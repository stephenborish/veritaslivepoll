<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veritas Live Poll - Teacher Dashboard</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#002d6b",
            "brand-white": "#ffffff",
            "brand-light-gray": "#d9e0e7",
            "brand-dark-gray": "#242424",
            "background-light": "#f5f7f8",
            "background-dark": "#0f1723"
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
            serif: ["Noto Serif", "serif"]
          },
          borderRadius: {
            DEFAULT: "0.25rem",
            lg: "0.5rem",
            xl: "0.75rem",
            full: "9999px"
          }
        }
      }
    };
  </script>

  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style type="text/tailwindcss">
    @layer utilities {
      .correct-answer-bg {
        background-image: repeating-linear-gradient(
          45deg,
          rgba(217, 224, 231, 0.7),
          rgba(217, 224, 231, 0.7) 10px,
          rgba(217, 224, 231, 1) 10px,
          rgba(217, 224, 231, 1) 20px
        );
      }
      .dark .correct-answer-bg {
        background-image: repeating-linear-gradient(
          45deg,
          rgba(0, 46, 109, 0.2),
          rgba(0, 46, 109, 0.2) 10px,
          rgba(0, 46, 109, 0.3) 10px,
          rgba(0, 46, 109, 0.3) 20px
        );
      }
    }
  </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-brand-dark-gray dark:text-brand-white">
  <div class="flex h-screen w-full flex-col">
    <!-- Header - Default State -->
    <header id="header-default" class="flex shrink-0 items-center justify-between whitespace-nowrap border-b border-solid border-primary/80 bg-primary px-6 py-3 shadow-sm">
      <div class="flex items-center gap-4">
        <img alt="Malvern Prep Logo" class="h-10 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png"/>
        <div class="flex flex-col">
          <h1 class="text-brand-white text-lg font-bold leading-tight tracking-[-0.015em]">Veritas Live Poll</h1>
          <p class="text-brand-white/80 text-sm">Teacher Dashboard</p>
        </div>
      </div>
      <div id="loader" class="loader" style="display: block;">
        <div class="h-6 w-6 animate-spin rounded-full border-2 border-brand-white/80 border-t-transparent"></div>
      </div>
    </header>

    <!-- Header - Live Poll State -->
    <header id="header-live" class="flex shrink-0 items-center justify-between whitespace-nowrap border-b border-solid border-primary/80 bg-primary px-6 py-3 shadow-sm" style="display: none;">
      <div class="flex items-center gap-4">
        <img alt="Malvern Prep Logo" class="h-10 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png"/>
        <div class="flex flex-col">
          <h1 id="header-poll-name" class="text-brand-white text-lg font-bold leading-tight tracking-[-0.015em]">Poll Name</h1>
          <p class="text-brand-white/80 text-sm">Live Poll</p>
        </div>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        <button id="header-start-btn" class="flex min-w-[80px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-brand-white text-primary text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-brand-light-gray transition-colors">
          <span class="material-symbols-outlined text-xl">play_arrow</span>
          <span class="truncate">Start</span>
        </button>
        <button id="header-pause-btn" class="flex min-w-[80px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-brand-white/30 transition-colors" style="display: none;">
          <span class="material-symbols-outlined text-xl">pause</span>
          <span class="truncate">Pause</span>
        </button>
        <button id="header-stop-btn" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-red-600 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-red-700 transition-colors">
          <span class="material-symbols-outlined text-xl">stop</span>
          <span class="truncate">Stop</span>
        </button>
        <div class="mx-2 h-6 w-px bg-brand-white/30"></div>
        <div id="question-dots" class="flex items-center gap-1.5 rounded-full bg-brand-white/20 px-3 py-1.5 text-sm font-medium text-brand-white">
          <!-- Question dots will be populated dynamically -->
        </div>
        <button id="header-next-btn" class="flex min-w-[80px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-brand-white/30 transition-colors">
          <span class="material-symbols-outlined text-xl">skip_next</span>
          <span class="truncate">Next</span>
        </button>
        <button id="header-reset-question-btn" class="flex min-w-[110px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-brand-white/30 transition-colors">
          <span class="material-symbols-outlined text-xl">replay</span>
          <span class="truncate">Reset Question</span>
        </button>
        <button id="header-skip-btn" class="flex min-w-[80px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-brand-white/30 transition-colors ml-2">
          <span class="material-symbols-outlined text-xl">fast_forward</span>
          <span class="truncate">Skip Question</span>
        </button>
      </div>
    </header>

    <div class="flex flex-grow overflow-hidden">
      <!-- Main Content Area -->
      <main class="flex-1 overflow-y-auto">
        <!-- Dashboard View (Default) -->
        <div id="dashboard" class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
          <!-- Sidebar Controls -->
          <aside class="lg:col-span-1 flex flex-col gap-6">
            <!-- Poll Controls -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <h2 class="text-brand-dark-gray dark:text-brand-white text-xl font-bold leading-normal mb-4">Poll Controls</h2>
              <div class="form-group mb-4">
                <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white" for="poll-select">Select Poll</label>
                <select id="poll-select" class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                  <option value="">-- Choose a poll --</option>
                </select>
              </div>
              <button id="send-link-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 mb-2 bg-green-600 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span class="material-symbols-outlined text-xl">mail</span>
                <span class="truncate">Send Student Links</span>
              </button>
              <button id="view-links-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 mb-4 bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span class="material-symbols-outlined text-xl">visibility</span>
                <span class="truncate">View All Links</span>
              </button>
              <button id="start-poll-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 mb-2 bg-primary text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
                <span class="material-symbols-outlined text-xl">play_arrow</span>
                <span class="truncate">Start Poll</span>
              </button>
            </div>

            <!-- Create New Poll -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <h2 class="text-brand-dark-gray dark:text-brand-white text-xl font-bold leading-normal mb-4">Create New Poll</h2>
              <button id="open-creator-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">
                <span class="material-symbols-outlined text-xl">add_circle</span>
                <span class="truncate">Create New Poll</span>
              </button>
            </div>
          </aside>

          <div class="lg:col-span-2 flex flex-col gap-6">
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                  <h2 class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white mb-1">Poll Library</h2>
                  <p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm">Sort, filter, edit, or delete any poll.</p>
                </div>
                <div class="flex flex-wrap items-center gap-3">
                  <label class="flex items-center gap-2 text-sm text-brand-dark-gray/70 dark:text-brand-white/70">
                    <span class="hidden sm:inline">Sort by</span>
                    <select id="poll-sort-select" class="rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                      <option value="updated_desc">Latest activity</option>
                      <option value="updated_asc">Oldest activity</option>
                      <option value="name_asc">Name A → Z</option>
                      <option value="class_asc">Class A → Z</option>
                    </select>
                  </label>
                  <label class="flex items-center gap-2 text-sm text-brand-dark-gray/70 dark:text-brand-white/70">
                    <span class="hidden sm:inline">Class</span>
                    <select id="poll-filter-select" class="rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                      <option value="all">All classes</option>
                    </select>
                  </label>
                </div>
              </div>
              <div class="mt-4 overflow-hidden rounded-lg border border-brand-light-gray/70 dark:border-brand-dark-gray/50">
                <table class="min-w-full divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/50 text-sm">
                  <thead class="bg-brand-light-gray/40 dark:bg-brand-dark-gray/40 text-brand-dark-gray/70 dark:text-brand-white/60">
                    <tr>
                      <th class="px-4 py-2 text-left font-semibold">Poll</th>
                      <th class="px-4 py-2 text-left font-semibold">Class</th>
                      <th class="px-4 py-2 text-left font-semibold">Questions</th>
                      <th class="px-4 py-2 text-left font-semibold">Last Edited</th>
                      <th class="px-4 py-2 text-right font-semibold">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="polls-table-body" class="divide-y divide-brand-light-gray/60 dark:divide-brand-dark-gray/40 bg-brand-white dark:bg-brand-dark-gray/30"></tbody>
                </table>
                <div id="polls-empty-state" class="p-6 text-center text-brand-dark-gray/60 dark:text-brand-white/60 hidden">
                  <p>No polls found. Create your first poll to get started.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Live Poll View -->
        <div id="live-view" class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6" style="display: none;">
          <!-- Main Content (2/3) -->
          <div class="lg:col-span-2 flex flex-col gap-6">
            <!-- Question Display -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <div class="flex gap-6">
                <div class="flex-grow">
                  <p id="live-question-info" class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm font-medium leading-normal mb-1">Question 1 of 10</p>
                  <h2 id="live-question-text" class="font-serif text-brand-dark-gray dark:text-brand-white tracking-tight text-xl leading-snug mb-4">Question text appears here</h2>
                </div>
                <div id="question-image-container" class="relative w-24 h-24 flex-shrink-0" style="display: none;">
                  <img id="live-question-image" alt="Question" class="rounded-lg object-cover w-full h-full" src="" referrerpolicy="no-referrer" style="max-width:100%;height:auto;display:block" onerror="this.style.display='none';"/>
                  <button class="absolute inset-0 flex items-center justify-center bg-black/50 text-white rounded-lg opacity-0 hover:opacity-100 transition-opacity" onclick="window.expandQuestionImage()">
                    <span class="material-symbols-outlined">zoom_in</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Live Results -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <div class="flex justify-between items-center mb-6">
                <h3 class="text-brand-dark-gray dark:text-brand-white text-xl font-bold leading-normal">Live Results</h3>
                <div class="flex items-center gap-3">
                  <span class="material-symbols-outlined text-primary dark:text-brand-white">group</span>
                  <span id="response-count" class="text-brand-dark-gray dark:text-brand-white text-base font-medium">0 / 0 answered</span>
                </div>
              </div>
              <div id="results-bars" class="flex flex-col gap-3">
                <!-- Results bars will be populated dynamically -->
              </div>
            </div>
          </div>

          <!-- Sidebar (1/3) -->
          <aside class="lg:col-span-1 flex flex-col gap-6">
            <!-- Timer -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <h3 class="text-brand-dark-gray dark:text-brand-white text-lg font-bold leading-normal mb-3 text-center">Question Timer</h3>
              <div class="flex flex-col items-center gap-4">
                <div class="text-center w-full">
                  <p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">Time Remaining</p>
                  <p id="live-timer-display" class="text-5xl font-bold text-primary dark:text-brand-white tracking-tighter font-mono mb-2">--:--</p>
                </div>
                <div class="w-full space-y-2">
                  <label class="block text-xs font-semibold uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/60 text-center">Preset Duration</label>
                  <div class="flex items-center justify-center gap-2">
                    <button id="timer-decrease-btn" class="h-9 w-9 rounded-full bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 flex items-center justify-center text-lg font-bold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors" type="button">−</button>
                    <input id="live-timer-input" type="text" value="01:30" class="w-24 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm text-center font-mono tracking-tight focus:outline-none focus:ring-2 focus:ring-primary/50" />
                    <button id="timer-increase-btn" class="h-9 w-9 rounded-full bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 flex items-center justify-center text-lg font-bold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors" type="button">+</button>
                  </div>
                  <p class="text-xs text-brand-dark-gray/50 dark:text-brand-white/50 text-center">Adjust in 15-second steps. Default is 90 seconds.</p>
                </div>
                <div class="flex flex-wrap items-center justify-center gap-2 w-full">
                  <button id="timer-start-btn" class="flex-1 min-w-[110px] flex items-center justify-center gap-2 h-10 px-4 rounded-lg bg-primary text-brand-white text-sm font-bold tracking-[0.015em] hover:bg-primary/90 transition-colors" type="button">
                    <span class="material-symbols-outlined text-xl">play_arrow</span>
                    <span>Start</span>
                  </button>
                  <button id="timer-pause-btn" class="flex-1 min-w-[110px] flex items-center justify-center gap-2 h-10 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-bold tracking-[0.015em] hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors" type="button">
                    <span class="material-symbols-outlined text-xl">pause</span>
                    <span>Pause</span>
                  </button>
                  <button id="timer-reset-btn" class="flex-1 min-w-[130px] flex items-center justify-center gap-2 h-10 px-4 rounded-lg bg-gray-200 text-brand-dark-gray dark:bg-brand-dark-gray/40 dark:text-brand-white text-sm font-bold tracking-[0.015em] hover:bg-gray-300 dark:hover:bg-brand-dark-gray/60 transition-colors" type="button">
                    <span class="material-symbols-outlined text-xl">restart_alt</span>
                    <span>Reset to 90s</span>
                  </button>
                </div>
                <p id="timer-status-message" class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 text-center">Timer idle.</p>
              </div>
            </div>

            <!-- Student Status -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm overflow-y-auto max-h-[600px]">
              <h3 class="text-brand-dark-gray dark:text-brand-white text-xl font-bold leading-normal mb-4">Student Status</h3>
              <div id="student-status-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2 gap-3">
                <!-- Student status tiles will be populated dynamically -->
              </div>
            </div>
          </aside>
        </div>

        <!-- Roster Manager View -->
        <div id="roster-manager" class="p-6 grid grid-cols-1 lg:grid-cols-4 gap-6" style="display: none;">
          <div class="lg:col-span-1 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-5 shadow-sm flex flex-col">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white">Classes</h2>
              <button id="add-class-btn" class="flex items-center justify-center h-9 w-9 rounded-full bg-primary text-brand-white hover:bg-primary/90 transition-colors" title="Add class">
                <span class="material-symbols-outlined text-base">add</span>
              </button>
            </div>
            <div id="roster-class-list" class="flex-1 overflow-y-auto space-y-2">
              <!-- Classes will render here -->
            </div>
          </div>
          <div class="lg:col-span-3 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
              <div>
                <h2 id="roster-class-title" class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">Select a class</h2>
                <p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm">Manage student names and emails for rostered classes.</p>
              </div>
              <div class="flex items-center gap-2">
                <button id="rename-class-btn" class="hidden h-9 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">Rename</button>
                <button id="delete-class-btn" class="hidden h-9 px-4 rounded-lg bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-sm font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors">Delete</button>
              </div>
            </div>
            <div id="roster-empty-state" class="border border-dashed border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-10 text-center text-brand-dark-gray/60 dark:text-brand-white/60">
              <p>Choose a class on the left to view its roster.</p>
            </div>
            <div id="roster-table-wrapper" class="hidden flex flex-col gap-4">
              <div class="overflow-x-auto border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg">
                <table class="min-w-full divide-y divide-brand-light-gray dark:divide-brand-dark-gray text-sm">
                  <thead class="bg-brand-light-gray/50 dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white">
                    <tr>
                      <th class="px-4 py-2 text-left font-semibold w-1/2">Student Name</th>
                      <th class="px-4 py-2 text-left font-semibold w-1/2">Email</th>
                      <th class="px-4 py-2 text-center font-semibold w-16">Remove</th>
                    </tr>
                  </thead>
                  <tbody id="roster-table-body" class="divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/50"></tbody>
                </table>
              </div>
              <div class="flex flex-wrap items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                  <button id="add-student-row-btn" class="h-10 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">+ Add Student</button>
                  <button id="bulk-add-students-btn" class="h-10 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">Bulk Add Students</button>
                  <span id="roster-status" class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60"></span>
                </div>
                <button id="save-roster-btn" class="h-10 px-5 rounded-lg bg-primary text-brand-white text-sm font-bold hover:bg-primary/90 transition-colors">Save Roster</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Archived Polls View -->
        <div id="archived-view" class="p-6 grid grid-cols-1 lg:grid-cols-4 gap-6" style="display: none;">
          <div class="lg:col-span-1 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-5 shadow-sm flex flex-col">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white">Archived Polls</h2>
              <button id="refresh-archived-btn" class="flex items-center justify-center h-9 w-9 rounded-full bg-primary text-brand-white hover:bg-primary/90 transition-colors" title="Refresh">
                <span class="material-symbols-outlined text-base">refresh</span>
              </button>
            </div>
            <label class="block text-xs font-semibold uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">Class Filter</label>
            <select id="archived-class-filter" class="mb-4 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
              <option value="all">All classes</option>
            </select>
            <div id="archived-list" class="flex-1 overflow-y-auto space-y-2">
              <!-- Archived polls list -->
            </div>
          </div>
          <div class="lg:col-span-3 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
            <div id="archived-empty-state" class="border border-dashed border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-10 text-center text-brand-dark-gray/60 dark:text-brand-white/60">
              <p>Select an archived poll to review student performance.</p>
            </div>
            <div id="archived-detail" class="hidden flex flex-col gap-6">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <div>
                  <h2 id="archived-poll-title" class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white"></h2>
                  <p id="archived-poll-meta" class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm"></p>
                </div>
                <div class="text-right text-sm text-brand-dark-gray/60 dark:text-brand-white/60">
                  <p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Questions:</span> <span id="archived-question-count"></span></p>
                  <p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Responses:</span> <span id="archived-response-count"></span></p>
                </div>
              </div>
              <div id="archived-questions-container" class="space-y-4">
                <!-- Question breakdowns will render here -->
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Right Sidebar Navigation -->
      <aside class="w-64 bg-primary flex-col items-center p-4 border-l border-primary/20 hidden lg:flex">
        <nav class="flex flex-col w-full gap-2">
          <button id="nav-polls-list" class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-brand-white/10 text-brand-white hover:bg-brand-white/20 font-semibold transition-colors text-left">
            <span class="material-symbols-outlined">monitoring</span>
            <span>Live Dashboard</span>
          </button>
          <button id="nav-create-poll" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-brand-white/70 hover:bg-brand-white/20 hover:text-brand-white transition-colors text-left">
            <span class="material-symbols-outlined">add_circle</span>
            <span>Create New Poll</span>
          </button>
          <button id="nav-rosters" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-brand-white/70 hover:bg-brand-white/20 hover:text-brand-white transition-colors text-left">
            <span class="material-symbols-outlined">group</span>
            <span>Classes &amp; Rosters</span>
          </button>
          <button id="nav-archived" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-brand-white/70 hover:bg-brand-white/20 hover:text-brand-white transition-colors text-left">
            <span class="material-symbols-outlined">inventory_2</span>
            <span>Archived Polls</span>
          </button>
        </nav>
      </aside>
    </div>
  </div>

  <!-- Poll Creator Modal -->
  <div id="poll-creator-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/20 z-10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img alt="Malvern Prep Logo" class="h-8 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png"/>
          <input type="text" id="new-poll-name" placeholder="Chapter 5 Quiz" class="bg-transparent text-brand-white text-xl font-bold border-none focus:ring-0 p-0 placeholder-brand-white/70 min-w-[300px]"/>
        </div>
        <div class="flex items-center gap-2">
          <span id="save-status" class="text-sm text-brand-white/80 mr-2">All changes saved</span>
          <button id="close-modal-btn" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-white/30 transition-colors">
            <span class="truncate">Cancel</span>
          </button>
          <button id="save-poll-btn" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-white text-primary text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray transition-colors">
            <span class="truncate">Publish Poll</span>
          </button>
        </div>
      </div>

      <div class="flex flex-grow overflow-hidden">
        <!-- Question Navigator Sidebar -->
        <aside class="w-64 flex-shrink-0 border-r border-solid border-brand-light-gray dark:border-brand-dark-gray/20 bg-brand-white dark:bg-background-dark overflow-y-auto">
          <div class="flex h-full flex-col justify-between p-4">
            <div id="question-navigator" class="flex flex-col gap-2">
              <!-- Question items will be added dynamically -->
            </div>
            <button id="add-question-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary/20 dark:bg-primary/30 text-primary dark:text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/30 dark:hover:bg-primary/40 transition-colors mt-4">
              <span class="truncate">+ Add Question</span>
            </button>
          </div>
        </aside>

        <!-- Editing Workspace -->
        <main class="flex-1 p-8 overflow-y-auto">
          <div class="form-group mb-6">
            <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white" for="class-select">Class</label>
            <select id="class-select" class="w-full max-w-md rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
              <option value="">-- Select Class --</option>
            </select>
          </div>

          <div id="question-builder-workspace">
            <!-- Question editing workspace will be populated dynamically -->
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- Student Links Modal -->
  <div id="student-links-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/70">
        <h2 class="text-brand-white text-2xl font-bold">Student Personalized Links</h2>
        <p class="text-brand-white/80 text-sm mt-1">Each student has a unique tracking link.</p>
      </div>
      <div class="p-6">
        <div id="links-container" class="max-h-[60vh] overflow-y-auto"></div>
        <div class="mt-6 pt-4 border-t border-primary/20">
          <button id="close-links-modal-btn" class="flex items-center justify-center gap-2 rounded-lg h-10 px-6 bg-primary text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
            <span>Close</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Add Students Modal -->
  <div id="bulk-add-students-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/70">
        <h2 class="text-brand-white text-2xl font-bold">Bulk Add Students</h2>
        <p class="text-brand-white/80 text-sm mt-1">Add multiple students at once. Enter one student per line in format: Name, Email</p>
      </div>
      <div class="p-6 flex-1 overflow-y-auto">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Student Data</label>
          <textarea id="bulk-student-input" class="w-full h-64 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 font-mono" placeholder="John Smith, jsmith@school.edu&#10;Jane Doe, jdoe@school.edu&#10;Bob Johnson, bjohnson@school.edu"></textarea>
          <p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-2">Format: Name, Email (one per line). Duplicates will be skipped automatically.</p>
        </div>
      </div>
      <div class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-primary/20 flex justify-end gap-3">
        <button id="cancel-bulk-add-btn" class="h-10 px-5 rounded-lg bg-brand-dark-gray/10 dark:bg-brand-white/10 text-brand-dark-gray dark:text-brand-white text-sm font-semibold hover:bg-brand-dark-gray/20 dark:hover:bg-brand-white/20 transition-colors">Cancel</button>
        <button id="confirm-bulk-add-btn" class="h-10 px-5 rounded-lg bg-primary text-brand-white text-sm font-bold hover:bg-primary/90 transition-colors">Add Students</button>
      </div>
    </div>
  </div>

  <script>
(function(){
  // --- Main App State ---
  var mainLoader=document.getElementById('loader');
  var ALL_POLLS=[];
  var ALL_CLASSES=[];
  var CURRENT_POLL_DATA={};
  var currentStudentStatusData=[];
  var pollInterval=null;
  var visualTimerInterval=null;
  var isPaused=false;
  var isLiveSession=false;
  var questionCounter=0;
  var questions=[];
  var selectedQuestionIndex=0;
  var editingPollId=null;
  var isPollDirty=false;
  var pollSortMode='updated_desc';
  var pollClassFilter='all';
  var rosterData={};
  var selectedRosterClass='';
  var rosterDirty=false;
  var archivedPolls=[];
  var archivedClassFilter='all';
  var selectedArchivedPollId='';
  var BASE_CLASSES=[];

  // --- Element Cache ---
  var pollSelect=document.getElementById('poll-select');
  var startPollBtn=document.getElementById('start-poll-btn');
  var dashboard=document.getElementById('dashboard');
  var liveView=document.getElementById('live-view');
  var rosterManager=document.getElementById('roster-manager');
  var archivedView=document.getElementById('archived-view');
  var headerDefault=document.getElementById('header-default');
  var headerLive=document.getElementById('header-live');
  var modal=document.getElementById('poll-creator-modal');
  var linksModal=document.getElementById('student-links-modal');
  var pollSortSelect=document.getElementById('poll-sort-select');
  var pollFilterSelect=document.getElementById('poll-filter-select');
  var pollsTableBody=document.getElementById('polls-table-body');
  var pollsEmptyState=document.getElementById('polls-empty-state');
  var classSelect=document.getElementById('class-select');
  var archivedClassFilterSelect=document.getElementById('archived-class-filter');
  var archivedList=document.getElementById('archived-list');
  var archivedEmptyState=document.getElementById('archived-empty-state');
  var archivedDetail=document.getElementById('archived-detail');
  var archivedPollTitle=document.getElementById('archived-poll-title');
  var archivedPollMeta=document.getElementById('archived-poll-meta');
  var archivedQuestionCount=document.getElementById('archived-question-count');
  var archivedResponseCount=document.getElementById('archived-response-count');
  var archivedQuestionsContainer=document.getElementById('archived-questions-container');
  var rosterClassList=document.getElementById('roster-class-list');
  var rosterClassTitle=document.getElementById('roster-class-title');
  var rosterEmptyState=document.getElementById('roster-empty-state');
  var rosterTableWrapper=document.getElementById('roster-table-wrapper');
  var rosterTableBody=document.getElementById('roster-table-body');
  var rosterStatus=document.getElementById('roster-status');
  var renameClassBtn=document.getElementById('rename-class-btn');
  var deleteClassBtn=document.getElementById('delete-class-btn');
  var addClassBtn=document.getElementById('add-class-btn');
  var addStudentRowBtn=document.getElementById('add-student-row-btn');
  var saveRosterBtn=document.getElementById('save-roster-btn');
  var refreshArchivedBtn=document.getElementById('refresh-archived-btn');

  // --- Initialization ---
  google.charts.load('current',{'packages':['corechart']});
  google.charts.setOnLoadCallback(loadInitialData);

  // --- Event Listeners ---
  document.getElementById('open-creator-btn').onclick=function(){openPollCreator();};
  document.getElementById('nav-create-poll').onclick=function(){openPollCreator();};
  document.getElementById('nav-polls-list').onclick=showDashboard;
  document.getElementById('nav-rosters').onclick=showRosterManager;
  document.getElementById('nav-archived').onclick=showArchivedView;
  document.getElementById('close-modal-btn').onclick=closePollCreator;
  document.getElementById('close-links-modal-btn').onclick=closeLinksModal;
  document.getElementById('add-question-btn').onclick=addQuestion;
  document.getElementById('save-poll-btn').onclick=savePoll;
  document.getElementById('new-poll-name').addEventListener('input',markPollDirty);
  classSelect.addEventListener('change',markPollDirty);
  startPollBtn.onclick=onStartPoll;
  document.getElementById('header-start-btn').onclick=onResumePoll;
  document.getElementById('header-pause-btn').onclick=onStopPoll;
  document.getElementById('header-stop-btn').onclick=onEndPoll;
  document.getElementById('header-next-btn').onclick=onNextQuestion;
  document.getElementById('header-reset-question-btn').onclick=onResetQuestion;
  document.getElementById('header-skip-btn').onclick=onNextQuestion;
  document.getElementById('timer-start-btn').onclick=startTimerCountdown;
  document.getElementById('timer-pause-btn').onclick=pauseTimerCountdown;
  document.getElementById('timer-reset-btn').onclick=resetTimerCountdown;
  document.getElementById('timer-decrease-btn').onclick=function(){adjustTimerPreset(-15);};
  document.getElementById('timer-increase-btn').onclick=function(){adjustTimerPreset(15);};
  document.getElementById('live-timer-input').addEventListener('change',function(){
    var parsed=parseTimerValue(this.value);
    if(parsed){
      timerPresetSeconds=parsed;
      timerRemainingSeconds=parsed;
      timerExpiredHandled=false;
      updateTimerInputs();
      updateTimerStatus('Preset updated to '+formatSeconds(timerPresetSeconds)+'.','info');
    } else {
      updateTimerInputs();
    }
  });
  updateTimerInputs();
  updateTimerStatus('Timer idle.','info');
  document.getElementById('send-link-btn').onclick=onSendLink;
  document.getElementById('view-links-btn').onclick=onViewLinks;
  pollSelect.onchange=onPollSelectChange;
  pollSortSelect.onchange=function(){pollSortMode=this.value;refreshPollViews();};
  pollFilterSelect.onchange=function(){pollClassFilter=this.value;refreshPollViews();};
  archivedClassFilterSelect.onchange=function(){archivedClassFilter=this.value;renderArchivedList();};
  addClassBtn.onclick=onAddClass;
  addStudentRowBtn.onclick=addRosterRow;
  document.getElementById('bulk-add-students-btn').onclick=openBulkAddStudentsModal;
  document.getElementById('cancel-bulk-add-btn').onclick=closeBulkAddStudentsModal;
  document.getElementById('confirm-bulk-add-btn').onclick=confirmBulkAddStudents;
  saveRosterBtn.onclick=saveRoster;
  renameClassBtn.onclick=onRenameClass;
  deleteClassBtn.onclick=onDeleteClass;
  refreshArchivedBtn.onclick=function(){loadArchivedPolls(true);};

  function setMainSection(section){
    dashboard.style.display=section==='dashboard'?'grid':'none';
    liveView.style.display=section==='live'?'grid':'none';
    rosterManager.style.display=section==='roster'?'grid':'none';
    archivedView.style.display=section==='archived'?'grid':'none';
  }

  function clearLiveIntervals(){
    if(pollInterval){
      clearInterval(pollInterval);
      pollInterval=null;
    }
    pauseTimerCountdown();
    stopVisualTimer();
    timerRemainingSeconds=timerPresetSeconds;
    timerActive=false;
    updateTimerDisplay();
    updateTimerStatus('Timer idle.','info');
  }

  function showDashboard(){
    clearLiveIntervals();
    isLiveSession=false;
    CURRENT_POLL_DATA={};
    headerDefault.style.display='flex';
    headerLive.style.display='none';
    setMainSection('dashboard');
  }

  function showRosterManager(){
    clearLiveIntervals();
    headerDefault.style.display='flex';
    headerLive.style.display='none';
    setMainSection('roster');
    if(Object.keys(rosterData).length===0){
      loadRosterData();
    } else {
      renderRosterClassList();
      if(selectedRosterClass){
        renderRosterTable();
      } else {
        rosterEmptyState.classList.remove('hidden');
        rosterTableWrapper.classList.add('hidden');
        renameClassBtn.classList.add('hidden');
        deleteClassBtn.classList.add('hidden');
      }
    }
  }

  function showArchivedView(){
    clearLiveIntervals();
    headerDefault.style.display='flex';
    headerLive.style.display='none';
    setMainSection('archived');
    if(archivedPolls.length===0){
      loadArchivedPolls();
    } else {
      renderArchivedList();
      renderArchivedDetail();
    }
  }

  // --- Initial Data Load ---
  function loadInitialData(){
    google.script.run
      .withSuccessHandler(onDashboardDataLoaded)
      .withFailureHandler(handleError)
      .getTeacherDashboardData();
  }

  function onDashboardDataLoaded(data){
    mainLoader.style.display='none';
    ALL_POLLS=data.polls||[];
    refreshClassOptions(data.classes||[]);
    refreshPollViews();
  }

  function updatePollDropdown(polls){
    polls=polls||getFilteredSortedPolls();
    var previousValue=pollSelect.value;
    pollSelect.innerHTML='<option value="">-- Choose a poll --</option>';
    var hasSelection=false;
    polls.forEach(function(poll){
      var opt=document.createElement('option');
      opt.value=poll.pollId;
      opt.textContent=poll.pollName+' ('+poll.className+') - '+poll.questions.length+' questions';
      if(poll.pollId===previousValue){
        opt.selected=true;
        hasSelection=true;
      }
      pollSelect.appendChild(opt);
    });
    if(!hasSelection){
      pollSelect.value='';
    }
    onPollSelectChange();
  }

  function refreshClassOptions(classList){
    BASE_CLASSES=(classList||[]).map(function(name){return (name||'').toString().trim();}).filter(function(name){return name!=='';});
    var classSet=new Set();
    BASE_CLASSES.forEach(function(name){classSet.add(name);});
    Object.keys(rosterData).forEach(function(name){if(name)classSet.add(name);});
    ALL_POLLS.forEach(function(poll){
      if(poll.className){
        classSet.add(poll.className);
      }
    });
    ALL_CLASSES=Array.from(classSet).sort();

    var previousSelection=classSelect.value;
    classSelect.innerHTML='<option value="">-- Select Class --</option>';
    ALL_CLASSES.forEach(function(className){
      var opt=document.createElement('option');
      opt.value=className;
      opt.textContent=className;
      classSelect.appendChild(opt);
    });
    if(previousSelection&&ALL_CLASSES.indexOf(previousSelection)!==-1){
      classSelect.value=previousSelection;
    } else {
      classSelect.value='';
    }

    updateClassFilters();
  }

  function updateClassFilters(){
    var previousPollFilter=pollClassFilter;
    pollFilterSelect.innerHTML='<option value="all">All classes</option>';
    ALL_CLASSES.forEach(function(className){
      var opt=document.createElement('option');
      opt.value=className;
      opt.textContent=className;
      pollFilterSelect.appendChild(opt);
    });
    if(previousPollFilter&&ALL_CLASSES.indexOf(previousPollFilter)!==-1){
      pollClassFilter=previousPollFilter;
    } else {
      pollClassFilter='all';
    }
    pollFilterSelect.value=pollClassFilter;

    var previousArchivedFilter=archivedClassFilter;
    archivedClassFilterSelect.innerHTML='<option value="all">All classes</option>';
    ALL_CLASSES.forEach(function(className){
      var opt=document.createElement('option');
      opt.value=className;
      opt.textContent=className;
      archivedClassFilterSelect.appendChild(opt);
    });
    if(previousArchivedFilter&&ALL_CLASSES.indexOf(previousArchivedFilter)!==-1){
      archivedClassFilter=previousArchivedFilter;
    } else {
      archivedClassFilter='all';
    }
    archivedClassFilterSelect.value=archivedClassFilter;
  }

  function getFilteredSortedPolls(){
    var list=ALL_POLLS.slice();
    if(pollClassFilter!=='all'){
      list=list.filter(function(poll){return poll.className===pollClassFilter;});
    }

    list.sort(function(a,b){
      switch(pollSortMode){
        case 'updated_asc':
          return getPollTimestamp(a)-getPollTimestamp(b);
        case 'name_asc':
          return (a.pollName||'').localeCompare(b.pollName||'');
        case 'class_asc':
          var classCompare=(a.className||'').localeCompare(b.className||'');
          if(classCompare!==0)return classCompare;
          return (a.pollName||'').localeCompare(b.pollName||'');
        case 'updated_desc':
        default:
          return getPollTimestamp(b)-getPollTimestamp(a);
      }
    });
    return list;
  }

  function getPollTimestamp(poll){
    var value=poll && (poll.updatedAt||poll.lastRunAt||poll.createdAt||'');
    var time=value?Date.parse(value):NaN;
    return isNaN(time)?0:time;
  }

  function refreshPollViews(){
    var polls=getFilteredSortedPolls();
    renderPollTable(polls);
    updatePollDropdown(polls);
    if(polls.length===0){
      pollsEmptyState.classList.remove('hidden');
    } else {
      pollsEmptyState.classList.add('hidden');
    }
  }

  function startEditPoll(pollId,triggerButton){
    if(!pollId)return;
    var button=triggerButton||null;
    var originalLabel=button?button.innerHTML:'';
    if(button){
      button.disabled=true;
      button.textContent='Loading...';
    }

    google.script.run
      .withSuccessHandler(function(poll){
        if(button){
          button.disabled=false;
          button.innerHTML=originalLabel;
        }
        openPollCreator(poll);
      })
      .withFailureHandler(function(error){
        if(button){
          button.disabled=false;
          button.innerHTML=originalLabel;
        }
        handleError(error);
      })
      .getPollForEditing(pollId);
  }

  function renderPollTable(polls){
    polls=polls||getFilteredSortedPolls();
    pollsTableBody.innerHTML='';

    if(polls.length===0){
      return;
    }

    polls.forEach(function(poll){
      var row=document.createElement('tr');
      row.className='hover:bg-brand-light-gray/40 dark:hover:bg-brand-dark-gray/40 transition-colors';
      var lastEdited=formatDateTime(poll.updatedAt||poll.lastRunAt||poll.createdAt);
      var createdLabel=poll.createdAt?formatDateTime(poll.createdAt):'—';
      var htmlParts=[];
      htmlParts.push('<td class="px-4 py-3 align-top">');
      htmlParts.push('<div class="font-semibold text-brand-dark-gray dark:text-brand-white">'+escapeHtml(poll.pollName||'Untitled Poll')+'</div>');
      htmlParts.push('<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/50">Created '+createdLabel+'</div>');
      htmlParts.push('</td>');
      htmlParts.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+escapeHtml(poll.className||'—')+'</td>');
      htmlParts.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+(poll.questions?poll.questions.length:0)+'</td>');
      htmlParts.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+lastEdited+'</td>');
      htmlParts.push('<td class="px-4 py-3 align-top">');
      htmlParts.push('<div class="flex justify-end gap-2">');
      htmlParts.push('<button class="poll-select-btn h-8 px-3 rounded-md bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-xs font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors" data-poll-id="'+poll.pollId+'">Select</button>');
      htmlParts.push('<button class="poll-copy-btn h-8 px-3 rounded-md bg-green-600/10 text-green-600 dark:text-green-300 dark:bg-green-500/20 text-xs font-semibold hover:bg-green-600/20 dark:hover:bg-green-500/30 transition-colors" data-poll-id="'+poll.pollId+'" title="Copy this poll">Copy</button>');
      htmlParts.push('<button class="poll-edit-btn h-8 px-3 rounded-md bg-primary text-brand-white text-xs font-semibold hover:bg-primary/90 transition-colors" data-poll-id="'+poll.pollId+'">Edit</button>');
      htmlParts.push('<button class="poll-delete-btn h-8 px-3 rounded-md bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-xs font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors" data-poll-id="'+poll.pollId+'">Delete</button>');
      htmlParts.push('</div>');
      htmlParts.push('</td>');
      row.innerHTML=htmlParts.join('');
      pollsTableBody.appendChild(row);
    });

    pollsTableBody.querySelectorAll('.poll-select-btn').forEach(function(btn){
      btn.onclick=function(){
        var id=this.dataset.pollId;
        pollSelect.value=id;
        onPollSelectChange();
        showDashboard();
      };
    });

    pollsTableBody.querySelectorAll('.poll-copy-btn').forEach(function(btn){
      btn.onclick=function(){
        var pollId=this.dataset.pollId;
        var poll=ALL_POLLS.find(function(p){return p.pollId===pollId;});
        if(!poll)return;

        var newName=prompt('Enter a name for the copied poll:',poll.pollName+' (Copy)');
        if(newName===null)return;

        newName=newName.trim();
        if(newName===''){
          alert('Poll name cannot be empty');
          return;
        }

        btn.disabled=true;
        btn.textContent='Copying...';

        google.script.run
          .withSuccessHandler(function(result){
            if(result.success){
              refreshPollData(result.polls);
              alert(result.message);
            } else {
              alert('Failed to copy poll: '+(result.error||'Unknown error'));
            }
            btn.disabled=false;
            btn.textContent='Copy';
          })
          .withFailureHandler(function(error){
            handleError(error);
            btn.disabled=false;
            btn.textContent='Copy';
          })
          .copyPoll(pollId,newName,poll.className);
      };
    });

    pollsTableBody.querySelectorAll('.poll-edit-btn').forEach(function(btn){
      btn.onclick=function(){
        startEditPoll(this.dataset.pollId,this);
      };
    });

    pollsTableBody.querySelectorAll('.poll-delete-btn').forEach(function(btn){
      btn.onclick=function(){
        var id=this.dataset.pollId;
        if(confirm('Delete this poll permanently? This will also remove all responses.')){
          google.script.run
            .withSuccessHandler(function(polls){
              refreshPollData(polls);
            })
            .withFailureHandler(handleError)
            .deletePoll(id);
        }
      };
    });
  }

  function refreshPollData(polls){
    ALL_POLLS=polls||[];
    refreshClassOptions(BASE_CLASSES);
    refreshPollViews();
  }

  function onPollSelectChange(){
    var pollId=pollSelect.value;
    var sendBtn=document.getElementById('send-link-btn');
    var viewBtn=document.getElementById('view-links-btn');
    if(pollId){
      var selectedPoll=ALL_POLLS.find(function(p){return p.pollId===pollId;});
      if(selectedPoll){
        sendBtn.disabled=false;
        viewBtn.disabled=false;
        sendBtn.dataset.className=selectedPoll.className;
        viewBtn.dataset.className=selectedPoll.className;
      }
    } else {
      sendBtn.disabled=true;
      viewBtn.disabled=true;
    }
  }

  // --- Roster Management ---
  function loadRosterData(){
    rosterStatus.textContent='Loading roster...';
    google.script.run
      .withSuccessHandler(function(data){
        rosterStatus.textContent='';
        onRosterDataLoaded(data, selectedRosterClass);
      })
      .withFailureHandler(function(error){
        rosterStatus.textContent='';
        handleError(error);
      })
      .getRosterManagerData();
  }

  function onRosterDataLoaded(data, focusClass){
    rosterDirty=false;
    rosterData=data&&data.rosters?data.rosters:{};
    refreshClassOptions((data&&data.classes)||BASE_CLASSES);

    if(focusClass){
      selectedRosterClass=focusClass;
    }

    if(selectedRosterClass && !rosterData[selectedRosterClass]){
      selectedRosterClass='';
    }

    renderRosterClassList();

    if(selectedRosterClass){
      renderRosterTable();
    } else {
      rosterClassTitle.textContent='Select a class';
      rosterEmptyState.classList.remove('hidden');
      rosterTableWrapper.classList.add('hidden');
      renameClassBtn.classList.add('hidden');
      deleteClassBtn.classList.add('hidden');
      rosterStatus.textContent='';
    }
  }

  function renderRosterClassList(){
    rosterClassList.innerHTML='';
    if(ALL_CLASSES.length===0){
      rosterClassList.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No classes yet. Click the + button to add one.</p>';
      return;
    }

    ALL_CLASSES.forEach(function(className){
      var button=document.createElement('button');
      button.type='button';
      var isActive=className===selectedRosterClass;
      button.className='w-full text-left px-3 py-2 rounded-lg transition-colors '+(isActive?'bg-primary text-brand-white shadow-sm':'bg-brand-light-gray/40 dark:bg-brand-dark-gray/30 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/60 dark:hover:bg-brand-dark-gray/50');
      button.textContent=className;
      button.onclick=function(){
        selectRosterClass(className);
      };
      rosterClassList.appendChild(button);
    });
  }

  function selectRosterClass(className){
    selectedRosterClass=className;
    rosterDirty=false;
    rosterStatus.textContent='';
    renderRosterClassList();
    renderRosterTable();
  }

  function renderRosterTable(){
    if(!selectedRosterClass){
      return;
    }

    var entries=rosterData[selectedRosterClass]||[];
    rosterData[selectedRosterClass]=entries;

    if(entries.length===0){
      entries.push({name:'',email:''});
    }

    rosterClassTitle.textContent=selectedRosterClass;
    rosterEmptyState.classList.add('hidden');
    rosterTableWrapper.classList.remove('hidden');
    renameClassBtn.classList.remove('hidden');
    deleteClassBtn.classList.remove('hidden');

    rosterTableBody.innerHTML='';
    entries.forEach(function(entry,index){
      var row=document.createElement('tr');
      row.innerHTML=
        '<td class="px-4 py-2 align-top">'+
          '<input type="text" class="roster-name-input w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" data-index="'+index+'" placeholder="Student Name" value="'+escapeHtml(entry.name||'')+'" />'+
        '</td>'+
        '<td class="px-4 py-2 align-top">'+
          '<input type="email" class="roster-email-input w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" data-index="'+index+'" placeholder="email@example.com" value="'+escapeHtml(entry.email||'')+'" />'+
        '</td>'+
        '<td class="px-4 py-2 align-top text-center">'+
          '<button class="remove-roster-row-btn h-8 w-8 rounded-full bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors" data-index="'+index+'" title="Remove">'+
            '<span class="material-symbols-outlined text-base">close</span>'+
          '</button>'+
        '</td>';
      rosterTableBody.appendChild(row);
    });

    rosterTableBody.querySelectorAll('.roster-name-input').forEach(function(input){
      input.oninput=function(){
        var idx=parseInt(this.dataset.index,10);
        rosterData[selectedRosterClass][idx].name=this.value;
        markRosterDirty();
      };
    });

    rosterTableBody.querySelectorAll('.roster-email-input').forEach(function(input){
      input.oninput=function(){
        var idx=parseInt(this.dataset.index,10);
        rosterData[selectedRosterClass][idx].email=this.value;
        markRosterDirty();
      };
    });

    rosterTableBody.querySelectorAll('.remove-roster-row-btn').forEach(function(btn){
      btn.onclick=function(){
        var idx=parseInt(this.dataset.index,10);
        removeRosterRow(idx);
      };
    });
  }

  function markRosterDirty(){
    rosterDirty=true;
    rosterStatus.textContent='Unsaved changes';
  }

  function addRosterRow(){
    if(!selectedRosterClass){
      alert('Select a class first.');
      return;
    }
    if(!rosterData[selectedRosterClass]){
      rosterData[selectedRosterClass]=[];
    }
    rosterData[selectedRosterClass].push({name:'',email:''});
    markRosterDirty();
    renderRosterTable();
  }

  function removeRosterRow(index){
    if(!selectedRosterClass)return;
    var entries=rosterData[selectedRosterClass]||[];
    if(entries.length>index){
      entries.splice(index,1);
      markRosterDirty();
      if(entries.length===0){
        entries.push({name:'',email:''});
      }
      renderRosterTable();
    }
  }

  function saveRoster(){
    if(!selectedRosterClass){
      alert('Select a class to save.');
      return;
    }

    var entries=(rosterData[selectedRosterClass]||[]).map(function(entry){
      return {
        name:(entry.name||'').trim(),
        email:(entry.email||'').trim()
      };
    }).filter(function(entry){
      return entry.name!==''&&entry.email!=='';
    });

    saveRosterBtn.disabled=true;
    rosterStatus.textContent='Saving roster...';

    google.script.run
      .withSuccessHandler(function(data){
        saveRosterBtn.disabled=false;
        rosterStatus.textContent='Roster saved.';
        rosterDirty=false;
        onRosterDataLoaded(data, selectedRosterClass);
      })
      .withFailureHandler(function(error){
        saveRosterBtn.disabled=false;
        handleError(error);
      })
      .saveRoster(selectedRosterClass, entries);
  }

  function openBulkAddStudentsModal(){
    if(!selectedRosterClass){
      alert('Select a class first.');
      return;
    }
    document.getElementById('bulk-student-input').value='';
    document.getElementById('bulk-add-students-modal').style.display='flex';
  }

  function closeBulkAddStudentsModal(){
    document.getElementById('bulk-add-students-modal').style.display='none';
  }

  function confirmBulkAddStudents(){
    if(!selectedRosterClass){
      alert('Select a class first.');
      closeBulkAddStudentsModal();
      return;
    }

    var input=document.getElementById('bulk-student-input').value;
    var lines=input.split('\n');
    var entries=[];

    lines.forEach(function(line){
      line=line.trim();
      if(line==='')return;

      // Parse format: Name, Email
      var parts=line.split(',');
      if(parts.length>=2){
        var name=parts[0].trim();
        var email=parts.slice(1).join(',').trim();
        if(name&&email){
          entries.push({name:name,email:email});
        }
      }
    });

    if(entries.length===0){
      alert('No valid student entries found. Use format: Name, Email');
      return;
    }

    var confirmBtn=document.getElementById('confirm-bulk-add-btn');
    confirmBtn.disabled=true;
    confirmBtn.textContent='Adding...';

    google.script.run
      .withSuccessHandler(function(result){
        confirmBtn.disabled=false;
        confirmBtn.textContent='Add Students';
        closeBulkAddStudentsModal();

        if(result.success){
          alert(result.message);
          rosterDirty=false;
          onRosterDataLoaded(result.data,selectedRosterClass);
        } else {
          alert('Failed to add students: '+(result.error||'Unknown error'));
        }
      })
      .withFailureHandler(function(error){
        confirmBtn.disabled=false;
        confirmBtn.textContent='Add Students';
        handleError(error);
      })
      .bulkAddStudentsToRoster(selectedRosterClass,entries);
  }

  function onAddClass(){
    var className=prompt('Class name');
    if(!className)return;
    className=className.trim();
    if(className==='')return;
    rosterStatus.textContent='Creating class...';
    google.script.run
      .withSuccessHandler(function(data){
        rosterStatus.textContent='Class created.';
        selectedRosterClass=className;
        onRosterDataLoaded(data, className);
      })
      .withFailureHandler(function(error){
        rosterStatus.textContent='';
        handleError(error);
      })
      .createClassRecord(className,'');
  }

  function onRenameClass(){
    if(!selectedRosterClass){
      alert('Select a class first.');
      return;
    }
    var newName=prompt('Rename class', selectedRosterClass);
    if(!newName)return;
    newName=newName.trim();
    if(newName===''){return;}
    if(newName===selectedRosterClass)return;
    rosterStatus.textContent='Renaming class...';
    google.script.run
      .withSuccessHandler(function(data){
        rosterStatus.textContent='Class renamed.';
        selectedRosterClass=newName;
        onRosterDataLoaded(data, newName);
      })
      .withFailureHandler(function(error){
        rosterStatus.textContent='';
        handleError(error);
      })
      .renameClass(selectedRosterClass,newName);
  }

  function onDeleteClass(){
    if(!selectedRosterClass){
      alert('Select a class first.');
      return;
    }
    if(!confirm('Delete class "'+selectedRosterClass+'" and remove all students?'))return;
    rosterStatus.textContent='Deleting class...';
    var classToDelete=selectedRosterClass;
    google.script.run
      .withSuccessHandler(function(data){
        rosterStatus.textContent='Class deleted.';
        selectedRosterClass='';
        onRosterDataLoaded(data, '');
      })
      .withFailureHandler(function(error){
        rosterStatus.textContent='';
        handleError(error);
      })
      .deleteClassRecord(classToDelete);
  }

  // --- Archived Polls ---
  function loadArchivedPolls(force){
    if(archivedPolls.length>0&&!force){
      renderArchivedList();
      renderArchivedDetail();
      return;
    }

    archivedList.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">Loading archived polls...</p>';
    archivedEmptyState.classList.remove('hidden');
    archivedDetail.classList.add('hidden');

    google.script.run
      .withSuccessHandler(function(polls){
        archivedPolls=polls||[];
        if(archivedPolls.length>0){
          if(!archivedPolls.some(function(p){return p.pollId===selectedArchivedPollId;})){
            selectedArchivedPollId=archivedPolls[0].pollId;
          }
        } else {
          selectedArchivedPollId='';
        }
        renderArchivedList();
        renderArchivedDetail();
      })
      .withFailureHandler(handleError)
      .getArchivedPolls();
  }

  function renderArchivedList(){
    archivedList.innerHTML='';
    var filtered=archivedClassFilter==='all'?archivedPolls:archivedPolls.filter(function(poll){return poll.className===archivedClassFilter;});

    if(filtered.length===0){
      archivedList.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No archived polls for this filter.</p>';
      archivedEmptyState.classList.remove('hidden');
      archivedDetail.classList.add('hidden');
      return;
    }

    filtered.forEach(function(poll){
      var button=document.createElement('button');
      button.type='button';
      var isActive=poll.pollId===selectedArchivedPollId;
      button.className='w-full text-left px-3 py-2 rounded-lg transition-colors '+(isActive?'bg-primary text-brand-white shadow-sm':'bg-brand-light-gray/40 dark:bg-brand-dark-gray/30 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/60 dark:hover:bg-brand-dark-gray/50');
      var metaText=(poll.className||'Unassigned')+' • '+formatDateTime(poll.lastRunAt||poll.updatedAt||poll.createdAt);
      button.innerHTML='<div class="font-semibold">'+escapeHtml(poll.pollName||'Untitled Poll')+'</div><div class="text-xs opacity-80">'+escapeHtml(metaText)+'</div>';
      button.onclick=function(){
        selectedArchivedPollId=poll.pollId;
        renderArchivedList();
        renderArchivedDetail();
      };
      archivedList.appendChild(button);
    });
  }

  function renderArchivedDetail(){
    var poll=archivedPolls.find(function(p){return p.pollId===selectedArchivedPollId;});
    if(!poll){
      archivedEmptyState.classList.remove('hidden');
      archivedDetail.classList.add('hidden');
      return;
    }

    archivedEmptyState.classList.add('hidden');
    archivedDetail.classList.remove('hidden');

    archivedPollTitle.textContent=poll.pollName||'Untitled Poll';
    archivedPollMeta.textContent=(poll.className||'Unassigned')+' • Last run '+formatDateTime(poll.lastRunAt||poll.updatedAt||poll.createdAt);
    archivedQuestionCount.textContent=poll.questionCount||0;
    archivedResponseCount.textContent=(poll.totalResponses||0)+' of '+(poll.totalStudents||0);

    archivedQuestionsContainer.innerHTML='';
    poll.questions.forEach(function(question,index){
      var card=document.createElement('div');
      card.className='border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-4 bg-brand-white dark:bg-brand-dark-gray/40';
      var summary=question.summary||{correct:0,incorrect:0,noResponse:0,violations:0};
      var responses=Array.isArray(question.responses)?question.responses:[];
      var nonResponders=Array.isArray(question.nonResponders)?question.nonResponders:[];
      summary.correct=summary.correct||0;
      summary.incorrect=summary.incorrect||0;
      summary.noResponse=summary.noResponse||0;
      summary.violations=summary.violations||0;

      var responsesHtml='';
      if(responses.length===0){
        responsesHtml='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No responses recorded.</p>';
      } else {
        responsesHtml='<table class="min-w-full text-sm divide-y divide-brand-light-gray dark:divide-brand-dark-gray/40"><thead class="text-xs uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/50"><tr><th class="py-2 text-left">Student</th><th class="py-2 text-left">Answer</th><th class="py-2 text-left">Status</th></tr></thead><tbody class="divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/40">';
        responses.forEach(function(response){
          var status=response.violation?'Violation':(response.isCorrect?'Correct':'Incorrect');
          var statusClass=response.violation?'text-orange-600 dark:text-orange-300':(response.isCorrect?'text-green-600 dark:text-green-300':'text-red-600 dark:text-red-300');
          responsesHtml+='<tr><td class="py-2 pr-3">'+escapeHtml(response.name||response.email)+'</td><td class="py-2 pr-3">'+escapeHtml(response.answer||'—')+'</td><td class="py-2 pr-3 '+statusClass+'">'+status+'</td></tr>';
        });
        responsesHtml+='</tbody></table>';
      }

      var nonResponderHtml='';
      if(nonResponders.length>0){
        nonResponderHtml='<div class="mt-3"><h4 class="text-xs font-semibold uppercase text-brand-dark-gray/60 dark:text-brand-white/60">No Response</h4><div class="flex flex-wrap gap-2 mt-1">';
        nonResponders.forEach(function(student){
          var chipClass=student.violation?'bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-200':'bg-brand-light-gray text-brand-dark-gray dark:bg-brand-dark-gray/50 dark:text-brand-white/80';
          nonResponderHtml+='<span class="px-2 py-1 rounded-full text-xs '+chipClass+'">'+escapeHtml(student.name||student.email)+'</span>';
        });
        nonResponderHtml+='</div></div>';
      }

      var imageHtml=question.questionImageURL?'<div class="mt-3"><img src="'+escapeHtml(question.questionImageURL)+'" class="max-h-48 rounded-lg object-contain" alt="Question image" /></div>':'';
      var questionHtml='<div><h3 class="font-serif text-lg text-brand-dark-gray dark:text-brand-white">Question '+(index+1)+'</h3><p class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 mt-1">'+escapeHtml(question.questionText||'')+'</p></div>';
      var summaryHtml='<div class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 text-right">'+
        '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Correct:</span> '+summary.correct+'</p>'+
        '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Incorrect:</span> '+summary.incorrect+'</p>'+
        '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">No Response:</span> '+summary.noResponse+'</p>'+
        '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Violations:</span> '+summary.violations+'</p>'+
      '</div>';
      card.innerHTML='<div class="flex flex-wrap items-start justify-between gap-3">'+questionHtml+summaryHtml+'</div>'+imageHtml+'<div class="mt-4">'+responsesHtml+'</div>'+nonResponderHtml;

      archivedQuestionsContainer.appendChild(card);
    });
  }

  // --- Poll Lifecycle Controls ---
  function onStartPoll(){
    var pollId=pollSelect.value;
    if(!pollId){alert("Please select a poll first.");return;}
    startPollBtn.disabled=true;
    clearLiveIntervals();
    isPaused=false;
    isLiveSession=true;
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .startPoll(pollId);
  }

  function onResumePoll(){
    if(pollInterval)clearInterval(pollInterval);
    pauseTimerCountdown();
    stopVisualTimer();
    timerExpiredHandled=false;
    timerActive=false;
    timerRemainingSeconds=timerPresetSeconds;
    updateTimerDisplay();
    updateTimerStatus('Timer idle.','info');
    isPaused=false;
    isLiveSession=true;
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .resumePoll();
  }

  function onStopPoll(){
    pauseTimerCountdown();
    stopVisualTimer();
    timerActive=false;
    timerRemainingSeconds=timerPresetSeconds;
    updateTimerDisplay();
    updateTimerStatus('Timer idle.','info');
    google.script.run
      .withSuccessHandler(function(data){
        isPaused=true;
        updateLiveView(data);
      })
      .withFailureHandler(handleError)
      .stopPoll();
  }

  function onNextQuestion(){
    if(pollInterval)clearInterval(pollInterval);
    pauseTimerCountdown();
    stopVisualTimer();
    timerExpiredHandled=false;
    timerActive=false;
    timerRemainingSeconds=timerPresetSeconds;
    updateTimerDisplay();
    updateTimerStatus('Timer ready for next question.','info');
    isPaused=false;
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .nextQuestion();
  }

  function onResetQuestion(){
    var pollId=CURRENT_POLL_DATA.pollId;
    var questionIndex=CURRENT_POLL_DATA.questionIndex;
    if(!pollId||typeof questionIndex==='undefined'){
      alert('No active question to reset.');
      return;
    }
    if(!confirm('Reset the current question for all students?')){
      return;
    }
    var clearResponses=confirm('Select OK to reset and clear responses, or Cancel to reset while keeping submissions.');
    pauseTimerCountdown();
    stopVisualTimer();
    timerExpiredHandled=false;
    timerActive=false;
    timerRemainingSeconds=timerPresetSeconds;
    updateTimerDisplay();
    updateTimerStatus('Timer idle.','info');

    google.script.run
      .withSuccessHandler(function(data){
        isPaused=false;
        updateLiveView(data);
      })
      .withFailureHandler(handleError)
      .resetLiveQuestion(pollId,questionIndex,clearResponses);
  }

  function onEndPoll(){
    if(!confirm('Are you sure you want to end this poll completely?'))return;
    showDashboard();
    google.script.run
      .withSuccessHandler(function(data){
        if(data&&data.status!=='ENDED'){
          showDashboard();
        }
      })
      .withFailureHandler(handleError)
      .closePoll();
  }

  // --- Live View & Data Polling ---
  function updateLiveView(data){
    mainLoader.style.display='none';
    startPollBtn.disabled=false;

    if(!data){return;}

    var status=data.status||'PRE_LIVE';
    var isPreLive=status==='PRE_LIVE';
    var isEnded=status==='ENDED';

    if(!isLiveSession && !isPreLive){
      return;
    }

    if(isPreLive||isEnded){
      showDashboard();
      return;
    }

    if(data.error){handleError(data.error);return;}

    var previousQuestionIndex=typeof CURRENT_POLL_DATA.questionIndex==='number'?CURRENT_POLL_DATA.questionIndex:null;
    isPaused=status==='PAUSED';

    CURRENT_POLL_DATA.pollId=data.pollId||pollSelect.value;
    CURRENT_POLL_DATA.questionIndex=data.questionIndex;
    CURRENT_POLL_DATA.correctAnswer=data.correctAnswer;
    CURRENT_POLL_DATA.totalQuestions=data.totalQuestions;
    CURRENT_POLL_DATA.timerSeconds=data.timerSeconds||null;

    var questionChanged=previousQuestionIndex===null||data.questionIndex!==previousQuestionIndex;

    // Show live view
    setMainSection('live');
    headerDefault.style.display='none';
    headerLive.style.display='flex';

    // Update header
    document.getElementById('header-poll-name').textContent=data.pollName;

    // Update question dots
    updateQuestionDots(data.questionIndex,data.totalQuestions);

    // Show/hide pause/start buttons
    if(isPaused){
      document.getElementById('header-start-btn').style.display='flex';
      document.getElementById('header-pause-btn').style.display='none';
    } else {
      document.getElementById('header-start-btn').style.display='none';
      document.getElementById('header-pause-btn').style.display='flex';
    }

    if(questionChanged){
      var defaultSeconds=data.timerSeconds?Math.min(600,Math.max(15,parseInt(data.timerSeconds,10))):90;
      timerPresetSeconds=defaultSeconds;
      timerRemainingSeconds=timerPresetSeconds;
      timerExpiredHandled=false;
      timerActive=false;
      updateTimerInputs();
      updateTimerStatus('Timer idle.','info');
    }

    if(data.metadata){
      if(data.metadata.reason==='TIMER_EXPIRED'){
        timerRemainingSeconds=0;
        var previousState=timerActive;
        timerActive=true;
        updateTimerDisplay();
        timerActive=previousState;
        timerExpiredHandled=true;
        updateTimerStatus('Time expired — poll paused.','danger');
      } else if(data.metadata.reason==='MANUAL_PAUSE'){
        updateTimerStatus('Poll paused.','info');
      } else {
        updateTimerStatus('Timer idle.','info');
      }
    }

    // DEBUG: Log what teacher received
    console.log('=== TEACHER RECEIVED DATA ===');
    console.log('questionImageURL:', data.questionImageURL);
    console.log('options:', data.options);
    if(data.options && data.options.length>0){
      data.options.forEach(function(opt,idx){
        console.log('  Option '+idx+':', 'text="'+opt.text+'", imageURL='+opt.imageURL);
      });
    }

    // Update question display
    document.getElementById('live-question-info').textContent='Question '+(data.questionIndex+1)+' of '+data.totalQuestions;
    document.getElementById('live-question-text').textContent=data.questionText;

    // Handle question image with cache-busting
    var questionImageContainer=document.getElementById('question-image-container');
    var questionImageEl=document.getElementById('live-question-image');
    if(data.questionImageURL){
      questionImageContainer.style.display='block';

      // Add cache-busting query parameter based on question index
      // This ensures the browser re-fetches when switching questions
      var imageUrl=data.questionImageURL;
      var cacheBuster='q='+data.questionIndex;
      var separator=imageUrl.includes('?')?'&':'?';
      questionImageEl.src=imageUrl+separator+cacheBuster;

      // Also set referrerpolicy for cross-origin images
      questionImageEl.setAttribute('referrerpolicy','no-referrer');
    } else {
      questionImageContainer.style.display='none';
      questionImageEl.src='';
    }

    // Update response count
    document.getElementById('response-count').textContent=data.totalResponses+' / '+data.totalStudents+' answered';

    // Update results bars
    renderResultsBars(data.results,data.correctAnswer,data.studentStatusList);

    // Update student status
    currentStudentStatusData=data.studentStatusList;
    renderStudentStatus();

    if(pollInterval)clearInterval(pollInterval);
    if(!isPaused){
      pollInterval=setInterval(pollForResults,2500);
    }
  }

  function updateQuestionDots(current,total){
    var dotsContainer=document.getElementById('question-dots');
    dotsContainer.innerHTML='';
    for(var i=0;i<total;i++){
      var dot=document.createElement('span');
      dot.className='h-2 w-2 rounded-full '+(i===current?'bg-primary':'bg-primary/50');
      dotsContainer.appendChild(dot);
    }
  }

  function renderResultsBars(results,correctAnswer,studentsList){
    var container=document.getElementById('results-bars');
    container.innerHTML='';

    if(!results||Object.keys(results).length===0){
      container.innerHTML='<p class="text-center text-gray-500 py-4">Waiting for responses...</p>';
      return;
    }

    var total=Object.values(results).reduce(function(a,b){return a+b;},0);

    Object.keys(results).forEach(function(answer){
      var count=results[answer];
      var percentage=total>0?Math.round((count/total)*100):0;
      var isCorrect=answer===correctAnswer;

      var barDiv=document.createElement('div');
      if(isCorrect){
        barDiv.className='rounded-lg border-2 border-primary';
      }

      var correctClass=isCorrect?'correct-answer-bg':'';
      var bgClass=isCorrect?'bg-primary':'bg-primary/20 dark:bg-primary/50';
      var textClass=isCorrect?'text-brand-white mix-blend-difference':'text-brand-dark-gray dark:text-brand-white';

      var barHtml='<div class="relative flex items-center min-h-[3rem] '+correctClass+' rounded-lg bg-brand-light-gray dark:bg-brand-dark-gray/50 overflow-hidden cursor-pointer hover:bg-gray-200 dark:hover:bg-brand-dark-gray/60 transition-colors">';
      barHtml+='<div class="absolute inset-y-0 left-0 '+bgClass+'" style="width: '+percentage+'%;"></div>';
      barHtml+='<div class="relative flex w-full items-start justify-between p-3">';
      
      if(isCorrect){
        barHtml+='<div class="flex items-start gap-2"><span class="font-serif font-medium '+textClass+' text-sm">'+escapeHtml(answer)+'</span>';
        barHtml+='<span class="material-symbols-outlined '+textClass+' text-xl">check_circle</span></div>';
      } else {
        barHtml+='<span class="font-serif font-medium '+textClass+' text-sm">'+escapeHtml(answer)+'</span>';
      }
      
      barHtml+='<span class="font-bold '+textClass+' shrink-0 ml-4 text-sm">'+percentage+'%</span>';
      barHtml+='</div></div>';

      // Add student names who selected this answer (show for ALL answers)
      var studentsWithAnswer=studentsList.filter(function(s){return s.answer===answer;});
      if(studentsWithAnswer.length>0){
        var studentsBgClass=isCorrect?'bg-primary/5 dark:bg-primary/10':'bg-gray-100 dark:bg-gray-800/50';
        var studentBadgeBg=isCorrect?'bg-primary/10 dark:bg-primary/20':'bg-gray-200 dark:bg-gray-700';
        var studentTextClass=isCorrect?'text-primary dark:text-brand-white/80':'text-gray-700 dark:text-gray-300';

        barHtml+='<div class="'+studentsBgClass+' p-3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 rounded-b-md">';
        studentsWithAnswer.forEach(function(student){
          barHtml+='<span class="text-xs '+studentTextClass+' font-medium px-2 py-1 '+studentBadgeBg+' rounded">'+escapeHtml(student.name)+'</span>';
        });
        barHtml+='</div>';
      }

      barDiv.innerHTML=barHtml;
      container.appendChild(barDiv);
    });
  }

  function renderStudentStatus(){
    var grid=document.getElementById('student-status-grid');
    if(!grid)return;

    grid.innerHTML='';
    currentStudentStatusData.forEach(function(student){
      var tile=document.createElement('div');

      if(student.status==='Submitted'){
        var isCorrect=student.isCorrect===true;
        var isIncorrect=student.isCorrect===false;
        var icon=isCorrect?'check_circle':(isIncorrect?'cancel':'task_alt');
        var baseColorClass=isCorrect?'bg-green-500/10 dark:bg-green-500/20':(isIncorrect?'bg-red-500/10 dark:bg-red-500/20':'bg-blue-500/10 dark:bg-blue-500/20');
        var iconClass=isCorrect?'text-green-600 dark:text-green-300':(isIncorrect?'text-red-600 dark:text-red-300':'text-blue-600 dark:text-blue-300');
        var textClass=isCorrect?'text-green-800 dark:text-green-200':(isIncorrect?'text-red-800 dark:text-red-200':'text-blue-800 dark:text-blue-200');
        var subTextClass=isCorrect?'text-green-700/80 dark:text-green-200/80':(isIncorrect?'text-red-700/80 dark:text-red-200/80':'text-blue-700/80 dark:text-blue-200/80');
        var statusLabel=isCorrect?'Correct':(isIncorrect?'Incorrect':'Submitted');
        var answerLabel=student.answer?(' • '+escapeHtml(student.answer)):'';

        tile.className='flex items-center justify-between gap-3 p-3 rounded-lg '+baseColorClass;
        tile.innerHTML='<div class="flex items-center gap-3 min-w-0">'+
          '<span class="material-symbols-outlined text-xl '+iconClass+'">'+icon+'</span>'+
          '<div class="flex flex-col min-w-0">'+
          '<span class="text-sm font-semibold '+textClass+' truncate">'+escapeHtml(student.name)+'</span>'+
          '<span class="text-xs '+subTextClass+' truncate">'+statusLabel+answerLabel+'</span>'+
          '</div></div>'+
          '<button class="reset-btn flex-shrink-0 flex items-center justify-center gap-1 h-7 px-2.5 rounded-md bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-xs font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors" data-email="'+student.email+'">'+
          '<span class="material-symbols-outlined text-sm">refresh</span><span>Reset</span></button>';
      } else if(student.status==='LOCKED'){
        var lockedDuration='';
        if(student.lockedAt){
          try {
            var lockedMs=new Date()-new Date(student.lockedAt);
            var lockedSec=Math.floor(lockedMs/1000);
            lockedDuration=' • '+lockedSec+'s';
          } catch(e){
            lockedDuration='';
          }
        }
        tile.className='flex items-center justify-between p-3 rounded-lg bg-red-500/10 dark:bg-red-500/20 gap-3';
        tile.innerHTML='<div class="flex items-center gap-3 min-w-0">'+
          '<span class="material-symbols-outlined text-xl text-red-600 dark:text-red-300">lock</span>'+
          '<div class="flex flex-col min-w-0">'+
          '<span class="text-sm font-semibold text-red-800 dark:text-red-200 truncate">'+escapeHtml(student.name)+'</span>'+
          '<span class="text-xs text-red-600 dark:text-red-300">Locked v'+(student.lockVersion||0)+lockedDuration+'</span>'+
          '</div></div>'+
          '<button class="unlock-btn flex-shrink-0 flex items-center justify-center gap-1 h-7 px-2.5 rounded-md bg-red-500/20 text-red-700 dark:bg-red-400/20 dark:text-red-200 text-xs font-semibold hover:bg-red-500/30 transition-colors" data-email="'+student.email+'" data-poll-id="'+CURRENT_POLL_DATA.pollId+'" data-lock-version="'+(student.lockVersion || 0)+'">'+
          '<span class="material-symbols-outlined text-sm">lock_open</span><span>Approve</span></button>';
      } else if(student.status==='AWAITING_FULLSCREEN'){
        tile.className='flex items-center justify-between p-3 rounded-lg bg-blue-500/10 dark:bg-blue-500/20 gap-3';
        tile.innerHTML='<div class="flex items-center gap-3 min-w-0">'+
          '<span class="material-symbols-outlined text-xl text-blue-600 dark:text-blue-300">hourglass_empty</span>'+
          '<div class="flex flex-col min-w-0">'+
          '<span class="text-sm font-semibold text-blue-800 dark:text-blue-200 truncate">'+escapeHtml(student.name)+'</span>'+
          '<span class="text-xs text-blue-600 dark:text-blue-300">Awaiting fullscreen confirmation</span>'+
          '</div></div>';
      } else if(student.status==='Waiting...'){
        tile.className='flex items-center justify-between p-3 rounded-lg bg-gray-500/10 dark:bg-gray-500/20';
        tile.innerHTML='<div class="flex items-center gap-3">'+
          '<span class="material-symbols-outlined text-xl text-gray-500 dark:text-gray-300">pending</span>'+
          '<span class="text-sm font-medium text-gray-600 dark:text-gray-300 truncate">'+escapeHtml(student.name)+'</span></div>';
      } else {
        tile.className='flex items-center justify-between p-3 rounded-lg bg-orange-500/10 dark:bg-orange-500/20';
        tile.innerHTML='<div class="flex items-center gap-3">'+
          '<span class="material-symbols-outlined text-xl text-orange-600 dark:text-orange-300">error</span>'+
          '<span class="text-sm font-medium text-orange-700 dark:text-orange-200 truncate">'+escapeHtml(student.name)+'</span></div>';
      }

      grid.appendChild(tile);
    });

    // Setup unlock listeners
    grid.querySelectorAll('.unlock-btn').forEach(function(btn){
      btn.onclick=function(){
        var email=this.dataset.email;
        var pollId=this.dataset.pollId;
        var lockVersion = parseInt(this.dataset.lockVersion, 10);

        if(!email||!pollId)return;

        if(!confirm('Unlock ' + email + '?')) {
            return;
        }

        this.disabled=true;
        this.querySelector('span:last-child').textContent='Unlocking...';

        google.script.run
          .withSuccessHandler(function(response) {
            if (response.ok) {
              currentStudentStatusData=currentStudentStatusData.map(function(s){
                if(s.email===email){
                  return {
                    name: s.name,
                    email: s.email,
                    status: 'AWAITING_FULLSCREEN',
                    lockVersion: response.lockVersion || lockVersion,
                    lockReason: s.lockReason,
                    lockedAt: s.lockedAt,
                    answer: s.answer,
                    isCorrect: s.isCorrect,
                    timestamp: s.timestamp
                  };
                }
                return s;
              });
              renderStudentStatus();
              pollForResults();
            } else if (response.reason === 'version_mismatch') {
              alert('Student has a newer violation (v' + response.lockVersion + '). Please refresh and try again.');
              pollForResults();
            } else if (response.reason === 'not_locked') {
              alert('Student is not locked. Status: ' + (response.status || 'unknown'));
              pollForResults();
            } else {
              alert('Unlock failed: ' + (response.reason || 'Unknown error'));
              pollForResults();
            }
          })
          .withFailureHandler(function(error) {
            alert('Error: ' + error.message);
            btn.disabled = false;
            btn.querySelector('span:last-child').textContent = 'Approve';
          })
          .teacherApproveUnlock(email, pollId, lockVersion);
      };
    });

    grid.querySelectorAll('.reset-btn').forEach(function(btn){
      btn.onclick=function(){
        var email=this.dataset.email;
        var pollId=CURRENT_POLL_DATA.pollId;
        var questionIndex=CURRENT_POLL_DATA.questionIndex;
        if(!email||pollId===undefined||questionIndex===undefined)return;
        var button=this;
        button.disabled=true;
        button.querySelector('span:last-child').textContent='Resetting...';
        google.script.run
          .withSuccessHandler(pollForResults)
          .withFailureHandler(function(error){
            handleError(error);
            button.disabled=false;
            button.querySelector('span:last-child').textContent='Reset';
          })
          .resetStudentResponse(email,pollId,questionIndex);
      };
    });
  }

  function pollForResults(){
    if(isPaused||!isLiveSession)return;
    var pollId=CURRENT_POLL_DATA.pollId;
    var questionIndex=CURRENT_POLL_DATA.questionIndex;
    if(pollId===undefined||questionIndex===undefined)return;

    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(function(e){console.warn('Poll refresh error:',e);})
      .getLivePollData(pollId,questionIndex);
  }

  // --- Timer Controls ---
  var timerPresetSeconds = 90;
  var timerRemainingSeconds = 90;
  var timerExpiredHandled = false;
  var timerActive = false;

  function formatSeconds(seconds){
    var safeSeconds = Math.max(0, Math.round(seconds || 0));
    var minutes = Math.floor(safeSeconds/60);
    var secs = safeSeconds%60;
    return (minutes<10?'0':'')+minutes+':' + (secs<10?'0':'')+secs;
  }

  function parseTimerValue(value){
    if(!value)return null;
    var trimmed=value.trim();
    if(trimmed.length===0)return null;
    if(trimmed.includes(':')){
      var parts=trimmed.split(':');
      if(parts.length===2){
        var minutes=parseInt(parts[0],10);
        var seconds=parseInt(parts[1],10);
        if(isFinite(minutes)&&isFinite(seconds)){
          var total=(minutes*60)+seconds;
          return Math.min(600,Math.max(15,total));
        }
      }
    }
    var numeric=parseInt(trimmed,10);
    if(isFinite(numeric)){
      return Math.min(600,Math.max(15,numeric));
    }
    return null;
  }

  function updateTimerInputs(){
    var input=document.getElementById('live-timer-input');
    if(input){
      input.value=formatSeconds(timerPresetSeconds);
    }
    updateTimerDisplay();
  }

  function updateTimerDisplay(){
    var timerDisplay=document.getElementById('live-timer-display');
    if(!timerDisplay)return;

    var displaySeconds;
    if(timerActive){
      displaySeconds=timerRemainingSeconds;
    } else if(timerExpiredHandled && timerRemainingSeconds<=0){
      displaySeconds=0;
    } else {
      displaySeconds=timerRemainingSeconds>0?timerRemainingSeconds:timerPresetSeconds;
    }
    timerDisplay.textContent = formatSeconds(displaySeconds);

    if(timerActive && displaySeconds<=10){
      timerDisplay.className='text-5xl font-bold text-red-600 dark:text-red-400 tracking-tighter font-mono animate-pulse';
    } else {
      timerDisplay.className='text-5xl font-bold text-primary dark:text-brand-white tracking-tighter font-mono';
    }
  }

  function updateTimerStatus(message, tone){
    var statusEl=document.getElementById('timer-status-message');
    if(!statusEl)return;
    statusEl.textContent=message;
    if(tone==='danger'){
      statusEl.className='text-xs text-red-600 dark:text-red-400 text-center font-medium';
    } else if(tone==='success'){
      statusEl.className='text-xs text-green-600 dark:text-green-400 text-center font-medium';
    } else {
      statusEl.className='text-xs text-brand-dark-gray/60 dark:text-brand-white/60 text-center';
    }
  }

  function adjustTimerPreset(delta){
    if(timerActive)return;
    timerPresetSeconds = Math.min(600, Math.max(15, timerPresetSeconds + delta));
    timerRemainingSeconds = timerPresetSeconds;
    timerExpiredHandled=false;
    updateTimerInputs();
    updateTimerStatus('Preset updated to '+formatSeconds(timerPresetSeconds)+'.','info');
  }

  function startTimerCountdown(){
    if(timerActive)return;
    timerExpiredHandled=false;
    if(timerRemainingSeconds<=0){
      timerRemainingSeconds=timerPresetSeconds;
    }
    timerActive=true;
    updateTimerDisplay();
    updateTimerStatus('Timer running…','info');
    stopVisualTimer();
    visualTimerInterval=setInterval(function(){
      timerRemainingSeconds-=1;
      updateTimerDisplay();
      if(timerRemainingSeconds<=0){
        clearInterval(visualTimerInterval);
        timerActive=false;
        updateTimerDisplay();
        if(!timerExpiredHandled){
          timerExpiredHandled=true;
          updateTimerStatus('Time expired — poll paused.','danger');
          google.script.run
            .withSuccessHandler(function(data){
              isPaused=true;
              updateLiveView(data);
            })
            .withFailureHandler(handleError)
            .pausePollForTimerExpiry();
        }
      }
    },1000);
  }

  function pauseTimerCountdown(){
    if(!timerActive)return;
    timerActive=false;
    clearInterval(visualTimerInterval);
    updateTimerDisplay();
    updateTimerStatus('Timer paused at '+formatSeconds(timerRemainingSeconds)+'.','info');
  }

  function resetTimerCountdown(){
    clearInterval(visualTimerInterval);
    timerActive=false;
    timerPresetSeconds=90;
    timerRemainingSeconds=timerPresetSeconds;
    timerExpiredHandled=false;
    updateTimerInputs();
    updateTimerStatus('Timer reset to 01:30.','info');
  }

  function stopVisualTimer(){
    clearInterval(visualTimerInterval);
    visualTimerInterval=null;
  }

  // --- Student Link Controls ---
  function onSendLink(){
    var btn=document.getElementById('send-link-btn');
    var className=btn.dataset.className;
    if(!className){alert('Please select a poll first.');return;}
    if(!confirm('This will email a new, unique poll link to all students in '+className+'. Are you sure?'))return;

    btn.disabled=true;
    btn.innerHTML='<div class="h-5 w-5 animate-spin rounded-full border-2 border-white border-t-transparent"></div>';

    google.script.run
      .withSuccessHandler(function(response){
        alert('✅ Successfully sent '+response.count+' poll links.');
        btn.disabled=false;
        btn.innerHTML='<span class="material-symbols-outlined text-xl">mail</span><span class="truncate">Send Student Links</span>';
      })
      .withFailureHandler(function(err){
        handleError(err);
        btn.disabled=false;
        btn.innerHTML='<span class="material-symbols-outlined text-xl">mail</span><span class="truncate">Send Student Links</span>';
      })
      .sendPollLinkToClass(className);
  }

  function onViewLinks(){
    var btn=document.getElementById('view-links-btn');
    var className=btn.dataset.className;
    if(!className){alert('Please select a poll first.');return;}
    btn.disabled=true;

    google.script.run
      .withSuccessHandler(function(response){
        if(!response.success)return handleError(new Error('Could not load links'));

        var container=document.getElementById('links-container');
        var html='<div class="overflow-x-auto"><table class="w-full border-collapse">';
        html+='<thead><tr class="bg-brand-light-gray dark:bg-brand-dark-gray/50 border-b-2 border-brand-light-gray dark:border-brand-dark-gray/40">';
        html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Student Name</th>';
        html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Email</th>';
        html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Link</th>';
        html+='<th class="px-4 py-3 text-center text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Actions</th>';
        html+='</tr></thead><tbody>';

        response.links.forEach(function(link){
          html+='<tr class="border-b border-brand-light-gray/50 dark:border-brand-dark-gray/20 hover:bg-brand-light-gray/30 dark:hover:bg-brand-dark-gray/10">';
          html+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+escapeHtml(link.name)+'</td>';
          html+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+escapeHtml(link.email)+'</td>';
          html+='<td class="px-4 py-3 text-xs font-mono text-brand-dark-gray/70 dark:text-brand-white/70 max-w-[200px] truncate" title="'+escapeHtml(link.url)+'">'+(link.hasActiveLink?escapeHtml(link.url):'<i class="text-gray-400">No active link</i>')+'</td>';
          html+='<td class="px-4 py-3 text-center">';
          if(link.hasActiveLink){
            html+='<button class="copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors" data-url="'+escapeHtml(link.url)+'">Copy</button>';
          }
          html+='</td></tr>';
        });

        html+='</tbody></table></div>';
        container.innerHTML=html;

        container.querySelectorAll('.copy-link-btn').forEach(function(btn){
          btn.onclick=function(){
            var url=this.dataset.url;
            try{
              var tempInput=document.createElement('input');
              document.body.appendChild(tempInput);
              tempInput.value=url;
              tempInput.select();
              document.execCommand('copy');
              document.body.removeChild(tempInput);

              btn.textContent='✓ Copied!';
              btn.className='copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-green-600 text-brand-white';
              setTimeout(function(){
                btn.textContent='Copy';
                btn.className='copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors';
              }, 2000);
            } catch(err) {
              alert('Could not copy link. Please copy it manually.');
            }
          };
        });

        linksModal.style.display='flex';
        btn.disabled=false;
      })
      .withFailureHandler(function(err){
        handleError(err);
        btn.disabled=false;
      })
      .getStudentLinksForClass(className);
  }

  function closeLinksModal(){
    linksModal.style.display='none';
  }

  function setSaveStatus(message){
    var saveStatus=document.getElementById('save-status');
    if(saveStatus){
      saveStatus.textContent=message;
    }
  }

  function markPollDirty(){
    if(!isPollDirty){
      isPollDirty=true;
    }
    setSaveStatus('Unsaved changes');
  }

  function resetPollDirty(message){
    isPollDirty=false;
    setSaveStatus(message||'All changes saved');
  }

  // --- Poll Creator Modal ---
  function openPollCreator(existingPoll){
    var saveButton=document.getElementById('save-poll-btn');

    questionCounter=0;
    questions=[];
    selectedQuestionIndex=0;

    if(existingPoll){
      editingPollId=existingPoll.pollId;
      document.getElementById('new-poll-name').value=existingPoll.pollName||'';
      if(existingPoll.className){
        refreshClassOptions(BASE_CLASSES.concat([existingPoll.className]));
      }
      classSelect.value=existingPoll.className||'';
      questions=existingPoll.questions.map(function(question){
        var answers=(question.options||[]).map(function(opt){
          return {
            text:opt.text||'',
            image:opt.imageURL||null,
            imageURL:opt.imageURL||null,
            imageFileId:opt.imageFileId||null
          };
        });
        if(answers.length<2){
          while(answers.length<2){
            answers.push({text:'',image:null,imageURL:null,imageFileId:null});
          }
        }
        var correctIndex=0;
        answers.forEach(function(answer,idx){
          if(answer.text===question.correctAnswer){
            correctIndex=idx;
          }
        });
        return {
          questionText:question.questionText||'',
          questionImage:null,
          questionImageURL:question.questionImageURL||null,
          questionImageFileId:question.questionImageFileId||null,
          answers:answers,
          correctAnswerIndex:correctIndex,
          timerSeconds:question.timerSeconds||null
        };
      });
      if(questions.length===0){
        addQuestion(true);
      }
      questionCounter=questions.length;
      selectedQuestionIndex=0;
      saveButton.innerHTML='<span class="truncate">Save Changes</span>';
      resetPollDirty('Editing existing poll');
    } else {
      editingPollId=null;
      document.getElementById('new-poll-name').value='';
      classSelect.value='';
      addQuestion(true);
      saveButton.innerHTML='<span class="truncate">Publish Poll</span>';
      resetPollDirty('All changes saved');
    }

    renderQuestionNavigator();
    renderQuestionWorkspace();
    modal.style.display='flex';
  }

  function closePollCreator(){
    modal.style.display='none';
    questions=[];
    questionCounter=0;
    selectedQuestionIndex=0;
    editingPollId=null;
    document.getElementById('save-poll-btn').innerHTML='<span class="truncate">Publish Poll</span>';
    resetPollDirty('All changes saved');
  }

  function addQuestion(suppressDirty){
    var skipDirty=suppressDirty===true;
    var newQuestion={
      questionText:'',
      questionImage:null,
      questionImageURL:null,
      questionImageFileId:null,
      answers:[
        {text:'',image:null,imageURL:null,imageFileId:null},
        {text:'',image:null,imageURL:null,imageFileId:null}
      ],
      correctAnswerIndex:0,
      timerSeconds:null
    };
    questions.push(newQuestion);
    selectedQuestionIndex=questions.length-1;
    if(!skipDirty){
      markPollDirty();
    }
    renderQuestionNavigator();
    renderQuestionWorkspace();
  }

  function deleteQuestion(index){
    if(questions.length<=1){
      alert('A poll must have at least one question.');
      return;
    }
    questions.splice(index,1);
    selectedQuestionIndex=Math.max(0,Math.min(selectedQuestionIndex,questions.length-1));
    renderQuestionNavigator();
    renderQuestionWorkspace();
    markPollDirty();
  }

  function duplicateQuestionLocal(index){
    if(questions.length>=50){
      alert('Maximum 50 questions per poll. Cannot duplicate.');
      return;
    }
    // Deep copy the question
    var questionToDuplicate=questions[index];
    var duplicatedQuestion=JSON.parse(JSON.stringify(questionToDuplicate));

    // Insert the duplicated question right after the original
    questions.splice(index+1,0,duplicatedQuestion);
    questionCounter++;
    selectedQuestionIndex=index+1;

    renderQuestionNavigator();
    renderQuestionWorkspace();
    markPollDirty();
  }

  function renderQuestionNavigator(){
    var nav=document.getElementById('question-navigator');
    nav.innerHTML='';
    
    questions.forEach(function(q,index){
      var isSelected=index===selectedQuestionIndex;
      var div=document.createElement('div');
      div.className='group relative flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer '+(isSelected?'bg-primary/20 dark:bg-primary/30':'hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10');
      
      var html='<span class="material-symbols-outlined '+(isSelected?'text-brand-dark-gray dark:text-brand-white':'text-brand-dark-gray/50 dark:text-brand-white/50')+'">drag_indicator</span>';
      html+='<p class="'+(isSelected?'text-primary dark:text-brand-white':'text-brand-dark-gray dark:text-brand-white')+' text-sm font-medium leading-normal">Question '+(index+1)+'</p>';

      html+='<div class="absolute right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">';
      html+='<button class="duplicate-question-btn p-1 rounded-full hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10" data-index="'+index+'" title="Duplicate question">';
      html+='<span class="material-symbols-outlined text-brand-dark-gray dark:text-brand-white text-base">content_copy</span>';
      html+='</button>';
      if(questions.length>1){
        html+='<button class="delete-question-btn p-1 rounded-full hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10" data-index="'+index+'" title="Delete question">';
        html+='<span class="material-symbols-outlined text-brand-dark-gray dark:text-brand-white text-base">close</span>';
        html+='</button>';
      }
      html+='</div>';

      div.innerHTML=html;

      div.onclick=function(e){
        if(e.target.classList.contains('material-symbols-outlined')&&(e.target.textContent==='close'||e.target.textContent==='content_copy'))return;
        selectedQuestionIndex=index;
        renderQuestionNavigator();
        renderQuestionWorkspace();
      };

      var duplicateBtn=div.querySelector('.duplicate-question-btn');
      if(duplicateBtn){
        duplicateBtn.onclick=function(e){
          e.stopPropagation();
          duplicateQuestionLocal(parseInt(this.dataset.index));
        };
      }

      var closeBtn=div.querySelector('.delete-question-btn');
      if(closeBtn){
        closeBtn.onclick=function(e){
          e.stopPropagation();
          deleteQuestion(parseInt(this.dataset.index));
        };
      }
      
      nav.appendChild(div);
    });
  }

  function renderQuestionWorkspace(){
    var workspace=document.getElementById('question-builder-workspace');
    var question=questions[selectedQuestionIndex];

    var html='<div class="max-w-4xl mx-auto">';
    html+='<div class="flex flex-wrap justify-between gap-3 mb-6">';
    html+='<div class="flex min-w-72 flex-col gap-1">';
    html+='<p class="text-brand-dark-gray dark:text-brand-white tracking-light text-[32px] font-bold leading-tight">Question '+(selectedQuestionIndex+1)+'</p>';
    html+='<p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm font-normal leading-normal">Edit the question and answer choices below.</p>';
    html+='</div></div>';

    html+='<div class="bg-brand-white dark:bg-brand-dark-gray/20 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/30 p-6 shadow-sm mb-6">';
    html+='<label class="flex flex-col w-full">';
    html+='<p class="text-brand-dark-gray dark:text-brand-white text-base font-medium leading-normal pb-2">Question Text</p>';
    html+='<textarea id="question-text-input" class="form-input flex w-full min-w-0 flex-1 resize-y overflow-hidden rounded-lg text-brand-dark-gray dark:text-brand-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 focus:border-primary min-h-36 placeholder:text-brand-dark-gray/50 dark:placeholder:text-brand-white/50 p-[15px] text-base font-normal leading-normal" placeholder="Type your question here...">'+escapeHtml(question.questionText||'')+'</textarea>';
    html+='</label>';
    html+='<div class="flex mt-4 items-center gap-3 flex-wrap">';
    html+='<label class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-light-gray dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white gap-2 pl-3 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/60 transition-colors">';
    html+='<span class="material-symbols-outlined text-xl">image</span>';
    html+='<span class="truncate">Upload Image</span>';
    html+='<input type="file" class="hidden" accept="image/*" id="question-image-input">';
    html+='</label>';
    html+='</div>';

    // Show image preview or uploading state
    var questionImagePreview=getImagePreviewUrl(question.questionImage||question.questionImageURL,question.questionImageFileId);
    var isUploading=question.questionImage==='UPLOADING';

    if(questionImagePreview||isUploading){
      html+='<div class="mt-4 flex flex-wrap items-center gap-3 bg-primary/5 dark:bg-primary/10 p-3 rounded-lg">';
      if(isUploading){
        html+='<div class="flex items-center gap-2 text-primary dark:text-brand-white">';
        html+='<div class="h-5 w-5 animate-spin rounded-full border-2 border-primary border-t-transparent"></div>';
        html+='<span class="text-sm font-medium">Uploading image...</span>';
        html+='</div>';
      } else if(questionImagePreview){
        html+='<img src="'+questionImagePreview+'" class="rounded-lg max-w-xs h-auto" referrerpolicy="no-referrer">';
        html+='<button type="button" class="remove-question-image-btn h-9 px-4 rounded-lg bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-sm font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors">Remove Image</button>';
      }
      html+='</div>';
    }

    html+='<div class="mt-4">';
    html+='<label class="text-brand-dark-gray dark:text-brand-white text-sm font-medium leading-normal block pb-2" for="question-timer-input">Suggested Timer (seconds)</label>';
    html+='<input id="question-timer-input" type="number" min="0" max="600" class="w-40 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" value="'+(question.timerSeconds||'')+'">';
    html+='<p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-1">Leave blank to control the timer manually during the live poll.</p>';
    html+='</div>';

    html+='</div>';

    html+='<div class="bg-brand-white dark:bg-brand-dark-gray/20 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/30 p-6 shadow-sm">';
    html+='<p class="text-brand-dark-gray dark:text-brand-white text-base font-medium leading-normal pb-4">Answer Choices</p>';
    html+='<div class="flex flex-col gap-4">';

    question.answers.forEach(function(answer,aIndex){
      html+=renderAnswerChoice(answer,aIndex,question.correctAnswerIndex===aIndex);
    });

    html+='</div>';
    html+='<div class="mt-4">';
    html+='<button id="add-answer-btn" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-light-gray dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/60 transition-colors">';
    html+='<span class="truncate">+ Add Answer Choice</span>';
    html+='</button></div></div></div>';

    workspace.innerHTML=html;

    document.getElementById('question-text-input').oninput=function(){
      questions[selectedQuestionIndex].questionText=this.value;
      markPollDirty();
    };

    var qImgInput=document.getElementById('question-image-input');
    if(qImgInput){
      qImgInput.onchange=function(){
        if(this.files&&this.files[0]){
          var file=this.files[0];

          // Show loading state
          var currentQuestion=questions[selectedQuestionIndex];
          currentQuestion.questionImage='UPLOADING';
          currentQuestion.questionImageURL=null;
          renderQuestionWorkspace();

          // Upload immediately to Drive
          uploadFile(file).then(function(fileId){
            // Store the fileId (not URL) - URLs generated at render time via proxy
            questions[selectedQuestionIndex].questionImageFileId=fileId;
            questions[selectedQuestionIndex].questionImage=null;
            questions[selectedQuestionIndex].questionImageURL=null;
            markPollDirty();
            renderQuestionWorkspace();
          }).catch(function(error){
            alert('Image upload failed: '+(error.message||error));
            questions[selectedQuestionIndex].questionImage=null;
            questions[selectedQuestionIndex].questionImageFileId=null;
            questions[selectedQuestionIndex].questionImageURL=null;
            renderQuestionWorkspace();
          });
        }
      };
    }

    var removeQImgBtn=workspace.querySelector('.remove-question-image-btn');
    if(removeQImgBtn){
      removeQImgBtn.onclick=function(){
        questions[selectedQuestionIndex].questionImage=null;
        questions[selectedQuestionIndex].questionImageURL=null;
        questions[selectedQuestionIndex].questionImageFileId=null;
        markPollDirty();
        renderQuestionWorkspace();
      };
    }

    var timerInput=document.getElementById('question-timer-input');
    if(timerInput){
      timerInput.oninput=function(){
        var value=parseInt(this.value,10);
        questions[selectedQuestionIndex].timerSeconds=isNaN(value)||value<=0?null:value;
        markPollDirty();
      };
    }

    document.getElementById('add-answer-btn').onclick=function(){
      questions[selectedQuestionIndex].answers.push({text:'',image:null,imageURL:null,imageFileId:null});
      markPollDirty();
      renderQuestionWorkspace();
    };

    workspace.querySelectorAll('.answer-text-input').forEach(function(input,index){
      input.oninput=function(){
        questions[selectedQuestionIndex].answers[index].text=this.value;
        markPollDirty();
      };
    });

    workspace.querySelectorAll('.correct-radio').forEach(function(radio,index){
      radio.onchange=function(){
        if(this.checked){
          questions[selectedQuestionIndex].correctAnswerIndex=index;
          markPollDirty();
        }
      };
    });

    workspace.querySelectorAll('.delete-answer-btn').forEach(function(btn,index){
      btn.onclick=function(){
        deleteAnswer(index);
      };
    });

    workspace.querySelectorAll('.answer-image-input').forEach(function(input,index){
      input.onchange=function(){
        if(this.files&&this.files[0]){
          var file=this.files[0];

          // Show loading state
          var currentAnswer=questions[selectedQuestionIndex].answers[index];
          currentAnswer.image='UPLOADING';
          currentAnswer.imageURL=null;
          renderQuestionWorkspace();

          // Upload immediately to Drive
          uploadFile(file).then(function(fileId){
            // Store the fileId (not URL) - URLs generated at render time via proxy
            questions[selectedQuestionIndex].answers[index].imageFileId=fileId;
            questions[selectedQuestionIndex].answers[index].image=null;
            questions[selectedQuestionIndex].answers[index].imageURL=null;
            markPollDirty();
            renderQuestionWorkspace();
          }).catch(function(error){
            alert('Image upload failed: '+(error.message||error));
            questions[selectedQuestionIndex].answers[index].image=null;
            questions[selectedQuestionIndex].answers[index].imageFileId=null;
            questions[selectedQuestionIndex].answers[index].imageURL=null;
            renderQuestionWorkspace();
          });
        }
      };
    });

    workspace.querySelectorAll('.remove-answer-image-btn').forEach(function(btn){
      btn.onclick=function(){
        var idx=parseInt(this.dataset.index,10);
        questions[selectedQuestionIndex].answers[idx].image=null;
        questions[selectedQuestionIndex].answers[idx].imageURL=null;
        questions[selectedQuestionIndex].answers[idx].imageFileId=null;
        markPollDirty();
        renderQuestionWorkspace();
      };
    });
  }

  function renderAnswerChoice(answer,index,isCorrect){
    var html='<div class="flex items-center gap-3">';
    html+='<label class="relative flex items-center justify-center cursor-pointer" title="Set as correct answer">';
    html+='<input class="correct-radio peer h-5 w-5 cursor-pointer appearance-none rounded-full border border-brand-light-gray dark:border-brand-white/30 checked:border-primary checked:bg-primary transition-all" name="correct_answer" type="radio" '+(isCorrect?'checked':'')+'/>';
    html+='<span class="material-symbols-outlined absolute text-brand-white transition-opacity opacity-0 peer-checked:opacity-100 text-sm">check</span>';
    html+='</label>';
    html+='<input class="answer-text-input form-input flex-1 rounded-lg text-brand-dark-gray dark:text-brand-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 focus:border-primary placeholder:text-brand-dark-gray/50 dark:placeholder:text-brand-white/50 p-3 text-base" placeholder="Answer '+String.fromCharCode(65+index)+'" type="text" value="'+escapeHtml(answer.text||'')+'"/>';
    html+='<label class="p-2 rounded-lg hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10 transition-colors cursor-pointer" title="Upload image for this answer">';
    html+='<span class="material-symbols-outlined text-brand-dark-gray/60 dark:text-brand-white/60">image</span>';
    html+='<input type="file" class="answer-image-input hidden" accept="image/*">';
    html+='</label>';

    if(questions[selectedQuestionIndex].answers.length>2){
      html+='<button class="delete-answer-btn p-2 rounded-lg hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10 transition-colors" title="Remove this answer">';
      html+='<span class="material-symbols-outlined text-brand-dark-gray/60 dark:text-brand-white/60">delete</span>';
      html+='</button>';
    } else {
      html+='<div class="w-10"></div>';
    }

    html+='</div>';

    // Show image preview or uploading state for answer choices
    var answerPreview=getImagePreviewUrl(answer.image||answer.imageURL,answer.imageFileId);
    var isAnswerUploading=answer.image==='UPLOADING';

    if(answerPreview||isAnswerUploading){
      html+='<div class="mt-2 flex items-center gap-3 bg-primary/5 dark:bg-primary/10 p-2 rounded-lg">';
      if(isAnswerUploading){
        html+='<div class="flex items-center gap-2 text-primary dark:text-brand-white">';
        html+='<div class="h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent"></div>';
        html+='<span class="text-xs font-medium">Uploading...</span>';
        html+='</div>';
      } else if(answerPreview){
        html+='<img src="'+answerPreview+'" class="rounded-md max-w-[160px] h-auto" referrerpolicy="no-referrer">';
        html+='<button type="button" class="remove-answer-image-btn h-8 px-3 rounded-md bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-xs font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors" data-index="'+index+'">Remove</button>';
      }
      html+='</div>';
    }

    return html;
  }

  function deleteAnswer(index){
    if(questions[selectedQuestionIndex].answers.length<=2){
      alert('A question must have at least two answer choices.');
      return;
    }
    questions[selectedQuestionIndex].answers.splice(index,1);
    if(questions[selectedQuestionIndex].correctAnswerIndex>=index){
      questions[selectedQuestionIndex].correctAnswerIndex=Math.max(0,questions[selectedQuestionIndex].correctAnswerIndex-1);
    }
    markPollDirty();
    renderQuestionWorkspace();
  }

  // Helper to get web app base URL for generating proxy URLs
  function getWebAppUrl(){
    // Use current page URL (web app deployment URL)
    var url=window.location.href;
    // Remove query parameters
    var baseUrl=url.split('?')[0];
    return baseUrl;
  }

  // Helper to generate Google Drive thumbnail URL from fileId
  function generateProxyUrl(fileId){
    if(!fileId||typeof fileId!=='string'){
      return'';
    }
    // Use Google Drive thumbnail API for direct image display
    // sz=w1000 specifies max width of 1000px (adjustable)
    return 'https://drive.google.com/thumbnail?id='+encodeURIComponent(fileId)+'&sz=w1000';
  }

  function getImagePreviewUrl(imageData,fileId){
    // If fileId is provided, generate proxy URL
    if(fileId&&typeof fileId==='string'){
      return generateProxyUrl(fileId);
    }

    // Otherwise handle legacy data
    if(imageData instanceof File){
      return URL.createObjectURL(imageData);
    }
    if(typeof imageData==='string'&&imageData){
      // Return the URL, unless it's the special UPLOADING marker
      if(imageData==='UPLOADING'){
        return'';
      }
      return imageData;
    }
    return'';
  }

  // --- Poll & Image Uploader ---
  function savePoll(){
    var savePollBtn=document.getElementById('save-poll-btn');
    var defaultLabel=editingPollId?'<span class="truncate">Save Changes</span>':'<span class="truncate">Publish Poll</span>';

    savePollBtn.disabled=true;
    savePollBtn.innerHTML='<div class="h-5 w-5 animate-spin rounded-full border-2 border-primary border-t-transparent"></div><span>Saving...</span>';

    var pollName=document.getElementById('new-poll-name').value.trim();
    var className=(classSelect.value||'').trim();

    if(!pollName||!className){
      alert('Please enter a poll name and select a class.');
      savePollBtn.disabled=false;
      savePollBtn.innerHTML=defaultLabel;
      return;
    }

    if(questions.length===0){
      alert('Please add at least one question.');
      savePollBtn.disabled=false;
      savePollBtn.innerHTML=defaultLabel;
      return;
    }

    var validationError='';
    questions.forEach(function(question,index){
      if(validationError)return;
      var questionText=(question.questionText||'').trim();
      if(questionText===''){
        validationError='Question '+(index+1)+' needs question text.';
        return;
      }
      var answerTexts=question.answers.map(function(answer){return(answer.text||'').trim();});
      var filledAnswers=answerTexts.filter(function(text){return text!=='';});
      if(filledAnswers.length<2){
        validationError='Question '+(index+1)+' must include at least two answer choices with text.';
        return;
      }
      var correctIndex=typeof question.correctAnswerIndex==='number'?question.correctAnswerIndex:0;
      if(correctIndex<0||correctIndex>=answerTexts.length){
        validationError='Question '+(index+1)+' has an invalid correct answer selection.';
        return;
      }
      if(answerTexts[correctIndex]===''){
        validationError='Question '+(index+1)+' must mark a correct answer with text.';
      }
    });

    if(validationError){
      alert(validationError);
      savePollBtn.disabled=false;
      savePollBtn.innerHTML=defaultLabel;
      return;
    }

    // Check for any images still uploading
    var uploadsInProgress=false;
    questions.forEach(function(question,index){
      if(question.questionImage==='UPLOADING'){
        uploadsInProgress=true;
        alert('Question '+(index+1)+' image is still uploading. Please wait for upload to complete.');
      }
      question.answers.forEach(function(answer,aIndex){
        if(answer.image==='UPLOADING'){
          uploadsInProgress=true;
          alert('Question '+(index+1)+', answer '+(aIndex+1)+' image is still uploading. Please wait for upload to complete.');
        }
      });
    });

    if(uploadsInProgress){
      savePollBtn.disabled=false;
      savePollBtn.innerHTML=defaultLabel;
      return;
    }

    // Build sanitized questions - all images should already be uploaded
    var sanitizedQuestions=questions.map(function(question){
      var answers=question.answers.map(function(answer){
        var text=(answer.text||'').trim();
        // Use imageFileId as canonical field (not URL)
        return{
          text:text,
          imageFileId:answer.imageFileId||null,
          imageURL:answer.imageURL||null  // Keep for backward compatibility
        };
      });

      var correctIndex=typeof question.correctAnswerIndex==='number'?question.correctAnswerIndex:0;
      if(correctIndex<0){correctIndex=0;}
      if(correctIndex>=answers.length){
        correctIndex=Math.max(0,answers.length-1);
      }

      var timerValue=null;
      if(typeof question.timerSeconds==='number'){
        timerValue=question.timerSeconds;
      } else if(typeof question.timerSeconds==='string'&&question.timerSeconds.trim()!==''){
        timerValue=parseInt(question.timerSeconds,10);
      }
      if(timerValue&&(!isFinite(timerValue)||timerValue<=0)){
        timerValue=null;
      }
      if(timerValue){
        timerValue=Math.min(Math.round(timerValue),600);
      }

      // Use questionImageFileId as canonical field (not URL)
      return{
        questionText:(question.questionText||'').trim(),
        questionImageFileId:question.questionImageFileId||null,
        questionImageURL:question.questionImageURL||null,  // Keep for backward compatibility
        answers:answers,
        correctAnswerIndex:correctIndex,
        timerSeconds:timerValue&&timerValue>0?timerValue:null
      };
    });

    // No upload tasks needed - images are uploaded immediately when selected
    Promise.resolve().then(function(){
      var payloadQuestions=sanitizedQuestions.map(function(question){
        var options=question.answers.map(function(answer){
          var imageUrl=answer.imageURL||null;
          var imageFileId=answer.imageFileId||null;
          return{
            text:answer.text,
            image:imageUrl,
            imageURL:imageUrl,
            imageFileId:imageFileId
          };
        });
        var correctIndex=question.correctAnswerIndex;
        if(correctIndex<0||correctIndex>=options.length){
          correctIndex=Math.max(0,options.length-1);
        }
        var correctAnswerText=options[correctIndex]?options[correctIndex].text:null;
        var imageUrl=question.questionImageURL||null;
        var imageFileId=question.questionImageFileId||null;
        return{
          questionText:question.questionText,
          questionImage:imageUrl,
          questionImageURL:imageUrl,
          questionImageFileId:imageFileId,
          options:options,
          correctAnswer:correctAnswerText,
          timerSeconds:question.timerSeconds||null
        };
      });

      // Validate payload before sending
      if(!payloadQuestions||payloadQuestions.length===0){
        alert('❌ Error: No valid questions to save. Please check your poll data.');
        savePollBtn.disabled=false;
        savePollBtn.innerHTML=defaultLabel;
        return;
      }

      // Capture question count immediately for success message
      var questionCount=payloadQuestions.length;
      console.log('Saving poll with '+questionCount+' questions');

      var request=google.script.run
        .withSuccessHandler(function(updatedPolls){
          // Use the captured questionCount variable (not from server response)
          refreshPollData(updatedPolls);
          resetPollDirty('All changes saved');
          savePollBtn.disabled=false;
          savePollBtn.innerHTML=defaultLabel;

          // Generate success message with the count we know is correct
          var successMessage=editingPollId
            ?'✅ Poll updated successfully with '+questionCount+' question'+(questionCount===1?'':'s')+'!'
            :'✅ Poll created successfully with '+questionCount+' question'+(questionCount===1?'':'s')+'!';

          console.log(successMessage);

          var shouldSelectNew=!editingPollId;
          closePollCreator();
          if(shouldSelectNew){
            pollSelect.value='';
            onPollSelectChange();
          }
          alert(successMessage);
        })
        .withFailureHandler(function(error){
          console.error('Poll save error:',error);
          handleError(error);
          savePollBtn.disabled=false;
          savePollBtn.innerHTML=defaultLabel;
        });

      if(editingPollId){
        request.updatePoll(editingPollId,pollName,className,payloadQuestions);
      } else {
        request.createNewPoll(pollName,className,payloadQuestions);
      }
    }).catch(function(err){
      console.error('Upload/save error:',err);
      alert('❌ Upload error: '+(err.message||err));
      savePollBtn.disabled=false;
      savePollBtn.innerHTML=defaultLabel;
    });
  }

  function fileToBase64(file){
    return new Promise(function(resolve,reject){
      // Validate file input
      if(!file){
        reject(new Error('No file provided'));
        return;
      }
      if(!(file instanceof File)){
        reject(new Error('Invalid file object'));
        return;
      }
      if(!file.type.startsWith('image/')){
        reject(new Error('File must be an image'));
        return;
      }
      if(file.size===0){
        reject(new Error('File is empty'));
        return;
      }
      if(file.size>5*1024*1024){
        reject(new Error('File exceeds 5MB limit'));
        return;
      }

      var reader=new FileReader();
      reader.readAsDataURL(file);
      reader.onload=function(){
        if(reader.result&&typeof reader.result==='string'){
          resolve(reader.result);
        } else {
          reject(new Error('Failed to read file data'));
        }
      };
      reader.onerror=function(error){
        reject(new Error('File read error: '+(error.message||'Unknown error')));
      };
    });
  }

  function uploadFile(file){
    return new Promise(function(resolve,reject){
      // Validate file before processing
      if(!file){
        reject(new Error('No file provided for upload'));
        return;
      }
      if(!file.name){
        reject(new Error('File has no name'));
        return;
      }

      fileToBase64(file).then(function(dataUrl){
        // Double-check dataUrl before sending
        if(!dataUrl||typeof dataUrl!=='string'){
          reject(new Error('Invalid data URL generated from file'));
          return;
        }

        google.script.run
          .withSuccessHandler(function(response){
            if(response&&response.success){
              // Server now returns fileId instead of url
              resolve(response.fileId);
            } else {
              reject(new Error(response.error||'Upload failed'));
            }
          })
          .withFailureHandler(function(error){
            reject(new Error('Server error: '+(error.message||error)));
          })
          .uploadImageToDrive(dataUrl,file.name);
      }).catch(function(error){
        reject(new Error('File conversion error: '+(error.message||error)));
      });
    });
  }

  // --- Utilities ---
  function formatDateTime(value){
    if(!value)return'—';
    var date=new Date(value);
    if(isNaN(date.getTime())){
      return value;
    }
    return date.toLocaleString();
  }

  function escapeHtml(text){
    if(!text)return'';
    var div=document.createElement('div');
    div.textContent=text;
    return div.innerHTML;
  }

  function handleError(error){
    mainLoader.style.display='none';
    console.error('Error:',error);
    alert('Error: '+(error.message||error));
  }

  // Expand question image in modal
  window.expandQuestionImage=function(){
    var imgSrc=document.getElementById('live-question-image').src;
    var modalHtml='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;" onclick="this.remove()">';
    modalHtml+='<img src="'+imgSrc+'" style="max-width:90%;max-height:90%;"/>';
    modalHtml+='</div>';
    document.body.insertAdjacentHTML('beforeend',modalHtml);
  };

  console.log('✓ Teacher Panel Ready');
})();
  </script>
</body>
</html>
