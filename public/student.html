<!DOCTYPE html>
<html class="light" lang="en">

<head>
  <!-- =============================================================================
     VERITAS LIVE POLL - SHARED HEAD ELEMENTS
     =============================================================================
     Purpose: Common <head> elements for all pages
     Used by: TeacherView.html, StudentView.html
     Phase: 3A - Shared Components
     ============================================================================= -->

<base target="_top">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

<!-- Material Symbols -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <title>Veritas Live Poll - Student</title>

  <!-- =============================================================================
     VERITAS LIVE POLL - SHARED TAILWIND CONFIGURATION
     =============================================================================
     Purpose: Centralized Tailwind CSS configuration for design system consistency
     Used by: TeacherView.html, StudentView.html
     Phase: 3A - Shared Components
     ============================================================================= -->

<!-- Tailwind CSS CDN with Plugins -->
<script src="https://cdn.tailwindcss.com/3.3.5"></script>

<!-- Tailwind Configuration -->
<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          // Veritas Brand Colors (Primary Design System)
          "veritas-navy": "#12385d",
          "veritas-gold": "#c5a05a",
          primary: "#12385d",

          // Supporting Brand Colors
          "brand-white": "#ffffff",
          "brand-light-gray": "#d9e0e7",
          "brand-dark-gray": "#242424",
          "background-light": "#f7f8fa",
          "background-dark": "#0f1723",

          // Semantic Colors
          "success-green": "#1b5e20",
          "success-bg": "#e8f5ec",
          "error-red": "#c62828",
          "text-primary": "#111111",
          "text-secondary": "#4b5563",
          "text-muted": "#6b7280"
        },
        fontFamily: {
          display: ["Inter", "sans-serif"],
          serif: ["Noto Serif", "serif"]
        },
        borderRadius: {
          DEFAULT: "0.25rem",
          lg: "0.5rem",
          xl: "0.75rem",
          "2xl": "1rem",
          full: "9999px"
        },
        spacing: {
          '18': '4.5rem',
          '88': '22rem',
          '128': '32rem'
        },
        animation: {
          // Teacher animations
          'fade-up': 'fadeUp 0.4s ease-out forwards',
          'pulse-glow': 'pulseGlow 3s ease-in-out infinite',

          // Student animations
          'fade-in': 'fadeIn 0.6s ease-out forwards',
          'spin-slow': 'spin 3s linear infinite',
          'pulse-dot': 'pulseDot 1.2s ease-in-out infinite'
        },
        keyframes: {
          fadeUp: {
            '0%': { opacity: '0', transform: 'translateY(20px)' },
            '100%': { opacity: '1', transform: 'translateY(0)' }
          },
          pulseGlow: {
            '0%, 100%': { boxShadow: '0 0 0 0 rgba(197, 160, 90, 0.4)' },
            '50%': { boxShadow: '0 0 20px 4px rgba(197, 160, 90, 0.4)' }
          },
          fadeIn: {
            'from': { opacity: '0', transform: 'translateY(10px)' },
            'to': { opacity: '1', transform: 'translateY(0)' }
          },
          pulseDot: {
            '0%, 80%, 100%': { opacity: '0.25', transform: 'scale(0.85)' },
            '40%': { opacity: '1', transform: 'scale(1)' }
          }
        }
      }
    }
  };
</script>
  <script>
(function (global) {
  'use strict';

  function clampSeconds(value) {
    var seconds = Number(value);
    if (!isFinite(seconds)) {
      seconds = 0;
    }
    return Math.max(0, Math.floor(seconds));
  }

  function formatClock(seconds) {
    var total = clampSeconds(seconds);
    var minutes = Math.floor(total / 60);
    var remaining = total % 60;
    var m = minutes < 10 ? '0' + minutes : String(minutes);
    var s = remaining < 10 ? '0' + remaining : String(remaining);
    return m + ':' + s;
  }

  function createCountdown(options) {
    options = options || {};
    var onTick = typeof options.onTick === 'function' ? options.onTick : function () {};
    var onExpire = typeof options.onExpire === 'function' ? options.onExpire : function () {};
    var intervalId = null;
    var remaining = 0;
    var running = false;

    function clearTimer() {
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
      running = false;
    }

    function notifyTick() {
      onTick(remaining);
    }

    function tickOnce() {
      if (!running) return;
      remaining = Math.max(0, remaining - 1);
      notifyTick();
      if (remaining <= 0) {
        clearTimer();
        onExpire();
      }
    }

    return {
      start: function (seconds) {
        remaining = clampSeconds(seconds);
        clearTimer();
        if (remaining === 0) {
          notifyTick();
          onExpire();
          return;
        }
        running = true;
        notifyTick();
        intervalId = setInterval(tickOnce, 1000);
      },
      pause: function () {
        if (!running) return;
        clearTimer();
      },
      stop: function () {
        clearTimer();
      },
      add: function (deltaSeconds) {
        var next = clampSeconds(remaining + Number(deltaSeconds));
        remaining = next;
        notifyTick();
        if (remaining === 0 && running) {
          clearTimer();
          onExpire();
        }
      },
      set: function (seconds) {
        remaining = clampSeconds(seconds);
        notifyTick();
        if (remaining === 0 && running) {
          clearTimer();
          onExpire();
        }
      },
      getRemaining: function () {
        return remaining;
      },
      isRunning: function () {
        return running;
      }
    };
  }

  function createHeartbeat(options) {
    options = options || {};
    var onBeat = typeof options.onBeat === 'function' ? options.onBeat : function () {};
    var intervalMs = Math.max(500, Number(options.intervalMs) || 3000);
    var timerId = null;

    function scheduleNext() {
      timerId = setTimeout(function () {
        timerId = null;
        onBeat();
        scheduleNext();
      }, intervalMs);
    }

    return {
      start: function (fireImmediately) {
        if (timerId) return;
        if (fireImmediately) {
          onBeat();
        }
        scheduleNext();
      },
      stop: function () {
        if (timerId) {
          clearTimeout(timerId);
          timerId = null;
        }
      },
      isRunning: function () {
        return timerId !== null;
      },
      pulse: function () {
        onBeat();
      },
      updateInterval: function (nextInterval) {
        intervalMs = Math.max(500, Number(nextInterval) || intervalMs);
        if (timerId) {
          clearTimeout(timerId);
          timerId = null;
          scheduleNext();
        }
      }
    };
  }

  function createFullscreenManager(doc, options) {
    var documentRef = doc || document;
    options = options || {};
    var onChange = typeof options.onChange === 'function' ? options.onChange : function () {};
    var targetElement = options.element || documentRef.documentElement;

    function isFullscreen() {
      return !!(documentRef.fullscreenElement || documentRef.webkitFullscreenElement || documentRef.msFullscreenElement);
    }

    function request() {
      if (!targetElement) {
        return Promise.reject(new Error('No element available for fullscreen'));
      }
      var req = targetElement.requestFullscreen || targetElement.webkitRequestFullscreen || targetElement.msRequestFullscreen;
      if (!req) {
        return Promise.reject(new Error('Fullscreen API unavailable'));
      }
      return req.call(targetElement);
    }

    function exit() {
      var exitFn = documentRef.exitFullscreen || documentRef.webkitExitFullscreen || documentRef.msExitFullscreen;
      if (exitFn) {
        return exitFn.call(documentRef);
      }
      return Promise.resolve();
    }

    function handleChange() {
      onChange({
        isFullscreen: isFullscreen(),
        hidden: documentRef.hidden
      });
    }

    documentRef.addEventListener('fullscreenchange', handleChange);
    documentRef.addEventListener('webkitfullscreenchange', handleChange);
    documentRef.addEventListener('visibilitychange', handleChange);

    return {
      request: request,
      exit: exit,
      isFullscreen: isFullscreen,
      dispose: function () {
        documentRef.removeEventListener('fullscreenchange', handleChange);
        documentRef.removeEventListener('webkitfullscreenchange', handleChange);
        documentRef.removeEventListener('visibilitychange', handleChange);
      }
    };
  }

  global.SecureAssessmentShared = {
    formatClock: formatClock,
    createCountdown: createCountdown,
    createHeartbeat: createHeartbeat,
    createFullscreenManager: createFullscreenManager
  };
})(this);
</script>


  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <script>
    window.SESSION_TOKEN = '';
    // CRITICAL: Store student email for violation reporting fallback
    // This ensures violations can be attributed even if SESSION_TOKEN is lost/invalid
    window.STUDENT_EMAIL = '';
    var FIREBASE_CONFIG = {"apiKey":"AIzaSyAv0bCe5KIuQx_sou8toBy5DG2PYaB_pBM","authDomain":"classroomproctor.firebaseapp.com","databaseURL":"https://classroomproctor-default-rtdb.firebaseio.com","projectId":"classroomproctor","storageBucket":"classroomproctor.firebasestorage.app","messagingSenderId":"600627073908","appId":"1:600627073908:web:935970f5849b28f6ad5221"};
    if (!FIREBASE_CONFIG) {
      console.warn('FIREBASE_CONFIG missing, using default fallback.');
      FIREBASE_CONFIG = {
        apiKey: "AIzaSyAv0bCe5KIuQx_sou8toBy5DG2PYaB_pBM",
        authDomain: "classroomproctor.firebaseapp.com",
        databaseURL: "https://classroomproctor-default-rtdb.firebaseio.com",
        projectId: "classroomproctor",
        storageBucket: "classroomproctor.firebasestorage.app",
        messagingSenderId: "600627073908",
        appId: "1:600627073908:web:935970f5849b28f6ad5221"
      };
      window.USING_FALLBACK_CONFIG = true;
    }
    var Veritas = Veritas || {};
    Veritas.Config = Veritas.Config || {};
    Veritas.Config.DEBUG_FIREBASE = false;

    // Store student email in sessionStorage for persistence across page refreshes
    if (window.STUDENT_EMAIL) {
      try {
        sessionStorage.setItem('veritas_student_email', window.STUDENT_EMAIL);
      } catch (e) { /* Storage may be unavailable */ }
    }
  </script>

  <!-- =============================================================================
     VERITAS LIVE POLL - SHARED CSS CUSTOM PROPERTIES
     =============================================================================
     Purpose: Centralized CSS variables for design system consistency
     Used by: TeacherView.html, StudentView.html
     Phase: 3A - Shared Components
     ============================================================================= -->

<style>
  /* Veritas Design System - CSS Custom Properties */
  :root {
    /* Brand Colors */
    --veritas-navy: #12385d;
    --veritas-gold: #c5a05a;
    --brand-white: #ffffff;
    --brand-light-gray: #d9e0e7;
    --brand-dark-gray: #242424;

    /* Background Colors */
    --bg-light: #f7f8fa;
    --bg-dark: #0f1723;
    --bg-card: #ffffff;
    --bg-elevated: #f8fafc;
    --bg-glass: rgba(255, 255, 255, 0.7);
    --bg-glass-dark: rgba(15, 23, 42, 0.7);

    /* Text Colors */
    --text-primary: #111111;
    --text-secondary: #4b5563;
    --text-muted: #6b7280;
    --text-on-navy: #ffffff;

    /* Semantic Colors */
    --success-green: #1b5e20;
    --success-light: #2e7d32;
    --success-bg: #e8f5ec;
    --success-bg-light: #ecfdf5;
    --error-red: #c62828;

    /* Opacity Modifiers */
    --navy-06: rgba(18, 56, 93, 0.06);
    --navy-10: rgba(18, 56, 93, 0.1);
    --navy-12: rgba(18, 56, 93, 0.12);
    --navy-14: rgba(18, 56, 93, 0.14);
    --gold-08: rgba(197, 160, 90, 0.08);

    /* Spacing Scale (following 8px baseline) */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 32px;
    --space-2xl: 48px;

    /* Border Radius */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 14px;
    --radius-xl: 16px;
    --radius-2xl: 24px;
    --radius-full: 9999px;

    /* Depth & Glassmorphism */
    --glass-blur: blur(12px);
    --glass-border: rgba(255, 255, 255, 0.2);
    --glass-border-dark: rgba(255, 255, 255, 0.1);
    --shadow-glass: 0 8px 32px 0 rgba(18, 56, 93, 0.1);
    --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

    /* Interactive Glows */
    --glow-navy: 0 0 15px rgba(18, 56, 93, 0.3);
    --glow-gold: 0 0 15px rgba(197, 160, 90, 0.3);

    /* Enhanced Semantic Colors (WCAG AA Compliant) */
    --primary: #12385d;
    --primary-hover: #0f2d4a;
    --primary-light: #1a4a7a;
    --secondary: #c5a05a;
    --secondary-hover: #b08f4d;

    /* Status Colors with Better Contrast */
    --success: #16a34a;
    --success-bg: #dcfce7;
    --success-border: #86efac;
    --warning: #f59e0b;
    --warning-bg: #fef3c7;
    --warning-border: #fcd34d;
    --error: #dc2626;
    --error-bg: #fee2e2;
    --error-border: #fca5a5;
    --info: #3b82f6;
    --info-bg: #dbeafe;
    --info-border: #93c5fd;

    /* Interactive States */
    --focus-ring: 0 0 0 3px rgba(18, 56, 93, 0.2);
    --hover-lift: 0 4px 12px rgba(0, 0, 0, 0.1);
    --active-press: 0 2px 4px rgba(0, 0, 0, 0.1);

    /* Typography Scale */
    --text-xs: 0.75rem;
    /* 12px */
    --text-sm: 0.875rem;
    /* 14px */
    --text-base: 1rem;
    /* 16px */
    --text-lg: 1.125rem;
    /* 18px */
    --text-xl: 1.25rem;
    /* 20px */
    --text-2xl: 1.5rem;
    /* 24px */
    --text-3xl: 1.875rem;
    /* 30px */
    --text-4xl: 2.25rem;
    /* 36px */

    /* Line Heights */
    --leading-tight: 1.25;
    --leading-normal: 1.5;
    --leading-relaxed: 1.75;

    /* Animation Timings */
    --duration-fast: 150ms;
    --duration-normal: 200ms;
    --duration-slow: 300ms;
    --ease-out: cubic-bezier(0.4, 0, 0.2, 1);
    --ease-in-out: cubic-bezier(0.4, 0, 0.6, 1);
  }
</style>
  <style>
  /* Veritas Design System - CSS Custom Properties */
  :root {
    /* Brand Colors */
    --veritas-navy: #12385d;
    --veritas-gold: #c5a05a;
    --brand-white: #ffffff;
    --brand-light-gray: #d9e0e7;
    --brand-dark-gray: #242424;

    /* Background Colors */
    --bg-light: #f7f8fa;
    --bg-dark: #0f1723;
    --bg-card: #ffffff;

    /* Text Colors */
    --text-primary: #111111;
    --text-secondary: #4b5563;
    --text-muted: #6b7280;
    --text-on-navy: #ffffff;

    /* Semantic Colors */
    --success-green: #1b5e20;
    --success-bg: #e8f5ec;
    --error-red: #c62828;

    /* Opacity Modifiers */
    --navy-10: rgba(18, 56, 93, 0.1);
    --navy-12: rgba(18, 56, 93, 0.12);
    --gold-08: rgba(197, 160, 90, 0.08);

    /* Spacing Scale (following 8px baseline) */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 32px;
    --space-2xl: 48px;

    /* Border Radius */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 14px;
    --radius-full: 9999px;

    /* Animation Timing */
    --transition-smooth: 400ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-fast: 200ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-bounce: 500ms cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .motion-safe-transition {
    transition: all var(--transition-smooth);
  }

  .motion-pulse {
    animation: motion-pulse 2s infinite ease-in-out;
  }

  .motion-slide-up {
    animation: motion-slide-up var(--transition-smooth) forwards;
  }

  .motion-slide-in-right {
    animation: motion-slide-in-right var(--transition-smooth) forwards;
  }

  .motion-fade-in {
    animation: motion-fade-in var(--transition-fast) forwards;
  }

  @keyframes motion-pulse {

    0%,
    100% {
      transform: scale(1);
      opacity: 0.8;
    }

    50% {
      transform: scale(1.15);
      opacity: 1;
    }
  }

  @keyframes motion-slide-up {
    from {
      transform: translateY(12px);
      opacity: 0;
    }

    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes motion-slide-in-right {
    from {
      transform: translateX(20px);
      opacity: 0;
    }

    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes motion-fade-in {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  /* Creative Animations */
  @keyframes draw-check {
    0% {
      stroke-dashoffset: 100;
      opacity: 0;
    }

    20% {
      opacity: 1;
    }

    100% {
      stroke-dashoffset: 0;
      opacity: 1;
    }
  }

  @keyframes motion-float {

    0%,
    100% {
      transform: translateY(0);
    }

    50% {
      transform: translateY(-10px);
    }
  }

  @keyframes motion-pulse-ring {
    0% {
      transform: scale(0.8);
      box-shadow: 0 0 0 0 rgba(18, 56, 93, 0.4);
      opacity: 0.8;
    }

    70% {
      transform: scale(1);
      box-shadow: 0 0 0 20px rgba(18, 56, 93, 0);
      opacity: 0;
    }

    100% {
      transform: scale(0.8);
      box-shadow: 0 0 0 0 rgba(18, 56, 93, 0);
      opacity: 0;
    }
  }

  @keyframes text-shimmer {
    0% {
      background-position: -200% center;
    }

    100% {
      background-position: 200% center;
    }
  }

  .animate-draw-check {
    stroke-dasharray: 100;
    stroke-dashoffset: 100;
    animation: draw-check 0.8s cubic-bezier(0.65, 0, 0.45, 1) forwards;
  }

  .animate-float {
    animation: motion-float 3s ease-in-out infinite;
  }

  .animate-pulse-ring {
    animation: motion-pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  .animate-text-shimmer {
    background: linear-gradient(90deg, #12385d 0%, #3b82f6 50%, #12385d 100%);
    background-size: 200% auto;
    color: transparent;
    -webkit-background-clip: text;
    background-clip: text;
    animation: text-shimmer 3s linear infinite;
  }

  /* Premium Waiting Particles */
  .shimmer-particle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: var(--veritas-gold);
    border-radius: 50%;
    opacity: 0.3;
    filter: blur(2px);
    animation: particle-rise 6s linear infinite;
  }

  @keyframes particle-rise {
    0% {
      transform: translateY(0) scale(1);
      opacity: 0;
    }

    50% {
      opacity: 0.5;
    }

    100% {
      transform: translateY(-100px) scale(1.5);
      opacity: 0;
    }
  }

  body {
    background: #ffffff;
    color: #000000;
    font-family: "Inter", sans-serif;
  }

  .page-shell {
    max-width: 1200px;
    margin: 0 auto;
    padding: 96px clamp(16px, 4vw, 40px) 48px;
    display: flex;
    flex-direction: column;
    gap: 24px;
    min-height: 90vh;
  }

  .hud-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 64px;
    background: var(--veritas-navy);
    color: #ffffff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 clamp(16px, 3vw, 32px);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
    z-index: 60;
  }

  .hud-left {
    display: flex;
    align-items: center;
    gap: 12px;
    text-transform: uppercase;
  }

  .hud-brand {
    font-weight: 800;
    letter-spacing: 0.18em;
    font-size: 1.1rem;
  }

  .hud-mode {
    color: rgba(255, 255, 255, 0.75);
    font-size: 0.82rem;
    letter-spacing: 0.08em;
    font-weight: 600;
  }

  .hud-center {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    pointer-events: none;
  }

  .hud-progress {
    margin: 0;
    color: #ffffff;
    letter-spacing: 0.14em;
    font-weight: 700;
    font-size: 0.95rem;
  }

  .hud-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .hud-timer {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .hud-icon-btn {
    width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.35);
    background: transparent;
    color: #ffffff;
    cursor: pointer;
    transition: background-color 120ms ease, border-color 120ms ease;
  }

  .hud-icon-btn:hover {
    background: rgba(255, 255, 255, 0.12);
    border-color: rgba(255, 255, 255, 0.5);
  }

  .hud-timer-value {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-weight: 700;
    font-size: 1.05rem;
    letter-spacing: 0.08em;
  }

  .hud-timer.alert-warning .hud-timer-value {
    color: #c2410c;
  }

  .hud-timer.alert-danger .hud-timer-value {
    color: #b91c1c;
    animation: pulse-dot 1s ease-in-out infinite;
  }

  .hud-timer.timer-hidden .hud-timer-value {
    color: rgba(255, 255, 255, 0.6);
    letter-spacing: 0.08em;
  }

  body.secure-overlay-active {
    overflow: hidden;
  }

  #student-container {
    width: 100%;
    max-width: none;
    margin: 0 auto;
    padding-left: clamp(8px, 2vw, 16px);
    padding-right: clamp(8px, 2vw, 16px);
  }

  .secure-topbar-timer {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    padding: 5px 11px;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.35);
    background: rgba(4, 12, 30, 0.45);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
  }

  .secure-topbar-time {
    font-size: 1.45rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    color: #fff;
  }

  .student-card,
  .secure-session-card {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    background: transparent;
    color: #000000;
    border-radius: 0;
    border: none;
    box-shadow: none;
    padding: 0;
    overflow: visible;
  }

  .student-card-body,
  .student-card-options,
  .secure-session-body {
    padding: 0;
  }

  .student-question-number,
  .student-card-header,
  .secure-session-header {
    display: none;
  }

  .question-layout {
    display: block;
    width: 100%;
  }

  .question-layout.no-image .question-textual {
    width: 100%;
  }

  .question-textual {
    display: block;
    width: 100%;
  }

  .student-stem {
    font-family: "Noto Serif", serif;
    font-size: 1.125rem;
    /* Standardized to 18px */
    line-height: 1.6;
    font-weight: 400;
    color: #12385d;
    margin: 0 0 16px;
    text-align: left;
    word-wrap: break-word;
  }

  #secure-question-text {
    font-family: "Inter", sans-serif;
    font-size: 1.125rem;
    /* Standardized to 18px */
    line-height: 1.6;
    font-weight: 400;
    color: #000000;
    margin: 0;
    text-align: left;
  }

  .student-subline {
    color: #4b5563;
    margin: 0;
    text-align: left;
  }

  .question-visual {
    float: right;
    margin-left: 16px;
    margin-bottom: 12px;
    max-width: 280px;
  }

  .question-visual img {
    max-height: 280px;
    width: 100%;
    object-fit: contain;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    padding: 8px;
    background: #ffffff;
    cursor: zoom-in;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.04);
  }

  .answer-area {
    margin-top: 20px;
    clear: both;
  }

  .student-choices {
    display: grid;
    grid-template-columns: 1fr;
    gap: 14px;
    padding: 0;
    margin: 0;
    list-style: none;
  }

  .answer-option {
    background: #ffffff;
    border: 1px solid #d1d5db;
    border-radius: 12px;
    padding: 10px 12px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    transition: border-color 150ms ease, box-shadow 150ms ease, background-color 150ms ease;
    color: #000000;
  }

  .answer-option:hover:not(.answer-option-disabled) {
    border-color: #9ca3af;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
  }

  .answer-option .option-body {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .answer-option .option-leading {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .letter-badge {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    border: 1px solid #cbd5e1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #12385d;
    background: #f8fafc;
    flex-shrink: 0;
  }

  .answer-option .option-text {
    color: #000000;
    font-size: 1.125rem;
    /* Standardized to 18px */
    line-height: 1.6;
    font-family: "Inter", sans-serif;
    margin: 0;
    text-align: left;
  }

  .answer-option .option-image {
    width: 100%;
    height: 150px;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    box-shadow: none;
    object-fit: cover;
    margin: 0 0 6px;
  }

  .answer-option .result-ribbon,
  .answer-option .result-indicator {
    display: none;
  }

  .answer-option.answer-option-selected {
    border: 2px solid #12385d;
    box-shadow: 0 0 0 3px rgba(18, 56, 93, 0.18);
    background: #e8f1fa;
  }

  .answer-option.answer-option-selected .letter-badge {
    background-color: #12385d;
    border-color: #12385d;
    color: #ffffff;
  }

  .secure-session-body {
    display: flex;
    flex-direction: column;
    gap: 24px;
    width: 100%;
    overflow: visible;
    padding-bottom: 8px;
  }

  #secure-options-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow: visible;
    padding-bottom: 4px;
  }

  .secure-session-footer {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: #ffffff;
    border-top: 1px solid #e5e7eb;
    box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.08);
    padding: 14px clamp(16px, 3vw, 32px);
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 12px;
    z-index: 55;
  }

  body.secure-mode-active .page-shell {
    padding-bottom: 56px;
  }

  /* Hide non-secure entry surfaces when secure mode is active */
  body.secure-mode-active #entry-screen,
  body.secure-mode-active #pre-live-card {
    display: none !important;
  }

  @media (max-width: 768px) {
    .page-shell {
      padding: 80px 16px 40px;
    }

    .hud-bar {
      flex-wrap: wrap;
      height: auto;
      gap: 8px;
      padding: 10px 14px;
    }

    .hud-left,
    .hud-right {
      width: 100%;
      justify-content: space-between;
    }

    .hud-center {
      position: static;
      transform: none;
      width: 100%;
      text-align: left;
      order: 3;
    }

    .hud-progress {
      font-size: 0.9rem;
      letter-spacing: 0.08em;
    }

    .secure-session-footer {
      flex-direction: column;
      align-items: stretch;
    }

    .secure-submit-btn {
      width: 100%;
    }

    .question-visual {
      float: none;
      margin: 0 0 12px;
      max-width: 100%;
    }
  }

  .student-card {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    background: transparent;
    color: #000000;
    border-radius: 0;
    border: none;
    box-shadow: none;
    overflow: visible;
    padding: 0;
  }

  .student-card.results-stage,
  .student-card.showing-results {
    background: transparent;
  }

  .student-card-header,
  .student-question-number,
  .student-card-body {
    display: none;
  }

  .student-card-body-content {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .student-question-image {
    width: 100%;
    max-width: 320px;
    /* Standardize max width for wrap */
    max-height: 380px;
    object-fit: contain;
    border-radius: 12px;
    border: 1px solid rgba(18, 56, 93, 0.1);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.04);
    cursor: zoom-in;
    padding: 8px;
    background: #ffffff;
    transition: transform 200ms ease, box-shadow 200ms ease;
  }

  .student-question-image:hover {
    transform: scale(1.02);
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.12);
  }


  .student-card-options {
    padding: 7px 4px 17px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-width: 100%;
    overflow: visible;
  }

  .student-pre-live-card {
    max-width: 720px;
    text-align: center;
  }

  .secure-session-card {
    position: relative;
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    background: transparent;
    border-radius: 0;
    border: none;
    box-shadow: none;
    min-height: auto;
    display: flex;
    flex-direction: column;
    overflow-x: hidden;
    padding: 0;
  }

  .secure-session-header {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    align-items: center;
    justify-content: space-between;
    padding: clamp(16px, 3vw, 32px) clamp(24px, 4vw, 48px);
    border-bottom: 1px solid rgba(18, 56, 93, 0.1);
    background: linear-gradient(120deg, rgba(18, 56, 93, 0.08), rgba(197, 160, 90, 0.12));
  }

  .secure-session-meta {
    font-size: 0.8rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--text-secondary);
  }

  .secure-session-progress {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .secure-connection-dot {
    width: 14px;
    height: 14px;
    border-radius: 999px;
    box-shadow: 0 0 12px rgba(18, 56, 93, 0.35);
  }

  .secure-connection-warning {
    padding: 8px 19px;
    background: #fffbeb;
    color: #92400e;
    border-top: 1px solid #fef3c7;
    border-bottom: 1px solid #fef3c7;
    font-weight: 500;
  }

  .secure-session-body {
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 24px;
    flex: 1;
    max-width: 100%;
    overflow-x: hidden;
    /* Fix: Answer Choices Layout Collapse */
    min-height: 0;
    padding-bottom: 24px;
  }

  .secure-question-pane,
  .secure-options-pane {
    display: none;
  }

  .secure-answer-option .letter-badge {
    width: 32px;
    height: 32px;
  }

  .secure-session-footer {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: #ffffff;
    border-top: 1px solid #e5e7eb;
    box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.08);
    padding: 14px clamp(16px, 3vw, 32px);
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 12px;
    z-index: 55;
  }

  /* Fix: Ensure page shell has enough padding so footer doesn't cover content */
  body.secure-mode-active .page-shell {
    padding-bottom: 120px !important;
  }

  @media (max-width: 1023px) {
    .secure-session-footer {
      align-items: stretch;
    }

    .secure-submit-btn {
      width: 100%;
    }
  }

  @media (max-height: 760px) {
    .secure-session-card {
      min-height: auto;
    }
  }

  .secure-connection-indicator {
    position: fixed;
    top: clamp(48px, 6vw, 88px);
    right: clamp(18px, 4vw, 64px);
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: rgba(15, 23, 42, 0.4);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    color: #fff;
    z-index: 30;
  }

  .secure-submit-btn {
    width: 100%;
    max-width: 240px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    border-radius: 999px;
    border: none;
    padding: 8px 14px;
    background: linear-gradient(135deg, #12385d, #1b4c7a);
    color: #fff;
    font-weight: 600;
    font-size: 1.05rem;
    letter-spacing: 0.03em;
    transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  }

  .secure-submit-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 15px 30px rgba(18, 56, 93, 0.2);
  }

  .secure-submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .secure-submit-hint {
    margin-top: 4px;
    font-size: 0.95rem;
    color: rgba(18, 56, 93, 0.7);
    text-align: right;
    width: 100%;
  }

  .secure-lobby-card {
    border-radius: 32px;
    border: 1px solid rgba(18, 56, 93, 0.08);
    background: #ffffff;
    color: #0f172a;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
  }

  .secure-lobby-chip {
    display: flex;
    flex-direction: column;
    padding: 10px 12px;
    border-radius: 18px;
    border: 1px solid rgba(15, 23, 42, 0.08);
    background: rgba(18, 56, 93, 0.03);
    min-width: 150px;
  }

  .secure-rules-list li {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    font-size: 0.95rem;
    color: #334155;
  }

  .student-pre-live-body {
    align-items: center;
    gap: 18px;
  }

  .student-pre-live-icon {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    background: var(--navy-10);
    color: var(--veritas-navy);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.4rem;
    margin: 0 auto;
  }

  .student-pre-live-footer {
    align-items: center;
    gap: 16px;
  }

  .student-pre-live-status {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
    letter-spacing: 0.28em;
    color: var(--veritas-navy);
    font-size: 0.75rem;
  }

  .student-pre-live-label {
    font-weight: 700;
  }

  .student-pre-live-pips {
    display: inline-flex;
    gap: 6px;
  }

  .student-pre-live-pips .pip {
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: rgba(18, 56, 93, 0.35);
    animation: motion-pulse 1.2s ease-in-out infinite;
  }

  .student-pre-live-reconnect {
    font-size: 0.9rem;
    color: var(--error-red);
    margin: 0;
  }

  /* .student-stem styling moved to unified section above (line 320) */

  .student-subline {
    font-size: 0.95rem;
    color: rgba(17, 17, 17, 0.72);
    margin: 0;
  }

  .student-no-responses {
    font-size: 0.95rem;
    font-style: italic;
    color: var(--veritas-navy);
    text-align: left;
    margin: 0;
  }

  .student-choices {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-width: 100%;
    overflow: visible;
    /* FIX: Changed from hidden to visible to prevent answer cutoff */
  }

  .student-choices li {
    list-style: none;
    margin: 0 !important;
    padding: 0 !important;
    line-height: 1;
    width: 100%;
    display: block;
  }

  .student-card img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--navy-12);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
  }

  .answer-option {
    position: relative;
    width: 100%;
    max-width: 100%;
    text-align: left;
    display: flex;
    align-items: flex-start;
    gap: 14px;
    background: var(--bg-card);
    color: var(--text-primary);
    border-radius: var(--radius-md);
    border: 1px solid rgba(18, 56, 93, 0.18);
    padding: 10px 12px;
    box-shadow: 0 2px 8px rgba(18, 56, 93, 0.08);
    transition: border-color 200ms ease, box-shadow 200ms ease, transform 200ms ease, background-color 200ms ease;
    cursor: pointer;
    appearance: none;
    box-sizing: border-box;
    overflow: hidden;
  }

  .answer-option:hover {
    border-color: var(--veritas-navy);
    box-shadow: 0 6px 18px rgba(18, 56, 93, 0.16);
    transform: translateY(-1px);
  }

  .answer-option:focus-visible {
    outline: 3px solid rgba(18, 56, 93, 0.4);
    outline-offset: 2px;
  }

  .answer-option.result-readonly {
    pointer-events: none;
    cursor: default !important;
    box-shadow: 0 2px 6px rgba(18, 56, 93, 0.05);
  }

  .answer-option.answer-option-disabled {
    opacity: 0.55;
    pointer-events: none;
    cursor: default;
    box-shadow: 0 2px 6px rgba(18, 56, 93, 0.05);
  }

  .answer-option .result-indicator {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: var(--radius-full);
    font-size: 0.95rem;
    font-weight: 700;
    background-color: rgba(18, 56, 93, 0.08);
    color: var(--veritas-navy);
    opacity: 0;
    transform: scale(0.85);
    position: absolute;
    top: 16px;
    right: 18px;
    transition: opacity 220ms ease, transform 220ms ease, background-color 220ms ease, color 220ms ease;
  }

  .percentage-bubble {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 12px;
    border-radius: 999px;
    background-color: #f3f4f6;
    color: #111827;
    font-size: 0.9rem;
    font-weight: 600;
    opacity: 0;
    transform: scale(0.85);
    margin-left: auto;
    margin-right: 8px;
    transition: opacity 220ms ease, transform 220ms ease;
  }

  #question-container.showing-results .answer-option .result-indicator {
    opacity: 1;
    transform: scale(1);
  }

  #question-container.showing-results .answer-option .percentage-bubble {
    opacity: 1;
    transform: scale(1);
  }

  .answer-option .letter-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    border-radius: 10px;
    background-color: rgba(18, 56, 93, 0.08);
    border: 1px solid rgba(18, 56, 93, 0.22);
    color: var(--veritas-navy);
    font-weight: 600;
    font-size: 1.05rem;
    transition: background-color 220ms ease, border-color 220ms ease, color 220ms ease, transform 220ms ease;
  }

  .answer-option .option-leading {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 12px;
    align-self: flex-start;
    flex: 1;
    min-width: 0;
  }

  .answer-option .option-body {
    flex: 1;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
    min-width: 0;
    max-width: 100%;
    justify-content: flex-start;
    overflow: hidden;
  }

  .answer-option .option-text-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0;
    min-width: 0;
  }

  .answer-option .option-text {
    color: #1c1c1c;
    font-size: 1.05rem;
    line-height: 1.6;
    font-family: "Inter", sans-serif;
    margin: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    max-width: 100%;
  }

  .answer-option .option-image {
    max-width: min(300px, 100%);
    width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid rgba(18, 56, 93, 0.16);
    box-shadow: 0 3px 10px rgba(18, 56, 93, 0.12);
    margin-bottom: 12px;
    cursor: pointer;
    transition: transform 200ms ease, box-shadow 200ms ease;
  }

  .answer-option .option-image:hover {
    transform: scale(1.02);
    box-shadow: 0 6px 16px rgba(18, 56, 93, 0.16);
  }

  .answer-option .result-ribbon {
    font-size: 0.9rem;
    font-weight: 600;
    align-self: flex-end;
    color: var(--veritas-navy);
    display: none;
  }

  .answer-option .result-ribbon.is-visible {
    display: inline-flex;
    margin-top: 8px;
  }

  .answer-option.result-correct .result-ribbon {
    color: var(--success-green);
  }

  .answer-option.result-incorrect .result-ribbon {
    color: var(--text-secondary);
  }

  #question-container.results-stage .answer-option {
    pointer-events: none;
    cursor: default !important;
  }

  #question-container.showing-results .answer-option {
    transition: background-color 240ms ease, border-color 240ms ease, color 240ms ease, box-shadow 240ms ease;
  }

  .answer-option.answer-option-selected {
    border-color: var(--veritas-navy);
    box-shadow: 0 0 0 3px rgba(18, 56, 93, 0.2);
  }

  .answer-option.answer-option-selected .letter-badge {
    background-color: var(--veritas-navy);
    border-color: var(--veritas-navy);
    color: var(--brand-white);
    transform: scale(1.02);
  }

  .answer-option.answer-option-selected .option-text {
    color: var(--veritas-navy);
  }

  .answer-option.result-correct {
    background-color: var(--success-bg) !important;
    border-color: #2e7d32 !important;
    box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.2);
  }

  .answer-option.result-correct .letter-badge {
    background-color: rgba(46, 125, 50, 0.18) !important;
    border-color: rgba(46, 125, 50, 0.4) !important;
    color: var(--success-green) !important;
  }

  .answer-option.result-correct .option-text {
    color: var(--success-green) !important;
  }

  .answer-option.result-correct .result-indicator {
    background-color: rgba(46, 125, 50, 0.2);
    color: var(--success-green);
  }

  .answer-option.result-incorrect {
    background-color: #f5f6f8 !important;
    border-color: rgba(17, 24, 39, 0.12) !important;
    color: #1c1c1c !important;
    box-shadow: none;
  }

  .answer-option.result-incorrect .letter-badge {
    background-color: rgba(18, 56, 93, 0.06) !important;
    border-color: rgba(18, 56, 93, 0.16) !important;
    color: var(--veritas-navy) !important;
  }

  .answer-option.result-incorrect .result-indicator {
    background-color: rgba(244, 67, 54, 0.12);
    color: var(--error-red);
  }

  .answer-option.result-incorrect.result-your-choice {
    border-color: rgba(198, 40, 40, 0.45) !important;
    box-shadow: 0 0 0 2px rgba(198, 40, 40, 0.15);
  }

  .answer-option.result-your-choice .option-text {
    color: var(--error-red) !important;
  }

  .prevent-select {
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
  }

  .prevent-select button,
  .prevent-select .material-symbols-outlined {
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  .student-card img,
  .student-card video,
  .student-card figure {
    max-width: 100%;
    height: auto;
  }

  .veritas-modal-root {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .veritas-modal-root.is-active {
    display: flex;
  }

  .veritas-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(9, 17, 34, 0.55);
    backdrop-filter: blur(3px);
  }

  .veritas-modal-dialog {
    position: relative;
    z-index: 1;
    width: min(520px, 92vw);
    border-radius: 16px;
    background: var(--bg-card);
    border-top: 4px solid var(--veritas-gold);
    box-shadow: 0 24px 48px rgba(9, 17, 34, 0.25);
    padding: 17px;
    display: flex;
    flex-direction: column;
    gap: 18px;
    animation: veritas-modal-in 220ms ease;
  }

  .veritas-modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
    color: var(--veritas-navy);
    font-weight: 700;
  }

  .veritas-modal-body {
    display: flex;
    flex-direction: column;
    gap: 12px;
    color: var(--text-primary);
    font-size: 0.98rem;
    line-height: 1.55;
  }

  .veritas-modal-subtext {
    color: var(--text-secondary);
    font-size: 0.85rem;
  }

  .veritas-modal-input {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .veritas-modal-input input {
    border-radius: 10px;
    border: 1px solid rgba(18, 56, 93, 0.28);
    padding: 6px 7px;
    font-size: 0.95rem;
    transition: border-color 160ms ease, box-shadow 160ms ease;
  }

  .veritas-modal-input input:focus-visible {
    outline: none;
    border-color: var(--veritas-navy);
    box-shadow: 0 0 0 3px rgba(18, 56, 93, 0.2);
  }

  .veritas-modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    flex-wrap: wrap;
  }

  .veritas-modal-button {
    border: none;
    border-radius: 999px;
    padding: 6px 13px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: transform 140ms ease, box-shadow 140ms ease, background-color 140ms ease, color 140ms ease;
  }

  .veritas-modal-button.primary {
    background: var(--veritas-navy);
    color: var(--brand-white);
    box-shadow: 0 8px 20px rgba(18, 56, 93, 0.25);
  }

  .veritas-modal-button.primary:hover:not([disabled]) {
    background: #0f2d4a;
    transform: translateY(-1px);
  }

  .veritas-modal-button.secondary {
    background: transparent;
    color: var(--veritas-navy);
    border: 1px solid rgba(18, 56, 93, 0.3);
  }

  .veritas-modal-button.secondary:hover:not([disabled]) {
    background: rgba(18, 56, 93, 0.08);
  }

  .veritas-modal-button.destructive {
    background: var(--error-red);
    color: var(--brand-white);
    box-shadow: 0 8px 18px rgba(198, 40, 40, 0.25);
  }

  .veritas-modal-button.destructive:hover:not([disabled]) {
    background: #a61b1b;
  }

  .veritas-modal-button[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .veritas-modal-spinner {
    width: 18px;
    height: 18px;
    border-radius: 999px;
    border: 2px solid rgba(255, 255, 255, 0.6);
    border-top-color: transparent;
    animation: veritas-spin 0.7s linear infinite;
    display: none;
    margin-left: 10px;
  }

  .veritas-modal-button.loading .veritas-modal-spinner {
    display: inline-block;
  }

  .veritas-modal-button.loading span {
    opacity: 0.75;
  }

  .dark .veritas-modal-dialog {
    background: rgba(15, 23, 35, 0.96);
    color: #e2e8f0;
    border-top-color: #c5a05a;
    box-shadow: 0 24px 48px rgba(2, 6, 23, 0.55);
  }

  .dark .veritas-modal-header h2 {
    color: #f8fafc;
  }

  .dark .veritas-modal-body {
    color: #f1f5f9;
  }

  .dark .veritas-modal-subtext {
    color: #cbd5f5;
  }

  .dark .veritas-modal-input input {
    background: rgba(15, 23, 42, 0.7);
    border-color: rgba(148, 163, 184, 0.4);
    color: #f8fafc;
  }

  .dark .veritas-modal-input input:focus-visible {
    border-color: #93c5fd;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35);
  }

  .dark .veritas-modal-button.secondary {
    color: #e2e8f0;
    border-color: rgba(148, 163, 184, 0.4);
  }

  .dark .veritas-modal-button.secondary:hover:not([disabled]) {
    background: rgba(148, 163, 184, 0.16);
  }

  .dark .veritas-modal-button.primary {
    background: #234776;
  }

  .dark .veritas-modal-button.primary:hover:not([disabled]) {
    background: #1a3456;
  }

  .dark .veritas-modal-backdrop {
    background: rgba(2, 6, 23, 0.7);
    backdrop-filter: blur(4px);
  }

  body.veritas-modal-open {
    overflow: hidden;
  }

  @keyframes veritas-modal-in {
    from {
      opacity: 0;
      transform: translateY(16px) scale(0.98);
    }

    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes veritas-spin {
    from {
      transform: rotate(0deg);
    }

    to {
      transform: rotate(360deg);
    }
  }

  @media (max-width: 480px) {
    .student-card {
      width: min(98vw, 480px);
      margin: 12px auto;
    }

    .student-card-header {
      padding: 8px 12px 6px;
    }

    .student-card-body {
      padding: 13px 12px 5px;
    }

    .student-card-options {
      padding: 5px 12px 13px;
      gap: 10px;
    }

    .answer-option {
      flex-direction: column;
      align-items: stretch;
    }

    .answer-option .letter-badge {
      width: 40px;
      height: 40px;
    }

    .veritas-modal-dialog {
      width: min(98vw, 480px);
      padding: 13px;
      gap: 16px;
    }

    .veritas-modal-actions {
      width: 100%;
      justify-content: stretch;
    }

    .veritas-modal-button {
      flex: 1;
    }
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .status-card {
    background: #ffffff !important;
    color: #111827 !important;
  }

  .status-card .material-symbols-outlined {
    color: var(--veritas-navy) !important;
  }

  .confidence-selector {
    margin-top: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .confidence-btn {
    height: 3.5rem;
    padding: 0 1.5rem;
    border-radius: 0.75rem;
    border: 2px solid;
    transition: all 200ms ease;
    font-weight: 600;
    font-size: 1.125rem;
    cursor: pointer;
    color: #111827 !important;
  }

  .confidence-btn[data-confidence="guessing"] {
    background-color: #fecaca;
    border-color: #ef4444;
  }

  .confidence-btn[data-confidence="guessing"]:hover {
    background-color: #fca5a5;
    border-color: #dc2626;
  }

  .confidence-btn[data-confidence="somewhat-sure"] {
    background-color: #fde68a;
    border-color: #f59e0b;
  }

  .confidence-btn[data-confidence="somewhat-sure"]:hover {
    background-color: #fcd34d;
    border-color: #d97706;
  }

  .confidence-btn[data-confidence="very-sure"] {
    background-color: #bfdbfe;
    border-color: #3b82f6;
  }

  .confidence-btn[data-confidence="very-sure"]:hover {
    background-color: #93c5fd;
    border-color: #2563eb;
  }

  .confidence-btn[data-confidence="certain"] {
    background-color: #bbf7d0;
    border-color: #22c55e;
  }

  .confidence-btn[data-confidence="certain"]:hover {
    background-color: #86efac;
    border-color: #16a34a;
  }

  /* Student Landing Page Animations */
  @keyframes drawLine {
    from {
      transform: scaleX(0);
    }

    to {
      transform: scaleX(1);
    }
  }

  @keyframes shimmerBg {
    0% {
      background-position: -1000px 0;
    }

    100% {
      background-position: 1000px 0;
    }
  }

  @keyframes floatParticle {

    0%,
    100% {
      transform: translateY(0) translateX(0);
      opacity: 0.4;
    }

    50% {
      transform: translateY(-20px) translateX(10px);
      opacity: 0.8;
    }
  }

  @keyframes pulseDot {

    0%,
    80%,
    100% {
      opacity: 0.3;
      transform: scale(1);
    }

    40% {
      opacity: 1;
      transform: scale(1.2);
    }
  }

  .shimmer-particle {
    position: absolute;
    width: 4px;
    height: 4px;
    background: radial-gradient(circle, #c5a05a, transparent);
    border-radius: 50%;
    animation: floatParticle 6s ease-in-out infinite;
    pointer-events: none;
  }

  .waiting-dots .dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    margin: 0 4px;
    background: #12385d;
    border-radius: 50%;
    animation: pulseDot 1.4s ease-in-out infinite;
  }

  .waiting-dots .dot:nth-child(1) {
    animation-delay: 0s;
  }

  .waiting-dots .dot:nth-child(2) {
    animation-delay: 0.2s;
  }

  .waiting-dots .dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  /* =========================
       METACOGNITION CONFIDENCE
       ========================= */

  .secure-confidence-prompt {
    padding: 2rem;
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    border-radius: 12px;
    margin-top: 1.5rem;
    animation: fadeInUp 0.3s ease-out;
  }

  .confidence-wrapper {
    max-width: 600px;
    margin: 0 auto;
  }

  .confidence-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .confidence-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .confidence-btn {
    flex: 1;
    min-width: 140px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1.25rem 1rem;
    border: 2px solid transparent;
    border-radius: 10px;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .confidence-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .confidence-guessing {
    border-color: #ef4444;
  }

  .confidence-guessing:hover {
    background: #fef2f2;
    border-color: #dc2626;
  }

  .confidence-somewhat {
    border-color: #f59e0b;
  }

  .confidence-somewhat:hover {
    background: #fffbeb;
    border-color: #d97706;
  }

  .confidence-very {
    border-color: #10b981;
  }

  .confidence-very:hover {
    background: #f0fdf4;
    border-color: #059669;
  }

  .confidence-emoji {
    font-size: 2rem;
    line-height: 1;
  }

  .confidence-label {
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Mobile responsiveness for confidence buttons */
  @media (max-width: 640px) {
    .confidence-buttons {
      flex-direction: column;
    }

    .confidence-btn {
      min-width: 100%;
    }
  }

  /* =============================================================================
     REVIEW MODE & FLASHLIGHT (Redesign)
     ============================================================================= */

  /* Flashlight Overlay */
  /* Privacy Blur Mode (Replaces Flashlight) */
  .privacy-active .question-textual,
  .privacy-active .answer-area,
  .privacy-active .question-visual {
    filter: blur(8px);
    transition: filter 0.3s ease;
    cursor: help;
  }

  .privacy-active .question-textual:hover,
  .privacy-active .answer-area:hover,
  .privacy-active .question-visual:hover {
    filter: none;
  }

  /* Flashlight Overlay - REMOVED/HIDDEN */
  #flashlight-overlay {
    display: none !important;
  }


  /* Review Ribbon */
  .review-ribbon-strip {
    position: absolute;
    left: -32px;
    top: 0;
    bottom: 0;
    width: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.15em;
    color: var(--text-muted);
    border-right: 1px solid var(--brand-light-gray);
    text-transform: uppercase;
    opacity: 0.6;
    pointer-events: none;
  }

  /* Ensure parent allows ribbon positioning */
  .student-card.results-stage {
    position: relative;
    overflow: visible !important;
  }

  /* Answer Options in Review Mode */
  .student-choices button.result-readonly {
    cursor: default !important;
    transform: none !important;
    box-shadow: none !important;
    background-color: #ffffff;
    /* Default bg */
    border-color: var(--brand-light-gray);
    padding-right: 60px;
    /* Space for flag */
    transition: background-color 0.3s ease, border-color 0.3s ease;
  }

  .student-choices button.result-readonly:hover {
    box-shadow: none !important;
    transform: none !important;
    background-color: #ffffff;
    /* No hover bg change */
  }

  /* Flags */
  .percentage-flag {
    position: absolute;
    top: 12px;
    right: -8px;
    background: var(--brand-dark-gray);
    color: white;
    font-size: 0.75rem;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 4px 0 0 4px;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
    z-index: 10;
  }

  .percentage-flag::after {
    content: '';
    position: absolute;
    right: 0;
    bottom: -6px;
    width: 0;
    height: 0;
    border-style: solid;
    border-width: 0 8px 6px 0;
    border-color: transparent #111 transparent transparent;
    /* Dark triangle for fold effect */
  }

  /* Correct / Incorrect States */
  .student-choices button.result-correct {
    background-color: #f0fdf4 !important;
    /* Green-50 */
    border-color: #4ade80 !important;
    /* Green-400 */
  }

  .student-choices button.result-incorrect {
    background-color: #fef2f2 !important;
    /* Red-50 */
    border-color: #f87171 !important;
    /* Red-400 */
    opacity: 1 !important;
  }

  .student-choices button.result-neutral {
    opacity: 0.6;
  }

  /* Badges */
  .result-badges {
    position: absolute;
    bottom: 8px;
    right: 12px;
    display: flex;
    gap: 6px;
    pointer-events: none;
  }

  .badge-pill {
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    padding: 2px 6px;
    border-radius: 4px;
    letter-spacing: 0.05em;
  }

  .badge-correct {
    color: #166534;
    /* Green-800 */
    background: #bbf7d0;
    /* Green-200 */
  }

  .badge-your-choice {
    color: #1e40af;
    /* Blue-800 */
    background: #bfdbfe;
    /* Blue-200 */
  }

  /* Remove old elements */
  .result-readonly .percentage-bubble {
    display: none !important;
    /* Hide old bubbles */
  }

  .result-readonly .result-indicator {
    display: none !important;
    /* Hide old big circles */
  }

  /* Icon Markers (Check/X) */
  .result-icon-marker {
    position: absolute;
    top: 50%;
    right: 16px;
    transform: translateY(-50%);
    font-family: 'Material Symbols Outlined';
    font-size: 24px;
    font-weight: normal;
    line-height: 1;
  }

  .result-correct .result-icon-marker {
    color: #15803d;
    /* Green-700 */
    content: 'check_circle';
  }

  .result-incorrect .result-icon-marker {
    color: #b91c1c;
    /* Red-700 */
    content: 'cancel';
  }
</style>
</head>

<body class="light">
  <body class="font-display bg-white text-black min-h-screen">
  <!-- Lock Overlay - Shows when student violates proctoring rules -->
  <div id="lock-overlay"
    class="fixed inset-0 z-[9998] bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center"
    style="display: none;">
    <!-- Content injected by showLockEnforcementUI() -->
  </div>

  <!-- Transition Loading Overlay - Shows during view transitions -->
  <div id="transition-overlay"
    class="fixed inset-0 z-[9990] bg-white/95 backdrop-blur-sm flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-200"
    style="display: none;">
    <div class="flex flex-col items-center gap-4">
      <div class="flex flex-row gap-2">
        <div class="w-3 h-3 rounded-full bg-veritas-navy animate-bounce"></div>
        <div class="w-3 h-3 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.15s]"></div>
        <div class="w-3 h-3 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.3s]"></div>
      </div>
      <p id="transition-message" class="text-veritas-navy text-sm font-medium">Loading...</p>
    </div>
  </div>

  <!-- Flashlight Overlay for Review Mode -->
  <div id="flashlight-overlay" class="fixed inset-0 z-[8000] pointer-events-none" style="display: none;"></div>

  <!-- Global Heads-Up Display -->
  <header class="hud-bar">
    <div class="hud-left">
      <span class="hud-brand" aria-label="Veritas">VERITAS</span>
      <span id="student-mode-label" class="hud-mode">Live Poll</span>
    </div>
    <div class="hud-center">
      <p id="question-progress" class="hud-progress" aria-live="polite">QUESTION --</p>
    </div>
    <div class="hud-right">
      <div id="secure-topbar-timer" class="hud-timer hidden" aria-live="polite">
        <button id="timer-visibility-toggle" type="button" class="hud-icon-btn" aria-pressed="false"
          aria-label="Hide timer">
          <span class="material-symbols-outlined" aria-hidden="true">visibility</span>
        </button>
        <span id="secure-countdown" class="hud-timer-value">00:00</span>
      </div>
      <div id="loader" class="loader" style="display: none;">
        <div class="h-6 w-6 animate-spin rounded-full border-2 border-white/80 border-t-transparent"></div>
      </div>
    </div>
  </header>

  <main class="page-shell">
    <div id="connectivity-banner"
      class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-lg flex items-center gap-3 rounded-xl border border-amber-300 bg-amber-50 px-4 py-3 text-amber-800 shadow-lg transition-all duration-200 backdrop-blur-sm">
      <span id="connectivity-icon" class="material-symbols-outlined text-2xl">sync</span>
      <div class="flex flex-col text-left flex-1">
        <span id="connectivity-message" class="text-sm font-semibold">Reconnecting... your poll data is catching
          up.</span>
        <span id="connectivity-submessage" class="text-xs text-amber-700/80 opacity-0"></span>
      </div>
    </div>
    <!-- Entry Screen - Clean Professional Landing Panel -->
    <div id="entry-screen" class="w-full max-w-4xl mx-auto text-left animate-fade-in px-6">
      <div class="space-y-8">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 rounded-xl flex items-center justify-center"
            style="background: #12385d; color: #ffffff;">
            <span class="material-symbols-outlined text-3xl">fact_check</span>
          </div>
          <div>
            <p class="text-sm font-semibold uppercase tracking-[0.22em] text-[#12385d]">Veritas</p>
            <h1 class="text-4xl sm:text-5xl font-bold" style="color: #12385d; letter-spacing: -0.01em;">Live Polls</h1>
          </div>
        </div>
        <p class="text-lg text-gray-700 leading-relaxed max-w-2xl">Your session will begin in fullscreen for a
          distraction-free experience. Click below to get started.</p>
        <button id="start-session-btn" type="button"
          class="inline-flex items-center justify-center gap-3 px-10 py-3 rounded-full text-white text-lg font-semibold transition-all duration-200 hover:shadow-md focus:outline-none focus:ring-4 focus:ring-[#12385d]/20"
          style="background: #12385d;">
          <span class="material-symbols-outlined text-2xl">play_arrow</span>
          <span>Begin Poll</span>
        </button>
      </div>
    </div>


    <!-- Student App Container -->
    <div class="w-full max-w-6xl mx-auto" id="student-container" style="display: none;">
      <div id="student-loader" class="flex flex-col items-center justify-center min-h-[50vh] animate-fade-in"
        style="display: block;">
        <div class="relative w-24 h-24 mb-8 flex items-center justify-center">
          <div class="absolute inset-0 rounded-full bg-veritas-navy/10 animate-pulse-ring"></div>
          <div class="absolute inset-0 rounded-full bg-veritas-navy/10 animate-pulse-ring" style="animation-delay: 1s;">
          </div>
          <div class="relative w-16 h-16 rounded-full bg-veritas-navy flex items-center justify-center shadow-xl">
            <span class="material-symbols-outlined text-3xl text-white">psychology</span>
          </div>
        </div>
        <h2 class="text-2xl font-bold text-veritas-navy mb-2 animate-text-shimmer">Initializing Session...</h2>
        <p class="text-slate-500 font-medium">Establishing secure connection</p>
      </div>

      <section id="secure-lobby" class="secure-lobby-card animate-fade-in" style="display: none;">
        <div class="px-8 sm:px-12 py-8 border-b border-slate-100">
          <p class="text-xs font-semibold tracking-[0.3em] text-veritas-navy/70 uppercase">Secure Assessment</p>
          <h2 id="secure-lobby-title" class="text-3xl sm:text-4xl font-semibold text-veritas-navy mt-2">Secure
            Assessment</h2>
          <p id="secure-lobby-summary" class="text-base text-slate-500 mt-2"></p>
        </div>
        <div class="px-8 sm:px-12 py-8 grid gap-8 lg:grid-cols-2">
          <div class="space-y-6">
            <div class="flex flex-wrap gap-4">
              <div class="secure-lobby-chip">
                <span class="text-xs font-semibold tracking-wide text-slate-500 uppercase">Time Limit</span>
                <span id="secure-lobby-time" class="text-2xl font-semibold text-veritas-navy mt-1">--</span>
              </div>
              <div class="secure-lobby-chip">
                <span class="text-xs font-semibold tracking-wide text-slate-500 uppercase">Questions</span>
                <span id="secure-lobby-questions" class="text-2xl font-semibold text-veritas-navy mt-1">--</span>
              </div>
            </div>
            <p id="secure-window-message" class="text-sm text-slate-500"></p>
          </div>
          <div id="secure-access-code-group" class="space-y-2" style="display: none;">
            <label for="secure-access-code" class="text-sm font-semibold text-slate-600">Access Code</label>
            <input id="secure-access-code" type="text" inputmode="text" autocomplete="off" maxlength="16"
              class="w-full rounded-2xl border border-slate-200 px-4 py-3 text-lg font-semibold tracking-[0.4em] text-center uppercase focus:border-veritas-navy focus:ring-2 focus:ring-veritas-navy/30"
              placeholder="ENTER CODE" />
            <p id="secure-access-code-error" class="text-sm text-red-600 hidden"></p>
          </div>
        </div>
        <div class="px-8 sm:px-12 pb-10 flex flex-col gap-4">
          <button id="secure-begin-btn" type="button"
            class="inline-flex items-center justify-center gap-2 rounded-2xl bg-veritas-navy px-8 py-4 text-white text-lg font-semibold shadow-lg transition hover:-translate-y-0.5 hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-veritas-navy/30">
            <span class="material-symbols-outlined text-xl">fullscreen</span>
            <span id="secure-begin-label">Begin Assessment</span>
          </button>
          <p class="text-xs text-slate-500">Going fullscreen is required. Your teacher is monitoring for tab switches
            and disconnects.</p>
          <ul id="secure-rules-list" class="secure-rules-list space-y-3"></ul>
        </div>
      </section>

      <!-- Pre-Live Card - Redesigned Waiting Screen -->
      <section id="pre-live-card" class="student-card student-pre-live-card text-center animate-fade-in"
        style="display: none; max-width: 900px; background: white; color: #111;">
        <div class="student-card-body student-pre-live-body" style="padding: 29px 19px;">
          <!-- Animated Icon -->
          <div class="student-pre-live-icon mb-6" aria-hidden="true"
            style="width: 96px; height: 96px; margin: 0 auto; background: rgba(18, 56, 93, 0.08); color: #12385d; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;">
            <span class="material-symbols-outlined" style="font-size: 3.5rem;">hourglass_top</span>
          </div>

          <!-- Main Message -->
          <h2 id="pre-live-primary" class="student-stem text-4xl sm:text-5xl font-bold mb-4" style="color: #12385d;">
            Waiting for your teacher to start the poll
            <span class="waiting-dots ml-2">
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
            </span>
          </h2>

          <!-- Subtext -->
          <p id="pre-live-subline" class="student-subline text-lg max-w-2xl mx-auto mb-6" style="color: #6b7280;">
            Keep this tab open  the question will appear automatically.
          </p>

          <!-- Humorous Footer -->
          <p class="text-sm italic mt-8" style="color: #9ca3af;">
            Patience is a virtue (and a graded skill).
          </p>

          <!-- Optional Shimmer Particles -->
          <div class="shimmer-particle" style="top: 20%; left: 15%; animation-delay: 0s;"></div>
          <div class="shimmer-particle" style="top: 60%; right: 20%; animation-delay: 2s;"></div>
          <div class="shimmer-particle" style="bottom: 30%; left: 25%; animation-delay: 4s;"></div>
        </div>

        <!-- Status Footer -->
        <div class="student-card-options student-pre-live-footer"
          style="background: rgba(18, 56, 93, 0.04); padding: 12px 19px; border-top: 1px solid rgba(18, 56, 93, 0.1);">
          <div class="student-pre-live-status" style="color: #12385d;">
            <span class="student-pre-live-label font-bold">PRE-LIVE</span>
            <span class="student-pre-live-pips" aria-hidden="true">
              <span class="pip" style="animation-delay: 0s; background: #12385d;"></span>
              <span class="pip" style="animation-delay: 0.2s; background: #12385d;"></span>
              <span class="pip" style="animation-delay: 0.4s; background: #12385d;"></span>
            </span>
          </div>
          <p id="pre-live-reconnect-line" class="student-pre-live-reconnect hidden" style="color: #12385d;">
            Reconnecting syncing you back into place.
          </p>
        </div>
      </section>

      <!-- Status Container -->
      <div id="status-container" class="text-center py-12 animate-fade-in" style="display: none;">
        <div class="status-card bg-white rounded-2xl border border-gray-200 p-8 sm:p-12 shadow-2xl max-w-3xl mx-auto">
          <span class="material-symbols-outlined text-6xl text-veritas-navy mb-4 inline-block">schedule</span>
          <h2 id="status-message" class="text-gray-900 text-2xl font-semibold">Connecting...</h2>
          <p id="status-submessage" class="text-gray-700 text-lg mt-4" style="display: none;"></p>
          <div id="resume-controls" class="mt-8 space-y-3" style="display: none;">
            <p class="text-gray-800 text-base leading-relaxed">
              Click below to return to fullscreen and resume.
            </p>
            <button id="resume-session-btn" type="button"
              class="mx-auto flex items-center justify-center gap-2 px-8 py-4 rounded-lg bg-green-500 text-white text-lg font-bold hover:bg-green-600 transition-transform duration-300 hover:scale-105 shadow-lg">
              <span class="material-symbols-outlined text-xl">fullscreen</span>
              <span id="resume-session-label">Resume Poll</span>
            </button>
          </div>
          <div id="secure-exit-controls" class="mt-10 space-y-3 hidden">
            <p id="secure-exit-description" class="text-gray-800 text-base leading-relaxed">
              When your teacher dismisses you, use the button below to close fullscreen safely.
            </p>
            <button id="secure-exit-btn" type="button"
              class="mx-auto flex items-center justify-center gap-2 px-8 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 text-base font-semibold hover:bg-gray-200 transition-colors">
              <span class="material-symbols-outlined text-lg">logout</span>
              <span id="secure-exit-label">Exit Secure Session</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Question Container -->
      <section id="question-container" class="student-card prevent-select animate-fade-in" aria-live="polite"
        style="display: none;">
        <div id="question-content" class="question-layout no-image">
          <div id="question-visual" class="question-visual">
            <img id="question-image" src="" alt="Question" class="student-question-image" referrerpolicy="no-referrer"
              onerror="this.style.display='none';" style="display: none;" />
          </div>
          <div class="question-textual">
            <h2 id="question-text" class="student-stem whitespace-pre-wrap"></h2>
            <p id="question-subline" class="student-subline hidden"></p>
          </div>
        </div>
        <div class="answer-area">
          <p id="no-responses-message" class="student-no-responses hidden"></p>
          <ul id="options-list" class="student-choices"></ul>
        </div>
      </section>

      <!-- Secure Assessment Focus Mode -->
      <section id="individual-timed-session" class="student-card secure-session-card prevent-select animate-fade-in"
        style="display: none;" aria-live="polite">
        <p id="secure-progress-label" class="sr-only">Question 1 of 10</p>
        <div id="secure-connection-warning" class="secure-connection-warning hidden"></div>
        <div id="secure-question-content" class="secure-session-body">
          <div id="secure-question-layout" class="question-layout no-image">
            <div id="secure-question-visual" class="question-visual">
              <img id="secure-question-image" src="" alt="Question" class="student-question-image"
                referrerpolicy="no-referrer" onerror="this.style.display='none';" style="display: none;" />
            </div>
            <div class="question-textual">
              <h2 id="secure-question-text" class="student-stem whitespace-pre-wrap"></h2>
              <p id="secure-question-subline" class="student-subline hidden"></p>
            </div>
          </div>
          <div class="answer-area">
            <ul id="secure-options-list" class="student-choices"></ul>
          </div>

          <!-- Metacognition Confidence Selector -->
          <div id="secure-confidence-prompt" class="secure-confidence-prompt hidden" style="display: none;">
            <div class="confidence-wrapper">
              <h3 class="confidence-title">How confident are you in your answer?</h3>
              <div class="confidence-buttons">
                <button type="button" class="confidence-btn confidence-guessing" data-confidence="guessing">
                  <span class="confidence-emoji"></span>
                  <span class="confidence-label">Guessing</span>
                </button>
                <button type="button" class="confidence-btn confidence-somewhat" data-confidence="somewhat-sure">
                  <span class="confidence-emoji"></span>
                  <span class="confidence-label">Somewhat Sure</span>
                </button>
                <button type="button" class="confidence-btn confidence-very" data-confidence="very-sure">
                  <span class="confidence-emoji"></span>
                  <span class="confidence-label">Very Sure</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="secure-session-footer">
          <button id="secure-submit-btn" class="secure-submit-btn" type="button">
            <span class="material-symbols-outlined text-xl" aria-hidden="true">arrow_forward</span>
            <span id="secure-submit-label">Lock Answer &amp; Next</span>
          </button>
          <p id="secure-submit-hint" class="secure-submit-hint">Select an answer before locking and moving forward.</p>
        </div>
      </section>

      <div id="secure-connection-indicator" class="secure-connection-indicator hidden" aria-live="polite">
        <span id="secure-connection-dot" class="secure-connection-dot bg-emerald-400" aria-hidden="true"></span>
        <span id="secure-connection-status" class="sr-only" role="status">Connected</span>
      </div>

    </div>

    <!-- TI-84 Calculator FAB and Draggable Window -->
    <button id="calc-fab"
      class="hidden fixed bottom-6 right-6 z-40 h-14 w-14 rounded-full bg-veritas-navy text-white shadow-xl hover:bg-veritas-navy/90 transition-transform active:scale-95 flex items-center justify-center"
      aria-label="Open TI-84 Calculator">
      <span class="material-symbols-outlined text-2xl">functions</span>
    </button>

    <div id="calc-window"
      class="hidden fixed bottom-28 right-6 z-50 w-[360px] h-[640px] bg-brand-dark-gray rounded-xl shadow-2xl overflow-hidden border border-white/20 flex flex-col resize-y min-h-[400px] max-h-[90vh]">
      <div id="calc-header"
        class="h-10 bg-veritas-navy/90 backdrop-blur cursor-move flex items-center justify-between px-4 select-none flex-shrink-0">
        <span class="text-white font-bold text-xs tracking-wider uppercase flex items-center gap-2">
          <span class="material-symbols-outlined text-sm">function</span> TI-84 Plus
        </span>
        <button id="calc-close" type="button" class="text-white/60 hover:text-white transition-colors">
          <span class="material-symbols-outlined text-lg">close</span>
        </button>
      </div>

      <!-- Debug Overlay (Hidden by default) -->
      <div id="debug-overlay"
        class="fixed top-0 left-0 w-full h-full bg-black/90 z-[9999] hidden p-4 font-mono text-green-400 text-xs overflow-auto pointer-events-none">
        <div class="pointer-events-auto absolute top-4 right-4">
          <button onclick="document.getElementById('debug-overlay').classList.add('hidden')"
            class="bg-red-500/20 text-red-500 px-3 py-1 rounded border border-red-500/50">CLOSE</button>
        </div>
        <div id="debug-content" class="whitespace-pre-wrap">Waiting for debug data...</div>
      </div>
      <div class="flex-1 bg-black relative overflow-hidden">
        <div id="calc-loader" class="absolute inset-0 flex items-center justify-center text-white/50 text-sm">Loading...
        </div>
        <iframe id="calc-iframe" src="about:blank" data-src="https://mpcalc-aaa91.web.app/"
          class="w-full h-full border-0" allow="fullscreen" title="TI-84 Calculator"
          aria-label="Embedded TI-84 calculator" tabindex="-1" data-safe-harbor="calculator"></iframe>
      </div>
    </div>
  </main>
  <style>
    /* Login Screen Styles */
    #login-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Inter', sans-serif;
    }

    .login-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        border-radius: 24px;
        padding: 48px;
        width: 100%;
        max-width: 420px;
        text-align: center;
        animation: loginSlideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes loginSlideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .login-logo {
        width: 64px;
        height: 64px;
        margin: 0 auto 24px;
        background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
    }

    .login-logo span {
        font-size: 32px;
        color: white;
    }

    .login-title {
        color: white;
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 8px;
        letter-spacing: -0.02em;
    }

    .login-subtitle {
        color: #94a3b8;
        font-size: 15px;
        margin-bottom: 32px;
        line-height: 1.5;
    }

    .login-btn {
        width: 100%;
        background: white;
        color: #0f172a;
        border: none;
        padding: 14px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        transition: all 0.2s ease;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .login-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        background: #f8fafc;
    }

    .login-btn:active {
        transform: translateY(0);
    }

    .login-btn-icon {
        width: 20px;
        height: 20px;
    }

    .login-error {
        margin-top: 16px;
        padding: 12px;
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 8px;
        color: #fca5a5;
        font-size: 13px;
        display: none;
        animation: shake 0.4s ease-in-out;
    }

    @keyframes shake {

        0%,
        100% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-4px);
        }

        75% {
            transform: translateX(4px);
        }
    }

    .login-footer {
        margin-top: 32px;
        color: #64748b;
        font-size: 12px;
    }
</style>

<div id="login-overlay" style="display: none;">
    <div class="login-card">
        <div class="login-logo">
            <span class="material-symbols-outlined">school</span>
        </div>
        <h1 class="login-title">Veritas Live</h1>
        <p class="login-subtitle">Sign in to access your classroom polls and assessments.</p>

        <button id="google-login-btn" class="login-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="login-btn-icon"
                alt="Google">
            Sign in with Google
        </button>

        <div id="login-error" class="login-error"></div>

        <div class="login-footer">
            &copy; 2024 Veritas Education. Secure & Private.
        </div>
    </div>
</div>

<script>
    (function () {
        // Expose LoginManager globally
        window.LoginManager = {
            show: function () {
                var el = document.getElementById('login-overlay');
                if (el) el.style.display = 'flex';
            },
            hide: function () {
                var el = document.getElementById('login-overlay');
                if (el) el.style.display = 'none';
            },
            setError: function (msg) {
                var el = document.getElementById('login-error');
                if (el) {
                    el.textContent = msg;
                    el.style.display = 'block';
                }
            },
            init: function (onSuccess) {
                var btn = document.getElementById('google-login-btn');
                if (btn) {
                    btn.addEventListener('click', function () {
                        var provider = new firebase.auth.GoogleAuthProvider();
                        // Force account selection
                        provider.setCustomParameters({
                            prompt: 'select_account'
                        });

                        firebase.auth().signInWithPopup(provider)
                            .then(function (result) {
                                var user = result.user;
                                console.log('[Auth] Signed in as:', user.email);

                                // Persist session
                                sessionStorage.setItem('veritas_session_token', user.uid); // Using UID as token for now
                                sessionStorage.setItem('veritas_student_email', user.email);

                                // Update Global State
                                window.SESSION_TOKEN = user.uid;
                                window.STUDENT_EMAIL = user.email;

                                LoginManager.hide();
                                if (onSuccess) onSuccess(user);
                            })
                            .catch(function (error) {
                                console.error('[Auth] Login failed:', error);
                                LoginManager.setError(error.message);
                            });
                    });
                }
            }
        };
    })();
</script>
  <script>
(function(global) {
  'use strict';

  // Deterministic Student Key Generation (SHA-256)
  // This matches the user's requirement for a collision-resistant key.
  // We use Web Crypto API which is available in modern browsers.

  async function generateStudentHash(email, pollId) {
    if (!email) return 'unknown_student';

    // Normalize: lowercase, trim
    const normalized = email.toLowerCase().trim();

    // Namespace with pollId if provided (optional but good for isolation)
    const data = pollId ? `${pollId}:${normalized}` : normalized;

    const encoder = new TextEncoder();
    const dataBuffer = encoder.encode(data);

    try {
      const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      // Convert to hex string
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      // Return first 16 chars as key (enough entropy for this context)
      return hashHex.substring(0, 16);
    } catch (e) {
      console.warn('Web Crypto unavailable, falling back to simple hash', e);
      // Fallback for very old browsers (unlikely in this context but safe)
      var hash = 0;
      for (var i = 0; i < data.length; i++) {
        var char = data.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return 'fb_' + Math.abs(hash).toString(16);
    }
  }

  // Export
  global.VeritasShared = global.VeritasShared || {};
  global.VeritasShared.generateStudentKey = generateStudentHash;

  // ========================================================================
  // VERITAS DEBUG HELPER
  // Accessible from browser console: VeritasDebug.printFirebaseConfig()
  // Safe no-op if Firebase is not available.
  // ========================================================================
  global.VeritasDebug = {
    /**
     * Print Firebase configuration details to console.
     * Call from browser DevTools: VeritasDebug.printFirebaseConfig()
     */
    printFirebaseConfig: function() {
      console.group(' VeritasDebug: Firebase Configuration');

      // Check FIREBASE_CONFIG
      if (typeof FIREBASE_CONFIG !== 'undefined' && FIREBASE_CONFIG) {
        console.log(' FIREBASE_CONFIG exists');
        console.log('  databaseURL:', FIREBASE_CONFIG.databaseURL || '(not set)');
        console.log('  projectId:', FIREBASE_CONFIG.projectId || '(not set)');
        console.log('  Full config:', FIREBASE_CONFIG);
      } else {
        console.warn(' FIREBASE_CONFIG is NOT defined');
      }

      // Check firebase SDK
      if (typeof firebase !== 'undefined') {
        console.log(' firebase SDK is loaded');
        console.log('  firebase.apps.length:', firebase.apps ? firebase.apps.length : 'n/a');
        if (firebase.apps && firebase.apps.length > 0) {
          console.log('  Default app name:', firebase.apps[0].name);
          console.log('  Database URL:', firebase.apps[0].options.databaseURL || '(not set)');
        }
      } else {
        console.warn(' firebase SDK is NOT loaded');
      }

      // Check firebaseDb reference (if exists in scope)
      if (typeof firebaseDb !== 'undefined' && firebaseDb) {
        console.log(' firebaseDb reference exists');
      } else {
        console.log(' firebaseDb reference not in scope (normal before init)');
      }

      console.groupEnd();
      return {
        configExists: typeof FIREBASE_CONFIG !== 'undefined',
        databaseURL: (typeof FIREBASE_CONFIG !== 'undefined' && FIREBASE_CONFIG) ? FIREBASE_CONFIG.databaseURL : null,
        firebaseLoaded: typeof firebase !== 'undefined',
        appsLength: (typeof firebase !== 'undefined' && firebase.apps) ? firebase.apps.length : 0
      };
    },

    /**
     * Print current page context for debugging
     */
    printContext: function() {
      console.group(' VeritasDebug: Page Context');
      console.log('Location:', window.location.href);
      console.log('Page type:', document.title);

      // Check for session token (student pages)
      if (typeof SESSION_TOKEN !== 'undefined') {
        console.log('SESSION_TOKEN:', SESSION_TOKEN ? '(present, length=' + SESSION_TOKEN.length + ')' : '(empty)');
      }

      // Check for poll data (teacher pages)
      if (typeof CURRENT_POLL_DATA !== 'undefined') {
        console.log('CURRENT_POLL_DATA:', CURRENT_POLL_DATA);
      }

      console.groupEnd();
    }
  };

})(this);
</script>

  <script>
    (function () {
        var secureFocusContainer = document.getElementById('individual-timed-session');
        var secureProgressLabel = document.getElementById('secure-progress-label');
        var secureCountdownEl = document.getElementById('secure-countdown');
        var secureTopbarTimer = document.getElementById('secure-topbar-timer');
        var timerVisibilityToggle = document.getElementById('timer-visibility-toggle');
        var questionProgressEl = document.getElementById('question-progress');
        var studentModeLabel = document.getElementById('student-mode-label');
        var questionLayout = document.getElementById('question-content');
        var questionVisual = document.getElementById('question-visual');
        var secureQuestionLayout = document.getElementById('secure-question-layout');
        var secureQuestionVisual = document.getElementById('secure-question-visual');
        var secureConnectionDot = document.getElementById('secure-connection-dot');
        var secureConnectionIndicator = document.getElementById('secure-connection-indicator');
        var secureConnectionStatus = document.getElementById('secure-connection-status');
        var secureConnectionWarning = document.getElementById('secure-connection-warning');
        var secureQuestionText = document.getElementById('secure-question-text');
        var secureQuestionSubline = document.getElementById('secure-question-subline');
        var secureQuestionImage = document.getElementById('secure-question-image');
        var secureOptionsList = document.getElementById('secure-options-list');
        var secureSubmitBtn = document.getElementById('secure-submit-btn');
        var secureSubmitLabel = document.getElementById('secure-submit-label');
        var secureSubmitHint = document.getElementById('secure-submit-hint');
        var secureConfidencePrompt = document.getElementById('secure-confidence-prompt');
        var timerHidden = false;
        var lastTimerDisplay = '00:00';
        var secureCountdownTotal = 0;
        var bodyEl = document.body;
        var secureCloseTimer = null;
        var firebaseDb = null;
        var firebaseRef = null;
        var studentKey = null;

        // --- FIREBASE INIT ---
        var currentFirebasePollId = null; // Store pollId for debug HUD
        var lastQuestionIndex = -1;
        var liveSessionRef = null;
        var connectedRef = null;

        // UUID Generator (Polyfill)
        function generateUUID() {
            if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {
                return crypto.randomUUID();
            }
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        async function initFirebaseSidecar(pollId, studentEmail) {
            if (!FIREBASE_CONFIG || !pollId || !studentEmail) return;

            // CHECK: If pollId changed, cleanup old listeners
            if (currentFirebasePollId && currentFirebasePollId !== pollId) {
                console.log('[Firebase] PollId changed from ' + currentFirebasePollId + ' to ' + pollId + ' - Validating cleanup...');

                // 1. Detach Student Status Listener
                if (firebaseRef) {
                    try {
                        firebaseRef.off();
                        console.log('[Firebase] Detached old student status listener');
                    } catch (e) { console.warn('Error detaching firebaseRef:', e); }
                    firebaseRef = null;
                }

                // 2. Detach Live Session Listener
                if (liveSessionRef) {
                    try {
                        liveSessionRef.off();
                        console.log('[Firebase] Detached old live session listener');
                    } catch (e) { console.warn('Error detaching liveSessionRef:', e); }
                    liveSessionRef = null;
                }

                // 3. Detach Connected Listener (optional, but cleaner)
                if (connectedRef) {
                    try {
                        connectedRef.off();
                    } catch (e) { }
                    connectedRef = null;
                }

                currentFirebasePollId = null;
            }

            // Prevent double init for same pollId
            if (firebaseRef && currentFirebasePollId === pollId) {
                return;
            }

            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                firebase.initializeApp(FIREBASE_CONFIG);
            }

            if (typeof firebase !== 'undefined') {
                firebaseDb = firebase.database();
                // Deterministic key generation
                studentKey = await window.VeritasShared.generateStudentKey(studentEmail, pollId);
                currentFirebasePollId = pollId; // Store for debug HUD

                var path = 'sessions/' + pollId + '/students/' + studentKey;
                firebaseRef = firebaseDb.ref(path);

                // 1. Set Initial State with Read-Before-Write
                // Only set ACTIVE if current is null/undefined or DISCONNECTED.
                // Do NOT overwrite LOCKED or FINISHED.
                firebaseRef.once('value').then(function (snapshot) {
                    var current = snapshot.val();
                    if (!current || current === 'DISCONNECTED') {
                        firebaseRef.set('ACTIVE');
                    }
                });

                // 2. On Disconnect -> DISCONNECTED
                firebaseRef.onDisconnect().set('DISCONNECTED');

                // 3. Listen for changes (Remote Lock/Unlock)
                firebaseRef.on('value', function (snapshot) {
                    var status = snapshot.val();
                    handleRemoteStatusChange(status);
                    updateDebugHud(status, null, currentFirebasePollId);
                });

                // Connection State for HUD & Adaptive Polling
                connectedRef = firebaseDb.ref('.info/connected');
                connectedRef.on('value', function (snap) {
                    var connected = snap.val() === true;
                    updateDebugHud(null, connected, currentFirebasePollId);

                    // ADAPTIVE POLLING: Reduce server load when Firebase is active
                    // If connected, we receive "signals" for state changes, so we can poll slowly.
                    // If disconnected, we fallback to fast polling to ensure responsiveness.
                    if (connected) {
                        console.log('[Adaptive Polling] Firebase connected - switching to balanced poll (5s)');
                        defaultPollInterval = 5000;
                    } else {
                        console.log('[Adaptive Polling] Firebase disconnected - switching to fast poll (2.5s)');
                        defaultPollInterval = 2500;
                    }
                });

                // 4. Signal-to-Poll: Listen for public state changes
                // When teacher advances slide, a signal is written here.
                // NEW: Listen to 'live_session' for instant updates (Hybrid Architecture)
                var sessionPath = 'sessions/' + pollId + '/live_session';
                liveSessionRef = firebaseDb.ref(sessionPath);

                liveSessionRef.on('value', function (snapshot) {
                    var data = snapshot.val();
                    if (data) {
                        console.log('[Firebase] Live Session update received:', data);

                        // If we have full metadata and a current pollId, update UI directly
                        // We strictly check for question content to ensure it's a 'Fast Path' signal
                        if (data.questionText && data.pollId && typeof updateStudentView === 'function') {
                            console.log('[Firebase] Fast Path: Updating view from pushed state');

                            // Synthesize the state payload for updateStudentView
                            var statePayload = {
                                pollId: data.pollId,
                                questionIndex: data.questionIndex,
                                status: data.status || 'OPEN',
                                questionText: data.questionText,
                                questionImageURL: data.questionImageURL,
                                options: data.options || [],
                                totalQuestions: data.totalQuestions, // Optional, caller handles if null
                                sessionPhase: data.sessionPhase || (data.metadata && data.metadata.sessionPhase) || 'LIVE',
                                resultsVisibility: data.resultsVisibility || (data.metadata && data.metadata.resultsVisibility) || 'HIDDEN'
                            };

                            // Add any extra metadata from the payload
                            if (data.metadata) {
                                for (var key in data.metadata) {
                                    if (!statePayload.hasOwnProperty(key)) {
                                        statePayload[key] = data.metadata[key];
                                    }
                                }
                            }

                            updateStudentView(statePayload);
                        } else {
                            // Fallback to polling for full state if data is incomplete
                            // FIX: If status changed (e.g. CLOSED), we should respect that even without text
                            if (data.status && data.status !== 'OPEN') {
                                console.log('[Firebase] Fast Path (Status Only): Processing status change to ' + data.status);
                                // Call updateStudentView with minimal data to trigger status change
                                if (typeof updateStudentView === 'function') {
                                    updateStudentView({
                                        pollId: data.pollId || pollId,
                                        questionIndex: data.questionIndex,
                                        status: data.status,
                                        sessionPhase: data.sessionPhase || 'LIVE'
                                    });
                                }
                            }

                            console.log('[Firebase] Slow Path: Incomplete data, polling server to ensure consistency');
                            startPolling(true);
                        }
                    }
                });

                console.log('[Firebase] Sidecar initialized for', path);
            }
        }

        /**
         * Submit answer directly to Firebase (Fast Path)
         */
        async function submitAnswerToFirebase(pollId, questionIndex, answer, confidence, email) {
            if (!firebaseDb) {
                console.warn('[Firebase] DB not initialized, skipping fast write');
                return null;
            }

            try {
                // Determine email if not provided
                var studentEmail = email || window.STUDENT_EMAIL || sessionStorage.getItem('veritas_student_email');
                if (!studentEmail) {
                    console.error('[Firebase] Cannot submit answer - no email found');
                    return null;
                }

                var responseId = generateUUID();
                var timestamp = new Date().toISOString();

                var payload = {
                    responseId: responseId,
                    pollId: pollId,
                    questionIndex: questionIndex,
                    answer: answer,
                    studentEmail: studentEmail,
                    confidenceLevel: confidence || null,
                    timestamp: timestamp,
                    clientTimestamp: Date.now()
                };

                // WRITE DIRECTLY TO FIREBASE (Cloud Function Trigger Path)
                // Path: answers/{pollId}/{studentKey}
                // The Cloud Function 'onAnswerSubmitted' listens here to grade/process.
                var key = studentKey || studentEmail.replace(/\./g, ',');
                if (!key) {
                    console.error('[Firebase] No student key available for submission');
                    return null;
                }

                var path = 'answers/' + pollId + '/' + key;

                await firebaseDb.ref(path).set(payload);

                console.log('[Firebase] Write to ' + path + ' successful:', payload);
                return { success: true, responseId: responseId, timestamp: timestamp };
            } catch (e) {
                console.error('[Firebase] Fast Answer Failed:', e);
                return null;
            }
        }

        // =============================================================================
        // STUDENT ACTIVITY TRACKER MODULE
        // =============================================================================

        /**
         * Activity Tracker - Singleton for tracking granular student activity
         */
        var ActivityTracker = (function () {
            var instance = null;

            function createInstance() {
                var activityBuffer = [];
                var currentPollId = null;
                var currentSessionId = null;
                var currentQuestionIndex = null;
                var questionStartTime = null;
                var lastAnswer = null;
                var focusState = document.hasFocus();
                var flushInterval = null;
                var FLUSH_INTERVAL_MS = 3000; // Send batch every 3 seconds
                var MAX_BUFFER_SIZE = 50; // Flush if buffer exceeds 50 events

                function init(pollId, sessionId, questionIndex) {
                    currentPollId = pollId;
                    currentSessionId = sessionId || '';
                    currentQuestionIndex = questionIndex;
                    questionStartTime = Date.now();
                    lastAnswer = null;

                    // Start periodic flush
                    if (!flushInterval) {
                        flushInterval = setInterval(flushActivities, FLUSH_INTERVAL_MS);
                    }

                    // Track focus events
                    if (!window._activityTrackerFocusAttached) {
                        window.addEventListener('focus', onFocusGained);
                        window.addEventListener('blur', onFocusLost);
                        window._activityTrackerFocusAttached = true;
                    }

                    // Record question view
                    recordActivity('QUESTION_VIEW', {
                        viewedAt: Date.now(),
                        questionIndex: questionIndex
                    });
                }

                function setQuestionStart(timestamp) {
                    questionStartTime = timestamp || Date.now();
                }

                function recordActivity(eventType, eventData) {
                    if (!currentPollId) return;

                    var activity = {
                        pollId: currentPollId,
                        sessionId: currentSessionId,
                        questionIndex: currentQuestionIndex !== undefined ? currentQuestionIndex : '',
                        eventType: eventType,
                        eventData: eventData || {},
                        clientTimestamp: new Date().toISOString()
                    };

                    activityBuffer.push(activity);

                    // Flush if buffer is full
                    if (activityBuffer.length >= MAX_BUFFER_SIZE) {
                        flushActivities();
                    }
                }

                function recordAnswerSelected(answer, isChange) {
                    var eventType = isChange ? 'ANSWER_CHANGED' : 'ANSWER_SELECTED';
                    var timeOnQuestion = questionStartTime ? Date.now() - questionStartTime : 0;

                    recordActivity(eventType, {
                        answer: answer,
                        previousAnswer: lastAnswer,
                        timeOnQuestionMs: timeOnQuestion
                    });

                    lastAnswer = answer;
                }

                function recordAnswerSubmitted(answer, confidenceLevel) {
                    var timeOnQuestion = questionStartTime ? Date.now() - questionStartTime : 0;

                    recordActivity('ANSWER_SUBMITTED', {
                        answer: answer,
                        confidenceLevel: confidenceLevel || null,
                        timeOnQuestionMs: timeOnQuestion,
                        totalTimeMs: timeOnQuestion
                    });
                }

                function recordOptionClick(optionIndex, optionText) {
                    recordActivity('OPTION_CLICKED', {
                        optionIndex: optionIndex,
                        optionText: optionText
                    });
                }

                function onFocusGained() {
                    focusState = true;
                    recordActivity('FOCUS_GAINED', {
                        timestamp: Date.now()
                    });
                }

                function onFocusLost() {
                    focusState = false;
                    recordActivity('FOCUS_LOST', {
                        timestamp: Date.now()
                    });
                }

                async function flushActivities() {
                    if (activityBuffer.length === 0 || !firebaseDb) return;

                    var toSend = activityBuffer.slice();
                    activityBuffer = [];

                    var pollId = currentFirebasePollId || (toSend.length > 0 ? toSend[0].pollId : null);
                    if (!pollId || !studentKey) {
                        // Restore buffer if we can't send yet
                        activityBuffer = toSend.concat(activityBuffer);
                        return;
                    }

                    try {
                        var activitiesRef = firebaseDb.ref('sessions/' + pollId + '/activities/' + studentKey);
                        var updates = {};
                        toSend.forEach(function (activity) {
                            var newKey = activitiesRef.push().key;
                            updates[newKey] = activity;
                        });

                        await activitiesRef.update(updates);
                        console.log('[ActivityTracker] (Firebase) Flushed ' + toSend.length + ' events');
                    } catch (error) {
                        console.error('[ActivityTracker] Firebase Flush failed:', error);
                        // Re-add to buffer on failure (at front)
                        activityBuffer = toSend.concat(activityBuffer);
                    }
                }

                function reset() {
                    flushActivities(); // Flush before reset
                    currentPollId = null;
                    currentSessionId = null;
                    currentQuestionIndex = null;
                    questionStartTime = null;
                    lastAnswer = null;
                }

                function destroy() {
                    if (flushInterval) {
                        clearInterval(flushInterval);
                        flushInterval = null;
                    }
                    flushActivities(); // Final flush
                }

                return {
                    init: init,
                    setQuestionStart: setQuestionStart,
                    recordActivity: recordActivity,
                    recordAnswerSelected: recordAnswerSelected,
                    recordAnswerSubmitted: recordAnswerSubmitted,
                    recordOptionClick: recordOptionClick,
                    flushActivities: flushActivities,
                    reset: reset,
                    destroy: destroy
                };
            }

            return {
                getInstance: function () {
                    if (!instance) {
                        instance = createInstance();
                    }
                    return instance;
                }
            };
        })();

        // Global shorthand
        var activityTracker = ActivityTracker.getInstance();

        // =============================================================================
        // END ACTIVITY TRACKER
        // =============================================================================

        function updateDebugHud(status, connected, pollId) {
            if (!FIREBASE_CONFIG || !Veritas.Config.DEBUG_FIREBASE) return;

            var hud = document.getElementById('firebase-debug-hud');
            if (!hud) {
                hud = document.createElement('div');
                hud.id = 'firebase-debug-hud';
                hud.style.cssText = 'position:fixed;bottom:10px;left:10px;background:rgba(0,0,0,0.95);color:#4ade80;font-family:monospace;font-size:11px;padding:12px;z-index:9999;pointer-events:none;max-width:350px;border:2px solid #4ade80;border-radius:8px;';
                document.body.appendChild(hud);
            }

            // We store state on the DOM element dataset for merging updates
            if (status !== undefined && status !== null) hud.dataset.status = status;
            if (connected !== undefined && connected !== null) hud.dataset.connected = connected;
            if (pollId !== undefined && pollId !== null) hud.dataset.pollId = pollId;

            var currentStatus = hud.dataset.status || 'UNKNOWN';
            var isConnected = hud.dataset.connected === 'true';
            var currentPollId = hud.dataset.pollId || 'N/A';

            var connDot = isConnected ? '<span style="color:#4ade80"></span>' : '<span style="color:#f87171"></span>';
            var html = '<strong style="color:#fff"> FIREBASE DEBUG (STUDENT)</strong><br>';
            html += connDot + ' <strong>.info/connected:</strong> ' + isConnected + '<br>';
            html += '<strong>PollId (sessionKey):</strong> ' + currentPollId + '<br>';
            html += '<strong>StudentKey:</strong> ' + (studentKey ? studentKey.substring(0, 12) + '...' : 'N/A') + '<br>';

            var statusColor = currentStatus === 'LOCKED' ? '#f87171' : currentStatus === 'ACTIVE' ? '#4ade80' : '#facc15';
            html += '<strong>RTDB Status:</strong> <span style="color:' + statusColor + '">' + currentStatus + '</span><br>';

            // Show last violation reason
            var lockReason = '';
            try {
                lockReason = sessionStorage.getItem('lock_reason') || 'None';
            } catch (e) {
                lockReason = 'N/A';
            }
            html += '<strong>Last violation:</strong> ' + lockReason;

            hud.innerHTML = html;
        }

        function handleRemoteStatusChange(status) {
            console.log('[Firebase] Remote status update:', status);
            if (status === 'LOCKED') {
                // Server commanded lock
                if (!LockManager.isLocked()) {
                    LockManager.lock('Teacher Remote Lock');
                }
            } else if (status === 'ACTIVE') {
                // Teacher signalled unlock
                // IMPLEMENTATION FIX: Check both LockManager and Poison Pill state
                var isLocked = LockManager.isLocked() || isPoisonPillActive();

                if (isLocked) {
                    console.log('[Firebase] Unlock signal received - checking server for AWAITING_FULLSCREEN');
                    // FIX: Explicitly call checkProctorState immediately
                    // This bypasses the polling delay and handles the 'resume' flow
                    checkProctorState();
                } else {
                    console.log('[Firebase] Unlock signal received but not locally locked - ignoring');
                }
            }
        }

        function reportFirebaseViolation(reason, pollId) {
            // P0-4 FIX: Store lock reason in sessionStorage
            if (reason) {
                sessionStorage.setItem('lock_reason', reason);
            }

            // Extract pollId from available sources if not provided
            var activePollId = pollId ||
                (currentPollState && currentPollState.pollId) ||
                (secureLobbyContext && secureLobbyContext.pollId) ||
                window.currentPollId;

            // FALLBACK: Check sessionStorage
            if (!activePollId) {
                try {
                    activePollId = sessionStorage.getItem('veritas_active_poll_id');
                } catch (e) { /* Storage may be unavailable */ }
            }

            if (firebaseRef) {
                firebaseRef.set('LOCKED');

                // P0-3 FIX: Store violation reason in separate RTDB node for teacher visibility
                if (reason && activePollId && studentKey) {
                    var violationsRef = firebaseDb.ref('sessions/' + activePollId + '/violations/' + studentKey);
                    violationsRef.set({
                        reason: reason,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            }

            updateDebugHud('LOCKED', null, activePollId);
        }

        // ================================
        // UNIFIED ACTIVITY MONITOR
        // ================================
        var ActivityMonitor = (function () {
            var instance;

            function create() {
                var lastInteraction = Date.now();
                var currentQuestionStart = Date.now();
                var isCalculatorActive = false;

                function markInteraction() {
                    lastInteraction = Date.now();
                }

                function setQuestionStart(timestamp) {
                    currentQuestionStart = timestamp || Date.now();
                }

                function setCalculatorState(active) {
                    isCalculatorActive = !!active;
                }

                function getTelemetry() {
                    var now = Date.now();
                    var idleMs = now - lastInteraction;
                    var status = idleMs > 30000 ? 'IDLE' : (isCalculatorActive ? 'CALCULATOR' : 'ACTIVE');
                    return {
                        status: status,
                        lastInteraction: lastInteraction,
                        currentQuestionStart: currentQuestionStart,
                        timeOnQuestion: Math.max(0, now - currentQuestionStart),
                        usingCalculator: isCalculatorActive
                    };
                }

                function attachListeners() {
                    ['click', 'mousemove', 'keydown', 'touchstart'].forEach(function (evt) {
                        document.addEventListener(evt, markInteraction, { passive: true });
                    });
                    var calcFrame = document.getElementById('calc-iframe');
                    if (calcFrame) {
                        calcFrame.addEventListener('focus', function () { setCalculatorState(true); markInteraction(); });
                        calcFrame.addEventListener('blur', function () { setCalculatorState(false); });
                    }
                }

                attachListeners();

                return {
                    markInteraction: markInteraction,
                    setQuestionStart: setQuestionStart,
                    setCalculatorState: setCalculatorState,
                    getTelemetry: getTelemetry
                };
            }

            return {
                getInstance: function () {
                    if (!instance) {
                        instance = create();
                    }
                    return instance;
                }
            };
        })();

        var secureCountdownController = window.SecureAssessmentShared.createCountdown({
            onTick: function (seconds) {
                updateSecureTimerDisplay(seconds);
            },
            onExpire: function () {
                handleSecureTimeExpiry();
            }
        });
        var secureSessionHeartbeat = window.SecureAssessmentShared.createHeartbeat({
            intervalMs: 3500,
            onBeat: function () {
                pollForIndividualSessionState();
            }
        });
        var secureFullscreenManager = window.SecureAssessmentShared.createFullscreenManager(document, {
            onChange: handleSecureFullscreenChange
        });

        // Local session state guards (prevent UI rewind)
        var lastSubmittedQuestionIndex = null;
        var pendingMetacogQuestionIndex = null;
        var metacogSubmittedFor = null;

        if (timerVisibilityToggle) {
            timerVisibilityToggle.addEventListener('click', function () {
                timerHidden = !timerHidden;
                applyTimerVisibility();
            });
        }

        applyTimerVisibility();
        var secureSessionActive = false;
        var secureQuestionState = null;
        var secureSelectedOptionIndex = null;
        var secureCurrentQuestionKey = null;
        var secureSubmitting = false;
        var secureTimeExpired = false;
        var securePollInFlight = false;
        var secureMetacognitionEnabled = false;
        var securePendingAnswerText = null;

        // =============================================================================
        // SOVEREIGN STATE MANAGEMENT (Novel Approach)
        // =============================================================================

        var ViewManager = {
            views: [
                'entry-screen',
                'secure-lobby',
                'status-container',
                'pre-live-card',
                'student-container',
                'question-container',
                'individual-timed-session',
                'student-loader'
            ],
            show: function (viewId) {
                var self = this;

                // Special handling: 'student-container' wraps 'question-container', 'pre-live-card', etc.
                // If showing a child of student-container, we must also show student-container
                var isStudentContent = ['question-container', 'pre-live-card', 'status-container'].indexOf(viewId) !== -1;

                this.views.forEach(function (id) {
                    var el = document.getElementById(id);
                    if (!el) return;

                    if (id === viewId) {
                        el.style.display = 'block';
                        el.classList.remove('hidden');
                    } else if (id === 'student-container' && isStudentContent) {
                        // Ensure parent container is visible
                        el.style.display = 'block';
                        el.classList.remove('hidden');
                    } else {
                        el.style.display = 'none';
                        el.classList.add('hidden');
                    }
                });
                console.log('[ViewManager] Active View:', viewId);
            }
        };

        // Global Error Trapping
        window.onerror = function (msg, url, line, col, error) {
            var debugContent = document.getElementById('debug-content');
            if (debugContent) {
                var timestamp = new Date().toLocaleTimeString();
                debugContent.innerHTML += `\n[${timestamp}] ERROR: ${msg}\nLine: ${line}`;

                // Auto-show debug overlay on critical errors if safe
                var overlay = document.getElementById('debug-overlay');
                if (overlay && msg.indexOf('ScriptError') === -1) { // Ignore common script interruptions
                    overlay.classList.remove('hidden');
                }
            }
            return false;
        };

        var LockManager = {
            isLocked: function () {
                try {
                    return sessionStorage.getItem('veritas_lock_active') === 'true';
                } catch (e) { return false; }
            },
            lock: function (reason) {
                console.warn('[LockManager] LOCKING:', reason);
                try {
                    sessionStorage.setItem('veritas_lock_active', 'true');
                    sessionStorage.setItem('lock_reason', reason || 'unknown');
                } catch (e) { }

                this.renderLockScreen(reason);

                // FIX: Report violation with proper error handling and retry logic
                // Use robust pollId resolution with sessionStorage fallback
                var activePollId = (typeof currentPollState !== 'undefined' && currentPollState && currentPollState.pollId) ||
                    (typeof secureLobbyContext !== 'undefined' && secureLobbyContext && secureLobbyContext.pollId) ||
                    (typeof secureQuestionState !== 'undefined' && secureQuestionState && secureQuestionState.pollId) ||
                    window.currentPollId;

                // CRITICAL FALLBACK: Check sessionStorage for pollId
                if (!activePollId) {
                    try {
                        activePollId = sessionStorage.getItem('veritas_active_poll_id');
                    } catch (e) { /* Storage may be unavailable */ }
                }

                if (!activePollId) {
                    console.error('[LockManager] CRITICAL: No pollId available for violation report!');
                    return;
                }

                // Update Firebase immediately for instant teacher feedback
                if (typeof reportFirebaseViolation === 'function') {
                    reportFirebaseViolation(reason, activePollId);
                }

                // CRITICAL FIX: Get fallback email for robust student identification
                // This ensures violations are attributed correctly even if SESSION_TOKEN is lost
                var fallbackEmail = window.STUDENT_EMAIL || '';
                if (!fallbackEmail) {
                    try {
                        fallbackEmail = sessionStorage.getItem('veritas_student_email') || '';
                    } catch (e) { /* Storage may be unavailable */ }
                }

                // No longer calling GAS reportStudentViolation as Firebase RTDB write (above)
                // is the new authoritative source and triggers teacher visibility.
                console.log('[LockManager] Violation reported via Firebase path');
            },
            unlock: function () {
                console.log('[LockManager] UNLOCKING');
                try {
                    sessionStorage.removeItem('veritas_lock_active');
                    sessionStorage.removeItem('lock_reason');
                } catch (e) { }
                hideLockEnforcementUI();
            },
            renderLockScreen: function (reason) {
                // Use the new Hybrid UI - pass reason to showLockEnforcementUI
                showLockEnforcementUI(reason);
            }
        };

        // =============================================================================
        // ZERO TOLERANCE PROCTORING - Helper Functions
        // =============================================================================

        /**
         * Determines if proctoring should be enabled for the session
         * Returns true if sessionType === 'SECURE_ASSESSMENT' OR metadata.liveProctoring === true
         * @param {Object} metadata - Session metadata containing sessionType and liveProctoring flag
         * @returns {boolean} True if proctoring should be enabled
         */
        function shouldEnableProctoring(metadata) {
            if (!metadata) return false;
            // Check for secure assessment
            var sessionType = (metadata.sessionType || '').toString().toUpperCase();
            if (sessionType === 'SECURE_ASSESSMENT' || sessionType === 'SECURE') {
                return true;
            }
            // Check for live proctoring enabled on Live Poll
            if (metadata.liveProctoring === true) {
                return true;
            }
            return false;
        }

        /**
         * AGGRESSIVE LOCKING - Zero Tolerance Implementation
         * Immediately locks the session with no grace period, no warnings.
         * - Hides question UI
         * - Shows red "LOCKED" overlay
         * - Persists lock to sessionStorage to prevent refresh bypass ("Poison Pill")
         * - Sends priority violation report to server
         * @param {string} reason - The violation reason (e.g., 'exit-fullscreen', 'tab-blur')
         */
        function lockSession(reason) {
            console.log('[Proctor] LOCK SESSION triggered:', reason);

            // IMMEDIATELY block all interaction
            isInteractionBlocked = true;
            violationLogged = true;

            // POISON PILL: Persist lock state to sessionStorage to prevent refresh bypass
            // This key MUST be checked at the top of startPolling() and updateStudentView()
            // The ONLY way to clear this is when server sends unlock_granted: true
            try {
                sessionStorage.setItem('veritas_lock_active', 'true');
                sessionStorage.setItem('is_locally_locked', 'true');
                sessionStorage.setItem('lock_reason', reason || 'violation');
                sessionStorage.setItem('lock_timestamp', Date.now().toString());
            } catch (e) {
                console.warn('[Proctor] Could not persist lock to sessionStorage:', e);
            }

            // Hide question UI - prevent seeing answers during lock
            if (secureOptionsList) {
                secureOptionsList.style.visibility = 'hidden';
            }
            if (secureQuestionText) {
                secureQuestionText.style.visibility = 'hidden';
            }
            if (secureQuestionImage) {
                secureQuestionImage.style.visibility = 'hidden';
            }

            // Show lock overlay with professional messaging
            showLockEnforcementUI();

            // Send priority violation report to server
            var activePollId = (currentPollState && currentPollState.pollId) ||
                (secureLobbyContext && secureLobbyContext.pollId) ||
                (secureQuestionState && secureQuestionState.pollId);

            // CRITICAL FIX: Get fallback email for robust student identification
            var fallbackEmail = window.STUDENT_EMAIL || '';
            try { fallbackEmail = sessionStorage.getItem('veritas_student_email') || ''; } catch (e) { }
        }

        if (activePollId) {
            const reportViolation = firebase.functions().httpsCallable('reportStudentViolation');
            reportViolation({
                pollId: activePollId,
                studentEmail: fallbackEmail,
                reason: reason || 'session-locked'
            })
                .then(function (result) {
                    console.log('[Proctor] Lock violation reported to Firebase:', result.data);
                    if (result.data && result.data.success) {
                        currentLockVersion = result.data.lockVersion;
                    }
                    // Start/Ensure Firebase listener is active
                    initProctorListener(activePollId, fallbackEmail);
                })
                .catch(function (error) {
                    console.error('[Proctor] Failed to report violation to Firebase:', error);
                    initProctorListener(activePollId, fallbackEmail);
                });
        }
    }

        /**
         * Check if session was locked before (e.g., page refresh bypass attempt)
         * Called on page load to restore lock state
         * POISON PILL: Uses veritas_lock_active which can ONLY be cleared by server unlock_granted
         */
        function checkForPersistedLock() {
        try {
            // PRIMARY CHECK: veritas_lock_active is the "Poison Pill" key
            var poisonPillActive = sessionStorage.getItem('veritas_lock_active');
            var isLocked = sessionStorage.getItem('is_locally_locked');

            if (poisonPillActive === 'true' || isLocked === 'true') {
                var lockReason = sessionStorage.getItem('lock_reason') || 'previous-violation';
                console.log('[Proctor] POISON PILL ACTIVE - Restoring lock state from sessionStorage:', lockReason);
                isInteractionBlocked = true;
                violationLogged = true;
                showLockEnforcementUI();
                // Start proctor polling to wait for server unlock
                startProctorPolling();
                return true;
            }
        } catch (e) {
            console.warn('[Proctor] Could not check sessionStorage for lock:', e);
        }
        return false;
    }

    /**
     * Clear the persisted lock state (called ONLY when server sends unlock_granted: true)
     * This is the ONLY "antidote" to the Poison Pill
     */
    function clearPersistedLock() {
        try {
            console.log('[Proctor] ANTIDOTE - Clearing Poison Pill lock state');
            sessionStorage.removeItem('veritas_lock_active');
            sessionStorage.removeItem('is_locally_locked');
            sessionStorage.removeItem('lock_reason');
            sessionStorage.removeItem('lock_timestamp');
        } catch (e) {
            console.warn('[Proctor] Could not clear lock from sessionStorage:', e);
        }
    }

    /**
* POISON PILL CHECK - Uses both sessionStorage and localStorage for maximum persistence
*/
    function isPoisonPillActive() {
        try {
            return sessionStorage.getItem('veritas_lock_active') === 'true';
        } catch (e) {
            return false;
        }
    }

    /**
     * Set the persistent lock state
     */
    function setPoisonPill(active) {
        try {
            if (active) {
                sessionStorage.setItem('veritas_lock_active', 'true');
            } else {
                sessionStorage.removeItem('veritas_lock_active');
            }
        } catch (e) {
            console.error('Failed to set poison pill', e);
        }
    }

    // =============================================================================
    // STORE-AND-FORWARD DATA LAYER - AnswerQueue
    // =============================================================================

    /**
     * AnswerQueue - Guarantees exam integrity by storing answers locally before sync
     * Uses localStorage for persistence across network failures
     * Implements optimistic UI with background sync
     */
    var AnswerQueue = (function () {
        var QUEUE_PREFIX = 'veritas_queue_';
        var SYNC_INTERVAL = 2000; // 2 seconds
        var syncIntervalId = null;
        var isSyncing = false;

        /**
         * Get the localStorage key for the current session
         */
        function getQueueKey(sessionId) {
            return QUEUE_PREFIX + (sessionId || 'default');
        }

        /**
         * Read the queue from localStorage
         */
        function readQueue(sessionId) {
            try {
                var key = getQueueKey(sessionId);
                var raw = localStorage.getItem(key);
                if (raw) {
                    return JSON.parse(raw);
                }
            } catch (e) {
                console.error('[AnswerQueue] Failed to read queue:', e);
            }
            return [];
        }

        /**
         * Write the queue to localStorage
         */
        function writeQueue(sessionId, queue) {
            try {
                var key = getQueueKey(sessionId);
                localStorage.setItem(key, JSON.stringify(queue));
            } catch (e) {
                console.error('[AnswerQueue] Failed to write queue:', e);
            }
        }

        /**
         * Push an answer to the queue
         * @param {Object} payload - Answer payload (pollId, sessionId, questionIndex, answer, confidenceLevel)
         */
        function push(payload) {
            if (!payload || !payload.sessionId) {
                console.warn('[AnswerQueue] Cannot push without sessionId');
                return;
            }
            var queue = readQueue(payload.sessionId);
            // Add metadata for tracking
            payload.queuedAt = Date.now();
            payload.syncAttempts = 0;
            queue.push(payload);
            writeQueue(payload.sessionId, queue);
            console.log('[AnswerQueue] Answer queued:', payload.actualQuestionIndex);
        }

        /**
         * Get pending items count
         */
        function getPendingCount(sessionId) {
            return readQueue(sessionId).length;
        }

        /**
         * Process and sync queued answers to server
         * Called periodically by sync loop
         */
        function syncToServer(sessionId, onSuccess, onError) {
            if (isSyncing) {
                console.log('[AnswerQueue] Sync already in progress, skipping');
                return;
            }

            var queue = readQueue(sessionId);
            if (queue.length === 0) {
                return;
            }

            isSyncing = true;
            var item = queue[0]; // Process first item (FIFO)
            item.syncAttempts = (item.syncAttempts || 0) + 1;

            console.log('[AnswerQueue] Syncing answer:', item.actualQuestionIndex, 'attempt:', item.syncAttempts);

            // FIXED: Write directly to Firebase
            var email = window.STUDENT_EMAIL || sessionStorage.getItem('veritas_student_email');
            var emailKey = email ? email.replace(/[.$#[\]]/g, '_') : 'unknown';

            firebase.database().ref('answers/' + item.pollId + '/' + emailKey).set({
                answer: item.answer,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                questionIndex: item.actualQuestionIndex,
                confidence: item.confidenceLevel,
                pollId: item.pollId,
                sessionId: item.sessionId
            }).then(function () {
                if (onSuccess) onSuccess({ success: true }, item);
            }).catch(function (err) {
                if (onError) onError(err, item);
            });
        }

        /**
         * Start the background sync loop
         */
        function startSyncLoop(sessionId, onSuccess, onError) {
            if (syncIntervalId) {
                console.log('[AnswerQueue] Sync loop already running');
                return;
            }
            console.log('[AnswerQueue] Starting sync loop for session:', sessionId);
            syncIntervalId = setInterval(function () {
                syncToServer(sessionId, onSuccess, onError);
            }, SYNC_INTERVAL);
        }

        /**
         * Stop the sync loop
         */
        function stopSyncLoop() {
            if (syncIntervalId) {
                clearInterval(syncIntervalId);
                syncIntervalId = null;
                console.log('[AnswerQueue] Sync loop stopped');
            }
        }

        /**
         * Clear the queue for a session (e.g., when session ends)
         */
        function clear(sessionId) {
            try {
                var key = getQueueKey(sessionId);
                localStorage.removeItem(key);
                console.log('[AnswerQueue] Queue cleared for session:', sessionId);
            } catch (e) {
                console.error('[AnswerQueue] Failed to clear queue:', e);
            }
        }

        // Public API
        return {
            push: push,
            getPendingCount: getPendingCount,
            syncToServer: syncToServer,
            startSyncLoop: startSyncLoop,
            stopSyncLoop: stopSyncLoop,
            clear: clear,
            readQueue: readQueue
        };
    })();

    function getModeName() {
        return secureSessionActive ? 'Assessment' : 'Poll';
    }

    function getModeNameLowerCase() {
        return secureSessionActive ? 'assessment' : 'poll';
    }

    function getFullModeName() {
        return secureSessionActive ? 'Secure Assessment' : 'Live Poll';
    }

    function setSecureChromeState(isActive) {
        if (studentModeLabel) {
            studentModeLabel.textContent = isActive ? 'Secure Assessment' : 'Live Poll';
        }
        if (secureTopbarTimer) {
            secureTopbarTimer.classList.toggle('hidden', !isActive);
            // Defensive: Ensure timer is visible and has initial content
            if (isActive && secureCountdownEl) {
                secureCountdownEl.textContent = lastTimerDisplay || '00:00';
            }
        }
    }

    function formatTime(seconds) {
        var minutes = Math.floor(seconds / 60);
        var remainingSeconds = seconds % 60;
        return ('0' + minutes).slice(-2) + ':' + ('0' + remainingSeconds).slice(-2);
    }

    function updateQuestionProgress(currentIndex, totalQuestions) {
        if (!questionProgressEl) return;
        var parsedIndex = typeof currentIndex === 'number' ? currentIndex : parseInt(currentIndex, 10);
        var parsedTotal = typeof totalQuestions === 'number' ? totalQuestions : parseInt(totalQuestions, 10);

        // Fix: Handle '?' and ensure 1-based indexing
        var safeIndex = isNaN(parsedIndex) ? 0 : Math.max(0, parsedIndex);
        var safeTotal = isNaN(parsedTotal) || parsedTotal <= 0 ? '?' : Math.max(1, parsedTotal);

        questionProgressEl.textContent = 'QUESTION ' + (safeIndex + 1) + ' OF ' + safeTotal;

        // Ensure visibility
        questionProgressEl.classList.remove('hidden');
    }

    function deriveSecureQuestionKey(state) {
        if (!state || !state.question) {
            return null;
        }
        if (state.question.id) {
            return state.question.id;
        }
        if (state.question.questionId) {
            return state.question.questionId;
        }
        if (typeof state.actualQuestionIndex === 'number') {
            return (state.pollId || 'poll') + ':' + state.actualQuestionIndex;
        }
        return (state.pollId || 'poll') + ':' + (state.progressIndex || 0);
    }

    function toggleSecureLayout(active) {
        if (!bodyEl) return;
        bodyEl.classList.toggle('secure-mode-active', !!active);
    }

    function hideExitControls() {
        if (!secureExitControls) return;
        secureExitControls.classList.add('hidden');
    }

    function showExitControls(label, description) {
        if (!secureExitControls) return;
        secureExitControls.classList.remove('hidden');
        if (secureExitLabel) {
            secureExitLabel.textContent = label || 'Exit Session';
        }
        if (secureExitDescription) {
            secureExitDescription.textContent = description || 'Exit fullscreen and close this tab when you are finished.';
        }
    }

    function setSecureConnectionIndicatorVisible(visible) {
        if (!secureConnectionIndicator) return;
        if (visible) {
            secureConnectionIndicator.classList.remove('hidden');
        } else {
            secureConnectionIndicator.classList.add('hidden');
        }
    }

    function syncSecureOptionSelection() {
        if (!secureOptionsList) return;
        var buttons = secureOptionsList.querySelectorAll('button.secure-answer-option');
        buttons.forEach(function (btn) {
            var btnIndex = parseInt(btn.dataset.optionIndex, 10);
            var selected = btnIndex === secureSelectedOptionIndex;
            btn.classList.toggle('answer-option-selected', selected);
            btn.setAttribute('aria-pressed', selected ? 'true' : 'false');
        });
    }

    function showIndividualTimedView(state) {
        // FIX TASK B: LOCK GUARD - If locked, do not show question view
        // This prevents lock bypass via view updates or server state changes
        if (LockManager.isLocked()) {
            console.log('[Proctor] showIndividualTimedView BLOCKED - Lock active');
            LockManager.renderLockScreen(sessionStorage.getItem('lock_reason'));
            return; // HALT RENDER - SECURITY BLOCK
        }

        // FIX: Force hide ALL other screens to prevent "Start Screen Leak" cheating risk
        hideSecureLobby();
        if (studentLoader) studentLoader.style.display = 'none';
        if (entryScreen) entryScreen.style.display = 'none';
        if (secureLobbyCard) secureLobbyCard.style.display = 'none';
        studentContainer.style.display = 'block';
        questionContainer.style.display = 'none';
        statusContainer.style.display = 'none';
        if (preLiveCard) preLiveCard.style.display = 'none';
        if (secureFocusContainer) secureFocusContainer.style.display = 'block';

        // FIX: SCROLL LOCK - Prevent scrolling to any leaked content
        document.body.style.overflow = 'hidden';

        toggleSecureLayout(true);
        if (!secureSessionActive) {
            secureSessionActive = true;
            secureSessionHeartbeat.start(true);
        }
        setSecureChromeState(true);

        // Sync calculator visibility based on server state
        syncCalculatorVisibility(state.calculatorEnabled);

        // FIX: Explicitly show timer container - defensive check
        if (secureTopbarTimer) {
            secureTopbarTimer.classList.remove('hidden');
        }

        hideSecureOverlay();
        setSecureConnectionIndicatorVisible(true);
        attachProctorVisibilityListeners();
        secureQuestionState = state;

        // CRITICAL: Persist pollId for violation reporting (secure question path)
        if (state && state.pollId) {
            window.currentPollId = state.pollId;
            try {
                sessionStorage.setItem('veritas_active_poll_id', state.pollId);
            } catch (e) { /* Storage may be unavailable */ }
        }

        if (entryScreen) entryScreen.style.display = 'none';
        if (secureLobbyCard) secureLobbyCard.style.display = 'none';
        var nextQuestionKey = deriveSecureQuestionKey(state);
        var isNewQuestion = secureCurrentQuestionKey !== nextQuestionKey;
        secureCurrentQuestionKey = nextQuestionKey;
        if (isNewQuestion) {
            secureSelectedOptionIndex = null;
            securePendingAnswerText = null;
            secureMetacognitionEnabled = false;
            hideSecureConfidencePrompt();
            ActivityMonitor.getInstance().setQuestionStart(Date.now());
        }
        secureSubmitting = false;
        secureTimeExpired = false;
        disableSecureOptions(false);

        // FIX: More robust question progress with debug logging
        if (questionProgressEl) {
            var progressIdx = typeof state.progressIndex === 'number'
                ? state.progressIndex
                : (typeof state.currentQuestionIndex === 'number' ? state.currentQuestionIndex : 0);
            var totalCount = typeof state.totalQuestions === 'number'
                ? state.totalQuestions
                : (state.question && state.question.options ? state.question.options.length : 1);
            console.log('[Secure] Question progress:', { progressIdx: progressIdx, totalCount: totalCount, state: state });
            questionProgressEl.textContent = 'QUESTION ' + (progressIdx + 1) + ' OF ' + totalCount;
        } else {
            console.warn('[Secure] questionProgressEl not found');
        }

        renderSecureQuestion(state);
        startSecureCountdown(state.timeRemainingSeconds || 0);
        updateSecureConnectionIndicators(state);
    }

    function renderSecureQuestion(state) {
        if (!state) return;

        // FIX TASK B: LOCK GUARD - If locked, do not render question content
        // This prevents lock bypass via question navigation or view refresh
        if (LockManager.isLocked()) {
            console.log('[Proctor] renderSecureQuestion BLOCKED - Lock active');
            LockManager.renderLockScreen(sessionStorage.getItem('lock_reason'));
            return; // HALT RENDER - SECURITY BLOCK
        }

        // Capture metacognition setting for this question
        secureMetacognitionEnabled = !!(state.question && state.question.metacognitionEnabled);
        var progressValue = typeof state.progressIndex === 'number'
            ? state.progressIndex
            : (typeof state.currentQuestionIndex === 'number' ? state.currentQuestionIndex : 0);
        var totalValue = typeof state.totalQuestions === 'number' ? state.totalQuestions : (state.question && state.question.options ? state.question.options.length : 0);
        if (secureProgressLabel) {
            secureProgressLabel.textContent = 'Question ' + (progressValue + 1) + ' of ' + totalValue;
        }
        updateQuestionProgress(progressValue, totalValue);
        if (secureQuestionText) {
            secureQuestionText.textContent = state.question.questionText || '';
        }
        if (secureQuestionSubline) {
            secureQuestionSubline.classList.add('hidden');
            secureQuestionSubline.textContent = '';
        }
        if (secureQuestionImage) {
            if (state.question.questionImageURL) {
                secureQuestionImage.src = state.question.questionImageURL;
                secureQuestionImage.style.display = 'block';
            } else {
                secureQuestionImage.style.display = 'none';
            }
        }
        var secureHasImage = !!state.question.questionImageURL;
        if (secureQuestionLayout) {
            secureQuestionLayout.classList.toggle('no-image', !secureHasImage);
        }
        if (secureQuestionVisual) {
            secureQuestionVisual.style.display = secureHasImage ? 'flex' : 'none';
        }
        if (secureOptionsList) {
            secureOptionsList.innerHTML = '';
            var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            var options = Array.isArray(state.question.options) ? state.question.options : [];
            options.forEach(function (option, index) {
                secureOptionsList.appendChild(buildSecureOption(option, index, letters.charAt(index) || '#'));
            });
            syncSecureOptionSelection();
        }
        updateSecureSubmitState();
    }

    function buildSecureOption(option, index, letter) {
        var li = document.createElement('li');
        var button = document.createElement('button');
        button.type = 'button';
        button.className = 'answer-option secure-answer-option relative w-full text-left';
        button.dataset.optionIndex = index;
        button.setAttribute('aria-pressed', 'false');
        var displayText = (option && option.text) ? option.text.toString() : '';
        var cleanText = displayText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        var content = '';
        if (option && option.imageURL) {
            content += '<img src="' + escapeHtml(option.imageURL) + '" alt="Answer ' + letter + '" class="option-image" referrerpolicy="no-referrer">';
        }
        content += '<div class="option-leading">';
        content += '<div class="letter-badge" aria-hidden="true">' + letter + '</div>';
        content += '<div class="option-body">';
        content += '<div class="option-text-wrapper">';
        if (cleanText) {
            content += '<p class="option-text">' + escapeHtml(cleanText).replace(/\n/g, '<br>') + '</p>';
        }
        content += '<span class="result-ribbon"></span>';
        content += '<span class="sr-only secure-selection-announcement"></span>';
        content += '</div>';
        content += '<span class="percentage-bubble"></span>';
        content += '</div>';
        content += '</div>';
        content += '<span class="result-indicator" aria-hidden="true"></span>';
        button.innerHTML = content;
        button.addEventListener('click', function (event) {
            if (event && event.target && event.target.closest('.option-image')) {
                return;
            }
            handleSecureOptionSelect(index);
        });
        li.appendChild(button);
        return li;
    }

    function handleSecureOptionSelect(index) {
        if (!secureOptionsList) return;
        secureSelectedOptionIndex = index;
        syncSecureOptionSelection();
        updateSecureSubmitState();
    }

    function updateSecureSubmitState() {
        if (!secureSubmitBtn) return;
        var hasState = !!secureQuestionState;
        var disabled = !hasState || secureSubmitting || secureTimeExpired;
        secureSubmitBtn.disabled = disabled;
        secureSubmitBtn.classList.toggle('opacity-60', disabled);
        if (secureSubmitLabel && hasState && !secureSubmitting) {
            var onLastQuestion = secureQuestionState.progressIndex >= secureQuestionState.totalQuestions - 1;
            secureSubmitLabel.textContent = onLastQuestion ? 'Submit Exam' : 'Submit & Next';
        }
        if (secureSubmitHint) {
            if (!hasState) {
                secureSubmitHint.textContent = '';
            } else if (typeof secureSelectedOptionIndex === 'number') {
                var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                var letter = letters.charAt(secureSelectedOptionIndex) || '#';
                secureSubmitHint.textContent = 'Selected ' + letter + '. Submit when ready.';
            } else {
                secureSubmitHint.textContent = 'No answer selected  submitting will record this as blank.';
            }
        }
    }

    function setSecureSubmitLoading(isLoading) {
        secureSubmitting = isLoading;
        if (!secureSubmitBtn) return;
        secureSubmitBtn.disabled = isLoading;
        secureSubmitBtn.classList.toggle('opacity-60', isLoading);
        if (secureSubmitLabel && isLoading) {
            secureSubmitLabel.textContent = 'Saving...';
        }
        if (!isLoading) {
            updateSecureSubmitState();
        }
    }

    function disableSecureOptions(disabled) {
        if (!secureOptionsList) return;
        secureOptionsList.querySelectorAll('button.secure-answer-option').forEach(function (btn) {
            btn.disabled = disabled;
            btn.classList.toggle('answer-option-disabled', disabled);
        });
    }

    function submitIndividualAnswer(state, answerText, isAutoSubmit) {
        if (!state || secureSubmitting) return;

        // Check if metacognition is enabled for this question
        // Auto-submits (timeout, forced submission) bypass the confidence prompt
        if (secureMetacognitionEnabled && !isAutoSubmit) {
            console.log('Metacognition enabled - showing confidence prompt');
            showSecureConfidencePrompt(answerText);
            return; // Don't submit yet, wait for confidence selection
        }

        // No metacognition or auto-submit, submit directly with null confidence
        submitIndividualAnswerWithConfidence(state, answerText, null);
    }

    function submitIndividualAnswerWithConfidence(state, answerText, confidenceLevel, retryCount) {
        retryCount = retryCount || 0;
        var maxRetries = 3;

        if (!state || secureSubmitting) return;
        setSecureSubmitLoading(true);
        disableSecureOptions(true);
        var answerDetails = {
            pollId: state.pollId,
            sessionId: state.sessionId,
            actualQuestionIndex: state.actualQuestionIndex,
            answer: answerText || '',
            confidenceLevel: confidenceLevel
        };

        var telemetry = ActivityMonitor.getInstance().getTelemetry();

        // FAST PATH: Write to Firebase first (Optimistic UI)
        submitAnswerToFirebase(
            answerDetails.pollId,
            answerDetails.actualQuestionIndex,
            answerDetails.answer,
            answerDetails.confidenceLevel,
            null // let function derive email
        ).then(function (fbResult) {
            if (fbResult && fbResult.success) {
                console.log('Firebase write success, proceeding with optimistic UI update');

                // Optimistic Success: Clear local state and show loading next
                try { localStorage.removeItem('secure_pending_answer'); } catch (e) { }

                setSecureSubmitLoading(false);
                disableSecureOptions(false);
                hideSecureConfidencePrompt();

                secureSelectedOptionIndex = null;
                secureQuestionState = null;
                secureCurrentQuestionKey = null;

                if (secureQuestionText) {
                    secureQuestionText.innerHTML = '<div style="display: flex; align-items: center; gap: 12px; padding: 20px 0;"><div style="width: 24px; height: 24px; border: 3px solid rgba(18, 56, 93, 0.2); border-top-color: #12385d; border-radius: 50%; animation: veritas-spin 0.7s linear infinite;"></div><span style="color: #4b5563; font-size: 1.1rem;">Answer Saved. Loading next...</span></div>';
                }
                if (secureQuestionImage) secureQuestionImage.style.display = 'none';
                if (secureOptionsList) secureOptionsList.innerHTML = '';

                // Firebase write was successful, the Cloud Function processes it.
                // No need for a redundant google.script.run sync.
                console.log('[Firebase] Submission finalized. Polling for next state.');
                setTimeout(function () { pollForIndividualSessionState(); }, 50);
            } else {
                console.warn('[Firebase] Write failed. Saving to local backup for manual recovery.');
                try {
                    localStorage.setItem('secure_pending_answer', JSON.stringify(answerDetails));
                } catch (e) {
                    console.error('Failed to backup answer', e);
                }
                setSecureSubmitLoading(false);
                disableSecureOptions(false);
                hideSecureConfidencePrompt();
                handleError('Submission failed. Your answer is backed up locally. Please check your connection and try again.');
            }
        });
    }



    function stopSecureCountdown() {
        secureCountdownController.stop();
    }

    function applyTimerVisibility() {
        if (!secureCountdownEl || !secureTopbarTimer) return;
        secureCountdownEl.textContent = timerHidden ? ':' : lastTimerDisplay;
        secureTopbarTimer.classList.toggle('timer-hidden', timerHidden);
        if (timerVisibilityToggle) {
            timerVisibilityToggle.setAttribute('aria-pressed', timerHidden ? 'true' : 'false');
            timerVisibilityToggle.setAttribute('aria-label', timerHidden ? 'Show timer' : 'Hide timer');
            var icon = timerVisibilityToggle.querySelector('.material-symbols-outlined');
            if (icon) {
                icon.textContent = timerHidden ? 'visibility_off' : 'visibility';
            }
        }
    }

    function updateSecureTimerDisplay(seconds) {
        if (!secureCountdownEl || !secureTopbarTimer) return;
        var safeSeconds = Math.max(0, seconds);
        lastTimerDisplay = formatTime(safeSeconds);
        secureTopbarTimer.classList.remove('alert-warning', 'alert-danger');
        var ratio = secureCountdownTotal > 0 ? Math.max(0, Math.min(1, safeSeconds / secureCountdownTotal)) : 1;
        if (ratio <= 0.1) {
            secureTopbarTimer.classList.add('alert-danger');
        } else if (ratio <= 0.25) {
            secureTopbarTimer.classList.add('alert-warning');
        }
        applyTimerVisibility();
    }

    function startSecureCountdown(timeRemainingSeconds) {
        var remaining = Math.max(0, Math.floor(timeRemainingSeconds || 0));
        secureCountdownTotal = remaining || secureCountdownTotal;
        lastTimerDisplay = formatTime(remaining);
        applyTimerVisibility();
        secureCountdownController.start(remaining);
    }

    function handleSecureTimeExpiry() {
        if (secureTimeExpired) return;
        secureTimeExpired = true;
        showSecureOverlay('TIME_UP', "Time's up!", 'Hold tight while we finalize your work.');
        autoSubmitSecureAnswer(false);
        scheduleSecureWindowClose(4000);
    }

    function showSecureConfidencePrompt(answerText) {
        if (!secureConfidencePrompt) return;

        securePendingAnswerText = answerText;

        // Hide question content, show confidence prompt
        if (secureQuestionText) secureQuestionText.style.display = 'none';
        if (secureQuestionImage) secureQuestionImage.style.display = 'none';
        if (secureOptionsList) secureOptionsList.style.display = 'none';
        if (secureSubmitBtn) secureSubmitBtn.style.display = 'none';

        secureConfidencePrompt.style.display = 'block';
        secureConfidencePrompt.classList.remove('hidden');

        // Attach confidence button handlers
        var confidenceBtns = secureConfidencePrompt.querySelectorAll('.confidence-btn');
        confidenceBtns.forEach(function (btn) {
            btn.onclick = function () {
                var confidenceLevel = btn.getAttribute('data-confidence');
                handleSecureConfidenceSelection(confidenceLevel);
            };
        });
    }

    function hideSecureConfidencePrompt() {
        if (!secureConfidencePrompt) return;
        secureConfidencePrompt.style.display = 'none';
        secureConfidencePrompt.classList.add('hidden');

        // Restore question display
        if (secureQuestionText) secureQuestionText.style.display = 'block';
        if (secureOptionsList) secureOptionsList.style.display = 'block';
        if (secureSubmitBtn) secureSubmitBtn.style.display = 'block';
    }

    function handleSecureConfidenceSelection(confidenceLevel) {
        // Allow empty strings (blank answers), only reject null/undefined
        if (securePendingAnswerText == null || !secureQuestionState) return;

        hideSecureConfidencePrompt();

        // Submit answer with confidence
        submitIndividualAnswerWithConfidence(
            secureQuestionState,
            securePendingAnswerText,
            confidenceLevel
        );

        // Clear pending state
        securePendingAnswerText = null;
    }

    function autoSubmitSecureAnswer(forceBlank) {
        if (!secureQuestionState || secureSubmitting) return;
        var answerText = '';
        if (!forceBlank && typeof secureSelectedOptionIndex === 'number') {
            var option = (secureQuestionState.question.options || [])[secureSelectedOptionIndex];
            if (option && typeof option.text === 'string') {
                answerText = option.text;
            }
        }
        // Pass true for isAutoSubmit to bypass confidence prompt on timeout
        submitIndividualAnswer(secureQuestionState, answerText, true);
    }

    function attemptSecureWindowClose() {
        try {
            if (document && document.fullscreenElement && document.exitFullscreen) {
                document.exitFullscreen().catch(function (err) {
                    console.warn('Error exiting fullscreen:', err);
                });
            }
        } catch (err) {
            console.warn('Unable to exit fullscreen', err);
        }
        try {
            if (google && google.script && google.script.host && typeof google.script.host.close === 'function') {
                google.script.host.close();
                return;
            }
        } catch (err) {
            console.warn('Unable to close Apps Script host', err);
        }
        if (typeof window !== 'undefined' && typeof window.close === 'function') {
            window.close();
        }
    }

    function clearSecureCloseTimer() {
        if (secureCloseTimer) {
            clearTimeout(secureCloseTimer);
            secureCloseTimer = null;
        }
    }

    function scheduleSecureWindowClose(delayMs) {
        if (secureCloseTimer) return;
        var timeout = Math.max(500, Number(delayMs) || 2500);
        secureCloseTimer = setTimeout(function () {
            secureCloseTimer = null;
            attemptSecureWindowClose();
        }, timeout);
    }

    function exitSecureSessionNow() {
        clearSecureCloseTimer();
        attemptSecureWindowClose();
    }

    function finalizeSecureSession(statusType, message, subtext) {
        stopSecureCountdown();
        setSecureConnectionIndicatorVisible(false);
        if (secureSessionActive) {
            secureSessionHeartbeat.stop();
            secureSessionActive = false;
        }
        setSecureChromeState(false);
        secureQuestionState = null;
        secureCurrentQuestionKey = null;
        secureSelectedOptionIndex = null;
        secureSubmitting = false;
        // Hide calculator when session ends
        if (typeof hideCalculatorOnSessionEnd === 'function') {
            hideCalculatorOnSessionEnd();
        }
        showSecureOverlay(statusType, message, subtext);
        scheduleSecureWindowClose(2500);
    }

    function showSecureOverlay(type, message, subtext) {
        var icon = 'lock';
        var iconClass = 'text-red-300';
        var messageClass = 'text-white text-2xl font-semibold';
        var subClass = 'text-white/80 text-base mt-4';
        var showExitAction = type === 'COMPLETED' || type === 'ENDED';
        var exitLabel = type === 'ENDED' ? 'Exit Session' : 'Exit Secure Session';
        var exitDescription = 'Use the button below to leave fullscreen and close the secure window when dismissed.';
        if (type === 'COMPLETED') {
            icon = 'task_alt';
            iconClass = 'text-green-300';
            messageClass = 'text-green-200 text-2xl font-semibold';
        } else if (type === 'TIME_UP') {
            icon = 'hourglass_bottom';
            showExitAction = false;
        } else if (type === 'ENDED') {
            icon = 'info';
        } else if (type === 'LOCKED') {
            // FIX TASK C: High-contrast styling for lock overlay (no pale pink-on-white)
            icon = 'lock';
            iconClass = 'text-red-600';
            messageClass = 'text-gray-900 text-2xl font-bold';
            subClass = 'text-gray-800 text-base mt-4 whitespace-pre-line';
            showExitAction = false;
        }
        showStatusPanel({
            icon: icon,
            iconClass: iconClass,
            message: message || '',
            messageClass: messageClass,
            subtext: subtext || '',
            subClass: subClass,
            showExitAction: showExitAction,
            exitActionLabel: exitLabel,
            exitActionDescription: exitDescription,
            showResume: false,
            lockScroll: true
        });
    }

    function hideSecureOverlay() {
        if (document && document.body) {
            document.body.classList.remove('secure-overlay-active');
        }
        if (statusContainer && !isInteractionBlocked) {
            statusContainer.style.display = 'none';
        }
        if (statusSubMessage) {
            statusSubMessage.style.display = 'none';
            statusSubMessage.textContent = '';
        }
    }

    function showSecureLockout(message, subtext) {
        stopSecureCountdown();
        setSecureConnectionIndicatorVisible(true);
        if (secureFocusContainer) {
            secureFocusContainer.style.display = 'block';
        }
        disableSecureOptions(true);
        showSecureOverlay('LOCKED', message || 'Assessment Paused', subtext || 'Fullscreen exit detected. Your teacher will re-admit you shortly.');
        // Hide calculator when locked
        if (typeof hideCalculatorOnSessionEnd === 'function') {
            hideCalculatorOnSessionEnd();
        }
    }

    function updateSecureConnectionIndicators(state) {
        if (!state || !secureConnectionDot) return;
        var health = (state.connectionHealth || '').toUpperCase();
        var dotClasses = ['bg-emerald-400', 'bg-amber-400', 'bg-red-500'];
        dotClasses.forEach(function (cls) { secureConnectionDot.classList.remove(cls); });
        var label = 'Synced';
        var warningText = '';
        if (health === 'RED') {
            secureConnectionDot.classList.add('bg-red-500');
            label = 'Connection issue';
            warningText = 'We are reconnecting and saving your work...';
        } else if (health === 'YELLOW') {
            secureConnectionDot.classList.add('bg-amber-400');
            label = 'Reconnecting';
            warningText = 'Syncing your progress...';
        } else {
            secureConnectionDot.classList.add('bg-emerald-400');
            label = 'Synced';
        }
        var lagSeconds = state.heartbeatLagMs ? Math.max(0, Math.round(state.heartbeatLagMs / 1000)) : 0;
        if (secureConnectionStatus) {
            var srLabel = label;
            if (lagSeconds > 0) {
                srLabel += '  ' + lagSeconds + ' second lag';
            }
            secureConnectionStatus.textContent = srLabel;
        }
        if (secureConnectionWarning) {
            if (warningText) {
                secureConnectionWarning.textContent = warningText;
                secureConnectionWarning.classList.remove('hidden');
            } else {
                secureConnectionWarning.textContent = '';
                secureConnectionWarning.classList.add('hidden');
            }
        }
    }

    function pollForIndividualSessionState() {
        // POISON PILL CHECK: If lock is active, immediately show lock UI and return
        if (isPoisonPillActive()) {
            console.log('[Proctor] POISON PILL ACTIVE in pollForIndividualSessionState - blocking');
            isInteractionBlocked = true;
            showLockEnforcementUI();
            return;
        }

        if (securePollInFlight) return;
        securePollInFlight = true;
        var telemetry = ActivityMonitor.getInstance().getTelemetry();
        // FIXED: Fetch state from Firebase directly
        var email = window.STUDENT_EMAIL || sessionStorage.getItem('veritas_student_email');
        var emailKey = email ? email.replace(/[.$#[\]]/g, '_') : 'unknown';
        var pollId = activePollId; // Assuming activePollId is available in scope

        Promise.all([
            firebase.database().ref('sessions/' + pollId + '/live_session').once('value'),
            firebase.database().ref('sessions/' + pollId + '/students/' + emailKey).once('value')
        ]).then(function (snaps) {
            securePollInFlight = false;
            if (studentLoader) studentLoader.style.display = 'none';

            var sessionSnap = snaps[0];
            var studentSnap = snaps[1];

            var sessionData = sessionSnap.val() || { status: 'CLOSED' };
            var studentData = studentSnap.val() || { status: 'ACTIVE' };

            // Map to legacy state object
            var state = {
                status: studentData.status, // ACTIVE, LOCKED, etc.
                sessionStatus: sessionData.status,
                locked: studentData.status === 'LOCKED',
                message: studentData.lastViolationReason || '',
                lockReason: studentData.lastViolationReason || '',
                completed: studentData.status === 'FINISHED',
                question: sessionData // Simplified map
            };

            // Dispatch to UI handlers
            if (state.sessionStatus === 'PRE_LIVE' || !state.sessionStatus) {
                showSecureLobby({ status: 'LOBBY', pollName: 'Wait for teacher...' });
                return;
            }
            if (state.status === 'LOBBY') {
                showSecureLobby(state);
                return;
            }
            hideSecureLobby();

            var lockReason = (state.lockReason || '').toString().toUpperCase();
            var lockMessage = (state.message || '').toString().toLowerCase();
            var isTerminalLock = state.locked === true || lockReason === 'FORCED_SUBMIT' || lockReason === 'TIME_EXPIRED' || lockMessage.indexOf('ended') >= 0 || lockMessage.indexOf('submitted') >= 0;

            if (state.completed || studentData.status === 'FINISHED') {
                updateSecureConnectionIndicators(state);
                finalizeSecureSession('COMPLETED', 'Assessment Submitted', 'Your responses have been secured.');
            } else if (sessionData.status === 'ENDED') {
                updateSecureConnectionIndicators(state);
                finalizeSecureSession('ENDED', 'Session Concluded', 'The session has ended.');
            } else if (isTerminalLock) {
                finalizeSecureSession('ENDED', state.message || 'Assessment Finalized', 'Your responses have been secured.');
            } else if (state.status === 'LOCKED') {
                if (secureFocusContainer) secureFocusContainer.style.display = 'block';
                showSecureLockout(state.message || 'Locked', 'Teacher intervention required.');
            } else if (state.status === 'ACTIVE' || !state.status) {
                // Pass necessary data for view
                state.question = sessionData; // Pass session metadata as question context
                state.timeLimitMinutes = sessionData.metadata ? sessionData.metadata.timeLimitMinutes : 60;
                showIndividualTimedView(state);
            }
        }).catch(function (error) {
            securePollInFlight = false;
            handleError(error);
        });

    }

    if (secureSubmitBtn) {
        secureSubmitBtn.addEventListener('click', function () {
            if (!secureQuestionState || secureSubmitting) return;
            var answerText = '';
            if (typeof secureSelectedOptionIndex === 'number') {
                var option = (secureQuestionState.question.options || [])[secureSelectedOptionIndex];
                if (option && typeof option.text === 'string') {
                    answerText = option.text;
                }
            }
            submitIndividualAnswer(secureQuestionState, answerText);
        });
    }

    // Add click handler to secure assessment question image for zoom
    if (secureQuestionImage) {
        secureQuestionImage.addEventListener('click', function (e) {
            e.stopPropagation();
            e.preventDefault();
            if (window.expandImage) {
                window.expandImage(this);
            }
        });
    }

    console.log('Student poll script initializing...');

    // Check for pending answer backup on initialization
    try {
        var backup = localStorage.getItem('secure_pending_answer');
        if (backup) {
            var answerDetails = JSON.parse(backup);
            // Use a slight delay to ensure UI is ready
            setTimeout(function () {
                if (confirm('Veritas found an unsaved answer from a previous session. Would you like to retry submitting it?')) {
                    // Create a dummy state to pass to submit
                    var dummyState = {
                        pollId: answerDetails.pollId,
                        sessionId: answerDetails.sessionId,
                        actualQuestionIndex: answerDetails.actualQuestionIndex,
                        question: {} // Dummy question object
                    };

                    // Manually trigger submission with recovered data
                    submitIndividualAnswerWithConfidence(
                        dummyState,
                        answerDetails.answer,
                        answerDetails.confidenceLevel
                    );
                } else {
                    localStorage.removeItem('secure_pending_answer');
                }
            }, 1000);
        }
    } catch (e) {
        console.error('Failed to check backup', e);
    }

    var studentLoader = document.getElementById('student-loader');
    var preLiveCard = document.getElementById('pre-live-card');
    var statusContainer = document.getElementById('status-container');
    var statusMessage = document.getElementById('status-message');
    var questionContainer = document.getElementById('question-container');
    var optionsList = document.getElementById('options-list');
    var questionTextEl = document.getElementById('question-text');
    var questionImageEl = document.getElementById('question-image');
    var questionSublineEl = document.getElementById('question-subline');
    var noResponsesMessageEl = document.getElementById('no-responses-message');
    var entryScreen = document.getElementById('entry-screen');
    var startSessionBtn = document.getElementById('start-session-btn');
    var studentContainer = document.getElementById('student-container');
    // Simple image zoom function (same approach as teacher panel)
    window.expandImage = function (imgElement) {
        var imgSrc = imgElement.src;
        var modalHtml = '<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:pointer;" onclick="this.remove()">';
        modalHtml += '<img src="' + imgSrc + '" style="max-width:90%;max-height:90%;"/>';
        modalHtml += '</div>';
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    };

    // Add click handler to question image
    if (questionImageEl) {
        questionImageEl.addEventListener('click', function (e) {
            e.stopPropagation();
            e.preventDefault();
            window.expandImage(this);
        });
    }

    // Event delegation for dynamically created option images
    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('option-image')) {
            e.stopPropagation();
            e.preventDefault();
            window.expandImage(e.target);
        }
    });
    var preLivePrimary = document.getElementById('pre-live-primary');
    var preLiveSubline = document.getElementById('pre-live-subline');
    var preLiveReconnectLine = document.getElementById('pre-live-reconnect-line');

    console.log('Start session button found:', startSessionBtn ? 'YES' : 'NO');
    console.log('Entry screen found:', entryScreen ? 'YES' : 'NO');
    var resumeControls = document.getElementById('resume-controls');
    var resumeSessionBtn = document.getElementById('resume-session-btn');
    var secureExitControls = document.getElementById('secure-exit-controls');
    var secureExitDescription = document.getElementById('secure-exit-description');
    var secureExitButton = document.getElementById('secure-exit-btn');
    var secureExitLabel = document.getElementById('secure-exit-label');
    var statusSubMessage = document.getElementById('status-submessage');
    var connectivityBanner = document.getElementById('connectivity-banner');
    var connectivityIcon = document.getElementById('connectivity-icon');
    var connectivityMessage = document.getElementById('connectivity-message');
    var connectivitySubMessage = document.getElementById('connectivity-submessage');

    var currentPollState = {};
    var lastUnlockedState = null;
    var pollTimerId = null;
    var defaultPollInterval = 1500;
    var maxPollInterval = 8000;
    var pollFailureCount = 0;
    var proctorPollInterval = null;
    var isInteractionBlocked = false;
    var isTeacherBlocked = false;
    var currentLockVersion = 0;
    var hasAnsweredCurrent = false;
    var violationLogged = false;
    var violationDebounceTimer = null;
    var fullscreenEnteredOnce = false; // Track if fullscreen has been entered to prevent false violations
    var pendingSubmission = false;
    var currentQuestionKey = null;
    var pendingAnswerText = null; // Store answer while waiting for confidence
    var currentMetacognitionEnabled = false; // Track if current question has metacognition
    var lastStateVersion = null;
    var lastSuccessfulPollAt = 0;
    var pollInFlight = false;
    var recoveringFromOutage = false;
    var connectivityHideTimer = null;
    var lastAdvisedInterval = defaultPollInterval;

    // --- PROCTORING SAFEGUARDS ---
    var secureSessionActive = false; // Must be TRUE for lock logic to engage
    var isEnteringFullscreen = false; // Grace period flag
    // -----------------------------

    var optionBaseClass = 'answer-option relative w-full text-left';
    var optionSelectedClass = optionBaseClass + ' answer-option-selected';
    var optionDisabledClass = optionBaseClass + ' answer-option-disabled';
    var SECURE_RULES_FALLBACK = [
        'Stay in fullscreen for the entire assessment',
        'No tab or app switching is allowed',
        'Mission Control monitors your progress in real time'
    ];
    var secureLobbyCard = document.getElementById('secure-lobby');
    var secureLobbyTitle = document.getElementById('secure-lobby-title');
    var secureLobbySummary = document.getElementById('secure-lobby-summary');
    var secureLobbyTime = document.getElementById('secure-lobby-time');
    var secureLobbyQuestions = document.getElementById('secure-lobby-questions');
    var secureWindowMessage = document.getElementById('secure-window-message');
    var secureAccessCodeGroup = document.getElementById('secure-access-code-group');
    var secureAccessCodeInput = document.getElementById('secure-access-code');
    var secureAccessCodeError = document.getElementById('secure-access-code-error');
    var secureBeginBtn = document.getElementById('secure-begin-btn');
    var secureBeginLabel = document.getElementById('secure-begin-label');
    var secureRulesList = document.getElementById('secure-rules-list');
    var secureLobbyContext = null;
    var secureWindowAutoReloaded = false;
    var blurListenerAttached = false;
    var liveSessionActive = false;

    function handleViolation(reason) {
        try {
            sessionStorage.setItem('veritas_lock_active', 'true');
            sessionStorage.setItem('lock_reason', reason || 'violation');
        } catch (e) { }
        LockManager.lock(reason || 'proctoring_violation');
        if (typeof reportViolationDebounced === 'function') {
            reportViolationDebounced(reason);
        }
    }

    function triggerSecurityViolation(reason) {
        handleViolation(reason);
    }

    /**
     * UNIFIED PROCTORING HANDLER
     * Handles blur, fullscreen exit, and tab switching.
     * Flow: 1. Check Calculator (Safe Harbor) -> 2. Set Lock Flag -> 3. Report Violation -> 4. Show Lock UI
     */
    function handlePotentialViolation(reason) {
        // 1. SAFE HARBOR CHECK (Critical)
        // If the student is clicking inside the TI-84 Calculator iframe,
        // the window 'blurs', but this is NOT a violation. Return immediately.
        if (document.activeElement && document.activeElement.id === 'calc-iframe') {
            return;
        }

        // 2. THE LOCK (Poison Pill)
        // Persist the lock state so a refresh won't fix it.
        sessionStorage.setItem('veritas_lock_active', 'true');

        // 3. THE REPORT
        // Send telemetry to the server (if ID exists)
        if (typeof reportViolation === 'function') {
            reportViolation(reason);
        } else if (typeof reportViolationDebounced === 'function') {
            reportViolationDebounced(reason);
        }

        // 4. SHOW LOCK UI
        showLockEnforcementUI(reason);
    }

    // ROBUST VIOLATION REPORTING WITH FAILSAFE POLL ID LOOKUP
    function reportViolation(reason) {
        // ROBUST ID CHECK: Check Global -> Data Object -> Storage
        var pid = window.currentPollId ||
            (window.pollData && window.pollData.pollId) ||
            sessionStorage.getItem('veritas_active_poll_id');

        if (!pid) {
            console.error('[Proctor] CRITICAL: Attempted to report violation but Poll ID is missing. Retrying in 1s...');
            // Retry once if ID is missing (race condition fix)
            setTimeout(function () { reportViolation(reason); }, 1000);
            return;
        }

        console.warn('[Proctor] Reporting violation:', reason, 'for Poll:', pid);

        // FIREBASE: Instant Lock (Fail-safe)
        try {
            if (typeof reportFirebaseViolation === 'function') {
                reportFirebaseViolation(reason, pid);
            }
        } catch (e) {
            console.warn('[Proctor] Firebase reporting failed:', e);
        }

        // CRITICAL FIX: Get fallback email for robust student identification
        var fallbackEmail = window.STUDENT_EMAIL || '';
        if (!fallbackEmail) {
            try { fallbackEmail = sessionStorage.getItem('veritas_student_email') || ''; } catch (e) { }
        }

        // FIX: Use the correct API with token - logStudentViolation was broken (ignored params)
        // FIXED: Use Cloud Function
        var reportStudentViolation = firebaseFunctions.httpsCallable('reportStudentViolation');
        reportStudentViolation({
            pollId: pid,
            studentEmail: fallbackEmail,
            reason: reason
        }).then(function (result) {
            console.log('[Proctor] Violation logged:', result.data);
            if (result.data && result.data.lockVersion !== undefined) {
                currentLockVersion = result.data.lockVersion;
            }
        }).catch(function (error) {
            console.error('[Proctor] Violation report failed:', error);
        });
    }

    function reportViolationDebounced(reason) {
        // FIX: Immediately block interaction to prevent submissions during debounce
        if (!isInteractionBlocked && !violationLogged && secureSessionActive) {
            console.log('[Proctor] Violation detected:', reason, '- blocking interaction immediately');
            isInteractionBlocked = true;
            showLockEnforcementUI();

            // FIREBASE: Instant Lock
            reportFirebaseViolation(reason);
        }

        if (violationDebounceTimer) {
            clearTimeout(violationDebounceTimer);
        }
        // FIX: Reduce debounce from 300ms to 100ms for faster blocking
        violationDebounceTimer = setTimeout(function () {
            if (violationLogged) {
                return;
            }

            // ROBUST POLL ID RESOLUTION: Check all sources to avoid silent failures
            var activePollId = (currentPollState && currentPollState.pollId) ||
                (secureLobbyContext && secureLobbyContext.pollId) ||
                window.currentPollId;

            // FALLBACK: Check sessionStorage if all in-memory sources failed
            if (!activePollId) {
                try {
                    activePollId = sessionStorage.getItem('veritas_active_poll_id');
                } catch (e) { /* Storage may be unavailable */ }
            }

            if (!activePollId) {
                console.error('[Proctor] CRITICAL: Cannot report violation - no poll ID found in any source');
                // Still show lock UI even without server report
                showLockEnforcementUI();
                return;
            }

            violationLogged = true;
            isInteractionBlocked = true;
            console.log('[Proctor] Reporting violation to server:', reason, 'pollId:', activePollId);

            // FIREBASE: Ensure locked state is set with pollId for teacher visibility
            reportFirebaseViolation(reason, activePollId);

            // CRITICAL FIX: Get fallback email for robust student identification
            var fallbackEmail = window.STUDENT_EMAIL || '';
            if (!fallbackEmail) {
                try { fallbackEmail = sessionStorage.getItem('veritas_student_email') || ''; } catch (e) { }
            }

            showLockEnforcementUI();
            google.script.run = null; // Removed legacy
            var reportStudentViolation = firebaseFunctions.httpsCallable('reportStudentViolation');
            reportStudentViolation({
                pollId: activePollId,
                studentEmail: fallbackEmail,
                reason: reason
            }).then(function (result) {
                var response = result.data || result;
                console.log('[Proctor] Violation reported:', response);
                if (response.success) {
                    currentLockVersion = response.lockVersion;
                    showLockEnforcementUI();
                    startProctorPolling();
                }
            }).catch(function (error) {
                console.error('[Proctor] Violation report failed:', error);
                showLockEnforcementUI();
            });
        }, 100);
    }

    function attachProctorVisibilityListeners() {
        if (blurListenerAttached) { return; }
        blurListenerAttached = true;

        // ZERO TOLERANCE: Immediate lock on window blur
        window.addEventListener('blur', function () {
            if (!secureSessionActive || isEnteringFullscreen || isInteractionBlocked || isTeacherBlocked) return;

            // NO-OP if not strictly in a "LIVE" or "SECURE" act.
            // If we are in LOBBY or PRE_LIVE, do not lock.
            if (currentPollState && (currentPollState.status === 'LOBBY' || currentPollState.status === 'PRE_LIVE' || currentPollState.sessionPhase === 'LOBBY')) return;

            // EXTRA GUARD: If Lobby is actually visible on screen, do NOT lock
            if (secureLobbyCard && secureLobbyCard.style.display !== 'none') {
                console.log('[Proctor] Blur ignored - Lobby is visible');
                return;
            }

            violationLogged = true;
            handlePotentialViolation('tab_switch');
        });

        // ZERO TOLERANCE: Immediate lock on tab visibility change
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                if (!secureSessionActive || isEnteringFullscreen || isInteractionBlocked || isTeacherBlocked) return;

                if (currentPollState && (currentPollState.status === 'LOBBY' || currentPollState.status === 'PRE_LIVE' || currentPollState.sessionPhase === 'LOBBY')) return;

                // EXTRA GUARD: If Lobby is actually visible on screen, do NOT lock
                if (secureLobbyCard && secureLobbyCard.style.display !== 'none') {
                    console.log('[Proctor] visibilitychange ignored - Lobby is visible');
                    return;
                }

                violationLogged = true;
                handlePotentialViolation('tab_hidden');
            }
        });
    }

    var VeritasModal = null;
    var veritasModalReady = new Promise(function (resolve) {
        function initializeModal() {
            VeritasModal = window.VeritasModal || createVeritasModal();
            window.VeritasModal = VeritasModal;
            resolve(VeritasModal);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeModal, { once: true });
        } else {
            initializeModal();
        }
    });

    function withVeritasModal(callback) {
        return veritasModalReady.then(function (controller) {
            return callback(controller);
        });
    }

    function veritasAlert(message, options) {
        return withVeritasModal(function (modal) {
            return modal.alert(Object.assign({ message: message }, options || {}));
        });
    }

    function veritasConfirm(message, options) {
        return withVeritasModal(function (modal) {
            return modal.confirm(Object.assign({ message: message }, options || {}));
        });
    }

    function veritasPrompt(message, options) {
        return withVeritasModal(function (modal) {
            return modal.prompt(Object.assign({ message: message }, options || {}));
        });
    }

    function describeSecureTimeLimit(minutes) {
        if (!minutes || minutes <= 0) {
            return 'Untimed';
        }
        if (minutes >= 60) {
            var hours = Math.floor(minutes / 60);
            var remainder = minutes % 60;
            if (remainder === 0) {
                return hours + (hours === 1 ? ' hour' : ' hours');
            }
            return hours + ' hr ' + remainder + ' min';
        }
        return minutes + ' min';
    }

    function describeSecureQuestionCount(count) {
        if (typeof count !== 'number' || count <= 0) {
            return '';
        }
        return count + (count === 1 ? ' Question' : ' Questions');
    }

    function renderSecureRules(rules) {
        if (!secureRulesList) return;
        secureRulesList.innerHTML = '';
        var appliedRules = Array.isArray(rules) && rules.length ? rules : SECURE_RULES_FALLBACK;
        appliedRules.forEach(function (rule) {
            var li = document.createElement('li');
            var icon = document.createElement('span');
            icon.className = 'material-symbols-outlined text-base text-veritas-navy mt-0.5';
            icon.textContent = 'shield_person';
            var text = document.createElement('span');
            text.textContent = rule;
            li.appendChild(icon);
            li.appendChild(text);
            secureRulesList.appendChild(li);
        });
    }

    function setSecureAccessError(message) {
        if (!secureAccessCodeError) return;
        if (message) {
            secureAccessCodeError.textContent = message;
            secureAccessCodeError.classList.remove('hidden');
        } else {
            secureAccessCodeError.textContent = '';
            secureAccessCodeError.classList.add('hidden');
        }
    }

    function computeSecureBeginLabel(windowStatus) {
        if (windowStatus === 'NOT_YET_OPEN') {
            return 'Opens Soon';
        }
        if (windowStatus === 'PAST_DUE') {
            return 'Window Closed';
        }
        return 'Begin Assessment';
    }

    function isSecureWindowBlocked(status) {
        return status === 'NOT_YET_OPEN' || status === 'PAST_DUE';
    }

    function updateSecureBeginButton() {
        if (!secureBeginBtn) return;
        var windowStatus = secureLobbyContext ? secureLobbyContext.windowStatus : 'OPEN';
        var label = computeSecureBeginLabel(windowStatus);
        var blocked = isSecureWindowBlocked(windowStatus);
        var loading = secureBeginBtn.dataset.loading === '1';
        if (secureLobbyContext) {
            secureLobbyContext.beginLabel = label;
        }
        secureBeginBtn.disabled = blocked || loading;
        secureBeginBtn.classList.toggle('opacity-60', blocked || loading);
        if (secureBeginLabel && !loading) {
            secureBeginLabel.textContent = label;
        }
    }

    function setSecureBeginLoading(isLoading) {
        if (!secureBeginBtn) return;
        secureBeginBtn.dataset.loading = isLoading ? '1' : '0';
        if (isLoading) {
            secureBeginBtn.disabled = true;
            secureBeginBtn.classList.add('opacity-60');
            if (secureBeginLabel) {
                secureBeginLabel.textContent = 'Preparing...';
            }
        } else {
            secureBeginBtn.classList.remove('opacity-60');
            updateSecureBeginButton();
        }
    }

    function hideSecureLobby() {
        if (secureLobbyCard) {
            secureLobbyCard.style.display = 'none';
        }
        secureLobbyContext = null;
        setSecureAccessError('');
    }

    function shouldAutoReloadForSecureWindow(previousStatus, nextStatus) {
        if (!previousStatus || !nextStatus) {
            return false;
        }
        var wasBlocked = isSecureWindowBlocked(previousStatus);
        var isBlockedNow = isSecureWindowBlocked(nextStatus);
        return wasBlocked && !isBlockedNow;
    }

    function triggerSecureWindowReload() {
        if (secureWindowAutoReloaded) {
            return;
        }
        secureWindowAutoReloaded = true;
        if (secureBeginBtn) {
            secureBeginBtn.disabled = true;
            secureBeginBtn.classList.add('opacity-60');
        }
        if (secureBeginLabel) {
            secureBeginLabel.textContent = 'Refreshing...';
        }
        setTimeout(function () {
            window.location.reload();
        }, 750);
    }

    function showSecureLobby(state) {
        var previousContext = secureLobbyContext;
        var previousLobbyKey = previousContext && previousContext.lobbyKey
            ? previousContext.lobbyKey
            : (previousContext ? (previousContext.pollId + '|' + previousContext.sessionId) : null);
        var nextLobbyKey = (state.pollId || 'poll') + '|' + (state.sessionId || '');
        var isNewLobbyContext = previousLobbyKey !== nextLobbyKey;
        var previousWindowStatus = previousContext ? previousContext.windowStatus : null;
        setSecureConnectionIndicatorVisible(false);
        setSecureChromeState(true);

        secureLobbyContext = {
            pollId: state.pollId,
            sessionId: state.sessionId,
            requiresAccessCode: !!state.requiresAccessCode,
            windowStatus: (state.availability && state.availability.windowStatus) || state.windowStatus || 'OPEN',
            lobbyKey: nextLobbyKey
        };

        // CRITICAL: Persist pollId for violation reporting (secure session path)
        if (state.pollId) {
            window.currentPollId = state.pollId;
            try {
                sessionStorage.setItem('veritas_active_poll_id', state.pollId);
            } catch (e) { /* Storage may be unavailable */ }
        }

        if (shouldAutoReloadForSecureWindow(previousWindowStatus, secureLobbyContext.windowStatus)) {
            triggerSecureWindowReload();
            return;
        }

        if (entryScreen) entryScreen.style.display = 'none';
        if (studentContainer) studentContainer.style.display = 'block';
        if (studentLoader) studentLoader.style.display = 'none';
        if (preLiveCard) preLiveCard.style.display = 'none';
        if (statusContainer) statusContainer.style.display = 'none';
        if (questionContainer) questionContainer.style.display = 'none';
        // Explicitly hide secure assessment canvas until we begin
        if (secureFocusContainer) secureFocusContainer.style.display = 'none';
        secureSessionActive = false; // DEACTIVATE proctoring when in lobby
        toggleSecureLayout(false);
        if (questionProgressEl) {
            questionProgressEl.textContent = 'STANDBY';
        }
        if (secureLobbyCard) secureLobbyCard.style.display = 'block';

        if (secureLobbyTitle) {
            secureLobbyTitle.textContent = state.pollName || 'Secure Assessment';
        }
        if (secureLobbySummary) {
            if (state.className) {
                secureLobbySummary.textContent = 'Class: ' + state.className;
                secureLobbySummary.style.display = 'block';
                secureLobbySummary.classList.remove('hidden');
            } else {
                secureLobbySummary.textContent = '';
                secureLobbySummary.style.display = 'none';
                secureLobbySummary.classList.add('hidden');
            }
        }
        if (secureLobbyTime) {
            secureLobbyTime.textContent = describeSecureTimeLimit(state.timeLimitMinutes);
        }
        if (secureLobbyQuestions) {
            secureLobbyQuestions.textContent = describeSecureQuestionCount(state.questionCount);
        }

        var availability = state.availability || {};
        var availabilityMessage = availability.message || 'Available now';
        if (availability.blockingMessage) {
            availabilityMessage += '  ' + availability.blockingMessage;
        }
        if (secureWindowMessage) {
            secureWindowMessage.textContent = availabilityMessage;
        }

        if (secureAccessCodeGroup) {
            secureAccessCodeGroup.style.display = secureLobbyContext.requiresAccessCode ? 'block' : 'none';
            secureAccessCodeGroup.classList.toggle('hidden', !secureLobbyContext.requiresAccessCode);
        }
        if (secureAccessCodeInput && isNewLobbyContext) {
            secureAccessCodeInput.value = '';
        }
        if (isNewLobbyContext) {
            setSecureAccessError('');
        }
        renderSecureRules(state.proctoringRules);
        updateSecureBeginButton();
    }

    function requestFullscreenForSecureAssessment() {
        if (!secureFullscreenManager) {
            return Promise.resolve();
        }
        if (secureFullscreenManager.isFullscreen()) {
            return Promise.resolve();
        }
        return secureFullscreenManager.request().catch(function () {
            return Promise.resolve();
        });
    }

    function handleSecureFullscreenChange(event) {
        // ZERO TOLERANCE PROCTORING - Active for ALL sessions (live polls and secure assessments)
        console.log('[Proctor] Fullscreen change event:', {
            isFullscreen: event.isFullscreen,
            hidden: event.hidden,
            secureSessionActive: secureSessionActive,
            liveSessionActive: liveSessionActive,
            fullscreenEnteredOnce: fullscreenEnteredOnce,
            isInteractionBlocked: isInteractionBlocked,
            violationLogged: violationLogged
        });

        // Check for tab blur/switch (visibility hidden) - IMMEDIATE LOCK
        if (event.hidden && !isInteractionBlocked && !violationLogged) {
            console.log('[Proctor] ZERO TOLERANCE: Tab blur detected - IMMEDIATE LOCK');
            triggerSecurityViolation('tab-blur');
            return;
        }

        // Check for entering fullscreen
        if (event.isFullscreen) {
            console.log('[Proctor] Fullscreen entered');
            fullscreenEnteredOnce = true;
            return;
        }

        // Check for exiting fullscreen after having entered - IMMEDIATE LOCK
        // No grace periods. No warnings. Zero tolerance.
        if ((fullscreenEnteredOnce || secureSessionActive || liveSessionActive) && !isInteractionBlocked && !violationLogged) {
            console.log('[Proctor] ZERO TOLERANCE: Fullscreen exit detected - IMMEDIATE LOCK');
            triggerSecurityViolation('exit-fullscreen');
        }
    }

    function handleSecureBeginClick() {
        if (!secureLobbyContext || !secureBeginBtn || secureBeginBtn.disabled) {
            return;
        }
        setSecureAccessError('');
        var providedCode = secureAccessCodeInput ? secureAccessCodeInput.value.trim() : '';
        if (secureLobbyContext.requiresAccessCode && !providedCode) {
            setSecureAccessError('Access code is required.');
            if (secureAccessCodeInput) {
                secureAccessCodeInput.focus();
            }
            return;
        }

        requestFullscreenForSecureAssessment()
            .then(function () {
                setSecureBeginLoading(true);
                isEnteringFullscreen = true; // START GRACE PERIOD

                // Allow 3 seconds for browser transition chaos to settle
                setTimeout(function () { isEnteringFullscreen = false; }, 3000);

                // Double check fullscreen state
                if (!secureFullscreenManager.isFullscreen()) {
                    throw new Error('Fullscreen failed');
                }

                // Immediately mark as active to allow polling, but grace period protects against blur
                secureSessionActive = true;

                // FIXED: Client-side Access Code Check & Initialization
                var pollId = secureLobbyContext.pollId;
                var email = window.STUDENT_EMAIL || sessionStorage.getItem('veritas_student_email');

                if (!email) {
                    setSecureBeginLoading(false);
                    veritasAlert('Student identity not found. Please refresh.', { title: 'Error' });
                    return;
                }

                // Fetch poll metadata for access code
                firebase.database().ref('polls/' + pollId).once('value')
                    .then(function (snap) {
                        var poll = snap.val();
                        if (!poll) throw new Error('Poll not found');

                        var serverCode = (poll.accessCode) ? poll.accessCode : '';

                        // Simple check
                        if (serverCode && serverCode !== providedCode) {
                            throw new Error('Invalid access code.');
                        }

                        // Initialize student session
                        var emailKey = email.replace(/[.$#[\]]/g, '_');
                        return firebase.database().ref('sessions/' + pollId + '/students/' + emailKey).update({
                            status: 'ACTIVE',
                            startedAt: firebase.database.ServerValue.TIMESTAMP,
                            email: email,
                            name: window.STUDENT_NAME || email.split('@')[0]
                        });
                    })
                    .then(function () {
                        setSecureBeginLoading(false);
                        // Success!
                        hideAllViews();
                        entryScreen.style.display = 'none';
                        secureLobbyContext = null;
                        startPolling(true);
                    })
                    .catch(function (error) {
                        setSecureBeginLoading(false);
                        isEnteringFullscreen = false;
                        secureSessionActive = false;
                        var message = error.message || 'Unable to begin assessment.';
                        if (/access code/i.test(message)) {
                            setSecureAccessError(message);
                            if (secureAccessCodeInput) {
                                secureAccessCodeInput.focus();
                            }
                        } else {
                            veritasAlert(message, { title: 'Secure Assessment' });
                        }
                    });
            })
            .catch(function (err) {
                console.warn('Fullscreen request was rejected', err);
                veritasAlert('Fullscreen permission is required to begin the assessment.', { title: 'Secure Assessment' });
            });
    }

    function ensureVeritasModalRoot() {
        var existing = document.getElementById('veritas-modal-root');
        if (existing) {
            return existing;
        }

        var root = document.createElement('div');
        root.id = 'veritas-modal-root';
        root.className = 'veritas-modal-root';
        root.setAttribute('aria-hidden', 'true');
        root.innerHTML = '' +
            '<div class="veritas-modal-backdrop"></div>' +
            '<div class="veritas-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="veritas-modal-title" aria-describedby="veritas-modal-message">' +
            '<div class="veritas-modal-header">' +
            '<h2 id="veritas-modal-title">Notice</h2>' +
            '</div>' +
            '<div class="veritas-modal-body">' +
            '<p id="veritas-modal-message"></p>' +
            '<div id="veritas-modal-subtext" class="veritas-modal-subtext"></div>' +
            '<div id="veritas-modal-input" class="veritas-modal-input" style="display: none;">' +
            '<label for="veritas-modal-input-field" class="sr-only">Input</label>' +
            '<input id="veritas-modal-input-field" type="text" autocomplete="off" />' +
            '</div>' +
            '<div class="veritas-modal-actions">' +
            '<button type="button" class="veritas-modal-button secondary" data-action="cancel">Cancel</button>' +
            '<button type="button" class="veritas-modal-button primary" data-action="confirm">' +
            '<span class="veritas-modal-spinner" aria-hidden="true"></span>' +
            '<span>Confirm</span>' +
            '</button>' +
            '</div>' +
            '</div>';

        (document.body || document.documentElement).appendChild(root);
        return root;
    }

    function createVeritasModal() {
        var root = ensureVeritasModalRoot();

        var dialog = root.querySelector('.veritas-modal-dialog');
        var titleEl = root.querySelector('#veritas-modal-title');
        var messageEl = root.querySelector('#veritas-modal-message');
        var subtextEl = root.querySelector('#veritas-modal-subtext');
        var inputWrap = root.querySelector('#veritas-modal-input');
        var inputField = root.querySelector('#veritas-modal-input-field');
        var confirmBtn = root.querySelector('[data-action="confirm']');
            var cancelBtn = root.querySelector('[data-action="cancel"]');
        var confirmLabel = confirmBtn.querySelector('span:not(.veritas-modal-spinner)');
        var active = false;
        var currentConfig = null;
        var resolveFn = null;
        var previousFocus = null;
        var allowEscape = true;
        var hiddenNodes = [];

        function toggleBackground(state) {
            var siblings = [].slice.call(document.body.children);
            if (state) {
                hiddenNodes = [];
                siblings.forEach(function (node) {
                    if (node === root) return;
                    hiddenNodes.push({
                        node: node,
                        ariaHidden: node.getAttribute('aria-hidden'),
                        inert: ('inert' in node) ? node.inert : null
                    });
                    node.setAttribute('aria-hidden', 'true');
                    if ('inert' in node) {
                        node.inert = true;
                    }
                });
            } else {
                hiddenNodes.forEach(function (record) {
                    if (record.ariaHidden === null) {
                        record.node.removeAttribute('aria-hidden');
                    } else {
                        record.node.setAttribute('aria-hidden', record.ariaHidden);
                    }
                    if ('inert' in record.node) {
                        if (record.inert !== null) {
                            record.node.inert = record.inert;
                        } else {
                            record.node.inert = false;
                        }
                    }
                });
                hiddenNodes = [];
            }
        }

        function setPending(state) {
            if (state) {
                confirmBtn.classList.add('loading');
                confirmBtn.setAttribute('disabled', 'disabled');
                if (cancelBtn.style.display !== 'none') {
                    cancelBtn.setAttribute('disabled', 'disabled');
                }
            } else {
                confirmBtn.classList.remove('loading');
                confirmBtn.removeAttribute('disabled');
                cancelBtn.removeAttribute('disabled');
            }
        }

        function getFocusable() {
            var selectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            var nodes = [].slice.call(dialog.querySelectorAll(selectors));
            return nodes.filter(function (node) {
                return !node.hasAttribute('disabled') && node.offsetParent !== null;
            });
        }

        function focusFirst() {
            var focusable = getFocusable();
            if (focusable.length > 0) {
                focusable[0].focus();
            } else {
                dialog.focus();
            }
        }

        function trapKey(event) {
            if (!active) return;
            if (event.key === 'Escape') {
                if (!allowEscape) return;
                event.preventDefault();
                handleCancel();
            } else if (event.key === 'Tab') {
                var focusable = getFocusable();
                if (focusable.length === 0) {
                    event.preventDefault();
                    return;
                }
                var index = focusable.indexOf(document.activeElement);
                if (event.shiftKey) {
                    if (index <= 0) {
                        focusable[focusable.length - 1].focus();
                        event.preventDefault();
                    }
                } else {
                    if (index === focusable.length - 1) {
                        focusable[0].focus();
                        event.preventDefault();
                    }
                }
            } else if (event.key === 'Enter' && currentConfig && currentConfig.mode === 'prompt') {
                if (document.activeElement === inputField) {
                    event.preventDefault();
                    handleConfirm();
                }
            }
        }

        function enforceFocus(event) {
            if (!active) return;
            if (!dialog.contains(event.target)) {
                event.stopPropagation();
                focusFirst();
            }
        }

        function closeModal(result) {
            active = false;
            root.classList.remove('is-active');
            root.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('veritas-modal-open');
            root.removeEventListener('keydown', trapKey, true);
            document.removeEventListener('focus', enforceFocus, true);
            toggleBackground(false);
            setPending(false);
            if (previousFocus && typeof previousFocus.focus === 'function') {
                setTimeout(function () { previousFocus.focus(); }, 0);
            }
            if (resolveFn) {
                resolveFn(result);
            }
            currentConfig = null;
            resolveFn = null;
        }

        function handleConfirm() {
            if (!active) return;
            setPending(true);
            var mode = currentConfig ? currentConfig.mode : 'alert';
            var result;
            if (mode === 'prompt') {
                result = inputField.value;
            } else if (mode === 'confirm') {
                result = true;
            }
            closeModal(result);
        }

        function handleCancel() {
            if (!active) return;
            var mode = currentConfig ? currentConfig.mode : 'alert';
            if (mode === 'alert') {
                closeModal(undefined);
                return;
            }
            if (mode === 'confirm') {
                closeModal(false);
            } else if (mode === 'prompt') {
                closeModal(null);
            }
        }

        function openModal(mode, options) {
            options = options || {};
            currentConfig = Object.assign({}, options, { mode: mode });
            allowEscape = options.allowEscape !== false;
            titleEl.textContent = options.title || (mode === 'confirm' ? 'Please Confirm' : (mode === 'prompt' ? 'Enter Response' : 'Notice'));

            // SECURITY DOCUMENTATION: Trust Boundary for options.html
            // The options.html parameter accepts raw HTML and uses innerHTML (XSS risk).
            // This is INTERNAL-ONLY and must NEVER receive user-controlled data.
            // All callers of openModal() in this codebase use app-controlled strings only.
            // If adding new calls with dynamic content, use options.message (textContent) instead,
            // or sanitize user data with escapeHtml() before passing to options.html.
            if (options.html) {
                messageEl.innerHTML = options.html;  // INTERNAL ONLY - never pass user data
            } else {
                messageEl.textContent = options.message || '';
            }
            if (options.subtext) {
                subtextEl.style.display = 'block';
                subtextEl.textContent = options.subtext;
            } else {
                subtextEl.style.display = 'none';
                subtextEl.textContent = '';
            }
            if (mode === 'prompt') {
                inputWrap.style.display = 'flex';
                inputField.value = options.defaultValue || '';
                if (options.placeholder) {
                    inputField.placeholder = options.placeholder;
                } else {
                    inputField.removeAttribute('placeholder');
                }
            } else {
                inputWrap.style.display = 'none';
                inputField.value = '';
                inputField.removeAttribute('placeholder');
            }
            confirmLabel.textContent = options.confirmText || (mode === 'confirm' ? 'Confirm' : (mode === 'prompt' ? 'Submit' : 'OK'));
            if (options.destructive) {
                confirmBtn.classList.add('destructive');
            } else {
                confirmBtn.classList.remove('destructive');
            }
            cancelBtn.style.display = mode === 'alert' ? 'none' : 'inline-flex';
            cancelBtn.textContent = options.cancelText || 'Cancel';
            setPending(false);
            previousFocus = document.activeElement;
            root.classList.add('is-active');
            root.setAttribute('aria-hidden', 'false');
            document.body.classList.add('veritas-modal-open');
            toggleBackground(true);
            active = true;
            root.addEventListener('keydown', trapKey, true);
            document.addEventListener('focus', enforceFocus, true);

            return new Promise(function (resolve) {
                resolveFn = resolve;
                setTimeout(function () {
                    if (mode === 'prompt') {
                        inputField.focus();
                        inputField.select();
                    } else if (mode === 'confirm' && options.focusCancel) {
                        cancelBtn.focus();
                    } else {
                        confirmBtn.focus();
                    }
                }, 0);
            });
        }

        confirmBtn.addEventListener('click', handleConfirm);
        cancelBtn.addEventListener('click', handleCancel);
        root.addEventListener('click', function (event) {
            if (event.target === root || event.target.classList.contains('veritas-modal-backdrop')) {
                if (!currentConfig || currentConfig.allowBackdropClose === false) {
                    return;
                }
                handleCancel();
            }
        });

        return {
            alert: function (options) {
                return openModal('alert', options).then(function () { return; });
            },
            confirm: function (options) {
                return openModal('confirm', options).then(function (result) { return result !== false; });
            },
            prompt: function (options) {
                return openModal('prompt', options).then(function (result) { return result; });
            }
        };
    }
    var currentOptionLayout = [];

    var connectivityThemes = {
        connecting: ['border-amber-300', 'bg-amber-50', 'text-amber-800', 'dark:border-amber-500', 'dark:bg-amber-900/20', 'dark:text-amber-100'],
        offline: ['border-red-300', 'bg-red-50', 'text-red-800', 'dark:border-red-600', 'dark:bg-red-900/20', 'dark:text-red-200'],
        recovered: ['border-green-300', 'bg-green-50', 'text-green-800', 'dark:border-green-600', 'dark:bg-green-900/20', 'dark:text-green-100']
    };
    var allConnectivityClasses = connectivityThemes.connecting.concat(connectivityThemes.offline, connectivityThemes.recovered);

    function isPreLiveVisible() {
        return preLiveCard && preLiveCard.style.display !== 'none';
    }

    function setPreLiveReconnectMessage(text) {
        // Disabled for student view - students don't need to see sync notifications
        return;
    }

    function applyConnectivityTheme(theme) {
        if (!connectivityBanner) return;
        for (var i = 0; i < allConnectivityClasses.length; i++) {
            connectivityBanner.classList.remove(allConnectivityClasses[i]);
        }
        var themeClasses = connectivityThemes[theme] || connectivityThemes.connecting;
        for (var j = 0; j < themeClasses.length; j++) {
            connectivityBanner.classList.add(themeClasses[j]);
        }
    }

    function showConnectivityState(state, options) {
        // Disabled for student view - students don't need to see sync notifications
        // Background sync continues to work normally
        return;
    }

    function hideConnectivityBanner() {
        if (!connectivityBanner) return;
        clearTimeout(connectivityHideTimer);
        connectivityBanner.classList.add('hidden');
        if (connectivitySubMessage) {
            connectivitySubMessage.textContent = '';
            connectivitySubMessage.classList.remove('opacity-0');
        }
        setPreLiveReconnectMessage('');
    }

    function stopPolling() {
        if (pollTimerId) {
            clearTimeout(pollTimerId);
            pollTimerId = null;
        }
        pollInFlight = false;
    }

    function scheduleNextPoll(delay) {
        if (isInteractionBlocked) return;
        stopPolling();
        var boundedDelay = Math.min(maxPollInterval, Math.max(1000, delay));
        var jitter = Math.random() * 0.15 * boundedDelay;
        pollTimerId = setTimeout(function () {
            pollTimerId = null;
            pollForStatus();
        }, boundedDelay + jitter);
    }

    function startPolling(immediate) {
        // Guard: Check for persisted lock
        if (sessionStorage.getItem('veritas_lock_active') === 'true') {
            if (typeof showLockEnforcementUI === 'function') {
                showLockEnforcementUI();
            }
            return;
        }

        // POISON PILL CHECK: If lock is active, immediately show lock UI and return
        if (isPoisonPillActive()) {
            console.log('[Proctor] POISON PILL ACTIVE in startPolling - blocking resume');
            isInteractionBlocked = true;
            showLockEnforcementUI();
            startProctorPolling();
            return;
        }

        pollFailureCount = 0;
        recoveringFromOutage = false;
        if (immediate) {
            stopPolling();
            pollForStatus(true);
        } else {
            scheduleNextPoll(defaultPollInterval);
        }
    }

    function handlePostPollSuccess(data, hadFailures) {
        if (typeof data.stateVersion === 'number') {
            lastStateVersion = data.stateVersion;
        }
        if (typeof data.advisedPollIntervalMs === 'number') {
            lastAdvisedInterval = data.advisedPollIntervalMs;
        } else {
            lastAdvisedInterval = defaultPollInterval;
        }

        if (hadFailures || data.connectionHealth === 'RECOVERED_AFTER_OUTAGE') {
            showConnectivityState('recovered', {
                message: 'Back on track - synced with your teacher.',
                icon: 'cloud_done',
                autoHide: 2400
            });
        } else if (data.connectionHealth === 'RECOVERING') {
            hideConnectivityBanner();
            if (isPreLiveVisible()) {
                setPreLiveReconnectMessage('Syncing back up  we will take off in a moment.');
            }
        } else if (!recoveringFromOutage && !hadFailures) {
            hideConnectivityBanner();
        }

        updateStudentView(data);
        var delay = Math.max(500, Math.min(maxPollInterval, lastAdvisedInterval));
        scheduleNextPoll(delay);
    }

    function handlePollingFailure(error) {
        var messageText = (error && error.message) ? error.message : (typeof error === 'string' ? error : '');
        if (messageText && /Authentication|not enrolled|Invalid link/i.test(messageText)) {
            stopPolling();
            handleError(error);
            return;
        }

        recoveringFromOutage = true;
        var backoffMultiplier = Math.pow(1.6, Math.max(1, pollFailureCount));
        var retryDelay = Math.min(maxPollInterval, Math.round((lastAdvisedInterval || defaultPollInterval) * backoffMultiplier));
        var seconds = Math.max(1, Math.round(retryDelay / 1000));

        var online = typeof navigator !== 'undefined' ? navigator.onLine : true;
        showConnectivityState(online ? 'connecting' : 'offline', {
            message: online ? 'Reconnecting... your poll data is catching up.' : 'Offline detected - we will hold your spot and resync when you are back.',
            icon: online ? 'sync_problem' : 'signal_wifi_off',
            submessage: online ? ('Retrying in ' + seconds + 's...') : '',
            preLiveMessage: online ? 'Reconnecting syncing you back into place.' : 'Offline detected  we will hold your spot and sync when you are back.'
        });

        scheduleNextPoll(retryDelay);
    }

    function showWaitingForNextPhase(message) {
        // Ensure parent container is visible
        if (studentContainer) {
            studentContainer.style.display = 'block';
            studentContainer.classList.remove('hidden');
        }
        // Hide question, show status
        if (questionContainer) questionContainer.style.display = 'none';
        if (statusContainer) {
            statusContainer.style.display = 'block';
            statusContainer.classList.remove('hidden');

            // Inject SVG Checkmark
            var iconEl = statusContainer.querySelector('.material-symbols-outlined');
            if (iconEl) {
                // Replace icon with animated SVG
                // Note: We're hacking the icon container to show our SVG
                var checkHtml = `
                    <svg class="w-24 h-24 mx-auto mb-6 text-veritas-navy" viewBox="0 0 52 52" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle class="animate-draw-check" cx="26" cy="26" r="25" stroke="currentColor" stroke-width="2"/>
                        <path class="animate-draw-check" d="M14.1 27.2l7.1 7.2 16.7-16.8" stroke="currentColor" stroke-width="2" style="animation-delay: 0.2s"/>
                    </svg>
                    `;
                // Temporarily replace the icon element styling or content
                // Ideally we should have a cleaner way, but let's replace the content and remove classes that might conflict
                iconEl.innerHTML = checkHtml;
                iconEl.className = 'block mb-4'; // Reset material-symbols classes
                iconEl.textContent = ''; // Remove text content
                // Actually, replace the whole element to be safe
                var newDiv = document.createElement('div');
                newDiv.innerHTML = checkHtml;
                iconEl.replaceWith(newDiv);
                // Add a hook to restore it later? 
                // renderStatusMessage handles restoration by resetting innerHTML/className
            }
        }
        if (statusMessage) {
            statusMessage.textContent = message || 'Response Captured';
            statusMessage.className = 'text-veritas-navy text-3xl font-bold tracking-tight animate-fade-in';
        }
        if (statusSubMessage) {
            statusSubMessage.textContent = "Data transmitted. Awaiting next phase...";
            statusSubMessage.style.display = 'block';
            statusSubMessage.className = 'text-slate-500 font-medium mt-2 animate-fade-in';
        }
        // Hide any resume controls
        var resumeControls = document.getElementById('resume-controls');
        if (resumeControls) {
            resumeControls.style.display = 'none';
        }
    }

    function pollForStatus() {
        if (isInteractionBlocked || pollInFlight) return;
        pollInFlight = true;
        var context = {
            lastStateVersion: lastStateVersion,
            lastSuccessAt: lastSuccessfulPollAt,
            failureCount: pollFailureCount,
            advisedInterval: lastAdvisedInterval,
            telemetry: ActivityMonitor.getInstance().getTelemetry()
        };

        // FIXED: Fetch from Firebase
        firebase.database().ref('sessions/' + activePollId + '/live_session').once('value')
            .then(function (snapshot) {
                pollInFlight = false;
                var data = snapshot.val();
                pollFailureCount = 0;
                recoveringFromOutage = false;
                lastSuccessfulPollAt = Date.now();
                // Assume data structure matches or is adaptable
                handlePostPollSuccess(data || {}, false);
            })
            .catch(function (error) {
                pollInFlight = false;
                pollFailureCount += 1;
                console.error('Polling error', error);
                handlePollingFailure(error);
            });
    }

    function isSessionActive() {
        // Refined: Check if the actual assessment/quiz view is visible
        var isFocusVisible = secureFocusContainer && secureFocusContainer.style.display !== 'none';
        var isQuestionVisible = questionContainer && questionContainer.style.display !== 'none';
        return (isFocusVisible || isQuestionVisible) && !LockManager.isLocked();
    }

    window.addEventListener('offline', function () {
        if (!isSessionActive()) return;
        recoveringFromOutage = true;
        showConnectivityState('offline', {
            message: 'Offline detected - we will hold your spot and resync when you are back.',
            icon: 'signal_wifi_off'
        });
    });

    window.addEventListener('online', function () {
        if (!isSessionActive()) return;
        showConnectivityState('connecting', {
            message: 'Reconnecting... your poll data is catching up.',
            icon: 'sync',
            submessage: 'Syncing now...'
        });
        startPolling(true);
        // Re-assert session active state if recovering and session is truly active
        if (isSessionActive() && !isInteractionBlocked) {
            // Determine if we should really set secureSessionActive
            // This prevents lobby-to-online transition bugs
            var isFocusVisible = secureFocusContainer && secureFocusContainer.style.display !== 'none';
            if (isFocusVisible) {
                secureSessionActive = true;
            }
        }
    });

    if (resumeSessionBtn) {
        resumeSessionBtn.onclick = function () {
            console.log('Resume button clicked - attempting fullscreen');
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen()
                    .then(function () {
                        console.log('Fullscreen entered - confirming with server');
                        // Call studentConfirmFullscreen with the current lockVersion
                        // Call confirmFullscreen Cloud Function
                        var confirmFullscreenFn = firebase.functions().httpsCallable('confirmFullscreen');
                        confirmFullscreenFn({
                            pollId: CURRENT_POLL_ID || (ACTIVE_SESSION && ACTIVE_SESSION.pollId),
                            studentEmail: STUDENT_INFO.id || STUDENT_INFO.email,
                            lockVersion: currentLockVersion
                        })
                            .then(function (result) {
                                if (result.data && result.data.success) {
                                    console.log('[Proctor] Server confirmed unlock via fullscreen confirmation - Firebase listener will handle state change.');
                                } else {
                                    console.error('Failed to confirm fullscreen:', result.data?.reason);
                                    statusMessage.textContent = 'Failed to resume. Please try again.';
                                }
                            })
                            .catch(function (error) {
                                console.error('Error confirming fullscreen:', error);
                                statusMessage.textContent = 'Error resuming session.';
                            });
                    })
                    .catch(function (e) {
                        console.warn('Fullscreen denied on resume:', e);
                        statusMessage.textContent = 'Fullscreen is required. Please allow fullscreen and try again.';
                    });
            }
        };
    }

    if (secureExitButton) {
        secureExitButton.addEventListener('click', function () {
            exitSecureSessionNow();
        });
    }

    if (startSessionBtn) {
        console.log('Attaching onclick handler to start session button');
        startSessionBtn.onclick = function () {
            console.log('!!! BEGIN SESSION BUTTON CLICKED !!!');
            console.log('Hiding entry screen, showing student container');
            entryScreen.style.display = 'none';
            studentContainer.style.display = 'block';
            isInteractionBlocked = false;
            isTeacherBlocked = false;
            violationLogged = false;
            fullscreenEnteredOnce = false; // Reset for new session
            if (resumeControls) {
                resumeControls.style.display = 'none';
            }

            try {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen().catch(function (e) {
                        console.warn('Fullscreen denied:', e);
                    });
                }
            } catch (e) {
                console.error('Fullscreen error:', e);
            }

            hideConnectivityBanner();
            startPolling(true);
        };
    } else {
        console.error('Start session button not found!');
    }

    var proctorListenerRef = null;

    function initProctorListener(pollId, email) {
        if (proctorListenerRef) return;
        var emailKey = (typeof generateStudentKey === 'function') ? generateStudentKey(email) : email.replace(/[.$#[\]]/g, '_');
        var statusRef = firebase.database().ref('sessions/' + pollId + '/students/' + emailKey);
        proctorListenerRef = statusRef;

        console.log('[Proctor] Initializing Firebase listener for status updates');

        statusRef.on('value', function (snapshot) {
            var data = snapshot.val();
            if (!data) return;

            console.log('[Proctor] Status Update Received:', data.status, { version: data.lockVersion });

            if (data.status === 'AWAITING_FULLSCREEN') {
                currentLockVersion = data.lockVersion;
                showResumePrompt();
            } else if (data.status === 'LOCKED' && data.lockVersion !== currentLockVersion) {
                currentLockVersion = data.lockVersion;
                showLockEnforcementUI();
            } else if (data.status === 'BLOCKED') {
                isTeacherBlocked = true;
                currentLockVersion = data.lockVersion || currentLockVersion;
                showTeacherBlockedMessage();
            } else if (data.status === 'ACTIVE' && (isInteractionBlocked || violationLogged)) {
                // This handles the explicit unlock/unblock case
                console.log('[Proctor] Status changed to ACTIVE - clearing local lock');
                clearPersistedLock();
                isInteractionBlocked = false;
                isTeacherBlocked = false;
                violationLogged = false;
                fullscreenEnteredOnce = false;
                hideConnectivityBanner();
                secureSessionActive = true;
                // Resume normal polling if it was stopped
                startPolling(true);
            }
        });
    }

    function startProctorPolling() {
        // FIREBASE MIGRATION: Polling is deprecated in favor of on('value') listener
        var activePollId = (currentPollState && currentPollState.pollId) ||
            (secureLobbyContext && secureLobbyContext.pollId) ||
            (secureQuestionState && secureQuestionState.pollId);
        var email = window.STUDENT_EMAIL || (STUDENT_DATA && STUDENT_DATA.email);
        if (activePollId && email) {
            initProctorListener(activePollId, email);
        }
    }


    function hideAllViews() {
        // ENHANCED VIEW MUTEX: Use both display property and hidden class for robustness
        ['entry-screen', 'secure-lobby', 'status-container', 'pre-live-card', 'student-container', 'question-container', 'individual-timed-session'].forEach(function (id) {
            var el = document.getElementById(id);
            if (el) {
                el.style.display = 'none';
                el.classList.add('hidden'); // Tailwind hidden utility
            }
        });
        // Ensure body overflow logic is reset unless locked
        if (!isInteractionBlocked) {
            document.body.style.overflow = '';
        }
    }

    function showView(elementId) {
        hideAllViews();
        var el = document.getElementById(elementId);
        if (el) {
            el.style.display = 'block';
            el.classList.remove('hidden');
        }
        // Also ensure parent container is visible if needed
        if (elementId !== 'entry-screen' && studentContainer) {
            studentContainer.style.display = 'block';
            studentContainer.classList.remove('hidden');
        }
    }

    function syncCalculatorVisibility(enabled) {
        var fab = document.getElementById('calc-fab');
        var win = document.getElementById('calc-window');
        if (enabled === true || enabled === 'true') {
            if (fab) fab.style.display = 'flex';
        } else {
            if (fab) fab.style.display = 'none';
            if (win) {
                win.classList.remove('active');
                win.style.display = 'none';
            }
        }
    }

    // =============================================================================
    // MAIN VIEW CONTROLLER (Sovereign Implementation)
    // =============================================================================

    function updateStudentView(data) {
        data = data || {};

        // CRITICAL FIX: Persist pollId globally and to sessionStorage for violation reporting
        if (data.pollId) {
            window.currentPollId = data.pollId;
            sessionStorage.setItem('veritas_active_poll_id', data.pollId);
        }

        console.log('[ViewManager] Update View State:', data);

        // --- EARLY CHECKS BEFORE HIDING VIEWS (prevents white screen) ---

        var currentIndex = typeof data.questionIndex === 'number' ? data.questionIndex : null;

        // Normalize results visibility early for deterministic guards
        var resultsVisibility = data.resultsVisibility || (data.status === 'RESULTS_REVEALED' ? 'REVEALED' : null);

        // 1. POISON PILL CHECK - Do NOT hide views if student is locked
        var poisonPillActive = false;
        try {
            poisonPillActive = sessionStorage.getItem('veritas_lock_active') === 'true';
        } catch (e) { poisonPillActive = false; }

        if (poisonPillActive) {
            if (data && data.unlock_granted === true) {
                clearPersistedLock();
                poisonPillActive = false;
                if (typeof hideLockEnforcementUI === 'function') { hideLockEnforcementUI(); }
            } else {
                // Show lock screen WITHOUT hiding other views first
                if (typeof showLockEnforcementUI === 'function') {
                    showLockEnforcementUI();
                }
                isInteractionBlocked = true;
                startProctorPolling();
                return;
            }
        }

        // 2. SOVEREIGN LOCK CHECK - Before hiding views
        if (LockManager.isLocked()) {
            if (data.unlockApproved === true) {
                console.log('[LockManager] Server approved unlock - Clearing Poison Pill');
                LockManager.unlock();
            } else {
                console.warn('[LockManager] Local Lock Active - Blocking View Update');
                var reason = sessionStorage.getItem('lock_reason');
                LockManager.renderLockScreen(reason);
                return; // HALT RENDER - SECURITY BLOCK
            }
        } else if (data.isLocked || data.status === 'LOCKED') {
            // Server commanded lock
            LockManager.lock(data.lockReason || 'Server Command');
            return;
        }

        // 3. SUBMISSION GUARD - If already submitted, show waiting screen immediately (no flash)
        // Maintain submission guardrails so polling cannot rewind UI
        if (data.hasSubmitted === true && currentIndex !== null) {
            lastSubmittedQuestionIndex = currentIndex;
        }

        // If we've already submitted for this question, never re-render the prompt unless in reveal phase
        if (currentIndex !== null && lastSubmittedQuestionIndex === currentIndex && data.status === 'LIVE' && resultsVisibility !== 'REVEALED') {
            // Don't hide views - just ensure status container is visible
            if (questionContainer) questionContainer.style.display = 'none';
            showWaitingForNextPhase('Response Captured');
            return;
        }

        // --- NOW SAFE TO HIDE VIEWS AND TRANSITION ---

        hideAllViews();

        // STRICT VIEW MUTEX: prevent ghost/double screens
        ['entry-screen', 'secure-lobby', 'student-container'].forEach(function (viewId) {
            var viewEl = document.getElementById(viewId);
            if (viewEl) {
                viewEl.style.display = 'none';
                viewEl.classList.add('hidden');
            }
        });

        // FIREBASE INIT CHECK (Lazy)
        if (!firebaseRef && data.pollId && data.studentEmail) {
            // Now async, but that's fine, it will init in background
            initFirebaseSidecar(data.pollId, data.studentEmail);
        }

        // RESULTS / REVEAL HANDLING
        if (data.resultsVisibility === 'REVEALED' || data.status === 'RESULTS_REVEALED') {
            var normalizedStatus = data.status || 'RESULTS_REVEALED';
            data.status = normalizedStatus;
            renderResultsStage(data);
            return;
        }
        if (data.status === 'RESULTS_HOLD') {
            showWaitingForNextPhase('Results Pending Analysis');
            return;
        }

        // 3. Calculator Sync
        var calcEnabled = data.calculatorEnabled === true;
        if (window.syncCalculatorVisibility) {
            window.syncCalculatorVisibility(calcEnabled);
        }

        // 4. Session Status Handling
        if (data.status === 'CLOSED' || data.sessionPhase === 'ENDED') {
            if (window.hideCalculatorOnSessionEnd) window.hideCalculatorOnSessionEnd();
            ViewManager.show('status-container');
            renderStatusMessage('Session Concluded', 'The live session has ended. Thanks for participating!');
            return;
        }

        if (!data.sessionType && !data.pollId) {
            if (entryScreen) {
                entryScreen.style.display = 'block';
                entryScreen.classList.remove('hidden');
            }
            ViewManager.show('entry-screen');
            return;
        }

        // Animation for question transition
        var isNewQuestion = lastQuestionIndex !== currentIndex && currentIndex !== null;
        if (isNewQuestion) {
            lastQuestionIndex = currentIndex;
            var sContainer = document.getElementById('student-container');
            if (sContainer) {
                sContainer.classList.remove('motion-slide-in-right');
                void sContainer.offsetWidth; // Force reflow
                sContainer.classList.add('motion-slide-in-right');
            }
        }

        if (studentContainer) {
            studentContainer.style.display = 'block';
            studentContainer.classList.remove('hidden');
        }

        // 5. Route to specific view handlers
        var isSecure = (data.sessionType === 'SECURE_ASSESSMENT' || data.sessionType === 'SECURE');

        if (isSecure) {
            // Secure Logic
            if (data.status === 'LOBBY' || data.sessionPhase === 'LOBBY') {
                var lobbyView = document.getElementById('secure-lobby');
                if (lobbyView) {
                    lobbyView.style.display = 'block';
                    lobbyView.classList.remove('hidden');
                }
                ViewManager.show('secure-lobby');
                renderSecureLobby(data);
            } else {
                ViewManager.show('individual-timed-session');
                showIndividualTimedView(data);
            }
        } else {
            // Live Poll Logic (Legacy)
            if (data.sessionPhase === 'LOBBY') {
                ViewManager.show('pre-live-card');
                updatePreLiveCard(data);
            } else {
                ViewManager.show('question-container');

                // Legacy UI updates
                if (data.status === 'PRE_LIVE') {
                    liveSessionActive = false;
                    hasAnsweredCurrent = false;
                    pendingSubmission = false;
                    currentQuestionKey = null;
                    toggleSecureLayout(false);
                    if (questionProgressEl) questionProgressEl.textContent = 'QUESTION 1 OF ?';
                    ViewManager.show('pre-live-card'); // Redundant but safe
                } else {
                    if (pendingMetacogQuestionIndex === currentIndex && metacogSubmittedFor !== currentIndex) {
                        showConfidenceQuestion(data.pollId, currentIndex);
                        return;
                    }

                    if (data.hasSubmitted === true && currentIndex !== null) {
                        showWaitingForNextPhase('Response Captured');
                        return;
                    }
                    renderQuestion(data);
                }
            }
        }

        // Resume controls logic (legacy cleanup)
        var resumeControls = document.getElementById('resume-controls');
        if (resumeControls) resumeControls.style.display = 'none';
    }

    // =============================================================================
    // LIVE POLL QUESTION RENDERER (FIX: Was undefined, causing blank question view)
    // =============================================================================
    function renderQuestion(data) {
        // FIX TASK B: LOCK GUARD - If locked, do not render question content
        // This prevents lock bypass via question rendering in Live Poll mode
        if (LockManager.isLocked()) {
            console.log('[Proctor] renderQuestion BLOCKED - Lock active');
            LockManager.renderLockScreen(sessionStorage.getItem('lock_reason'));
            return; // HALT RENDER - SECURITY BLOCK
        }

        // Defensive guard: if critical elements are missing, show error
        if (!questionContainer || !optionsList || !questionTextEl) {
            console.error('[renderQuestion] Critical DOM elements missing');
            var errorOverlay = document.getElementById('render-error-overlay');
            if (!errorOverlay) {
                errorOverlay = document.createElement('div');
                errorOverlay.id = 'render-error-overlay';
                errorOverlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;color:white;font-family:sans-serif;';
                errorOverlay.innerHTML = '<h2 style="font-size:24px;margin-bottom:16px;">Unable to Load Question</h2><p style="max-width:400px;text-align:center;">Critical UI elements are missing. Please refresh the page or contact your teacher.</p>';
                document.body.appendChild(errorOverlay);
            }
            return;
        }

        currentPollState = data;
        console.log('[renderQuestion] Rendering Live Poll question:', data);

        // Derive question key for change detection
        var resetTimestamp = (data.metadata && data.metadata.resetAt) ? data.metadata.resetAt : '';
        var newQuestionKey = data.pollId + ':' + data.questionIndex + ':' + resetTimestamp;

        // Check if question has changed
        var questionChanged = (currentQuestionKey !== newQuestionKey);
        if (questionChanged) {
            console.log('[renderQuestion] Question changed from', currentQuestionKey, 'to', newQuestionKey);
            currentQuestionKey = newQuestionKey;
            hasAnsweredCurrent = !!data.hasSubmitted;
            pendingSubmission = false;
            currentOptionLayout = [];
            liveSessionActive = true;
            pendingMetacogQuestionIndex = null;
            metacogSubmittedFor = null;

            // Initialize activity tracker for this question
            activityTracker.init(data.pollId, data.sessionId || '', data.questionIndex);
        }

        // Update metacognition setting for this question
        currentMetacognitionEnabled = !!data.metacognitionEnabled;

        // Update question progress (fixes "QUESTION --" display)
        updateQuestionProgress(data.questionIndex, data.totalQuestions);

        // Show question container, hide status
        questionContainer.style.display = 'block';
        if (statusContainer) statusContainer.style.display = 'none';

        // Set question text with fallback and visibility check
        if (questionTextEl) {
            var qText = data.questionText || data.text || data.stem || '';
            if (!qText && data.options && data.options.length > 0) {
                // Fallback: If options exist but text is missing, show loading
                qText = '<span class="animate-pulse text-gray-500 italic">Loading question...</span>';
                console.warn('[renderQuestion] Question text is missing, showing loader', data);
                // Force immediate full poll to resolve this
                if (typeof startPolling === 'function') startPolling(true);
            } else if (!qText) {
                qText = "[Question Text Missing]";
            }

            // Use innerHTML instead of textContent to support the spinner span
            questionTextEl.innerHTML = qText;
            questionTextEl.style.display = 'block'; // Force visibility
            questionTextEl.classList.remove('hidden');
        }

        // Handle question image
        var hasQuestionImage = !!data.questionImageURL;
        if (questionImageEl) {
            if (hasQuestionImage) {
                questionImageEl.src = data.questionImageURL;
                questionImageEl.style.display = 'block';
            } else {
                questionImageEl.style.display = 'none';
            }
        }
        if (questionLayout) {
            questionLayout.classList.toggle('no-image', !hasQuestionImage);
        }
        if (questionVisual) {
            questionVisual.style.display = hasQuestionImage ? 'flex' : 'none';
        }

        // Hide subline (used for results stage)
        if (questionSublineEl) {
            questionSublineEl.classList.add('hidden');
            questionSublineEl.textContent = '';
        }
        if (noResponsesMessageEl) {
            noResponsesMessageEl.classList.add('hidden');
            noResponsesMessageEl.textContent = '';
        }

        // Clear results decorations (removes blur, ribbon, review-mode class, etc.)
        resetResultDecorations();

        // Render options only if question changed or options empty
        if (questionChanged || optionsList.children.length === 0) {
            var options = data.options || [];
            var letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

            // Apply shuffle if enabled (and question just changed)
            if (questionChanged && data.shuffleOptions) {
                options = shuffle(options.slice());
            }

            optionsList.innerHTML = '';
            currentOptionLayout = [];

            options.forEach(function (option, index) {
                var normalized = {
                    text: (typeof option === 'string') ? option : (option.text || ''),
                    imageURL: (typeof option === 'object') ? (option.imageURL || option.imageUrl || '') : ''
                };
                var letter = letters[index] || (index + 1).toString();
                var btn = createOptionButton(normalized, letter, data.pollId, data.questionIndex);

                // Disable if already answered
                if (hasAnsweredCurrent) {
                    btn.disabled = true;
                    btn.classList.add('answer-option-disabled');
                }

                var listItem = document.createElement('li');
                listItem.appendChild(btn);
                optionsList.appendChild(listItem);

                currentOptionLayout.push({
                    text: normalized.text,
                    imageURL: normalized.imageURL
                });
            });
        } else if (hasAnsweredCurrent) {
            // Student has already answered - show waiting screen instead of question
            showWaitingForNextPhase('Response Captured');
            return;
        }
    }

    function submitAnswer(pollId, questionIndex, answerText) {
        console.log('=== SUBMIT ANSWER CALLED ===');
        console.log('currentMetacognitionEnabled:', currentMetacognitionEnabled);
        console.log('answerText:', answerText);

        if (isInteractionBlocked) {
            return;
        }
        if (hasAnsweredCurrent) {
            return;
        }

        var buttons = optionsList.querySelectorAll('button');
        for (var i = 0; i < buttons.length; i++) {
            buttons[i].disabled = true;
            if (buttons[i].dataset.answerText === answerText) {
                buttons[i].className = optionSelectedClass;
            } else {
                buttons[i].className = optionDisabledClass;
            }
        }

        // Check if metacognition is enabled for this question
        if (currentMetacognitionEnabled) {
            console.log('Metacognition is enabled - showing confidence question');
            pendingAnswerText = answerText;
            questionContainer.style.display = 'none';
            showConfidenceQuestion(pollId, questionIndex);
        } else {
            console.log('Metacognition is NOT enabled - submitting answer directly');
            hasAnsweredCurrent = true;
            pendingSubmission = true;
            // Show immediate feedback while waiting for server response
            statusContainer.style.display = 'block';
            questionContainer.style.display = 'none';
            if (statusMessage) {
                var waitPhrases = [
                    "Locking in your genius...", "Securing your brilliance...",
                    "Beaming answer to HQ...", "Writing to the digital ledger..."
                ];
                statusMessage.textContent = waitPhrases[Math.floor(Math.random() * waitPhrases.length)];
                statusMessage.className = 'text-veritas-navy text-2xl font-bold animate-text-shimmer';
            }
            if (statusSubMessage) {
                statusSubMessage.textContent = 'Please wait while we confirm your submission.';
                statusSubMessage.style.display = 'block';
                statusSubMessage.className = 'text-slate-500 text-sm mt-2 animate-pulse';
            }
            submitAnswerToServer(pollId, questionIndex, answerText, null);
        }
    }

    function showConfidenceQuestion(pollId, questionIndex) {
        statusContainer.style.display = 'block';
        questionContainer.style.display = 'none';

        pendingMetacogQuestionIndex = questionIndex;

        statusMessage.textContent = 'How confident are you in your answer?';
        statusMessage.className = 'text-gray-800 text-xl font-semibold mb-4';

        if (statusSubMessage) {
            statusSubMessage.innerHTML = '<div class="confidence-selector mt-6 flex flex-col gap-3">' +
                '<button class="confidence-btn h-14 px-6 rounded-xl bg-red-500/20 hover:bg-red-500/30 text-gray-900 border-2 border-red-500/40 hover:border-red-500/60 transition-all font-semibold text-lg" data-confidence="guessing">' +
                '<span class="mr-2"></span> Guessing' +
                '</button>' +
                '<button class="confidence-btn h-14 px-6 rounded-xl bg-yellow-500/20 hover:bg-yellow-500/30 text-gray-900 border-2 border-yellow-500/40 hover:border-yellow-500/60 transition-all font-semibold text-lg" data-confidence="somewhat-sure">' +
                '<span class="mr-2"></span> Somewhat Sure' +
                '</button>' +
                '<button class="confidence-btn h-14 px-6 rounded-xl bg-blue-500/20 hover:bg-blue-500/30 text-gray-900 border-2 border-blue-500/40 hover:border-blue-500/60 transition-all font-semibold text-lg" data-confidence="very-sure">' +
                '<span class="mr-2"></span> Very Sure' +
                '</button>' +
                '<button class="confidence-btn h-14 px-6 rounded-xl bg-green-500/20 hover:bg-green-500/30 text-gray-900 border-2 border-green-500/40 hover:border-green-500/60 transition-all font-semibold text-lg" data-confidence="certain">' +
                '<span class="mr-2"></span> Absolutely Certain' +
                '</button>' +
                '</div>';
            statusSubMessage.style.display = 'block';
            statusSubMessage.className = 'text-gray-700 text-base mt-4';

            var confidenceBtns = statusSubMessage.querySelectorAll('.confidence-btn');
            for (var i = 0; i < confidenceBtns.length; i++) {
                confidenceBtns[i].addEventListener('click', function (event) {
                    event.preventDefault();
                    var confidence = this.dataset.confidence;
                    submitAnswerWithConfidence(pollId, questionIndex, pendingAnswerText, confidence);
                });
            }
        }
    }

    if (secureBeginBtn) {
        secureBeginBtn.addEventListener('click', handleSecureBeginClick);
    }

    if (secureAccessCodeInput) {
        secureAccessCodeInput.addEventListener('input', function () {
            setSecureAccessError('');
        });
    }

    function submitAnswerWithConfidence(pollId, questionIndex, answerText, confidence) {
        // Track answer submission
        activityTracker.recordAnswerSubmitted(answerText, confidence);

        hasAnsweredCurrent = true;
        pendingSubmission = true;
        metacogSubmittedFor = questionIndex;
        pendingMetacogQuestionIndex = null;
        statusMessage.textContent = 'Transmitting your response...';
        statusMessage.className = 'text-gray-900 text-2xl font-semibold';
        if (statusSubMessage) {
            statusSubMessage.innerHTML = '';
            statusSubMessage.style.display = 'none';
        }
        submitAnswerToServer(pollId, questionIndex, answerText, confidence);
    }

    function submitAnswerToServer(pollId, questionIndex, answerText, confidence) {
        // Live Poll - FAST PATH: Firebase First
        submitAnswerToFirebase(pollId, questionIndex, answerText, confidence)
            .then(function (firebaseResult) {
                if (firebaseResult && firebaseResult.success) {
                    console.log('[Firebase] Fast write successful (Live Poll)');
                    pendingAnswerText = null;
                    statusMessage.textContent = 'Response Received';
                    statusMessage.className = 'text-green-700 text-2xl font-semibold';
                    if (statusSubMessage) {
                        statusSubMessage.textContent = 'Recorded via Firebase.';
                        statusSubMessage.style.display = 'block';
                        statusSubMessage.className = 'text-gray-700 text-lg mt-4';
                    }
                } else {
                    console.warn('[Firebase] Fast write failed.');
                    handleLivePollError('Firebase submission failed. Please check your connection.');
                }
            });
    } function handleLivePollError(error) {
        hasAnsweredCurrent = false;
        pendingSubmission = false;
        pendingAnswerText = null;
        statusMessage.textContent = error || 'We hit a hiccup. Try again?';
        statusMessage.className = 'text-red-700 text-2xl font-semibold';
        if (statusSubMessage) {
            statusSubMessage.style.display = 'none';
            statusSubMessage.textContent = '';
        }
        setTimeout(function () {
            if (!isInteractionBlocked) {
                questionContainer.style.display = 'block';
                statusContainer.style.display = 'none';
                var buttons = optionsList.querySelectorAll('button');
                for (var i = 0; i < buttons.length; i++) {
                    buttons[i].disabled = false;
                    buttons[i].className = optionBaseClass;
                }
            }
        }, 2000);
    }
    }

    function shuffle(array) {
        var arr = array.slice();
        for (var i = arr.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = arr[i];
            arr[i] = arr[j];
            arr[j] = temp;
        }
        return arr;
    }

    function createOptionButton(option, letter, pollId, questionIndex) {
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = optionBaseClass;
        btn.dataset.answerText = option.text || '';

        var displayText = (option.text || '').trim();

        var content = '';
        if (option.imageURL) {
            content += '<img src="' + escapeHtml(option.imageURL) + '" alt="Answer ' + letter + '" class="option-image" referrerpolicy="no-referrer">';
        }
        content += '<div class="option-leading">';
        content += '<div class="letter-badge" aria-hidden="true">' + letter + '</div>';
        content += '<div class="option-body">';
        content += '<div class="option-text-wrapper">';
        if (displayText) {
            // Remove carriage returns and normalize line endings before converting to <br>
            var cleanText = displayText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            content += '<p class="option-text">' + escapeHtml(cleanText).replace(/\n/g, '<br>') + '</p>';
        }
        content += '<span class="sr-only result-announcement"></span>';
        content += '</div>';
        content += '</div>';
        content += '</div>';

        // New Review Mode Elements
        content += '<div class="result-metadata">';
        content += '<div class="percentage-flag" style="display:none"></div>';
        content += '<div class="result-icon-marker"></div>';
        content += '</div>';
        content += '<div class="result-badges"></div>';

        btn.innerHTML = content;
        btn.addEventListener('click', function (event) {
            if (event && event.target && event.target.closest('.option-image')) {
                return;
            }

            // Track option click
            var optionIndex = Array.from(btn.parentElement.parentElement.children).indexOf(btn.parentElement);
            activityTracker.recordOptionClick(optionIndex, option.text);

            submitAnswer(pollId, questionIndex, option.text);
        });

        return btn;
    }

    function resetResultDecorations() {
        if (questionContainer) {
            questionContainer.classList.remove('results-stage', 'showing-results', 'review-mode');
            // Remove ribbon if exists
            var ribbon = questionContainer.querySelector('.review-ribbon-strip');
            if (ribbon) ribbon.remove();
        }
        // Disable privacy blur
        var flashlight = document.getElementById('flashlight-overlay');
        if (flashlight) flashlight.style.display = 'none';
        if (questionContainer) {
            questionContainer.classList.remove('privacy-active');
        }

        if (questionSublineEl) {
            questionSublineEl.classList.add('hidden');
            questionSublineEl.textContent = '';
        }
        if (noResponsesMessageEl) {
            noResponsesMessageEl.classList.add('hidden');
            noResponsesMessageEl.textContent = '';
        }
        if (!optionsList) return;
        var buttons = optionsList.querySelectorAll('button');
        buttons.forEach(function (btn) {
            btn.disabled = false;
            btn.className = optionBaseClass;
            btn.classList.remove('result-readonly', 'result-correct', 'result-incorrect', 'result-your-choice', 'result-neutral');

            // Clear new elements
            var flag = btn.querySelector('.percentage-flag');
            if (flag) { flag.style.display = 'none'; flag.textContent = ''; }

            var marker = btn.querySelector('.result-icon-marker');
            if (marker) marker.textContent = '';

            var badges = btn.querySelector('.result-badges');
            if (badges) badges.innerHTML = '';
        });
    }

    function ensureOptionsRenderedForResults(data) {
        if (!optionsList) return;
        if (optionsList.children.length > 0) {
            return;
        }

        var baseOptions = currentOptionLayout.length > 0 ? currentOptionLayout : (data.options || []);
        var letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
        optionsList.innerHTML = '';
        currentOptionLayout = [];

        baseOptions.forEach(function (option, index) {
            var normalized = {
                text: option.text || option,
                imageURL: option.imageURL || option.imageUrl || ''
            };
            var letter = letters[index] || (index + 1).toString();
            var btn = createOptionButton(normalized, letter, data.pollId, data.questionIndex);
            btn.disabled = true;
            btn.classList.add('result-readonly');
            var listItem = document.createElement('li');
            listItem.appendChild(btn);
            optionsList.appendChild(listItem);
            currentOptionLayout.push({
                text: normalized.text || '',
                imageURL: normalized.imageURL || ''
            });
        });
    }

    function decorateOptionsForResults(data) {
        if (!optionsList) return;
        var totalResponses = typeof data.totalResponses === 'number' ? data.totalResponses : 0;
        var percentages = data.resultPercentages || {};
        var buttons = optionsList.querySelectorAll('button');

        buttons.forEach(function (btn) {
            var answerText = btn.dataset.answerText || '';
            btn.disabled = true;
            btn.className = optionBaseClass + ' result-readonly';
            btn.classList.remove('result-correct', 'result-incorrect', 'result-your-choice');

            var srOnly = btn.querySelector('.result-announcement');
            if (srOnly) srOnly.textContent = '';

            if (data.status !== 'RESULTS_REVEALED') {
                return;
            }

            var percentage = typeof percentages[answerText] === 'number' ? percentages[answerText] : 0;

            // Update Flag
            var flag = btn.querySelector('.percentage-flag');
            if (flag) {
                flag.style.display = 'block';
                // Always show flag for every option as per "Percentages as Flags" requirement
                if (totalResponses > 0 || percentage > 0) {
                    flag.textContent = percentage + '%';
                } else {
                    flag.textContent = '0%';
                }
            }

            var isCorrect = data.correctAnswer && answerText === data.correctAnswer;
            var hasStudentAnswer = data.studentAnswer !== undefined && data.studentAnswer !== null && data.studentAnswer !== '';
            var isStudentChoice = hasStudentAnswer && answerText === data.studentAnswer;
            var studentIsCorrect = (data.studentIsCorrect === null || data.studentIsCorrect === undefined)
                ? null
                : !!data.studentIsCorrect;

            // State Classes
            if (isCorrect) {
                btn.classList.add('result-correct');
            } else if (isStudentChoice && (studentIsCorrect === false || !isCorrect)) {
                btn.classList.add('result-incorrect');
            } else {
                // Neutral/Unselected options
                btn.classList.add('result-neutral');
            }

            // Markers (Check/X)
            var marker = btn.querySelector('.result-icon-marker');
            if (marker) {
                if (isCorrect) {
                    marker.textContent = 'check_circle'; // Green Check
                    marker.parentElement.parentElement.classList.add('result-correct'); // reinforce parent
                } else if (isStudentChoice && (studentIsCorrect === false || !isCorrect)) {
                    marker.textContent = 'cancel'; // Red X
                    marker.parentElement.parentElement.classList.add('result-incorrect');
                } else {
                    marker.textContent = ''; // No icon for others
                }
            }

            // Badges
            var badgesContainer = btn.querySelector('.result-badges');
            if (badgesContainer) {
                badgesContainer.innerHTML = '';
                if (isStudentChoice) {
                    var badge = document.createElement('span');
                    badge.className = 'badge-pill badge-your-choice';
                    badge.textContent = 'Your Choice';
                    badgesContainer.appendChild(badge);
                }
                if (isCorrect) {
                    var badge = document.createElement('span');
                    badge.className = 'badge-pill badge-correct';
                    badge.textContent = 'Correct';
                    badgesContainer.appendChild(badge);
                }
            }

            // SR Announcement
            if (srOnly) {
                var srParts = [];
                if (isCorrect) srParts.push('Correct answer');
                if (isStudentChoice) srParts.push('Your selection');
                srParts.push(percentage + '% of class selected this choice');
                srOnly.textContent = srParts.join('. ') + '.';
            }
        });
    }

    // Flashlight / Privacy Blur Logic
    // Handled via CSS classes (.review-mode triggers .privacy-blur on container)
    // No JS needed for flashlight effect anymore.


    function renderResultsStage(data) {
        currentPollState = data;
        var resetTimestamp = (data.metadata && data.metadata.resetAt) ? data.metadata.resetAt : '';
        currentQuestionKey = data.pollId + ':' + data.questionIndex + ':' + resetTimestamp;
        hasAnsweredCurrent = !!data.hasSubmitted;

        // Ensure parent container is visible for results display
        if (studentContainer) {
            studentContainer.style.display = 'block';
            studentContainer.classList.remove('hidden');
        }

        questionContainer.style.display = 'block';
        questionContainer.classList.remove('hidden');
        statusContainer.style.display = 'none';

        var qNum = (data.questionIndex || 0) + 1;
        var qTotal = data.totalQuestions || '?';
        updateQuestionProgress(data.questionIndex, data.totalQuestions);
        if (questionTextEl) {
            questionTextEl.textContent = data.questionText || '';
        }
        var hasQuestionImage = !!data.questionImageURL;
        if (questionImageEl) {
            if (hasQuestionImage) {
                questionImageEl.src = data.questionImageURL;
                questionImageEl.style.display = 'block';
            } else {
                questionImageEl.style.display = 'none';
            }
        }
        if (questionLayout) {
            questionLayout.classList.toggle('no-image', !hasQuestionImage);
        }
        if (questionVisual) {
            questionVisual.style.display = hasQuestionImage ? 'flex' : 'none';
        }

        // Remove old styling text
        if (questionSublineEl) {
            questionSublineEl.classList.add('hidden'); // Removed "Shown after responses closed."
        }

        if (data.status === 'RESULTS_REVEALED' && noResponsesMessageEl) {
            if ((data.totalResponses || 0) === 0) {
                noResponsesMessageEl.textContent = 'No responses recorded for this question.';
                noResponsesMessageEl.classList.remove('hidden');
            } else {
                noResponsesMessageEl.classList.add('hidden');
                noResponsesMessageEl.textContent = '';
            }
        } else if (noResponsesMessageEl) {
            noResponsesMessageEl.classList.add('hidden');
            noResponsesMessageEl.textContent = '';
        }

        ensureOptionsRenderedForResults(data);

        questionContainer.classList.add('results-stage', 'review-mode');

        // Add Review Ribbon
        if (!questionContainer.querySelector('.review-ribbon-strip')) {
            var ribbon = document.createElement('div');
            ribbon.className = 'review-ribbon-strip animate-fade-in';
            ribbon.textContent = 'REVIEW';
            questionContainer.appendChild(ribbon);
        }

        // Enable Privacy Blur Mode
        var flashlight = document.getElementById('flashlight-overlay');
        if (flashlight) {
            flashlight.style.display = 'none'; // Ensure old overlay is hidden
            // Set initial position to center or last known
            flashlight.style.setProperty('--x', (window.innerWidth / 2) + 'px');
            flashlight.style.setProperty('--y', (window.innerHeight / 2) + 'px');
        }
        if (questionContainer) {
            questionContainer.classList.add('privacy-active');
        }

        questionContainer.classList.remove('showing-results');
        if (data.status === 'RESULTS_REVEALED') {
            requestAnimationFrame(function () {
                questionContainer.classList.add('showing-results');
            });
        }

        decorateOptionsForResults(data);
    }

    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showStatusPanel(options) {
        options = options || {};
        hideConnectivityBanner();
        hideSecureLobby();
        if (studentContainer) studentContainer.style.display = 'block';
        if (entryScreen) entryScreen.style.display = 'none';
        if (questionContainer) questionContainer.style.display = 'none';
        if (secureFocusContainer) secureFocusContainer.style.display = 'none';
        if (studentLoader) studentLoader.style.display = 'none';
        if (statusContainer) statusContainer.style.display = 'block';

        // Theme Handling
        var isDark = options.theme === 'dark';
        var statusCard = statusContainer ? statusContainer.querySelector('.status-card') : null;

        if (isDark) {
            // Apply Premium Glass Dark Theme
            if (statusContainer) {
                statusContainer.className = 'fixed inset-0 z-[9000] flex items-center justify-center p-6 transition-all duration-700 backdrop-blur-3xl bg-slate-950/40 select-none';
                statusContainer.style.display = 'flex';
            }
            if (statusCard) {
                statusCard.className = 'status-card relative w-full max-w-xl mx-auto p-12 overflow-hidden rounded-[2.5rem] border border-white/10 bg-white/5 shadow-[0_32px_64px_-16px_rgba(0,0,0,0.5)] flex flex-col items-center text-center motion-slide-up';
                // Extra layer for better glass effect
                statusCard.style.backdropFilter = 'blur(20px)';
                statusCard.style.webkitBackdropFilter = 'blur(20px)';
            }
            // Hide the Student Header if in full overlay mode
            var header = document.querySelector('.student-header');
            if (header) header.style.display = 'none';
        } else {
            // Light/Default Theme
            if (statusContainer) {
                statusContainer.className = 'text-center py-12 animate-fade-in block';
                statusContainer.style.display = 'block';
            }
            if (statusCard) {
                statusCard.className = 'status-card bg-white rounded-2xl border border-gray-200 p-8 sm:p-12 shadow-2xl max-w-3xl mx-auto';
                statusCard.style.backdropFilter = 'none';
                statusCard.style.webkitBackdropFilter = 'none';
            }
            var header = document.querySelector('.student-header');
            if (header) header.style.display = ''; // Restore
        }

        if (statusMessage) {
            statusMessage.textContent = options.message || '';
            statusMessage.className = options.messageClass || (isDark ? 'text-white text-4xl font-bold tracking-tight mb-2 drop-shadow-sm' : 'text-gray-900 text-2xl font-semibold');
        }
        if (statusSubMessage) {
            if (options.subtext) {
                statusSubMessage.style.display = 'block';
                statusSubMessage.textContent = options.subtext;
                statusSubMessage.className = options.subClass || (isDark ? 'text-slate-300 text-xl mt-4 max-w-lg mx-auto leading-relaxed' : 'text-gray-700 text-lg mt-4');
            } else {
                statusSubMessage.style.display = 'none';
                statusSubMessage.textContent = '';
            }
        }
        var iconEl = statusContainer ? statusContainer.querySelector('.material-symbols-outlined') : null;
        if (iconEl) {
            iconEl.textContent = options.icon || 'info';
            if (isDark) {
                // Modern icon accent
                iconEl.className = 'material-symbols-outlined text-8xl mb-10 select-none ' + (options.iconClass || 'text-emerald-400');
                iconEl.style.textShadow = '0 0 30px rgba(52, 211, 153, 0.4)';
            } else {
                iconEl.className = 'material-symbols-outlined text-6xl mb-4 inline-block ' + (options.iconClass || 'text-veritas-navy');
                iconEl.style.textShadow = 'none';
            }
        }
        if (resumeControls) {
            resumeControls.style.display = options.showResume ? 'block' : 'none';
            if (isDark && options.showResume) {
                var btn = document.getElementById('resume-session-btn');
                if (btn) {
                    btn.className = 'mx-auto mt-8 flex items-center justify-center gap-3 px-10 py-5 rounded-2xl bg-white text-slate-900 text-xl font-bold hover:bg-slate-50 transition-all duration-300 hover:scale-105 shadow-[0_20px_40px_-10px_rgba(255,255,255,0.2)] active:scale-95';
                }
            }
        }
        if (secureExitControls) {
            if (options.showExitAction) {
                secureExitControls.classList.remove('hidden');
                if (secureExitDescription) {
                    secureExitDescription.textContent = options.exitActionDescription || 'Click below to exit fullscreen and close the secure window.';
                    if (isDark) secureExitDescription.className = 'text-slate-400 text-sm mt-12 mb-4 max-w-sm mx-auto';
                }
                if (secureExitBtn) {
                    if (isDark) {
                        secureExitBtn.className = 'mx-auto flex items-center justify-center gap-2 px-8 py-4 rounded-xl border border-white/10 bg-white/5 text-slate-300 text-base font-medium hover:bg-white/10 transition-all duration-300 hover:text-white';
                    }
                }
                if (secureExitLabel) {
                    secureExitLabel.textContent = options.exitActionLabel || 'Exit Secure Session';
                }
            } else {
                secureExitControls.classList.add('hidden');
            }
        }
        if (document && document.body) {
            if (options.lockScroll) {
                document.body.classList.add('secure-overlay-active');
            } else {
                document.body.classList.remove('secure-overlay-active');
            }
        }
    }

    function showLockedMessage(message, subMessage) {
        console.log('Showing locked message');
        stopPolling();
        recoveringFromOutage = false;
        // Professional lock message with science-themed copy
        showStatusPanel({
            icon: 'lock',
            iconClass: 'text-red-600',
            message: message || 'Assessment Paused',
            messageClass: 'text-gray-900 text-2xl font-bold',
            subtext: subMessage || 'Proctoring protocol triggered. Your teacher can see this and will grant re-entry.',
            subClass: 'text-gray-800 text-base mt-4 whitespace-pre-line',
            showResume: false,
            lockScroll: true
        });
        isTeacherBlocked = false;
    }

    /**
     * VERITAS UI CONFIGURATION
     * Theme: "Clear Protocol + Calm Guide" (Hybrid)
     * Tone: Warm but Precise. Human but Authoritative.
     */
    const UX_COPY = {
        // VIOLATION
        LOCKED: {
            title: "You Stepped Out",
            icon: "door_open",
            body: "The session detected activity outside this window.",
            footer: "This was flagged automatically. Your instructor can bring you back in.",
            badge: "OUTSIDE THE ROOM",
            statusLight: "LINK ACTIVE"
        },
        // LOBBY
        PRE_LIVE: {
            title: "Checked In",
            icon: "how_to_reg",
            body: "You're in the room. Waiting for the green light."
        },
        // SUBMITTED
        RESPONSE_SUBMITTED: {
            title: "Answer Sent",
            icon: "outgoing_mail",
            body: "Recorded. Sit back while the class catches up."
        },
        // REVEAL
        WAITING_FOR_REVEAL: {
            title: "Time's Up",
            icon: "timer_off",
            body: "Answers are sealed. Reveal is in your instructor's hands."
        },
        // TRANSITION
        BETWEEN_QUESTIONS: {
            title: "Switching Gears",
            icon: "swap_horiz",
            body: "Next question on deck."
        }
    };

    // --- AMBER LOCK SCREEN RENDERER ---
    function showLockEnforcementUI(reason) {
        var container = document.getElementById('lock-overlay');
        if (!container) return;

        // Reset opacity to ensure visibility (cleanup from old trap code)
        document.body.style.opacity = '1';
        container.style.display = 'flex';

        // SECURITY FIX: Escape reason to prevent XSS (even though currently app-controlled)
        // This protects against future refactoring where user-controlled data might flow here
        var safeReason = reason ? escapeHtml(reason) : UX_COPY.LOCKED.body;

        container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full w-full max-w-2xl mx-auto p-8 animate-fade-in text-center">

                    <div class="h-20 w-20 bg-amber-900/20 rounded-full flex items-center justify-center mb-6 border-2 border-amber-700">
                        <span class="material-symbols-outlined text-4xl text-amber-400">
                            ${UX_COPY.LOCKED.icon}
                        </span>
                    </div>

                    <h1 class="text-3xl font-bold text-white mb-2 tracking-tight">
                        ${UX_COPY.LOCKED.title}
                    </h1>

                    <div class="w-full bg-amber-900/10 border-l-4 border-amber-500 p-5 my-6 text-left rounded-r-md">
                        <p class="text-xs font-semibold text-amber-400 uppercase tracking-wide mb-1">
                            ${UX_COPY.LOCKED.badge}
                        </p>
                        <p class="text-lg text-gray-100">
                            ${safeReason}
                        </p>
                    </div>

                    <p class="text-base text-gray-400">
                        ${UX_COPY.LOCKED.footer}
                    </p>

                    <div class="mt-8 flex items-center gap-2 text-xs text-gray-500 font-medium">
                        <span class="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span>${UX_COPY.LOCKED.statusLight}</span>
                    </div>
                </div>
            `;
    }

    /**
     * Hide the lock enforcement overlay
     */
    function hideLockEnforcementUI() {
        var container = document.getElementById('lock-overlay');
        if (container) {
            container.style.display = 'none';
            container.innerHTML = '';
        }
        // Reset body opacity in case it was hidden by snipping trap
        document.body.style.opacity = '1';
    }

    /**
     * Render a status message in the status container
     * Used for session ended, waiting states, etc.
     */
    function renderStatusMessage(title, message, options) {
        options = options || {};
        var icon = options.icon || 'check_circle';
        var iconClass = options.iconClass || 'text-veritas-navy';

        if (statusContainer) {
            statusContainer.style.display = 'block';
        }
        if (questionContainer) {
            questionContainer.style.display = 'none';
        }
        if (statusMessage) {
            statusMessage.textContent = title || 'Status';
            statusMessage.className = 'text-gray-900 text-2xl font-semibold';
        }
        if (statusSubMessage) {
            statusSubMessage.textContent = message || '';
            statusSubMessage.style.display = message ? 'block' : 'none';
            statusSubMessage.className = 'text-gray-700 text-lg mt-4';
        }

        // Update the icon
        // Update the icon
        var statusCard = statusContainer ? statusContainer.querySelector('.status-card') : null;
        if (statusCard) {
            // Check if we need to restore the original icon span (if it was replaced by SVG)
            var iconContainer = statusCard.querySelector('.material-symbols-outlined') || statusCard.querySelector('div:first-child');

            // If we found a container but it's not the span we expect, or if we need to reset it
            if (!iconContainer || iconContainer.tagName !== 'SPAN' || !iconContainer.classList.contains('material-symbols-outlined')) {
                // Recreate the standard icon span
                var newIconSpan = document.createElement('span');
                newIconSpan.className = 'material-symbols-outlined text-6xl mb-4 inline-block ' + iconClass;
                newIconSpan.textContent = icon;

                if (iconContainer) {
                    iconContainer.replaceWith(newIconSpan);
                } else {
                    // Should be first child
                    statusCard.insertBefore(newIconSpan, statusCard.firstChild);
                }
            } else {
                // It's the standard span, just update it
                iconContainer.textContent = icon;
                iconContainer.className = 'material-symbols-outlined text-6xl mb-4 inline-block ' + iconClass;
            }
        }

        // Hide resume controls
        var resumeControls = document.getElementById('resume-controls');
        if (resumeControls) {
            resumeControls.style.display = 'none';
        }

        // Show secure exit if session ended
        var secureExitControls = document.getElementById('secure-exit-controls');
        if (secureExitControls && options.showExit) {
            secureExitControls.classList.remove('hidden');
        }
    }

    /**
     * Show transition loading overlay with optional message
     */
    function showTransitionOverlay(message) {
        var overlay = document.getElementById('transition-overlay');


        // Upgrade overlay content dynamically if it's the old simple version
        if (overlay && !overlay.querySelector('.animate-pulse-ring')) {
            overlay.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-8">
                        <div class="relative w-20 h-20 mb-6 flex items-center justify-center">
                            <div class="absolute inset-0 rounded-full bg-veritas-navy/10 animate-pulse-ring"></div>
                            <div class="absolute inset-0 rounded-full bg-veritas-navy/5 animate-pulse-ring" style="animation-delay: 0.5s;"></div>
                            <div class="relative w-12 h-12 rounded-full bg-veritas-navy flex items-center justify-center shadow-lg transform transition-transform duration-500 hover:rotate-180">
                                <span class="material-symbols-outlined text-2xl text-white">sync</span>
                            </div>
                        </div>
                        <p id="transition-message" class="text-veritas-navy text-lg font-bold tracking-wide animate-text-shimmer">Loading...</p>
                        <p class="text-slate-400 text-xs font-medium mt-2 uppercase tracking-widest">Please Wait</p>
                    </div>
                `;
        }

        var msgEl = document.getElementById('transition-message');
        if (overlay) {
            overlay.style.display = 'flex';
            requestAnimationFrame(function () {
                overlay.style.opacity = '1';
            });
        }
        if (msgEl) {
            var loadPhrases = [
                "Synapsing...", "Calibrating Neural Net...", "Crunching Data...",
                "Fetching Brilliance...", "Aligning Quarks...", "Beaming to Cloud..."
            ];
            msgEl.textContent = message || loadPhrases[Math.floor(Math.random() * loadPhrases.length)];
        }
    }

    /**
     * Hide transition loading overlay
     */
    function hideTransitionOverlay() {
        var overlay = document.getElementById('transition-overlay');
        if (overlay) {
            overlay.style.opacity = '0';
            setTimeout(function () {
                overlay.style.display = 'none';
            }, 200);
        }
    }

    function showTeacherBlockedMessage() {
        console.log('Showing teacher block message');
        stopPolling();
        isInteractionBlocked = true;
        isTeacherBlocked = true;
        showStatusPanel({
            icon: 'pause_circle',
            iconClass: 'text-amber-600',
            message: 'Session Paused',
            messageClass: 'text-gray-900 text-xl font-semibold',
            subtext: 'Your teacher has temporarily frozen responses. Hold position.',
            subClass: 'text-gray-700 text-base mt-4',
            showResume: false,
            lockScroll: true
        });
    }

    function showResumePrompt() {
        console.log('Showing resume prompt');
        stopPolling();

        // CRITICAL FIX: Explicitly hide the lock overlay so the Resume prompt is visible
        hideLockEnforcementUI();

        var modeName = getFullModeName();
        var resumeLabel = document.getElementById('resume-session-label');
        if (resumeLabel) {
            resumeLabel.textContent = 'Resume ' + modeName;
        }
        showStatusPanel({
            theme: 'dark',
            icon: 'fullscreen',
            // iconClass: 'text-emerald-400', // Default is fine (emerald-400 set in function for dark mode)
            message: 'Cleared for Re-Entry',
            // messageClass: 'text-white text-3xl font-bold tracking-tight', // Default is fine
            subtext: 'Click below to return to fullscreen and rejoin the session.',
            // subClass: 'text-gray-300 text-lg mt-4', // Default is fine
            showResume: true,
            lockScroll: true
        });
    }

    function handleError(error) {
        console.error('Error:', error);

        // Extract clean error message
        var errorMsg = (error.message || error) || 'Unknown error';
        var errorString = String(errorMsg);

        // Remove "Error: " prefix if present to avoid duplication
        if (typeof errorMsg === 'string' && errorMsg.indexOf('Error: ') === 0) {
            errorMsg = errorMsg.substring(7);
        }

        // Handle generic network errors
        if (errorString.includes('NetworkError') || errorString.includes('HTTP 0') || errorString.includes('Connection failure')) {
            errorMsg = 'Network connection interrupted. Please check your internet connection and try again.';
        }

        showStatusPanel({
            icon: 'error',
            iconClass: 'text-veritas-navy',
            message: 'An error occurred: ' + errorMsg,
            messageClass: 'text-gray-900 text-2xl font-bold',
            showResume: false,
            lockScroll: false
        });
        if (resumeControls) resumeControls.style.display = 'none';
    }

    // =========================================================================
    // TI-84 CALCULATOR WIDGET MODULE
    // =========================================================================

    var calcFab = document.getElementById('calc-fab');
    var calcWindow = document.getElementById('calc-window');
    var calcHeader = document.getElementById('calc-header');
    var calcClose = document.getElementById('calc-close');
    var calcIframe = document.getElementById('calc-iframe');
    var calcLoader = document.getElementById('calc-loader');
    var calcIframeLoaded = false;
    var calcWindowOpen = false;

    /**
     * Sync calculator FAB visibility based on server state
     * @param {boolean} isEnabled - Whether calculator is enabled for this session
     */
    function syncCalculatorVisibility(isEnabled) {
        if (!calcFab) return;

        if (isEnabled) {
            calcFab.classList.remove('hidden');
        } else {
            calcFab.classList.add('hidden');
            // Force close calculator window if disabled mid-exam
            if (calcWindow) {
                calcWindow.classList.add('hidden');
                calcWindowOpen = false;
            }
        }
    }

    /**
     * Open calculator window and lazy-load iframe
     */
    function openCalculator() {
        if (!calcWindow || !calcIframe) return;

        calcWindow.classList.remove('hidden');
        calcWindowOpen = true;

        // Lazy load iframe on first open
        if (!calcIframeLoaded && calcIframe.dataset.src) {
            calcIframe.src = calcIframe.dataset.src;
            calcIframeLoaded = true;

            calcIframe.addEventListener('load', function () {
                if (calcLoader) {
                    calcLoader.style.display = 'none';
                }
                console.log('[Calculator] TI-84 iframe loaded');
            }, { once: true });
        }
    }

    /**
     * Close calculator window
     */
    function closeCalculator() {
        if (!calcWindow) return;
        calcWindow.classList.add('hidden');
        calcWindowOpen = false;
    }

    // FAB click handler
    if (calcFab) {
        calcFab.addEventListener('click', function () {
            if (calcWindowOpen) {
                closeCalculator();
            } else {
                openCalculator();
            }
        });
    }

    // Close button handler
    if (calcClose) {
        calcClose.addEventListener('click', function (e) {
            e.stopPropagation();
            closeCalculator();
        });
    }

    // =========================================================================
    // DRAGGABLE WINDOW LOGIC (Robust Mouse + Touch Support)
    // =========================================================================

    // =========================================================================
    // ROBUST DRAG & DROP (Sovereign Shield Implementation)
    // =========================================================================

    function initCalculatorDrag() {
        var header = document.getElementById('calc-header');
        var win = document.getElementById('calc-window');
        var iframe = document.getElementById('calc-iframe');

        if (!header || !win) return;

        // Create Drag Shield (Lazy init)
        var shieldId = 'veritas-drag-shield';
        var shield = document.getElementById(shieldId);
        if (!shield) {
            shield = document.createElement('div');
            shield.id = shieldId;
            shield.style.position = 'fixed';
            shield.style.top = '0';
            shield.style.left = '0';
            shield.style.width = '100vw';
            shield.style.height = '100vh';
            shield.style.zIndex = '2147483647'; // Max z-index
            shield.style.cursor = 'move';
            shield.style.display = 'none';
            shield.style.background = 'transparent'; // Invisible
            document.body.appendChild(shield);
        }

        var isDragging = false;
        var startX, startY, initialLeft, initialTop;

        function onDragStart(e) {
            if (e.target.closest('#calc-close')) return;

            isDragging = true;

            // Show Shield to capture all mouse events (prevents iframe theft)
            shield.style.display = 'block';

            var clientX = e.type.indexOf('touch') !== -1 ? e.touches[0].clientX : e.clientX;
            var clientY = e.type.indexOf('touch') !== -1 ? e.touches[0].clientY : e.clientY;

            startX = clientX;
            startY = clientY;

            var rect = win.getBoundingClientRect();
            initialLeft = rect.left;
            initialTop = rect.top;

            // Clear transform, switch to static top/left for reliability
            win.style.transform = 'none';
            win.style.left = initialLeft + 'px';
            win.style.top = initialTop + 'px';
            win.style.right = 'auto';
            win.style.bottom = 'auto';

            if (e.cancelable && !e.target.tagName.match(/INPUT|TEXTAREA|SELECT|BUTTON/i)) {
                e.preventDefault();
            }
        }

        function onDragMove(e) {
            if (!isDragging) return;

            // Prevent scrolling on touch
            if (e.cancelable) e.preventDefault();

            var clientX = e.type.indexOf('touch') !== -1 ? e.touches[0].clientX : e.clientX;
            var clientY = e.type.indexOf('touch') !== -1 ? e.touches[0].clientY : e.clientY;

            var deltaX = clientX - startX;
            var deltaY = clientY - startY;

            var newLeft = initialLeft + deltaX;
            var newTop = initialTop + deltaY;

            // Bounds Checking
            var maxW = window.innerWidth - win.offsetWidth;
            var maxH = window.innerHeight - win.offsetHeight;

            newLeft = Math.max(0, Math.min(newLeft, maxW));
            newTop = Math.max(0, Math.min(newTop, maxH));

            win.style.left = newLeft + 'px';
            win.style.top = newTop + 'px';
        }

        function onDragEnd() {
            isDragging = false;
            shield.style.display = 'none';
        }

        // Attach start listeners to header
        header.style.cursor = 'move';
        // Remove old listeners if any (by cloning? No, just add new ones, browser handles)
        // But to be clean, let's assume this runs once.
        header.addEventListener('mousedown', onDragStart);
        header.addEventListener('touchstart', onDragStart, { passive: false });

        // Attach move/end listeners to SHIELD (Sovereign Capture)
        // This is the key: The events happen on the shield, not the window/document
        shield.addEventListener('mousemove', onDragMove);
        shield.addEventListener('touchmove', onDragMove, { passive: false });

        shield.addEventListener('mouseup', onDragEnd);
        shield.addEventListener('touchend', onDragEnd);
        shield.addEventListener('mouseleave', onDragEnd);
    }

    // Initialize Drag
    function initVisuals() {
        // 1. Fix Question Header Initialization
        var qProgress = document.getElementById('question-progress');
        if (qProgress) {
            // Hide initially until a real question index is received
            qProgress.classList.add('hidden');
            qProgress.textContent = 'WAITING TO START';
        }

        // 2. Ghost Screen / Duplicate Logo Killer
        // The screenshot shows a duplicate "Veritas Live Polls" logo at the bottom.
        // This detects and removes duplicate entry screens or rogue H1s.
        var entryScreens = document.querySelectorAll('#entry-screen');
        if (entryScreens.length > 1) {
            console.warn('[VisualFix] Found ' + entryScreens.length + ' entry-screens. Removing duplicates.');
            for (var i = 1; i < entryScreens.length; i++) {
                entryScreens[i].remove();
            }
        } else {
            // Fallback: If ID is missing on duplicates, check H1s
            var brands = document.querySelectorAll('h1');
            if (brands.length > 1) {
                console.warn('[VisualFix] Found duplicate H1 elements. Cleaning up.');
                for (var j = 1; j < brands.length; j++) {
                    // Traverse up to find the container to remove
                    var wrapper = brands[j].closest('.flex.items-center.gap-4'); // The logo container class
                    if (wrapper) wrapper.remove();
                    else brands[j].remove();
                }
            }
        }
    }

    function startApp() {
        initCalculatorDrag();
        initVisuals();
    }

    function initAuth() {
        // CLIENT-SIDE AUTH CHECK
        // If we are in "static mode" (hosting) and have no injected email, perform login.
        if (!window.STUDENT_EMAIL) {
            console.log('[Auth] No student email found. Initiating Login Flow.');

            // Hide main content to prevent flash
            var appContainer = document.getElementById('student-container');
            var entryScreen = document.getElementById('entry-screen');
            if (appContainer) appContainer.style.display = 'none';
            if (entryScreen) entryScreen.style.display = 'none';

            if (window.LoginManager) {
                LoginManager.init(function (user) {
                    // On Success
                    console.log('[Auth] Login successful. Reloading to initialize session.');
                    setTimeout(function () { window.location.reload(); }, 500);
                });
                LoginManager.show();
            } else {
                console.error('LoginManager not loaded!');
                alert('Authentication system missing. Please contact support.');
            }
        } else {
            // Already authenticated (or GAS mode)
            console.log('[Auth] Authenticated as:', window.STUDENT_EMAIL);
            startApp();
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAuth);
    } else {
        initAuth();
    }

    // Handle calculator visibility when session ends or locks
    function hideCalculatorOnSessionEnd() {
        var calcFab = document.getElementById('calc-fab');
        var calcWindow = document.getElementById('calc-window');
        if (calcFab) calcFab.style.display = 'none';
        if (calcWindow) {
            calcWindow.classList.add('hidden');
            calcWindow.classList.remove('active');
            calcWindow.style.display = 'none';
            calcWindowOpen = false;
        }
    }

    // Expose function for session state changes
    window.syncCalculatorVisibility = syncCalculatorVisibility;
    window.hideCalculatorOnSessionEnd = hideCalculatorOnSessionEnd;
    window.updateStudentView = updateStudentView;
    window.LockManager = LockManager;
    window.ViewManager = ViewManager;

    }) ();
</script>
  <script>
    /**
     * Veritas Theme Manager
     * Handles Dark Mode persistence, system preference detection, and UI toggling.
     */
    (function () {
        var ThemeManager = {
            LOCAL_STORAGE_KEY: 'veritas_theme',

            init: function () {
                this.applyTheme(this.getPreferredTheme());
                this.injectToggle();

                // Listen for system changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    if (!localStorage.getItem(this.LOCAL_STORAGE_KEY)) {
                        this.applyTheme(e.matches ? 'dark' : 'light');
                    }
                });
            },

            getPreferredTheme: function () {
                var stored = localStorage.getItem(this.LOCAL_STORAGE_KEY);
                if (stored) return stored;
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            },

            applyTheme: function (theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                localStorage.setItem(this.LOCAL_STORAGE_KEY, theme);
                this.updateButtonState(theme);
            },

            toggle: function () {
                var current = this.getPreferredTheme();
                var next = current === 'dark' ? 'light' : 'dark';
                this.applyTheme(next);
            },

            updateButtonState: function (theme) {
                var btn = document.getElementById('theme-toggle-btn');
                if (!btn) return;

                var icon = btn.querySelector('.material-symbols-outlined');
                if (icon) {
                    icon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode';
                }
                btn.setAttribute('aria-label', 'Switch to ' + (theme === 'dark' ? 'light' : 'dark') + ' mode');
            },

            injectToggle: function () {
                if (document.getElementById('theme-toggle-btn')) return;

                var btn = document.createElement('button');
                btn.id = 'theme-toggle-btn';
                btn.className = 'theme-toggle fixed bottom-6 right-6 z-50 p-3 rounded-full shadow-lg transition-all duration-300 hover:scale-110 focus:outline-none';

                // Styles are inline or tailwind, but we need dynamic logic for colors
                // We'll use classes that adapt to dark mode via Tailwind
                btn.classList.add('bg-white', 'dark:bg-slate-800', 'text-slate-800', 'dark:text-yellow-400');

                btn.innerHTML = '<span class="material-symbols-outlined text-xl">dark_mode</span>';
                btn.onclick = this.toggle.bind(this);

                document.body.appendChild(btn);
                this.updateButtonState(this.getPreferredTheme());
            }
        };

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => ThemeManager.init());
        } else {
            ThemeManager.init();
        }

        // Expose global
        window.ThemeManager = ThemeManager;
    })();
</script>

<style>
    /* Extra transition for smooth theme switching */
    html.dark body {
        background-color: #0f172a;
        /* slate-900 */
        color: #f8fafc;
        /* slate-50 */
    }

    html.dark .glass-card {
        background: rgba(15, 23, 42, 0.6);
        border-color: rgba(255, 255, 255, 0.1);
    }

    /* Transition properties */
    body,
    .glass-card,
    .btn,
    .card {
        transition-property: background-color, border-color, color, fill, stroke;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 300ms;
    }
</style>
</body>

</html>