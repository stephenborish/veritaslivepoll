<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veritas Live Poll - Teacher Dashboard</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#002d6b",
            "brand-white": "#ffffff",
            "brand-light-gray": "#d9e0e7",
            "brand-dark-gray": "#242424",
            "background-light": "#f5f7f8",
            "background-dark": "#0f1723"
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
            serif: ["Noto Serif", "serif"]
          },
          borderRadius: {
            DEFAULT: "0.25rem",
            lg: "0.5rem",
            xl: "0.75rem",
            full: "9999px"
          }
        }
      }
    };
  </script>

  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style type="text/tailwindcss">
    @layer utilities {
      .correct-answer-bg {
        background-image: repeating-linear-gradient(
          45deg,
          rgba(217, 224, 231, 0.7),
          rgba(217, 224, 231, 0.7) 10px,
          rgba(217, 224, 231, 1) 10px,
          rgba(217, 224, 231, 1) 20px
        );
      }
      .dark .correct-answer-bg {
        background-image: repeating-linear-gradient(
          45deg,
          rgba(0, 46, 109, 0.2),
          rgba(0, 46, 109, 0.2) 10px,
          rgba(0, 46, 109, 0.3) 10px,
          rgba(0, 46, 109, 0.3) 20px
        );
      }
    }
  </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-brand-dark-gray dark:text-brand-white">
  <div class="flex h-screen w-full flex-col">
    <!-- Header - Default State -->
    <header id="header-default" class="flex shrink-0 items-center justify-between whitespace-nowrap border-b border-solid border-primary/80 bg-primary px-6 py-3 shadow-sm">
      <div class="flex items-center gap-4">
        <img alt="Malvern Prep Logo" class="h-10 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png"/>
        <div class="flex flex-col">
          <h1 class="text-brand-white text-lg font-bold leading-tight tracking-[-0.015em]">Veritas Live Poll</h1>
          <p class="text-brand-white/80 text-sm">Teacher Dashboard</p>
        </div>
      </div>
      <div id="loader" class="loader" style="display: block;">
        <div class="h-6 w-6 animate-spin rounded-full border-2 border-brand-white/80 border-t-transparent"></div>
      </div>
    </header>

    <!-- Header - Live Poll State -->
    <header id="header-live" class="flex shrink-0 items-center justify-between whitespace-nowrap border-b border-solid border-primary/80 bg-primary px-6 py-3 shadow-sm" style="display: none;">
      <div class="flex items-center gap-4">
        <img alt="Malvern Prep Logo" class="h-10 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png"/>
        <div class="flex flex-col">
          <h1 id="header-poll-name" class="text-brand-white text-lg font-bold leading-tight tracking-[-0.015em]">Poll Name</h1>
          <p class="text-brand-white/80 text-sm">Live Poll</p>
        </div>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        <button id="header-start-btn" class="flex min-w-[80px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-brand-white text-primary text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-brand-light-gray transition-colors">
          <span class="material-symbols-outlined text-xl">play_arrow</span>
          <span class="truncate">Start</span>
        </button>
        <button id="header-pause-btn" class="flex min-w-[80px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-brand-white/30 transition-colors" style="display: none;">
          <span class="material-symbols-outlined text-xl">pause</span>
          <span class="truncate">Pause</span>
        </button>
        <button id="header-stop-btn" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-red-600 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-red-700 transition-colors">
          <span class="material-symbols-outlined text-xl">stop</span>
          <span class="truncate">Stop</span>
        </button>
        <div class="mx-2 h-6 w-px bg-brand-white/30"></div>
        <div id="question-dots" class="flex items-center gap-1.5 rounded-full bg-brand-white/20 px-3 py-1.5 text-sm font-medium text-brand-white">
          <!-- Question dots will be populated dynamically -->
        </div>
        <button id="header-next-btn" class="flex min-w-[80px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-brand-white/30 transition-colors">
          <span class="material-symbols-outlined text-xl">skip_next</span>
          <span class="truncate">Next</span>
        </button>
        <button id="header-skip-btn" class="flex min-w-[80px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-brand-white/30 transition-colors ml-2">
          <span class="material-symbols-outlined text-xl">fast_forward</span>
          <span class="truncate">Skip Question</span>
        </button>
      </div>
    </header>

    <div class="flex flex-grow overflow-hidden">
      <!-- Main Content Area -->
      <main class="flex-1 overflow-y-auto">
        <!-- Dashboard View (Default) -->
        <div id="dashboard" class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
          <!-- Sidebar Controls -->
          <aside class="lg:col-span-1 flex flex-col gap-6">
            <!-- Poll Controls -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <h2 class="text-brand-dark-gray dark:text-brand-white text-xl font-bold leading-normal mb-4">Poll Controls</h2>
              <div class="form-group mb-4">
                <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white" for="poll-select">Select Poll</label>
                <select id="poll-select" class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                  <option value="">-- Choose a poll --</option>
                </select>
              </div>
              <button id="send-link-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 mb-2 bg-green-600 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span class="material-symbols-outlined text-xl">mail</span>
                <span class="truncate">Send Student Links</span>
              </button>
              <button id="view-links-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 mb-4 bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span class="material-symbols-outlined text-xl">visibility</span>
                <span class="truncate">View All Links</span>
              </button>
              <div class="form-group mb-4">
                <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white" for="poll-timer-input">Timer (seconds)</label>
                <input type="number" id="poll-timer-input" placeholder="60" min="10" max="600" class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50"/>
              </div>
              <button id="start-poll-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 mb-2 bg-primary text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
                <span class="material-symbols-outlined text-xl">play_arrow</span>
                <span class="truncate">Start Poll</span>
              </button>
            </div>

            <!-- Create New Poll -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <h2 class="text-brand-dark-gray dark:text-brand-white text-xl font-bold leading-normal mb-4">Create New Poll</h2>
              <button id="open-creator-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">
                <span class="material-symbols-outlined text-xl">add_circle</span>
                <span class="truncate">Create New Poll</span>
              </button>
            </div>
          </aside>

          <div class="lg:col-span-2 flex items-center justify-center">
            <div class="text-center">
              <span class="material-symbols-outlined text-6xl text-primary dark:text-brand-white mb-4 inline-block">ballot</span>
              <h2 class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white mb-2">Welcome to Veritas Live Poll</h2>
              <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Select a poll and click "Start Poll" to begin</p>
            </div>
          </div>
        </div>

        <!-- Live Poll View -->
        <div id="live-view" class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6" style="display: none;">
          <!-- Main Content (2/3) -->
          <div class="lg:col-span-2 flex flex-col gap-6">
            <!-- Question Display -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <div class="flex gap-6">
                <div class="flex-grow">
                  <p id="live-question-info" class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm font-medium leading-normal mb-1">Question 1 of 10</p>
                  <h2 id="live-question-text" class="font-serif text-brand-dark-gray dark:text-brand-white tracking-tight text-xl leading-snug mb-4">Question text appears here</h2>
                </div>
                <div id="question-image-container" class="relative w-24 h-24 flex-shrink-0" style="display: none;">
                  <img id="live-question-image" alt="Question" class="rounded-lg object-cover w-full h-full" src=""/>
                  <button class="absolute inset-0 flex items-center justify-center bg-black/50 text-white rounded-lg opacity-0 hover:opacity-100 transition-opacity" onclick="window.expandQuestionImage()">
                    <span class="material-symbols-outlined">zoom_in</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Live Results -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <div class="flex justify-between items-center mb-6">
                <h3 class="text-brand-dark-gray dark:text-brand-white text-xl font-bold leading-normal">Live Results</h3>
                <div class="flex items-center gap-3">
                  <span class="material-symbols-outlined text-primary dark:text-brand-white">group</span>
                  <span id="response-count" class="text-brand-dark-gray dark:text-brand-white text-base font-medium">0 / 0 answered</span>
                </div>
              </div>
              <div id="results-bars" class="flex flex-col gap-3">
                <!-- Results bars will be populated dynamically -->
              </div>
            </div>
          </div>

          <!-- Sidebar (1/3) -->
          <aside class="lg:col-span-1 flex flex-col gap-6">
            <!-- Timer -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <div class="flex flex-col items-center gap-4">
                <div class="text-center">
                  <p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">Time Remaining</p>
                  <p id="live-timer-display" class="text-5xl font-bold text-primary dark:text-brand-white tracking-tighter font-mono">--:--</p>
                </div>
                <button id="restart-timer-btn" class="flex items-center justify-center gap-2 h-10 px-4 rounded-full bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">
                  <span class="material-symbols-outlined text-xl">restart_alt</span>
                  <span>Restart Timer</span>
                </button>
              </div>
            </div>

            <!-- Student Status -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm overflow-y-auto max-h-[600px]">
              <h3 class="text-brand-dark-gray dark:text-brand-white text-xl font-bold leading-normal mb-4">Student Status</h3>
              <div id="student-status-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2 gap-3">
                <!-- Student status tiles will be populated dynamically -->
              </div>
            </div>
          </aside>
        </div>
      </main>

      <!-- Right Sidebar Navigation -->
      <aside class="w-64 bg-primary flex-col items-center p-4 border-l border-primary/20 hidden lg:flex">
        <nav class="flex flex-col w-full gap-2">
          <button id="nav-polls-list" class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-brand-white/10 text-brand-white hover:bg-brand-white/20 font-semibold transition-colors text-left">
            <span class="material-symbols-outlined">ballot</span>
            <span>Polls List</span>
          </button>
          <button id="nav-create-poll" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-brand-white/70 hover:bg-brand-white/20 hover:text-brand-white transition-colors text-left">
            <span class="material-symbols-outlined">add_circle</span>
            <span>Create New Poll</span>
          </button>
        </nav>
        <div class="mt-auto w-full">
          <button id="nav-settings" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-brand-white/70 hover:bg-brand-white/20 hover:text-brand-white transition-colors text-left w-full">
            <span class="material-symbols-outlined">settings</span>
            <span>Settings</span>
          </button>
        </div>
      </aside>
    </div>
  </div>

  <!-- Poll Creator Modal -->
  <div id="poll-creator-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/20 z-10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img alt="Malvern Prep Logo" class="h-8 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png"/>
          <input type="text" id="new-poll-name" placeholder="Chapter 5 Quiz" class="bg-transparent text-brand-white text-xl font-bold border-none focus:ring-0 p-0 placeholder-brand-white/70 min-w-[300px]"/>
        </div>
        <div class="flex items-center gap-2">
          <span id="save-status" class="text-sm text-brand-white/80 mr-2">All changes saved</span>
          <button id="close-modal-btn" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-white/30 transition-colors">
            <span class="truncate">Cancel</span>
          </button>
          <button id="save-poll-btn" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-white text-primary text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray transition-colors">
            <span class="truncate">Publish Poll</span>
          </button>
        </div>
      </div>

      <div class="flex flex-grow overflow-hidden">
        <!-- Question Navigator Sidebar -->
        <aside class="w-64 flex-shrink-0 border-r border-solid border-brand-light-gray dark:border-brand-dark-gray/20 bg-brand-white dark:bg-background-dark overflow-y-auto">
          <div class="flex h-full flex-col justify-between p-4">
            <div id="question-navigator" class="flex flex-col gap-2">
              <!-- Question items will be added dynamically -->
            </div>
            <button id="add-question-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary/20 dark:bg-primary/30 text-primary dark:text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/30 dark:hover:bg-primary/40 transition-colors mt-4">
              <span class="truncate">+ Add Question</span>
            </button>
          </div>
        </aside>

        <!-- Editing Workspace -->
        <main class="flex-1 p-8 overflow-y-auto">
          <div class="form-group mb-6">
            <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white" for="class-select">Class</label>
            <select id="class-select" class="w-full max-w-md rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
              <option value="">-- Select Class --</option>
            </select>
          </div>

          <div id="question-builder-workspace">
            <!-- Question editing workspace will be populated dynamically -->
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- Student Links Modal -->
  <div id="student-links-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/70">
        <h2 class="text-brand-white text-2xl font-bold">Student Personalized Links</h2>
        <p class="text-brand-white/80 text-sm mt-1">Each student has a unique tracking link.</p>
      </div>
      <div class="p-6">
        <div id="links-container" class="max-h-[60vh] overflow-y-auto"></div>
        <div class="mt-6 pt-4 border-t border-primary/20">
          <button id="close-links-modal-btn" class="flex items-center justify-center gap-2 rounded-lg h-10 px-6 bg-primary text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
            <span>Close</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
(function(){
  // --- Main App State ---
  var mainLoader=document.getElementById('loader');
  var ALL_POLLS=[];
  var ALL_CLASSES=[];
  var CURRENT_POLL_DATA={};
  var currentStudentStatusData=[];
  var pollInterval=null;
  var questionTimer=null;
  var visualTimerInterval=null;
  var isPaused=false;
  var questionCounter=0;
  var questions=[];
  var selectedQuestionIndex=0;

  // --- Element Cache ---
  var pollSelect=document.getElementById('poll-select');
  var startPollBtn=document.getElementById('start-poll-btn');
  var dashboard=document.getElementById('dashboard');
  var liveView=document.getElementById('live-view');
  var headerDefault=document.getElementById('header-default');
  var headerLive=document.getElementById('header-live');
  var modal=document.getElementById('poll-creator-modal');
  var linksModal=document.getElementById('student-links-modal');

  // --- Initialization ---
  google.charts.load('current',{'packages':['corechart']});
  google.charts.setOnLoadCallback(loadInitialData);

  // --- Event Listeners ---
  document.getElementById('open-creator-btn').onclick=openPollCreator;
  document.getElementById('nav-create-poll').onclick=openPollCreator;
  document.getElementById('nav-polls-list').onclick=showDashboard;
  document.getElementById('close-modal-btn').onclick=closePollCreator;
  document.getElementById('close-links-modal-btn').onclick=closeLinksModal;
  document.getElementById('add-question-btn').onclick=addQuestion;
  document.getElementById('save-poll-btn').onclick=savePoll;
  startPollBtn.onclick=onStartPoll;
  document.getElementById('header-start-btn').onclick=onStartPoll;
  document.getElementById('header-pause-btn').onclick=onStopPoll;
  document.getElementById('header-stop-btn').onclick=onEndPoll;
  document.getElementById('header-next-btn').onclick=onNextQuestion;
  document.getElementById('header-skip-btn').onclick=onNextQuestion;
  document.getElementById('restart-timer-btn').onclick=onRestartTimer;
  document.getElementById('send-link-btn').onclick=onSendLink;
  document.getElementById('view-links-btn').onclick=onViewLinks;

  function showDashboard(){
    dashboard.style.display='grid';
    liveView.style.display='none';
    headerDefault.style.display='flex';
    headerLive.style.display='none';
  }

  // --- Initial Data Load ---
  function loadInitialData(){
    google.script.run
      .withSuccessHandler(onDashboardDataLoaded)
      .withFailureHandler(handleError)
      .getTeacherDashboardData();
  }

  function onDashboardDataLoaded(data){
    mainLoader.style.display='none';
    ALL_CLASSES=data.classes||[];
    ALL_POLLS=data.polls||[];

    var classSelect=document.getElementById('class-select');
    classSelect.innerHTML='<option value="">-- Select Class --</option>';
    ALL_CLASSES.forEach(function(className){
      var opt=document.createElement('option');
      opt.value=className;
      opt.textContent=className;
      classSelect.appendChild(opt);
    });

    updatePollDropdown();
  }

  function updatePollDropdown(){
    pollSelect.innerHTML='<option value="">-- Choose a poll --</option>';
    ALL_POLLS.forEach(function(poll){
      var opt=document.createElement('option');
      opt.value=poll.pollId;
      opt.textContent=poll.pollName+' ('+poll.className+') - '+poll.questions.length+' questions';
      pollSelect.appendChild(opt);
    });
    pollSelect.onchange=onPollSelectChange;
    onPollSelectChange();
  }

  function onPollSelectChange(){
    var pollId=pollSelect.value;
    var sendBtn=document.getElementById('send-link-btn');
    var viewBtn=document.getElementById('view-links-btn');
    if(pollId){
      var selectedPoll=ALL_POLLS.find(function(p){return p.pollId===pollId;});
      if(selectedPoll){
        sendBtn.disabled=false;
        viewBtn.disabled=false;
        sendBtn.dataset.className=selectedPoll.className;
        viewBtn.dataset.className=selectedPoll.className;
      }
    } else {
      sendBtn.disabled=true;
      viewBtn.disabled=true;
    }
  }

  // --- Poll Lifecycle Controls ---
  function onStartPoll(){
    var pollId=pollSelect.value;
    if(!pollId){alert("Please select a poll first.");return;}
    startPollBtn.disabled=true;
    startMasterTimer();
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .startPoll(pollId);
  }

  function onStopPoll(){
    clearTimeout(questionTimer);
    stopVisualTimer();
    google.script.run
      .withSuccessHandler(function(data){
        isPaused=true;
        updateLiveView(data);
      })
      .withFailureHandler(handleError)
      .stopPoll();
  }

  function onNextQuestion(){
    if(pollInterval)clearInterval(pollInterval);
    isPaused=false;
    startMasterTimer();
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .nextQuestion();
  }

  function onEndPoll(){
    if(!confirm('Are you sure you want to end this poll completely?'))return;
    clearTimeout(questionTimer);
    stopVisualTimer();
    if(pollInterval)clearInterval(pollInterval);
    google.script.run
      .withSuccessHandler(function(data){
        showDashboard();
      })
      .withFailureHandler(handleError)
      .closePoll();
  }

  function onRestartTimer(){
    var timerInput=document.getElementById('poll-timer-input');
    var seconds=parseInt(timerInput.value,10);
    if(seconds>0&&seconds<=600){
      startMasterTimer();
    }
  }

  // --- Live View & Data Polling ---
  function updateLiveView(data){
    mainLoader.style.display='none';
    startPollBtn.disabled=false;

    if(data.status==="CLOSED"){
      showDashboard();
      return;
    }

    if(data.error){handleError(data.error);return;}

    CURRENT_POLL_DATA.pollId=pollSelect.value;
    CURRENT_POLL_DATA.questionIndex=data.questionIndex;
    CURRENT_POLL_DATA.correctAnswer=data.correctAnswer;
    CURRENT_POLL_DATA.totalQuestions=data.totalQuestions;

    // Show live view
    dashboard.style.display='none';
    liveView.style.display='grid';
    headerDefault.style.display='none';
    headerLive.style.display='flex';

    // Update header
    document.getElementById('header-poll-name').textContent=data.pollName;

    // Update question dots
    updateQuestionDots(data.questionIndex,data.totalQuestions);

    // Show/hide pause/start buttons
    if(isPaused){
      document.getElementById('header-start-btn').style.display='flex';
      document.getElementById('header-pause-btn').style.display='none';
    } else {
      document.getElementById('header-start-btn').style.display='none';
      document.getElementById('header-pause-btn').style.display='flex';
    }

    // Update question display
    document.getElementById('live-question-info').textContent='Question '+(data.questionIndex+1)+' of '+data.totalQuestions;
    document.getElementById('live-question-text').textContent=data.questionText;

    // Handle question image
    if(data.questionImageURL){
      document.getElementById('question-image-container').style.display='block';
      document.getElementById('live-question-image').src=data.questionImageURL;
    } else {
      document.getElementById('question-image-container').style.display='none';
    }

    // Update response count
    document.getElementById('response-count').textContent=data.totalResponses+' / '+data.totalStudents+' answered';

    // Update results bars
    renderResultsBars(data.results,data.correctAnswer,data.studentStatusList);

    // Update student status
    currentStudentStatusData=data.studentStatusList;
    renderStudentStatus();

    if(pollInterval)clearInterval(pollInterval);
    if(!isPaused){
      pollInterval=setInterval(pollForResults,2500);
    }
  }

  function updateQuestionDots(current,total){
    var dotsContainer=document.getElementById('question-dots');
    dotsContainer.innerHTML='';
    for(var i=0;i<total;i++){
      var dot=document.createElement('span');
      dot.className='h-2 w-2 rounded-full '+(i===current?'bg-primary':'bg-primary/50');
      dotsContainer.appendChild(dot);
    }
  }

  function renderResultsBars(results,correctAnswer,studentsList){
    var container=document.getElementById('results-bars');
    container.innerHTML='';

    if(!results||Object.keys(results).length===0){
      container.innerHTML='<p class="text-center text-gray-500 py-4">Waiting for responses...</p>';
      return;
    }

    var total=Object.values(results).reduce(function(a,b){return a+b;},0);

    Object.keys(results).forEach(function(answer){
      var count=results[answer];
      var percentage=total>0?Math.round((count/total)*100):0;
      var isCorrect=answer===correctAnswer;

      var barDiv=document.createElement('div');
      if(isCorrect){
        barDiv.className='rounded-lg border-2 border-primary';
      }

      var correctClass=isCorrect?'correct-answer-bg':'';
      var bgClass=isCorrect?'bg-primary':'bg-primary/20 dark:bg-primary/50';
      var textClass=isCorrect?'text-brand-white mix-blend-difference':'text-brand-dark-gray dark:text-brand-white';

      var barHtml='<div class="relative flex items-center min-h-[3rem] '+correctClass+' rounded-lg bg-brand-light-gray dark:bg-brand-dark-gray/50 overflow-hidden cursor-pointer hover:bg-gray-200 dark:hover:bg-brand-dark-gray/60 transition-colors">';
      barHtml+='<div class="absolute inset-y-0 left-0 '+bgClass+'" style="width: '+percentage+'%;"></div>';
      barHtml+='<div class="relative flex w-full items-start justify-between p-3">';
      
      if(isCorrect){
        barHtml+='<div class="flex items-start gap-2"><span class="font-serif font-medium '+textClass+' text-sm">'+escapeHtml(answer)+'</span>';
        barHtml+='<span class="material-symbols-outlined '+textClass+' text-xl">check_circle</span></div>';
      } else {
        barHtml+='<span class="font-serif font-medium '+textClass+' text-sm">'+escapeHtml(answer)+'</span>';
      }
      
      barHtml+='<span class="font-bold '+textClass+' shrink-0 ml-4 text-sm">'+percentage+'%</span>';
      barHtml+='</div></div>';

      // Add student names who selected this answer (if correct)
      if(isCorrect){
        var studentsWithAnswer=studentsList.filter(function(s){return s.answer===answer;});
        if(studentsWithAnswer.length>0){
          barHtml+='<div class="bg-primary/5 dark:bg-primary/10 p-3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 rounded-b-md">';
          studentsWithAnswer.forEach(function(student){
            barHtml+='<span class="text-xs text-primary dark:text-brand-white/80 font-medium px-2 py-1 bg-primary/10 dark:bg-primary/20 rounded">'+escapeHtml(student.name)+'</span>';
          });
          barHtml+='</div>';
        }
      }

      barDiv.innerHTML=barHtml;
      container.appendChild(barDiv);
    });
  }

  function renderStudentStatus(){
    var grid=document.getElementById('student-status-grid');
    if(!grid)return;

    grid.innerHTML='';
    currentStudentStatusData.forEach(function(student){
      var tile=document.createElement('div');

      if(student.status==='Submitted'){
        tile.className='flex items-center justify-between p-2.5 rounded-lg bg-green-500/10 dark:bg-green-500/20 gap-2';
        tile.innerHTML='<span class="text-sm font-medium text-green-800 dark:text-green-300 truncate">'+escapeHtml(student.name)+'</span>'+
          '<button class="reset-btn flex-shrink-0 flex items-center justify-center gap-1 h-7 px-2.5 rounded-md bg-green-600 text-brand-white text-xs font-bold hover:bg-green-700 transition-colors" data-email="'+student.email+'">'+
          '<span class="material-symbols-outlined text-sm">refresh</span><span>Reset</span></button>';
      } else if(student.status==='LOCKED'){
        tile.className='flex items-center justify-between p-2.5 rounded-lg bg-orange-500/10 dark:bg-orange-500/20 gap-2';
        tile.innerHTML='<div class="flex flex-col text-left flex-grow min-w-0"><span class="text-sm font-medium text-orange-800 dark:text-orange-300 truncate">'+escapeHtml(student.name)+'</span></div>'+
          '<button class="unlock-btn flex-shrink-0 flex items-center justify-center gap-1 h-7 px-2.5 rounded-md bg-orange-500/20 text-orange-700 dark:bg-orange-400/20 dark:text-orange-300 text-xs font-bold hover:bg-orange-500/30 transition-colors" data-email="'+student.email+'">'+
          '<span class="material-symbols-outlined text-sm">lock_open</span><span>Unlock</span></button>';
      } else if(student.status==='Waiting...'){
        tile.className='flex items-center justify-center p-2.5 rounded-lg bg-gray-500/10 dark:bg-gray-500/20 text-center';
        tile.innerHTML='<span class="text-sm font-medium text-gray-600 dark:text-gray-300">'+escapeHtml(student.name)+'</span>';
      } else {
        tile.className='flex items-center justify-center p-2.5 rounded-lg bg-red-500/10 dark:bg-red-500/20 text-center';
        tile.innerHTML='<span class="text-sm font-medium text-red-800 dark:text-red-300">'+escapeHtml(student.name)+'</span>';
      }

      grid.appendChild(tile);
    });

    // Setup unlock listeners
    grid.querySelectorAll('.unlock-btn').forEach(function(btn){
      btn.onclick=function(){
        var email=this.dataset.email;
        var pollId=CURRENT_POLL_DATA.pollId;
        if(!email||!pollId)return;
        this.disabled=true;
        this.querySelector('span:last-child').textContent='Unlocking...';
        google.script.run
          .withSuccessHandler(pollForResults)
          .withFailureHandler(handleError)
          .unlockStudent(email,pollId);
      };
    });

    grid.querySelectorAll('.reset-btn').forEach(function(btn){
      btn.onclick=function(){
        var email=this.dataset.email;
        var pollId=CURRENT_POLL_DATA.pollId;
        var questionIndex=CURRENT_POLL_DATA.questionIndex;
        if(!email||pollId===undefined||questionIndex===undefined)return;
        var button=this;
        button.disabled=true;
        button.querySelector('span:last-child').textContent='Resetting...';
        google.script.run
          .withSuccessHandler(pollForResults)
          .withFailureHandler(function(error){
            handleError(error);
            button.disabled=false;
            button.querySelector('span:last-child').textContent='Reset';
          })
          .resetStudentResponse(email,pollId,questionIndex);
      };
    });
  }

  function pollForResults(){
    if(isPaused)return;
    var pollId=CURRENT_POLL_DATA.pollId;
    var questionIndex=CURRENT_POLL_DATA.questionIndex;
    if(pollId===undefined||questionIndex===undefined)return;

    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(function(e){console.warn('Poll refresh error:',e);})
      .getLivePollData(pollId,questionIndex);
  }

  // --- Timer Controls ---
  function startMasterTimer(){
    clearTimeout(questionTimer);
    var timerInput=document.getElementById('poll-timer-input');
    var seconds=parseInt(timerInput.value,10);

    if(seconds>0&&seconds<=600){
      startVisualTimer(seconds);
      questionTimer=setTimeout(onStopPoll,seconds*1000);
    } else {
      stopVisualTimer();
    }
  }

  function startVisualTimer(duration){
    stopVisualTimer();
    var timerDisplay=document.getElementById('live-timer-display');
    if(!timerDisplay)return;

    var timer=duration;
    var updateDisplay=function(){
      var minutes=Math.floor(timer/60);
      var seconds=timer%60;
      timerDisplay.textContent=minutes+':'+(seconds<10?'0':'')+seconds;

      if(timer<=10){
        timerDisplay.className='text-5xl font-bold text-red-600 dark:text-red-400 tracking-tighter font-mono animate-pulse';
      } else {
        timerDisplay.className='text-5xl font-bold text-primary dark:text-brand-white tracking-tighter font-mono';
      }

      if(timer<=0){
        stopVisualTimer();
        timerDisplay.textContent="Time's Up!";
      }
      timer--;
    };
    updateDisplay();
    visualTimerInterval=setInterval(updateDisplay,1000);
  }

  function stopVisualTimer(){
    clearInterval(visualTimerInterval);
    var timerDisplay=document.getElementById('live-timer-display');
    if(timerDisplay){
      timerDisplay.textContent='--:--';
      timerDisplay.className='text-5xl font-bold text-primary dark:text-brand-white tracking-tighter font-mono';
    }
  }

  // --- Student Link Controls ---
  function onSendLink(){
    var btn=document.getElementById('send-link-btn');
    var className=btn.dataset.className;
    if(!className){alert('Please select a poll first.');return;}
    if(!confirm('This will email a new, unique poll link to all students in '+className+'. Are you sure?'))return;

    btn.disabled=true;
    btn.innerHTML='<div class="h-5 w-5 animate-spin rounded-full border-2 border-white border-t-transparent"></div>';

    google.script.run
      .withSuccessHandler(function(response){
        alert('✅ Successfully sent '+response.count+' poll links.');
        btn.disabled=false;
        btn.innerHTML='<span class="material-symbols-outlined text-xl">mail</span><span class="truncate">Send Student Links</span>';
      })
      .withFailureHandler(function(err){
        handleError(err);
        btn.disabled=false;
        btn.innerHTML='<span class="material-symbols-outlined text-xl">mail</span><span class="truncate">Send Student Links</span>';
      })
      .sendPollLinkToClass(className);
  }

  function onViewLinks(){
    var btn=document.getElementById('view-links-btn');
    var className=btn.dataset.className;
    if(!className){alert('Please select a poll first.');return;}
    btn.disabled=true;

    google.script.run
      .withSuccessHandler(function(response){
        if(!response.success)return handleError(new Error('Could not load links'));

        var container=document.getElementById('links-container');
        var html='<div class="overflow-x-auto"><table class="w-full border-collapse">';
        html+='<thead><tr class="bg-brand-light-gray dark:bg-brand-dark-gray/50 border-b-2 border-brand-light-gray dark:border-brand-dark-gray/40">';
        html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Student Name</th>';
        html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Email</th>';
        html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Link</th>';
        html+='<th class="px-4 py-3 text-center text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Actions</th>';
        html+='</tr></thead><tbody>';

        response.links.forEach(function(link){
          html+='<tr class="border-b border-brand-light-gray/50 dark:border-brand-dark-gray/20 hover:bg-brand-light-gray/30 dark:hover:bg-brand-dark-gray/10">';
          html+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+escapeHtml(link.name)+'</td>';
          html+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+escapeHtml(link.email)+'</td>';
          html+='<td class="px-4 py-3 text-xs font-mono text-brand-dark-gray/70 dark:text-brand-white/70 max-w-[200px] truncate" title="'+escapeHtml(link.url)+'">'+(link.hasActiveLink?escapeHtml(link.url):'<i class="text-gray-400">No active link</i>')+'</td>';
          html+='<td class="px-4 py-3 text-center">';
          if(link.hasActiveLink){
            html+='<button class="copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors" data-url="'+escapeHtml(link.url)+'">Copy</button>';
          }
          html+='</td></tr>';
        });

        html+='</tbody></table></div>';
        container.innerHTML=html;

        container.querySelectorAll('.copy-link-btn').forEach(function(btn){
          btn.onclick=function(){
            var url=this.dataset.url;
            try{
              var tempInput=document.createElement('input');
              document.body.appendChild(tempInput);
              tempInput.value=url;
              tempInput.select();
              document.execCommand('copy');
              document.body.removeChild(tempInput);

              btn.textContent='✓ Copied!';
              btn.className='copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-green-600 text-brand-white';
              setTimeout(function(){
                btn.textContent='Copy';
                btn.className='copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors';
              }, 2000);
            } catch(err) {
              alert('Could not copy link. Please copy it manually.');
            }
          };
        });

        linksModal.style.display='flex';
        btn.disabled=false;
      })
      .withFailureHandler(function(err){
        handleError(err);
        btn.disabled=false;
      })
      .getStudentLinksForClass(className);
  }

  function closeLinksModal(){
    linksModal.style.display='none';
  }

  // --- Poll Creator Modal ---
  function openPollCreator(){
    questionCounter=0;
    questions=[];
    selectedQuestionIndex=0;
    document.getElementById('new-poll-name').value='';
    document.getElementById('class-select').value='';
    addQuestion();
    renderQuestionNavigator();
    renderQuestionWorkspace();
    modal.style.display='flex';
  }

  function closePollCreator(){
    modal.style.display='none';
    questions=[];
    questionCounter=0;
    selectedQuestionIndex=0;
  }

  function addQuestion(){
    var newQuestion={
      questionText:'',
      questionImage:null,
      answers:[
        {text:'',image:null},
        {text:'',image:null}
      ],
      correctAnswerIndex:0
    };
    questions.push(newQuestion);
    selectedQuestionIndex=questions.length-1;
    renderQuestionNavigator();
    renderQuestionWorkspace();
  }

  function deleteQuestion(index){
    if(questions.length<=1){
      alert('A poll must have at least one question.');
      return;
    }
    questions.splice(index,1);
    selectedQuestionIndex=Math.max(0,Math.min(selectedQuestionIndex,questions.length-1));
    renderQuestionNavigator();
    renderQuestionWorkspace();
  }

  function renderQuestionNavigator(){
    var nav=document.getElementById('question-navigator');
    nav.innerHTML='';
    
    questions.forEach(function(q,index){
      var isSelected=index===selectedQuestionIndex;
      var div=document.createElement('div');
      div.className='group relative flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer '+(isSelected?'bg-primary/20 dark:bg-primary/30':'hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10');
      
      var html='<span class="material-symbols-outlined '+(isSelected?'text-brand-dark-gray dark:text-brand-white':'text-brand-dark-gray/50 dark:text-brand-white/50')+'">drag_indicator</span>';
      html+='<p class="'+(isSelected?'text-primary dark:text-brand-white':'text-brand-dark-gray dark:text-brand-white')+' text-sm font-medium leading-normal">Question '+(index+1)+'</p>';
      
      if(questions.length>1){
        html+='<div class="absolute right-2 opacity-0 group-hover:opacity-100 transition-opacity">';
        html+='<button class="p-1 rounded-full hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10" data-index="'+index+'">';
        html+='<span class="material-symbols-outlined text-brand-dark-gray dark:text-brand-white text-base">close</span>';
        html+='</button></div>';
      }
      
      div.innerHTML=html;
      
      div.onclick=function(e){
        if(e.target.classList.contains('material-symbols-outlined')&&e.target.textContent==='close')return;
        selectedQuestionIndex=index;
        renderQuestionNavigator();
        renderQuestionWorkspace();
      };
      
      var closeBtn=div.querySelector('button[data-index]');
      if(closeBtn){
        closeBtn.onclick=function(e){
          e.stopPropagation();
          deleteQuestion(parseInt(this.dataset.index));
        };
      }
      
      nav.appendChild(div);
    });
  }

  function renderQuestionWorkspace(){
    var workspace=document.getElementById('question-builder-workspace');
    var question=questions[selectedQuestionIndex];
    
    var html='<div class="max-w-4xl mx-auto">';
    html+='<div class="flex flex-wrap justify-between gap-3 mb-6">';
    html+='<div class="flex min-w-72 flex-col gap-1">';
    html+='<p class="text-brand-dark-gray dark:text-brand-white tracking-light text-[32px] font-bold leading-tight">Question '+(selectedQuestionIndex+1)+'</p>';
    html+='<p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm font-normal leading-normal">Edit the question and answer choices below.</p>';
    html+='</div></div>';
    
    html+='<div class="bg-brand-white dark:bg-brand-dark-gray/20 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/30 p-6 shadow-sm mb-6">';
    html+='<label class="flex flex-col w-full">';
    html+='<p class="text-brand-dark-gray dark:text-brand-white text-base font-medium leading-normal pb-2">Question Text</p>';
    html+='<textarea id="question-text-input" class="form-input flex w-full min-w-0 flex-1 resize-y overflow-hidden rounded-lg text-brand-dark-gray dark:text-brand-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 focus:border-primary min-h-36 placeholder:text-brand-dark-gray/50 dark:placeholder:text-brand-white/50 p-[15px] text-base font-normal leading-normal" placeholder="Type your question here...">'+escapeHtml(question.questionText)+'</textarea>';
    html+='</label>';
    html+='<div class="flex mt-4">';
    html+='<label class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-light-gray dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white gap-2 pl-3 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/60 transition-colors">';
    html+='<span class="material-symbols-outlined text-xl">image</span>';
    html+='<span class="truncate">Upload Image</span>';
    html+='<input type="file" class="hidden" accept="image/*" id="question-image-input">';
    html+='</label></div>';
    
    if(question.questionImage){
      html+='<img src="'+getImagePreviewUrl(question.questionImage)+'" class="mt-4 rounded-lg max-w-full h-auto"/>';
    }
    
    html+='</div>';
    
    html+='<div class="bg-brand-white dark:bg-brand-dark-gray/20 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/30 p-6 shadow-sm">';
    html+='<p class="text-brand-dark-gray dark:text-brand-white text-base font-medium leading-normal pb-4">Answer Choices</p>';
    html+='<div class="flex flex-col gap-4">';
    
    question.answers.forEach(function(answer,aIndex){
      html+=renderAnswerChoice(answer,aIndex,question.correctAnswerIndex===aIndex);
    });
    
    html+='</div>';
    html+='<div class="mt-4">';
    html+='<button id="add-answer-btn" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-light-gray dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/60 transition-colors">';
    html+='<span class="truncate">+ Add Answer Choice</span>';
    html+='</button></div></div></div>';
    
    workspace.innerHTML=html;
    
    // Attach event listeners
    document.getElementById('question-text-input').oninput=function(){
      questions[selectedQuestionIndex].questionText=this.value;
    };
    
    var qImgInput=document.getElementById('question-image-input');
    if(qImgInput){
      qImgInput.onchange=function(){
        if(this.files&&this.files[0]){
          questions[selectedQuestionIndex].questionImage=this.files[0];
          renderQuestionWorkspace();
        }
      };
    }
    
    document.getElementById('add-answer-btn').onclick=function(){
      questions[selectedQuestionIndex].answers.push({text:'',image:null});
      renderQuestionWorkspace();
    };
    
    // Attach answer choice listeners
    var answerInputs=workspace.querySelectorAll('.answer-text-input');
    answerInputs.forEach(function(input,index){
      input.oninput=function(){
        questions[selectedQuestionIndex].answers[index].text=this.value;
      };
    });
    
    var correctRadios=workspace.querySelectorAll('.correct-radio');
    correctRadios.forEach(function(radio,index){
      radio.onchange=function(){
        if(this.checked){
          questions[selectedQuestionIndex].correctAnswerIndex=index;
        }
      };
    });
    
    var deleteButtons=workspace.querySelectorAll('.delete-answer-btn');
    deleteButtons.forEach(function(btn,index){
      btn.onclick=function(){
        deleteAnswer(index);
      };
    });
    
    var answerImageInputs=workspace.querySelectorAll('.answer-image-input');
    answerImageInputs.forEach(function(input,index){
      input.onchange=function(){
        if(this.files&&this.files[0]){
          questions[selectedQuestionIndex].answers[index].image=this.files[0];
          renderQuestionWorkspace();
        }
      };
    });
  }

  function renderAnswerChoice(answer,index,isCorrect){
    var html='<div class="flex items-center gap-3">';
    html+='<label class="relative flex items-center justify-center cursor-pointer" title="Set as correct answer">';
    html+='<input class="correct-radio peer h-5 w-5 cursor-pointer appearance-none rounded-full border border-brand-light-gray dark:border-brand-white/30 checked:border-primary checked:bg-primary transition-all" name="correct_answer" type="radio" '+(isCorrect?'checked':'')+'/>';
    html+='<span class="material-symbols-outlined absolute text-brand-white transition-opacity opacity-0 peer-checked:opacity-100 text-sm">check</span>';
    html+='</label>';
    html+='<input class="answer-text-input form-input flex-1 rounded-lg text-brand-dark-gray dark:text-brand-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 focus:border-primary placeholder:text-brand-dark-gray/50 dark:placeholder:text-brand-white/50 p-3 text-base" placeholder="Answer '+String.fromCharCode(65+index)+'" type="text" value="'+escapeHtml(answer.text)+'"/>';
    html+='<label class="p-2 rounded-lg hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10 transition-colors cursor-pointer" title="Upload image for this answer">';
    html+='<span class="material-symbols-outlined text-brand-dark-gray/60 dark:text-brand-white/60">image</span>';
    html+='<input type="file" class="answer-image-input hidden" accept="image/*">';
    html+='</label>';
    
    if(questions[selectedQuestionIndex].answers.length>2){
      html+='<button class="delete-answer-btn p-2 rounded-lg hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10 transition-colors" title="Remove this answer">';
      html+='<span class="material-symbols-outlined text-brand-dark-gray/60 dark:text-brand-white/60">delete</span>';
      html+='</button>';
    } else {
      html+='<div class="w-10"></div>';
    }
    
    html+='</div>';
    
    if(answer.image){
      html+='<img src="'+getImagePreviewUrl(answer.image)+'" class="mt-2 rounded-lg max-w-[200px] h-auto"/>';
    }
    
    return html;
  }

  function deleteAnswer(index){
    if(questions[selectedQuestionIndex].answers.length<=2){
      alert('A question must have at least two answer choices.');
      return;
    }
    questions[selectedQuestionIndex].answers.splice(index,1);
    if(questions[selectedQuestionIndex].correctAnswerIndex>=index){
      questions[selectedQuestionIndex].correctAnswerIndex=Math.max(0,questions[selectedQuestionIndex].correctAnswerIndex-1);
    }
    renderQuestionWorkspace();
  }

  function getImagePreviewUrl(image){
    if(image instanceof File){
      return URL.createObjectURL(image);
    }
    if(typeof image==='string'&&image){
      return image;
    }
    return'';
  }

  // --- Poll & Image Uploader ---
  function savePoll(){
    var savePollBtn=document.getElementById('save-poll-btn');
    savePollBtn.disabled=true;
    savePollBtn.innerHTML='<div class="h-5 w-5 animate-spin rounded-full border-2 border-primary border-t-transparent"></div><span>Saving...</span>';

    var pollName=document.getElementById('new-poll-name').value.trim();
    var className=document.getElementById('class-select').value;

    if(!pollName||!className){
      alert("Please enter a poll name and select a class.");
      savePollBtn.disabled=false;
      savePollBtn.innerHTML='<span class="truncate">Publish Poll</span>';
      return;
    }

    if(questions.length===0){
      alert("Please add at least one question.");
      savePollBtn.disabled=false;
      savePollBtn.innerHTML='<span class="truncate">Publish Poll</span>';
      return;
    }

    var uploadTasks=[];
    var questionsToSave=JSON.parse(JSON.stringify(questions));

    questions.forEach(function(q,qIndex){
      if(q.questionImage instanceof File){
        uploadTasks.push(uploadFile(q.questionImage).then(function(url){
          questionsToSave[qIndex].questionImage=url;
          questionsToSave[qIndex].questionImageURL=url;
        }));
      }

      q.answers.forEach(function(a,aIndex){
        if(a.image instanceof File){
          uploadTasks.push(uploadFile(a.image).then(function(url){
            questionsToSave[qIndex].answers[aIndex].image=url;
            questionsToSave[qIndex].answers[aIndex].imageURL=url;
          }));
        }
      });
    });

    Promise.all(uploadTasks).then(function(){
      var pollData={
        pollName:pollName,
        className:className,
        questions:questionsToSave.map(function(q){
          return{
            questionText:q.questionText,
            questionImage:q.questionImageURL||q.questionImage||null,
            questionImageURL:q.questionImageURL||q.questionImage||null,
            options:q.answers.map(function(a){
              var imageUrl=a.imageURL||a.image||null;
              return{text:a.text,image:imageUrl,imageURL:imageUrl};
            }),
            correctAnswer:q.answers[q.correctAnswerIndex]?q.answers[q.correctAnswerIndex].text:null
          };
        })
      };

      google.script.run
        .withSuccessHandler(function(newPollsList){
          ALL_POLLS=newPollsList;
          updatePollDropdown();
          savePollBtn.disabled=false;
          savePollBtn.innerHTML='<span class="truncate">Publish Poll</span>';
          closePollCreator();
          alert('✅ Poll created successfully with '+questions.length+' questions!');
        })
        .withFailureHandler(function(error){
          handleError(error);
          savePollBtn.disabled=false;
          savePollBtn.innerHTML='<span class="truncate">Publish Poll</span>';
        })
        .createNewPoll(pollData.pollName,pollData.className,pollData.questions);
    }).catch(function(err){
      alert('❌ Upload error: '+err.message);
      savePollBtn.disabled=false;
      savePollBtn.innerHTML='<span class="truncate">Publish Poll</span>';
    });
  }

  function fileToBase64(file){
    return new Promise(function(resolve,reject){
      var reader=new FileReader();
      reader.readAsDataURL(file);
      reader.onload=function(){
        resolve(reader.result);
      };
      reader.onerror=function(error){
        reject(error);
      };
    });
  }

  function uploadFile(file){
    return new Promise(function(resolve,reject){
      fileToBase64(file).then(function(dataUrl){
        google.script.run
          .withSuccessHandler(function(response){
            if(response.success){
              resolve(response.url);
            } else {
              reject(new Error(response.error||'Upload failed'));
            }
          })
          .withFailureHandler(reject)
          .uploadImageToDrive(dataUrl,file.name);
      }).catch(reject);
    });
  }

  // --- Utilities ---
  function escapeHtml(text){
    if(!text)return'';
    var div=document.createElement('div');
    div.textContent=text;
    return div.innerHTML;
  }

  function handleError(error){
    mainLoader.style.display='none';
    console.error('Error:',error);
    alert('Error: '+(error.message||error));
  }

  // Expand question image in modal
  window.expandQuestionImage=function(){
    var imgSrc=document.getElementById('live-question-image').src;
    var modalHtml='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;" onclick="this.remove()">';
    modalHtml+='<img src="'+imgSrc+'" style="max-width:90%;max-height:90%;"/>';
    modalHtml+='</div>';
    document.body.insertAdjacentHTML('beforeend',modalHtml);
  };

  console.log('✓ Teacher Panel Ready');
})();
  </script>
</body>
</html>
