<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veritas Live Poll - Student</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#002d6b",
            "brand-blue": "#002d6b",
            "brand-accent": "#0066cc",
            "brand-white": "#ffffff",
            "brand-light-gray": "#d9e0e7",
            "brand-dark-gray": "#242424",
            "background-light": "#f5f7f8",
            "background-dark": "#0f1723"
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
            serif: ["Noto Serif", "serif"]
          },
          borderRadius: {
            DEFAULT: "0.25rem",
            lg: "0.5rem",
            xl: "0.75rem",
            full: "9999px"
          },
          animation: {
            'fade-in': 'fade-in 0.6s ease-out forwards',
            'spin-slow': 'spin 3s linear infinite'
          },
          keyframes: {
            'fade-in': {
              'from': { opacity: '0', transform: 'translateY(10px)' },
              'to': { opacity: '1', transform: 'translateY(0)' }
            }
          }
        }
      }
    };
  </script>
  <script>window.SESSION_TOKEN = '<?= sessionToken ?>';</script>
</head>
<body class="font-display bg-gradient-to-br from-brand-blue to-brand-accent text-white min-h-screen">
  <!-- Header - Subtle overlay style -->
  <header class="absolute top-0 left-0 right-0 z-10 flex items-center justify-between px-6 py-4">
    <div class="flex items-center gap-3">
      <img alt="Malvern Prep Logo" class="h-12 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/main/Malvern%20Logo.png"/>
      <div class="flex flex-col">
        <h1 class="text-white text-xl font-extrabold tracking-[0.15em] uppercase">Veritas</h1>
        <p class="text-white/70 text-xs tracking-wide">Live Poll</p>
      </div>
    </div>
    <div id="loader" class="loader" style="display: none;">
      <div class="h-6 w-6 animate-spin rounded-full border-2 border-white/80 border-t-transparent"></div>
    </div>
  </header>

  <main class="flex flex-col items-center justify-center min-h-screen p-6 pt-24 space-y-4">
    <div id="connectivity-banner" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-lg flex items-center gap-3 rounded-xl border border-amber-300 bg-amber-50 px-4 py-3 text-amber-800 shadow-lg transition-all duration-200 backdrop-blur-sm">
      <span id="connectivity-icon" class="material-symbols-outlined text-2xl">sync</span>
      <div class="flex flex-col text-left flex-1">
        <span id="connectivity-message" class="text-sm font-semibold">Reconnecting... your poll data is catching up.</span>
        <span id="connectivity-submessage" class="text-xs text-amber-700/80 opacity-0"></span>
      </div>
    </div>
    <!-- Entry Screen -->
    <div id="entry-screen" class="w-full max-w-3xl mx-auto text-center animate-fade-in">
      <div class="bg-black/20 backdrop-blur-lg rounded-xl shadow-2xl border border-white/10 p-8 sm:p-12">
        <p class="text-white text-xl mb-10 leading-relaxed">
          Welcome! Click <strong>&quot;Begin Session&quot;</strong> to join now.
        </p>

        <!-- Important Security Notice -->
        <div class="bg-white/10 border-2 border-yellow-300 rounded-lg p-8 mb-10 text-center">
          <h4 class="text-yellow-300 text-2xl font-bold mb-4 tracking-wide">
            <span class="text-3xl">&#9888;</span> ATTENTION
          </h4>
          <p class="text-white text-lg leading-relaxed">
            Do <strong class="underline">NOT</strong> switch tabs, open other windows, or exit fullscreen mode &mdash; your session will be locked.
          </p>
        </div>

        <div class="flex justify-center">
          <button id="start-session-btn" class="flex items-center justify-center gap-3 px-12 py-4 rounded-lg bg-green-500 text-white text-xl font-bold hover:bg-green-600 transition-transform duration-300 hover:scale-105 shadow-lg">
            <span class="material-symbols-outlined text-2xl">play_circle</span>
            <span>Begin Session</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Student App Container -->
    <div class="w-full max-w-6xl mx-auto" id="student-container" style="display: none;">
      <div id="student-loader" class="text-center py-12 animate-fade-in" style="display: block;">
        <img src="https://raw.githubusercontent.com/stephenborish/veritasassets/main/Malvern%20Logo.png" alt="Malvern Prep" class="h-16 mx-auto mb-4" />
        <div class="text-3xl font-extrabold tracking-[0.2em] uppercase text-white mb-8">VERITAS</div>
        <div class="h-16 w-16 animate-spin rounded-full border-4 border-white/30 border-t-white mx-auto mb-4"></div>
        <p class="text-white/90 text-lg">Preparing your secure session...</p>
      </div>

      <!-- Status Container -->
      <div id="status-container" class="text-center py-12 animate-fade-in" style="display: none;">
        <div class="bg-black/20 backdrop-blur-lg rounded-xl border border-white/10 p-8 sm:p-12 shadow-2xl max-w-3xl mx-auto">
          <span class="material-symbols-outlined text-6xl text-white mb-4 inline-block">schedule</span>
          <h2 id="status-message" class="text-white text-2xl font-semibold">Connecting to poll...</h2>
          <p id="status-submessage" class="text-white/70 text-lg mt-4" style="display: none;"></p>
          <div id="resume-controls" class="mt-8 space-y-3" style="display: none;">
            <p class="text-white/90 text-base leading-relaxed">
              Click below to return to fullscreen and resume the poll.
            </p>
            <button id="resume-session-btn" class="mx-auto flex items-center justify-center gap-2 px-8 py-4 rounded-lg bg-green-500 text-white text-lg font-bold hover:bg-green-600 transition-transform duration-300 hover:scale-105 shadow-lg">
              <span class="material-symbols-outlined text-xl">fullscreen</span>
              <span>Resume Poll</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Question Container -->
      <div id="question-container" class="bg-black/20 backdrop-blur-lg rounded-xl border border-white/10 shadow-2xl animate-fade-in" style="display: none;">
        <!-- Question Header -->
        <div class="bg-white/5 px-6 py-4 border-b border-white/10">
          <p id="question-number" class="text-sm font-bold text-white/90 uppercase tracking-wide"></p>
        </div>

        <!-- Question Content -->
        <div id="question-content" class="p-8">
          <img id="question-image" src="" alt="Question" class="max-w-full max-h-[500px] rounded-xl mx-auto mb-8 shadow-xl border-2 border-white/20" referrerpolicy="no-referrer" onerror="this.style.display='none';" style="display: none;" />
          <h2 id="question-text" class="font-serif text-white text-lg font-normal leading-relaxed text-left mb-8"></h2>
        </div>

        <!-- Answer Options -->
        <div class="px-6 pb-8">
          <div id="options-list" class="space-y-3"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    (function() {
        console.log('Student poll script initializing...');
        var studentLoader = document.getElementById('student-loader');
        var statusContainer = document.getElementById('status-container');
        var statusMessage = document.getElementById('status-message');
        var questionContainer = document.getElementById('question-container');
        var optionsList = document.getElementById('options-list');
        var entryScreen = document.getElementById('entry-screen');
        var startSessionBtn = document.getElementById('start-session-btn');
        var studentContainer = document.getElementById('student-container');

        console.log('Start session button found:', startSessionBtn ? 'YES' : 'NO');
        console.log('Entry screen found:', entryScreen ? 'YES' : 'NO');
        var resumeControls = document.getElementById('resume-controls');
        var resumeSessionBtn = document.getElementById('resume-session-btn');
        var statusSubMessage = document.getElementById('status-submessage');
        var connectivityBanner = document.getElementById('connectivity-banner');
        var connectivityIcon = document.getElementById('connectivity-icon');
        var connectivityMessage = document.getElementById('connectivity-message');
        var connectivitySubMessage = document.getElementById('connectivity-submessage');

        var currentPollState = {};
        var pollTimerId = null;
        var defaultPollInterval = 2500;
        var maxPollInterval = 12000;
        var pollFailureCount = 0;
        var proctorPollInterval = null;
        var isInteractionBlocked = false;
        var currentLockVersion = 0;
        var hasAnsweredCurrent = false;
        var violationLogged = false;
        var violationDebounceTimer = null;
        var pendingSubmission = false;
        var currentQuestionKey = null;
        var lastStateVersion = null;
        var lastSuccessfulPollAt = 0;
        var pollInFlight = false;
        var recoveringFromOutage = false;
        var connectivityHideTimer = null;
        var lastAdvisedInterval = defaultPollInterval;
        var optionBaseClass = 'answer-option w-full p-5 rounded-xl border-2 border-white/20 bg-white/5 backdrop-blur-sm text-left hover:border-white/60 hover:bg-white/10 transition-all shadow-sm';
        var optionSelectedClass = 'answer-option w-full p-5 rounded-xl border-2 border-green-400 bg-green-500/20 backdrop-blur-sm text-left shadow-md ring-2 ring-green-400/50';

        var connectivityThemes = {
            connecting: ['border-amber-300', 'bg-amber-50', 'text-amber-800', 'dark:border-amber-500', 'dark:bg-amber-900/20', 'dark:text-amber-100'],
            offline: ['border-red-300', 'bg-red-50', 'text-red-800', 'dark:border-red-600', 'dark:bg-red-900/20', 'dark:text-red-200'],
            recovered: ['border-green-300', 'bg-green-50', 'text-green-800', 'dark:border-green-600', 'dark:bg-green-900/20', 'dark:text-green-100']
        };
        var allConnectivityClasses = connectivityThemes.connecting.concat(connectivityThemes.offline, connectivityThemes.recovered);

        function applyConnectivityTheme(theme) {
            if (!connectivityBanner) return;
            for (var i = 0; i < allConnectivityClasses.length; i++) {
                connectivityBanner.classList.remove(allConnectivityClasses[i]);
            }
            var themeClasses = connectivityThemes[theme] || connectivityThemes.connecting;
            for (var j = 0; j < themeClasses.length; j++) {
                connectivityBanner.classList.add(themeClasses[j]);
            }
        }

        function showConnectivityState(state, options) {
            if (!connectivityBanner) return;
            options = options || {};
            clearTimeout(connectivityHideTimer);
            connectivityBanner.classList.remove('hidden');
            applyConnectivityTheme(state);
            if (connectivityIcon) {
                var icon = options.icon || (state === 'offline' ? 'signal_wifi_off' : (state === 'recovered' ? 'cloud_done' : 'sync'));
                connectivityIcon.textContent = icon;
            }
            if (connectivityMessage) {
                var defaults = {
                    connecting: 'Reconnecting... your poll data is catching up.',
                    offline: 'Offline detected - we will hold your spot and resync when you are back.',
                    recovered: 'Back on track - synced with your teacher.'
                };
                connectivityMessage.textContent = options.message || defaults[state] || defaults.connecting;
            }
            if (connectivitySubMessage) {
                var submessage = options.submessage || '';
                connectivitySubMessage.textContent = submessage;
                if (submessage) {
                    connectivitySubMessage.classList.remove('opacity-0');
                } else {
                    connectivitySubMessage.classList.add('opacity-0');
                }
            }
            if (options.autoHide) {
                connectivityHideTimer = setTimeout(hideConnectivityBanner, options.autoHide);
            }
        }

        function hideConnectivityBanner() {
            if (!connectivityBanner) return;
            clearTimeout(connectivityHideTimer);
            connectivityBanner.classList.add('hidden');
            if (connectivitySubMessage) {
                connectivitySubMessage.textContent = '';
                connectivitySubMessage.classList.remove('opacity-0');
            }
        }

        function stopPolling() {
            if (pollTimerId) {
                clearTimeout(pollTimerId);
                pollTimerId = null;
            }
            pollInFlight = false;
        }

        function scheduleNextPoll(delay) {
            if (isInteractionBlocked) return;
            stopPolling();
            var boundedDelay = Math.min(maxPollInterval, Math.max(1000, delay));
            var jitter = Math.random() * 0.15 * boundedDelay;
            pollTimerId = setTimeout(function() {
                pollTimerId = null;
                pollForStatus();
            }, boundedDelay + jitter);
        }

        function startPolling(immediate) {
            pollFailureCount = 0;
            recoveringFromOutage = false;
            if (immediate) {
                stopPolling();
                pollForStatus(true);
            } else {
                scheduleNextPoll(defaultPollInterval);
            }
        }

        function handlePostPollSuccess(data, hadFailures) {
            if (typeof data.stateVersion === 'number') {
                lastStateVersion = data.stateVersion;
            }
            if (typeof data.advisedPollIntervalMs === 'number') {
                lastAdvisedInterval = data.advisedPollIntervalMs;
            } else {
                lastAdvisedInterval = defaultPollInterval;
            }

            if (hadFailures || data.connectionHealth === 'RECOVERED_AFTER_OUTAGE') {
                showConnectivityState('recovered', {
                    message: 'Back on track - synced with your teacher.',
                    icon: 'cloud_done',
                    autoHide: 2400
                });
            } else if (data.connectionHealth === 'RECOVERING') {
                showConnectivityState('connecting', {
                    message: 'Syncing up with your teacher poll - hold on a sec.',
                    icon: 'sync'
                });
                connectivityHideTimer = setTimeout(hideConnectivityBanner, 2200);
            } else if (!recoveringFromOutage && !hadFailures) {
                hideConnectivityBanner();
            }

            updateStudentView(data);
            var delay = Math.max(1200, Math.min(maxPollInterval, lastAdvisedInterval));
            scheduleNextPoll(delay);
        }

        function handlePollingFailure(error) {
            var messageText = (error && error.message) ? error.message : (typeof error === 'string' ? error : '');
            if (messageText && /Authentication|not enrolled|Invalid link/i.test(messageText)) {
                stopPolling();
                handleError(error);
                return;
            }

            recoveringFromOutage = true;
            var backoffMultiplier = Math.pow(1.6, Math.max(1, pollFailureCount));
            var retryDelay = Math.min(maxPollInterval, Math.round((lastAdvisedInterval || defaultPollInterval) * backoffMultiplier));
            var seconds = Math.max(1, Math.round(retryDelay / 1000));

            var online = typeof navigator !== 'undefined' ? navigator.onLine : true;
            showConnectivityState(online ? 'connecting' : 'offline', {
                message: online ? 'Reconnecting... your poll data is catching up.' : 'Offline detected - we will hold your spot and resync when you are back.',
                icon: online ? 'sync_problem' : 'signal_wifi_off',
                submessage: online ? ('Retrying in ' + seconds + 's...') : ''
            });

            scheduleNextPoll(retryDelay);
        }

        function pollForStatus() {
            if (isInteractionBlocked || pollInFlight) return;
            pollInFlight = true;
            var context = {
                lastStateVersion: lastStateVersion,
                lastSuccessAt: lastSuccessfulPollAt,
                failureCount: pollFailureCount,
                advisedInterval: lastAdvisedInterval
            };

            google.script.run
                .withSuccessHandler(function(data) {
                    pollInFlight = false;
                    var hadFailures = pollFailureCount > 0 || recoveringFromOutage;
                    pollFailureCount = 0;
                    recoveringFromOutage = false;
                    lastSuccessfulPollAt = Date.now();
                    handlePostPollSuccess(data || {}, hadFailures);
                })
                .withFailureHandler(function(error) {
                    pollInFlight = false;
                    pollFailureCount += 1;
                    console.error('Polling error', error);
                    handlePollingFailure(error);
                })
                .getStudentPollStatus(SESSION_TOKEN, context);
        }

        function isSessionActive() {
            return studentContainer && studentContainer.style.display !== 'none' && entryScreen && entryScreen.style.display === 'none';
        }

        window.addEventListener('offline', function() {
            if (!isSessionActive()) return;
            recoveringFromOutage = true;
            showConnectivityState('offline', {
                message: 'Offline detected - we will hold your spot and resync when you are back.',
                icon: 'signal_wifi_off'
            });
        });

        window.addEventListener('online', function() {
            if (!isSessionActive()) return;
            showConnectivityState('connecting', {
                message: 'Reconnecting... your poll data is catching up.',
                icon: 'sync',
                submessage: 'Syncing now...'
            });
            startPolling(true);
        });

        if (resumeSessionBtn) {
            resumeSessionBtn.onclick = function() {
                console.log('Resume button clicked - attempting fullscreen');
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen()
                        .then(function() {
                            console.log('Fullscreen entered - confirming with server');
                            // Call studentConfirmFullscreen with the current lockVersion
                            google.script.run
                                .withSuccessHandler(function(response) {
                                    if (response.success && response.status === 'OK') {
                                        console.log('Server confirmed unlock - resuming poll');
                                        isInteractionBlocked = false;
                                        violationLogged = false;
                                        if (proctorPollInterval) {
                                            clearInterval(proctorPollInterval);
                                            proctorPollInterval = null;
                                        }
                                        if (resumeControls) {
                                            resumeControls.style.display = 'none';
                                        }
                                        hideConnectivityBanner();
                                        startPolling(true);
                                    } else {
                                        console.error('Failed to confirm fullscreen:', response);
                                        statusMessage.textContent = 'Failed to resume. Please try again.';
                                    }
                                })
                                .withFailureHandler(function(error) {
                                    console.error('Error confirming fullscreen:', error);
                                    statusMessage.textContent = 'Error resuming session.';
                                })
                                .studentConfirmFullscreen(currentLockVersion, SESSION_TOKEN);
                        })
                        .catch(function(e) {
                            console.warn('Fullscreen denied on resume:', e);
                            statusMessage.textContent = 'Fullscreen is required. Please allow fullscreen and try again.';
                        });
                }
            };
        }

        if (startSessionBtn) {
            console.log('Attaching onclick handler to start session button');
            startSessionBtn.onclick = function() {
                console.log('!!! BEGIN SESSION BUTTON CLICKED !!!');
                console.log('Hiding entry screen, showing student container');
                entryScreen.style.display = 'none';
                studentContainer.style.display = 'block';
                isInteractionBlocked = false;
                violationLogged = false;
                if (resumeControls) {
                    resumeControls.style.display = 'none';
                }

                try {
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen().catch(function(e) {
                            console.warn('Fullscreen denied:', e);
                        });
                    }
                } catch (e) {
                    console.error('Fullscreen error:', e);
                }

                function reportViolationDebounced(reason) {
                    // Clear any existing timer
                    if (violationDebounceTimer) {
                        clearTimeout(violationDebounceTimer);
                    }

                    // Set a new timer for 300ms
                    violationDebounceTimer = setTimeout(function() {
                        // Check if already reported to prevent duplicates
                        if (violationLogged || isInteractionBlocked) {
                            console.log('Violation already reported, skipping');
                            return;
                        }

                        console.log('VIOLATION: ' + reason);
                        // Set flags BEFORE RPC to prevent retry-based double-bump
                        violationLogged = true;
                        isInteractionBlocked = true;

                        google.script.run
                            .withSuccessHandler(function(response) {
                                if (response.success) {
                                    currentLockVersion = response.lockVersion;
                                    showLockedMessage();
                                    startProctorPolling();
                                }
                            })
                            .withFailureHandler(function(error) {
                                console.error('Violation report failed:', error);
                                // Keep flags set - student stays locked locally even if server unreachable
                                showLockedMessage();
                            })
                            .reportStudentViolation(reason, SESSION_TOKEN);
                    }, 300);
                }

                document.addEventListener('visibilitychange', function() {
                    if (document.hidden && !isInteractionBlocked && !violationLogged) {
                        reportViolationDebounced('tab-blur');
                    }
                });

                document.addEventListener('fullscreenchange', function() {
                    if (!document.fullscreenElement && !isInteractionBlocked && !violationLogged) {
                        reportViolationDebounced('exit-fullscreen');
                    }
                });

                hideConnectivityBanner();
                startPolling(true);
            };
        } else {
            console.error('Start session button not found!');
        }

        function startProctorPolling() {
            stopPolling();
            if (proctorPollInterval) {
                clearInterval(proctorPollInterval);
            }
            proctorPollInterval = setInterval(checkProctorState, 2500);
            checkProctorState();
        }

        function checkProctorState() {
            google.script.run
                .withSuccessHandler(function(response) {
                    if (!response.success) {
                        console.error('Proctor state check failed:', response.error);
                        return;
                    }

                    // Check if status is AWAITING_FULLSCREEN and lockVersion matches
                    if (response.status === 'AWAITING_FULLSCREEN' && response.lockVersion === currentLockVersion) {
                        if (proctorPollInterval) {
                            clearInterval(proctorPollInterval);
                            proctorPollInterval = null;
                        }
                        showResumePrompt();
                    } else if (response.status === 'LOCKED' && response.lockVersion !== currentLockVersion) {
                        // New violation or version mismatch - update lockVersion
                        currentLockVersion = response.lockVersion;
                        showLockedMessage();
                    } else if (response.status === 'OK') {
                        // Unlocked - resume normal polling
                        if (proctorPollInterval) {
                            clearInterval(proctorPollInterval);
                            proctorPollInterval = null;
                        }
                        isInteractionBlocked = false;
                        violationLogged = false;
                        hideConnectivityBanner();
                        startPolling(true);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Proctor state check error:', error);
                })
                .getStudentProctorState(SESSION_TOKEN);
        }

        function updateStudentView(data) {
            console.log('Status update:', data.status);
            if (studentLoader) studentLoader.style.display = 'none';

            if (statusSubMessage) {
                statusSubMessage.style.display = 'none';
                statusSubMessage.textContent = '';
            }

            if (data.status === 'LOCKED' || data.status === 'AWAITING_FULLSCREEN') {
                console.log('Server confirmed lock status on page load:', data.status);
                isInteractionBlocked = true;
                google.script.run
                    .withSuccessHandler(function(proctorResponse) {
                        if (proctorResponse.success) {
                            currentLockVersion = proctorResponse.lockVersion;
                            if (proctorResponse.status === 'AWAITING_FULLSCREEN') {
                                showResumePrompt();
                            } else if (proctorResponse.status === 'LOCKED') {
                                showLockedMessage();
                                startProctorPolling();
                            }
                        }
                    })
                    .withFailureHandler(handleError)
                    .getStudentProctorState(SESSION_TOKEN);
                return;
            }

            if (resumeControls) {
                resumeControls.style.display = 'none';
            }

            if (data.status === 'OPEN') {
                var questionKey = data.pollId + ':' + data.questionIndex;
                var isNewQuestion = questionKey !== currentQuestionKey;

                if (isNewQuestion) {
                    currentQuestionKey = questionKey;
                    hasAnsweredCurrent = !!data.hasSubmitted;
                    pendingSubmission = false;
                    currentPollState = data;
                    statusContainer.style.display = hasAnsweredCurrent ? 'block' : 'none';
                    questionContainer.style.display = hasAnsweredCurrent ? 'none' : 'block';

                    var qNum = (data.questionIndex || 0) + 1;
                    var qTotal = data.totalQuestions || '?';
                    document.getElementById('question-number').textContent = 'Question ' + qNum + ' of ' + qTotal;

                    document.getElementById('question-text').textContent = data.questionText || '';

                    var qImgEl = document.getElementById('question-image');
                    if (data.questionImageURL) {
                        qImgEl.src = data.questionImageURL;
                        qImgEl.style.display = 'block';
                    } else {
                        qImgEl.style.display = 'none';
                    }

                    optionsList.innerHTML = "";
                    var shuffled = shuffle(data.options || []);
                    var letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

                    // DEBUG: Log what we received
                    console.log('=== STUDENT RECEIVED DATA ===');
                    console.log('questionImageURL:', data.questionImageURL);
                    console.log('options:', data.options);
                    if (data.options && data.options.length > 0) {
                        data.options.forEach(function(opt, idx) {
                            console.log('  Option ' + idx + ':', 'text="' + opt.text + '", imageURL=' + opt.imageURL);
                        });
                    }

                    shuffled.forEach(function(option, index) {
                        var btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = optionBaseClass;
                        btn.dataset.answerText = option.text || '';

                        var letter = letters[index] || (index + 1).toString();
                        var content = '<div class="flex items-start gap-4">';
                        content += '<div class="flex-shrink-0 w-10 h-10 rounded-lg bg-white/10 flex items-center justify-center border border-white/30">';
                        content += '<span class="text-white font-semibold text-lg">' + letter + '</span>';
                        content += '</div>';
                        content += '<div class="flex-grow flex flex-col gap-3 min-w-0">';
                        if (option.imageURL) {
                            content += '<img src="' + escapeHtml(option.imageURL) + '" alt="Answer ' + letter + '" class="max-w-full max-h-[220px] rounded-lg object-contain border border-white/30" referrerpolicy="no-referrer">';
                        }
                        if (option.text) {
                            content += '<p class="font-serif text-white text-lg font-normal leading-relaxed">' + escapeHtml(option.text) + '</p>';
                        }
                        content += '</div></div>';

                        btn.innerHTML = content;
                        btn.onclick = function() {
                            submitAnswer(data.pollId, data.questionIndex, option.text);
                        };
                        optionsList.appendChild(btn);
                    });
                }

                if (pendingSubmission && !data.hasSubmitted) {
                    return;
                }

                if (data.hasSubmitted) {
                    hasAnsweredCurrent = true;
                    pendingSubmission = false;
                }

                if (hasAnsweredCurrent) {
                    questionContainer.style.display = 'none';
                    statusContainer.style.display = 'block';
                    statusMessage.textContent = data.hasSubmitted ? (data.message || 'Answer received - nice work.') : 'Answer received - nice work.';
                    statusMessage.className = 'text-green-300 text-2xl font-semibold';
                    if (statusSubMessage) {
                        statusSubMessage.textContent = 'Waiting for another question...';
                        statusSubMessage.style.display = 'block';
                        statusSubMessage.className = 'text-white/70 text-lg mt-4';
                    }
                    var iconEl = statusContainer.querySelector('.material-symbols-outlined');
                    if (iconEl) {
                        iconEl.textContent = 'check_circle';
                        iconEl.className = 'material-symbols-outlined text-6xl text-green-300 mb-4 inline-block';
                    }
                } else {
                    questionContainer.style.display = 'block';
                    statusContainer.style.display = 'none';
                }
            } else {
                currentPollState = {};
                questionContainer.style.display = 'none';
                statusContainer.style.display = 'block';
                var statusIcon = 'schedule';
                var statusClass = 'text-white';
                var statusTextClass = 'text-white text-2xl font-semibold';

                if (data.status === 'WAITING') {
                    if (data.hasSubmitted) {
                        hasAnsweredCurrent = true;
                        pendingSubmission = false;
                        statusMessage.textContent = data.message || 'Answer received - nice work.';
                        statusTextClass = 'text-green-300 text-2xl font-semibold';
                        statusIcon = 'check_circle';
                        statusClass = 'text-green-300';
                        if (statusSubMessage) {
                            statusSubMessage.textContent = 'Waiting for another question...';
                            statusSubMessage.style.display = 'block';
                            statusSubMessage.className = 'text-white/70 text-lg mt-4';
                        }
                    } else {
                        hasAnsweredCurrent = false;
                        statusMessage.textContent = data.message || 'Hang tight - your teacher is loading the next challenge.';
                        statusIcon = 'hourglass_top';
                        statusClass = 'text-white';
                    }
                } else if (data.status === 'NOT_ENROLLED') {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || "You are not enrolled.";
                    statusTextClass = 'text-red-300 text-2xl font-bold';
                    statusIcon = 'error';
                    statusClass = 'text-red-300';
                    stopPolling();
                } else if (data.status === 'ERROR') {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || "We hit a snag. Try again soon.";
                    statusTextClass = 'text-red-300 text-2xl font-bold';
                    statusIcon = 'error';
                    statusClass = 'text-red-300';
                } else if (data.status === 'CLOSED') {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || 'That is a wrap! You just finished the poll - nicely done.';
                    statusTextClass = 'text-white text-2xl font-semibold';
                    statusIcon = 'emoji_events';
                    statusClass = 'text-yellow-300';
                } else {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || 'Hang tight - your teacher is loading the next challenge.';
                    statusIcon = 'hourglass_top';
                    statusClass = 'text-white';
                }
                statusMessage.className = statusTextClass;
                var iconEl = statusContainer.querySelector('.material-symbols-outlined');
                if (iconEl) {
                    iconEl.textContent = statusIcon;
                    iconEl.className = 'material-symbols-outlined text-6xl mb-4 inline-block ' + statusClass;
                }
            }
        }

        function submitAnswer(pollId, questionIndex, answerText) {
            if (isInteractionBlocked) {
                return;
            }
            if (hasAnsweredCurrent) {
                return;
            }

            var buttons = optionsList.querySelectorAll('button');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].disabled = true;
                if (buttons[i].dataset.answerText === answerText) {
                    buttons[i].className = optionSelectedClass;
                } else {
                    buttons[i].className = optionBaseClass + ' opacity-40 pointer-events-none';
                }
            }
            hasAnsweredCurrent = true;
            pendingSubmission = true;
            statusContainer.style.display = 'block';
            questionContainer.style.display = 'none';
            statusMessage.textContent = 'Transmitting your genius response...';
            statusMessage.className = 'text-white text-2xl font-semibold';
            google.script.run
                .withSuccessHandler(function(response) {
                    if (!response.success) {
                        hasAnsweredCurrent = false;
                        pendingSubmission = false;
                        statusMessage.textContent = response.error || 'We hit a hiccup. Try again?';
                        statusMessage.className = 'text-red-300 text-2xl font-semibold';
                        if (statusSubMessage) {
                            statusSubMessage.style.display = 'none';
                            statusSubMessage.textContent = '';
                        }
                        setTimeout(function() {
                            if (!isInteractionBlocked) {
                                questionContainer.style.display = 'block';
                                statusContainer.style.display = 'none';
                                var buttons = optionsList.querySelectorAll('button');
                                for (var i = 0; i < buttons.length; i++) {
                                    buttons[i].disabled = false;
                                    buttons[i].className = optionBaseClass;
                                }
                            }
                        }, 2000);
                    } else {
                        statusMessage.textContent = 'Answer received - nice work.';
                        statusMessage.className = 'text-green-300 text-2xl font-semibold';
                        if (statusSubMessage) {
                            statusSubMessage.textContent = 'Waiting for another question...';
                            statusSubMessage.style.display = 'block';
                            statusSubMessage.className = 'text-white/70 text-lg mt-4';
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    hasAnsweredCurrent = false;
                    pendingSubmission = false;
                    handleError(error);
                })
                .submitStudentAnswer(pollId, questionIndex, answerText, SESSION_TOKEN);
        }

        function shuffle(array) {
            var arr = array.slice();
            for (var i = arr.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = arr[i];
                arr[i] = arr[j];
                arr[j] = temp;
            }
            return arr;
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showLockedMessage() {
            console.log('Showing locked message');
            stopPolling();
            recoveringFromOutage = false;
            hideConnectivityBanner();
            studentContainer.style.display = 'block';
            entryScreen.style.display = 'none';
            questionContainer.style.display = 'none';
            statusContainer.style.display = 'block';
            if (studentLoader) studentLoader.style.display = 'none';

            if (statusSubMessage) {
                statusSubMessage.style.display = 'none';
                statusSubMessage.textContent = '';
            }

            statusMessage.textContent = 'Oops - you left fullscreen. Your poll has been paused until your teacher lets you back in.';
            statusMessage.className = 'text-red-300 text-xl font-semibold';

            var iconEl = statusContainer.querySelector('.material-symbols-outlined');
            if (iconEl) {
                iconEl.textContent = 'lock';
                iconEl.className = 'material-symbols-outlined text-6xl text-red-300 mb-4 inline-block';
            }
            if (resumeControls) {
                resumeControls.style.display = 'none';
            }
        }

        function showResumePrompt() {
            console.log('Showing resume prompt');
            stopPolling();
            hideConnectivityBanner();
            studentContainer.style.display = 'block';
            entryScreen.style.display = 'none';
            questionContainer.style.display = 'none';
            statusContainer.style.display = 'block';
            if (studentLoader) studentLoader.style.display = 'none';

            if (statusSubMessage) {
                statusSubMessage.style.display = 'none';
                statusSubMessage.textContent = '';
            }

            // Use exact text from requirements
            statusMessage.textContent = 'You are cleared for re-entry. Go fullscreen to get back in the game.';
            statusMessage.className = 'text-white text-xl font-semibold';

            var iconEl = statusContainer.querySelector('.material-symbols-outlined');
            if (iconEl) {
                iconEl.textContent = 'fullscreen';
                iconEl.className = 'material-symbols-outlined text-6xl text-green-300 mb-4 inline-block';
            }

            if (resumeControls) {
                resumeControls.style.display = 'block';
            }
        }

        function handleError(error) {
            console.error('Error:', error);
            hideConnectivityBanner();
            statusContainer.style.display = 'block';
            questionContainer.style.display = 'none';
            if (studentLoader) studentLoader.style.display = 'none';
            if (resumeControls) resumeControls.style.display = 'none';

            if (statusSubMessage) {
                statusSubMessage.style.display = 'none';
                statusSubMessage.textContent = '';
            }

            statusMessage.textContent = 'An error occurred: ' + (error.message || error);
            statusMessage.className = 'text-yellow-300 text-2xl font-bold';

            var iconEl = statusContainer.querySelector('.material-symbols-outlined');
            if (iconEl) {
                iconEl.textContent = 'error';
                iconEl.className = 'material-symbols-outlined text-6xl text-yellow-300 mb-4 inline-block';
            }
        }
    })();
    </script>
</body>
</html>
