import"./firebase-7PLbf-9k.js";import"./proctoring-CP4HimPX.js";(function(){try{console.log("[Info] Teacher Scripts Initializing...");var ht=document.getElementById("loader"),Ae=document.getElementById("polls-card-view"),rr=document.getElementById("polls-table-view"),xa=document.getElementById("polls-table-body"),Kt=document.getElementById("polls-empty-state")}catch(e){console.error("[Critical] DOM Init Failed:",e)}var ae=[],be=[],f={},we=null,H=[],bo="",ke={column:"lastName",direction:"asc"},de=null,He=null;try{window.SecureAssessmentShared&&window.SecureAssessmentShared.createHeartbeat?He=window.SecureAssessmentShared.createHeartbeat({intervalMs:2500,onBeat:function(){typeof ea=="function"&&ea()}}):console.warn("[Warn] SecureAssessmentShared not found, heartbeat disabled")}catch(e){console.error("[Error] Heartbeat init failed:",e)}var Ot=0,Ne=null,O=null,J=[],ee=new Set,oa=new Set,ir=!1,$=null,Ie=!1,ze=!1,Ce=!1,yn=!1,k=[],hn=0,j=[],la=[],ue=null,at="";function sr(e){if(!e)return"";var n=e;return typeof DOMPurify<"u"&&(n=DOMPurify.sanitize(e,{ADD_TAGS:["math","annotation","semantics","mrow","mi","mo","mn","msup","sub","sup"],ADD_ATTR:["class","style","src","alt","width","height"]})),'<div class="ql-editor">'+n+"</div>"}function or(){window.renderMathInElement?renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]}):window.MathLive&&window.MathLive.renderMathInDocument&&window.MathLive.renderMathInDocument()}var rt={lastCompletionPct:null,lastAccuracyPct:null,lastLockoutTotal:null,allRespondedCelebrated:!1},it=null,Le=null,da=null,Ve={},Me=!1,vi=-1,xn="question",ca=2500,yo={get:function(e){try{var n=localStorage.getItem("vlp_"+e);if(!n)return null;var t=JSON.parse(n);return t.expires&&Date.now()>t.expires?null:t.value}catch(a){return console.warn("LocalCache get error:",a),null}},set:function(e,n,t){try{var a={value:n,expires:t?Date.now()+t:null};localStorage.setItem("vlp_"+e,JSON.stringify(a))}catch(r){console.warn("LocalCache set error:",r)}},invalidate:function(e){try{localStorage.removeItem("vlp_"+e)}catch(n){console.warn("LocalCache invalidate error:",n)}}},Re={instances:{},lastFocusedQuillId:null,init:function(e,n,t,a){var r=document.getElementById(e);if(!r)return null;if(this.instances[e])if(this.instances[e].container!==r)delete this.instances[e];else return this.instances[e];var i=new Quill("#"+e,{theme:"snow",placeholder:t||"Enter text...",modules:{imageResize:{displaySize:!0},toolbar:{container:[["bold","italic","underline","strike"],["blockquote","code-block"],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{color:[]},{background:[]}],["link","image","formula"],[{align:[]}],["clean"]],handlers:{formula:function(){console.log("Formula button clicked");var s=this.quill.getSelection();typeof window.openFormulaModal=="function"?window.openFormulaModal(this.quill,s):(console.error("window.openFormulaModal is not defined. Checking global scope..."),window.openFormulaModal?window.openFormulaModal(this.quill,s):alert("Error: Formula editor could not be loaded. Please refresh."))}}}}});return n&&(typeof n=="object"&&n.ops?i.setContents(n):i.clipboard.dangerouslyPasteHTML(n)),i.on("text-change",function(s,d,o){if(a){var l=r.querySelector(".ql-editor"),c=l?l.innerHTML:i.root.innerHTML,u=i.getText(),m=i.getContents();a({html:c,text:u,delta:m})}}),i.on("selection-change",function(s,d,o){if(s&&(Re.lastFocusedQuillId=e),s&&s.length===0){var[l,c]=i.getLeaf(s.index);l&&l.statics.blotName==="formula"&&openFormulaModal(i,s,l)}}),this.instances[e]=i,i},get:function(e){return this.instances[e]},clearAll:function(){this.instances={},this.lastFocusedQuillId=null},insertMathSymbol:function(e){if(!this.lastFocusedQuillId){var n=Object.keys(this.instances);if(n.length>0)this.lastFocusedQuillId=n[0];else return}var t=this.instances[this.lastFocusedQuillId];if(t){var a=t.getSelection(!0);a?(t.insertText(a.index,e),t.setSelection(a.index+e.length)):t.insertText(t.getLength()-1,e)}}};function $e(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=Math.random()*16|0,t=e=="x"?n:n&3|8;return t.toString(16)})}var bi={NetworkError:{title:"Connection Problem",message:"Please check your internet and try again."},"permission-denied":{title:"Access Denied",message:"You don't have permission for this action."},"not-found":{title:"Not Found",message:"The requested item could not be found."},default:{title:"Error",message:"An unexpected error occurred. Please try again."}};function Ut(e){var n=e&&e.code||"default",t=bi[n]||bi.default;typeof P=="function"?P("error",t.title,t.message):console.error(t.title+": "+t.message,e)}var lr={guessing:{label:"Guessing",emoji:"ðŸ¤”",textClass:"text-red-700 dark:text-red-200",badgeClass:"bg-red-500/10 text-red-700 dark:text-red-200 border border-red-500/30",barClass:"bg-red-500",accentClass:"text-red-700/80 dark:text-red-200/80"},"somewhat-sure":{label:"Somewhat sure",emoji:"ðŸ¤·",textClass:"text-amber-700 dark:text-amber-200",badgeClass:"bg-amber-500/10 text-amber-700 dark:text-amber-200 border border-amber-500/30",barClass:"bg-amber-500",accentClass:"text-amber-700/80 dark:text-amber-200/80"},"very-sure":{label:"Very sure",emoji:"ðŸ‘",textClass:"text-blue-700 dark:text-blue-200",badgeClass:"bg-blue-500/10 text-blue-700 dark:text-blue-200 border border-blue-500/30",barClass:"bg-blue-500",accentClass:"text-blue-700/80 dark:text-blue-200/80"},certain:{label:"Absolutely certain",emoji:"ðŸ’¯",textClass:"text-green-700 dark:text-green-200",badgeClass:"bg-green-500/10 text-green-700 dark:text-green-200 border border-green-500/30",barClass:"bg-green-500",accentClass:"text-green-700/80 dark:text-green-200/80"}};const yi={success:4e3,info:5e3,warning:7e3,error:0};function P(e,n,t,a=null,r=null){const i=document.getElementById("toast-container");if(!i)return;const s=e==="warn"?"warning":e,d=document.createElement("div");d.className=`toast toast-${s}`;const o={success:"check_circle",error:"error",warning:"warning",info:"info"};let l="";if(r&&r.label&&(l=`<button class="toast-action-btn">${r.label}</button>`),d.innerHTML=`
      <span class="material-symbols-outlined toast-icon">${o[s]||"notifications"}</span>
      <div class="toast-content">
        <div class="toast-title">${n}</div>
        <div class="toast-message">${t}</div>
        ${l}
      </div>
      <button class="toast-close" onclick="this.closest('.toast').remove()">
        <span class="material-symbols-outlined" style="font-size: 18px">close</span>
      </button>
      <div class="toast-progress"></div>
    `,r&&r.onClick){const u=d.querySelector(".toast-action-btn");u&&(u.onclick=function(m){m.stopPropagation(),r.onClick(),d.remove()})}i.appendChild(d);let c=a??yi[s]??yi.info;c>0&&setTimeout(()=>{d.classList.add("toast-out"),setTimeout(()=>d.remove(),300)},c)}window.showToast=P;var ua=!1,ye=null;function ho(e){ye||(ye=document.createElement("div"),ye.id="teacher-connectivity-toast",ye.className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] px-6 py-3 rounded-full shadow-lg transition-all duration-300 flex items-center gap-3",ye.style.cssText="opacity: 0; pointer-events: none;",document.body.appendChild(ye)),!e&&!ua?(ye.innerHTML='<span class="inline-block w-3 h-3 rounded-full bg-amber-400 animate-pulse"></span><span class="font-semibold text-amber-900">Reconnecting to Server...</span>',ye.className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] px-6 py-3 rounded-full shadow-lg transition-all duration-300 flex items-center gap-3 bg-amber-100 border border-amber-300",ye.style.opacity="1",ye.style.pointerEvents="auto",ua=!0,console.log("[Connectivity] Teacher - showing reconnecting toast")):e&&ua&&(ye.innerHTML='<span class="inline-block w-3 h-3 rounded-full bg-emerald-500"></span><span class="font-semibold text-emerald-900">Connected - Syncing Data</span>',ye.className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] px-6 py-3 rounded-full shadow-lg transition-all duration-300 flex items-center gap-3 bg-emerald-100 border border-emerald-300",setTimeout(function(){ye.style.opacity="0",ye.style.pointerEvents="none",ua=!1,console.log("[Connectivity] Teacher - hiding toast - connection restored")},2e3))}let _t=!1;function xo(){const e=document.getElementById("fab-main-toggle"),n=document.getElementById("fab-menu"),t=document.getElementById("fab-container");if(!e||!n)return;e.addEventListener("click",function(){_t=!_t,_t?(n.classList.add("is-open"),e.classList.add("is-open"),e.setAttribute("aria-expanded","true")):(n.classList.remove("is-open"),e.classList.remove("is-open"),e.setAttribute("aria-expanded","false"))});const a=document.getElementById("fab-next-btn"),r=document.getElementById("fab-show-results-btn"),i=document.getElementById("fab-reset-btn"),s=document.getElementById("fab-stop-btn");a&&a.addEventListener("click",function(){typeof zn=="function"&&zn(),xt()}),r&&r.addEventListener("click",function(){const d=document.getElementById("header-end-show-btn");d&&(typeof Da=="function"?Da():d.click()),xt()}),i&&i.addEventListener("click",function(){typeof Pa=="function"&&Pa(),xt()}),s&&s.addEventListener("click",function(){typeof ds=="function"&&ds(),xt()}),document.addEventListener("click",function(d){_t&&!t.contains(d.target)&&xt()})}function xt(){_t=!1;const e=document.getElementById("fab-menu"),n=document.getElementById("fab-main-toggle");e&&e.classList.remove("is-open"),n&&(n.classList.remove("is-open"),n.setAttribute("aria-expanded","false"))}function hi(e,n){const t=document.getElementById(e);if(!t)return;const a=138.23,r=a-n/100*a;t.style.strokeDashoffset=r,t.classList.remove("ring-success","ring-warning","ring-danger"),n>=70?t.classList.add("ring-success"):n>=40?t.classList.add("ring-warning"):t.classList.add("ring-danger")}function Eo(e){const n=document.getElementById("ambient-state-overlay");n&&(n.className="ambient-state-overlay",n.classList.add(`state-${e}`))}var Ht={responses:[],accuracy:[],maxPoints:20};function xi(e,n){Ht[e]||(Ht[e]=[]),Ht[e].push(n),Ht[e].length>Ht.maxPoints&&Ht[e].shift()}function wo(e,n="default"){e&&(e.classList.remove("celebrate"),e.offsetWidth,e.classList.add("celebrate"),setTimeout(function(){e.classList.remove("celebrate")},600),n==="all-responded"?(P("success","ðŸŽ‰ All Students Responded!","Great work! Everyone has submitted their answer."),Eo("all-responded")):n==="perfect-accuracy"&&P("success","ðŸ’¯ Perfect Accuracy!","100% of students got the answer correct!"))}var Et=[],En=!1,Ei=50;function ko(){const e=document.getElementById("activity-feed"),n=document.getElementById("activity-feed-close"),t=document.getElementById("fab-activity-btn");e&&(n&&n.addEventListener("click",function(){ma()}),t&&t.addEventListener("click",function(){wi(),xt()}),document.addEventListener("click",function(a){En&&!e.contains(a.target)&&!t.contains(a.target)&&ma()}))}function wi(){En?ma():Io()}function Io(){const e=document.getElementById("activity-feed");e&&(e.classList.add("is-open"),En=!0)}function ma(){const e=document.getElementById("activity-feed");e&&(e.classList.remove("is-open"),En=!1)}function Lo(e,n,t){const r={type:e,icon:n,message:t,timestamp:new Date};Et.unshift(r),Et.length>Ei&&(Et=Et.slice(0,Ei)),Co()}function Co(){const e=document.getElementById("activity-feed-list"),n=document.getElementById("activity-feed-count");if(!e)return;if(Et.length===0){e.innerHTML=`
        <div class="activity-feed-empty">
          <span class="material-symbols-outlined">inbox</span>
          <p>No recent activity</p>
        </div>
      `,n&&(n.textContent="0");return}n&&(n.textContent=Et.length.toString());const t=Et.map(function(a){const r=zr(a.timestamp);return`
        <div class="activity-item">
          <div class="activity-icon ${a.type}">
            <span class="material-symbols-outlined">${a.icon}</span>
          </div>
          <div class="activity-content">
            <div class="activity-message">${h(a.message)}</div>
            <div class="activity-time">${r}</div>
          </div>
        </div>
      `}).join("");e.innerHTML=t}function So(){document.addEventListener("keydown",function(e){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")return;const n=document.getElementById("live-view");if(!(!n||n.style.display==="none"))switch(e.key){case"ArrowRight":e.preventDefault();const t=document.getElementById("header-next-btn");t&&!t.disabled&&t.click();break;case"ArrowLeft":e.preventDefault();const a=document.getElementById("header-back-btn");a&&!a.disabled&&a.click();break;case" ":if(e.target.id==="timer-display")return;e.preventDefault(),fe?dn():Oa();break;case"r":case"R":e.preventDefault();const i=document.getElementById("header-reset-question-btn");i&&!i.disabled&&i.click();break;case"a":case"A":e.preventDefault(),wi();break;case"Escape":e.preventDefault(),En&&ma(),_t&&xt();break}})}function Se(e){if(this.inputId=e.inputId,this.containerId=e.containerId,this.data=e.data||[],this.onSelect=e.onSelect,this.filterFn=e.filterFn||function(n,t){return(n.label||"").toLowerCase().includes(t.toLowerCase())},this.renderItem=e.renderItem||function(n,t,a){var r=t?'<span class="absolute inset-y-0 right-0 flex items-center pr-4 text-veritas-navy"><span class="material-symbols-outlined text-sm">check</span></span>':"",i=a?"bg-veritas-navy text-white":"text-gray-900",s=n.subLabel?'<span class="block truncate text-xs opacity-70">'+h(n.subLabel)+"</span>":"";return'<li class="relative cursor-default select-none py-2 pl-3 pr-9 '+i+'" role="option" aria-selected="'+t+'" data-index="'+n.index+'"><div class="flex flex-col"><span class="block truncate font-medium">'+h(n.label)+"</span>"+s+"</div>"+r+"</li>"},this.input=document.getElementById(this.inputId),this.container=document.getElementById(this.containerId)||(this.input?this.input.parentElement:null),!this.input||!this.container){console.warn("Combobox init failed: missing input or container",this.inputId);return}this.button=this.container.querySelector("button[data-combobox-toggle]"),this.optionsList=document.createElement("ul"),this.optionsList.className="absolute z-[100] mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black/5 focus:outline-none sm:text-sm hidden",this.container.appendChild(this.optionsList),this.isOpen=!1,this.activeIndex=-1,this.filteredData=[],this.query="",this.init()}Se.prototype.init=function(){var e=this;this.input.addEventListener("input",function(n){e.query=n.target.value,e.isOpen=!0,e.activeIndex=-1,e.renderOptions()}),this.input.addEventListener("focus",function(){e.data.length>0}),this.input.addEventListener("keydown",function(n){if(!e.isOpen){n.key==="ArrowDown"&&(e.isOpen=!0,e.renderOptions(),n.preventDefault());return}switch(n.key){case"ArrowDown":n.preventDefault(),e.activeIndex=(e.activeIndex+1)%e.filteredData.length,e.updateActiveOption(),e.scrollActiveIntoView();break;case"ArrowUp":n.preventDefault(),e.activeIndex=(e.activeIndex-1+e.filteredData.length)%e.filteredData.length,e.updateActiveOption(),e.scrollActiveIntoView();break;case"Enter":n.preventDefault(),e.activeIndex>=0&&e.filteredData[e.activeIndex]&&e.selectItem(e.filteredData[e.activeIndex]);break;case"Escape":e.close();break;case"Tab":e.close();break}}),this.button&&this.button.addEventListener("click",function(n){n.stopPropagation(),e.toggle()}),this.optionsList.addEventListener("click",function(n){var t=n.target.closest("li");if(t){var a=parseInt(t.dataset.index,10),r=e.filteredData[a];r&&e.selectItem(r)}}),document.addEventListener("click",function(n){e.isOpen&&!e.container.contains(n.target)&&e.close()})},Se.prototype.updateData=function(e){this.data=e,this.isOpen&&this.renderOptions()},Se.prototype.toggle=function(){this.isOpen?this.close():this.open()},Se.prototype.open=function(){this.isOpen=!0,this.query=this.input.value,this.renderOptions()},Se.prototype.close=function(){this.isOpen=!1,this.optionsList.classList.add("hidden"),this.activeIndex=-1},Se.prototype.renderOptions=function(){var e=this;this.query===""?this.filteredData=this.data:this.filteredData=this.data.filter(function(n){return e.filterFn(n,e.query)}),this.filteredData.length===0?this.optionsList.innerHTML='<div class="relative cursor-default select-none py-2 px-4 text-gray-700">Nothing found.</div>':this.optionsList.innerHTML=this.filteredData.map(function(n,t){var a=Object.assign({},n,{index:t});return e.renderItem(a,!1,t===e.activeIndex)}).join(""),this.optionsList.classList.remove("hidden")},Se.prototype.updateActiveOption=function(){var e=this.optionsList.querySelectorAll("li");e.forEach((function(n,t){t===this.activeIndex?(n.classList.add("bg-veritas-navy","text-white"),n.classList.remove("text-gray-900")):(n.classList.remove("bg-veritas-navy","text-white"),n.classList.add("text-gray-900"))}).bind(this))},Se.prototype.scrollActiveIntoView=function(){var e=this.optionsList.children[this.activeIndex];e&&e.scrollIntoView({block:"nearest"})},Se.prototype.selectItem=function(e){this.input.value=e.label,this.query=e.label,this.close(),this.onSelect&&this.onSelect(e);var n=new Event("input",{bubbles:!0});this.input.dispatchEvent(n)};var dr=null,cr=null,ur=null;function Ao(){xo(),ko(),zd(),So(),To(),qo(),Xi(),Bo()}async function Bo(){try{var e=sessionStorage.getItem("veritas_active_poll_id");if(!e){console.log("[Rehydration] No active poll in sessionStorage - showing dashboard");return}if(console.log("[Rehydration] Found active poll:",e,"- checking Firebase..."),typeof firebase>"u"||!firebase.database){console.warn("[Rehydration] Firebase not available - showing dashboard");return}var n=firebase.database(),t=n.ref("sessions/"+e+"/live_session"),a=await t.once("value"),r=a.val();if(!r){console.log("[Rehydration] No live_session data found - poll may have ended"),sessionStorage.removeItem("veritas_active_poll_id");return}var i=r.status||"",s=r.sessionPhase||r.metadata&&r.metadata.sessionPhase||"";if(i==="CLOSED"||i==="ENDED"||s==="ENDED"){console.log("[Rehydration] Poll is closed/ended - cleaning up and showing dashboard"),sessionStorage.removeItem("veritas_active_poll_id");return}console.log("[Rehydration] Poll is ACTIVE (status: "+i+", phase: "+s+") - restoring live view");var d=ae?ae.find(function(x){return x.pollId===e}):null;if(!d){console.log("[Rehydration] Poll not in ALL_POLLS cache - fetching from server...");var o=n.ref("polls/"+e),l=await o.once("value");if(d=l.val(),!d){console.error("[Rehydration] Could not find poll data for:",e),sessionStorage.removeItem("veritas_active_poll_id");return}d.pollId=e}f={pollId:e,pollName:d.pollName||d.name,questions:d.questions||[],questionIndex:r.questionIndex!==void 0?r.questionIndex:0,totalQuestions:d.questions?d.questions.length:0,className:d.className,sessionType:d.sessionType||"LIVE_POLL"};var c=f.questions[f.questionIndex]||{},u=c.timerSeconds||r.metadata&&r.metadata.timeLimit||0;if(u>0&&r.metadata&&r.metadata.startedAt){var m=r.metadata.startedAt,g=new Date(m).getTime(),p=Date.now(),v=Math.floor((p-g)/1e3),y=Math.max(0,u-v);console.log("[Rehydration] Timer sync: preset="+u+"s, elapsed="+v+"s, remaining="+y+"s"),typeof window<"u"&&(window.REHYDRATED_TIMER_REMAINING=y,window.REHYDRATED_TIMER_PRESET=u,window.REHYDRATED_TIMER_ACTIVE=i==="OPEN"&&y>0)}typeof Xn=="function"&&Xn(e),ze=!0;var E={pollId:e,status:i||"OPEN",questionIndex:f.questionIndex,pollName:f.pollName,questionText:c.questionText||r.questionText||"",questionImageURL:c.questionImageURL||r.questionImageURL||"",options:c.options||r.options||[],totalQuestions:f.totalQuestions,correctAnswer:c.correctAnswer,timerSeconds:c.timerSeconds,metadata:r.metadata||{},authoritativeStatus:"LIVE",results:{},totalResponses:0,totalStudents:0,studentStatusList:[]};if(console.log("[Rehydration] SUCCESS - Restoring live view with data:",E),typeof showLiveView=="function")showLiveView(E);else if(typeof sn=="function"){var q=document.getElementById("dashboard-content"),B=document.getElementById("live-view");q&&(q.style.display="none"),B&&(B.style.display="block"),sn(E)}typeof Tt=="function"&&setTimeout(Tt,500),P("success","Session Restored","Live poll resumed. Timer synced with server.",3e3)}catch(x){console.error("[Rehydration] Error restoring session:",x),sessionStorage.removeItem("veritas_active_poll_id")}}function ki(){if(console.log("initTeacherAuth firing"),sessionStorage.getItem("veritas_session_token")){console.log("[Auth] Teacher Authenticated");var e=document.getElementById("dashboard-root");e&&(e.style.display="flex"),Ao()}else{console.log("[Auth] No teacher session found. Initiating Login Flow.");var e=document.getElementById("dashboard-root");e&&(e.style.display="none"),window.LoginManager?(LoginManager.init(function(n){console.log("[Auth] Teacher Login Successful:",n.email),sessionStorage.setItem("veritas_teacher_email",n.email),setTimeout(function(){window.location.reload()},500)}),LoginManager.show()):alert("Auth System Missing")}}function To(){dr=new Se({inputId:"poll-search-input",containerId:"poll-search-container",onSelect:function(e){if(e.type==="class"){var n=document.getElementById("poll-filter-select");if(n){n.value=e.value;var t=new Event("change");n.dispatchEvent(t)}}}}),cr=new Se({inputId:"student-search-input",containerId:"student-search-container",onSelect:function(e){}}),ur=new Se({inputId:"analytics-student-search",containerId:"analytics-student-search-container",onSelect:function(e){e.student&&(Ml(e.student),document.getElementById("analytics-student-search").value="")}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",function(){setTimeout(ki,50)}):(console.log("[Info] Document already ready, firing initTeacherAuth immediately"),setTimeout(ki,50)),window.expandImage=function(e){var n=e.src,t='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:pointer;" onclick="this.remove()">';t+='<img src="'+n+'" style="max-width:90%;max-height:90%;"/>',t+="</div>",document.body.insertAdjacentHTML("beforeend",t)};function qo(){console.log("âœ¨ Enhanced UI systems initialized (Phase 3)");var e=document.getElementById("live-question-image");e&&e.addEventListener("click",function(n){n.stopPropagation(),n.preventDefault(),this.src&&this.style.display!=="none"&&window.expandImage(this)})}function No(e){var n=lr[e];return n?n.emoji+" "+n.label:null}var L=0,zt=null,st="LIVE_POLL",je=!1,ge={timeLimitMinutes:60,accessCode:"",availableFrom:"",dueBy:""},Ii="updated_desc",wt="all",Y={},M="",wn=[],kt="all",kn="",Vt=[],Mo=null,jt=null,mr=!1,fr=!1,It=null;const fa=!1;function Ro(e){console.log("[Auth] Rendering Logout button for:",e.email);var n=document.querySelector(".header-right");if(n&&!document.getElementById("teacher-logout-btn")){var t=document.createElement("button");t.id="teacher-logout-btn",t.className="flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-all bg-white/10 hover:bg-white/20 text-white border border-white/20",t.innerHTML=`
          <span class="material-symbols-outlined text-[18px]">logout</span>
          <span class="hidden sm:inline">Logout</span>
        `,t.onclick=function(){Li()},t.title="Signed in as "+(e.email||"Teacher"),n.insertBefore(t,n.firstChild)}}function Li(){confirm("Are you sure you want to log out?")&&(console.log("[Auth] Initiating logout..."),firebase.auth().signOut().then(function(){console.log("[Auth] Signed out from Firebase."),sessionStorage.removeItem("veritas_session_token"),sessionStorage.removeItem("veritas_teacher_email"),localStorage.removeItem("veritas_teacher_email"),window.SESSION_TOKEN=null,window.TEACHER_EMAIL=null,window.DATA_LOAD_INITIATED=!1,window.location.reload()}).catch(function(e){console.error("[Auth] Logout failed:",e),P("error","Logout Failed",e.message)}))}window.logout=Li;function gr(){if(console.log("[Veritas] Initializing Firebase backend..."),typeof FIREBASE_CONFIG<"u"&&FIREBASE_CONFIG){if(typeof firebase>"u"){console.error("[Firebase] SDK not loaded! Retrying in 500ms..."),setTimeout(gr,500);return}if(!firebase.apps.length)try{firebase.initializeApp(FIREBASE_CONFIG),console.log("[Firebase] App initialized successfully.")}catch(e){console.error("[Firebase] Initialization error:",e),P("error","Critical Error","Failed to initialize backend. Please refresh.");return}}else{console.error("[Firebase] FIREBASE_CONFIG missing!"),P("error","Configuration Error","Backend config missing.");return}window.AUTH_READY=!1;try{firebase.auth().onAuthStateChanged(function(e){if(e){var n=Date.now();console.log("[Auth] User authenticated:",e.email,"| UID:",e.uid),sessionStorage.setItem("veritas_session_token",e.uid),sessionStorage.setItem("veritas_teacher_email",e.email),window.SESSION_TOKEN=e.uid,window.TEACHER_EMAIL=e.email,window.LoginManager&&window.LoginManager.hide();var t=document.getElementById("dashboard-root");t&&(t.style.display="flex"),t&&(t.style.display="flex"),ht&&(ht.style.display="none"),Ro(e),e.getIdToken().then(function(){window.AUTH_READY=!0,console.log("[Auth] Token validated - API calls enabled"),window.DATA_LOAD_INITIATED||(window.DATA_LOAD_INITIATED=!0,Ca(),Fn())}).catch(function(r){console.error("[Auth] Token validation failed:",r),window.AUTH_READY=!1}),firebase.functions().httpsCallable("verifyTeacher")().then(function(r){var i=Date.now()-n;r.data.isTeacher?console.log("[Auth] Teacher authorized:",e.email,"(Verified in "+i+"ms)"):console.warn("[Auth] Unauthorized teacher access attempt:",e.email,r.data.reason||"")}).catch(function(r){console.error("[Auth] VerifyTeacher Error:",r)})}else{console.log("[Auth] No teacher session found. Initiating Login Flow."),window.AUTH_READY=!1,window.DATA_LOAD_INITIATED=!1,ht&&(ht.style.display="none");var t=document.getElementById("dashboard-root");t&&(t.style.display="none"),window.LoginManager?window.LoginManager.show():setTimeout(function(){window.LoginManager&&window.LoginManager.show()},500)}})}catch(e){console.error("[Auth] Error setting up auth listener:",e),P("error","Auth Setup Failed","Please refresh the page.")}}function Ci(){var e=document.getElementById("header-datetime");if(e){var n=new Date,t={month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"};e.textContent=n.toLocaleDateString("en-US",t)}}Ci(),setInterval(Ci,6e4);var pr=null,Do=new Promise(function(e){function n(){pr=window.VeritasModal||Fo(),window.VeritasModal=pr,e(pr)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n,{once:!0}):n()});function vr(e){return Do.then(function(n){return e(n)})}function S(e,n){return vr(function(t){return t.alert(Object.assign({message:e},n||{}))})}function Qe(e,n){return vr(function(t){return t.confirm(Object.assign({message:e},n||{}))})}function br(e,n){return vr(function(t){return t.prompt(Object.assign({message:e},n||{}))})}function Po(){var e=document.getElementById("veritas-modal-root");if(e)return e;var n=document.createElement("div");return n.id="veritas-modal-root",n.className="veritas-modal-root",n.setAttribute("aria-hidden","true"),n.innerHTML='<div class="veritas-modal-backdrop"></div><div class="veritas-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="veritas-modal-title" aria-describedby="veritas-modal-message"><div class="veritas-modal-header"><h2 id="veritas-modal-title">Notice</h2></div><div class="veritas-modal-body"><p id="veritas-modal-message"></p><div id="veritas-modal-subtext" class="veritas-modal-subtext"></div><div id="veritas-modal-input" class="veritas-modal-input" style="display: none;"><label for="veritas-modal-input-field" class="sr-only">Input</label><input id="veritas-modal-input-field" type="text" autocomplete="off" /></div></div><div class="veritas-modal-actions"><button type="button" class="veritas-modal-button secondary" data-action="cancel">Cancel</button><button type="button" class="veritas-modal-button primary" data-action="confirm"><span class="veritas-modal-spinner" aria-hidden="true"></span><span>Confirm</span></button></div></div>',(document.body||document.documentElement).appendChild(n),n}function Fo(){var e=Po(),n=e.querySelector(".veritas-modal-dialog"),t=e.querySelector("#veritas-modal-title"),a=e.querySelector("#veritas-modal-message"),r=e.querySelector("#veritas-modal-subtext"),i=e.querySelector("#veritas-modal-input"),s=e.querySelector("#veritas-modal-input-field"),d=e.querySelector('[data-action="confirm"]'),o=e.querySelector('[data-action="cancel"]'),l=d.querySelector("span:not(.veritas-modal-spinner)"),c=!1,u=null,m=null,g=null,p=!0,v=[];function y(w){var A=[].slice.call(document.body.children);w?(v=[],A.forEach(function(T){T!==e&&(v.push({node:T,ariaHidden:T.getAttribute("aria-hidden"),inert:"inert"in T?T.inert:null}),T.setAttribute("aria-hidden","true"),"inert"in T&&(T.inert=!0))})):(v.forEach(function(T){T.ariaHidden===null?T.node.removeAttribute("aria-hidden"):T.node.setAttribute("aria-hidden",T.ariaHidden),"inert"in T.node&&(T.inert!==null?T.node.inert=T.inert:T.node.inert=!1)}),v=[])}function E(w){w?(d.classList.add("loading"),d.setAttribute("disabled","disabled"),o.style.display!=="none"&&o.setAttribute("disabled","disabled")):(d.classList.remove("loading"),d.removeAttribute("disabled"),o.removeAttribute("disabled"))}function q(){var w='button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',A=[].slice.call(n.querySelectorAll(w));return A.filter(function(T){return!T.hasAttribute("disabled")&&T.offsetParent!==null})}function B(){var w=q();w.length>0?w[0].focus():n.focus()}function x(w){if(c)if(w.key==="Escape"){if(!p)return;w.preventDefault(),V()}else if(w.key==="Tab"){var A=q();if(A.length===0){w.preventDefault();return}var T=A.indexOf(document.activeElement);w.shiftKey?T<=0&&(A[A.length-1].focus(),w.preventDefault()):T===A.length-1&&(A[0].focus(),w.preventDefault())}else w.key==="Enter"&&u&&u.mode==="prompt"&&document.activeElement===s&&(w.preventDefault(),N())}function C(w){c&&(n.contains(w.target)||(w.stopPropagation(),B()))}function R(w){c=!1,e.classList.remove("is-active"),e.setAttribute("aria-hidden","true"),document.body.classList.remove("veritas-modal-open"),e.removeEventListener("keydown",x,!0),document.removeEventListener("focus",C,!0),y(!1),E(!1),g&&typeof g.focus=="function"&&setTimeout(function(){g.focus()},0),m&&m(w),u=null,m=null}function N(){if(c){E(!0);var w=u?u.mode:"alert",A;w==="prompt"?A=s.value:w==="confirm"&&(A=!0),R(A)}}function V(){if(c){var w=u?u.mode:"alert";if(w==="alert"){R(void 0);return}w==="confirm"?R(!1):w==="prompt"&&R(null)}}function W(w,A){return A=A||{},u=Object.assign({},A,{mode:w}),p=A.allowEscape!==!1,t.textContent=A.title||(w==="confirm"?"Please Confirm":w==="prompt"?"Enter Response":"Notice"),A.html?a.innerHTML=A.html:a.textContent=A.message||"",A.subtext?(r.style.display="block",r.textContent=A.subtext):(r.style.display="none",r.textContent=""),w==="prompt"?(i.style.display="flex",s.value=A.defaultValue||"",A.placeholder?s.placeholder=A.placeholder:s.removeAttribute("placeholder")):(i.style.display="none",s.value="",s.removeAttribute("placeholder")),l.textContent=A.confirmText||(w==="confirm"?"Confirm":w==="prompt"?"Submit":"OK"),A.destructive?d.classList.add("destructive"):d.classList.remove("destructive"),o.style.display=w==="alert"?"none":"inline-flex",o.textContent=A.cancelText||"Cancel",E(!1),g=document.activeElement,e.classList.add("is-active"),e.setAttribute("aria-hidden","false"),document.body.classList.add("veritas-modal-open"),c=!0,e.addEventListener("keydown",x,!0),document.addEventListener("focus",C,!0),w==="prompt"?(s.focus(),s.select()):w==="confirm"&&A.focusCancel?o.focus():d.focus(),y(!0),new Promise(function(T){m=T})}return d.addEventListener("click",N),o.addEventListener("click",V),e.addEventListener("click",function(w){if(w.target===e||w.target.classList.contains("veritas-modal-backdrop")){if(!u||u.allowBackdropClose===!1)return;V()}}),{alert:function(w){return W("alert",w).then(function(){})},confirm:function(w){return W("confirm",w).then(function(A){return A!==!1})},prompt:function(w){return W("prompt",w).then(function(A){return A})}}}function I(e,n){var t=document.getElementById(e);return t?(t.addEventListener("click",n),t):null}function Oo(e,n,t){var a=document.getElementById(e);return a?(a.addEventListener(n,t),a):null}function Uo(e,n,t){e&&e.addEventListener("change",n)}function ga(){var e=document.getElementById("filter-locked-only-btn"),n=document.getElementById("filter-all-btn");e&&(typeof Bt<"u"&&Bt==="locked"?(e.classList.add("bg-red-500/30"),e.classList.remove("bg-red-500/10")):(e.classList.remove("bg-red-500/30"),e.classList.add("bg-red-500/10"))),n&&(typeof Bt<"u"&&Bt==="all"?(n.classList.add("bg-primary/30"),n.classList.remove("bg-primary/10")):(n.classList.remove("bg-primary/30"),n.classList.add("bg-primary/10")))}function _o(){var e=document.getElementById("exited-students-panel");e&&(e.classList.remove("hidden"),e.scrollIntoView({behavior:"smooth",block:"start"}))}function Si(){var e=In?"menu_open":"menu",n=In?"Hide navigation":"Show navigation";Ti.forEach(function(t){if(t){var a=t.querySelector(".material-symbols-outlined");a&&(a.textContent=e),t.setAttribute("aria-label",n),t.setAttribute("aria-expanded",In?"true":"false")}})}function Ye(e){Qt&&(In=e,e?(Qt.classList.remove("w-0","p-0","border-none","opacity-0"),Qt.classList.add("w-64","p-4","border-r","flex")):(Qt.classList.remove("w-64","p-4","border-r"),Qt.classList.add("w-0","p-0","border-none","opacity-0"),Qt.classList.add("flex")),Si())}function Ho(e){e&&e.preventDefault(),Ye(!In)}function Ai(e){var n=I(e,Ho);n&&Ti.push(n)}function pa(e){e&&!e.dataset.defaultHtml&&(e.dataset.defaultHtml=e.innerHTML)}function zo(e){return'<span class="flex w-full items-center justify-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"></span><span>'+h(e||"Loading...")+"</span></span>"}function G(e,n,t){e&&(n?(pa(e),e.disabled=!0,e.setAttribute("aria-busy","true"),e.setAttribute("aria-disabled","true"),e.innerHTML=zo(t)):(e.dataset.defaultHtml&&(e.innerHTML=e.dataset.defaultHtml),e.disabled=!1,e.removeAttribute("aria-busy"),e.removeAttribute("aria-disabled")))}function Bi(){mr||fr||window.google&&google.charts&&typeof google.charts.load=="function"&&(fr=!0,google.charts.load("current",{packages:["corechart"]}),google.charts.setOnLoadCallback(function(){mr=!0,fr=!1,It&&(clearInterval(It),It=null);try{Vo()}catch(e){console.error("Post-chart bootstrap failed:",e)}}))}function Vo(){if(typeof Un=="function"&&typeof Q<"u"&&Q)try{Un()}catch(e){console.error("Analytics redraw failed:",e)}}var Z=document.getElementById("poll-select"),U=document.getElementById("start-session-main-btn"),De=document.getElementById("send-link-btn"),K=document.getElementById("view-links-btn");document.getElementById("header-session-controls");var Qt=document.getElementById("dashboard-sidebar"),In=window.innerWidth>=1024,Ti=[],Wt=document.getElementById("dashboard");document.getElementById("live-view");var qi=document.getElementById("live-mobile-nav"),Ni=document.getElementById("live-mobile-actions");document.getElementById("roster-manager"),document.getElementById("archived-view"),document.getElementById("analytics-view");var va=document.getElementById("header-default"),ba=document.getElementById("header-live"),pe=document.getElementById("header-calc-toggle"),ya=document.getElementById("header-calc-state"),ha=document.getElementById("poll-creator-modal"),ot=document.getElementById("student-links-modal"),Mi=document.getElementById("poll-sort-select"),Ln=document.getElementById("poll-filter-select"),Cn=document.getElementById("poll-search-input"),Sn=document.getElementById("poll-search-clear-btn"),Ae=document.getElementById("polls-card-view"),xa=document.getElementById("polls-table-body"),Kt=document.getElementById("polls-empty-state"),lt=document.getElementById("class-select"),An=document.querySelectorAll(".builder-session-toggle"),yr=document.getElementById("secure-assessment-settings"),Gt=document.getElementById("secure-session-meta"),$t=document.getElementById("secure-time-limit-input"),Yt=document.getElementById("secure-access-code-input"),Xt=document.getElementById("secure-available-input"),Jt=document.getElementById("secure-due-input"),Zt=document.getElementById("student-manager-modal"),Ri=document.getElementById("student-manager-name"),Di=document.getElementById("student-manager-status"),Pi=document.getElementById("student-manager-progress"),Fi=document.getElementById("student-manager-time"),Oi=document.getElementById("student-manager-extra"),Ui=document.getElementById("student-manager-connection"),hr=document.getElementById("student-manager-connection-dot"),xr=document.getElementById("student-manager-message"),_i=document.getElementById("student-manager-loading"),Er=document.getElementById("student-manager-add-5"),wr=document.getElementById("student-manager-add-10"),Bn=document.getElementById("student-manager-pause"),Lt=document.getElementById("student-manager-unlock"),kr=document.getElementById("student-manager-force-submit"),Hi=document.getElementById("student-manager-close"),Ir=document.getElementById("bulk-time-input"),en=document.getElementById("bulk-time-all-btn"),dt=document.getElementById("bulk-time-selected-btn"),zi=document.getElementById("bulk-selection-count"),Ea=document.getElementById("bulk-selection-clear"),Tn=document.getElementById("bulk-selected-label"),Vi=document.getElementById("question-sort-reset-btn"),ji=document.getElementById("question-sort-help"),ct=document.getElementById("question-navigator"),qn=document.getElementById("archived-class-filter"),wa=document.getElementById("archived-list"),ka=document.getElementById("archived-empty-state"),Ia=document.getElementById("archived-detail"),jo=document.getElementById("archived-poll-title"),Qo=document.getElementById("archived-poll-meta"),Wo=document.getElementById("archived-question-count"),Ko=document.getElementById("archived-response-count"),Qi=document.getElementById("archived-questions-container"),Lr=document.getElementById("roster-class-list"),Wi=document.getElementById("roster-class-title"),Cr=document.getElementById("roster-empty-state"),Sr=document.getElementById("roster-table-wrapper"),Nn=document.getElementById("roster-table-body"),re=document.getElementById("roster-status"),Mn=document.getElementById("rename-class-btn"),Rn=document.getElementById("delete-class-btn"),Ki=document.getElementById("add-class-btn"),Gi=document.getElementById("add-student-row-btn"),Dn=document.getElementById("save-roster-btn"),$i=document.getElementById("refresh-archived-btn");document.getElementById("emulator-controls");var La=document.getElementById("emulator-enabled");document.getElementById("emulator-options"),document.getElementById("emulator-student-count"),document.getElementById("emulator-concurrent");var Yi=!1;pa(U),pa(De),pa(K),window.VeritasDebug={initialize:gr,loadInitialData:Ca,loadDashboardSummary:Fn,forceSync:function(){Ca(),Fn()}},gr(),window.google&&google.charts&&typeof google.charts.load=="function"?Bi():(console.warn("Google Charts unavailable â€“ continuing initialization without charts."),It=setInterval(function(){window.google&&google.charts&&typeof google.charts.load=="function"&&Bi()},400),setTimeout(function(){It&&(clearInterval(It),It=null)},8e3));function Xi(){try{console.log("[App] Initializing dashboard bindings..."),U=document.getElementById("start-session-main-btn"),Z=document.getElementById("poll-select"),I("nav-create-poll",function(){console.log("Create New Poll button clicked - opening wizard via Wizard.init()"),Ye(!1),window.Wizard&&window.Wizard.init?Wizard.init():console.error("Wizard system not loaded")}),I("nav-polls-list",function(){Fe(),Ye(!0)}),I("nav-rosters",function(){Go(),Ye(!1)}),I("nav-archived",function(){$o(),Ye(!1)}),I("nav-analytics",function(){Il(),Ye(!1)}),I("close-modal-btn",Ns),I("close-links-modal-btn",td),I("close-preview-modal-btn",_a),I("add-question-btn",Rd),I("save-poll-btn",_d),I("import-from-bank-btn",Ld),I("close-question-bank-btn",Ms),I("import-selected-btn",Ad),I("ai-suggest-btn",Bd),I("close-ai-modal-btn",Ds),I("generate-ai-btn",Nd),I("add-stimulus-btn",function(){typeof Fs=="function"&&(Fs(),setTimeout(function(){window.QuillManager&&Re.init&&Re.init("stimulus-content-editor","","Enter passage content...",function(c){})},100))}),I("close-stimulus-modal-btn",ai),I("cancel-stimulus-btn",ai),I("create-stimulus-btn",Md),Oo("new-poll-name","input",z),Uo(lt,z,"class-select"),An&&An.length&&An.forEach(function(c){c.addEventListener("click",function(){var u=this.dataset.sessionType;typeof ei=="function"&&ei(u)})}),$t&&$t.addEventListener("input",function(){jn(),z()}),Yt&&Yt.addEventListener("input",function(){this.value=(this.value||"").toUpperCase(),jn(),z()}),Xt&&Xt.addEventListener("change",function(){jn(),z()}),Jt&&Jt.addEventListener("change",function(){jn(),z()}),typeof Jr=="function"&&Jr(),typeof Qa=="function"&&Qa(),typeof Zr=="function"&&Zr(),Cn&&Cn.addEventListener("input",function(){at=(this.value||"").trim(),tn(),qr()}),Sn&&Sn.addEventListener("click",function(){at="",Cn&&(Cn.value="",Cn.focus()),tn(),qr()}),qr(),Xr(),Vi&&Vi.addEventListener("click",function(){gd()}),ct&&(ct.addEventListener("dragover",xd),ct.addEventListener("drop",Ed)),U?(console.log("[DashboardBindings] Found startPollBtn (ID: start-session-main-btn). Binding click event..."),U.removeEventListener("click",Hr),U.addEventListener("click",Hr),console.log("[DashboardBindings] Bound onStartPoll to start-session-main-btn")):console.error("[DashboardBindings] CRITICAL: startPollBtn (ID: start-session-main-btn) NOT FOUND in DOM.");var e=document.getElementById("wizard-calculator-toggle");e&&e.addEventListener("change",function(){typeof b<"u"&&(b.calculatorEnabled=this.checked)}),I("header-start-btn",ls),I("header-end-show-btn",Da),I("header-stop-btn",ms),I("header-present-btn",Oc);var n=document.getElementById("header-calc-toggle");n&&n.addEventListener("click",Rl),I("live-more-actions-btn",function(c){c.stopPropagation(),console.log("[LiveUI] Three-dots menu clicked");var u=document.getElementById("live-more-menu");u&&(u.classList.toggle("hidden"),console.log("[LiveUI] Menu hidden:",u.classList.contains("hidden")))}),document.addEventListener("click",function(c){var u=document.getElementById("live-more-menu"),m=document.getElementById("live-more-actions-btn");u&&!u.classList.contains("hidden")&&!u.contains(c.target)&&(!m||!m.contains(c.target))&&u.classList.add("hidden")}),I("header-edit-poll-btn",function(){f&&f.pollId&&Aa(f.pollId)}),I("header-back-btn",cs),I("header-prev-btn",cs),I("header-next-btn",zn),document.addEventListener("click",function(c){var u=document.getElementById("live-more-menu"),m=document.getElementById("live-more-actions-btn");u&&!u.classList.contains("hidden")&&!u.contains(c.target)&&!m.contains(c.target)&&u.classList.add("hidden");var g=document.getElementById("student-inspector-panel");if(g&&!g.classList.contains("hidden")){var p=g.contains(c.target),v=c.target.closest(".student-status-card")||c.target.closest(".student-row");!p&&!v&&jr()}}),I("header-reset-question-btn",Pa),I("hide-results-btn",Dl),I("strip-next-btn",zn),Ai("dashboard-sidebar-toggle"),Ai("dashboard-sidebar-toggle-live"),Si();var t=document.querySelectorAll(".live-mobile-tab");t.forEach(function(c){c.addEventListener("click",function(){var u=c.getAttribute("data-panel");Br(u)})}),Ar(),I("focus-lockouts-btn",_o);var a=document.getElementById("hud-focus-lockouts-btn");a&&(a.onclick=function(c){c.stopPropagation();var u=document.getElementById("locked-students-popover");u&&u.classList.toggle("hidden")}),I("start-btn",Oa),I("pause-btn",dn),I("reset-btn",vs),I("add-10s-btn",function(){qt(),Ke(10)}),I("subtract-10s-btn",function(){qt(),Ke(-10)}),I("mobile-start-btn",Oa),I("mobile-pause-btn",dn),I("mobile-reset-btn",Pa),I("mobile-next-btn",zn),I("mobile-reveal-btn",Da),I("mobile-resume-btn",ls),I("mobile-stop-btn",ms),I("add-10s-btn-mobile",function(){qt(),Ke(10)}),I("subtract-10s-btn-mobile",function(){qt(),Ke(-10)}),I("mobile-locks-btn",function(){var c=document.getElementById("hud-focus-lockouts-btn");c&&!c.disabled&&c.click()});var r=document.getElementById("timer-display");r&&(r.addEventListener("blur",function(){qt(),mt()}),r.addEventListener("keydown",function(c){c.key==="Enter"&&r.blur()})),mt(),te("Timer idle.","info"),I("send-link-btn",Kr),I("view-links-btn",Ua),I("header-send-link-btn",Kr),I("header-view-links-btn",Ua),console.log("[DashboardBindings] Bound link action buttons."),I("add-30s-btn-preset",function(){qt(),Ke(30);var c=document.getElementById("live-more-menu");c&&c.classList.add("hidden")}),I("add-60s-btn-preset",function(){qt(),Ke(60);var c=document.getElementById("live-more-menu");c&&c.classList.add("hidden")});var i=document.getElementById("student-search-input");i&&i.addEventListener("input",function(){bo=this.value,ve()}),I("filter-all-btn",function(){ps("ALL")}),I("filter-locked-only-btn",function(){ps("LOCKED")});var s=document.getElementById("student-status-filter-select");s&&s.addEventListener("change",function(){Bt=this.value,ga(),ve()});var d=document.getElementById("student-correctness-filter-select");d&&d.addEventListener("change",function(){Vl=this.value,ve()});var o=document.getElementById("student-sort-select");o&&o.addEventListener("change",function(){if(ke.column=this.value,this.value==="recent"&&ke.direction==="asc"){ke.direction="desc";var c=document.querySelector("#student-sort-direction-btn span");c&&(c.textContent="north")}else{var u=document.querySelector("#student-sort-direction-btn span");u&&(u.textContent=ke.direction==="asc"?"south":"north")}ve()});var l=document.getElementById("student-sort-direction-btn");l&&l.addEventListener("click",function(){ke.direction=ke.direction==="asc"?"desc":"asc";var c=this.querySelector("span");c&&(c.textContent=ke.direction==="asc"?"south":"north"),ve()}),document.querySelectorAll("th[data-sort]").forEach(function(c){c.addEventListener("click",function(){var u=this.dataset.sort;ke.column===u?ke.direction=ke.direction==="asc"?"desc":"asc":(ke.column=u,ke.direction="asc"),document.querySelectorAll("th[data-sort] .sort-icon").forEach(function(g){g.textContent="unfold_more"});var m=this.querySelector(".sort-icon");m&&(m.textContent=ke.direction==="asc"?"arrow_upward":"arrow_downward"),ve()})}),Z?Z.addEventListener("change",St):console.warn("Missing change target: poll-select"),Mi?Mi.addEventListener("change",function(){Ii=this.value,tn()}):console.warn("Missing change target: poll-sort-select"),Ln?Ln.addEventListener("change",function(){wt=this.value,tn()}):console.warn("Missing change target: poll-filter-select"),qn?qn.addEventListener("change",function(){kt=this.value,qa()}):console.warn("Missing change target: archived-class-filter"),Ki?Ki.addEventListener("click",pl):console.warn("Missing click target: add-class-btn"),Gi?Gi.addEventListener("click",cl):console.warn("Missing click target: add-student-row-btn"),I("bulk-add-students-btn",fl),I("cancel-bulk-add-btn",Or),I("confirm-bulk-add-btn",gl),Dn?Dn.addEventListener("click",ml):console.warn("Missing click target: save-roster-btn"),Mn?Mn.addEventListener("click",vl):console.warn("Missing click target: rename-class-btn"),Rn?Rn.addEventListener("click",bl):console.warn("Missing click target: delete-class-btn"),$i?$i.addEventListener("click",function(){is(!0)}):console.warn("Missing click target: refresh-archived-btn")}catch(c){console.error("[App] Binding Error:",c)}}function Pe(e){console.log("[UI] setMainSection called via:",e);var n=document.querySelector("main");n&&(n.scrollTop=0);var t=document.getElementById("dashboard"),a=document.getElementById("live-view"),r=document.getElementById("roster-manager"),i=document.getElementById("archived-view"),s=document.getElementById("analytics-view"),d=document.getElementById("individual-timed-view"),o=document.getElementById("create-poll-view"),l=document.getElementById("dashboard-root"),c=document.getElementById("header-session-controls");Ye(e==="dashboard");function u(){var m=document.getElementById("header-default"),g=document.getElementById("header-live"),p=document.getElementById("live-control-bar"),v=document.getElementById("fab-container");e==="create-poll"?(l&&(l.style.display="none"),o&&(o.style.display="flex")):(l&&(l.style.display="flex"),o&&(o.style.display="none")),e==="live"?(console.log("[UI] Switching to live header"),m&&(m.style.display="none"),g&&(g.style.display="flex"),p&&p.classList.remove("hidden"),p&&(p.style.display="flex"),v&&(v.style.display="block")):(console.log("[UI] Switching to default header"),m&&(m.style.display="flex"),g&&(g.style.display="none"),p&&p.classList.add("hidden"),p&&(p.style.display="none"),v&&(v.style.display="none")),t&&(t.style.display=e==="dashboard"?"block":"none"),a&&(a.style.display=e==="live"?"grid":"none"),r&&(r.style.display=e==="roster"?"grid":"none"),i&&(i.style.display=e==="archived"?"grid":"none"),s&&(s.style.display=e==="analytics"?"flex":"none"),d&&(d.style.display=e==="individual-timed"?"block":"none");var y=document.querySelectorAll(".sidebar-nav-btn[data-section-target]");y.forEach(function(E){var q=E.getAttribute("data-section-target"),B=q===e;E.classList.toggle("is-active",B),E.setAttribute("aria-current",B?"page":"false"),B?E.classList.add("font-semibold"):E.classList.remove("font-semibold")}),c&&(e==="dashboard"?c.classList.remove("hidden"):c.classList.add("hidden")),e==="live"&&Br(xn||"question"),Ar()}document.startViewTransition?document.startViewTransition(u):u()}function Ar(){qi&&(qi.style.display="none"),Ni&&(Ni.style.display="none"),Br(xn||"question")}function Br(e){xn=e||"question";var n=document.querySelectorAll("[data-mobile-panel]"),t=window.innerWidth<=1024;n.forEach(function(r){var i=r.getAttribute("data-mobile-panel")===xn||!t;r.classList.toggle("is-active",i)});var a=document.querySelectorAll(".live-mobile-tab");a.forEach(function(r){var i=r.getAttribute("data-panel")===xn;r.classList.toggle("is-active",i),r.setAttribute("aria-selected",i?"true":"false")})}window.addEventListener("resize",function(){Ar()});function Pn(){de&&(clearInterval(de),de=null),He.stop(),jt&&(clearInterval(jt),jt=null),Nt(),ft(),se=me,fe=!1,Mt(),te("Timer idle.","info")}function Fe(){Pn(),ze=!1,f={},O=null,Ne=null,Ot=0,He.stop(),va.style.display="flex",ba.style.display="none",Pe("dashboard"),Ye(!0),setTimeout(function(){Fn()},100)}function Fn(){console.log("[Firebase] loadDashboardSummary: Skipped Firestore listener.")}function Go(){Pn(),va.style.display="flex",ba.style.display="none",Pe("roster"),Object.keys(Y).length===0?nn():(Fr(),M?On():(Cr.classList.remove("hidden"),Sr.classList.add("hidden"),Mn.classList.add("hidden"),Rn.classList.add("hidden")))}function $o(){Pn(),va.style.display="flex",ba.style.display="none",Pe("archived"),wn.length===0?is():(qa(),Ur())}function Ca(){O=null,Ne=null,Ot=0,He.stop(),console.log("[Firebase] loadInitialData: Fetching polls and classes from RTDB...");var e=firebase.auth().currentUser;if(!e||!e.email){console.warn("[Firebase] loadInitialData skipped: No authenticated teacher (User: "+(e?"Anonymous":"Null")+").");return}var n=firebase.database();Promise.all([n.ref("polls").once("value"),n.ref("rosters/classes").once("value")]).then(function(t){var a=t[0],r=t[1],i=a.val()||{},s=r.val()||[],d=Object.keys(i).map(function(o){var l=i[o];return l.id=o,l});d.sort(function(o,l){return(l.updatedAt||0)-(o.updatedAt||0)}),console.log("[Firebase] Loaded "+d.length+" polls and "+s.length+" classes."),Yo({polls:d,classes:s})}).catch(function(t){console.error("[Firebase] Failed to load initial data:",t),P("error","Data Load Error","Failed to load polls. Please refresh.")})}function Yo(e){e||(console.warn("onDashboardDataLoaded received null/undefined data"),e={polls:[],classes:[]}),ht.style.display="none";try{ae=e.polls||[];try{Tr(e.classes||[])}catch(n){console.warn("refreshClassOptions error:",n)}try{tn()}catch(n){console.error("refreshPollViews CRITICAL FAILURE:",n)}if(e.activePollId&&e.activePoll)try{f=e.activePoll,sn(e.activePoll),Pe("live")}catch(n){console.error("Failed to auto-route to active poll",n),Wt&&(Wt.style.display="block")}else try{Pe("dashboard")}catch(n){console.error("setMainSection failed:",n),Wt&&(Wt.style.display="block")}setTimeout(function(){try{Mo||Fn()}catch(n){console.warn("Summary load failed",n)}},100)}catch(n){console.error("Error loading dashboard:",n),F(n),Wt&&(Wt.style.display="block")}}function Xo(e){e=e||Nr();var n=Z.value;Z.innerHTML='<option value="">-- Choose a poll --</option>';var t=!1;e.forEach(function(a){var r=document.createElement("option");r.value=a.pollId;var i=Array.isArray(a.questions)?a.questions.length:0,s=a.pollName+" ("+(a.className||"Unassigned")+") - "+i+" questions";if(pt(a.sessionType)){var d=Zi(a),o=Ba(a);s="ðŸ”’ "+s,d&&(s+=" â€¢ "+d+" min"),o&&(s+=" â€¢ Code "+o)}r.textContent=s,a.pollId===n&&(r.selected=!0,t=!0),Z.appendChild(r)}),t||(Z.value=""),St()}function Tr(e){Vt=(e||[]).map(function(a){return(a||"").toString().trim()}).filter(function(a){return a!==""});var n=new Set;if(Vt.forEach(function(a){n.add(a)}),Object.keys(Y).forEach(function(a){a&&n.add(a)}),ae.forEach(function(a){a.className&&n.add(a.className)}),be=Array.from(n).sort(),window.ALL_CLASSES=be,lt){var t=lt.value;lt.innerHTML='<option value="">-- Select Class --</option>',be.forEach(function(a){var r=document.createElement("option");r.value=a,r.textContent=a,lt.appendChild(r)}),t&&be.indexOf(t)!==-1?lt.value=t:lt.value=""}Jo()}function Jo(){var e=wt;Ln.innerHTML='<option value="all">All classes</option>',be.forEach(function(t){var a=document.createElement("option");a.value=t,a.textContent=t,Ln.appendChild(a)}),e&&be.indexOf(e)!==-1?wt=e:wt="all",Ln.value=wt;var n=kt;qn.innerHTML='<option value="all">All classes</option>',be.forEach(function(t){var a=document.createElement("option");a.value=t,a.textContent=t,qn.appendChild(a)}),n&&be.indexOf(n)!==-1?kt=n:kt="all",qn.value=kt}function qr(){Sn&&(at?Sn.classList.remove("hidden"):Sn.classList.add("hidden"))}function Zo(e,n){if(!n)return!0;var t=(e&&e.pollName?e.pollName:"").toLowerCase();if(t.indexOf(n)!==-1)return!0;var a=(e&&e.className?e.className:"").toLowerCase();if(a.indexOf(n)!==-1)return!0;if(!e)return!1;if(Array.isArray(e.questions))for(var r=0;r<e.questions.length;r++){var i=e.questions[r]||{},s=(i.questionText||"").toLowerCase();if(s.indexOf(n)!==-1)return!0;var d=(i.topicTag||i.topic||"").toLowerCase();if(d.indexOf(n)!==-1)return!0;var o=(i.correctAnswer||"").toLowerCase();if(o&&o.indexOf(n)!==-1)return!0;for(var l=Array.isArray(i.options)?i.options:Array.isArray(i.answers)?i.answers:[],c=0;c<l.length;c++){var u=l[c]||{},m=(u.text||u.label||"").toLowerCase();if(m.indexOf(n)!==-1)return!0}}var g=[];e&&Array.isArray(e.liveSessions)&&g.push(e.liveSessions),e&&Array.isArray(e.recentSessions)&&g.push(e.recentSessions),e&&Array.isArray(e.sessions)&&g.push(e.sessions);for(var p=0;p<g.length;p++)for(var v=g[p],y=0;y<v.length;y++){var E=v[y]||{},q=E.sessionName||E.title||"",B=(typeof q=="string"?q:String(q||"")).toLowerCase();if(B.indexOf(n)!==-1)return!0;var x=E.notes||E.summary||"",C=(typeof x=="string"?x:String(x||"")).toLowerCase();if(C.indexOf(n)!==-1)return!0;for(var R=Array.isArray(E.questions)?E.questions:[],N=0;N<R.length;N++){var V=R[N]||{},W=V.questionText||V.text||"",w=(typeof W=="string"?W:String(W||"")).toLowerCase();if(w.indexOf(n)!==-1)return!0;for(var A=Array.isArray(V.options)?V.options:[],T=0;T<A.length;T++){var _e=A[T]||{},nt=_e.text||_e.label||"",yt=(typeof nt=="string"?nt:String(nt||"")).toLowerCase();if(yt.indexOf(n)!==-1)return!0}}}return!1}function Nr(){var e=ae.slice();if(wt!=="all"&&(e=e.filter(function(t){return t.className===wt})),at){var n=at.toLowerCase();e=e.filter(function(t){return Zo(t,n)})}return e.sort(function(t,a){switch(Ii){case"updated_asc":return Sa(t)-Sa(a);case"name_asc":return(t.pollName||"").localeCompare(a.pollName||"");case"class_asc":var r=(t.className||"").localeCompare(a.className||"");return r!==0?r:(t.pollName||"").localeCompare(a.pollName||"");default:return Sa(a)-Sa(t)}}),e}function Sa(e){var n=e&&(e.updatedAt||e.lastRunAt||e.createdAt||""),t=n?Date.parse(n):NaN;return isNaN(t)?0:t}function tn(){var e=Nr();if(dr){var n=[];be.forEach(function(i){n.push({label:i,type:"class",subLabel:"Class"})}),ae.forEach(function(i){n.push({label:i.pollName,type:"poll",subLabel:i.className})}),dr.updateData(n)}try{el(e)}catch(i){console.error("Error rendering poll cards:",i),Ae&&(Ae.innerHTML='<div class="col-span-full text-center p-8 text-red-500 bg-red-50 rounded-lg border border-red-200">System Error: Unable to render polls. Please refresh or contact support.</div>')}try{il(e)}catch(i){console.error("Error rendering poll table:",i)}if(Xo(e),Kt)if(e.length===0){if(Kt.classList.remove("hidden"),at)var t=h(at);var a=Kt.querySelector("h3"),r=Kt.querySelector("p");at?(a&&(a.textContent="No Polls Found"),r&&(r.textContent='Your search for "'+t+'" did not return any results. Try different keywords.')):(a&&(a.textContent="Welcome to Your Poll Library"),r&&(r.textContent="This is where your polls will live. Create your first interactive poll to engage your students and gather real-time feedback."))}else Kt.classList.add("hidden")}function Aa(e,n){if(e){var t=null,a=firebase.database();a.ref("polls/"+e).once("value").then(function(r){var i=r.val();i?(i.pollId=e,ra(i,t)):S("Failed to load poll data (Not found).",{title:"Error"})}).catch(function(r){F(r)})}}function el(e){if(Ae&&(Ae.innerHTML="",!(!e||e.length===0))){var n=0;e.forEach(function(t){try{if(!t)return;var a=document.createElement("article");a.className="poll-card",t&&t.pollId&&(a.dataset.pollId=t.pollId),a.setAttribute("tabindex","0"),a.setAttribute("role","group");var r=h(t&&t.pollName?t.pollName:"Untitled Poll");a.setAttribute("aria-label","Poll: "+r);var i=h(t&&t.className?t.className:"Unassigned"),s=Array.isArray(t&&t.questions)?t.questions.length:0,d=tt(t.updatedAt||t.lastRunAt||t.createdAt),o=Ge(t.sessionType),l=[];l.push('<div class="mb-4">'),l.push('<h3 class="text-lg font-bold text-veritas-navy dark:text-white">'+r+"</h3>"),l.push("</div>"),l.push('<div class="flex flex-wrap gap-2 mb-4">');var c=Ji(o);if(l.push('<span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full '+c.badgeClass+'">'),l.push('<span class="material-symbols-outlined text-sm">'+c.icon+"</span>"),l.push(c.label),l.push("</span>"),l.push('<span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">'),l.push('<span class="material-symbols-outlined text-sm">quiz</span>'),l.push(s+" Questions"),l.push("</span>"),l.push("</div>"),o==="SECURE_ASSESSMENT"){var u=Mr(t),m=Ba(t),g=es(t);l.push('<div class="rounded-xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-900 dark:border-rose-500/40 dark:bg-rose-500/10 dark:text-rose-100 mb-4">'),u&&l.push('<div class="flex items-center gap-2 mb-2"><span class="material-symbols-outlined text-base">timer</span><span>'+h(u)+"</span></div>"),l.push('<div class="flex items-center gap-2 mb-2"><span class="material-symbols-outlined text-base">key</span><span>Access Code: '),m?l.push('<span class="font-semibold tracking-widest">'+h(m)+"</span>"):l.push('<span class="opacity-80">Not required</span>'),l.push("</span></div>"),g&&l.push('<div class="flex items-center gap-2"><span class="material-symbols-outlined text-base">calendar_month</span><span>'+h(g)+"</span></div>"),l.push("</div>")}l.push('<div class="text-xs text-gray-500 dark:text-gray-400 mb-4">Last updated: '+d+"</div>"),l.push('<div class="flex gap-2 mt-auto">'),l.push('<button type="button" class="flex-1 poll-card-btn primary poll-preview-btn" data-poll-id="'+(t&&t.pollId?t.pollId:"")+'" aria-label="Preview & Edit '+r+'"><span class="material-symbols-outlined text-base">visibility</span>Preview & Edit</button>'),l.push('<button type="button" class="poll-card-btn info poll-copy-btn" data-poll-id="'+(t&&t.pollId?t.pollId:"")+'" aria-label="Duplicate '+r+'"><span class="material-symbols-outlined text-base">content_copy</span></button>'),l.push('<button type="button" class="poll-card-btn danger poll-delete-btn" data-poll-id="'+(t&&t.pollId?t.pollId:"")+'" aria-label="Delete '+r+'"><span class="material-symbols-outlined text-base">delete</span></button>'),l.push("</div>"),a.innerHTML=l.join(""),a.addEventListener("click",function(p){if(!p.target.closest(".poll-card-btn")){var v=this.dataset.pollId;v&&(Z.value=v,St(),Fe())}}),a.addEventListener("keydown",function(p){if(!p.target.closest(".poll-card-btn")&&(p.key==="Enter"||p.key===" "||p.key==="Spacebar")){p.preventDefault();var v=this.dataset.pollId;if(!v)return;Z.value=v,St(),Fe()}}),Ae.appendChild(a)}catch(p){console.error("Error rendering individual poll card:",p,t),n++}}),n>0&&Ae.children.length===0&&(Ae.innerHTML='<div class="col-span-full text-center p-8 text-red-500 bg-red-50 rounded-lg border border-red-200">Unable to load polls due to a data error. Please contact support.</div>'),rs(Ae)}}function Ji(e){var n=Ge(e);return n==="SECURE_ASSESSMENT"?{label:"Secure Assessment",icon:"lock",badgeClass:"bg-rose-100 text-rose-800 dark:bg-rose-900 dark:text-rose-200"}:{label:"Live Poll",icon:"groups",badgeClass:"bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200"}}function Zi(e){if(!e)return null;var n=e.timeLimitMinutes;if(typeof n=="number"&&n>0)return n;if(typeof n=="string"&&n.trim()!==""){var t=parseInt(n,10);if(!isNaN(t)&&t>0)return t}if(e.secureSettings){var a=e.secureSettings.timeLimitMinutes;if(typeof a=="number"&&a>0)return a;if(typeof a=="string"&&a.trim()!==""){var r=parseInt(a,10);if(!isNaN(r)&&r>0)return r}}return null}function Mr(e){var n=Zi(e);if(!n)return"";var t=n===1?"minute":"minutes";return"Time limit: "+n+" "+t}function Ba(e){return e?e.accessCode&&e.accessCode.toString().trim()!==""?e.accessCode.toString().trim().toUpperCase():e.secureSettings&&e.secureSettings.accessCode?e.secureSettings.accessCode.toString().trim().toUpperCase():"":""}function tl(e){if(!e)return{availableFrom:"",dueBy:""};var n=e.availableFrom||"",t=e.dueBy||"";return!n&&e.secureSettings&&(n=e.secureSettings.availableFrom||""),!t&&e.secureSettings&&(t=e.secureSettings.dueBy||""),{availableFrom:n||"",dueBy:t||""}}function es(e){var n=tl(e),t=n.availableFrom,a=n.dueBy;return t&&a?"Window: "+tt(t)+" â†’ "+tt(a):t?"Opens "+tt(t):a?"Due "+tt(a):""}function nl(e){var n=Ge(e.sessionType),t=Ji(n),a='<div class="flex flex-col gap-1">';if(a+='<span class="inline-flex items-center gap-1.5 px-2 py-0.5 text-xs font-semibold rounded-full '+t.badgeClass+'">',a+='<span class="material-symbols-outlined text-sm">'+t.icon+"</span>"+t.label+"</span>",n==="SECURE_ASSESSMENT"){var r=Mr(e),i=Ba(e);r&&(a+='<span class="text-xs text-rose-700 dark:text-rose-200">'+h(r)+"</span>"),i?a+='<span class="text-xs text-rose-700 dark:text-rose-200">Code: <span class="font-semibold tracking-widest">'+h(i)+"</span></span>":a+='<span class="text-xs text-rose-700/80 dark:text-rose-200/80">No access code</span>'}return a+="</div>",a}var Ct=null;function Rr(){Ct&&(Ct.remove(),Ct=null,document.removeEventListener("click",ts))}function ts(e){Ct&&Ct.contains(e.target)||Rr()}function al(e,n){var t=Ct;if(Rr(),!(t&&t.dataset.triggerId===n)){var a=e.getBoundingClientRect();window.pageYOffset||document.documentElement.scrollTop,window.pageXOffset||document.documentElement.scrollLeft;var r=document.createElement("div");r.className="fixed z-[9999] w-52 rounded-xl border border-white/5 bg-gray-800 p-1 text-sm text-white shadow-lg transition duration-100 ease-out origin-top-right",r.style.top=a.bottom+5+"px";var i=208,s=a.right-i;s<10&&(s=a.left),r.style.left=s+"px",r.dataset.triggerId=n;var d=[{label:"Edit",icon:"edit",action:"edit",kbd:"âŒ˜E"},{label:"Duplicate",icon:"content_copy",action:"duplicate",kbd:"âŒ˜D"},{label:"Preview",icon:"visibility",action:"preview",kbd:"âŒ˜P"},{type:"divider"},{label:"Delete",icon:"delete",action:"delete",kbd:"âŒ˜Del",danger:!0}];d.forEach(function(o){if(o.type==="divider"){var l=document.createElement("div");l.className="my-1 h-px bg-white/5",r.appendChild(l);return}var c=document.createElement("button");c.className="group flex w-full items-center gap-2 rounded-lg px-3 py-1.5 hover:bg-white/10 text-left transition-colors "+(o.danger?"text-red-400 hover:text-red-300":"text-white");var u=o.danger?"text-red-400 group-hover:text-red-300":"text-white/60 group-hover:text-white";c.innerHTML=`
        <span class="material-symbols-outlined text-base ${u}">${o.icon}</span>
        <span>${o.label}</span>
        ${o.kbd?`<kbd class="ml-auto hidden font-sans text-xs text-white/50 group-hover:inline">${o.kbd}</kbd>`:""}
      `,c.onclick=function(m){m.stopPropagation(),rl(o.action,n),Rr()},r.appendChild(c)}),document.body.appendChild(r),Ct=r,requestAnimationFrame(function(){document.addEventListener("click",ts)})}}function rl(e,n){e==="edit"?Aa(n):e==="duplicate"?ns(n):e==="preview"?ws(n):e==="delete"&&as(n)}function il(e){e=e||Nr(),xa.innerHTML="",e.length!==0&&(e.forEach(function(n){try{if(!n)return;var t=document.createElement("tr");t.className="hover:bg-brand-light-gray/40 dark:hover:bg-brand-dark-gray/40 transition-colors";var a=tt(n.updatedAt||n.lastRunAt||n.createdAt),r=n.createdAt?tt(n.createdAt):"â€”",i=[];i.push('<td class="px-4 py-3 align-top">'),i.push('<div class="font-semibold text-brand-dark-gray dark:text-brand-white"><span class="poll-name-link cursor-pointer hover:text-primary dark:hover:text-primary transition-colors" data-poll-id="'+n.pollId+'">'+h(n.pollName||"Untitled Poll")+"</span></div>"),i.push('<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/50">Created '+r+"</div>"),i.push("</td>"),i.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+h(n.className||"â€”")+"</td>"),i.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+(n.questions?n.questions.length:0)+"</td>"),i.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+nl(n)+"</td>"),i.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+a+"</td>"),i.push('<td class="px-4 py-3 align-top text-right">'),i.push('<div class="flex justify-end items-center gap-2">'),i.push('<button class="poll-select-btn h-8 px-3 rounded-md bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-xs font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors" data-poll-id="'+n.pollId+'">Select</button>'),i.push('<div class="relative inline-block text-left">'),i.push('<button type="button" class="poll-options-btn inline-flex items-center gap-2 rounded-md bg-gray-800 px-3 py-1.5 text-xs font-semibold text-white shadow-inner shadow-white/10 hover:bg-gray-700 focus:outline-none transition-colors" data-poll-id="'+n.pollId+'" aria-expanded="false" aria-haspopup="true">'),i.push("Options"),i.push('<span class="material-symbols-outlined text-base text-white/60">keyboard_arrow_down</span>'),i.push("</button>"),i.push("</div>"),i.push("</div>"),i.push("</td>"),t.innerHTML=i.join(""),xa.appendChild(t)}catch(s){console.error("Error rendering poll table row:",s,n)}}),rs(xa))}async function ns(e){var n=ae.find(function(s){return s.pollId===e});if(n){var t=await br("Enter a name for the copied poll:",{defaultValue:n.pollName+" (Copy)",title:"Copy poll"});if(t!==null){if(t=t.trim(),t===""){await S("Poll name cannot be empty",{title:"Copy poll"});return}var a=deepClone(n);a.pollName=t,a.createdAt=Date.now(),a.updatedAt=a.createdAt;var r={pollName:a.pollName,className:a.className,questions:a.questions,sessionType:a.sessionType||"LIVE_POLL",timeLimitMinutes:a.timeLimitMinutes||null,accessCode:a.accessCode||"",availableFrom:a.availableFrom||"",dueBy:a.dueBy||"",secureSettings:a.secureSettings||{}},i=firebase.functions().httpsCallable("createPoll");i(r).then(function(s){if(s.data&&s.data.success)S("Poll copied successfully.",{title:"Success"});else throw new Error(s.data?s.data.message:"Failed to copy poll")}).catch(function(s){F(s)})}}}async function as(e){var n=await Qe("Delete this poll permanently? This will also remove all responses.",{title:"Delete poll",confirmText:"Delete",destructive:!0});if(n){var t=firebase.database(),a={};a["polls/"+e]=null,a["answers/"+e]=null,a["history/"+e]=null,a["sessions/"+e]=null,t.ref().update(a).then(function(){S("Poll deleted successfully.",{title:"Success"})}).catch(function(r){F(r)})}}function rs(e){e&&(e.querySelectorAll(".poll-select-btn").forEach(function(n){n.onclick=function(t){t.stopPropagation();var a=this.dataset.pollId;a&&(Z.value=a,St(),Fe())}}),e.querySelectorAll(".poll-options-btn").forEach(function(n){n.onclick=function(t){t.stopPropagation();var a=this.dataset.pollId;a&&al(this,a)}}),e.querySelectorAll(".poll-name-link").forEach(function(n){n.onclick=function(t){t.preventDefault(),t.stopPropagation();var a=this.dataset.pollId;a&&Aa(a)}}),e.querySelectorAll(".poll-copy-btn").forEach(function(n){n.onclick=function(t){t.stopPropagation(),ns(this.dataset.pollId)}}),e.querySelectorAll(".poll-edit-btn").forEach(function(n){n.onclick=function(t){t.stopPropagation(),Aa(this.dataset.pollId)}}),e.querySelectorAll(".poll-preview-btn").forEach(function(n){n.onclick=function(t){t.stopPropagation(),ws(this.dataset.pollId)}}),e.querySelectorAll(".poll-delete-btn").forEach(function(n){n.onclick=function(t){t.stopPropagation(),as(this.dataset.pollId)}}))}function sl(e){ae=e||[],Tr(Vt),tn()}function St(){console.log("[onPollSelectChange] Triggered."),U=document.getElementById("start-session-main-btn"),De=document.getElementById("send-link-btn"),K=document.getElementById("view-links-btn"),Z=document.getElementById("poll-select"),Z&&console.log("[onPollSelectChange] Current value:",Z.value);var e=Z.value,n=e?ae.find(function(r){return r.pollId===e}):null,t=n&&n.className?n.className:"",a=!!n;console.log("[onPollSelectChange] Poll:",e,"Found:",a,"Class:",t),ve(),ol(n),ll(n),De&&(a&&t?(De.disabled=!1,De.removeAttribute("aria-disabled"),De.dataset.className=t):(G(De,!1),De.disabled=!0,De.setAttribute("aria-disabled","true"),delete De.dataset.className)),K&&(a&&t?(K.disabled=!1,K.removeAttribute("aria-disabled"),K.dataset.className=t):(G(K,!1),K.disabled=!0,K.setAttribute("aria-disabled","true"),delete K.dataset.className)),U&&(G(U,!1),U.disabled=!a,U.disabled?U.setAttribute("aria-disabled","true"):U.removeAttribute("aria-disabled"))}function ol(e){if(U){var n=e?pt(e.sessionType):!1,t=n?"rocket_launch":"play_circle",a=n?"Launch Exam Room":"Start Session",r='<span class="material-symbols-outlined text-lg">'+t+"</span><span>"+a+"</span>";U.dataset.defaultHtml=r,U.dataset.sessionMode=n?"secure":"live",U.setAttribute("aria-label",a),U.classList.remove("bg-veritas-gold","hover:bg-veritas-gold/90","bg-rose-600","hover:bg-rose-700"),n?U.classList.add("bg-rose-600","hover:bg-rose-700"):U.classList.add("bg-veritas-gold","hover:bg-veritas-gold/90"),U.getAttribute("aria-busy")!=="true"&&(U.innerHTML=r)}}function ll(e){if(Gt){if(!e||!pt(e.sessionType)){Gt.classList.add("hidden"),Gt.setAttribute("aria-hidden","true");return}Gt.classList.remove("hidden"),Gt.setAttribute("aria-hidden","false");var n=[],t=Mr(e);t&&n.push('<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm opacity-80">timer</span><span>'+h(t)+"</span></span>");var a=Ba(e);a?n.push('<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm opacity-80">key</span><span>Code: <span class="font-semibold tracking-widest">'+h(a)+"</span></span></span>"):n.push('<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm opacity-80">key</span><span class="opacity-70">No access code</span></span>');var r=e.calculatorEnabled===!0||e.secureSettings&&e.secureSettings.calculatorEnabled===!0;n.push('<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm opacity-80">calculate</span><span>'+(r?"Calculator enabled":"Calculator off")+"</span></span>");var i=es(e);i&&n.push('<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm opacity-80">calendar_month</span><span>'+h(i)+"</span></span>"),Gt.innerHTML=n.join('<span class="opacity-50">|</span>')}}function Dr(e){var n=da;if(!n)try{n=da=firebase.functions()}catch(t){console.error("[Firebase] Functions SDK not initialized:",t)}return n?Promise.resolve({callable:n.httpsCallable(e)}):Promise.reject(new Error("Backend is unavailable. Please refresh and sign in again."))}function Xe(e){return Dr("manageRoster").then(function(n){return n.callable(e||{})})}function nn(){if(re.textContent="Loading roster...",!firebase.auth().currentUser||!window.AUTH_READY){re.textContent="",firebase.auth().currentUser?(console.log("[Firebase] Auth token not ready, retrying loadRosterData in 500ms..."),setTimeout(nn,500)):(S("You must be authenticated to load rosters.",{title:"Authentication required",destructive:!0}),window.LoginManager&&window.LoginManager.show());return}Xe({action:"GET_DATA"}).then(function(e){var n=e.data;if(re.textContent="",n&&n.success)console.log("[Firebase] Rosters loaded via Cloud Function"),Pr(n,M);else throw new Error("Could not load roster data")}).catch(function(e){re.textContent="",console.error("[Firebase] Roster fetch error:",e),F(e)})}function Pr(e,n){Y=e&&e.rosters?e.rosters:{},Tr(e&&e.classes||Vt),n&&(M=n),M&&!Y[M]&&(M=""),Fr(),M?On():(Wi.textContent="Select a class",Cr.classList.remove("hidden"),Sr.classList.add("hidden"),Mn.classList.add("hidden"),Rn.classList.add("hidden"),re.textContent="")}function Fr(){if(Lr.innerHTML="",be.length===0){Lr.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No classes yet. Click the + button to add one.</p>';return}be.forEach(function(e){var n=document.createElement("button");n.type="button";var t=e===M;n.className="w-full text-left px-3 py-2 rounded-lg transition-colors "+(t?"bg-primary text-brand-white shadow-sm":"bg-brand-light-gray/40 dark:bg-brand-dark-gray/30 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/60 dark:hover:bg-brand-dark-gray/50"),n.textContent=e,n.onclick=function(){dl(e)},Lr.appendChild(n)})}function dl(e){M=e,re.textContent="",Fr(),On()}function On(){if(M){var e=Y[M]||[];Y[M]=e,e.length===0&&e.push({name:"",email:""}),Wi.textContent=M,Cr.classList.add("hidden"),Sr.classList.remove("hidden"),Mn.classList.remove("hidden"),Rn.classList.remove("hidden"),Nn.innerHTML="",e.forEach(function(n,t){var a=document.createElement("tr");a.innerHTML='<td class="px-4 py-2 align-top"><input type="text" class="roster-name-input w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" data-index="'+t+'" placeholder="Student Name" value="'+h(n.name||"")+'" /></td><td class="px-4 py-2 align-top"><input type="email" class="roster-email-input w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" data-index="'+t+'" placeholder="email@example.com" value="'+h(n.email||"")+'" /></td><td class="px-4 py-2 align-top text-center"><button class="remove-roster-row-btn h-8 w-8 rounded-full bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors" data-index="'+t+'" title="Remove"><span class="material-symbols-outlined text-base">close</span></button></td>',Nn.appendChild(a)}),Nn.querySelectorAll(".roster-name-input").forEach(function(n){n.oninput=function(){var t=parseInt(this.dataset.index,10);Y[M][t].name=this.value,Ta()}}),Nn.querySelectorAll(".roster-email-input").forEach(function(n){n.oninput=function(){var t=parseInt(this.dataset.index,10);Y[M][t].email=this.value,Ta()}}),Nn.querySelectorAll(".remove-roster-row-btn").forEach(function(n){n.onclick=function(){var t=parseInt(this.dataset.index,10);ul(t)}})}}function Ta(){re.textContent="Unsaved changes"}async function cl(){if(!M){await S("Select a class first.",{title:"Roster"});return}Y[M]||(Y[M]=[]),Y[M].push({name:"",email:""}),Ta(),On()}function ul(e){if(M){var n=Y[M]||[];n.length>e&&(n.splice(e,1),Ta(),n.length===0&&n.push({name:"",email:""}),On())}}async function ml(){if(!M){await S("Select a class to save.",{title:"Roster"});return}var e=(Y[M]||[]).map(function(n){return{name:(n.name||"").trim(),email:(n.email||"").trim()}}).filter(function(n){return n.name!==""&&n.email!==""});Dn.disabled=!0,re.textContent="Saving roster...",Xe({action:"SAVE",className:M,students:e}).then(function(n){Dn.disabled=!1,re.textContent="Roster saved.",Y||(Y={}),Y[M]=e,Pr({rosters:Y,classes:be.includes(M)?be:be.concat([M])},M)}).catch(function(n){Dn.disabled=!1,F(n)})}async function fl(){if(!M){await S("Select a class first.",{title:"Roster"});return}document.getElementById("bulk-student-input").value="",document.getElementById("bulk-add-students-modal").style.display="flex"}function Or(){document.getElementById("bulk-add-students-modal").style.display="none"}async function gl(){if(!M){await S("Select a class first.",{title:"Roster"}),Or();return}var e=document.getElementById("bulk-student-input").value,n=e.split(`
`),t=[];if(n.forEach(function(r){if(r=r.trim(),r!==""){var i=r.split(",");if(i.length>=2){var s=i[0].trim(),d=i.slice(1).join(",").trim();s&&d&&t.push({name:s,email:d})}}}),t.length===0){await S("No valid student entries found. Use format: Name, Email",{title:"Bulk add students"});return}var a=document.getElementById("confirm-bulk-add-btn");a.disabled=!0,a.textContent="Adding...",Xe({action:"BULK_ADD",className:M,students:t}).then(function(){a.disabled=!1,a.textContent="Add Students",Or(),nn(),P("success","Students added","Successfully added "+t.length+" students.")}).catch(function(r){a.disabled=!1,a.textContent="Add Students",F(r)})}async function pl(){var e=await br("Class name",{title:"Add class",confirmText:"Create"});if(e&&(e=e.trim(),e!=="")){re.textContent="Creating class...";var n=firebase.database(),t=n.ref("rosters");t.once("value").then(function(a){var r=a.val()||{classes:[],rosters:{}};return r.classes||(r.classes=[]),r.rosters||(r.rosters={}),r.classes.includes(e)||r.classes.push(e),r.rosters[e]=r.rosters[e]||[],t.set(r)}).then(function(){re.textContent="Class created.",M=e,nn()}).catch(function(a){re.textContent="",F(a)})}}async function vl(){if(!M){await S("Select a class first.",{title:"Roster"});return}var e=await br("Rename class",{title:"Rename class",defaultValue:M,confirmText:"Rename"});e&&(e=e.trim(),e!==""&&e!==M&&(re.textContent="Renaming class...",Xe({action:"RENAME",className:M,newClassName:e}).then(function(n){if(n.data&&n.data.success)re.textContent="Class renamed.",n.data.pollsUpdated>0&&(re.textContent+=" ("+n.data.pollsUpdated+" poll"+(n.data.pollsUpdated===1?"":"s")+" updated)"),M=e,nn();else throw new Error(n.data?.error||"Failed to rename class")}).catch(function(n){re.textContent="",typeof Ut=="function"?Ut(n):F(n)})))}async function bl(){if(!M){await S("Select a class first.",{title:"Roster"});return}var e=await Qe('Delete class "'+M+'" and remove all students?',{title:"Delete class",confirmText:"Delete",destructive:!0});if(e){re.textContent="Deleting class...";var n=M;Xe({action:"DELETE",className:n}).then(function(t){if(t.data&&t.data.success)re.textContent="Class deleted.",M="",nn();else throw new Error(t.data?.error||"Failed to delete class")}).catch(function(t){re.textContent="",typeof Ut=="function"?Ut(t):F(t)})}}function is(e){if(wn.length>0&&!e){qa(),Ur();return}wa.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">Loading archived polls...</p>',ka.classList.remove("hidden"),Ia.classList.add("hidden"),console.warn("[Firebase] loadArchivedPolls: Legacy RTDB history disabled."),archivedStatus.textContent="Archived polls are temporarily unavailable."}function qa(){wa.innerHTML="";var e=kt==="all"?wn:wn.filter(function(n){return n.className===kt});if(e.length===0){wa.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No archived polls for this filter.</p>',ka.classList.remove("hidden"),Ia.classList.add("hidden");return}e.forEach(function(n){var t=document.createElement("button");t.type="button";var a=n.pollId===kn;t.className="w-full text-left px-3 py-2 rounded-lg transition-colors "+(a?"bg-primary text-brand-white shadow-sm":"bg-brand-light-gray/40 dark:bg-brand-dark-gray/30 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/60 dark:hover:bg-brand-dark-gray/50");var r=(n.className||"Unassigned")+" â€¢ "+tt(n.lastRunAt||n.updatedAt||n.createdAt);t.innerHTML='<div class="font-semibold">'+h(n.pollName||"Untitled Poll")+'</div><div class="text-xs opacity-80">'+h(r)+"</div>",t.onclick=function(){kn=n.pollId,qa(),Ur()},wa.appendChild(t)})}function Ur(){var e=wn.find(function(n){return n.pollId===kn});if(!e){ka.classList.remove("hidden"),Ia.classList.add("hidden");return}ka.classList.add("hidden"),Ia.classList.remove("hidden"),jo.textContent=e.pollName||"Untitled Poll",Qo.textContent=(e.className||"Unassigned")+" â€¢ Last run "+tt(e.lastRunAt||e.updatedAt||e.createdAt),Wo.textContent=e.questionCount||0,Ko.textContent=(e.totalResponses||0)+" of "+(e.totalStudents||0),Qi.innerHTML="",e.questions.forEach(function(n,t){var a=document.createElement("div");a.className="border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-4 bg-brand-white dark:bg-brand-dark-gray/40";var r=n.summary||{correct:0,incorrect:0,noResponse:0,violations:0},i=Array.isArray(n.responses)?n.responses:[],s=Array.isArray(n.nonResponders)?n.nonResponders:[];r.correct=r.correct||0,r.incorrect=r.incorrect||0,r.noResponse=r.noResponse||0,r.violations=r.violations||0;var d="";i.length===0?d='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No responses recorded.</p>':(d='<table class="min-w-full text-sm divide-y divide-brand-light-gray dark:divide-brand-dark-gray/40"><thead class="text-xs uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/50"><tr><th class="py-2 text-left">Student</th><th class="py-2 text-left">Answer</th><th class="py-2 text-left">Status</th></tr></thead><tbody class="divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/40">',i.forEach(function(m){var g=m.violation?"Violation":m.isCorrect?"Correct":"Incorrect",p=m.violation?"text-orange-600 dark:text-orange-300":m.isCorrect?"text-green-600 dark:text-green-300":"text-red-600 dark:text-red-300";d+='<tr><td class="py-2 pr-3">'+h(m.name||m.email)+'</td><td class="py-2 pr-3">'+h(m.answer||"â€”")+'</td><td class="py-2 pr-3 '+p+'">'+g+"</td></tr>"}),d+="</tbody></table>");var o="";s.length>0&&(o='<div class="mt-3"><h4 class="text-xs font-semibold uppercase text-brand-dark-gray/60 dark:text-brand-white/60">No Response</h4><div class="flex flex-wrap gap-2 mt-1">',s.forEach(function(m){var g=m.violation?"bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-200":"bg-brand-light-gray text-brand-dark-gray dark:bg-brand-dark-gray/50 dark:text-brand-white/80",p=m.name?Ue(m):m.email;o+='<span class="px-2 py-1 rounded-full text-xs '+g+'">'+h(p)+"</span>"}),o+="</div></div>");var l=n.questionImageURL?'<div class="mt-3"><img src="'+h(n.questionImageURL)+'" class="max-h-48 rounded-lg object-contain" alt="Question image" /></div>':"",c='<div><h3 class="font-serif text-lg text-brand-dark-gray dark:text-brand-white">Question '+(t+1)+'</h3><p class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 mt-1">'+h(n.questionText||"")+"</p></div>",u='<div class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 text-right"><p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Correct:</span> '+r.correct+'</p><p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Incorrect:</span> '+r.incorrect+'</p><p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">No Response:</span> '+r.noResponse+'</p><p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Violations:</span> '+r.violations+"</p></div>";a.innerHTML='<div class="flex flex-wrap items-start justify-between gap-3">'+c+u+"</div>"+l+'<div class="mt-4">'+d+"</div>"+o,Qi.appendChild(a)})}function yl(e){var n=document.getElementById("post-poll-analytics-modal"),t=document.getElementById("analytics-loading"),a=document.getElementById("analytics-report");n.style.display="flex",t.classList.remove("hidden"),a.classList.add("hidden"),firebase.functions().httpsCallable("getAnalytics")({pollId:e}).then(function(i){var s=i.data;s.success?hl(s):t.innerHTML='<div class="text-center py-12"><p class="text-red-600">Error: '+h(s.error||"Failed to load analytics")+"</p></div>"}).catch(function(i){t.innerHTML='<div class="text-center py-12"><p class="text-red-600">Error: '+h(i.message||"Unknown error")+"</p></div>"})}function hl(e){var n=document.getElementById("analytics-loading"),t=document.getElementById("analytics-report");document.getElementById("analytics-poll-name").textContent=e.pollName||"Poll Analysis",document.getElementById("analytics-poll-meta").textContent=e.className+" â€¢ "+e.questionCount+" Questions",e.teacherActionItems&&xl(e.teacherActionItems),El(e.classOverview,e.distribution),e.metacognition&&e.metacognition.enabled?(wl(e.metacognition),document.getElementById("metacognition-section").classList.remove("hidden")):document.getElementById("metacognition-section").classList.add("hidden"),kl(e.itemAnalysis),n.classList.add("hidden"),t.classList.remove("hidden")}function xl(e){var n=document.getElementById("analytics-actions-container");if(n){if(!e||e.length===0){n.innerHTML="";return}var t='<h4 class="text-lg font-bold text-brand-dark-gray dark:text-white mb-3 flex items-center gap-2"><span class="material-symbols-outlined text-amber-500">lightbulb</span> Insights & Recommendations</h4><div class="grid grid-cols-1 gap-3">';e.forEach(function(a){var r=a.priority==="urgent"?"border-red-200 bg-red-50 text-red-900":"border-amber-200 bg-amber-50 text-amber-900",i=a.priority==="urgent"?"warning":"info";t+='<div class="flex items-start gap-3 p-4 rounded-lg border '+r+'"><span class="material-symbols-outlined mt-0.5">'+i+'</span><div><p class="font-semibold">'+h(a.message)+"</p>",a.items&&a.items.length>0&&(t+='<ul class="mt-2 text-sm list-disc list-inside opacity-90">',a.items.forEach(function(s){t+="<li>Q"+(s.index+1)+": "+h(s.text)+"</li>"}),t+="</ul>"),t+="</div></div>"}),t+="</div>",n.innerHTML=t}}function El(e,n){var t=document.getElementById("class-overview-content"),a=e.interpretation||{},r='<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">';if(r+='<div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700/30 rounded-lg p-4">',r+='<div class="text-sm text-blue-700 dark:text-blue-300 font-semibold mb-1">Mean Score</div>',r+='<div class="text-3xl font-bold text-blue-900 dark:text-blue-100">'+e.mean+"</div>",a.meanScore&&(r+='<div class="mt-2 text-xs font-medium text-blue-800 dark:text-blue-200">'+h(a.meanScore.message)+"</div>"),r+="</div>",r+='<div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700/30 rounded-lg p-4">',r+='<div class="text-sm text-green-700 dark:text-green-300 font-semibold mb-1">Median Score</div>',r+='<div class="text-3xl font-bold text-green-900 dark:text-green-100">'+e.median+"</div>",r+="</div>",r+='<div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-700/30 rounded-lg p-4">',r+='<div class="text-sm text-purple-700 dark:text-purple-300 font-semibold mb-1">Std. Deviation</div>',r+='<div class="text-3xl font-bold text-purple-900 dark:text-purple-100">'+e.stdDev+"</div>",a.stdDev&&(r+='<div class="mt-2 text-xs font-medium text-purple-800 dark:text-purple-200">'+h(a.stdDev.message)+"</div>"),r+="</div>",r+='<div class="bg-gray-50 dark:bg-gray-900/20 border border-gray-200 dark:border-gray-700/30 rounded-lg p-4">',r+='<div class="text-sm text-gray-700 dark:text-gray-300 font-semibold mb-1">Participants</div>',r+='<div class="text-3xl font-bold text-gray-900 dark:text-gray-100">'+e.participantCount+"</div>",a.participation&&(r+='<div class="mt-2 text-xs font-medium text-gray-800 dark:text-gray-200">'+h(a.participation.message)+"</div>"),r+="</div>",r+="</div>",n&&n.histogram&&n.histogram.length>0){r+='<div class="bg-white dark:bg-brand-dark-gray/40 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-4">',r+='<h4 class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white mb-3">Score Distribution</h4>',r+='<div class="flex items-end gap-2 h-48">';var i=Math.max.apply(null,n.histogram.map(function(s){return s.count}));n.histogram.forEach(function(s){var d=i>0?s.count/i*100:0;r+='<div class="flex-1 flex flex-col items-center gap-1">',r+='<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">'+s.count+"</div>",r+='<div class="w-full bg-primary rounded-t" style="height: '+d+'%;"></div>',r+='<div class="text-xs font-semibold text-brand-dark-gray dark:text-brand-white">'+s.score+"</div>",r+="</div>"}),r+="</div>",r+="</div>"}t.innerHTML=r}function wl(e){var n=document.getElementById("metacognition-content");if(!e.overall){n.innerHTML='<p class="text-brand-dark-gray/60 dark:text-brand-white/60">No metacognition data available yet.</p>';return}var t='<div class="bg-white dark:bg-brand-dark-gray/40 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-6 mb-4">';t+='<h4 class="text-lg font-semibold text-brand-dark-gray dark:text-brand-white mb-4">Confidence vs. Correctness Matrix</h4>',t+='<div class="grid grid-cols-1 md:grid-cols-2 gap-4">',t+='<div class="bg-green-50 dark:bg-green-900/20 border-2 border-green-500 rounded-lg p-4">',t+='<div class="flex items-center gap-2 mb-2">',t+='<span class="text-2xl">ðŸ’¯</span>',t+='<div class="text-sm font-semibold text-green-700 dark:text-green-300">Conscious Competence</div>',t+="</div>",t+='<div class="text-3xl font-bold text-green-900 dark:text-green-100">'+e.overall.confidentCorrect+"%</div>",t+='<div class="text-xs text-green-700 dark:text-green-300 mt-1">Confident & Correct (Mastery!)</div>',t+="</div>",t+='<div class="bg-red-50 dark:bg-red-900/20 border-2 border-red-500 rounded-lg p-4">',t+='<div class="flex items-center gap-2 mb-2">',t+='<span class="text-2xl">âš ï¸</span>',t+='<div class="text-sm font-semibold text-red-700 dark:text-red-300">Confidently Incorrect</div>',t+="</div>",t+='<div class="text-3xl font-bold text-red-900 dark:text-red-100">'+e.overall.confidentIncorrect+"%</div>",t+='<div class="text-xs text-red-700 dark:text-red-300 mt-1">RED ALERT: Deep misconception!</div>',t+="</div>",t+='<div class="bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-500 rounded-lg p-4">',t+='<div class="flex items-center gap-2 mb-2">',t+='<span class="text-2xl">ðŸ¤”</span>',t+='<div class="text-sm font-semibold text-yellow-700 dark:text-yellow-300">Imposter Syndrome</div>',t+="</div>",t+='<div class="text-3xl font-bold text-yellow-900 dark:text-yellow-100">'+e.overall.uncertainCorrect+"%</div>",t+='<div class="text-xs text-yellow-700 dark:text-yellow-300 mt-1">Uncertain but Correct (Lucky?)</div>',t+="</div>",t+='<div class="bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-500 rounded-lg p-4">',t+='<div class="flex items-center gap-2 mb-2">',t+='<span class="text-2xl">ðŸ¤·</span>',t+='<div class="text-sm font-semibold text-blue-700 dark:text-blue-300">Conscious Incompetence</div>',t+="</div>",t+='<div class="text-3xl font-bold text-blue-900 dark:text-blue-100">'+e.overall.uncertainIncorrect+"%</div>",t+=`<div class="text-xs text-blue-700 dark:text-blue-300 mt-1">Know they don't know (Good!)</div>`,t+="</div>",t+="</div>",t+="</div>",n.innerHTML=t}function kl(e){var n=document.getElementById("item-analysis-content"),t="";e.forEach(function(a,r){var i=a.difficultyPct>90?"green":a.difficultyPct<30?"red":"blue",s=a.discrimination>.3?"green":a.discrimination<0?"red":"yellow",d=a.interpretation||{};if(t+='<div class="bg-white dark:bg-brand-dark-gray/40 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-5 mb-4">',t+='<div class="flex items-start justify-between gap-4 mb-4">',t+='<div class="flex-1">',t+='<div class="flex items-center gap-2">',t+='<h4 class="font-semibold text-brand-dark-gray dark:text-brand-white">Question '+(r+1)+"</h4>",d.overall){var o=d.overall.quality==="excellent"?"bg-green-100 text-green-800":d.overall.quality==="flawed"?"bg-red-100 text-red-800":d.overall.quality==="needs-adjustment"?"bg-orange-100 text-orange-800":"bg-gray-100 text-gray-800";t+='<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase '+o+'">'+h(d.overall.quality)+"</span>"}t+="</div>",t+='<p class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 mt-1">'+h(a.questionText)+"</p>",t+="</div>",t+='<div class="flex gap-3">',t+='<div class="text-center">',t+='<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mb-1">Difficulty</div>',t+='<div class="text-2xl font-bold text-'+i+"-600 dark:text-"+i+'-400">'+a.difficultyPct+"%</div>",d.difficulty&&(t+='<div class="text-[10px] text-gray-500">'+h(d.difficulty.level)+"</div>"),t+="</div>",t+='<div class="text-center">',t+='<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mb-1">Discrimination</div>',t+='<div class="text-2xl font-bold text-'+s+"-600 dark:text-"+s+'-400">'+a.discrimination+"</div>",d.discrimination&&(t+='<div class="text-[10px] text-gray-500">'+h(d.discrimination.level)+"</div>"),t+="</div>",t+="</div>",t+="</div>",a.flags&&a.flags.length>0&&(t+='<div class="flex flex-wrap gap-2 mb-3">',a.flags.forEach(function(l){var c=l==="negative-discrimination"?"bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300":l==="too-hard"?"bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-300":"bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-300";t+='<span class="px-2 py-1 rounded-full text-xs font-semibold '+c+'">'+l.replace(/-/g," ")+"</span>"}),t+="</div>"),d.actionable&&d.actionable.length>0&&(t+='<div class="mt-3 p-3 bg-amber-50 dark:bg-amber-900/10 border border-amber-100 dark:border-amber-800/30 rounded text-sm text-amber-800 dark:text-amber-200">',t+='<p class="font-semibold text-xs uppercase tracking-wide mb-1">Recommendation:</p>',t+='<ul class="list-disc list-inside space-y-1">',d.actionable.forEach(function(l){t+="<li>"+h(l)+"</li>"}),t+="</ul></div>"),a.distractorAnalysis&&a.distractorAnalysis.length>0&&(t+='<div class="bg-gray-50 dark:bg-brand-dark-gray/20 rounded-lg p-3">',t+='<h5 class="text-xs font-semibold uppercase text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">Distractor Analysis</h5>',t+='<div class="space-y-2">',a.distractorAnalysis.forEach(function(l){var c=l.quality==="excellent"||l.quality==="good"?"green":l.quality==="problematic"?"red":"gray";t+='<div class="flex items-center justify-between text-sm">',t+='<div class="flex items-center gap-2">',t+='<span class="font-semibold text-brand-dark-gray dark:text-brand-white">'+l.optionLetter+"</span>",t+='<span class="text-brand-dark-gray/70 dark:text-brand-white/70">'+h(l.option.substring(0,50))+(l.option.length>50?"...":"")+"</span>",l.isCorrect&&(t+='<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300">Correct</span>'),t+="</div>",t+='<div class="flex items-center gap-3">',t+='<span class="text-brand-dark-gray/60 dark:text-brand-white/60">'+l.totalPct+"%</span>",t+='<span class="text-xs text-'+c+"-600 dark:text-"+c+'-400">'+l.quality+"</span>",t+="</div>",t+="</div>"}),t+="</div>",t+="</div>"),t+="</div>"}),n.innerHTML=t}var Q=null,Na="overview",he={className:"all"},Je={field:"qNum",direction:"asc"};function Il(){Pn(),va.style.display="flex",ba.style.display="none",Pe("analytics");var e=document.getElementById("analytics-class-filter");e.innerHTML='<option value="all">All Classes</option>';var n=Array.from(new Set(ae.map(function(t){return t.className})));n.forEach(function(t){var a=document.createElement("option");a.value=t,a.textContent=t,e.appendChild(a)}),Q?Un():an(),jt&&clearInterval(jt),jt=setInterval(function(){Q=null,an(he)},3e4)}function an(e){he=e||he,document.getElementById("analytics-overview-loading").classList.remove("hidden"),document.getElementById("analytics-overview-content").classList.add("hidden"),document.getElementById("analytics-items-loading").classList.remove("hidden"),document.getElementById("analytics-items-content").classList.add("hidden"),document.getElementById("analytics-students-loading").classList.remove("hidden"),document.getElementById("analytics-students-content").classList.add("hidden"),firebase.functions().httpsCallable("getAnalytics")(he).then(function(t){Q=t.data,document.getElementById("analytics-overview-loading").classList.add("hidden"),document.getElementById("analytics-items-loading").classList.add("hidden"),document.getElementById("analytics-students-loading").classList.add("hidden"),Un()}).catch(function(t){console.error("Analytics loading error:",t),document.getElementById("analytics-overview-loading").innerHTML='<p class="text-red-600">Error loading analytics: '+h(t.message||"Unknown error")+"</p>",document.getElementById("analytics-items-loading").innerHTML='<p class="text-red-600">Error loading analytics: '+h(t.message||"Unknown error")+"</p>",document.getElementById("analytics-students-loading").innerHTML='<p class="text-red-600">Error loading analytics: '+h(t.message||"Unknown error")+"</p>"})}function Un(){Na==="overview"?Ll():Na==="items"?ss():Na==="students"&&Nl()}function Ll(){if(document.getElementById("analytics-overview-loading").classList.add("hidden"),document.getElementById("analytics-overview-content").classList.remove("hidden"),!!Q){var e=document.getElementById("analytics-kpi-container");e.innerHTML="",(Q.kpis||[]).forEach(function(o){var l=document.createElement("div");l.className="bg-brand-white dark:bg-brand-dark-gray/40 rounded-xl p-5 border border-brand-light-gray dark:border-brand-dark-gray/40 shadow-sm hover:shadow-md transition-shadow cursor-pointer",l.title=o.tooltip;var c="";if(o.delta!==void 0&&o.delta!==null){var u=o.delta>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400",m=o.delta>=0?"â–²":"â–¼";c='<div class="text-xs font-semibold '+u+' mt-1">'+m+" "+Math.abs(o.delta)+"</div>"}l.innerHTML='<div class="text-xs font-semibold uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">'+h(o.label)+'</div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">'+h(o.value)+"</div>"+c,e.appendChild(l)});var n=document.getElementById("analytics-topic-heat");if(n){if(Q.topics&&Q.topics.length>0){var t='<div class="space-y-2">';Q.topics.forEach(function(o){var l=o.masteryPct>=70?"bg-green-500":o.masteryPct>=50?"bg-yellow-500":"bg-red-500";t+='<div class="flex items-center gap-3">',t+='<div class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white min-w-[120px]">'+h(o.topic)+"</div>",t+='<div class="flex-1 bg-brand-light-gray dark:bg-brand-dark-gray/30 rounded-full h-6 overflow-hidden">',t+='<div class="'+l+' h-full flex items-center justify-end px-2 text-xs text-white font-semibold" style="width: '+o.masteryPct+'%">',o.masteryPct>15&&(t+=o.masteryPct+"%"),t+="</div></div>",t+='<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 min-w-[60px] text-right">'+o.questionCount+" items</div>",t+="</div>"}),t+="</div>",n.innerHTML=t}else n.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No topic data available. Add topic tags to your questions.</p>';var a=document.getElementById("analytics-item-scatter");if(a)if(!Q.items||Q.items.length===0)a.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No item data available</p>';else if(mr&&window.google&&google.visualization&&typeof google.visualization.ScatterChart=="function"){var r=[["Difficulty (% Correct)","Discrimination","Question"]];Q.items.forEach(function(o){r.push([o.correctPct,o.rbis,"Q"+o.qNum])});var i=google.visualization.arrayToDataTable(r),s={title:"Item Difficulty vs Discrimination",hAxis:{title:"Difficulty (% Correct)",minValue:0,maxValue:100},vAxis:{title:"Discrimination (r_bis)",minValue:-.5,maxValue:1},legend:"none",pointSize:5,backgroundColor:"transparent",chartArea:{width:"85%",height:"75%"}},d=new google.visualization.ScatterChart(a);d.draw(i,s)}else a.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">Preparing analytics visualsâ€¦</p>'}}}function ss(){if(document.getElementById("analytics-items-loading").classList.add("hidden"),document.getElementById("analytics-items-content").classList.remove("hidden"),!(!Q||!Q.items)){var e=Q.items.slice();e.sort(function(t,a){var r=t[Je.field],i=a[Je.field];if(typeof r=="number"&&typeof i=="number")return Je.direction==="asc"?r-i:i-r;var s=String(r||""),d=String(i||"");return Je.direction==="asc"?s.localeCompare(d):d.localeCompare(s)});var n=document.getElementById("analytics-items-tbody");n.innerHTML="",e.forEach(function(t){var a=document.createElement("tr");a.className="hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30 cursor-pointer";var r=document.createElement("td");r.className="py-3 px-4 font-semibold",r.textContent=t.qNum,a.appendChild(r);var i=document.createElement("td");i.className="py-3 px-4 text-xs",i.textContent=t.topic||"Untagged",a.appendChild(i);var s=document.createElement("td");s.className="py-3 px-4 font-semibold";var d=t.correctPct>=70?"text-green-600 dark:text-green-400":t.correctPct>=50?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400";s.innerHTML='<span class="'+d+'">'+t.correctPct+"%</span>",a.appendChild(s);var o=document.createElement("td");o.className="py-3 px-4 font-semibold";var l=t.rbis>=.3?"text-green-600 dark:text-green-400":t.rbis>=.15?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400";o.innerHTML='<span class="'+l+'">'+t.rbis.toFixed(2)+"</span>",a.appendChild(o);var c=document.createElement("td");c.className="py-3 px-4",c.innerHTML=Cl(t),a.appendChild(c);var u=document.createElement("td");u.className="py-3 px-4",u.textContent=t.medianTimeSec+"s",a.appendChild(u);var m=document.createElement("td");if(m.className="py-3 px-4",t.flags&&t.flags.length>0){var g="";t.flags.forEach(function(p){var v="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300";p==="low-disc"&&(v="bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300"),g+='<span class="inline-block px-2 py-0.5 rounded text-xs font-semibold '+v+' mr-1">'+h(p)+"</span>"}),m.innerHTML=g}a.appendChild(m),n.appendChild(a)})}}function Cl(e){var n=e.total||1,t=["A","B","C","D"],a=["#3b82f6","#10b981","#f59e0b","#ef4444"],r='<div class="flex items-center gap-1 text-xs">';return t.forEach(function(i,s){var d=e.choiceCounts[i]||0,o=(d/n*100).toFixed(0),l=s===e.correctIndex,c=l?"border-2 border-brand-dark-gray dark:border-brand-white":"";d>0&&(r+='<div class="flex items-center gap-0.5">',r+='<span class="font-semibold">'+i+"</span>",r+='<div class="h-4 rounded '+c+'" style="width: '+o*.8+"px; background-color: "+a[s]+'; opacity: 0.7;"></div>',r+='<span class="text-brand-dark-gray/60 dark:text-brand-white/60">'+o+"%</span>",r+="</div>")}),r+="</div>",r}var At=null,Ma=[],_r="name",_n=!0;function os(e){var n=document.getElementById("student-insights-content");n&&(n.innerHTML='<div class="flex items-center justify-center p-12 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700/30 rounded-lg"><div class="text-center"><span class="material-symbols-outlined text-5xl text-red-600 dark:text-red-400 mb-4">error</span><p class="text-red-800 dark:text-red-200 text-lg font-semibold mb-2">Failed to Load Student Insights</p><p class="text-red-600 dark:text-red-300 text-sm">'+h(e)+'</p><button onclick="loadStudentInsights()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Retry</button></div></div>'),P("error","Error",e,5e3)}function Sl(){var e=he&&he.className?he.className:"all";he&&he.dateFrom&&he.dateFrom,he&&he.dateTo&&he.dateTo,firebase.functions().httpsCallable("getAnalytics")({className:e}).then(function(t){var a=t.data;if(a&&a.success)At=a,Ma=a.students||[],Al();else{var r=a&&a.error?a.error:"Failed to load insights";os(r)}}).catch(function(t){os(t.message||"Unknown error")})}function Al(){if(At){var e=At.classStats;document.getElementById("struggling-count").textContent=e.strugglingCount||0,document.getElementById("non-responder-count").textContent=e.nonResponderCount||0,document.getElementById("rule-violator-count").textContent=e.ruleViolatorCount||0,document.getElementById("high-performer-count").textContent=e.highPerformerCount||0,Ra()}}function Ra(){var e=document.getElementById("student-insights-table-body");if(e){var n=Ma;n.sort(function(a,r){var i,s;switch(_r){case"name":i=a.name||a.email,s=r.name||r.email;break;case"accuracy":i=a.accuracy,s=r.accuracy;break;case"participation":i=a.participationRate,s=r.participationRate;break;case"violations":i=a.violations.length,s=r.violations.length;break;default:return 0}return i<s?_n?-1:1:i>s?_n?1:-1:0});var t="";n.forEach(function(a){var r=a.accuracy>=85?"text-green-600 dark:text-green-400":a.accuracy>=70?"text-blue-600 dark:text-blue-400":a.accuracy>=50?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400",i=a.participationRate>=90?"text-green-600 dark:text-green-400":a.participationRate>=75?"text-blue-600 dark:text-blue-400":a.participationRate>=50?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400",s=a.violations.length===0?"text-green-600 dark:text-green-400":a.violations.length===1?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400",d="";a.flags.forEach(function(o){var l="",c="";switch(o){case"struggling":l="bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300",c="Struggling";break;case"non-responder":l="bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300",c="Non-Responder";break;case"rule-violator":l="bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300",c="Rule Violator";break;case"high-performer":l="bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300",c="High Performer";break;case"consistent":l="bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",c="Consistent";break}d+='<span class="'+l+' px-2 py-0.5 rounded text-xs font-semibold mr-1">'+c+"</span>"}),t+='<tr class="border-t border-brand-light-gray dark:border-brand-dark-gray/40 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30 transition-colors">',t+='<td class="px-4 py-3 text-sm font-medium text-brand-dark-gray dark:text-brand-white">'+h(Ue(a))+"</td>",t+='<td class="px-4 py-3 text-center"><span class="text-sm font-semibold '+r+'">'+Math.round(a.accuracy)+'%</span><br><span class="text-xs text-brand-dark-gray/50 dark:text-brand-white/50">'+a.correctAnswers+"/"+(a.correctAnswers+a.incorrectAnswers)+"</span></td>",t+='<td class="px-4 py-3 text-center"><span class="text-sm font-semibold '+i+'">'+Math.round(a.participationRate)+'%</span><br><span class="text-xs text-brand-dark-gray/50 dark:text-brand-white/50">'+a.questionsAnswered+"/"+a.totalQuestions+"</span></td>",t+='<td class="px-4 py-3 text-center text-sm font-semibold '+s+'">'+a.violations.length+"</td>",t+='<td class="px-4 py-3 text-sm">'+d+"</td>",t+="</tr>"}),e.innerHTML=t||'<tr><td colspan="5" class="px-4 py-8 text-center text-brand-dark-gray/60 dark:text-brand-white/60">No students found</td></tr>'}}function Bl(e){if(At){Ma=At.students.filter(function(a){return a.flags.includes(e)});var n=document.getElementById("student-insights-filter-badge"),t=document.getElementById("clear-student-filter-btn");n.textContent=e.replace("-"," ").toUpperCase(),n.classList.remove("hidden"),t.classList.remove("hidden"),Ra()}}function Tl(){At&&(Ma=At.students||[],document.getElementById("student-insights-filter-badge").classList.add("hidden"),document.getElementById("clear-student-filter-btn").classList.add("hidden"),Ra())}function ql(e){_r===e?_n=!_n:(_r=e,_n=!0),Ra()}function Nl(){if(document.getElementById("analytics-students-loading").classList.add("hidden"),document.getElementById("analytics-students-content").classList.remove("hidden"),Sl(),!(!Q||!Q.students)){var e=Object.values(Q.students);if(ur){var n=e.map(function(t){return{label:Ue(t),subLabel:t.email,student:t}});ur.updateData(n)}}}function Ml(e){document.getElementById("analytics-student-empty").classList.add("hidden"),document.getElementById("analytics-student-detail").classList.remove("hidden");var n=document.getElementById("analytics-student-summary");n.innerHTML='<div class="flex flex-wrap items-center justify-between gap-4"><div><h3 class="text-xl font-bold text-brand-dark-gray dark:text-brand-white">'+h(Ue(e))+'</h3><p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">'+h(e.email)+'</p></div><div class="grid grid-cols-3 gap-4 text-center"><div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">'+e.successLast10.toFixed(1)+'%</div><div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Success Rate</div></div><div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">'+e.participationPct.toFixed(0)+'%</div><div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Participation</div></div><div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">'+e.integrityCount+'</div><div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Integrity Events</div></div></div></div>';var t=document.getElementById("analytics-student-sparkline"),a=e.sessions||[];if(a.length>0){var r='<div class="flex gap-2">';a.slice(0,10).reverse().forEach(function(o){var l=o.scorePct>=70?"bg-green-500":o.scorePct>=50?"bg-yellow-500":"bg-red-500";r+='<div class="flex-1 flex flex-col items-center gap-1" title="'+h(o.sessionName)+": "+o.scorePct+'%">',r+='<div class="w-full rounded '+l+'" style="height: '+o.scorePct*.8+'px; min-height: 20px;"></div>',r+='<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">'+o.scorePct.toFixed(0)+"%</div>",r+="</div>"}),r+="</div>",t.innerHTML=r}else t.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No session data</p>';var i=document.getElementById("analytics-student-topics"),s=Object.keys(e.topicPerformance||{});if(s.length>0){var d='<div class="space-y-2">';s.forEach(function(o){var l=e.topicPerformance[o],c=l.total>0?(l.correct/l.total*100).toFixed(0):0,u=c>=70?"bg-green-500":c>=50?"bg-yellow-500":"bg-red-500";d+='<div class="flex items-center gap-2">',d+='<div class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white min-w-[100px]">'+h(o)+"</div>",d+='<div class="flex-1 bg-brand-light-gray dark:bg-brand-dark-gray/30 rounded-full h-5 overflow-hidden">',d+='<div class="'+u+' h-full flex items-center justify-end px-2 text-xs text-white font-semibold" style="width: '+c+'%">',c>15&&(d+=c+"%"),d+="</div></div>",d+='<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">'+l.correct+"/"+l.total+"</div>",d+="</div>"}),d+="</div>",i.innerHTML=d}else i.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No topic data</p>'}document.getElementById("analytics-apply-filters-btn").onclick=function(){var e=document.getElementById("analytics-class-filter").value,n=document.getElementById("analytics-date-from").value,t=document.getElementById("analytics-date-to").value;an({className:e,dateFrom:n,dateTo:t})},document.getElementById("analytics-clear-filters-btn").onclick=function(){document.getElementById("analytics-class-filter").value="all",document.getElementById("analytics-date-from").value="",document.getElementById("analytics-date-to").value="",an({className:"all"})},document.getElementById("analytics-refresh-btn").onclick=function(){an(he)},document.querySelectorAll(".analytics-date-preset").forEach(function(e){e.onclick=function(){var n=e.getAttribute("data-days"),t=e.getAttribute("data-preset"),a=new Date,r="",i=a.toISOString().split("T")[0];if(n){var s=new Date;s.setDate(s.getDate()-parseInt(n)),r=s.toISOString().split("T")[0]}else if(t==="thisMonth"){var d=new Date(a.getFullYear(),a.getMonth(),1);r=d.toISOString().split("T")[0]}else if(t==="lastMonth"){var o=new Date(a.getFullYear(),a.getMonth()-1,1),l=new Date(a.getFullYear(),a.getMonth(),0);r=o.toISOString().split("T")[0],i=l.toISOString().split("T")[0]}else t==="all"&&(r="",i="");document.getElementById("analytics-date-from").value=r,document.getElementById("analytics-date-to").value=i;var c=document.getElementById("analytics-class-filter").value;an({className:c,dateFrom:r,dateTo:i})}}),document.getElementById("analytics-export-btn").onclick=function(){if(!Q){alert("No data to export. Please load analytics first.");return}var e={exportDate:new Date().toISOString(),kpis:Q.kpis||[],sessions:Q.sessions||[],items:Q.items||[],students:Object.values(Q.students||{}),topics:Q.topics||[]},n=`Session Name,Class,Date,Questions,Participants,Total Students,Mastery %,Participation %,Median Time (s),Integrity Rate
`;(e.sessions||[]).forEach(function(i){n+='"'+(i.sessionName||"").replace(/"/g,'""')+'",',n+='"'+(i.className||"").replace(/"/g,'""')+'",',n+='"'+(i.date||"")+'",',n+=i.questionCount+",",n+=i.participants+",",n+=i.totalStudents+",",n+=i.masteryPct+",",n+=i.participationPct+",",n+=i.medianTimeSec+",",n+=i.integrityRate+`
`});var t=new Blob([n],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a"),r=URL.createObjectURL(t);a.setAttribute("href",r),a.setAttribute("download","veritas-analytics-"+new Date().toISOString().split("T")[0]+".csv"),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)},document.querySelectorAll(".analytics-tab").forEach(function(e){e.onclick=function(){var n=e.id.replace("analytics-tab-","");Na=n,document.querySelectorAll(".analytics-tab").forEach(function(t){t.classList.remove("bg-primary","text-brand-white"),t.classList.add("text-brand-dark-gray/70","dark:text-brand-white/70","hover:bg-brand-light-gray/20","dark:hover:bg-brand-dark-gray/30")}),e.classList.add("bg-primary","text-brand-white"),e.classList.remove("text-brand-dark-gray/70","dark:text-brand-white/70","hover:bg-brand-light-gray/20","dark:hover:bg-brand-dark-gray/30"),document.querySelectorAll(".analytics-tab-content").forEach(function(t){t.classList.add("hidden")}),document.getElementById("analytics-content-"+n).classList.remove("hidden"),Un()}}),document.querySelectorAll("#analytics-items-table th[data-sort]").forEach(function(e){e.onclick=function(){var n=e.getAttribute("data-sort");Je.field===n?Je.direction=Je.direction==="asc"?"desc":"asc":(Je.field=n,Je.direction="asc"),ss()}});async function Hr(e){console.log("[onStartPoll] EVENT TRIGGERED. Element:",e&&e.target?e.target.id:"N/A"),e&&e.preventDefault(),Z||(Z=document.getElementById("poll-select")),console.log("[onStartPoll] Current pollSelect value:",Z?Z.value:"N/A");try{var n=Z.value;if(!n){console.warn("[onStartPoll] No poll selected."),await S("Please select a poll first.",{title:"Live poll"});return}var t=ae.find(function(p){return p.pollId===n});if(console.log("[onStartPoll] Selected Poll found:",!!t,t),!t){console.error("[onStartPoll] Could not find poll data for ID:",n),await S("Could not find the selected poll data.",{title:"Error"}),G(U,!1);return}if(f=t,pt(t.sessionType)){console.log("[onStartPoll] Starting Secure Session..."),G(U,!0,"Launching...");var o=f.questions&&f.questions[0]?f.questions[0]:null,a=o&&(o.questionText||o.stemHtml||o.text)||"",r=o?o.options||[]:[],i=o&&o.correctAnswer!==void 0?o.correctAnswer:null,s=o&&(o.questionImageURL||o.imageURL||o.mediaUrl)||"",d=f.questions&&f.questions.length?f.questions.length:0;Dr("setLiveSessionState").then(function(v){return console.log("[onStartPoll] secure: obtained callable context"),v.callable({pollId:n,status:"OPEN",questionIndex:0,questionText:a,options:r,correctAnswer:i,questionImageURL:s,totalQuestions:d,metadata:{sessionPhase:"ASSESSMENT_START",resultsVisibility:"HIDDEN"}})}).then(function(v){console.log("[onStartPoll] secure: callable result:",v);var y=v.data;if(G(U,!1),y&&y.success)Ol(y),Yi&&La&&La.checked;else throw new Error(y&&y.error||"Failed to start secure session")}).catch(function(v){console.error("[onStartPoll] secure: error:",v),G(U,!1),F(v)});return}console.log("[onStartPoll] Starting Live Session..."),G(U,!0,"Starting..."),Pn(),Ie=!1,ze=!0;var o=f.questions&&f.questions[0]?f.questions[0]:null,l=o&&(o.questionText||o.stemHtml||o.text)||"",c=o?o.options||[]:[],u=o&&o.correctAnswer!==void 0?o.correctAnswer:null,m=o&&(o.questionImageURL||o.imageURL||o.mediaUrl)||"",g=f.questions&&f.questions.length?f.questions.length:0;Dr("setLiveSessionState").then(function(p){return console.log("[onStartPoll] live: obtained callable context"),p.callable({pollId:n,status:"OPEN",questionIndex:0,questionText:l,options:c,correctAnswer:u,questionImageURL:m,totalQuestions:g,metadata:{sessionPhase:"LIVE",resultsVisibility:"HIDDEN"}})}).then(function(p){console.log("[onStartPoll] live: callable result:",p),G(U,!1);var v=p.data;if(v&&v.success)console.log("[onStartPoll] Session started successfully. Triggering UI transition..."),sessionStorage.setItem("veritas_active_poll_id",n),Xa({pollId:n,status:"OPEN",questionIndex:0,metadata:{sessionPhase:"LIVE",resultsVisibility:"HIDDEN"}}),Yi&&La&&La.checked;else throw new Error(v.error||"Failed to start poll")}).catch(function(p){console.error("[onStartPoll] live: error:",p),G(U,!1),F(p)})}catch(p){console.error("[onStartPoll] Synchronous error:",p),typeof G=="function"&&U&&G(U,!1),F(p)}}function ls(){de&&clearInterval(de),Nt(),ft(),We=!1,fe=!1,se=me,Mt(),te("Timer idle.","info"),Ie=!1,ze=!0;var e=f&&f.pollId||"",n=typeof f.questionIndex=="number"?f.questionIndex:0;firebase.functions().httpsCallable("setLiveSessionState")({pollId:e,status:"OPEN",questionIndex:n}).then(function(t){var a=t.data;if(a&&(a.success===!1||a.error))throw new Error(a.error||"Failed to resume poll");console.log("[Firebase] Poll Resumed:",a)}).catch(F)}function ds(){Nt(),ft(),fe=!1,se=me,Mt(),te("Timer idle.","info");var e=firebase.functions().httpsCallable("setLiveSessionState"),n=f.pollId,t=f.questionIndex||0;e({pollId:n,status:"PAUSED",questionIndex:t}).then(function(a){Ie=!0,console.log("Poll Stopped (Paused):",a.data)}).catch(F)}function Da(){Nt(),ft(),fe=!1,se=me,Mt(),te("Timer idle.","info");var e=document.getElementById("header-end-show-btn");e&&(e.disabled=!0);var n=firebase.functions().httpsCallable("setLiveSessionState"),t=f.pollId,a=f.questionIndex,r=f.resultsVisibility||"HIDDEN",i=r==="REVEALED";if(!t){console.error("Missing pollId");return}var s=i?"HIDDEN":"REVEALED";n({pollId:t,questionIndex:a,status:"LIVE",metadata:{serverProcessed:!0,resultsVisibility:s}}).then(function(d){console.log("Question Visibility Toggled via Cloud Function (REVEALED="+!i+")"),e&&(e.disabled=!1)}).catch(function(d){console.error("Finalize Session Error:",d),e&&(e.disabled=!1),F(d)})}function cs(){de&&clearInterval(de),Nt(),ft(),We=!1,fe=!1,se=me,Mt(),te("Timer ready for previous question.","info"),Ie=!1,Ce=!0;var e=(f.questionIndex||0)-1;e<0&&(e=0);var n=firebase.functions().httpsCallable("setLiveSessionState"),t=f.pollId,a=f.questions&&f.questions[e]?f.questions[e]:null;n({pollId:t,questionIndex:e,status:"OPEN",questionText:a?a.questionText:"",options:a?a.options:[]}).then(function(r){setTimeout(function(){Ce=!1},500)}).catch(function(r){Ce=!1,F(r)})}var Hn=0;function zn(){if(yn){console.warn("[Navigation] Already in progress; ignoring extra Next click");return}yn=!0,Hn++;var e=Hn;console.log("[Navigation] Starting with sequenceId:",e),setTimeout(function(){yn=!1,Ce=!1},5e3),de&&clearInterval(de),Nt(),ft(),We=!1,fe=!1,se=me,Mt(),te("Timer ready for next question.","info"),Ie=!1,Ce=!0;var n=(f.questionIndex||0)+1;if(f&&f.questions&&n<f.questions.length){console.log("[Optimistic] Advancing UI to question index:",n,"sequenceId:",e);var t={mode:"lightweight",pollId:f.pollId,questionIndex:n,status:"OPEN",metadata:{sessionPhase:"LIVE",resultsVisibility:"HIDDEN",startedAt:new Date().toISOString(),sequenceId:e}};Xa(t)}var a=firebase.functions().httpsCallable("setLiveSessionState"),r=f.pollId,i=f.questions&&f.questions[n]?f.questions[n]:null;a({pollId:r,questionIndex:n,status:"OPEN",questionText:i?i.questionText:"",options:i?i.options:[],metadata:{sequenceId:e,timestamp:Date.now()}}).then(function(s){console.log("[Navigation] Server confirmed sequenceId:",e),e===Hn?setTimeout(function(){Ce=!1,yn=!1},500):console.warn("[Navigation] Sequence mismatch: local="+Hn+", this="+e+" (ignoring stale response)")}).catch(function(s){console.error("[Navigation] Error with sequenceId:",e,s),e===Hn&&(Ce=!1,yn=!1),F(s)})}async function Pa(){var e=f.pollId,n=f.questionIndex;if(!e||typeof n>"u"){await S("No active question to reset.",{title:"Reset question"});return}var t=await Qe("Reset the current question for all students?",{title:"Reset question",confirmText:"Reset question",destructive:!0});if(t){var a=await Qe("Select OK to reset and clear responses, or Cancel to reset while keeping submissions.",{title:"Responses",confirmText:"Reset & clear",cancelText:"Keep submissions",destructive:!0});dn(),ft(),We=!1,fe=!1,ie=!1,se=me,D=me,ln(!1),mt(),te("Timer idle.","info");var r=firebase.functions().httpsCallable("setLiveSessionState");a&&firebase.database().ref("answers/"+e).remove().then(function(){console.log("Responses cleared for poll reset.")}).catch(console.error),r({pollId:e,questionIndex:n,status:"OPEN",questionText:f.questions&&f.questions[n]?f.questions[n].questionText:"",options:f.questions&&f.questions[n]?f.questions[n].options:[]}).then(function(i){Ie=!1,P("success","Question Reset",a?"Timer restarted and responses cleared.":"Timer restarted (responses kept).")}).catch(F)}}function us(e,n){if(je=!!e,!!pe){var t=!f.pollId;pe.disabled=t,pe.setAttribute("aria-disabled",t?"true":"false"),pe.setAttribute("aria-pressed",je?"true":"false"),pe.dataset.state=je?"on":"off",pe.classList.toggle("bg-amber-500",je&&!t),pe.classList.toggle("text-veritas-navy",je&&!t),pe.classList.toggle("bg-white/10",!(je&&!t)),ya&&(ya.textContent=je?"On":"Off",ya.classList.toggle("text-veritas-gold",je),ya.classList.toggle("opacity-80",!je))}}async function Rl(){if(!(!pe||fa)){var e=f&&f.pollId;if(!e){F("No active session to update.");return}var n=!je;pe.setAttribute("aria-busy","true"),pe.disabled=!0;try{var t=firebase.functions().httpsCallable("setLiveSessionState"),a=await t({pollId:e,metadata:{calculatorEnabled:n}});pe.removeAttribute("aria-busy"),pe.disabled=!1,us(n,!0)}catch(r){pe.removeAttribute("aria-busy"),pe.disabled=!1,F(r)}}}function Dl(){var e=document.getElementById("hide-results-btn");e&&(e.disabled=!0),firebase.functions().httpsCallable("setLiveSessionState")({pollId:f.pollId,status:"PAUSED",questionIndex:CURRENT_QUESTION_INDEX,sessionPhase:"RESULTS_HOLD",resultsVisibility:"HIDDEN"}).then(function(t){e&&(e.disabled=!1)}).catch(function(t){e&&(e.disabled=!1),F(t)})}async function ms(){var e=await Qe("Are you sure you want to end this poll completely?",{title:"End poll",confirmText:"End poll",destructive:!0});if(!e)return;sessionStorage.removeItem("veritas_active_poll_id"),Fe(),firebase.functions().httpsCallable("finalizeSession")({pollId:f&&f.pollId||""}).then(function(t){Fe()}).catch(F)}function Pl(e){var n=e&&typeof e.totalResponses=="number"?e.totalResponses:0,t=e&&typeof e.totalStudents=="number"?e.totalStudents:0,a=document.getElementById("live-overview-responses"),r=document.getElementById("live-overview-response-progress"),i=document.getElementById("live-overview-response-caption"),s=document.getElementById("hud-response-count"),d=document.getElementById("hud-response-caption"),o=document.getElementById("hud-response-trend"),l=document.getElementById("mobile-response-chip");a&&(a.textContent=n+" / "+t);var c=t>0?Math.round(n/t*100):0;if(r){var u=Math.max(0,Math.min(100,c));r.style.width=u+"%"}if(i&&(i.textContent=t>0?c+"% complete":"Awaiting roster data"),s&&(s.textContent=(t>0?n:"0")+" / "+(t||0)),l&&(l.textContent=(t>0?n:0)+" / "+(t||0)),d&&(d.textContent=t>0?c+"% complete":"Awaiting roster data"),o){o.classList.remove("hud-trend-up","hud-trend-down","hud-trend-steady");var m=rt.lastCompletionPct;if(m===null||t===0)o.textContent="â€¢ steady",o.classList.add("hud-trend-steady");else{var g=c-m;g>0?(o.textContent="â–² +"+g+"%",o.classList.add("hud-trend-up")):g<0?(o.textContent="â–¼ "+g+"%",o.classList.add("hud-trend-down")):(o.textContent="â€¢ steady",o.classList.add("hud-trend-steady"))}}rt.lastCompletionPct=t>0?c:null,hi("hud-response-ring",c);var p=document.getElementById("hud-response-percent");p&&(p.textContent=c+"%"),xi("responses",c);var v=t>0&&n===t,y=document.getElementById("all-responded-banner");v?rt.allRespondedCelebrated||(P("success","All Students Responded!","Everyone has submitted their answer.",null,{label:"Reveal Answer",onClick:function(){var le=document.getElementById("header-end-show-btn");le&&le.click()}}),y&&(y.classList.add("hidden"),y.setAttribute("aria-hidden","true")),rt.allRespondedCelebrated=!0):(y&&(y.classList.add("hidden"),y.setAttribute("aria-hidden","true")),rt.allRespondedCelebrated=!1),typeof window.checkAllRespondedState=="function"&&window.checkAllRespondedState(v);var E=e&&e.results,q;Array.isArray(E)?q=E:E&&typeof E=="object"?q=Object.keys(E).map(function(le){var qe=E[le];if(qe&&typeof qe=="object"&&!Array.isArray(qe)){var bn={};return Object.keys(qe).forEach(function(ar){bn[ar]=qe[ar]}),bn.answerText=le,bn.count=typeof qe.count=="number"?qe.count:0,bn}return{answerText:le,count:typeof qe=="number"?qe:0}}):q=[];var B=e&&e.correctAnswer,x=0,C=0;q.forEach(function(le){if(le){var qe=typeof le.count=="number"?le.count:0;x+=qe;var bn=le.answerText||le.text||le.optionText||"",ar=le.isCorrect===!0||!!B&&bn===B;ar&&(C+=qe)}});var R=document.getElementById("live-overview-accuracy"),N=document.getElementById("live-overview-accuracy-caption"),V=document.getElementById("hud-accuracy-value"),W=document.getElementById("hud-accuracy-caption"),w=document.getElementById("hud-accuracy-trend"),A=document.getElementById("mobile-accuracy-chip"),T=x>0?Math.round(C/x*100):0;R&&(R.textContent=T+"%"),N&&(x===0?N.textContent="No responses yet":N.textContent=C+" of "+x+" correct"),V&&(V.textContent=x>0?T+"%":"--%"),A&&(A.textContent=x>0?T+"%":"--%");var _e=document.getElementById("hud-metacognition-value");if(_e)if(!e||!e.studentStatuses||x===0)_e.textContent="--";else{var nt=0,yt=0,sa={guessing:1,"somewhat-sure":2,"very-sure":3,certain:4};if(Object.values(e.studentStatuses).forEach(function(le){le.confidence&&sa[le.confidence]&&(nt+=sa[le.confidence],yt++)}),yt>0){var pi=(nt/yt).toFixed(1);_e.textContent=pi+"/4"}else _e.textContent="--"}if(x>0){hi("hud-accuracy-ring",T);var er=document.getElementById("hud-accuracy-percent");if(er&&(er.textContent=T+"%"),xi("accuracy",T),T===100&&x>=3){var oe=document.getElementById("hud-accuracy-card");oe&&!oe.classList.contains("celebrate")&&wo(oe,"perfect-accuracy")}}if(W&&(x===0?W.textContent="Waiting for responses":W.textContent=C+" of "+x+" correct"),w)if(w.classList.remove("hud-trend-up","hud-trend-down","hud-trend-steady"),x===0)w.textContent="â€¢ steady",w.classList.add("hud-trend-steady");else{var tr=rt.lastAccuracyPct;if(tr===null)w.textContent="â€¢ steady",w.classList.add("hud-trend-steady");else{var nr=T-tr;nr>0?(w.textContent="â–² +"+nr+"%",w.classList.add("hud-trend-up")):nr<0?(w.textContent="â–¼ "+nr+"%",w.classList.add("hud-trend-down")):(w.textContent="â€¢ steady",w.classList.add("hud-trend-steady"))}}rt.lastAccuracyPct=x>0?T:null}function Fl(e,n,t){var a=document.getElementById("live-overview-lockouts");a&&(a.textContent=e||0);var r=document.getElementById("live-overview-lockouts-caption"),i=document.getElementById("hud-lockouts-value"),s=document.getElementById("hud-lockouts-caption");document.getElementById("hud-lockouts-card");var d=document.getElementById("hud-focus-lockouts-btn"),o=document.getElementById("mobile-lock-chip"),l=document.getElementById("mobile-locks-btn"),c=document.getElementById("mobile-locks-label");if(r){var u=(e||0)+0;if(u===0)r.textContent="No approvals pending";else{var m=[];e&&m.push(e+" locked"),r.textContent=m.join(" â€¢ ")}}var g=(e||0)+0;if(i&&(i.textContent=g),o&&(o.textContent=g),c&&(c.textContent=g===1?"1 Locked":g+" Locked"),s&&(g===0?s.textContent="No approvals pending":s.textContent="Requires quick approval"),d)if(g>0)d.disabled=!1,d.classList.remove("opacity-50","pointer-events-none");else{d.disabled=!0,d.classList.add("opacity-50","pointer-events-none");var p=document.getElementById("locked-students-popover");p&&p.classList.add("hidden")}l&&(l.disabled=g===0),rt.lastLockoutTotal=g;var v=document.getElementById("focus-lockouts-btn");v&&(v.disabled=(e||0)===0);var y=document.getElementById("live-overview-waiting");y&&(y.textContent=t||0);var E=document.getElementById("live-overview-waiting-caption");E&&(t?t===1?E.textContent="1 student still working":E.textContent=t+" students still working":E.textContent="Everyone has responded")}function Ol(e){Zs(e)}async function Ul(){var e=await Qe("Are you sure you want to end this session for all students?",{title:"End Session",confirmText:"End Session",cancelText:"Cancel"});if(!e)return;He.stop();var n=O||f&&f.pollId;if(!n)return;firebase.functions().httpsCallable("finalizeSession")({pollId:n}).then(function(){Fe()}).catch(F)}function rn(e,n){var t=document.querySelectorAll('[id="'+e+'"]');t.forEach(function(a){a.style.display=n})}function Fa(e,n){var t=document.querySelectorAll('[id="'+e+'"]');t.forEach(function(a){"disabled"in a&&(a.disabled=n),n?(a.style.opacity="0.5",a.style.cursor="not-allowed"):(a.style.opacity="1",a.style.cursor="pointer")})}function sn(e){if(ht.style.display="none",G(U,!1),!!e){e.pollId&&Xn(e.pollId);var n=e.status||"PRE_LIVE",t=e.metadata||{},a=typeof t.isCollecting=="boolean"?t.isCollecting:n==="LIVE",r=t.resultsVisibility||"HIDDEN",v=r==="REVEALED",i=n==="PRE_LIVE",s=n==="ENDED",d=t.calculatorEnabled===!0||e.calculatorEnabled===!0||e.secureSettings&&e.secureSettings.calculatorEnabled===!0;if(!ze&&!i)if(n==="LIVE"||n==="OPEN")console.log("[updateLiveView] Transitioning to LIVE session state"),ze=!0;else return;if((n==="LIVE"||n==="OPEN")&&Pe("live"),(typeof we>"u"||we===null)&&(we=e.questionIndex),i||s){console.log("[updateLiveView] Session is PRE_LIVE or ENDED, showing dashboard"),Fe();return}if(e.error){F(e.error);return}var o=typeof f.questionIndex=="number"?f.questionIndex:null;if(Ie=!a,f.pollId=e.pollId||Z.value,f.questionIndex=e.questionIndex,f.correctAnswer=e.correctAnswer,e.sessionType&&(st=Ge(e.sessionType),f.sessionType=e.sessionType),!f.questions&&ae){var l=ae.find(function(oe){return oe.pollId===(e.pollId||f.pollId)});l&&l.questions&&(console.log("[Enrichment] Restored questions from ALL_POLLS cache"),f.questions=l.questions)}f.pollId&&Xn(f.pollId),f.totalQuestions=e.totalQuestions,f.timerSeconds=e.timerSeconds||null,f.options=e.options||[],f.metacognition=e.metacognition||null,f.calculatorEnabled=d,pt(e.sessionType||st),us(d);var c=o===null||e.questionIndex!==o;mn("header-poll-name",e.pollName),mn("header-poll-name",e.pollName);var u=we!==null?we:e.questionIndex,m=we===e.questionIndex,g=document.getElementById("header-present-btn");g&&(!m&&u!==e.questionIndex?g.classList.remove("hidden"):g.classList.add("hidden")),fs(e.questionIndex,e.totalQuestions,we),f.questions&&f.questions[u]&&vo(u),Fa("header-back-btn",e.questionIndex<=0),Fa("header-prev-btn",e.questionIndex<=0);var p=e.questionIndex>=e.totalQuestions-1;Fa("header-next-btn",p),Fa("mobile-next-btn",p);var v=r==="REVEALED",y=document.getElementById("mobile-resume-btn"),E=document.getElementById("mobile-reveal-btn");if(v?(rn("header-start-btn","none"),rn("header-end-show-btn","none"),y&&y.classList.add("hidden"),E&&E.classList.add("hidden")):Ie?(rn("header-start-btn","flex"),rn("header-end-show-btn","flex"),y&&y.classList.remove("hidden"),E&&E.classList.remove("hidden")):(rn("header-start-btn","none"),rn("header-end-show-btn","flex"),y&&y.classList.add("hidden"),E&&E.classList.remove("hidden")),c){var q=e.timerSeconds?Math.min(600,Math.max(15,parseInt(e.timerSeconds,10))):90;me=q,se=q,D=q,We=!1,fe=!1,ie=!1,Ze.stop(),ie=!1,fe=!1,ln(!1),mt(),te("Timer idle.","info")}if(e.metadata)if(e.metadata.reason==="TIMER_EXPIRED"){se=0,D=0;var B=fe;fe=!0,mt(),fe=B,We=!0,te("Time expired â€” poll paused.","danger")}else e.metadata.reason==="MANUAL_PAUSE"?te("Poll paused.","info"):e.metadata.reason==="RESPONSES_CLOSED"?te("Responses closed. Ready to reveal.","info"):e.metadata.reason==="RESULTS_REVEALED"?te("Results shared with students.","success"):e.metadata.reason==="RESULTS_HIDDEN"?te("Results hidden from students.","info"):te("Timer idle.","info");console.log("=== TEACHER RECEIVED DATA ==="),console.log("questionImageURL:",e.questionImageURL),console.log("options:",e.options),e.options&&e.options.length>0&&e.options.forEach(function(oe,tr){console.log("  Option "+tr+":",'text="'+oe.text+'", imageURL='+oe.imageURL)});var x=vi!==e.questionIndex;if(x){vi=e.questionIndex;var C=document.querySelector(".live-question-card");C&&(C.classList.remove("motion-slide-in-right"),C.offsetWidth,C.classList.add("motion-slide-in-right"))}mn("live-question-info","Q"+(e.questionIndex+1)+"/"+e.totalQuestions),Us("live-question-text",e.questionText),Us("live-question-text-compact",e.questionText);var R=document.getElementById("question-image-container"),N=document.querySelectorAll('[id="live-question-image"]'),V=document.getElementById("question-layout-container");if(e.questionImageURL){R&&(R.style.display="flex"),V&&V.classList.remove("no-image");var W=e.questionImageURL,w="q="+e.questionIndex,A=W.includes("?")?"&":"?";N.forEach(function(oe){oe.src=W+A+w,oe.style.display="block",oe.setAttribute("referrerpolicy","no-referrer")})}else R&&(R.style.display="none"),N.forEach(function(oe){oe.src=""}),V&&V.classList.add("no-image");mn("response-count",e.totalResponses+" / "+e.totalStudents+" answered"),mn("response-count-header",e.totalResponses+" / "+e.totalStudents+" answered"),Pl(e),Hl(e.results,e.correctAnswer,e.studentStatusList),zl(e.metacognition||null);var T=document.getElementById("results-reveal-strip");if(T){var _e=typeof e.questionIndex=="number"&&e.questionIndex>=0;if(a||!_e||!v)T.classList.add("hidden");else{T.classList.remove("hidden");var nt=document.getElementById("hide-results-btn"),yt=document.getElementById("strip-next-btn"),sa=document.getElementById("results-strip-status");if(nt&&(nt.disabled=!_e),yt&&(yt.disabled=!_e),sa){var pi=e.totalResponses===0?" No responses were recorded.":"";sa.textContent="Students can now see the correct answer and results."+pi}}}if(H=e.studentStatusList,typeof Ka=="function"&&Ka(),cr&&Array.isArray(H)){var er=H.map(function(oe){return{label:Ue(oe),subLabel:oe.status,value:oe.email}});cr.updateData(er)}ve(),de&&clearInterval(de),Ie||(de=setInterval(Tt,ca))}}function _l(e){if(!(Ie||Ce)&&e!==f.questionIndex){de&&clearInterval(de),Nt(),ft(),We=!1,fe=!1,se=me,Mt(),te("Navigating...","info"),Ie=!1,Ce=!0,we=e,fs(f.questionIndex,f.totalQuestions,we),vo(we);var n=document.getElementById("header-present-btn");n&&(we!==f.questionIndex?n.classList.remove("hidden"):n.classList.add("hidden")),Ce=!1}}function fs(e,n,t){t==null&&(t=e);var a=document.getElementById("question-progress-container");if(a){a.innerHTML="";var r=10,i=0,s=n;if(n>r&&(i=Math.max(0,t-Math.floor(r/2)),s=Math.min(n,i+r),s-i<r&&(i=Math.max(0,s-r))),i>0){var d=document.createElement("span");d.className="text-white/30 text-xs mx-1",d.textContent="...",a.appendChild(d)}for(var o=i;o<s;o++){var l=document.createElement("button");l.type="button";var c=o===e,u=o===t,m=o<e;l.className="question-step flex items-center justify-center rounded-full transition-all duration-300 cursor-pointer ",u?(l.className+="w-8 h-8 sm:w-9 sm:h-9 bg-veritas-gold text-white font-bold text-xs sm:text-sm shadow-md ring-2 ring-white/20 z-10",l.innerHTML="<span>"+(o+1)+"</span>"):c?(l.className+="w-8 h-8 bg-green-500 text-white font-bold hover:scale-105 ring-2 ring-green-400/50",l.innerHTML='<span class="material-symbols-outlined text-lg">podium</span>'):m?(l.className+="w-8 h-8 bg-emerald-500/80 text-white font-bold hover:bg-emerald-500 hover:scale-105",l.innerHTML='<span class="material-symbols-outlined text-lg">check</span>'):(l.className+="w-6 h-6 sm:w-7 sm:h-7 bg-white/10 text-white/50 border border-white/10 font-bold text-[10px] sm:text-xs hover:bg-white/20 hover:text-white hover:scale-105",l.innerHTML="<span>"+(o+1)+"</span>"),(function(p){l.onclick=function(v){v.stopPropagation(),_l(p)},l.title="View Question "+(p+1)})(o),a.appendChild(l)}if(s<n){var g=document.createElement("span");g.className="text-white/30 text-xs mx-1",g.textContent="...",a.appendChild(g)}}}function Hl(e,n,t){var a=document.getElementById("results-bars");a.innerHTML="";var r=Array.isArray(f.options)?f.options.slice():[],i={};if(r.forEach(function(o){i[o&&o.text||""]=!0}),e&&Object.keys(e).forEach(function(o){i[o||""]||(r.push({text:o||"",imageURL:""}),i[o||""]=!0)}),r.length===0&&(r=e&&Object.keys(e).length>0?Object.keys(e).map(function(o){return{text:o,imageURL:""}}):[]),r.length===0){a.innerHTML='<p class="text-center text-gray-500 py-4">Waiting for responses...</p>';return}var s=r.reduce(function(o,l){var c=l&&l.text||"",u=e&&typeof e[c]=="number"?e[c]:0;return o+u},0),d="ABCDEFGHIJKLMNOPQRSTUVWXYZ";r.forEach(function(o,l){var c=o&&o.text||"",u=e&&typeof e[c]=="number"?e[c]:0,m=s>0?Math.round(u/s*100):0,g=c===n,p=d[l]||String(l+1),v=o&&o.imageURL,y=document.createElement("div"),E=g?"border-green-500 dark:border-green-400":"border-gray-200 dark:border-gray-700",q=g?"bg-green-50/50 dark:bg-green-900/20":"bg-white dark:bg-brand-dark-gray/30";y.className="relative rounded-xl border "+E+" "+q+" overflow-hidden transition-all hover:shadow-sm";var B='<div class="flex items-start gap-2.5 p-3">',x=g?"bg-green-500 dark:bg-green-600":"bg-gray-600 dark:bg-gray-500";B+='<div class="flex-shrink-0 w-8 h-8 '+x+' rounded-lg flex items-center justify-center">',B+='<span class="text-white text-base font-bold">'+p+"</span>",B+="</div>",B+='<div class="flex-1 min-w-0">',c?B+='<div class="text-[1.125rem] font-medium text-brand-dark-gray dark:text-brand-white break-words leading-relaxed ql-editor-reset">'+sr(c)+"</div>":v||(B+='<p class="text-sm font-medium text-gray-400 dark:text-gray-500">(No content)</p>'),v&&(B+='<div class="mt-1.5"><img src="'+h(v)+'" class="max-w-full max-h-24 rounded-lg border border-gray-200 dark:border-gray-700" alt="Answer '+p+' image" referrerpolicy="no-referrer"/></div>');var C=Array.isArray(t)?t.filter(function(N){return N.answer===c}):[];C.length>0&&(B+='<div class="mt-1.5 flex flex-wrap gap-1">',C.forEach(function(N){var V=No(N.confidence),W=lr[N.confidence]||{},w=W.badgeClass||"bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300",A=Ue(N);if(V){var T=W.emoji||"";A=T+" "+A}B+='<span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[11px] font-medium '+w+'">'+h(A)+"</span>"}),B+="</div>"),B+="</div>";var R=g?"bg-green-500 dark:bg-green-600":"bg-gray-700 dark:bg-gray-600";B+='<div class="flex-shrink-0 '+R+' text-white rounded-lg px-2 py-1 flex flex-col items-center">',B+='<span class="text-lg font-bold leading-none">'+m+"%</span>",B+='<span class="text-[10px] opacity-90 mt-0.5">'+u+"</span>",B+="</div>",B+="</div>",y.innerHTML=B,a.appendChild(y)}),or()}function zl(e){var n=document.getElementById("confidence-pulse-container");if(n&&(n.innerHTML="",!(!e||!e.enabled))){var t=document.createElement("div");t.id="live-metacognition-card",t.className="bg-white dark:bg-brand-dark-gray/30 p-3 rounded-xl border border-purple-200 dark:border-purple-700 shadow-sm";var a=e.totalResponses||0,r=e.responseRate||0,i=Array.isArray(e.flaggedStudents)?e.flaggedStudents:[],s=a>0?a+" responses â€¢ "+r+"% participation":"Waiting for responses",d=[{key:"confidentCorrect",emoji:"ðŸ’¯",label:"Sure & Right",barClass:"bg-emerald-500",textClass:"text-emerald-700 dark:text-emerald-200"},{key:"confidentIncorrect",emoji:"âš ï¸",label:"Sure & Wrong",barClass:"bg-rose-500",textClass:"text-rose-700 dark:text-rose-200"},{key:"uncertainCorrect",emoji:"ðŸ¤”",label:"Unsure & Right",barClass:"bg-amber-500",textClass:"text-amber-700 dark:text-amber-200"},{key:"uncertainIncorrect",emoji:"ðŸ¤·",label:"Unsure & Wrong",barClass:"bg-blue-500",textClass:"text-blue-700 dark:text-blue-200"}],o='<div class="flex items-start justify-between gap-3 mb-2">';o+='<div class="flex items-start gap-2">',o+='<span class="material-symbols-outlined text-purple-600 dark:text-purple-300 text-xl">psychology</span>',o+='<div><h4 class="text-brand-dark-gray dark:text-brand-white font-semibold text-sm leading-tight">Confidence Pulse</h4>',o+='<p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Certainty vs. accuracy snapshot</p></div>',o+="</div>",o+='<div class="text-xs px-2 py-1 rounded-md bg-purple-50 text-purple-700 dark:bg-purple-900/30 dark:text-purple-200 font-semibold">'+h(s)+"</div>",o+="</div>",o+='<div class="flex flex-wrap gap-2 mb-3 text-xs font-semibold">',o+='<span class="px-2 py-1 rounded-md bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-200">âœ“ Correct: '+(e.correctCount||0)+"</span>",o+='<span class="px-2 py-1 rounded-md bg-rose-50 text-rose-700 dark:bg-rose-900/30 dark:text-rose-200">âœ— Incorrect: '+(e.incorrectCount||0)+"</span>",o+='<span class="px-2 py-1 rounded-md bg-slate-100 text-slate-700 dark:bg-slate-800/50 dark:text-slate-200">âŠ˜ Unanswered: '+(e.unansweredCount||0)+"</span>",o+="</div>",o+='<div class="grid grid-cols-1 sm:grid-cols-2 gap-2">',d.forEach(function(l){var c=e.matrixPercentages&&typeof e.matrixPercentages[l.key]=="number"?e.matrixPercentages[l.key]:0,u=e.matrixCounts&&typeof e.matrixCounts[l.key]=="number"?e.matrixCounts[l.key]:0,m=[];Array.isArray(H)&&(m=H.filter(function(g){if(g.status!=="Submitted"||!g.confidence)return!1;var p=g.isCorrect===!0,v=g.confidence>=.75;return l.key==="confidentCorrect"?v&&p:l.key==="confidentIncorrect"?v&&!p:l.key==="uncertainCorrect"?!v&&p:l.key==="uncertainIncorrect"?!v&&!p:!1})),o+='<div class="confidence-row flex flex-col">',o+='<div class="flex items-center justify-between gap-2">',o+='<div class="flex items-center gap-1.5"><span class="text-sm">'+l.emoji+'</span><span class="text-xs font-semibold '+l.textClass+'">'+l.label+"</span></div>",o+='<span class="text-sm font-bold '+l.textClass+'">'+c+"%</span>",o+="</div>",o+='<div class="confidence-bar-track my-1"><div class="confidence-bar-fill '+l.barClass+'" style="width:'+c+'%"></div></div>',m.length>0&&(o+='<div class="flex flex-wrap gap-1 mt-1 mb-2">',m.forEach(function(g){o+='<span class="px-1.5 py-0.5 rounded bg-white/50 dark:bg-black/20 text-[10px] font-medium border border-black/5 truncate max-w-full">'+h(Ue(g))+"</span>"}),o+="</div>"),o+='<div class="flex items-center justify-between text-[11px] text-brand-dark-gray/60 dark:text-brand-white/60 mt-auto">',o+="<span>"+u+" students</span>",o+="<span>live</span>",o+="</div>",o+="</div>"}),o+="</div>",i.length>0&&(o+='<div class="rounded-lg border border-rose-500/40 bg-rose-500/10 p-2 mt-2">',o+='<div class="flex items-center gap-1 mb-1">',o+='<span class="material-symbols-outlined text-sm text-rose-700 dark:text-rose-200">report</span>',o+='<span class="text-xs font-semibold text-rose-700 dark:text-rose-200">'+i.length+" confidently wrong</span>",o+="</div>",o+='<div class="flex flex-wrap gap-1">',i.forEach(function(l){var c=h(l.name||l.email||"Student");o+='<span class="px-1.5 py-0.5 rounded bg-white/70 text-xs font-medium text-rose-700 dark:bg-rose-900/40 dark:text-rose-100">'+c+"</span>"}),o+="</div>",o+="</div>"),t.innerHTML=o,n.appendChild(t)}}var Bt="all",Vl="all";function jl(e){if(e==null)return null;var n=e.toString().trim().toLowerCase(),t=n.replace(/\s+/g,"_");return t.indexOf("blocked")===0?"BLOCKED":t.indexOf("awaiting_fullscreen")===0||t.indexOf("awaitingfullscreen")===0||t.indexOf("awaiting_full_screen")===0?"AWAITING_FULLSCREEN":t.indexOf("locked")===0||t.indexOf("locked")>0&&t.indexOf("unlocked")===-1||t.indexOf("approval")!==-1&&t.indexOf("unlocked")===-1?"LOCKED":null}function on(e){return e?jl(e.status||e.proctorStatus||null):null}function Ql(e){return on(e)==="LOCKED"}async function Wl(){if(!(!f||!f.pollId)){var e=H.filter(function(u){return Ql(u)});if(e.length===0){await S("No students are currently locked.",{title:"No students to approve"});return}var n=await Qe("Approve re-entry for all "+e.length+" locked student(s)?",{title:"Approve All",confirmText:"Approve All ("+e.length+")"});if(n){var t=document.getElementById("approve-all-unlocks-btn");t&&(t.disabled=!0,t.querySelector("span:last-child").textContent="Approving...");for(var a=0,r=0,i=0;i<e.length;i++){var s=e[i];try{var d=firebase.functions().httpsCallable("manageProctoring"),o=parseInt(s.lockVersion,10);isNaN(o)&&(o=0);var l=await d({action:"UNLOCK",studentEmail:s.email,pollId:f.pollId,lockVersion:o});l.data&&l.data.success?(a++,H=H.map(function(u){return u.email===s.email?{name:u.name,email:u.email,status:"AWAITING_FULLSCREEN",lockVersion:l.data.lockVersion||s.lockVersion,lockReason:u.lockReason,lockedAt:u.lockedAt,answer:u.answer,isCorrect:u.isCorrect,timestamp:u.timestamp}:u})):r++}catch{r++}}if(ve(),t&&(t.disabled=!1,t.querySelector("span:last-child").textContent="Approve All"),a>0){var c="Approved "+a+" student(s)";r>0&&(c+=", "+r+" failed"),P("success","Batch Approval Complete",c,4e3)}else P("error","Approval Failed","Failed to approve students. Please try again.",4e3)}}}function zr(e){var n=Math.floor((new Date-e)/1e3);return n<60?"just now":n<120?"1 minute ago":n<3600?Math.floor(n/60)+" minutes ago":n<7200?"1 hour ago":n<86400?Math.floor(n/3600)+" hours ago":Math.floor(n/86400)+" days ago"}async function gs(e,n,t,a,r){if(!(!e||!n)){if(r=r||{},t=parseInt(t,10),isNaN(t)&&(t=0),!r.skipConfirm){var i=await Qe("Approve unlock for "+e+"?",{title:"Approve unlock",confirmText:"Approve"});if(!i)return}if(a){a.disabled=!0;var d=a.querySelector("span.material-symbols-outlined"),o=a.querySelector("span:last-child");d&&(d.textContent="progress_activity"),d&&d.classList.add("animate-spin"),o&&(o.textContent="Unlocking...")}var s=!1;H=H.map(function(c){return c.email===e?(s=!0,Object.assign({},c,{status:"AWAITING_FULLSCREEN",optimistic:!0})):c}),s&&(ve(),console.log("[Optimistic UI] Student",e,"marked as AWAITING_FULLSCREEN (pending server confirmation)"));var d,o;ci("Unlock "+e);var l=firebase.functions().httpsCallable("manageProctoring");l({action:"UNLOCK",pollId:n,studentEmail:e,expectedLockVersion:t}).then(function(c){var u=c.data;if(u&&u.success){if(a){a.disabled=!1;var m=a.querySelector("span.material-symbols-outlined"),g=a.querySelector("span:last-child");m&&(m.textContent="check_circle",m.classList.remove("animate-spin")),g&&(lastSpan.textContent="Unlocked"),setTimeout(function(){$&&$.email===e&&populateStudentModal($)},1e3)}P("success","Unlocked",e+" has been approved to rejoin.")}else throw new Error(u&&u.error||"Failed to approve unlock")}).catch(function(c){if(console.error("[Unlock Error]",c),H=H.map(function(g){return g.email===e&&g.optimistic?(delete g.optimistic,Object.assign({},g,{status:"LOCKED"})):g}),ve(),a){a.disabled=!1;var u=a.querySelector("span.material-symbols-outlined"),m=a.querySelector("span:last-child");u&&(u.textContent="lock_open",u.classList.remove("animate-spin")),m&&(m.textContent="Approve Unlock")}c.message&&c.message.includes("version_mismatch")?P("warning","Unlock Failed","Student violated policy again. Refresh and retry.",5e3):F(c)})}}function Kl(e){var n=document.createElement("button");n.className="reset-btn flex-shrink-0 flex items-center justify-center gap-1 h-7 px-2.5 rounded-md bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-xs font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors",n.dataset.email=e.email||"";var t=document.createElement("span");t.className="material-symbols-outlined text-sm",t.textContent="refresh";var a=document.createElement("span");return a.textContent="Reset",n.appendChild(t),n.appendChild(a),n.addEventListener("click",function(r){r.stopPropagation(),e.email&&Qr("RESET",e.email)}),n}function Gl(e){var n=document.createElement("button");n.className="unlock-btn flex-shrink-0 flex items-center justify-center gap-1 h-8 px-3 rounded-md bg-red-600 text-white text-xs font-bold hover:bg-red-700 transition-colors shadow-sm",n.dataset.email=e.email||"",f&&f.pollId!==void 0&&(n.dataset.pollId=f.pollId),n.dataset.lockVersion=e.lockVersion!=null?e.lockVersion:0;var t=document.createElement("span");t.className="material-symbols-outlined text-sm",t.textContent="lock_open";var a=document.createElement("span");return a.textContent="Approve",n.appendChild(t),n.appendChild(a),n.addEventListener("click",function(r){r.stopPropagation(),e.email&&Qr("UNLOCK",e.email)}),n}function $l(e){if(!e)return null;var n=Ue(e),t=on(e),a=t==="LOCKED",r=t==="BLOCKED",i=t==="AWAITING_FULLSCREEN",s=e.isCorrect===!0,d=document.createElement("div"),o="relative group p-4 rounded-xl border transition-all duration-200 hover:shadow-md";a||i?o+=" bg-red-50 dark:bg-red-900/10 border-red-200 dark:border-red-800/30":r?o+=" bg-gray-100 dark:bg-gray-800 border-gray-300 dark:border-gray-600 opacity-60":e.status==="Submitted"?s?o+=" bg-emerald-50 dark:bg-emerald-900/10 border-emerald-200 dark:border-emerald-800/30":e.isCorrect===!1?o+=" bg-amber-50 dark:bg-amber-900/10 border-amber-200 dark:border-amber-800/30":o+=" bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700":o+=" bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",d.className=o;var l="INVITED",c=(e.status||"").toUpperCase();a?l="VIOLATION DETECTED":r?l="BLOCKED":i?l="ALLOW RE-ENTRY":c==="SUBMITTED"?l="ANSWERED":c==="IN PROGRESS"?l="WORKING...":c==="ACTIVE"?l="THINKING...":c==="CONNECTED"?l="JOINED":c==="TYPING"&&(l="TYPING...");var u='<div class="flex items-start justify-between mb-2 gap-2">';u+='<div class="flex flex-col min-w-0 flex-1">',u+='<span class="font-bold text-sm text-gray-900 dark:text-white truncate" title="'+h(n)+'">'+h(n)+"</span>",u+='<span class="text-[10px] uppercase font-bold tracking-wide text-gray-400 dark:text-gray-500 truncate">'+h(l)+"</span>",u+="</div>";var m="bg-gray-300";a?m="bg-red-500 animate-pulse":e.status==="Submitted"?m="bg-emerald-500":c==="IN PROGRESS"||c==="TYPING"?m="bg-indigo-400 animate-pulse":(c==="ACTIVE"||c==="CONNECTED")&&(m="bg-blue-400"),u+='<span class="flex-shrink-0 w-2.5 h-2.5 rounded-full shadow-sm mt-1 '+m+'"></span>',u+="</div>",u+='<div class="flex items-center justify-between border-t border-gray-100 dark:border-gray-700/50 pt-3 mt-1">';var g=e.answer?h(e.answer):'<span class="text-gray-300 italic">Thinking...</span>',p="text-gray-900 dark:text-white";if(e.status==="Submitted"&&(s?p="text-emerald-700 dark:text-emerald-300":e.isCorrect===!1&&(p="text-amber-700 dark:text-amber-300 line-through decoration-amber-500/50")),u+='<div class="flex flex-col">',u+='<span class="text-[10px] font-mono text-gray-400 mb-0.5">ANSWER</span>',u+='<span class="text-sm font-bold '+p+' truncate max-w-[100px]">'+g+"</span>",u+="</div>",e.confidence){var v=lr[e.confidence]||{},y=v.emoji||"â€¢",E=v.textClass||"text-gray-400";u+='<div class="flex flex-col items-end" title="'+(v.label||"")+'">',u+='<span class="text-[10px] font-mono text-gray-400 mb-0.5">CONFIDENCE</span>',u+='<span class="text-lg '+E+'">'+y+"</span>",u+="</div>"}u+="</div>";var q=a||e.status==="Submitted"||e.status==="Waiting...";if(q&&(u+='<div class="absolute inset-0 bg-white/95 dark:bg-gray-800/95 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2 rounded-xl backdrop-blur-[2px] z-10 pointer-events-none">',u+='<span class="text-xs font-bold text-gray-500 mb-1">ACTIONS</span>',u+='<div class="action-btn-container flex gap-2 pointer-events-auto"></div>',u+="</div>"),d.innerHTML=u,q){var B=d.querySelector(".action-btn-container");if(B){if(a){var x=Gl(e);x.className="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-bold rounded shadow-sm",x.innerHTML="UNLOCK",B.appendChild(x)}if(e.status==="Submitted"){var C=Kl(e);C.className="px-3 py-1.5 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold rounded shadow-sm",C.innerHTML="RESET",B.appendChild(C)}}}return d}var Vr="ALL";function ps(e){if(Vr!==e){Vr=e;var n=document.getElementById("filter-all-btn"),t=document.getElementById("filter-locked-only-btn");n&&(e==="ALL"?n.className="px-3 py-1 text-xs font-bold rounded-md bg-white dark:bg-gray-600 text-gray-800 dark:text-white shadow-sm transition-all":n.className="px-3 py-1 text-xs font-bold rounded-md text-gray-500 hover:text-gray-700 dark:text-gray-400 hover:bg-gray-300 dark:hover:bg-gray-600 transition-all"),t&&(e==="LOCKED"?t.className="px-3 py-1 text-xs font-bold rounded-md bg-white dark:bg-gray-600 text-red-600 dark:text-red-400 shadow-sm transition-all flex items-center gap-1":t.className="px-3 py-1 text-xs font-bold rounded-md text-gray-500 hover:text-gray-700 dark:text-gray-400 hover:bg-gray-300 dark:hover:bg-gray-600 transition-all flex items-center gap-1"),ve()}}function ve(){var e=document.getElementById("student-status-grid");if(e){var n=Array.isArray(H)?H:[],t=[];Vr==="LOCKED"?t=n.filter(function(y){var E=on(y);return E==="LOCKED"||E==="BLOCKED"}):t=n.slice(),t.sort(function(y,E){var q=function(C){var R=on(C);return R==="LOCKED"||R==="BLOCKED"?0:C.status==="Submitted"?C.isCorrect===!0?3:2:1},B=q(y),x=q(E);return B!==x?B-x:(y.lastName||"").localeCompare(E.lastName||"")}),e.innerHTML="";var a=document.createDocumentFragment();t.forEach(function(y){var E=$l(y);E&&(E.style.cursor="pointer",E.onclick=function(){Yl(y.email)},a.appendChild(E))}),e.appendChild(a);var r=t.filter(y=>y.status==="Submitted").length,i=t.filter(y=>y.status==="Submitted"&&y.isCorrect===!0).length,s=t.filter(y=>on(y)==="LOCKED").length,d=t.filter(y=>y.status!=="Submitted").length,o=t.length,l=r>0?Math.round(i/r*100):0,c=document.getElementById("hud-accuracy-value");c&&(c.textContent=r>0?l+"%":"--%");var u=document.getElementById("hud-response-count");u&&(u.textContent=r+"/"+o);var m=0,g=0;t.forEach(function(y){y.status==="Submitted"&&y.confidence&&(y.confidence==="guessing"?m+=0:y.confidence==="somewhat-sure"?m+=50:y.confidence==="very-sure"&&(m+=100),g++)});var p=g>0?Math.round(m/g):null,v=document.getElementById("hud-metacognition-value");v&&(p!==null?(v.textContent=p,v.className="text-xl font-bold "+(p>=80?"text-emerald-600":p>=50?"text-amber-600":"text-red-500")):(v.textContent="--",v.className="text-xl font-bold text-gray-400")),Fl(s,0,d)}}function Yl(e){var n=H.find(function(l){return l.email===e});if(n){var t=document.getElementById("student-inspector-panel");if(t){var a=Ue(n),r=on(n),i=r==="LOCKED",s=r==="BLOCKED",d=i?"text-red-600 bg-red-50":s?"text-gray-600 bg-gray-100":"text-emerald-600 bg-emerald-50",o=`
        <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-900">
          <div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white">${h(a)}</h3>
            <span class="text-xs px-2 py-0.5 rounded font-bold uppercase tracking-wide ${d}">${r||"UNKNOWN"}</span>
          </div>
          <button onclick="closeStudentInspector()" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-6">
          <div class="space-y-4">
            <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Actions</h4>
            <div class="grid grid-cols-1 gap-3">
              ${i?`
              <button onclick="proctorAction('UNLOCK', '${e}')" class="flex items-center justify-center gap-2 p-3 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700 transition-all shadow-md">
                <span class="material-symbols-outlined">lock_open</span>
                <span>Unlock Student</span>
              </button>`:""}
              
              <button onclick="proctorAction('RESET', '${e}')" class="flex items-center justify-center gap-2 p-3 bg-white border border-gray-300 text-gray-700 rounded-lg font-bold hover:bg-gray-50 transition-all">
                <span class="material-symbols-outlined">restart_alt</span>
                <span>Reset Question</span>
              </button>
              
              <button onclick="resendLinkToStudent('${e}')" class="flex items-center justify-center gap-2 p-3 bg-blue-50 text-blue-600 border border-blue-200 rounded-lg font-bold hover:bg-blue-100 transition-all">
                <span class="material-symbols-outlined">send</span>
                <span>Re-send Link</span>
              </button>
              
              ${s?`
              <button onclick="proctorAction('UNBLOCK', '${e}')" class="flex items-center justify-center gap-2 p-3 bg-gray-100 text-gray-700 border border-gray-300 rounded-lg font-bold hover:bg-gray-200 transition-all">
                <span class="material-symbols-outlined">check_circle</span>
                <span>Unblock Student</span>
              </button>`:`
              <button onclick="proctorAction('BLOCK', '${e}')" class="flex items-center justify-center gap-2 p-3 bg-red-50 text-red-600 border border-red-200 rounded-lg font-bold hover:bg-red-100 transition-all">
                <span class="material-symbols-outlined">block</span>
                <span>Block Student</span>
              </button>`}
            </div>
          </div>
          
          <div class="space-y-2">
            <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Details</h4>
            <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg text-sm space-y-2 border border-gray-200 dark:border-gray-700">
              <div class="flex justify-between">
                <span class="text-gray-500">Email</span>
                <span class="text-gray-900 dark:text-white font-mono">${h(n.email)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">Attempt Count</span>
                <span class="text-gray-900 dark:text-white font-mono">${n.attemptCount||0}</span>
              </div>
              
              <!-- Telemetry -->
              <div class="border-t border-gray-200 dark:border-gray-700 my-2 pt-2"></div>
              
              <div class="flex justify-between">
                <span class="text-gray-500">Time Spent</span>
                <span class="text-gray-900 dark:text-white font-mono">${n.timeOnQuestionMs?Math.round(n.timeOnQuestionMs/1e3)+"s":"--"}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">Calculator Used</span>
                <span class="font-bold border px-1.5 rounded text-xs ${n.usingCalculator?"text-amber-600 bg-amber-50 border-amber-200":"text-gray-400 border-gray-200"}">
                  ${n.usingCalculator?"YES":"NO"}
                </span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">Confidence</span>
                <span class="text-gray-900 dark:text-white">${n.confidence?n.confidence.replace("-"," ").toUpperCase():"--"}</span>
              </div>
              
               ${i?`
               <div class="border-t border-gray-200 dark:border-gray-700 my-2 pt-2"></div>
               <div class="flex justify-between">
                <span class="text-red-500 font-bold">Details</span>
                <span class="text-red-600 font-mono text-xs">${h(n.lastViolationReason||"Unknown Violation")}</span>
               </div>
               `:""}
               
            </div>
          </div>
        </div>
      `;t.innerHTML=o,t.classList.remove("hidden"),t.offsetWidth,t.classList.remove("translate-x-full")}}}function jr(){var e=document.getElementById("student-inspector-panel");e&&(e.classList.add("translate-x-full"),setTimeout(function(){e.classList.add("hidden")},300))}window.closeStudentInspector=jr,window.proctorAction=Qr,window.resendLinkToStudent=Xl;async function Xl(e){if(confirm("Re-send the unique poll link to "+e+"?")){var n=document.getElementById("send-link-btn"),t=n&&n.dataset.className;if(t||f&&f.className&&(t=f.className),!t){P("Error: Could not determine class name","error");return}var a=window.location.origin+"/student.html";P("info","Sending Link","Preparing email for "+e+"...");try{var r=await Xe({action:"SEND_EMAILS",className:t,pollId:f.pollId}),i=r.data;if(!i.success)throw new Error("Could not retrieve student link data");var s=i.links.find(function(g){return g.email===e});if(!s)throw new Error("Student not found in roster for this class");var d=(f.sessionType||"").toUpperCase().includes("SECURE"),o=a+"?token="+s.token,l=bs(s.name,o,d,e),c={subject:i.subject,students:[{email:e,name:s.name,subject:i.subject,body:l}]},u=await firebase.functions().httpsCallable("sendEmail")(c),m=u.data;if(m.success&&m.sentCount>0)P("success","Link Sent","Email sent to "+e);else throw new Error(m.error||"Failed to send email")}catch(g){console.error(g),P("error","Send Failed",g.message)}}}function Qr(e,n){if(confirm("Are you sure you want to "+e+" this student?")){if(!f||!f.pollId){console.error("[Proctor] No active poll data found."),P("Error: No active poll found","error");return}var t=firebase.functions().httpsCallable("manageProctoring");t({action:e,pollId:f.pollId,studentEmail:n}).then(function(a){console.log("[Proctor] Action success:",a),P("Action "+e+" successful","success"),jr()}).catch(function(a){console.error("[Proctor] Action failed:",a),F(a)})}}function Jl(e){if(typeof e!="number"||isNaN(e))return"--";var n=Math.max(0,Math.floor(e/1e3)),t=Math.floor(n/60),a=n%60;return t+"m "+(a<10?"0"+a:a)+"s"}function Zl(e){if(!e)return"";var n=e.isIdle?"bg-amber-400":"bg-emerald-400",t=typeof e.timeOnQuestion=="number"?Jl(e.timeOnQuestion):"",a=e.usingCalculator?'<span class="material-symbols-outlined text-sm text-blue-500">calculate</span>':"",r=t?"<span>"+t+"</span>":"";return`<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] bg-slate-100 text-slate-700 mr-2">
        <span class="h-2.5 w-2.5 rounded-full ${n}"></span>
        <span>${e.isIdle?"Idle":"Active"}</span>
        ${a}
        ${r}
      </span>`}function Tt(){if(!(Ie||!ze||Ce)){var e=f.pollId,n=f.questionIndex;!e||n===void 0||Me||(console.warn("[Firebase] Connection lost, attempting reconnect..."),Le&&Le.once("value").then(function(t){t.exists()&&console.log("[Firebase] Reconnected, refreshing data...")}))}}var me=90,se=90,We=!1,fe=!1,D=90,ie=!1,Ze=window.SecureAssessmentShared.createCountdown({onTick:function(e){D=e,se=e,mt()},onExpire:function(){ed()}});function ut(e){var n=Math.max(0,Math.round(e||0)),t=Math.floor(n/60),a=n%60,r=("0"+t).slice(-2),i=("0"+a).slice(-2);return r+":"+i}function Wr(){var e=document.getElementById("hud-pace-value");if(e){var n=document.getElementById("hud-pace-caption"),t=document.getElementById("hud-pace-chip"),a=document.getElementById("hud-pace-chip-icon"),r=document.getElementById("hud-pace-chip-label");e.textContent=ut(D);var i="ready",s="Timer ready",d="pause_circle",o="Ready";D<=0?(i="complete",s="All time used",d="task_alt",o="Complete"):ie?D<=15?(i="critical",s="Wrap up now",d="emergency",o="Critical"):(i="running",s="Timer running",d="play_arrow",o="Running"):D<me&&(i="paused",s="Paused â€” extend or resume",d="pause_circle",o="Paused"),n&&(n.textContent=s),t&&t.setAttribute("data-variant",i),a&&(a.textContent=d),r&&(r.textContent=o)}}function mt(){var e=document.getElementById("timer-display");if(e){e.value=ut(D),ie?document.title=ut(D)+" - Veritas Live Poll":document.title="Veritas Live Poll",se=D;var n=document.getElementById("timer-main-container");document.getElementById("timer-compact-container");var t=document.getElementById("timer-display-compact");t&&(t.value=ut(D)),n&&(n.classList.remove("timer-safe","timer-warning","timer-critical"),ie&&D>0&&(D<15?n.classList.add("timer-critical"):D<=30?n.classList.add("timer-warning"):n.classList.add("timer-safe"))),Wr()}}function ln(e){ie=e,fe=e;var n=document.getElementById("start-btn"),t=document.getElementById("pause-btn"),a=document.getElementById("add-10s-btn"),r=document.getElementById("subtract-10s-btn"),i=document.getElementById("timer-display"),s=document.getElementById("add-30s-btn-preset"),d=document.getElementById("add-60s-btn-preset"),o=document.getElementById("mobile-start-btn"),l=document.getElementById("mobile-pause-btn"),c=document.getElementById("mobile-timer-label"),u=document.getElementById("timer-display-compact"),m=document.getElementById("add-10s-btn-mobile"),g=document.getElementById("subtract-10s-btn-mobile");n&&n.classList.toggle("hidden",e),t&&t.classList.toggle("hidden",!e),o&&o.classList.toggle("hidden",e),l&&l.classList.toggle("hidden",!e),c&&(e?c.textContent="Running":D<me?c.textContent="Resume":c.textContent="Start"),a&&(a.disabled=e),r&&(r.disabled=e),i&&(i.disabled=e),s&&(s.disabled=e),d&&(d.disabled=e),m&&(m.disabled=e),g&&(g.disabled=e),u&&(u.disabled=e),Wr()}function Oa(){if(console.log("[Timer] startTimer called. isRunning:",ie,"totalSeconds:",D),ie||D<=0){console.log("[Timer] Cannot start - already running or no time");return}ln(!0),te("Timer runningâ€¦","info"),Ze.start(D),console.log("[Timer] Timer started")}function dn(){ie&&(Ze.pause(),ln(!1),te("Timer paused at "+ut(D)+".","info"))}function vs(){Ze.stop(),D=me,se=D,We=!1,Ze.set(D),ln(!1);var e=document.getElementById("timer-display");e&&e.classList.remove("timer-finished"),te("Timer reset to "+ut(me)+".","info"),document.title="Veritas Live Poll"}function ed(){Ze.stop(),ln(!1);var e=document.getElementById("timer-display");e&&(e.classList.add("timer-finished"),setTimeout(function(){e.classList.remove("timer-finished")},1e3)),We||(We=!0,se=0,D=0,mt(),te("Time expired â€” poll paused.","danger"),firebase.functions().httpsCallable("setLiveSessionState")({pollId:f.pollId,status:"PAUSED",questionIndex:f.questionIndex||0,metadata:{reason:"TIMER_EXPIRED"}}).then(function(n){var t=n.data;t&&t.success?(Ie=!0,sn(t)):F(t.error||"Failed to pause poll on timer expiry")}).catch(F))}function Ke(e){ie||(D+=e,D<0&&(D=0),se=D,me=D,Ze.set(D))}function qt(){if(!ie){var e=document.getElementById("timer-display");if(e){var n=e.value,t=0,a=0;if(n.includes(":")){var r=n.split(":");t=parseInt(r[0],10)||0,a=parseInt(r[1],10)||0,D=t*60+a}else if(n.trim()!==""){var i=parseInt(n,10)||0;D=i}se=D,me=D,Ze.set(D),Wr()}}}function te(e,n){var t=document.getElementById("timer-status-message");t&&(t.textContent=e,n==="danger"?t.className="text-xs text-red-600 dark:text-red-400 text-center font-medium":n==="success"?t.className="text-xs text-green-600 dark:text-green-400 text-center font-medium":t.className="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 text-center")}function Nt(){dn()}function ft(){Ze.stop(),ie=!1,fe=!1}function Mt(){se!==D&&(D=se),mt()}function bs(e,n,t,a){var r=t?"Secure Assessment Session":"Live Poll Session",i=t?"Your personalized link for today's secure assessment is ready. Please click the button below to begin.":"Your personalized link for today's live poll is ready. Please click the button below to begin.";return`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
    <title>VERITAS Live Poll</title>
    <style>
        /* BASE STYLES */
        body { margin: 0; padding: 0; width: 100% !important; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; color: #333333; line-height: 1.6; }
        .container { max-width: 600px; margin: 40px auto; padding: 0; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .content-padding { padding: 30px; }
        /* TYPOGRAPHY */
        h1, p, li, span, div, a { font-size: 16px; }
        h1 { margin: 0 0 16px 0; font-weight: 700; color: #12385d; letter-spacing: -0.5px; }
        p { margin: 0 0 16px 0; }
        /* BUTTON */
        .btn { display: inline-block; background-color: #12385d; color: #ffffff !important; text-decoration: none; padding: 14px 35px; border-radius: 4px; font-weight: 600; margin: 10px 0; }
        .btn:hover { background-color: #0f2f4d; }
        /* UTILS */
        .divider { height: 1px; background-color: #e5e7eb; margin: 20px 0; border: none; }
        .text-muted { color: #6b7280; }
        .footer { font-size: 12px; color: #9ca3af; margin-top: 30px; text-align: center; }
        .instructions-list { padding-left: 18px; color: #4b5563; margin-bottom: 0; }
        .instructions-list li { margin-bottom: 8px; }
        /* RESPONSIVE */
        @media screen and (max-width: 600px) {
            .container { margin: 0; border-radius: 0; }
            .content-padding { padding: 20px; }
            .btn { display: block; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div style="background-color: #12385d; padding: 20px 30px;">
            <span style="font-weight: 700; font-size: 26px; color: #ffffff;">VERITAS</span> 
            <span style="color: #c5a05a; margin: 0 8px; font-size: 26px;">|</span>
            <span style="color: #e5e7eb; font-size: 22px;">${r}</span>
        </div>
        <div class="content-padding">
            <p>Hello <strong>${e}</strong>,</p>
            <p>${i}</p>
            <div style="text-align: center;">
                <a href="${n}" class="btn">Begin Session</a>
            </div>
            <hr class="divider">
            <div style="background-color: #ffdcdc; padding: 20px; border-radius: 6px; border: 1px solid #fed7d7;">
                <p style="font-weight: 600; margin-bottom: 12px; margin-top: 0; color: #c53030;">Important Instructions:</p>
                <ul class="instructions-list" style="margin: 0;">
                    <li>You must remain in fullscreen mode throughout the entire session.</li>
                    <li>Don't navigate to other tabs or applications.</li>
                    <li>Do not refresh the browser to prevent disconnection.</li>
                </ul>
            </div>
            <div class="footer">
                <p style="margin-bottom: 8px;">ðŸ”’ This is a unique link for <strong>${a}</strong>. Do not share it.</p>
                <p style="margin-bottom: 0;">&copy; 2025 VERITAS</p>
            </div>
        </div>
    </div>
</body>
</html>`}async function Kr(){console.log("[onSendLink] Triggered");var e=De||document.getElementById("send-link-btn");if(!e){console.warn("Missing send link button");return}var n=e&&e.dataset.className;if(!n){await S("Please select a poll first.",{title:"Send poll links"});return}var t=await Qe("This will email a new, unique poll link to all students in "+n+". Are you sure?",{title:"Send poll links",confirmText:"Send links"});if(t){var a=K&&!K.disabled;K&&(G(K,!1),K.disabled=!0,K.setAttribute("aria-disabled","true")),G(e,!0,"Sending...");var r=window.location.origin+"/student.html";Xe({action:"SEND_EMAILS",className:n,pollId:f.pollId}).then(function(i){var s=i.data;if(!s.success)throw new Error("Could not prepare email data");s.baseUrl=r;var d=(f.sessionType||"").toUpperCase().includes("SECURE");return s.students=s.links.map(function(o){var l=r+"?token="+o.token,c=bs(o.name,l,d,o.email);return{email:o.email,name:o.name,subject:s.subject,body:c}}),firebase.functions().httpsCallable("sendEmail")(s).then(function(o){var l=o.data;if(G(e,!1),K&&a&&(K.disabled=!1,K.removeAttribute("aria-disabled")),l.success)S("Emails processed for "+l.sentCount+" students.",{title:"Emails Processed"});else{var c="Sent: "+(l.sentCount||0)+", Failed: "+(l.failedCount||0)+".";l.failures&&l.failures.length>0&&(c+=`

Failures:
`+l.failures.map(function(u){return u.name+": "+u.error}).join(`
`)),l.error&&(c="Error: "+l.error),S(c,{title:"Email Delivery Report",destructive:!0}),K&&(K.click(),P("info","Fallback","Opening link list for manual distribution.",4e3))}})}).catch(function(i){G(e,!1),F(i)})}}async function Ua(){var e=K;if(!e){console.warn("Missing view links button");return}var n=e&&e.dataset.className;if(!n){await S("Please select a poll first.",{title:"View links"});return}G(e,!0,"Loading...");var t=window.location.origin+"/student.html";Xe({action:"GET_LINKS",className:n}).then(function(a){var r=a.data;if(!r.success)return F(new Error("Could not load links"));var i=document.getElementById("links-container"),s='<div class="overflow-x-auto"><table class="w-full border-collapse">';s+='<thead><tr class="bg-brand-light-gray dark:bg-brand-dark-gray/50 border-b-2 border-brand-light-gray dark:border-brand-dark-gray/40">',s+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Student Name</th>',s+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Email</th>',s+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Link</th>',s+='<th class="px-4 py-3 text-center text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Actions</th>',s+="</tr></thead><tbody>",r.links.forEach(function(d){var o=t+"?token="+d.token;s+='<tr class="border-b border-brand-light-gray/50 dark:border-brand-dark-gray/20 hover:bg-brand-light-gray/30 dark:hover:bg-brand-dark-gray/10">',s+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+h(d.name)+"</td>",s+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+h(d.email)+"</td>",s+='<td class="px-4 py-3 text-xs font-mono text-brand-dark-gray/70 dark:text-brand-white/70 max-w-[200px] truncate" title="'+h(o)+'">'+h(o)+"</td>",s+='<td class="px-4 py-3 text-center">',s+='<button class="copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors" data-url="'+h(o)+'">Copy</button>',s+="</td></tr>"}),s+="</tbody></table></div>",i.innerHTML=s,i.querySelectorAll(".copy-link-btn").forEach(function(d){d.onclick=async function(){var o=this.dataset.url;try{if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")await navigator.clipboard.writeText(o);else{await S("Automatic copy is not supported in this browser. Please copy the link manually.",{title:"Copy link"});return}d.textContent="âœ“ Copied!",d.className="copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-green-600 text-brand-white",setTimeout(function(){d.textContent="Copy",d.className="copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors"},2e3)}catch{await S("Could not copy link. Please copy it manually.",{title:"Copy link",destructive:!0})}}}),ot.parentElement!==document.body&&document.body.appendChild(ot),ot.classList.remove("hidden"),ot.style.cssText="display: flex !important; visibility: visible !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: 99999 !important; background-color: rgba(0,0,0,0.6) !important;",ot.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden",G(e,!1)}).catch(function(a){F(a),G(e,!1)})}function td(){ot.classList.add("hidden"),ot.style.display="none",ot.style.cssText="",document.body.style.overflow=""}var cn=document.getElementById("poll-preview-modal");document.getElementById("editor-sidebar");var nd=document.getElementById("preview-poll-name"),ad=document.getElementById("preview-poll-meta"),Gr=document.getElementById("preview-questions-nav");document.getElementById("editor-question-input");var ys=document.getElementById("editor-timer-input"),hs=document.getElementById("editor-img-preview-container"),rd=document.getElementById("editor-img-thumbnail"),xs=document.getElementById("editor-options-list");document.getElementById("true-preview-container");var id=document.getElementById("preview-student-stem"),$r=document.getElementById("preview-student-visual"),Es=document.getElementById("preview-student-options"),_=null,ce=0,Vn=null,Oe=!1,gt=null;function ws(e){var n=ae.find(function(t){return t.pollId===e});if(!n){P("error","Error","Poll not found.");return}_=JSON.parse(JSON.stringify(n)),_.questions||(_.questions=[]),_.questions.length===0&&_.questions.push(sd()),ce=0,Oe=!1,nd.textContent=n.pollName||"Untitled Poll",od(),ld(),Yr(),Is(0),cn.parentElement!==document.body&&document.body.appendChild(cn),cn.style.display="flex",cn.classList.remove("hidden"),document.body.style.overflow="hidden",document.addEventListener("keydown",ks)}function _a(){Oe&&!confirm("You have unsaved changes. Are you sure you want to close?")||(cn.style.display="none",cn.classList.add("hidden"),document.body.style.overflow="",document.removeEventListener("keydown",ks),_=null)}function ks(e){e.key==="Escape"&&_a(),(e.metaKey||e.ctrlKey)&&e.key==="s"&&(e.preventDefault(),ud())}function sd(){return{questionText:"New Question",options:[{text:"Option A",imageURL:""},{text:"Option B",imageURL:""},{text:"Option C",imageURL:""},{text:"Option D",imageURL:""}],correctAnswer:"A",timerSeconds:60,questionImageURL:""}}function od(){var e=_.questions.length,n=_.className||"No Class";ad.textContent=n+" â€¢ "+e+" Question"+(e!==1?"s":""),document.getElementById("preview-question-count-badge").textContent=e}function Yr(){Gr.innerHTML="",_.questions.forEach(function(e,n){var t=document.createElement("div");t.className="group flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all border border-transparent "+(n===ce?"bg-veritas-navy/5 border-veritas-navy/10 shadow-sm":"hover:bg-gray-50 dark:hover:bg-gray-800"),t.draggable=!0;var a=document.createElement("span");a.className="material-symbols-outlined text-gray-400 text-lg cursor-grab active:cursor-grabbing opacity-0 group-hover:opacity-100 transition-opacity",a.textContent="drag_indicator";var r=document.createElement("span");r.className="text-xs font-bold w-5 h-5 flex items-center justify-center rounded bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 "+(n===ce?"bg-veritas-navy text-white dark:bg-veritas-navy dark:text-white":""),r.textContent=n+1;var i=document.createElement("div");i.className="flex-1 min-w-0";var s=document.createElement("div");s.innerHTML=e.questionText||"New Question";var d=s.textContent||s.innerText||"New Question";i.innerHTML='<p class="text-xs font-semibold text-gray-700 dark:text-gray-200 truncate">'+h(d)+"</p>",t.appendChild(a),t.appendChild(r),t.appendChild(i),t.onclick=function(){Is(n)},t.addEventListener("dragstart",function(o){gt=n,o.dataTransfer.effectAllowed="move",t.classList.add("opacity-50")}),t.addEventListener("dragend",function(){t.classList.remove("opacity-50"),gt=null}),t.addEventListener("dragover",function(o){o.preventDefault(),o.dataTransfer.dropEffect="move"}),t.addEventListener("drop",function(o){if(o.preventDefault(),gt!==null&&gt!==n){var l=_.questions.splice(gt,1)[0];_.questions.splice(n,0,l),ce===gt?ce=n:gt<ce&&n>=ce?ce--:gt>ce&&n<=ce&&ce++,Yr(),Oe=!0}}),Gr.appendChild(t)})}function ld(){Vn||(Vn=Re.init("editor-question-input","","Type your question here...",function(e){_&&(_.questions[ce].questionText=e.html,un(),Yr(),Oe=!0)}))}function Is(e){ce=e;for(var n=_.questions[e],t=Gr.children,a=0;a<t.length;a++)a===e?(t[a].classList.add("bg-veritas-navy/5","border-veritas-navy/10"),t[a].classList.remove("hover:bg-gray-50"),t[a].querySelector("span.w-5").classList.add("bg-veritas-navy","text-white")):(t[a].classList.remove("bg-veritas-navy/5","border-veritas-navy/10"),t[a].classList.add("hover:bg-gray-50"),t[a].querySelector("span.w-5").classList.remove("bg-veritas-navy","text-white"));if(document.getElementById("editor-current-num").textContent=e+1,Vn){var r=Vn.clipboard.convert(n.questionText||"");Vn.setContents(r,"silent")}ys.value=n.timerSeconds||60,ys.onchange=function(){n.timerSeconds=parseInt(this.value)||60,Oe=!0},n.questionImageURL?(rd.src=n.questionImageURL,hs.classList.remove("hidden")):hs.classList.add("hidden"),Ha(),un()}function Ha(){xs.innerHTML="";var e=_.questions[ce];e.options.forEach(function(n,t){var a=String.fromCharCode(65+t),r=e.correctAnswer===a,i=document.createElement("div");i.className="flex flex-col gap-2 bg-white dark:bg-brand-dark-gray p-3 rounded-lg border "+(r?"border-green-500 ring-1 ring-green-500/20":"border-gray-200 dark:border-gray-700");var s=document.createElement("div");s.className="flex items-center gap-3 w-full";var d=document.createElement("label");d.className="flex-shrink-0 flex items-center justify-center w-8 h-8 rounded-full border cursor-pointer transition-colors "+(r?"bg-green-500 border-green-500 text-white":"bg-gray-50 border-gray-300 hover:border-gray-400 text-gray-400"),d.innerHTML='<span class="text-sm font-bold">'+a+'</span><input type="radio" name="correct_answer" class="hidden" '+(r?"checked":"")+">",d.onclick=function(){e.correctAnswer=a,Ha(),un(),Oe=!0};var o=document.createElement("input");o.type="text",o.value=n.text||"",o.placeholder="Answer option "+a,o.className="flex-1 min-w-0 px-3 py-1.5 rounded-md border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-veritas-navy/50 outline-none text-sm",o.oninput=function(){n.text=this.value,un(),Oe=!0};var l=document.createElement("div");l.className="flex items-center gap-1";var c=document.createElement("label");c.className="p-1.5 text-gray-400 hover:text-veritas-navy cursor-pointer transition-colors rounded hover:bg-gray-100",c.title="Add Image",c.innerHTML='<span class="material-symbols-outlined text-lg">image</span><input type="file" class="hidden" accept="image/*" onchange="handleOptionImageUpload('+t+', this)">';var u=document.createElement("button");if(u.className="p-1.5 text-gray-400 hover:text-red-500 transition-colors rounded hover:bg-gray-100",u.innerHTML='<span class="material-symbols-outlined text-lg">close</span>',u.title="Remove Option",u.onclick=function(){cd(t)},l.appendChild(c),l.appendChild(u),s.appendChild(d),s.appendChild(o),s.appendChild(l),i.appendChild(s),n.imageURL){var m=document.createElement("div");m.className="pl-11 relative group inline-block";var g=document.createElement("img");g.src=n.imageURL,g.className="h-20 w-auto rounded border border-gray-200 object-contain bg-gray-50";var p=document.createElement("button");p.className="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-500 text-white rounded-full p-0.5 shadow-sm opacity-0 group-hover:opacity-100 transition-opacity",p.innerHTML='<span class="material-symbols-outlined text-[12px]">close</span>',p.onclick=function(){dd(t)},m.appendChild(g),m.appendChild(p),i.appendChild(m)}xs.appendChild(i)})}function dd(e){var n=_.questions[ce];n.options[e]&&(n.options[e].imageURL="",Ha(),un(),Oe=!0)}function cd(e){var n=_.questions[ce];if(n.options.length<=2){P("warning","Cannot Remove","Minimum 2 options required.");return}n.options.splice(e,1);var t=n.correctAnswer;e<n.correctAnswer.charCodeAt(0)-65?t=String.fromCharCode(n.correctAnswer.charCodeAt(0)-1):e===n.correctAnswer.charCodeAt(0)-65&&(t="A"),n.correctAnswer=t,Ha(),un(),Oe=!0}function un(){var e=_.questions[ce];id.innerHTML=e.questionText||'<span class="text-gray-400 italic">Start typing your question...</span>',e.questionImageURL?($r.querySelector("img").src=e.questionImageURL,$r.classList.remove("hidden")):$r.classList.add("hidden"),Es.innerHTML="",e.options.forEach(function(n,t){var a=String.fromCharCode(65+t),r=e.correctAnswer===a,i=document.createElement("div");i.className="student-option flex flex-col gap-2 "+(r?"correct-preview":"");var s=document.createElement("div");s.className="flex items-center gap-3 w-full";var d=document.createElement("div");d.className="student-badge",d.textContent=a;var o=document.createElement("div");if(o.className="text-sm font-medium flex-1 break-words",o.textContent=n.text||"Option "+a,s.appendChild(d),s.appendChild(o),r){var l=document.createElement("span");l.className="material-symbols-outlined text-green-500 text-lg",l.textContent="check_circle",s.appendChild(l)}if(i.appendChild(s),n.imageURL){var c=document.createElement("img");c.src=n.imageURL,c.className="w-full h-32 object-contain rounded border border-gray-100 bg-white ml-2",i.appendChild(c)}Es.appendChild(i)})}function ud(){if(!Oe){_a();return}var e=document.getElementById("preview-save-btn");e.disabled=!0,e.innerHTML='<div class="h-4 w-4 border-2 border-white/50 border-t-white rounded-full animate-spin"></div> Saving...',firebase.functions().httpsCallable("updatePoll")({pollId:_.pollId,pollName:_.pollName,className:_.className,questions:_.questions,metadata:{sessionType:_.sessionType||"live",timeLimitMinutes:_.timeLimitMinutes||null,accessCode:_.accessCode||"",availableFrom:_.availableFrom||"",dueBy:_.dueBy||"",secureSettings:_.secureSettings||{}}}).then(function(n){if(n.data&&n.data.success){P("success","Saved","Poll updated successfully."),Oe=!1;var t=ae.findIndex(a=>a.pollId===_.pollId);t!==-1&&(ae[t]=_),_a()}else throw new Error("Save failed")}).catch(function(n){P("error","Save Failed",n.message),e.disabled=!1,e.innerHTML='<span class="material-symbols-outlined text-lg">save</span> Save & Close'})}function md(){return hn+=1,"q-"+hn}function za(e){if(!e)return e;if(!e._id)e._id=md();else{var n=String(e._id).match(/q-(\d+)/);if(n){var t=parseInt(n[1],10);!isNaN(t)&&t>hn&&(hn=t)}}return typeof e._createdOrder!="number"&&(e._createdOrder=Date.now()),e}function Va(e,n){if(e){var t=j.indexOf(e);if(t!==-1){typeof n=="number"&&n!==t&&(j.splice(t,1),n>j.length&&(n=j.length),j.splice(n,0,e));return}typeof n=="number"&&n>=0&&n<=j.length?j.splice(n,0,e):j.push(e)}}function fd(e){if(e){var n=j.indexOf(e);n!==-1&&j.splice(n,1)}}function Ls(e){var n=new Map;k.forEach(function(a){a&&a._id&&n.set(a._id,a)});var t=[];return(e||[]).forEach(function(a){n.has(a)&&(t.push(n.get(a)),n.delete(a))}),n.forEach(function(a){t.push(a)}),t}function Rt(e){var n=e||k[L]&&k[L]._id||null,t=Ls(j);if(k=t,j=t.map(function(r){return r._id}),k.length===0){L=0;return}if(n){var a=k.findIndex(function(r){return r&&r._id===n});a!==-1?L=a:L>=k.length&&(L=Math.max(0,k.length-1))}else L>=k.length&&(L=Math.max(0,k.length-1))}function Xr(){ji&&(ji.textContent="Drag questions to reorder them manually.")}function gd(){if(!(!la||la.length===0)){var e=k[L]&&k[L]._id,n=Ls(la);k=n,j=n.map(function(t){return t._id}),Rt(e),vt(),ne(),z(),Xr()}}function ja(){ct&&ct.querySelectorAll(".question-nav-item").forEach(function(e){e.classList.remove("drop-before","drop-after")})}function Cs(){ct&&ct.querySelectorAll(".question-nav-item").forEach(function(e){e.classList.remove("drop-before","drop-after","dragging")})}function Ss(e,n){if(e){var t=j.indexOf(e);t!==-1&&(n>j.length&&(n=j.length),n>t&&n--,n!==t&&(j.splice(t,1),j.splice(n,0,e),Rt(e),vt(),ne(),z()))}}function pd(e){if(ue=this.dataset.questionId||null,!!ue){this.classList.add("dragging"),e.dataTransfer.effectAllowed="move";try{e.dataTransfer.setData("text/plain",ue)}catch{}}}function vd(e){if(ue){var n=this.dataset.questionId;if(!(!n||n===ue)){e.preventDefault(),ja();var t=this.getBoundingClientRect(),a=e.clientY-t.top<t.height/2;a?(this.classList.add("drop-before"),this.classList.remove("drop-after")):(this.classList.add("drop-after"),this.classList.remove("drop-before"))}}}function bd(){this.classList.contains("question-nav-item")&&this.classList.remove("drop-before","drop-after")}function yd(e){if(ue){var n=this.dataset.questionId;if(!(!n||n===ue)){e.preventDefault(),e.stopPropagation();var t=this.getBoundingClientRect(),a=e.clientY-t.top<t.height/2;ja();var r=j.indexOf(n);if(r!==-1){var i=a?r:r+1;Ss(ue,i),ue=null}}}}function hd(){Cs(),ue=null}function xd(e){ue&&(e.preventDefault(),ja())}function Ed(e){ue&&e.target===ct&&(e.preventDefault(),ja(),Ss(ue,j.length),ue=null)}function As(e){var n=document.getElementById("save-status");n&&(n.textContent=e)}function z(){As("Unsaved changes")}function Bs(e){As(e||"All changes saved")}function Ge(e){if(!e)return"LIVE_POLL";var n=e.toString().toUpperCase();return n==="LIVE"||n==="LIVE_POLL"?"LIVE_POLL":n==="SECURE_ASSESSMENT"||n==="SECURE"||n==="INDIVIDUAL_TIMED"?"SECURE_ASSESSMENT":"LIVE_POLL"}function pt(e){return Ge(e)==="SECURE_ASSESSMENT"}function Jr(){An&&An.forEach(function(e){var n=Ge(e.dataset.sessionType)===Ge(st);n?(e.classList.add("bg-primary","text-brand-white"),e.classList.remove("text-brand-dark-gray","dark:text-brand-white/70")):(e.classList.remove("bg-primary","text-brand-white"),e.classList.add("text-brand-dark-gray","dark:text-brand-white/70"))})}function Qa(){yr&&(pt(st)?yr.classList.remove("hidden"):yr.classList.add("hidden"))}function Ts(e){if(!e)return"";var n=new Date(e);if(isNaN(n.getTime()))return"";var t=n.getFullYear(),a=String(n.getMonth()+1).padStart(2,"0"),r=String(n.getDate()).padStart(2,"0"),i=String(n.getHours()).padStart(2,"0"),s=String(n.getMinutes()).padStart(2,"0");return t+"-"+a+"-"+r+"T"+i+":"+s}function qs(e){if(!e)return"";var n=new Date(e);return isNaN(n.getTime())?"":n.toISOString()}function Zr(){$t&&($t.value=typeof ge.timeLimitMinutes=="number"?ge.timeLimitMinutes:""),Yt&&(Yt.value=ge.accessCode||""),Xt&&(Xt.value=Ts(ge.availableFrom)),Jt&&(Jt.value=Ts(ge.dueBy))}function jn(){if($t){var e=parseInt($t.value,10);ge.timeLimitMinutes=isNaN(e)?"":e}return Yt&&(ge.accessCode=(Yt.value||"").trim().toUpperCase()),Xt&&(ge.availableFrom=qs(Xt.value)),Jt&&(ge.dueBy=qs(Jt.value)),{timeLimitMinutes:typeof ge.timeLimitMinutes=="number"?ge.timeLimitMinutes:null,accessCode:ge.accessCode||"",availableFrom:ge.availableFrom||"",dueBy:ge.dueBy||""}}function wd(){ge={timeLimitMinutes:60,accessCode:"",availableFrom:"",dueBy:""},Zr()}function ei(e,n){st=Ge(e),Jr(),Qa(),n||z()}function kd(){var e=jn();return{sessionType:st,timeLimitMinutes:e.timeLimitMinutes,accessCode:e.accessCode,availableFrom:e.availableFrom,dueBy:e.dueBy,secureSettings:{timeLimitMinutes:e.timeLimitMinutes,accessCode:e.accessCode,availableFrom:e.availableFrom,dueBy:e.dueBy,fullscreenRequired:pt(st),proctoringRules:["Fullscreen required","No tab switching","Mission Control monitoring"]}}}function Id(e){console.warn("Legacy openPollCreator called. Redirecting to Wizard."),typeof na=="function"?(na(),ra(e)):console.error("New Wizard not found.")}function Ns(){ha&&(ha.style.display="none",ha.classList.add("hidden"),ha.style.cssText=""),document.body.style.overflow="",k=[],L=0,zt=null,document.getElementById("save-poll-btn").innerHTML='<span class="truncate">Publish Poll</span>',Bs("All changes saved"),j=[],la=[],hn=0,ue=null,Xr(),wd(),ei("LIVE_POLL",!0),Qa()}var Dt=[],et=new Set;function Ld(){var e=document.getElementById("question-bank-modal");e&&(e.style.display="flex",Cd())}function Ms(){var e=document.getElementById("question-bank-modal");e&&(e.style.display="none"),et.clear(),Rs()}function Cd(){var e=document.getElementById("bank-questions-container");document.getElementById("bank-poll-filter"),e&&(e.innerHTML='<p class="text-center text-brand-dark-gray/60 py-8">Loading questions from your polls...</p>',(function(){try{var n=[];(ae||[]).forEach(function(t){!t||!t.questions||t.questions.forEach(function(a,r){n.push({pollId:t.pollId,pollName:t.pollName,questionIndex:r,questionText:a.questionText||"",answers:a.answers||a.options||[],topicTag:a.topicTag||a.topic||"",difficultyLevel:a.difficultyLevel||""})})}),Dt=n,ti(),Sd()}catch(t){console.error("Question Bank synthesis failed:",t),e.innerHTML='<p class="text-center text-red-600 py-8">Failed to synthesize question bank: '+t.message+"</p>"}})())}function Sd(){var e=document.getElementById("bank-poll-filter");if(e){var n=[...new Set(Dt.map(function(t){return t.pollName}))];e.innerHTML='<option value="">All Polls ('+Dt.length+" questions)</option>",n.forEach(function(t){var a=Dt.filter(function(r){return r.pollName===t}).length;e.innerHTML+='<option value="'+h(t)+'">'+h(t)+" ("+a+")</option>"}),e.onchange=function(){ti(this.value)}}}function ti(e){var n=document.getElementById("bank-questions-container");if(n){var t=e?Dt.filter(function(a){return a.pollName===e}):Dt;if(t.length===0){n.innerHTML='<p class="text-center text-brand-dark-gray/60 py-8">No questions found in your question bank.</p>';return}n.innerHTML=t.map(function(a,r){var i=et.has(a.pollId+":"+a.questionIndex),s=a.difficultyLevel?'<span class="text-xs px-2 py-0.5 rounded-full '+(a.difficultyLevel==="easy"?"bg-green-100 text-green-700":a.difficultyLevel==="medium"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700")+'">'+a.difficultyLevel+"</span>":"";return'<div class="bank-question-item p-4 rounded-lg border cursor-pointer transition-colors '+(i?"border-amber-500 bg-amber-50 dark:bg-amber-900/20":"border-brand-light-gray dark:border-brand-dark-gray/40 hover:bg-brand-light-gray/30")+'" data-bank-key="'+a.pollId+":"+a.questionIndex+'"><div class="flex items-start justify-between gap-3"><div class="flex-1"><p class="text-sm font-medium text-brand-dark-gray dark:text-brand-white line-clamp-2">'+h(a.questionText||"No question text")+'</p><div class="flex flex-wrap items-center gap-2 mt-2"><span class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">'+h(a.pollName)+"</span>"+(a.topicTag?'<span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300">'+h(a.topicTag)+"</span>":"")+s+'</div></div><div class="flex-shrink-0"><span class="material-symbols-outlined text-xl '+(i?"text-amber-600":"text-brand-light-gray")+'">'+(i?"check_circle":"radio_button_unchecked")+"</span></div></div></div>"}).join(""),n.querySelectorAll(".bank-question-item").forEach(function(a){a.onclick=function(){var r=this.dataset.bankKey;et.has(r)?et.delete(r):et.add(r),ti(document.getElementById("bank-poll-filter")?.value),Rs()}})}}function Rs(){var e=document.getElementById("bank-selected-count"),n=document.getElementById("import-selected-btn"),t=et.size;e&&(e.textContent=t+" question"+(t!==1?"s":"")+" selected"),n&&(n.disabled=t===0)}function Ad(){et.size!==0&&(et.forEach(function(e){var n=e.split(":"),t=n[0],a=parseInt(n[1],10),r=Dt.find(function(s){return s.pollId===t&&s.questionIndex===a});if(r){var i={questionText:r.questionText||"",answers:(r.answers||[]).map(function(s){return typeof s=="string"?{text:s}:{text:s.text||"",imageURL:s.imageURL||null}}),correctAnswerIndex:0,metacognitionEnabled:!1,topicTag:r.topicTag||"",difficultyLevel:r.difficultyLevel||""};i.answers.length<2&&(i.answers=[{text:""},{text:""}]),za(i),k.push(i),Va(i._id)}}),Rt(),vt(),ne(),z(),Ms(),S(et.size+" question(s) imported successfully!",{title:"Question Bank"}))}var Qn={"Unit 1":{name:"Chemistry of Life",weight:"8-11%",topics:["1.1 Structure of Water and Hydrogen Bonding","1.2 Elements of Life","1.3 Introduction to Biological Macromolecules","1.4 Properties of Biological Macromolecules","1.5 Structure and Function of Biological Macromolecules","1.6 Nucleic Acids"]},"Unit 2":{name:"Cell Structure and Function",weight:"10-13%",topics:["2.1 Cell Structure: Subcellular Components","2.2 Cell Structure and Function","2.3 Cell Size","2.4 Plasma Membranes","2.5 Membrane Permeability","2.6 Membrane Transport","2.7 Facilitated Diffusion","2.8 Tonicity and Osmoregulation","2.9 Mechanisms of Transport","2.10 Cell Compartmentalization","2.11 Origins of Cell Compartmentalization"]},"Unit 3":{name:"Cellular Energetics",weight:"12-16%",topics:["3.1 Enzyme Structure","3.2 Enzyme Catalysis","3.3 Environmental Impacts on Enzyme Function","3.4 Cellular Energy","3.5 Photosynthesis","3.6 Cellular Respiration","3.7 Fitness"]},"Unit 4":{name:"Cell Communication and Cell Cycle",weight:"10-15%",topics:["4.1 Cell Communication","4.2 Introduction to Signal Transduction","4.3 Signal Transduction","4.4 Changes in Signal Transduction Pathways","4.5 Feedback","4.6 Cell Cycle","4.7 Regulation of Cell Cycle"]},"Unit 5":{name:"Heredity",weight:"8-11%",topics:["5.1 Meiosis","5.2 Meiosis and Genetic Diversity","5.3 Mendelian Genetics","5.4 Non-Mendelian Genetics","5.5 Environmental Effects on Phenotype","5.6 Chromosomal Inheritance"]},"Unit 6":{name:"Gene Expression and Regulation",weight:"12-16%",topics:["6.1 DNA and RNA Structure","6.2 Replication","6.3 Transcription and RNA Processing","6.4 Translation","6.5 Regulation of Gene Expression","6.6 Gene Expression and Cell Specialization","6.7 Mutations"]},"Unit 7":{name:"Natural Selection",weight:"13-20%",topics:["7.1 Introduction to Natural Selection","7.2 Natural Selection","7.3 Artificial Selection","7.4 Population Genetics","7.5 Hardy-Weinberg Equilibrium","7.6 Evidence of Evolution","7.7 Common Ancestry","7.8 Continuing Evolution","7.9 Phylogeny","7.10 Speciation","7.11 Extinction","7.12 Variations in Populations","7.13 Origin of Life on Earth"]},"Unit 8":{name:"Ecology",weight:"10-15%",topics:["8.1 Responses to the Environment","8.2 Energy Flow Through Ecosystems","8.3 Population Ecology","8.4 Effect of Density of Populations","8.5 Community Ecology","8.6 Biodiversity","8.7 Disruptions to Ecosystems"]}};function Bd(){var e=document.getElementById("ai-suggestions-modal");e&&(e.style.display="flex",Td(),qd())}function Ds(){var e=document.getElementById("ai-suggestions-modal");e&&(e.style.display="none")}function Td(){var e=document.getElementById("ai-current-question");if(e){var n=k[L];n&&n.questionText?e.textContent='"'+n.questionText.substring(0,150)+(n.questionText.length>150?"...":"")+'"':e.textContent='"No question text entered"'}}function qd(){var e=document.getElementById("apbio-unit-select"),n=document.getElementById("apbio-topic-select"),t=document.getElementById("apbio-preview");document.getElementById("apbio-tag-preview"),e.value="",n.innerHTML='<option value="">-- Select Unit First --</option>',n.disabled=!0,document.getElementById("bigidea-evo").checked=!1,document.getElementById("bigidea-ene").checked=!1,document.getElementById("bigidea-ist").checked=!1,document.getElementById("bigidea-syi").checked=!1,t.classList.add("hidden");var a=k[L];if(a&&a.topicTag){var r=a.topicTag,i=r.match(/Unit \d/);i&&(e.value=i[0],Ps(i[0]))}e.onchange=function(){Ps(this.value),ni()},n.onchange=ni,["bigidea-evo","bigidea-ene","bigidea-ist","bigidea-syi"].forEach(function(s){document.getElementById(s).onchange=ni})}function Ps(e){var n=document.getElementById("apbio-topic-select");if(!e||!Qn[e]){n.innerHTML='<option value="">-- Select Unit First --</option>',n.disabled=!0;return}var t=Qn[e];n.innerHTML='<option value="">-- Select Topic --</option>',t.topics.forEach(function(a){var r=document.createElement("option");r.value=a,r.textContent=a,n.appendChild(r)}),n.disabled=!1}function ni(){var e=document.getElementById("apbio-preview"),n=document.getElementById("apbio-tag-preview"),t=document.getElementById("apbio-unit-select"),a=document.getElementById("apbio-topic-select"),r=[];t.value&&Qn[t.value]&&r.push(t.value+": "+Qn[t.value].name),a.value&&r.push(a.value);var i=[];document.getElementById("bigidea-evo").checked&&i.push("EVO"),document.getElementById("bigidea-ene").checked&&i.push("ENE"),document.getElementById("bigidea-ist").checked&&i.push("IST"),document.getElementById("bigidea-syi").checked&&i.push("SYI"),i.length>0&&r.push("Big Ideas: "+i.join(", ")),r.length>0?(n.textContent=r.join(" | "),e.classList.remove("hidden")):e.classList.add("hidden")}function Nd(){var e=document.getElementById("apbio-unit-select"),n=document.getElementById("apbio-topic-select");if(!e.value){S("Please select a unit before applying the tag.",{title:"AP Bio Topic Tagger"});return}var t=[];e.value&&Qn[e.value]&&t.push(e.value),n.value&&t.push(n.value);var a=[];document.getElementById("bigidea-evo").checked&&a.push("EVO"),document.getElementById("bigidea-ene").checked&&a.push("ENE"),document.getElementById("bigidea-ist").checked&&a.push("IST"),document.getElementById("bigidea-syi").checked&&a.push("SYI"),a.length>0&&t.push("["+a.join(", ")+"]");var r=t.join(" | ");k[L].topicTag=r,k[L].topic=r,k[L].apBioUnit=e.value,k[L].apBioTopic=n.value,k[L].apBioBigIdeas=a,z(),ne(),Ds(),S("AP Bio topic tag applied: "+r,{title:"Topic Tagged!"})}function Fs(){var e=document.getElementById("stimulus-modal");e&&(e.style.display="flex",document.getElementById("stimulus-title-input").value="",document.getElementById("stimulus-content-input").value="",document.getElementById("stimulus-question-count").value="2")}function ai(){var e=document.getElementById("stimulus-modal");e&&(e.style.display="none")}function Md(){var e=(document.getElementById("stimulus-title-input").value||"").trim(),n=Re.get("stimulus-content-editor"),t=n?n.root.innerHTML:"",a=n?n.getContents():null,r=n?n.getText():"";if(!t){var i=document.getElementById("stimulus-content-input");i&&(t=i.value)}var s=parseInt(document.getElementById("stimulus-question-count").value,10)||2;if(!e&&!r.trim()){S("Please enter a stimulus title or content.",{title:"Stimulus Required"});return}for(var d="stimulus-"+Date.now(),o=0;o<s;o++){var l={questionText:"",answers:[{text:""},{text:""}],correctAnswerIndex:0,metacognitionEnabled:!1,topicTag:"",difficultyLevel:"",stimulusId:d,stimulusTitle:e,stimulusHtml:t,stimulusDelta:a,stimulusText:r,stimulusContent:t,isStimulus:o===0};za(l),k.push(l),Va(l._id)}ai(),Rt(),vt(),ne(),z(),S(s+' question(s) created with stimulus "'+(e||"Untitled")+'"',{title:"Stimulus Created"})}function Rd(e){var n=e===!0,t=k[L],a=j.length;if(t&&t._id){var r=j.indexOf(t._id);r!==-1&&(a=r+1)}var i={questionText:"",questionImage:null,questionImageURL:null,questionImageFileId:null,answers:[{text:"",image:null,imageURL:null,imageFileId:null},{text:"",image:null,imageURL:null,imageFileId:null}],correctAnswerIndex:0,timerSeconds:null,metacognitionEnabled:!1};za(i),k.push(i),Va(i._id,a),Rt(i._id),n||z(),vt(),ne()}async function Dd(e){if(k.length<=1){await S("A poll must have at least one question.",{title:"Edit poll"});return}var n=k[e],t=n&&n._id;k.splice(e,1),t&&fd(t),L>=k.length&&(L=Math.max(0,k.length-1)),Rt(),vt(),ne(),z()}async function Pd(e){if(k.length>=50){await S("Maximum 50 questions per poll. Cannot duplicate.",{title:"Edit poll"});return}var n=k[e];if(n){var t=JSON.parse(JSON.stringify(n));delete t._id,delete t._createdOrder,za(t),t._createdOrder=Date.now(),k.splice(e+1,0,t);var a=n._id?j.indexOf(n._id):-1,r=a===-1?j.length:a+1;Va(t._id,r),Rt(t._id),vt(),ne(),z()}}function vt(){var e=document.getElementById("question-navigator");e.innerHTML="",ue=null,Cs(),k.forEach(function(n,t){var a=t===L,r=document.createElement("div");r.className="question-nav-item group relative flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer "+(a?"bg-primary/20 dark:bg-primary/30":"hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10");var i='<span class="material-symbols-outlined '+(a?"text-brand-dark-gray dark:text-brand-white":"text-brand-dark-gray/50 dark:text-brand-white/50")+'">drag_indicator</span>';i+='<p class="'+(a?"text-primary dark:text-brand-white":"text-brand-dark-gray dark:text-brand-white")+' text-sm font-medium leading-normal">Question '+(t+1)+"</p>",i+='<div class="absolute right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">',i+='<button class="duplicate-question-btn p-1 rounded-full hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10" data-index="'+t+'" title="Duplicate question">',i+='<span class="material-symbols-outlined text-brand-dark-gray dark:text-brand-white text-base">content_copy</span>',i+="</button>",k.length>1&&(i+='<button class="delete-question-btn p-1 rounded-full hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10" data-index="'+t+'" title="Delete question">',i+='<span class="material-symbols-outlined text-brand-dark-gray dark:text-brand-white text-base">close</span>',i+="</button>"),i+="</div>",r.innerHTML=i,r.dataset.questionId=n&&n._id?n._id:"question-"+t,r.dataset.index=t,r.setAttribute("draggable","true"),r.addEventListener("dragstart",pd),r.addEventListener("dragover",vd),r.addEventListener("dragleave",bd),r.addEventListener("drop",yd),r.addEventListener("dragend",hd),r.onclick=function(o){o.target.classList.contains("material-symbols-outlined")&&(o.target.textContent==="close"||o.target.textContent==="content_copy")||(L=t,vt(),ne())};var s=r.querySelector(".duplicate-question-btn");s&&(s.onclick=function(o){o.stopPropagation(),Pd(parseInt(this.dataset.index))});var d=r.querySelector(".delete-question-btn");d&&(d.onclick=function(o){o.stopPropagation(),Dd(parseInt(this.dataset.index))}),e.appendChild(r)})}function ne(){var e=document.getElementById("question-builder-workspace"),n=k[L],t='<div class="max-w-4xl mx-auto">';t+='<div class="flex flex-wrap justify-between gap-3 mb-6">',t+='<div class="flex min-w-72 flex-col gap-1">',t+='<p class="text-brand-dark-gray dark:text-brand-white tracking-light text-[32px] font-bold leading-tight">Question '+(L+1)+"</p>",t+='<p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm font-normal leading-normal">Edit the question and answer choices below.</p>',t+="</div></div>",t+='<div class="bg-brand-white dark:bg-brand-dark-gray/20 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/30 p-6 shadow-sm mb-6">',t+='<label class="flex flex-col w-full">',t+='<p class="text-brand-dark-gray dark:text-brand-white text-base font-medium leading-normal pb-2">Question Text</p>',t+='<textarea id="question-text-input" class="form-input flex w-full min-w-0 flex-1 resize-y overflow-hidden rounded-lg text-brand-dark-gray dark:text-brand-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 focus:border-primary min-h-36 placeholder:text-brand-dark-gray/50 dark:placeholder:text-brand-white/50 p-[15px] text-base font-normal leading-normal" placeholder="Type your question here...">'+h(n.questionText||"")+"</textarea>",t+="</label>",t+='<div class="grid w-full max-w-xs items-center gap-1.5 mt-4">',t+='<label for="question-image-input" class="text-sm text-gray-400 font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Question Image</label>',t+='<input id="question-image-input" type="file" accept="image/*" class="flex h-10 w-full rounded-md border border-brand-light-gray dark:border-brand-dark-gray/50 bg-white dark:bg-brand-dark-gray/30 px-3 py-2 text-sm text-gray-400 file:border-0 file:bg-transparent file:text-gray-600 dark:file:text-gray-300 file:text-sm file:font-medium focus:outline-none focus:ring-2 focus:ring-primary/50">',t+="</div>";var a=ri(n.questionImage||n.questionImageURL,n.questionImageFileId),r=n.questionImage==="UPLOADING";(a||r)&&(t+='<div class="mt-4 flex flex-wrap items-center gap-3 bg-primary/5 dark:bg-primary/10 p-3 rounded-lg">',r?(t+='<div class="flex items-center gap-2 text-primary dark:text-brand-white">',t+='<div class="h-5 w-5 animate-spin rounded-full border-2 border-primary border-t-transparent"></div>',t+='<span class="text-sm font-medium">Uploading image...</span>',t+="</div>"):a&&(t+='<img src="'+a+'" class="rounded-lg max-w-xs h-auto" referrerpolicy="no-referrer">',t+='<button type="button" class="remove-question-image-btn h-9 px-4 rounded-lg bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-sm font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors">Remove Image</button>'),t+="</div>"),t+='<div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">',t+="<div>",t+='<label class="text-brand-dark-gray dark:text-brand-white text-sm font-medium leading-normal block pb-2" for="question-topic-input">Topic/Standard Tag</label>',t+='<input id="question-topic-input" type="text" class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="e.g., Cell Division, Algebra, etc." value="'+h(n.topicTag||n.topic||"")+'">',t+='<p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-1">Used for topic-level analytics.</p>',t+="</div>",t+="<div>",t+='<label class="text-brand-dark-gray dark:text-brand-white text-sm font-medium leading-normal block pb-2" for="question-difficulty-select">Difficulty Level</label>',t+='<select id="question-difficulty-select" class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">';var i=n.difficultyLevel||"";t+='<option value=""'+(i===""?" selected":"")+">-- Select --</option>",t+='<option value="easy"'+(i==="easy"?" selected":"")+">ðŸŸ¢ Easy</option>",t+='<option value="medium"'+(i==="medium"?" selected":"")+">ðŸŸ¡ Medium</option>",t+='<option value="hard"'+(i==="hard"?" selected":"")+">ðŸ”´ Hard</option>",t+="</select>",t+='<p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-1">Compare predicted vs actual difficulty.</p>',t+="</div>",t+='<div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700/30 rounded-lg p-3">',t+='<div class="flex items-start gap-2">',t+='<input type="checkbox" id="question-metacognition-input" class="mt-0.5 h-4 w-4 rounded border-blue-300 dark:border-blue-600 text-blue-600 focus:ring-blue-500 cursor-pointer" '+(n.metacognitionEnabled?"checked":"")+" />",t+='<div class="flex-1">',t+='<label for="question-metacognition-input" class="text-brand-dark-gray dark:text-brand-white text-xs font-semibold leading-normal cursor-pointer block">Enable Metacognition Assessment</label>',t+='<p class="text-xs text-brand-dark-gray/70 dark:text-brand-white/70 mt-1">Ask students how confident they are in their answer.</p>',t+="</div>",t+="</div>",t+="</div>",t+="</div>",t+="</div>",t+='<div class="bg-brand-white dark:bg-brand-dark-gray/20 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/30 p-6 shadow-sm">',t+='<p class="text-brand-dark-gray dark:text-brand-white text-base font-medium leading-normal pb-4">Answer Choices</p>',t+='<div class="flex flex-col gap-4">',n.answers.forEach(function(u,m){t+=Fd(u,m,n.correctAnswerIndex===m)}),t+="</div>",t+='<div class="mt-4">',t+='<button id="add-answer-btn" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-light-gray dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/60 transition-colors">',t+='<span class="truncate">+ Add Answer Choice</span>',t+="</button></div></div></div>",e.innerHTML=t,document.getElementById("question-text-input").oninput=function(){k[L].questionText=this.value,z()};var s=document.getElementById("question-image-input");s&&(s.onchange=function(){if(this.files&&this.files[0]){var u=this.files[0],m=k[L];m.questionImage="UPLOADING",m.questionImageURL=null,ne(),Os(u).then(function(g){k[L].questionImageFileId=g,k[L].questionImage=null,k[L].questionImageURL=null,z(),ne()}).catch(async function(g){await S("Image upload failed: "+(g.message||g),{title:"Upload image",destructive:!0}),k[L].questionImage=null,k[L].questionImageFileId=null,k[L].questionImageURL=null,ne()})}});var d=e.querySelector(".remove-question-image-btn");d&&(d.onclick=function(){k[L].questionImage=null,k[L].questionImageURL=null,k[L].questionImageFileId=null,z(),ne()});var o=document.getElementById("question-topic-input");o&&(o.oninput=function(){k[L].topicTag=this.value.trim(),k[L].topic=this.value.trim(),z()});var l=document.getElementById("question-metacognition-input");l&&(l.onchange=function(){k[L].metacognitionEnabled=this.checked,z()});var c=document.getElementById("question-difficulty-select");c&&(c.onchange=function(){k[L].difficultyLevel=this.value,z()}),document.getElementById("add-answer-btn").onclick=function(){k[L].answers.push({text:"",image:null,imageURL:null,imageFileId:null}),z(),ne()},e.querySelectorAll(".answer-text-input").forEach(function(u,m){u.oninput=function(){k[L].answers[m].text=this.value,z()}}),e.querySelectorAll(".correct-radio").forEach(function(u,m){u.onchange=function(){this.checked&&(k[L].correctAnswerIndex=m,z())}}),e.querySelectorAll(".delete-answer-btn").forEach(function(u,m){u.onclick=function(){Od(m)}}),e.querySelectorAll(".answer-image-input").forEach(function(u,m){u.onchange=function(){if(this.files&&this.files[0]){var g=this.files[0],p=k[L].answers[m];p.image="UPLOADING",p.imageURL=null,ne(),Os(g).then(function(v){k[L].answers[m].imageFileId=v,k[L].answers[m].image=null,k[L].answers[m].imageURL=null,z(),ne()}).catch(async function(v){await S("Image upload failed: "+(v.message||v),{title:"Upload image",destructive:!0}),k[L].answers[m].image=null,k[L].answers[m].imageFileId=null,k[L].answers[m].imageURL=null,ne()})}}}),e.querySelectorAll(".remove-answer-image-btn").forEach(function(u){u.onclick=function(){var m=parseInt(this.dataset.index,10);k[L].answers[m].image=null,k[L].answers[m].imageURL=null,k[L].answers[m].imageFileId=null,z(),ne()}})}function Fd(e,n,t){var a='<div class="flex items-center gap-3">';a+='<label class="relative flex items-center justify-center cursor-pointer" title="Set as correct answer">',a+='<input class="correct-radio peer h-5 w-5 cursor-pointer appearance-none rounded-full border border-brand-light-gray dark:border-brand-white/30 checked:border-primary checked:bg-primary transition-all" name="correct_answer" type="radio" '+(t?"checked":"")+"/>",a+='<span class="material-symbols-outlined absolute text-brand-white transition-opacity opacity-0 peer-checked:opacity-100 text-sm">check</span>',a+="</label>",a+='<input class="answer-text-input form-input flex-1 rounded-lg text-brand-dark-gray dark:text-brand-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 focus:border-primary placeholder:text-brand-dark-gray/50 dark:placeholder:text-brand-white/50 p-3 text-base" placeholder="Answer '+String.fromCharCode(65+n)+'" type="text" value="'+h(e.text||"")+'"/>',a+='<label class="p-2 rounded-lg hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10 transition-colors cursor-pointer" title="Upload image for this answer">',a+='<span class="material-symbols-outlined text-brand-dark-gray/60 dark:text-brand-white/60">image</span>',a+='<input type="file" class="answer-image-input hidden" accept="image/*">',a+="</label>",k[L].answers.length>2?(a+='<button class="delete-answer-btn p-2 rounded-lg hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10 transition-colors" title="Remove this answer">',a+='<span class="material-symbols-outlined text-brand-dark-gray/60 dark:text-brand-white/60">delete</span>',a+="</button>"):a+='<div class="w-10"></div>',a+="</div>";var r=ri(e.image||e.imageURL,e.imageFileId),i=e.image==="UPLOADING";return(r||i)&&(a+='<div class="mt-2 flex items-center gap-3 bg-primary/5 dark:bg-primary/10 p-2 rounded-lg">',i?(a+='<div class="flex items-center gap-2 text-primary dark:text-brand-white">',a+='<div class="h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent"></div>',a+='<span class="text-xs font-medium">Uploading...</span>',a+="</div>"):r&&(a+='<img src="'+r+'" class="rounded-md max-w-[160px] h-auto" referrerpolicy="no-referrer">',a+='<button type="button" class="remove-answer-image-btn h-8 px-3 rounded-md bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-xs font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors" data-index="'+n+'">Remove</button>'),a+="</div>"),a}async function Od(e){if(k[L].answers.length<=2){await S("A question must have at least two answer choices.",{title:"Edit poll"});return}k[L].answers.splice(e,1),k[L].correctAnswerIndex>=e&&(k[L].correctAnswerIndex=Math.max(0,k[L].correctAnswerIndex-1)),z(),ne()}function Ud(e){return!e||typeof e!="string"?"":"https://drive.google.com/thumbnail?id="+encodeURIComponent(e)+"&sz=w1000"}function ri(e,n){return n&&typeof n=="string"?Ud(n):e instanceof File?URL.createObjectURL(e):typeof e=="string"&&e?e==="UPLOADING"?"":e:""}async function _d(){var e=document.getElementById("save-poll-btn"),n=zt?'<span class="truncate">Save Changes</span>':'<span class="truncate">Publish Poll</span>';e.disabled=!0,e.innerHTML='<div class="h-5 w-5 animate-spin rounded-full border-2 border-primary border-t-transparent"></div><span>Saving...</span>';var t=document.getElementById("new-poll-name").value.trim(),a=(lt.value||"").trim(),r=Ge(st),i=kd();if(i.sessionType=r,!t||!a){await S("Please enter a poll name and select a class.",{title:"Save poll"}),e.disabled=!1,e.innerHTML=n;return}if(pt(r)&&(!i.timeLimitMinutes||i.timeLimitMinutes<=0)){await S("Secure Assessments require a positive time limit.",{title:"Save poll"}),e.disabled=!1,e.innerHTML=n;return}if(k.length===0){await S("Please add at least one question.",{title:"Save poll"}),e.disabled=!1,e.innerHTML=n;return}var s="";if(k.forEach(function(x,C){if(!s){var R=(x.questionText||"").trim();if(R===""){s="Question "+(C+1)+" needs question text.";return}var N=x.answers.map(function(w){return(w.text||"").trim()}),V=N.filter(function(w){return w!==""});if(V.length<2){s="Question "+(C+1)+" must include at least two answer choices with text.";return}var W=typeof x.correctAnswerIndex=="number"?x.correctAnswerIndex:0;if(W<0||W>=N.length){s="Question "+(C+1)+" has an invalid correct answer selection.";return}N[W]===""&&(s="Question "+(C+1)+" must mark a correct answer with text.")}}),s){await S(s,{title:"Save poll"}),e.disabled=!1,e.innerHTML=n;return}var d=!1,o=[];if(k.forEach(function(x,C){x.questionImage==="UPLOADING"&&(d=!0,o.push("Question "+(C+1)+" image is still uploading. Please wait for upload to complete.")),x.answers.forEach(function(R,N){R.image==="UPLOADING"&&(d=!0,o.push("Question "+(C+1)+", answer "+(N+1)+" image is still uploading. Please wait for upload to complete."))})}),d){await S(o.join(`
`),{title:"Save poll"}),e.disabled=!1,e.innerHTML=n;return}var l=k.map(function(x){var C=x.answers.map(function(V){var W=(V.text||"").trim();return{text:W,imageFileId:V.imageFileId||null,imageURL:V.imageURL||null}}),R=typeof x.correctAnswerIndex=="number"?x.correctAnswerIndex:0;R<0&&(R=0),R>=C.length&&(R=Math.max(0,C.length-1));var N=null;return typeof x.timerSeconds=="number"?N=x.timerSeconds:typeof x.timerSeconds=="string"&&x.timerSeconds.trim()!==""&&(N=parseInt(x.timerSeconds,10)),N&&(!isFinite(N)||N<=0)&&(N=null),N&&(N=Math.min(Math.round(N),600)),{questionText:(x.questionText||"").trim(),questionImageFileId:x.questionImageFileId||null,questionImageURL:x.questionImageURL||null,answers:C,correctAnswerIndex:R,timerSeconds:N&&N>0?N:null,metacognitionEnabled:!!x.metacognitionEnabled}});try{var c=l.map(function(x){var C=x.answers.map(function(w){var A=w.imageURL||null,T=w.imageFileId||null;return{text:w.text,image:A,imageURL:A,imageFileId:T}}),R=x.correctAnswerIndex;(R<0||R>=C.length)&&(R=Math.max(0,C.length-1));var N=C[R]?C[R].text:null,V=x.questionImageURL||null,W=x.questionImageFileId||null;return{questionText:x.questionText,questionImage:V,questionImageURL:V,questionImageFileId:W,options:C,correctAnswer:N,timerSeconds:x.timerSeconds||null,metacognitionEnabled:!!x.metacognitionEnabled}});if(!c||c.length===0){await S("âŒ Error: No valid questions to save. Please check your poll data.",{title:"Save poll",destructive:!0}),e.disabled=!1,e.innerHTML=n;return}var u=c.length;console.log("Saving poll with "+u+" questions");var m,g;try{var p={sessionType:r,timeLimitMinutes:i.timeLimitMinutes,accessCode:i.accessCode,availableFrom:i.availableFrom,dueBy:i.dueBy,secureSettings:i.secureSettings},v;if(zt){var y=firebase.functions().httpsCallable("updatePoll");v=await y({pollId:zt,pollName:t,className:a,questions:c,metadata:p})}else{var E=firebase.functions().httpsCallable("createPoll");v=await E({pollName:t,className:a,questions:c,metadata:p})}if(v.data&&v.data.success){yo.invalidate("dashboardData"),await Ca(),Bs("All changes saved"),e.disabled=!1,e.innerHTML=n;var q=zt?"âœ… Poll updated successfully with "+u+" question"+(u===1?"":"s")+"!":"âœ… Poll created successfully with "+u+" question"+(u===1?"":"s")+"!";console.log(q);var B=!zt;Ns(),B&&(Z.value="",St()),await S(q,{title:"Save poll"})}else throw new Error(v.data?.error||"Failed to save poll")}catch(x){console.error("Firebase poll save error:",x),typeof Ut=="function"?Ut(x):await S("âŒ Error saving poll: "+(x.message||x),{title:"Save poll",destructive:!0}),e.disabled=!1,e.innerHTML=n}}catch(x){console.error("Upload/save error:",x),await S("âŒ Upload error: "+(x.message||x),{title:"Save poll",destructive:!0}),e.disabled=!1,e.innerHTML=n}}function Hd(e){return new Promise(function(n,t){if(!e){t(new Error("No file provided"));return}if(!(e instanceof File)){t(new Error("Invalid file object"));return}if(!e.type.startsWith("image/")){t(new Error("File must be an image"));return}if(e.size===0){t(new Error("File is empty"));return}if(e.size>5*1024*1024){t(new Error("File exceeds 5MB limit"));return}var a=new FileReader;a.readAsDataURL(e),a.onload=function(){a.result&&typeof a.result=="string"?n(a.result):t(new Error("Failed to read file data"))},a.onerror=function(r){t(new Error("File read error: "+(r.message||"Unknown error")))}})}function Os(e){return new Promise(function(n,t){if(!e){t(new Error("No file provided for upload"));return}if(!e.name){t(new Error("File has no name"));return}Hd(e).then(function(a){if(!a||typeof a!="string"){t(new Error("Invalid data URL generated from file"));return}var r=0,i=3;function s(){r++;var d=firebase.storage().ref(),o=Date.now(),l=(e.name||"image").replace(/[^a-zA-Z0-9.-]/g,"_"),c="poll-images/uploads/"+o+"-"+l,u=d.child(c);u.putString(a,"data_url").then(function(m){return m.ref.getDownloadURL()}).then(function(m){console.log("[Firebase Storage] Upload success:",m),n(m)}).catch(function(m){console.error("[Firebase Storage] Upload failed:",m);var g=(m.message||"").toString(),p=g.includes("retry")||g.includes("network");p&&r<i?(console.warn("Upload attempt "+r+" failed. Retrying...",m),setTimeout(s,r*2e3)):t(new Error(m.message||"Image upload failed"))})}s()}).catch(function(a){t(new Error("File conversion error: "+(a.message||a)))})})}function tt(e){if(!e)return"â€”";var n=new Date(e);return isNaN(n.getTime())?e:n.toLocaleString()}function mn(e,n){var t=document.getElementById(e);t&&(typeof n=="string"&&n.includes("<")&&n.includes(">")?(t.innerHTML=sr(n),or()):t.textContent=n||"")}function Us(e,n){var t=document.getElementById(e);t&&(t.innerHTML=sr(n),or())}var X,xe,ii=!1,si=0,oi=0,_s="#059669",Wa=4,li="pen";function zd(){var e=document.getElementById("lcb-whiteboard-toggle");e&&e.addEventListener("click",Hs);var n=document.getElementById("wb-close-btn");n&&n.addEventListener("click",Hs);var t=document.getElementById("wb-clear-btn");if(t&&t.addEventListener("click",Vd),X=document.getElementById("wb-canvas"),!!X){xe=X.getContext("2d"),window.addEventListener("resize",zs),X.addEventListener("mousedown",jd),X.addEventListener("mousemove",Qd),X.addEventListener("mouseup",Vs),X.addEventListener("mouseout",Vs),X.addEventListener("touchstart",function(r){var i=r.touches[0],s=new MouseEvent("mousedown",{clientX:i.clientX,clientY:i.clientY});X.dispatchEvent(s)},!1),X.addEventListener("touchmove",function(r){var i=r.touches[0],s=new MouseEvent("mousemove",{clientX:i.clientX,clientY:i.clientY});X.dispatchEvent(s)},!1),X.addEventListener("touchend",function(r){var i=new MouseEvent("mouseup",{});X.dispatchEvent(i)},!1);var a=document.querySelectorAll(".wb-tool");a.forEach(function(r){r.addEventListener("click",function(){a.forEach(function(s){s.classList.remove("active","scale-110","ring-2","ring-offset-2","ring-indigo-500")}),r.classList.add("active","scale-110","ring-2","ring-offset-2","ring-indigo-500");var i=r.dataset.mode;i==="eraser"?(li="eraser",Wa=20):(li="pen",_s=r.dataset.color,Wa=parseInt(r.dataset.size)||4)})})}}function Hs(){var e=document.getElementById("whiteboard-overlay");if(e){var n=e.classList.contains("hidden");n?(e.classList.remove("hidden"),zs()):e.classList.add("hidden")}}function zs(){if(X){var e=X.parentElement;e&&(X.width=e.clientWidth,X.height=e.clientHeight)}}function Vd(){!X||!xe||xe.clearRect(0,0,X.width,X.height)}function jd(e){ii=!0;var n=X.getBoundingClientRect();si=e.clientX-n.left,oi=e.clientY-n.top}function Qd(e){if(ii){var n=X.getBoundingClientRect(),t=e.clientX-n.left,a=e.clientY-n.top;xe.beginPath(),xe.moveTo(si,oi),xe.lineTo(t,a),xe.lineCap="round",xe.lineJoin="round",li==="eraser"?(xe.globalCompositeOperation="destination-out",xe.lineWidth=Wa):(xe.globalCompositeOperation="source-over",xe.strokeStyle=_s,xe.lineWidth=Wa),xe.stroke(),si=t,oi=a}}function Vs(){ii=!1}function Ue(e){if(!e)return"";if(typeof e=="string"){var n=e.trim();if(!n)return"";var t=n.split(/\s+/).filter(Boolean);return t.length>=2?t[0]+" "+t[t.length-1]:t[0]||""}var a=(e.firstName||"").trim(),r=(e.lastName||"").trim();return a||r?(a+" "+r).trim():e.displayName?Ue(e.displayName):e.name?Ue(e.name):e.email?e.email:""}async function F(e){ht.style.display="none",console.error("Error:",e);var n=(e&&e.message?e.message:e)||"Unknown error",t=String(n);typeof n=="string"&&n.indexOf("Error: ")===0&&(n=n.substring(7)),(t.includes("NetworkError")||t.includes("HTTP 0")||t.includes("Connection failure"))&&(n="Network connection interrupted. Please check your internet connection and try again."),await S(n,{title:"Something went wrong",destructive:!0})}window.expandQuestionImage=function(){var e=document.getElementById("live-question-image").src,n='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;" onclick="this.remove()">';n+='<img src="'+e+'" style="max-width:90%;max-height:90%;"/>',n+="</div>",document.body.insertAdjacentHTML("beforeend",n)};var js=document.getElementById("view-analytics-btn");js&&js.addEventListener("click",function(){kn&&yl(kn)});var Qs=document.getElementById("close-analytics-modal-btn");Qs&&Qs.addEventListener("click",function(){document.getElementById("post-poll-analytics-modal").style.display="none"}),document.getElementById("post-poll-analytics-modal").addEventListener("click",function(e){e.target===this&&(this.style.display="none")});var Ws=document.getElementById("filter-locked-only-btn");Ws&&Ws.addEventListener("click",function(){Bt="locked";var e=document.getElementById("student-status-filter-select");e&&(e.value="locked"),ga(),ve()});var Ks=document.getElementById("filter-all-btn");Ks&&Ks.addEventListener("click",function(){Bt="all";var e=document.getElementById("student-status-filter-select");e&&(e.value="all"),ga(),ve()}),ga();var Gs=document.getElementById("dismiss-violations-alert");Gs&&Gs.addEventListener("click",function(){document.getElementById("violations-alert-panel").classList.add("hidden")});var $s=document.getElementById("approve-all-unlocks-btn");$s&&$s.addEventListener("click",Wl);var Ys=document.getElementById("toggle-exited-panel-btn");Ys&&Ys.addEventListener("click",function(){var e=document.getElementById("exited-students-list-inline");if(e){var n=this.querySelector(".material-symbols-outlined");e.style.display==="none"?(e.style.display="",n&&(n.textContent="expand_more")):(e.style.display="none",n&&(n.textContent="expand_less"))}});var Gn=document.getElementById("add-30s-btn-preset");Gn&&Gn.addEventListener("click",function(){ie||Ke(30)});var $n=document.getElementById("add-60s-btn-preset");$n&&$n.addEventListener("click",function(){ie||Ke(60)});var Wn=document.getElementById("view-cards-btn"),Kn=document.getElementById("view-table-btn");if(Wn&&Kn&&Ae&&rr){Wn.classList.add("active"),Wn.addEventListener("click",function(){Ae.classList.remove("hidden"),rr.classList.add("hidden"),Wn.classList.add("active"),Kn.classList.remove("active"),localStorage.setItem("vlp_poll_view","cards")}),Kn.addEventListener("click",function(){Ae.classList.add("hidden"),rr.classList.remove("hidden"),Kn.classList.add("active"),Wn.classList.remove("active"),localStorage.setItem("vlp_poll_view","table")});var Wd=localStorage.getItem("vlp_poll_view");Wd==="table"&&Kn.click()}document.addEventListener("keydown",function(e){if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||e.target.isContentEditable)&&ze)switch(e.key){case"ArrowRight":case"n":case"N":e.preventDefault();var n=document.getElementById("header-next-btn");n&&!n.disabled&&n.offsetParent!==null&&n.click();break;case"ArrowLeft":case"b":case"B":e.preventDefault();var t=document.getElementById("header-back-btn");t&&!t.disabled&&t.offsetParent!==null&&t.click();break;case" ":case"Spacebar":e.preventDefault(),ie?dn():D>0&&Oa();break;case"r":case"R":e.preventDefault(),ie||vs();break;case"e":case"E":e.preventDefault();var a=document.getElementById("header-end-show-btn");a&&!a.disabled&&a.offsetParent!==null&&a.click();break}}),window.checkAllRespondedState=function(e){if(ze){var n=document.getElementById("header-next-btn");if(n){var t=f.questionIndex>=f.totalQuestions-1;e&&!t?n.classList.add("pulse-ready"):n.classList.remove("pulse-ready")}}};var Gn=document.getElementById("add-30s-btn-preset");Gn&&Gn.addEventListener("click",function(){ie||Ke(30)});var $n=document.getElementById("add-60s-btn-preset");$n&&$n.addEventListener("click",function(){ie||Ke(60)}),window.onStartPoll=Hr,window.onSendLink=Kr,window.onViewLinks=Ua,window.initializeDashboardBindings=Xi,window.onPollSelectChange=St,console.log("âœ“ Teacher Panel Ready (Enhanced UI)"),(function(){var n={firebasePresent:typeof firebase<"u",configPresent:typeof FIREBASE_CONFIG<"u"&&!!FIREBASE_CONFIG,databaseURL:typeof FIREBASE_CONFIG<"u"&&FIREBASE_CONFIG?FIREBASE_CONFIG.databaseURL:null,appsLengthBefore:typeof firebase<"u"&&firebase.apps?firebase.apps.length:"n/a",initCalled:!1,success:!1};if(typeof firebase<"u"&&FIREBASE_CONFIG){if(firebase.apps.length)n.success=!0;else try{n.initCalled=!0,n.success=!0}catch(t){console.error("[Firebase] Failed to initialize app:",t),n.error=t.message}firebase.apps.length>0&&(it=firebase.database(),firebase.functions&&(da=firebase.functions())),n.appsLengthAfter=firebase.apps.length}else typeof firebase>"u"&&console.error("[Firebase] SDK not loaded! Check script tags in Teacher_View.html"),FIREBASE_CONFIG||console.error("[Firebase] FIREBASE_CONFIG not available!");console.log("[Firebase Init] databaseURL="+n.databaseURL+", firebasePresent="+n.firebasePresent+", appsLength="+n.appsLengthAfter+", initCalled="+n.initCalled+", success="+n.success)})();async function Kd(e,n){if(!(!e||!n)){var t=f&&f.questions&&typeof n.questionIndex=="number"?f.questions[n.questionIndex]:null,a=n.questionText||(t?t.questionText:"")||"Question "+((n.questionIndex||0)+1),r=n.options||(t?t.options:[]);if(firebase&&firebase.functions)try{var i=firebase.functions().httpsCallable("setLiveSessionState");console.log("[Firebase] Calling Cloud Function: setLiveSessionState...");var s=n.correctAnswer||(t?t.correctAnswer:null),d=await i({pollId:e,status:n.status||"OPEN",questionIndex:n.questionIndex,questionText:a,correctAnswer:s,options:r});console.log("[Firebase] Cloud Function Success:",d.data);return}catch(u){console.warn("[Firebase] Cloud Function failed userspace, falling back to legacy RTDB write:",u)}if(it){var o="sessions/"+e+"/live_session",l=it.ref(o),c={pollId:e,questionIndex:n.questionIndex,status:n.status||"OPEN",timestamp:firebase.database.ServerValue.TIMESTAMP,sessionPhase:n.sessionPhase||"LIVE",resultsVisibility:n.resultsVisibility||"HIDDEN",questionText:a,questionImageURL:n.questionImageURL||(t?t.questionImageURL:""),options:r,metadata:{sessionPhase:n.sessionPhase||"LIVE",resultsVisibility:n.resultsVisibility||"HIDDEN",isCollecting:n.status==="OPEN"}};l.set(c).catch(function(u){console.warn("[Firebase] Broadcast to live_session failed:",u)})}}}var Yn=null;function Xn(e){if(!(!FIREBASE_CONFIG||!e)){if(Le&&O!==e&&(console.log("[Firebase] Cleaning up listeners for previous pollId:",O),Le.off(),Le=null,gn&&(gn.off(),gn=null),Yn&&(Yn.off(),Yn=null)),Le&&O===e){console.log("[Firebase] Already subscribed to pollId:",e);return}if(typeof firebase<"u"&&!firebase.apps.length&&console.warn("[Firebase] Late init triggered in initFirebaseMissionControl - this should be rare."),typeof firebase<"u"){it=firebase.database();var n="sessions/"+e+"/students";Le=it.ref(n),O=e,di=Le.toString(),Yn=it.ref(".info/connected"),Yn.on("value",function(a){Me=a.val()===!0,console.log("[Firebase] Connection status changed:",Me?"CONNECTED":"DISCONNECTED","pollId:",e),ho(Me);var r=Me?3e4:2500;He&&He.isRunning()&&(console.log("[Adaptive Polling] Updating Mission Control heartbeat to "+r+"ms"),He.updateInterval(r)),de?(console.log("[Adaptive Polling] Updating Live Poll interval to "+r+"ms"),clearInterval(de),ca=r,de=setInterval(Tt,ca)):ca=r,Me&&(console.log("[Connectivity Recovery] Teacher reconnected - syncing state"),typeof Tt=="function"&&ze&&setTimeout(Tt,500)),Pt={timestamp:Date.now(),type:"connection"},Xs(),Jn()}),Le.on("child_changed",async function(a){var r=a.key,i=a.val(),s=typeof i=="object"&&i?i.status||"ACTIVE":i,d=Ve[r];if(fn={studentKey:r,status:s,timestamp:Date.now()},Pt={timestamp:Date.now(),type:"child_changed"},console.log("[Firebase] Student status changed:",r.substring(0,8)+"...",d,"â†’",s),(s==="LOCKED"||typeof s=="object"&&s.status==="LOCKED")&&d!=="LOCKED"){var o="Student";if(J)for(var l=0;l<J.length;l++){var c=await window.VeritasShared.generateStudentKey(J[l].email,O);if(c===r){o=J[l].name||J[l].email;break}}Lo("error","lock",o+" was locked out (violation detected).")}if(s==="ACTIVE"&&d&&d!=="ACTIVE"){var u=null;if(J&&O)for(var l=0;l<J.length;l++){var m=J[l],g=await window.VeritasShared.generateStudentKey(m.email,O);if(g===r){u=m.name||m.email;break}}if(!u&&H&&f&&f.pollId)for(var p=0;p<H.length;p++){var v=H[p],y=await window.VeritasShared.generateStudentKey(v.email,f.pollId);if(y===r){u=v.name||v.email;break}}P("info","Student Resumed",(u||"A student")+" has re-entered the session.",3e3)}}),Le.on("child_added",function(a){Pt={timestamp:Date.now(),type:"child_added"};var r=a.key,i=a.val(),s=r.replace(/,/g,".");J||(J=[]);var d=J.some(function(l){return l.email===s});if(!d){console.log("[Firebase] New student detected via Fast Path:",s);var o={name:s,email:s,status:i,proctorStatus:i==="ACTIVE"?"ACTIVE":"LOCKED",progress:0,score:0};J.push(o),J.sort(function(l,c){return(l.name||"").localeCompare(c.name||"")}),ui({students:J}),Ka()}}),Le.on("value",function(a){Ve=a.val()||{},console.log("[Firebase] Status update received for pollId:",e,"Students:",Object.keys(Ve).length),Pt={timestamp:Date.now(),type:"value"},Ka(),Jn()}),gn=it.ref("sessions/"+e+"/violations"),gn.on("child_added",function(a){var r=a.key,i=a.val();i&&i.reason&&(Ft={studentKey:r,reason:i.reason,timestamp:Date.now()},console.log("[Firebase] Violation detected:",r.substring(0,8)+"...","-",i.reason),Jn())}),gn.on("child_changed",function(a){var r=a.key,i=a.val();i&&i.reason&&(Ft={studentKey:r,reason:i.reason,timestamp:Date.now()},console.log("[Firebase] Violation updated:",r.substring(0,8)+"...","-",i.reason),Jn())});var t=it.ref("answers/"+e);t.on("child_added",function(a){var r=a.val();r&&r.questionIndex!==void 0&&Gd(r)}),console.log("[Firebase] Mission Control initialized for",n,"Connected:",Me),console.log("[Firebase] Actual subscription:",di)}}}function Gd(e){if(!(!f||f.pollId!==e.pollId)){var n=H.find(function(o){return o.email===e.studentEmail});if(n){var t=Math.max(n.progress||0,(e.questionIndex||0)+1);n.progress=t,n.status="Submitted",n.timeOnQuestionMs=e.timeOnQuestionMs,n.usingCalculator=e.usingCalculator,n.confidence=e.confidenceLevel,n.lastAnswerTimestamp=e.clientTimestamp,e.questionIndex===f.questionIndex?n.status="Submitted":n.status="In Progress";var a=document.querySelector('.student-status-card[data-email="'+CSS.escape(n.email)+'"]');if(a){var r=a.querySelector(".progress-bar-fill"),i=a.querySelector(".progress-text"),s=a.querySelector(".status-badge");if(r&&n.totalQuestions>0){var d=Math.min(100,Math.round(t/n.totalQuestions*100));r.style.width=d+"%",r.classList.remove("pulse-once"),r.offsetWidth,r.classList.add("pulse-once")}i&&(i.textContent=t+"/"+n.totalQuestions),s&&(s.textContent="In Progress",s.className="status-badge bg-emerald-100 text-emerald-800")}console.log("[Firebase] Realtime Answer processed for:",e.studentEmail)}}}function Xs(){var e=document.getElementById("realtime-indicator");if(!e){var n=document.getElementById("individual-session-meta");if(n){var t=document.createElement("span");t.id="realtime-indicator",t.className="ml-4 inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-bold",n.appendChild(t)}}var a=document.getElementById("realtime-indicator");a&&(Me?(a.className="ml-4 inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700 border border-green-200",a.innerHTML='<span class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></span> Realtime Active'):typeof window.USING_FALLBACK_CONFIG<"u"&&window.USING_FALLBACK_CONFIG?(a.className="ml-4 inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700 border border-red-200 cursor-pointer hover:bg-red-200",a.innerHTML='<span class="material-symbols-outlined text-sm">warning</span> Setup Required',a.title="Firebase Config Missing. Click for instructions.",a.onclick=function(){alert(`ACTION REQUIRED:

The app is not connected to a backend because FIREBASE_CONFIG is missing.

Please refer to the SETUP_GUIDE.md to configure your Script Properties.`)}):(a.className="ml-4 inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700 border border-red-200",a.innerHTML='<span class="h-2 w-2 rounded-full bg-red-500"></span> Realtime OFF (Polling mode)'))}function Js(e){if(!e)return!1;var n=Date.now(),t=typeof e=="number"?e:new Date(e).getTime(),a=3e4;return n-t>a}async function Ka(){var e=!1;if(J&&O&&(await Promise.all(J.map(async function(t){var a=await window.VeritasShared.generateStudentKey(t.email,O),r=Ve[a];if(r){var i=t.status,s=t.connection?t.connection.status:"GRAY",d=typeof r=="object"&&r?r.status:r,o=typeof r=="object"&&r?r.lastActive||r.lastActiveAt:null,l=Js(o);d==="ACTIVE"?(t.status!=="Submitted"&&(i=l?"Idle":"In Progress"),s=l?"YELLOW":"GREEN"):d==="Submitted"?(i="Submitted",s="GREEN"):d==="LOCKED"?(i="LOCKED",t.proctorStatus="LOCKED",s="GREEN"):d==="DISCONNECTED"?(s="RED",i="Offline"):d==="FINISHED"&&(i="Submitted",s="GREEN"),t.isIdle=l,t.lastActive=o,(t.status!==i||t.connection&&t.connection.status!==s)&&(t.status=i,t.connection||(t.connection={}),t.connection.status=s,e=!0)}})),e&&ui({students:J})),H&&H.length>0&&f&&f.pollId){var n=!1;await Promise.all(H.map(async function(t){var a=await window.VeritasShared.generateStudentKey(t.email,f.pollId),r=Ve[a];if(r){var i=t.status,s=typeof r=="object"&&r?r.status:r,d=typeof r=="object"&&r?r.lastActive||r.lastActiveAt:null,o=Js(d);s==="ACTIVE"?t.status!=="Submitted"&&(i=o?"Idle":"In Progress"):s==="Submitted"?i="Submitted":s==="LOCKED"?(i="LOCKED",t.proctorStatus="LOCKED"):s==="DISCONNECTED"?i="Offline":s==="FINISHED"&&(i="Submitted"),t.isIdle=o,t.lastActive=d,t.status!==i&&(t.status=i,n=!0)}})),n&&ve()}}async function $d(e,n){var t=O||f&&f.pollId;if(!(!Le||!e||!t)){var a=await window.VeritasShared.generateStudentKey(e,t);Le.child(a).set(n)}}var Ga={action:"None",timestamp:null},Pt={timestamp:null,type:"None"},fn={studentKey:null,status:null,timestamp:null},Ft={studentKey:null,reason:null,timestamp:null},di=null,gn=null;function Jn(){if(Veritas.Config.DEBUG_FIREBASE){var e=document.getElementById("firebase-debug-hud");e||(e=document.createElement("div"),e.id="firebase-debug-hud",e.style.cssText="position:fixed;bottom:10px;right:10px;background:rgba(0,0,0,0.95);color:#4ade80;font-family:monospace;font-size:11px;padding:12px;z-index:9999;pointer-events:none;max-width:380px;border:2px solid #4ade80;border-radius:8px;line-height:1.4;",document.body.appendChild(e));var n=Me?'<span style="color:#4ade80">â—</span>':'<span style="color:#f87171">â—</span>',t='<strong style="color:#fff">ðŸ”¥ FIREBASE DEBUG (TEACHER)</strong><br>';t+=n+" <strong>.info/connected:</strong> "+Me+"<br>",t+="<strong>PollId (sessionKey):</strong> "+(O||"None")+"<br>",t+="<strong>Actual RTDB Path:</strong> "+(di||"Not subscribed")+"<br>",t+="<strong>Students observed:</strong> "+Object.keys(Ve).length+"<br>";var a=Object.keys(Ve);if(a.length>0&&(t+="<strong>Sample statuses:</strong><br>",a.slice(0,2).forEach(function(o){var l=Ve[o]==="LOCKED"?"#f87171":Ve[o]==="ACTIVE"?"#4ade80":"#facc15";t+="  â€¢ "+o.substring(0,8)+'...: <span style="color:'+l+'">'+Ve[o]+"</span><br>"})),Pt.timestamp){var r=Math.round((Date.now()-Pt.timestamp)/1e3);t+="<strong>Last RTDB event:</strong> "+Pt.type+" ("+r+"s ago)<br>"}if(fn.timestamp&&fn.studentKey){var i=Math.round((Date.now()-fn.timestamp)/1e3);t+="<strong>Last change:</strong> "+fn.studentKey.substring(0,8)+"... â†’ "+fn.status+" ("+i+"s ago)<br>"}if(Ft.timestamp&&Ft.studentKey){var s=Math.round((Date.now()-Ft.timestamp)/1e3);t+='<strong style="color:#f87171">Last violation:</strong> '+Ft.studentKey.substring(0,8)+"... - "+Ft.reason+" ("+s+"s ago)<br>"}if(Ga.timestamp){var d=Math.round((Date.now()-Ga.timestamp)/1e3);t+="<strong>Last action:</strong> "+Ga.action+" ("+d+"s ago)<br>"}e.innerHTML=t}}function ci(e){Ga={action:e,timestamp:Date.now()},Jn()}function Zs(e){if(e){Pe("individual-timed"),O=e.pollId,Ne=e.sessionId,f.pollId=e.pollId,f.sessionId=e.sessionId,f.pollName=e.pollName,f.className=e.className,f.timeLimitMinutes=e.timeLimitMinutes||0,f.questionCount=e.totalQuestions||e.questionCount||0;var n=document.getElementById("individual-session-poll-name");n&&(n.textContent=e.pollName+" â€“ "+(e.className||""));var t=document.getElementById("individual-session-meta");if(t){var a=e.timeLimitMinutes?e.timeLimitMinutes+" min limit":"Untimed";t.textContent=a+" â€¢ "+(e.students?e.students.length:0)+" learners"}Xn(e.pollId),Me&&Xs(),ui(e),ea(),He.stop(),He.start(!0)}}window.showIndividualTimedView=Zs;function ui(e){var n=document.getElementById("individual-session-students-grid");if(n){var t=e&&e.students?e.students:[];if(J=t.slice(),n.innerHTML="",t.forEach(function(r){var i=r.proctorStatus==="LOCKED"||r.status==="Locked"||r.status&&r.status.indexOf("Locked")===0;i?oa.has(r.email)||(P("error","Security Violation",r.name+" has been locked."),oa.add(r.email)):oa.has(r.email)&&oa.delete(r.email)}),t.length===0){var a=document.createElement("div");a.className="col-span-full text-center py-10 text-slate-500",a.textContent="Students will appear here as they join the assessment.",n.appendChild(a)}else Yd(t),t.forEach(function(r){var i="bg-slate-100 text-slate-700",s=(r.status||"").toString().toLowerCase();s.indexOf("in progress")===0?i="bg-emerald-50 text-emerald-700":s.indexOf("locked")===0||s.indexOf("blocked")===0?i="bg-red-50 text-red-700":r.status==="Awaiting Fullscreen"?i="bg-blue-50 text-blue-700":r.status==="Paused"?i="bg-amber-50 text-amber-700":r.status==="Submitted"&&(i="bg-slate-200 text-slate-700");var d="bg-slate-300",o="No data",l=r.connection?r.connection.status:"GRAY";l==="GREEN"?(d="bg-emerald-400",o="Synced"):l==="YELLOW"?(d="bg-amber-400",o="Reconnecting"):l==="RED"&&(d="bg-red-500",o="Offline");var c=r.timeRemainingSeconds!=null?ut(r.timeRemainingSeconds):"--:--",u=r.progressPct!=null?r.progressPct:0,m=`Q ${r.progress||0} / ${r.totalQuestions||0}`,g=r.status==="Not Started",p=ee.has(r.email),v=r.progress||0,y=typeof r.correctCount=="number"?r.correctCount:null,E=r.totalQuestions||0,q=v>0&&y!==null?`${y} correct`:v>0?"Responses recorded":"Awaiting responses",B=typeof r.scorePct=="number"&&E>0&&v>0?`${Math.round(r.scorePct)}% of exam`:"",x="bg-emerald-500";s.indexOf("locked")===0||s.indexOf("blocked")===0?x="bg-red-500":r.status==="Paused"&&(x="bg-amber-500");var C=r.proctorStatus==="LOCKED"||r.proctorStatus==="BLOCKED"||s.indexOf("locked")===0||s.indexOf("blocked")===0,R=document.createElement("div"),N="mission-student-card rounded-2xl border border-slate-200 dark:border-brand-dark-gray/60 bg-white dark:bg-brand-dark-gray/30 p-4 shadow-sm flex flex-col gap-3 transition-all";p&&(N+=" ring-2 ring-amber-400 ring-opacity-70 shadow-lg"),R.className=N,R.dataset.email=r.email,R.innerHTML=`
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-base font-semibold text-brand-dark-gray dark:text-white">${h(r.name)}</p>
              <div class="flex items-center gap-2 flex-wrap mt-1">
                <span class="inline-flex px-2.5 py-1 text-xs font-semibold rounded-full ${i}">${r.status}</span>
                ${Zl(r.telemetry)}
              </div>
            </div>
            <div class="flex items-center gap-3 text-xs text-slate-500">
              <button type="button" class="mission-select-btn rounded-full border border-slate-300 dark:border-slate-600 p-1.5 text-slate-500 hover:text-veritas-navy" data-action="toggle-select" data-email="${r.email}" aria-pressed="${p?"true":"false"}" title="Select student">
                <span class="material-symbols-outlined text-base" data-role="selection-icon">${p?"check_circle":"radio_button_unchecked"}</span>
              </button>
              <div class="flex items-center gap-1.5">
                <span class="h-2.5 w-2.5 rounded-full ${d}"></span>
                <span>${o}</span>
              </div>
            </div>
          </div>
          <div>
            <div class="flex items-center justify-between text-xs text-slate-500 mb-1">
              <span>${m}</span>
              <span>Remaining ${c}</span>
            </div>
            <div class="w-full h-2 rounded-full bg-slate-100 dark:bg-slate-800">
              <div class="h-2 rounded-full ${x}" style="width: ${u}%"></div>
            </div>
            <div class="flex items-center justify-between text-xs text-slate-600 mt-2">
              <span class="font-semibold">${q}</span>
              <span>${B}</span>
            </div>
          </div>
          <div class="flex flex-col gap-2 pt-1">
            <button class="mission-manage-btn inline-flex items-center justify-center gap-2 rounded-full border border-slate-300 dark:border-slate-600 px-4 py-2 text-sm font-semibold text-brand-dark-gray dark:text-white hover:bg-slate-50 disabled:opacity-60" data-action="manage-student" data-email="${r.email}" ${g?"disabled":""}>
              <span class="material-symbols-outlined text-base">tune</span>
              Manage
            </button>
            ${C?`<button type="button" class="inline-flex items-center justify-center gap-2 rounded-full border border-blue-200 text-blue-700 bg-blue-50 px-4 py-2 text-xs font-semibold hover:bg-blue-100" data-action="unlock-student" data-email="${r.email}" data-lock-version="${r.lockVersion||0}">
              <span class="material-symbols-outlined text-base">lock_open_right</span>
              <span>Approve re-entry</span>
            </button>`:""}
          </div>
        `,n.appendChild(R)});tc(e&&e.summary?e.summary:{}),nc(),Xd(),Jd(),rc(),mi(),Zn()}}function Yd(e){if(ee.size){var n=new Set(e.map(function(t){return t.email}));Array.from(ee).forEach(function(t){n.has(t)||ee.delete(t)})}}function Xd(){var e=document.querySelectorAll('#individual-session-students-grid [data-action="toggle-select"]');e.forEach(function(n){n.addEventListener("click",function(t){t.preventDefault(),t.stopPropagation(),Zd(n.dataset.email)})})}function Jd(){var e=document.querySelectorAll('#individual-session-students-grid [data-action="unlock-student"]');e.forEach(function(n){n.addEventListener("click",function(t){if(t.preventDefault(),t.stopPropagation(),!!O){var a=n.dataset.email,r=Number(n.dataset.lockVersion||0);gs(a,O,r,n)}})})}function Zd(e){e&&(ee.has(e)?ee.delete(e):ee.add(e),mi(),Zn())}function ec(){ee.size&&(ee.clear(),mi(),Zn())}function mi(){var e=document.querySelectorAll("#individual-session-students-grid .mission-student-card");e.forEach(function(n){var t=n.dataset.email,a=t&&ee.has(t);n.classList.toggle("ring-2",!!a),n.classList.toggle("ring-amber-400",!!a),n.classList.toggle("ring-opacity-70",!!a),n.classList.toggle("shadow-lg",!!a);var r=n.querySelector('[data-role="selection-icon"]');r&&(r.textContent=a?"check_circle":"radio_button_unchecked");var i=n.querySelector('[data-action="toggle-select"]');i&&i.setAttribute("aria-pressed",a?"true":"false")})}function Zn(){if(zi&&(zi.textContent=ee.size),Ea&&Ea.classList.toggle("hidden",ee.size===0),!ir&&Tn&&(Tn.textContent=ee.size>0?"Add to selected ("+ee.size+")":"Add to selected"),!ir&&dt){var e=ee.size===0||!O||!Ne;dt.disabled=e,dt.classList.toggle("opacity-60",e)}}function $a(e,n){if(ir=!!e,en){en.disabled=!!e,en.classList.toggle("opacity-60",!!e);var t=en.querySelector("span:last-child");t&&(t.textContent=e&&n==="ALL"?"Adding...":"Add to entire class")}if(dt){var a=e||ee.size===0||!O||!Ne;dt.disabled=a,dt.classList.toggle("opacity-60",a),Tn&&(e&&n==="SELECTED"?Tn.textContent="Adding...":e||(Tn.textContent=ee.size>0?"Add to selected ("+ee.size+")":"Add to selected"))}e||Zn()}async function eo(e){if(!O||!Ne){await S("Launch a secure assessment before extending time.",{title:"Extend time"});return}if(e==="SELECTED"&&ee.size===0){await S("Select at least one student first.",{title:"Extend time"});return}if(!Ir)return;var n=parseFloat(Ir.value);if(isNaN(n)||n<=0){await S("Enter a positive number of minutes to add.",{title:"Extend time"}),Ir.focus();return}$a(!0,e);var t=[];e==="ALL"?firebase.database().ref("sessions/"+O+"/students").once("value").then(function(r){var i=r.val()||{};t=Object.keys(i).map(function(s){return i[s].email}),a(t,n)}):(t=Array.from(ee),a(t,n));function a(r,i){if(!r||r.length===0){$a(!1,e);return}var s=r.map(function(d){var o=typeof generateStudentKey=="function"?generateStudentKey(d):d.replace(/[.$#[\]]/g,"_");return firebase.database().ref("sessions/"+O+"/students/"+o+"/timeAdjustment").transaction(function(l){return(l||0)+i})});Promise.all(s).then(function(){$a(!1,e);var d=e==="ALL"?"the entire class":r.length+" student(s)";P("success","Time extended","Added "+i+" minute(s) for "+d+".",4e3),ea()}).catch(function(d){$a(!1,e),F(d)})}}function ea(){if(!(!O||!Ne)&&Ot>0){var e=Ot-1e3;if(e<=0)Ot=0;else{Ot=e,console.log("Mission control polling backing off:",e+"ms remaining");return}}}function tc(e){var n=document.getElementById("summary-not-started"),t=document.getElementById("summary-in-progress"),a=document.getElementById("summary-locked"),r=document.getElementById("summary-completed");n&&(n.textContent=e.notStarted||0),t&&(t.textContent=e.inProgress||0);var i=(e.locked||0)+(e.paused||0);a&&(a.textContent=i),r&&(r.textContent=e.completed||0)}function nc(){var e=document.querySelectorAll('.mission-manage-btn, [data-action="manage-student"]');e.forEach(function(n){n.addEventListener("click",function(){var t=n.dataset.email,a=J.find(function(r){return r.email===t});a&&ac(a)})})}function ac(e){!Zt||!e||($=e,no(e),Zt.classList.remove("hidden"))}function to(){Zt&&(Zt.classList.add("hidden"),$=null,ta(!1))}function rc(){if(!(!$||!J.length||!Zt||Zt.classList.contains("hidden"))){var e=J.find(function(n){return n.email===$.email});e&&($=e,no(e))}}function no(e){if(e){if(Ri&&(Ri.textContent=e.name),Di&&(Di.textContent=e.status),Pi){var n=e.progress||0,t="Q "+n+" / "+(e.totalQuestions||0);typeof e.correctCount=="number"&&n>0&&(t+=" â€¢ "+e.correctCount+" correct"),Pi.textContent=t}if(Fi&&(Fi.textContent=e.timeRemainingSeconds!=null?ut(e.timeRemainingSeconds):"--:--"),Oi){var a=e.timeAdjustmentMinutes||0;Oi.textContent=(a>=0?"+":"")+a+"m"}if(Ui){var r="No signal",i=e.connection?e.connection.status:"";i==="GREEN"?r="Synced":i==="YELLOW"?r="Reconnecting":i==="RED"&&(r="Offline"),Ui.textContent=r}if(hr){hr.classList.remove("bg-emerald-400","bg-amber-400","bg-red-500","bg-slate-300");var s="bg-slate-300",d=e.connection?e.connection.status:"";d==="GREEN"?s="bg-emerald-400":d==="YELLOW"?s="bg-amber-400":d==="RED"&&(s="bg-red-500"),hr.classList.add(s)}if(xr&&(e.lastHeartbeatMs?xr.textContent="Last heartbeat "+zr(new Date(e.lastHeartbeatMs))+".":xr.textContent=""),Bn&&(Bn.innerHTML='<span class="material-symbols-outlined text-base">'+(e.pauseActive?"play_arrow":"pause_circle")+"</span><span>"+(e.pauseActive?" Resume Timer":" Pause Timer")+"</span>"),Lt){var o=e.proctorStatus==="LOCKED"||e.isLocked;Lt.disabled=!o,Lt.classList.toggle("opacity-60",!o)}}}function ta(e){_i&&_i.classList.toggle("hidden",!e),[Er,wr,Bn,Lt,kr].forEach(function(n){n&&(n.disabled=!!e)})}var pn=null;function ic(){var e=document.getElementById("book-view-modal"),n=document.getElementById("book-view-loading"),t=document.getElementById("book-view-content"),a=document.getElementById("book-view-error");if(!(!e||!O)){e.classList.remove("hidden"),n.classList.remove("hidden"),t.classList.add("hidden"),a.classList.add("hidden");var r=da.httpsCallable("getAnalytics");r({pollId:O}).then(function(i){var s=i.data||i,d={success:!0,summary:{className:s.className||"Unknown Class",pollName:s.pollName||"Unknown Poll",date:new Date().toLocaleDateString(),averageScore:0},students:[],questions:[]};s.itemAnalysis&&Object.keys(s.itemAnalysis).forEach(function(o){var l=s.itemAnalysis[o];d.questions.push({index:o,text:"Question "+(parseInt(o)+1),difficulty:l.difficultyIndex,discrimination:l.discriminationIndex,correctCount:l.correctCount,totalCount:l.totalResponseCount})}),pn=d,lc(d),n.classList.add("hidden"),t.classList.remove("hidden")}).catch(function(i){oc("Error loading analytics: "+(i.message||"Unknown error"))})}}function sc(){var e=document.getElementById("book-view-modal");e&&e.classList.add("hidden"),pn=null}window.closeBookView=sc;function oc(e){var n=document.getElementById("book-view-loading"),t=document.getElementById("book-view-content"),a=document.getElementById("book-view-error"),r=document.getElementById("book-view-error-message");n.classList.add("hidden"),t.classList.add("hidden"),a.classList.remove("hidden"),r&&(r.textContent=e)}var pn=null;function lc(e){pn=e;var n=document.getElementById("book-view-title"),t=document.getElementById("book-view-subtitle");n&&(n.textContent=e.pollName+" - Book View"),t&&(t.textContent=e.className+" â€¢ "+e.questionCount+" questions â€¢ "+e.studentDetails.length+" students");var a=document.getElementById("book-export-csv-btn");if(!a){var r=document.querySelector("#book-view-section .flex.items-center.gap-4");r&&(a=document.createElement("button"),a.id="book-export-csv-btn",a.className="flex items-center gap-2 px-4 py-2 bg-veritas-gold text-white rounded-lg hover:bg-veritas-gold/90 transition-colors font-semibold",a.innerHTML='<span class="material-symbols-outlined text-sm">download</span><span>Export CSV</span>',a.onclick=function(){ao()},r.appendChild(a))}dc(e.classOverview,e.questionCount),cc(e.studentDetails),uc(e.itemAnalysis,e.studentDetails),mc(e.studentDetails,e.questionCount)}function ao(){if(!pn){P("error","Export Error","No book view data available to export.");return}try{for(var e=pn,n=[],t=["Student Name","Email","Score","Percentage"],a=0;a<e.questionCount;a++)t.push("Q"+(a+1));n.push(t.join(",")),e.studentDetails.forEach(function(l){var c=[];function u(m){if(m==null)return"";var g=String(m);return g.includes(",")||g.includes('"')||g.includes(`
`)?'"'+g.replace(/"/g,'""')+'"':g}c.push(u(l.name)),c.push(u(l.email||"")),c.push(l.totalScore+"/"+l.maxScore),c.push(l.percentage+"%"),l.questionResponses.forEach(function(m){if(m.answered){var g=m.isCorrect?"âœ“ "+m.studentAnswer:"âœ— "+m.studentAnswer;c.push(u(g))}else c.push("â€”")}),n.push(c.join(","))});var r=n.join(`
`),i=new Blob([r],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),d=URL.createObjectURL(i),o=(e.pollName||"Poll")+"_"+(e.className||"Class")+"_Results.csv";o=o.replace(/[^a-z0-9_\-]/gi,"_"),s.setAttribute("href",d),s.setAttribute("download",o),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),P("success","Export Complete","CSV file downloaded successfully.",3e3),typeof ci=="function"&&ci("Export Book View CSV: "+e.pollName)}catch(l){console.error("[CSV Export] Error:",l),P("error","Export Failed","Failed to generate CSV file: "+l.message)}}window.exportBookViewToCSV=ao;function dc(e,n){var t=document.getElementById("book-class-total-students"),a=document.getElementById("book-class-average"),r=document.getElementById("book-class-median"),i=document.getElementById("book-class-stddev"),s=document.getElementById("book-class-interpretation");if(t&&(t.textContent=e.participantCount),a){var d=n>0?Math.round(e.mean/n*100):0;a.textContent=d+"%"}if(r&&(r.textContent=e.median+"/"+n),i&&(i.textContent=e.stdDev.toFixed(2)),s&&e.interpretation){var o="";e.interpretation.participation&&(o+='<div class="mb-2"><strong>Participation:</strong> '+e.interpretation.participation.message+"</div>"),e.interpretation.meanScore&&(o+='<div class="mb-2"><strong>Class Performance:</strong> '+e.interpretation.meanScore.message+"</div>"),e.interpretation.stdDev&&(o+="<div><strong>Score Distribution:</strong> "+e.interpretation.stdDev.message+"</div>"),s.innerHTML=o}}function cc(e){var n=document.getElementById("book-students-table-body");n&&(n.innerHTML="",e.forEach(function(t){var a=document.createElement("tr");a.className="hover:bg-slate-50 dark:hover:bg-brand-dark-gray/20 transition-colors cursor-pointer",a.onclick=function(){fc(t)};var r="";t.rank===1?r='<span class="ml-2 text-yellow-500">ðŸ¥‡</span>':t.rank===2?r='<span class="ml-2 text-gray-400">ðŸ¥ˆ</span>':t.rank===3&&(r='<span class="ml-2 text-orange-600">ðŸ¥‰</span>');var i="text-slate-700 dark:text-slate-300";t.percentage>=90?i="text-green-600 dark:text-green-400 font-bold":t.percentage>=80?i="text-green-600 dark:text-green-400":t.percentage>=70?i="text-blue-600 dark:text-blue-400":t.percentage>=60?i="text-yellow-600 dark:text-yellow-400":i="text-red-600 dark:text-red-400",a.innerHTML='<td class="px-4 py-3 text-sm font-semibold">'+t.rank+r+'</td><td class="px-4 py-3 text-sm font-medium text-brand-dark-gray dark:text-white">'+h(t.name)+'</td><td class="px-4 py-3 text-sm text-center">'+t.totalScore+"/"+t.maxScore+'</td><td class="px-4 py-3 text-sm text-center '+i+'">'+t.percentage+'%</td><td class="px-4 py-3 text-sm text-center">'+t.percentileRank+'th</td><td class="px-4 py-3 text-center"><button class="px-3 py-1 text-xs font-semibold rounded-lg bg-veritas-gold/10 text-veritas-gold hover:bg-veritas-gold/20 transition-colors">View Details</button></td>',n.appendChild(a)}))}function uc(e,n){var t=document.getElementById("book-questions-container");t&&(t.innerHTML="",e.forEach(function(a,r){var i=document.createElement("div");i.className="bg-white dark:bg-brand-dark-gray/30 rounded-xl border border-slate-200 dark:border-brand-dark-gray/40 p-6 shadow-sm";var s=a.interpretation.difficulty.color,d=a.interpretation.discrimination.color,o=a.interpretation.overall.color,l='<div class="flex items-start justify-between gap-4 mb-4"><div class="flex-1"><h4 class="text-lg font-bold text-brand-dark-gray dark:text-white mb-2">Question '+(r+1)+'</h4><p class="text-sm text-slate-600 dark:text-slate-400">'+h(a.questionText)+'</p></div><div class="flex gap-2">';a.flags.forEach(function(c){var u=c.replace(/-/g," ").toUpperCase();l+='<span class="px-2 py-1 text-xs font-semibold rounded bg-red-100 text-red-800">âš  '+u+"</span>"}),l+="</div></div>",l+='<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"><div class="bg-slate-50 dark:bg-brand-dark-gray/40 rounded-lg p-3"><p class="text-xs text-slate-500 mb-1">Difficulty (P-Value)</p><p class="text-2xl font-bold" style="color:'+s+'">'+(a.difficultyPct||0)+'%</p><p class="text-xs text-slate-600 dark:text-slate-400">'+a.interpretation.difficulty.message+'</p></div><div class="bg-slate-50 dark:bg-brand-dark-gray/40 rounded-lg p-3"><p class="text-xs text-slate-500 mb-1">Discrimination</p><p class="text-2xl font-bold" style="color:'+d+'">'+a.discrimination.toFixed(2)+'</p><p class="text-xs text-slate-600 dark:text-slate-400">'+a.interpretation.discrimination.message+'</p></div><div class="bg-slate-50 dark:bg-brand-dark-gray/40 rounded-lg p-3"><p class="text-xs text-slate-500 mb-1">Responses</p><p class="text-2xl font-bold text-slate-700 dark:text-slate-300">'+a.responseCount+'</p><p class="text-xs text-slate-600 dark:text-slate-400">students answered</p></div><div class="bg-slate-50 dark:bg-brand-dark-gray/40 rounded-lg p-3"><p class="text-xs text-slate-500 mb-1">Overall Quality</p><p class="text-sm font-bold" style="color:'+o+'">'+a.interpretation.overall.quality.toUpperCase()+'</p><p class="text-xs text-slate-600 dark:text-slate-400">'+a.interpretation.overall.message+"</p></div></div>",a.distractorAnalysis&&a.distractorAnalysis.length>0&&(l+='<div class="border-t border-slate-200 dark:border-brand-dark-gray/40 pt-4"><h5 class="text-sm font-semibold text-brand-dark-gray dark:text-white mb-3">Answer Choice Analysis</h5><div class="space-y-2">',a.distractorAnalysis.forEach(function(c){var u=c.isCorrect,m=u?"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800":"bg-slate-50 dark:bg-brand-dark-gray/40 border-slate-200 dark:border-brand-dark-gray/60",g=u?"âœ“":"";l+='<div class="flex items-center gap-3 p-3 rounded-lg border '+m+'"><div class="flex-shrink-0 w-8 h-8 rounded-full bg-white dark:bg-brand-dark-gray flex items-center justify-center font-bold text-sm">'+c.optionLetter+'</div><div class="flex-1"><p class="text-sm font-medium text-brand-dark-gray dark:text-white">'+g+" "+h(c.option)+(u?' <span class="text-green-600 dark:text-green-400">(Correct Answer)</span>':"")+'</p></div><div class="text-right"><p class="text-sm font-bold text-brand-dark-gray dark:text-white">'+c.totalPct.toFixed(1)+'%</p><p class="text-xs text-slate-500">selected</p></div><div class="text-right"><p class="text-xs text-slate-500">High: '+c.highGroupPct.toFixed(1)+'%</p><p class="text-xs text-slate-500">Low: '+c.lowGroupPct.toFixed(1)+"%</p></div></div>"}),l+="</div></div>"),i.innerHTML=l,t.appendChild(i)}))}function mc(e,n){var t=document.getElementById("book-matrix-header-row"),a=document.getElementById("book-matrix-table-body");if(!(!t||!a)){t.innerHTML="";var r=document.createElement("th");r.className="sticky left-0 bg-slate-100 dark:bg-brand-dark-gray/50 px-3 py-2 text-left font-semibold border-r border-slate-300 dark:border-brand-dark-gray/60",r.textContent="Student",t.appendChild(r);for(var i=0;i<n;i++){var s=document.createElement("th");s.className="bg-slate-100 dark:bg-brand-dark-gray/50 px-3 py-2 text-center font-semibold border-l border-slate-300 dark:border-brand-dark-gray/60",s.textContent="Q"+(i+1),t.appendChild(s)}var d=document.createElement("th");d.className="bg-slate-100 dark:bg-brand-dark-gray/50 px-3 py-2 text-center font-semibold",d.textContent="Total",t.appendChild(d),a.innerHTML="",e.forEach(function(o){var l=document.createElement("tr");l.className="hover:bg-slate-50 dark:hover:bg-brand-dark-gray/20";var c=document.createElement("td");c.className="sticky left-0 bg-white dark:bg-brand-dark-gray px-3 py-2 text-sm font-medium border-r border-slate-300 dark:border-brand-dark-gray/60",c.textContent=o.name,l.appendChild(c),o.questionResponses.forEach(function(m){var g=document.createElement("td");g.className="px-3 py-2 text-center text-xs border-l border-slate-200 dark:border-brand-dark-gray/60",m.answered?m.isCorrect?(g.className+=" bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 font-semibold",g.innerHTML='âœ“<br><span class="text-[10px]">'+h(m.studentAnswer)+"</span>"):(g.className+=" bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 font-semibold",g.innerHTML='âœ—<br><span class="text-[10px]">'+h(m.studentAnswer)+"</span>"):(g.className+=" bg-slate-100 dark:bg-brand-dark-gray/40 text-slate-400",g.textContent="â€”"),l.appendChild(g)});var u=document.createElement("td");u.className="px-3 py-2 text-center font-bold text-sm bg-slate-100 dark:bg-brand-dark-gray/50",u.textContent=o.totalScore+"/"+o.maxScore,l.appendChild(u),a.appendChild(l)})}}function fc(e){var n=document.getElementById("book-student-detail");if(n){var t=document.getElementById("student-detail-name"),a=document.getElementById("student-detail-score"),r=document.getElementById("student-detail-percentage"),i=document.getElementById("student-detail-rank"),s=document.getElementById("student-detail-percentile");t&&(t.textContent=e.name),a&&(a.textContent=e.totalScore+"/"+e.maxScore),r&&(r.textContent=e.percentage+"%"),i&&(i.textContent="#"+e.rank),s&&(s.textContent=e.percentileRank+"th percentile");var d=document.getElementById("student-detail-responses");d&&(d.innerHTML="",e.questionResponses.forEach(function(o,l){var c=document.createElement("div");c.className="bg-white dark:bg-brand-dark-gray/30 rounded-lg border border-slate-200 dark:border-brand-dark-gray/40 p-4";var u=o.isCorrect?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300":"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300",m=o.isCorrect?"âœ“":"âœ—",g=o.isCorrect?"Correct":"Incorrect";o.answered||(u="bg-slate-100 text-slate-600 dark:bg-brand-dark-gray/40 dark:text-slate-400",m="â€”",g="Not Answered");var p='<div class="flex items-start justify-between gap-4 mb-3"><h5 class="text-sm font-bold text-brand-dark-gray dark:text-white">Question '+(l+1)+'</h5><span class="px-3 py-1 text-xs font-semibold rounded-full '+u+'">'+m+" "+g+'</span></div><p class="text-sm text-slate-700 dark:text-slate-300 mb-3">'+h(o.questionText)+"</p>";o.answered&&(p+='<div class="space-y-2"><div><span class="text-xs font-semibold text-slate-500">Student Answer:</span> <span class="text-sm font-medium text-brand-dark-gray dark:text-white">'+h(o.studentAnswer)+'</span></div><div><span class="text-xs font-semibold text-slate-500">Correct Answer:</span> <span class="text-sm font-medium text-green-700 dark:text-green-400">'+h(o.correctAnswer)+"</span></div></div>"),c.innerHTML=p,d.appendChild(c)})),n.classList.remove("hidden")}}function ro(){var e=document.getElementById("book-student-detail");e&&e.classList.add("hidden")}window.closeStudentDetail=ro,document.addEventListener("keydown",function(e){if(e.key==="Escape"||e.keyCode===27){var n=document.getElementById("book-student-detail");n&&!n.classList.contains("hidden")&&ro()}});function fi(e){var n=["students","questions","matrix"];n.forEach(function(t){var a=document.getElementById("book-tab-"+t),r=document.getElementById("book-content-"+t);a&&(t===e?a.className="px-6 py-3 font-semibold text-sm transition-colors border-b-2 border-veritas-gold text-veritas-gold":a.className="px-6 py-3 font-semibold text-sm transition-colors border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-veritas-gold hover:border-veritas-gold/30"),r&&(t===e?r.classList.remove("hidden"):r.classList.add("hidden"))})}function h(e){if(!e)return"";var n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&amp;#039;"};return String(e).replace(/[&<>"']/g,function(t){return n[t]})}I("view-book-report-btn",ic),I("secure-view-links-btn",function(){var e=f&&f.className;if(!e){S("No class assigned to this assessment.",{title:"View Links",destructive:!0});return}K?(K.dataset.className=e,Ua()):firebase.database().ref("rosters/rosters/"+e).once("value").then(function(n){var t=n.val();if(t&&t.length>0){var a=t.map(function(r){return{name:r.name,email:r.email,link:WEB_APP_URL+"?role=student&pollId="+(f?f.pollId:"")+"&email="+encodeURIComponent(r.email)}});openLinksModalWithData(e,a)}else S("No students found in this class roster.",{title:"View Links",destructive:!0})}).catch(function(n){F(n)})});var io=document.getElementById("book-tab-students"),so=document.getElementById("book-tab-questions"),oo=document.getElementById("book-tab-matrix");io&&io.addEventListener("click",function(){fi("students")}),so&&so.addEventListener("click",function(){fi("questions")}),oo&&oo.addEventListener("click",function(){fi("matrix")});function gi(e,n){if(!(!O||!Ne||!$)){ta(!0);var t=O,a=n[2]||$.email,r=typeof generateStudentKey=="function"?generateStudentKey(a):a.replace(/[.$#[\]]/g,"_"),i=firebase.database().ref("sessions/"+t+"/students/"+r),s=null;if(e==="adjustSecureAssessmentTime"){var d=n[3];s=i.child("timeAdjustment").transaction(function(o){return(o||0)+d})}else e==="pauseSecureAssessmentStudent"?s=i.update({status:"PAUSED",pauseActive:!0}):e==="resumeSecureAssessmentStudent"?s=i.update({status:"ACTIVE",pauseActive:!1}):e==="forceSubmitSecureAssessmentStudent"&&(s=i.update({status:"FINISHED"}));s?s.then(function(){ta(!1),ea()}).catch(function(o){ta(!1),F(o)}):ta(!1)}}function lo(e){$&&gi("adjustSecureAssessmentTime",[O,Ne,$.email,e])}function gc(){if($){var e=$.pauseActive?"resumeSecureAssessmentStudent":"pauseSecureAssessmentStudent";gi(e,[O,Ne,$.email])}}async function pc(){if($){var e=await Qe("Force submit and lock "+$.name+"?",{title:"Force submit",destructive:!0,confirmText:"Force Submit"});e&&gi("forceSubmitSecureAssessmentStudent",[O,Ne,$.email])}}I("end-individual-session-btn",Ul),Hi&&Hi.addEventListener("click",to),document.querySelectorAll('[data-student-manager-close="true"]').forEach(function(e){e.addEventListener("click",to)}),Er&&Er.addEventListener("click",function(){lo(5)}),wr&&wr.addEventListener("click",function(){lo(10)}),Bn&&Bn.addEventListener("click",gc),kr&&kr.addEventListener("click",function(){pc()}),Lt&&Lt.addEventListener("click",function(){!$||!O||($d($.email,"ACTIVE"),gs($.email,O,$.lockVersion||0,Lt))}),en&&en.addEventListener("click",function(){eo("ALL")}),dt&&dt.addEventListener("click",function(){eo("SELECTED")}),Ea&&Ea.addEventListener("click",function(){ec()}),Zn();var b={currentStep:1,mode:null,pollName:"",className:"",timeLimitMinutes:null,accessCode:"",availabilityStart:null,availabilityEnd:null,calculatorEnabled:!1,proctoringRules:[],questions:[],showResultsImmediately:!1,pollId:null,isEditMode:!1};function na(){b={currentStep:1,mode:null,pollName:"",className:"",timeLimitMinutes:null,accessCode:"",availabilityStart:null,availabilityEnd:null,calculatorEnabled:!1,proctoringRules:[],questions:[],showResultsImmediately:!1,pollId:null,isEditMode:!1}}function co(e,n){if(!firebase.auth().currentUser||!window.AUTH_READY){console.warn("[Wizard] Cannot refresh classes: Auth not ready"),e&&(firebase.auth().currentUser?(e.innerHTML='<option value="" disabled>Loading classes...</option>',setTimeout(function(){co(e,n)},500)):e.innerHTML='<option value="" disabled>Please sign in to load classes</option>');return}Xe({action:"GET_DATA"}).then(function(t){if(t.data&&t.data.success){Pr(t.data,M);var a=window.ALL_CLASSES&&window.ALL_CLASSES.length>0?window.ALL_CLASSES:[];e&&(a.length>0?(e.innerHTML='<option value="">-- Select a class --</option>',a.forEach(function(r){var i=document.createElement("option");i.value=r,i.textContent=r,e.appendChild(i)}),n&&(e.value=n)):e.innerHTML='<option value="" disabled>No classes found (Create one in Dashboard)</option>')}}).catch(function(t){console.warn("[Wizard] Unable to refresh classes for wizard:",t)})}var aa=null;function ra(e,n){na();var t=!!e;if(na(),b.pollId=t?e.pollId:null,b.isEditMode=t,b.currentStep=1,t&&e){b.pollName=e.pollName||"",b.className=e.className||"";var a=Ge(e.sessionType);b.mode=a==="SECURE_ASSESSMENT"?"secure":"live",b.mode==="secure"&&(b.timeLimitMinutes=typeof e.timeLimitMinutes=="number"?e.timeLimitMinutes:e.secureSettings&&typeof e.secureSettings.timeLimitMinutes=="number"?e.secureSettings.timeLimitMinutes:60,b.accessCode=(e.accessCode||e.secureSettings&&e.secureSettings.accessCode||"").toString().toUpperCase(),b.availabilityStart=e.availableFrom||e.secureSettings&&e.secureSettings.availableFrom||null,b.availabilityEnd=e.dueBy||e.secureSettings&&e.secureSettings.dueBy||null,b.calculatorEnabled=e.calculatorEnabled===!0||e.secureSettings&&e.secureSettings.calculatorEnabled===!0),e.questions&&e.questions.length>0&&(b.questions=e.questions.map(function(g){for(var p=(g.options||[]).map(function(y){return{text:y.text||"",imageURL:y.imageURL||"",imageFileId:y.imageFileId||null}});p.length<4;)p.push({text:"",imageURL:"",imageFileId:null});var v=0;return p.forEach(function(y,E){y.text===g.correctAnswer&&(v=E)}),{questionText:g.questionText||"",questionImageURL:g.questionImageURL||"",questionImageFileId:g.questionImageFileId||null,options:p,correctAnswerIndex:v,metacognitionEnabled:!!g.metacognitionEnabled,timerSeconds:g.timerSeconds||null}}));var r=document.getElementById("wizard-title");r&&(r.textContent="Edit Poll")}else{var r=document.getElementById("wizard-title");r&&(r.textContent="Create Poll")}b.questions.length;var i=document.getElementById("wizard-class-select");if(i){i.innerHTML='<option value="">-- Select a class --</option>';var s=window.ALL_CLASSES&&window.ALL_CLASSES.length>0?window.ALL_CLASSES:typeof Vt<"u"?Vt:[];if(s.length===0){var d=document.createElement("option");d.textContent="Loading classes...",d.disabled=!0,i.appendChild(d),co(i,b.className)}else s.forEach(function(g){var p=document.createElement("option");p.value=g,p.textContent=g,i.appendChild(p)});if(t&&b.className){if(s.indexOf(b.className)===-1){var o=document.createElement("option");o.value=b.className,o.textContent=b.className,i.appendChild(o)}i.value=b.className}}Pe("create-poll");var l=document.getElementById("header-session-controls");if(l&&l.classList.add("hidden"),t){typeof n=="number"&&n>=0?(Ee(3),L=n,setTimeout(function(){ne()},0)):Ee(2);var c=document.getElementById("live-config-section"),u=document.getElementById("secure-config-section"),m=document.getElementById("config-mode-label");b.mode==="secure"?(c&&c.classList.add("hidden"),u&&u.classList.remove("hidden"),m&&(m.textContent="Secure Assessment")):b.mode==="live"&&(c&&c.classList.remove("hidden"),u&&u.classList.add("hidden"),m&&(m.textContent="Live Poll"))}else Ee(1)}function uo(){if(!((b.pollName||b.questions.length>0)&&!confirm("You have unsaved changes. Are you sure you want to close?"))){var e=document.getElementById("header-session-controls");e&&e.classList.remove("hidden"),Pe("dashboard")}}function mo(e){Array.isArray(e)&&sl(e),b={currentStep:1,mode:null,pollName:"",className:"",timeLimitMinutes:null,accessCode:"",availabilityStart:null,availabilityEnd:null,calculatorEnabled:!1,proctoringRules:[],questions:[],showResultsImmediately:!1,pollId:null,isEditMode:!1};var n=document.getElementById("header-session-controls");n&&n.classList.remove("hidden"),Pe("dashboard")}function vc(e){if(e){var n=ae.find(function(t){return t.pollId===e});n?ra(n):S("Failed to load poll data for editing.",{title:"Error"})}}window.Wizard={init:ra,close:uo,loadWithData:vc};function Ee(e){if(!(e<1||e>4)){var n=[".wizard-progress"];n.forEach(function(u){var m=document.querySelector(u);if(m)for(var g=1;g<=4;g++){var p=m.querySelector('.progress-step[data-step="'+g+'"]');if(p)if(p.classList.remove("active","completed"),g<e){p.classList.add("completed");var v=p.querySelector(".progress-circle");v&&(v.classList.add("bg-green-500"),v.classList.remove("bg-white/20"))}else if(g===e){p.classList.add("active");var v=p.querySelector(".progress-circle");v&&(v.classList.remove("bg-green-500","bg-white/20"),v.classList.add("bg-veritas-gold"))}else{var v=p.querySelector(".progress-circle");v&&(v.classList.remove("bg-green-500","bg-veritas-gold"),v.classList.add("bg-white/20"))}}});for(var t=1;t<=4;t++){var a=document.getElementById("wizard-step-"+t);a&&a.classList.remove("active")}var r=document.getElementById("wizard-step-"+e);if(r&&r.classList.add("active"),b.currentStep=e,hc(),e===2){var i=document.getElementById("wizard-poll-name"),s=document.getElementById("wizard-class-select"),d=document.getElementById("wizard-time-limit"),o=document.getElementById("wizard-access-code"),l=document.getElementById("wizard-calculator-toggle");if(i&&b.pollName&&(i.value=b.pollName),s&&b.className&&(s.value=b.className),d&&b.timeLimitMinutes&&(d.value=b.timeLimitMinutes),o&&b.accessCode&&(o.value=b.accessCode),l&&(l.checked=b.calculatorEnabled===!0),b.isEditMode&&b.mode){var c=document.getElementById("wizard-step-2")?.querySelector("span.mode-label");c&&(c.textContent=b.mode==="secure"?"Secure Assessment":"Live Poll")}}b.currentStep===3&&e!==3&&Be(),e===3&&Te(),e===4&&Dc()}}function bc(){wc(b.currentStep)&&(Ec(b.currentStep),b.currentStep<4&&Ee(b.currentStep+1))}function yc(){b.currentStep>1&&Ee(b.currentStep-1)}function hc(){var e=document.getElementById("wizard-back-btn"),n=document.getElementById("wizard-next-btn"),t=document.getElementById("wizard-publish-btn");if(!(!e||!n||!t))if(b.isEditMode?e.disabled=b.currentStep<=2:e.disabled=b.currentStep===1,b.currentStep===4){n.classList.add("hidden"),t.classList.remove("hidden");var a=t.querySelector(".material-symbols-outlined"),r=t.querySelector(".publish-btn-text")||t;b.isEditMode?(a&&(a.textContent="save"),r.innerHTML='<span class="material-symbols-outlined">save</span>Update Poll'):(a&&(a.textContent="rocket_launch"),r.innerHTML='<span class="material-symbols-outlined">rocket_launch</span>Publish Poll')}else n.classList.remove("hidden"),t.classList.add("hidden")}function xc(e){b.mode=e;var n=document.querySelectorAll(".mode-card");n.forEach(function(a){a.getAttribute("data-mode")===e?a.classList.add("selected"):a.classList.remove("selected")});var t=document.getElementById("wizard-next-btn");t&&(t.disabled=!1)}function Ec(e){e===2&&(b.pollName=document.getElementById("wizard-poll-name")?.value||"",b.className=document.getElementById("wizard-class-select")?.value||"",b.mode==="secure"&&(b.timeLimitMinutes=parseInt(document.getElementById("wizard-time-limit")?.value)||null,b.accessCode=document.getElementById("wizard-access-code")?.value||"",b.calculatorEnabled=document.getElementById("wizard-calculator-toggle")?.checked||!1))}function wc(e){if(e===1){if(!b.mode)return alert("Please select a poll mode."),!1;var n=document.getElementById("live-config-section"),t=document.getElementById("secure-config-section"),a=document.getElementById("config-mode-label");return b.mode==="live"?(n&&n.classList.remove("hidden"),t&&t.classList.add("hidden"),a&&(a.textContent="Live Poll")):(n&&n.classList.add("hidden"),t&&t.classList.remove("hidden"),a&&(a.textContent="Secure Assessment")),!0}if(e===2){var r=document.getElementById("wizard-poll-name")?.value.trim(),i=document.getElementById("wizard-class-select")?.value;if(!r)return alert("Please enter a poll name."),!1;if(!i)return alert("Please select a class."),!1;if(b.mode==="secure"){var s=parseInt(document.getElementById("wizard-time-limit")?.value);if(!s||s<=0)return alert("Time limit is required for Secure Assessments."),!1}return!0}return e===3&&b.questions.length===0?(alert("Please add at least one question."),!1):!0}function Be(){var e={a:0,b:1,c:2,d:3,e:4,f:5};Object.keys(Re.instances).forEach(function(n){var t=Re.instances[n];if(t){var a=document.getElementById(n);if(a){var r=a.querySelector(".ql-editor"),i=r?r.innerHTML:t.root.innerHTML,s=t.getText(),d=t.getContents(),o=n.match(/^question-input-(\d+)$/);if(o){var l=parseInt(o[1],10)-1;b.questions[l]&&(b.questions[l].html=i,b.questions[l].delta=d,b.questions[l].questionText=s);return}var c=n.match(/^answer-input-(\d+)-([a-f])$/i);if(c){var l=parseInt(c[1],10)-1,u=c[2].toLowerCase(),m=e[u];b.questions[l]&&b.questions[l].options[m]&&(b.questions[l].options[m].html=i,b.questions[l].options[m].delta=d,b.questions[l].options[m].text=s);return}var g=n.match(/^q-meta-(\d+)$/);if(g){var l=parseInt(g[1],10);b.questions[l]&&(b.questions[l].metaPromptHtml=i,b.questions[l].metaPromptDelta=d,b.questions[l].metaPromptText=s);return}}}})}window.syncWizardQuillContent=Be;function kc(){var e=document.getElementById("wizard-questions-list");e&&(b.questions.push({questionText:"",html:"",delta:null,questionImageURL:"",options:[{text:"",html:"",delta:null,imageURL:"",id:$e()},{text:"",html:"",delta:null,imageURL:"",id:$e()},{text:"",html:"",delta:null,imageURL:"",id:$e()},{text:"",html:"",delta:null,imageURL:"",id:$e()}],correctAnswerIndex:0,metacognitionEnabled:!1,timerSeconds:null}),Be(),Te(),setTimeout(function(){var n=e.lastElementChild;n&&n.scrollIntoView({behavior:"smooth",block:"center"})},100))}function Ic(e){if(b.questions.length<=1){alert("You must have at least one question.");return}confirm("Are you sure you want to remove this question?")&&(Be(),b.questions.splice(e,1),Te())}function Lc(e){var n=b.questions[e];if(n.options.length>=6){alert("Maximum 6 answer choices allowed.");return}Be(),n.options.push({text:"",html:"",delta:null,imageURL:"",id:$e()}),Te()}function Cc(e,n){var t=b.questions[e];if(t.options.length<=2){alert("Minimum 2 answer choices required.");return}Be(),t.options.splice(n,1),t.correctAnswerIndex>=t.options.length&&(t.correctAnswerIndex=0),Te()}function Sc(e,n){Be(),b.questions[e].correctAnswerIndex=n,Te()}function Ac(e,n){if(!(!n||!n.trim())){var t=n.split(`
`).map(o=>o.trim()).filter(o=>o);if(!(t.length<2)){var a="",r=[],i=/^([a-f]|[1-6])[\.\)]\s*(.*)/i,s=!1;t.forEach(o=>{var l=o.match(i);l?(s=!0,r.push(l[2])):s?r.length>0&&(r[r.length-1]+=" "+o):a+=(a?`
`:"")+o}),r.length===0&&(a=t[0],r=t.slice(1)),Be();var d=b.questions[e];for(d.questionText=a,d.html="<p>"+a+"</p>",d.delta=null,d.options=r.slice(0,6).map(o=>({text:o,html:"<p>"+o+"</p>",delta:null,imageURL:"",id:$e()}));d.options.length<2;)d.options.push({text:"",html:"",delta:null,imageURL:"",id:$e()});Te()}}}function Bc(){var e=[{label:"Î±",value:"Î±"},{label:"Î²",value:"Î²"},{label:"Î³",value:"Î³"},{label:"Ï€",value:"Ï€"},{label:"Î¸",value:"Î¸"},{label:"Î£",value:"Î£"},{label:"âˆž",value:"âˆž"},{label:"âˆš",value:"âˆš"},{label:"Â²",value:"Â²"},{label:"Â³",value:"Â³"},{label:"Â±",value:"Â±"},{label:"â‰ ",value:"â‰ "},{label:"â‰ˆ",value:"â‰ˆ"},{label:"â‰¤",value:"â‰¤"},{label:"â‰¥",value:"â‰¥"},{label:"Î”",value:"Î”"}],n='<div class="math-input-panel flex flex-wrap gap-1.5 p-2 bg-slate-50 border-b border-brand-light-gray">';return e.forEach(function(t){n+=`<button type="button" class="math-symbol-btn" onclick="QuillManager.insertMathSymbol('`+t.value+`')">`+t.label+"</button>"}),n+="</div>",n}function Te(){var e=document.getElementById("wizard-questions-list");e&&(e.innerHTML="",Re.clearAll(),b.questions.forEach(function(n,t){var a=["A","B","C","D","E","F"],r=t+1,i="question-input-"+r,s=document.createElement("div");s.className="question-card bg-white border border-brand-light-gray rounded-xl overflow-hidden shadow-sm transition-all duration-200 ring-offset-2",s.dataset.qIndex=t;var d='<div class="question-card-header flex justify-between items-center px-4 py-2 bg-slate-50 border-b border-brand-light-gray"><div class="flex items-center gap-3"><div class="drag-handle cursor-grab active:cursor-grabbing p-1 -ml-1 text-slate-400 hover:text-slate-600 hover:bg-slate-200 rounded transition-colors" draggable="true" title="Drag to reorder"><span class="material-symbols-outlined text-lg">drag_indicator</span></div><div class="flex items-center gap-2"><div class="h-6 w-6 rounded bg-veritas-navy text-white flex items-center justify-center font-bold text-[10px]">'+r+'</div><span class="font-bold text-xs text-brand-dark-gray tracking-tight">QUESTION '+r+'</span></div></div><div class="flex items-center gap-2"><label class="flex items-center gap-1.5 px-2 py-1 rounded hover:bg-slate-200 cursor-pointer text-[11px] font-semibold text-slate-500 transition-colors" title="Enable confidence tracking"><input type="checkbox" class="wizard-meta-cb h-3.5 w-3.5 rounded border-slate-300 text-veritas-navy focus:ring-veritas-navy" data-q-index="'+t+'" '+(n.metacognitionEnabled?"checked":"")+'><span>Confidence</span></label><div class="w-px h-4 bg-slate-200 mx-1"></div><button type="button" class="p-1.5 rounded text-red-400 hover:text-red-600 hover:bg-red-50 transition-all" onclick="removeWizardQuestion('+t+')" title="Remove Question"><span class="material-symbols-outlined text-lg">delete</span></button></div></div>',o=Bc(),l='<div class="px-4 py-3 bg-slate-50/50 border-b border-brand-light-gray"><div class="flex items-center gap-2 mb-2"><span class="material-symbols-outlined text-sm text-veritas-gold">tips_and_updates</span><span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Smart Paste</span></div><textarea class="smart-paste-area focus:ring-1 focus:ring-veritas-gold" placeholder="Paste full question with options here (e.g. "What is 2+2? A) 3 B) 4") to auto-populate..." data-q-index="'+t+'"></textarea></div>',c='<div class="p-4 space-y-2"><div class="flex items-center justify-between"><label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider">Question Stem</label></div><div class="border border-brand-light-gray rounded-lg overflow-hidden focus-within:border-veritas-navy transition-colors"><div id="'+i+'" class="bg-white" style="min-height: 100px; height: auto;"></div></div></div>',u='<div class="px-4 pb-4 space-y-3"><label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider block mb-1">Answer Choices</label>';n.options.forEach(function(y,E){var q=n.correctAnswerIndex===E,B="answer-input-"+r+"-"+a[E].toLowerCase(),x=q?"ring-2 ring-green-500 bg-green-50/30":"border-slate-200";u+='<div class="flex items-start gap-3 p-3 rounded-xl border '+x+' transition-all group"><div class="flex flex-col items-center gap-2 mt-1"><button type="button" class="wizard-correct-toggle w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm transition-all '+(q?"bg-green-500 text-white shadow-lg shadow-green-200":"bg-slate-100 text-slate-400 hover:bg-green-100 hover:text-green-600")+'" onclick="setCorrectAnswer('+t+", "+E+')" title="Mark as Correct Answer">'+a[E]+'</button></div><div class="flex-1"><div class="border border-brand-light-gray rounded-lg overflow-hidden bg-white focus-within:border-veritas-navy transition-colors"><div id="'+B+'" style="min-height: 60px; height: auto;"></div></div></div><button type="button" class="mt-2 p-1.5 rounded text-slate-300 hover:text-red-500 hover:bg-red-50 transition-all opacity-0 group-hover:opacity-100" onclick="removeWizardOption('+t+", "+E+')" title="Remove Choice"><span class="material-symbols-outlined text-lg">close</span></button></div>'}),n.options.length<6&&(u+='<div class="flex justify-center pt-1"><button type="button" class="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-100 hover:bg-primary/10 text-slate-600 hover:text-primary transition-all text-[11px] font-bold" onclick="addWizardOption('+t+')"><span class="material-symbols-outlined text-sm">add_circle</span>Add Choice</button></div>'),u+="</div>",s.innerHTML=d+o+l+c+u,e.appendChild(s);var m=s.querySelector(".smart-paste-area");if(m&&m.addEventListener("paste",function(y){y.preventDefault();var E=(y.clipboardData||window.clipboardData).getData("text");Ac(t,E)}),n.metacognitionEnabled){var g=document.createElement("div");g.className="px-4 pb-4",g.innerHTML='<label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Confidence Prompt</label><div id="q-meta-'+t+'" class="border border-brand-light-gray rounded-lg overflow-hidden" style="height: 80px;"></div>',s.insertBefore(g,s.querySelector(".p-4")),Re.init("q-meta-"+t,n.metaPromptDelta||n.metaPromptHtml||"How confident are you in your answer?","Enter prompt...",function(y){b.questions[t].metaPromptHtml=y.html,b.questions[t].metaPromptDelta=y.delta,b.questions[t].metaPromptText=y.text})}var p=s.querySelector(".wizard-meta-cb");p&&p.addEventListener("change",function(){b.questions[t].metacognitionEnabled=this.checked,Te()});var v=s.querySelector(".drag-handle");v.addEventListener("dragstart",function(y){aa=t,s.classList.add("opacity-40","scale-[0.98]"),y.dataTransfer.effectAllowed="move",y.dataTransfer.setDragImage(s,20,20)}),v.addEventListener("dragend",function(y){s.classList.remove("opacity-40","scale-[0.98]"),e.querySelectorAll(".question-card").forEach(function(E){E.classList.remove("ring-4","ring-veritas-gold/20","border-veritas-gold")})}),s.addEventListener("dragover",function(y){return y.preventDefault&&y.preventDefault(),y.dataTransfer.dropEffect="move",this.classList.add("ring-4","ring-veritas-gold/20","border-veritas-gold"),!1}),s.addEventListener("dragleave",function(y){this.classList.remove("ring-4","ring-veritas-gold/20","border-veritas-gold")}),s.addEventListener("drop",function(y){y.stopPropagation&&y.stopPropagation();var E=parseInt(this.dataset.qIndex);if(aa!==null&&aa!==E){Be();var q=b.questions[aa];b.questions.splice(aa,1),b.questions.splice(E,0,q),Te()}return!1})}),Nc(),fo())}function fo(){var e=document.getElementById("wizard-timeline-items");e&&(e.innerHTML="",b.questions.forEach(function(n,t){var a=document.createElement("button");a.type="button",a.className="wizard-timeline-btn w-full h-8 rounded-lg bg-slate-50 hover:bg-primary/10 border border-brand-light-gray/50 hover:border-primary flex items-center justify-center font-bold text-sm text-brand-dark-gray hover:text-primary transition-all",a.dataset.qIndex=t,a.title="Jump to Question "+(t+1),a.textContent=t+1,a.addEventListener("click",function(){go(t)}),e.appendChild(a)}),Tc())}function go(e){var n=document.getElementById("wizard-questions-list");if(n){var t=n.querySelectorAll(".question-card");t[e]&&(t[e].scrollIntoView({behavior:"smooth",block:"center"}),t[e].classList.add("ring-2","ring-primary","ring-offset-2"),setTimeout(function(){t[e].classList.remove("ring-2","ring-primary","ring-offset-2")},1500))}}var Ya=null;function Tc(){Ya&&Ya.disconnect();var e=document.getElementById("wizard-questions-list"),n=document.getElementById("wizard-timeline-items");if(!(!e||!n)){var t=e.querySelectorAll(".question-card");t.length!==0&&(Ya=new IntersectionObserver(function(a){a.forEach(function(r){if(r.isIntersecting){var i=parseInt(r.target.dataset.qIndex);qc(i)}})},{root:null,rootMargin:"-20% 0px -60% 0px",threshold:0}),t.forEach(function(a){Ya.observe(a)}))}}function qc(e){var n=document.getElementById("wizard-timeline-items");if(n){var t=n.querySelectorAll(".wizard-timeline-btn");t.forEach(function(a,r){r===e?(a.classList.remove("bg-slate-50","text-brand-dark-gray","border-brand-light-gray/50"),a.classList.add("bg-primary","text-white","border-primary","shadow-md")):(a.classList.remove("bg-primary","text-white","border-primary","shadow-md"),a.classList.add("bg-slate-50","text-brand-dark-gray","border-brand-light-gray/50"))})}}window.updateWizardTimeline=fo,window.jumpToWizardQuestion=go;function po(e){if(!e)return null;if(e.tagName&&e.tagName.toLowerCase()==="div")return e.id;var n=document.createElement("div");return n.id=e.id,n.className=e.className||"",n.innerHTML=e.value||e.innerHTML||"",Array.prototype.slice.call(e.attributes||[]).forEach(function(t){t.name!=="id"&&t.name!=="class"&&n.setAttribute(t.name,t.value)}),e.parentNode&&e.parentNode.replaceChild(n,e),n.id}function Nc(){if(console.log("[Wizard] initializeQuillEditors firing"),typeof Quill>"u"){console.error("Quill is not available. Skipping wizard editor initialization.");return}var e=document.querySelector("[data-full-editor-toggle], #full-editor-toggle");e&&e.parentNode&&e.parentNode.removeChild(e);var n=document.getElementById("poll-wizard")||document,t=n.querySelectorAll('[id^="question-input-"]');t.forEach(function(i){var s=i.id.match(/^question-input-(\d+)/),d=s?parseInt(s[1],10)-1:null;if(!(d===null||!b.questions[d])){var o=b.questions[d],l=o.delta||o.html||o.questionText||"",c=po(i);Re.init(c,l,"Enter question text...",function(u){o.html=u.html,o.delta=u.delta,o.questionText=u.text})}});var a={a:0,b:1,c:2,d:3,e:4,f:5},r=n.querySelectorAll('[id^="answer-input-"]');r.forEach(function(i){var s=i.id.match(/^answer-input-(\d+)-([a-f])/i);if(s){var d=parseInt(s[1],10)-1,o=s[2].toLowerCase(),l=a[o];if(!(d<0||l===void 0)){var c=b.questions[d];if(c){c.options[l]||(c.options[l]={text:"",html:"",delta:null,imageURL:"",imageFileId:null,id:$e()});var u=c.options[l],m=u.delta||u.html||u.text||"",g=po(i);Re.init(g,m,"Answer choice...",function(p){u.html=p.html,u.delta=p.delta,u.text=p.text})}}}})}function Mc(e){return new Promise(function(n,t){var a=firebase.auth().currentUser;if(!a){t("User not authenticated");return}var r=Date.now(),i="poll_images/"+a.uid+"/"+r+"_"+e.name,s=firebase.storage().ref().child(i),d=s.put(e);d.on("state_changed",function(o){},function(o){console.error("Upload failed:",o),t(o)},function(){d.snapshot.ref.getDownloadURL().then(function(o){n(o)})})})}function Rc(e,n,t){if(e){if(!e.type.startsWith("image/")){alert("Please select an image file.");return}if(e.size>5*1024*1024){alert("Image must be less than 5MB.");return}Be(),t===null?b.questions[n].questionImageURL="UPLOADING":b.questions[n].options[t].imageURL="UPLOADING",Te(),Mc(e).then(function(a){Be(),t===null?b.questions[n].questionImageURL=a:b.questions[n].options[t].imageURL=a,Te()}).catch(function(a){alert("Image upload failed. Please try again."),Be(),t===null?b.questions[n].questionImageURL=null:b.questions[n].options[t].imageURL=null,Te()})}}window.addWizardOption=Lc,window.removeWizardOption=Cc,window.setCorrectAnswer=Sc,window.handleWizardImageUpload=Rc;function Dc(){var e=b.mode==="live"?"Live Poll":"Secure Assessment";document.getElementById("review-mode").textContent=e,document.getElementById("review-name").textContent=b.pollName||"(Untitled)",document.getElementById("review-class").textContent=b.className||"(No class selected)";var n=document.getElementById("review-questions-summary");if(n)if(b.questions.length===0)n.innerHTML='<p class="text-red-500 font-medium">No questions added. Please go back and add at least one question.</p>';else{var t=["A","B","C","D","E","F"],a='<div class="space-y-4">';a+='<p class="text-sm text-brand-dark-gray/60 mb-3">'+b.questions.length+" question(s) ready to publish</p>",b.questions.forEach(function(r,i){var s=r.questionText||"(Empty question)";s.length>80&&(s=s.substring(0,80)+"..."),a+='<div class="bg-slate-50 rounded-lg p-3 border border-brand-light-gray hover:border-primary hover:bg-primary/5 cursor-pointer transition-all group" data-edit-question="'+i+'" title="Click to edit this question">',a+='<div class="flex items-start gap-2 mb-2">',a+='<span class="h-6 w-6 rounded bg-primary text-white text-xs font-bold flex items-center justify-center shrink-0">'+(i+1)+"</span>",a+='<span class="font-medium text-brand-dark-gray text-sm group-hover:text-primary">'+h(s)+"</span>",a+='<span class="material-symbols-outlined text-xs text-slate-400 ml-auto opacity-0 group-hover:opacity-100 transition-opacity">edit</span>',a+="</div>",r.options&&r.options.length>0&&(a+='<div class="ml-8 flex flex-wrap gap-2">',r.options.forEach(function(d,o){if(d.text&&d.text.trim()!==""){var l=r.correctAnswerIndex===o,c=l?"bg-green-100 text-green-700 border-green-300":"bg-white text-brand-dark-gray/70 border-brand-light-gray",u=d.text.length>20?d.text.substring(0,20)+"...":d.text;a+='<span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded border '+c+'">',a+="<strong>"+t[o]+"</strong> "+h(u),l&&(a+=' <span class="material-symbols-outlined text-xs">check</span>'),a+="</span>"}}),a+="</div>"),a+="</div>"}),a+="</div>",b.mode==="secure"&&(a+='<div class="mt-4 p-3 rounded-lg bg-amber-50 border border-amber-200">',a+='<h5 class="text-sm font-bold text-amber-800 mb-2 flex items-center gap-2"><span class="material-symbols-outlined text-base">lock</span>Secure Assessment Settings</h5>',a+='<div class="text-sm text-amber-700 space-y-1">',a+="<p><strong>Time Limit:</strong> "+(b.timeLimitMinutes||"Not set")+" minutes</p>",b.accessCode&&(a+="<p><strong>Access Code:</strong> "+h(b.accessCode)+"</p>"),a+="<p><strong>Calculator:</strong> "+(b.calculatorEnabled?"Enabled":"Disabled")+"</p>",a+="</div></div>"),n.innerHTML=a,n.querySelectorAll("[data-edit-question]").forEach(function(r){r.addEventListener("click",function(){var i=parseInt(this.getAttribute("data-edit-question"));Ee(3),setTimeout(function(){var s=document.querySelectorAll(".question-card");s[i]&&(s[i].scrollIntoView({behavior:"smooth",block:"center"}),s[i].classList.add("ring-2","ring-primary","ring-offset-2"),setTimeout(function(){s[i].classList.remove("ring-2","ring-primary","ring-offset-2")},2e3))},100)})})}}function Pc(){if(!b.pollName||b.pollName.trim()===""){alert("Please enter a poll name."),Ee(2);return}if(!b.className||b.className.trim()===""){alert("Please select a class."),Ee(2);return}if(b.questions.length===0){alert("Please add at least one question."),Ee(3);return}for(var e=0;e<b.questions.length;e++){var n=b.questions[e];if(!n.questionText||n.questionText.trim()===""){alert("Question "+(e+1)+" is missing the question text."),Ee(3);return}for(var t=!1,a=0;a<n.options.length;a++)if(n.options[a].text&&n.options[a].text.trim()!==""){t=!0;break}if(!t){alert("Question "+(e+1)+" needs at least one answer choice."),Ee(3);return}}if(b.mode==="secure"&&(!b.timeLimitMinutes||b.timeLimitMinutes<=0)){alert("Please set a time limit for secure assessments."),Ee(2);return}var r=b.questions.map(function(v){var y=v.options.filter(function(C){return C.text&&C.text.trim()!==""});y.length<2&&(y=[{text:"Option A",imageURL:null,imageFileId:null},{text:"Option B",imageURL:null,imageFileId:null}]);var E=null;if(v.correctAnswerIndex!==void 0&&v.correctAnswerIndex!==null){var q=v.options[v.correctAnswerIndex];q&&q.text&&q.text.trim()!==""&&(E=q.text.trim())}!E&&y.length>0&&(E=y[0].text);var B=v.correctAnswerIndex!==void 0&&v.correctAnswerIndex<y.length?v.correctAnswerIndex:0,x=y[B].id;return{questionText:v.questionText?v.questionText.trim():"",html:v.html||v.questionText||"",delta:v.delta||null,questionImageURL:v.questionImageURL&&v.questionImageURL!=="UPLOADING"?v.questionImageURL:null,questionImageFileId:v.questionImageFileId||null,options:y.map(function(C){return{id:C.id||$e(),text:C.text?C.text.trim():"",html:C.html||C.text||"",delta:C.delta||null,imageURL:C.imageURL&&C.imageURL!=="UPLOADING"?C.imageURL:null,imageFileId:C.imageFileId||null}}),correctAnswer:E,correctAnswerId:x,timerSeconds:v.timerSeconds||null,metacognitionEnabled:!!v.metacognitionEnabled,metaPromptHtml:v.metaPromptHtml||null,metaPromptDelta:v.metaPromptDelta||null,metaPromptText:v.metaPromptText||null}}),i={sessionType:b.mode==="secure"?"SECURE_ASSESSMENT":"LIVE_POLL"};b.mode==="secure"&&(i.timeLimitMinutes=parseInt(b.timeLimitMinutes)||60,i.accessCode=b.accessCode||"",i.calculatorEnabled=b.calculatorEnabled===!0);var s=document.getElementById("wizard-publish-btn"),d=b.isEditMode?"Updating":"Publishing",o=b.isEditMode?"save":"rocket_launch";s&&(s.disabled=!0,s.innerHTML='<span class="material-symbols-outlined animate-spin">hourglass_empty</span> '+d+"..."),console.log(d+" poll:",b.pollName,b.className,r,i);var l=firebase.functions();if(b.isEditMode&&b.pollId){var c=b.pollId,u={pollId:c,pollName:b.pollName.trim(),className:b.className.trim(),questions:r,metadata:i},m=l.httpsCallable("updatePoll");m(u).then(async function(v){console.log("Poll updated via Cloud Function:",v.data),await S("Poll updated successfully!",{title:"Success"});var y={pollId:c,pollName:u.pollName,className:u.className,questions:u.questions,metadata:u.metadata,success:!0};mo(y)}).catch(async function(v){console.error("Cloud Function Update Error:",v),await S("Failed to update: "+(v.message||"Unknown error"),{title:"Error",destructive:!0}),s&&(s.disabled=!1,s.innerHTML='<span class="material-symbols-outlined">'+o+"</span> Update Poll")})}else{var g={pollName:b.pollName.trim(),className:b.className.trim(),questions:r,metadata:i},p=l.httpsCallable("createPoll");p(g).then(async function(v){console.log("Poll created via Cloud Function:",v.data),await S("Poll published successfully!",{title:"Success"});var y={pollId:v.data.pollId,pollName:g.pollName,className:g.className,questions:g.questions,metadata:g.metadata,success:!0};mo(y)}).catch(async function(v){console.error("Cloud Function Create Error:",v),await S("Failed to publish: "+(v.message||"Unknown error"),{title:"Error",destructive:!0}),s&&(s.disabled=!1,s.innerHTML='<span class="material-symbols-outlined">'+o+"</span> Publish Poll")})}}window.showDashboard=Fe,window.openPollCreator=Id,window.openPollWizard=ra,window.closePollWizard=uo,window.initWizardState=na,window.selectPollMode=xc,window.wizardGoNext=bc,window.wizardGoBack=yc,window.goToWizardStep=Ee,window.goToWizardStep=Ee,window.addWizardQuestion=kc,window.removeWizardQuestion=Ic,window.endSession=ia,window.publishWizardPoll=Pc,window.filterStudentsByFlag=Bl,window.clearStudentFilter=Tl,window.sortStudentsBy=ql,window.updateLiveView=sn,window.endSession=ia,I("header-stop-btn",function(){f&&f.pollId&&ia(f.pollId)}),I("fab-stop-btn",function(){f&&f.pollId&&ia(f.pollId)}),I("mobile-stop-btn",function(){f&&f.pollId&&ia(f.pollId)});async function ia(e){if(!e){console.error("endSession called without pollId");return}if(confirm("Are you sure you want to end this session? This will stop all student activity and finalize the results.")){var n=document.getElementById("header-stop-btn"),t=document.getElementById("fab-stop-btn"),a=document.getElementById("mobile-stop-btn"),r=[n,t,a].filter(Boolean);r.forEach(function(u){u.disabled=!0,u.innerHTML='<span class="material-symbols-outlined animate-spin">hourglass_empty</span> Ending...'});try{var i=firebase.functions().httpsCallable("finalizeSession"),s=await i({pollId:e});console.log("Session finalized:",s.data),await S("Session ended successfully. Results have been saved to history.",{title:"Session Ended"});var d=document.getElementById("live-view"),o=document.getElementById("header-live"),l=document.getElementById("header-default");d&&(d.style.display="none"),o&&(o.style.display="none"),l&&(l.style.display="flex");var c=document.getElementById("fab-container");c&&(c.style.display="none"),typeof Fe=="function"?Fe():window.location.reload()}catch(u){console.error("Failed to end session:",u),await S("Failed to end session: "+(u.message||"Unknown error"),{title:"Error",destructive:!0}),r.forEach(function(m){m.disabled=!1,m.id==="fab-stop-btn"?m.innerHTML='<span class="material-symbols-outlined">stop</span>':m.id==="mobile-stop-btn"?m.innerHTML='<span class="material-symbols-outlined text-base">stop_circle</span><span>End</span>':m.innerHTML='<span class="material-symbols-outlined text-base">stop_circle</span> End Session'})}}}function Xa(e){console.log("[Optimization] Handling lightweight update:",e);var t=e.questionIndex,a=f&&f.questions?f.questions[t]:null;if(Kd(e.pollId,{questionIndex:t,status:e.status,sessionPhase:e.metadata?e.metadata.sessionPhase:"LIVE",resultsVisibility:e.metadata?e.metadata.resultsVisibility:"HIDDEN",questionText:a?a.questionText:"",questionImageURL:a?a.questionImageURL:"",options:a?a.options:[]}),!f||!f.questions){console.warn("[Optimization] CURRENT_POLL_DATA missing, falling back to full refresh");var n=ae.find(function(s){return s.pollId===e.pollId});if(n&&n.questions){f=n;var a=n.questions[e.questionIndex];if(a){Xa(e);return}}console.error("[Firebase] Failed to locate poll definition for sync:",e.pollId);return}var t=e.questionIndex,a=f.questions[t];if(!a){console.error("[Optimization] Question definition not found for index:",t);return}var r=H;if(!r||r.length===0){var i=f?f.className:null;if(console.log("[Optimization] No students loaded, searching for roster. className:",i),i&&Y&&Y[i]&&Y[i].length>0){console.log("[Optimization] Found roster in memory:",Y[i].length,"students"),H=Y[i].map(function(s){return{name:s.name||"",email:s.email||"",firstName:(s.name||"").split(" ")[0]||"",lastName:(s.name||"").split(" ").slice(1).join(" ")||"",status:"Waiting...",statusNote:"waiting",answer:"---",isCorrect:null,confidence:null,timestamp:9999999999999}}),vn(e,a,t,H);return}if(f&&f.roster&&f.roster.length>0){console.log("[Optimization] Found roster in poll definition:",f.roster.length,"students"),H=f.roster.map(function(s){return{name:s.name||"",email:s.email||"",firstName:(s.name||"").split(" ")[0]||"",lastName:(s.name||"").split(" ").slice(1).join(" ")||"",status:"Waiting...",statusNote:"waiting",answer:"---",isCorrect:null,confidence:null,timestamp:9999999999999}}),vn(e,a,t,H);return}if(i){console.log("[Optimization] Fetching roster from Firebase for class:",i),firebase.database().ref("rosters/rosters/"+i).once("value").then(function(s){var d=s.val();d&&Array.isArray(d)&&d.length>0?(console.log("[Optimization] Loaded",d.length,"students from Firebase"),H=d.map(function(o){return{name:o.name||"",email:o.email||"",firstName:(o.name||"").split(" ")[0]||"",lastName:(o.name||"").split(" ").slice(1).join(" ")||"",status:"Waiting...",statusNote:"waiting",answer:"---",isCorrect:null,confidence:null,timestamp:9999999999999}}),Xa(e)):(console.warn("[Optimization] No roster found in Firebase for class:",i),vn(e,a,t,[]))}).catch(function(s){console.error("[Optimization] Failed to fetch roster from Firebase:",s),vn(e,a,t,[])});return}console.warn("[Optimization] No roster source available"),vn(e,a,t,[]);return}vn(e,a,t,r)}function vn(e,n,t,a){var r={pollId:e.pollId,status:e.status,questionIndex:t,pollName:f.pollName,questionText:n.questionText,questionImageURL:n.questionImageURL,options:n.options||[],totalQuestions:f.questions.length,correctAnswer:n.correctAnswer,timerSeconds:n.timerSeconds,metadata:e.metadata,authoritativeStatus:"LIVE",results:{},totalResponses:0,totalStudents:a.length,studentStatusList:a.map(function(i){return Object.assign({},i,{status:"Waiting...",statusNote:"waiting",answer:"---",isCorrect:null,confidence:null,timestamp:9999999999999})})};sn(r),setTimeout(function(){console.log("[Optimization] Triggering background fetch for consistency"),Ce=!1,Tt()},500)}var bt=null,Ja=null,Za=null;window.openFormulaModal=function(e,n,t){bt=e,Ja=n,Za=t||null;var a=document.getElementById("formula-modal"),r=document.getElementById("math-editor-field");if(a&&r){if(t){var i=t.value();r.value=typeof i=="string"?i:""}else r.value="";a.classList.remove("hidden"),a.classList.add("flex"),setTimeout(function(){r.focus()},50)}},window.closeFormulaModal=function(){var e=document.getElementById("formula-modal");e&&(e.classList.add("hidden"),e.classList.remove("flex"),bt=null,Ja=null,Za=null)},window.insertFormula=function(){var e=document.getElementById("math-editor-field");if(bt&&e){var n=e.value;if(Za){var t=bt.getIndex(Za);bt.deleteText(t,1),bt.insertEmbed(t,"formula",n)}else{var t=Ja?Ja.index:bt.getLength();bt.insertEmbed(t,"formula",n)}closeFormulaModal()}},(function(){var n=document.getElementById("close-formula-modal"),t=document.getElementById("cancel-formula-btn"),a=document.getElementById("insert-formula-btn");n&&(n.onclick=window.closeFormulaModal),t&&(t.onclick=window.closeFormulaModal),a&&(a.onclick=window.insertFormula)})();function Fc(){var e=document.getElementById("calculator-draggable"),n=document.getElementById("calculator-drag-handle"),t=document.getElementById("header-calc-toggle");if(!e||!n||!t)return;t.addEventListener("click",function(){var p=e.classList.contains("hidden");p?(e.classList.remove("hidden"),t.classList.add("bg-white","text-indigo-600","shadow-inner"),t.classList.remove("text-gray-600")):(e.classList.add("hidden"),t.classList.remove("bg-white","text-indigo-600","shadow-inner"),t.classList.add("text-gray-600"))});var a=!1,r,i,s,d,o=0,l=0;n.addEventListener("mousedown",c),document.addEventListener("mouseup",u),document.addEventListener("mousemove",m);function c(p){s=p.clientX-o,d=p.clientY-l,(p.target===n||n.contains(p.target))&&(a=!0)}function u(p){s=r,d=i,a=!1}function m(p){a&&(p.preventDefault(),r=p.clientX-s,i=p.clientY-d,o=r,l=i,g(r,i,e))}function g(p,v,y){y.style.transform="translate3d("+p+"px, "+v+"px, 0)"}}setTimeout(function(){Fc(),console.log("[Info] Calculator System Initialized")},1e3),document.querySelectorAll('[data-close-inspector="true"]').forEach(function(e){e.addEventListener("click",function(){var n=document.getElementById("student-inspector-modal");n&&n.classList.add("hidden")})});function vo(e){if(!(!f.questions||!f.questions[e])){var n=f.questions[e],t=document.getElementById("live-question-text");t&&(t.textContent=n.questionText||"");var a=document.getElementById("live-question-image-container"),r=document.getElementById("live-question-image");if(a&&r){var i=ri(n.questionImage||n.questionImageURL,n.questionImageFileId);i?(r.src=i,a.classList.remove("hidden")):a.classList.add("hidden")}var s=document.getElementById("results-bars");if(s){s.innerHTML="";var d=n.answers||n.options||[];d.length>0&&d.forEach(function(l,c){var u=document.createElement("div");u.className="mb-3";var m=String.fromCharCode(65+c);u.innerHTML=`
                        <div class="flex justify-between text-sm mb-1">
                           <span class="font-bold">${m}. ${h(l.text||"")}</span>
                           <span class="text-gray-400 text-xs">Waiting...</span>
                        </div>
                        <div class="h-8 w-full bg-gray-100 rounded-lg overflow-hidden relative">
                           <div class="h-full bg-gray-200" style="width: 0%"></div>
                        </div>
                     `,s.appendChild(u)})}var o=document.getElementById("live-question-info");o&&(o.textContent="Q"+(e+1)+" / "+f.questions.length)}}function Oc(){if(we!==null){var e=f.pollId,n=we,t=f.questions&&f.questions[n]?f.questions[n]:null,a=document.getElementById("header-present-btn");a&&G(a,!0);var r=firebase.functions().httpsCallable("setLiveSessionState");r({pollId:e,questionIndex:n,status:"OPEN",questionText:t?t.questionText:"",options:t?t.options:[],correctAnswer:t?t.correctAnswer:""}).then(function(){a&&G(a,!1),a&&a.classList.add("hidden")}).catch(function(i){a&&G(a,!1),F(i)})}}})();
