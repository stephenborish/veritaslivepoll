import"./firebase-QpG6acjP.js";import"./proctoring-CP4HimPX.js";(function(){console.log("Veritas Student Script IIFE executing...");var F=document.getElementById("individual-timed-session"),vn=document.getElementById("secure-progress-label"),Me=document.getElementById("secure-countdown"),j=document.getElementById("secure-topbar-timer"),we=document.getElementById("timer-visibility-toggle"),te=document.getElementById("question-progress"),gn=document.getElementById("student-mode-label"),et=document.getElementById("question-content"),tt=document.getElementById("question-visual"),yn=document.getElementById("secure-question-layout"),pn=document.getElementById("secure-question-visual"),Ne=document.getElementById("secure-connection-dot"),kt=document.getElementById("secure-connection-indicator"),bn=document.getElementById("secure-connection-status"),Be=document.getElementById("secure-connection-warning"),$=document.getElementById("secure-question-text"),_t=document.getElementById("secure-question-subline"),X=document.getElementById("secure-question-image"),O=document.getElementById("secure-options-list"),H=document.getElementById("secure-submit-btn"),nt=document.getElementById("secure-submit-label"),st=document.getElementById("secure-submit-hint"),J=document.getElementById("secure-confidence-prompt"),me=!1,it="00:00",ot=0,hn=document.body,Se=null,U=null,rt=null,K=null,ne=null,ve=null,at=-1,lt=null,Pt=null,ct="vlp_poll_state_cache",ls=300*1e3;function cs(e){if(!(!e||!e.pollId))try{var t={state:e,cachedAt:Date.now()};sessionStorage.setItem(ct,JSON.stringify(t)),console.log("[StateCache] Cached poll state for:",e.pollId)}catch(n){console.warn("[StateCache] Failed to cache state:",n)}}function us(){try{var e=sessionStorage.getItem(ct);if(!e)return null;var t=JSON.parse(e),n=Date.now()-t.cachedAt;return n>ls?(console.log("[StateCache] Cache expired (age:",Math.round(n/1e3),"s)"),sessionStorage.removeItem(ct),null):(console.log("[StateCache] Found valid cache (age:",Math.round(n/1e3),"s)"),t.state)}catch(s){return console.warn("[StateCache] Failed to read cache:",s),null}}function ds(){try{sessionStorage.removeItem(ct)}catch{}}function fs(){var e=us();if(!e)return console.log("[StateRehydration] No valid cached state found"),!1;if(console.log("[StateRehydration] Rehydrating from cache immediately"),e.status==="ENDED"||e.status==="CLOSED")return console.log("[StateRehydration] Cached state is ENDED/CLOSED, clearing cache"),ds(),!1;try{return Ee(e),console.log("[StateRehydration] Successfully rendered from cache"),!0}catch(t){return console.error("[StateRehydration] Failed to render cached state:",t),!1}}var ge=(function(){var e={};return{attach:function(t,n,s,i){this.detach(t),n.on(s,i),e[t]={ref:n,eventType:s,callback:i,attachedAt:Date.now()},console.log("[ListenerManager] Attached listener: "+t)},detach:function(t){if(e[t]){var n=e[t];try{n.ref.off(n.eventType,n.callback),console.log("[ListenerManager] Detached listener: "+t)}catch(s){console.warn("[ListenerManager] Error detaching "+t+":",s)}delete e[t]}},detachAll:function(){var t=Object.keys(e);t.forEach(function(n){ge.detach(n)}),console.log("[ListenerManager] Detached all listeners ("+t.length+" total)")},getActiveCount:function(){return Object.keys(e).length},listActive:function(){return Object.keys(e)}}})();if(typeof firebase<"u"&&typeof FIREBASE_CONFIG<"u"){if(!firebase.apps.length)try{firebase.initializeApp(FIREBASE_CONFIG),console.log("[Init] Firebase initialized eagerly")}catch(e){console.error("[Init] Firebase eager init failed:",e)}firebase.apps.length&&(U=firebase.database(),firebase.functions&&(rt=firebase.functions()))}function ms(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}function ut(e){if(!e)return"";var t=e;return typeof DOMPurify<"u"?t=DOMPurify.sanitize(e,{ADD_TAGS:["math","annotation","semantics","mrow","mi","mo","mn","msup","sub","sup"],ADD_ATTR:["class","style"]}):console.warn("DOMPurify not loaded - rendering as raw HTML"),'<div class="ql-editor">'+t+"</div>"}function Mt(){window.renderMathInElement&&renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})}async function En(e,t){if(!(!FIREBASE_CONFIG||!e||!t)){if(ve&&ve!==e&&(console.log("[Firebase] PollId changed from "+ve+" to "+e+" - Cleaning up via ListenerManager..."),ge.detachAll(),K=null,lt=null,Pt=null,ve=null),K&&ve===e){console.log("[Firebase] Already initialized for pollId: "+e+" (Active listeners: "+ge.getActiveCount()+")");return}if(typeof firebase<"u"&&!firebase.apps.length&&firebase.initializeApp(FIREBASE_CONFIG),typeof firebase<"u"){U=firebase.database(),firebase.functions&&(rt=firebase.functions()),ne=await window.VeritasShared.generateStudentKey(t,e),ve=e;var n="sessions/"+e+"/students/"+ne;K=U.ref(n),K.once("value").then(function(c){var r=c.val(),u=!r||typeof r!="object";if(u){var f={status:"ACTIVE",name:window.STUDENT_NAME||"Unknown",email:window.STUDENT_EMAIL||"unknown",joinedAt:firebase.database.ServerValue.TIMESTAMP,lockVersion:0,userAgent:navigator.userAgent};K.set(f),console.log("[Firebase] Initialized student state object:",f)}else(r.status==="DISCONNECTED"||!r.status)&&K.update({status:"ACTIVE",lastActiveAt:firebase.database.ServerValue.TIMESTAMP})}),K.onDisconnect().update({status:"DISCONNECTED",lastDisconnectedAt:firebase.database.ServerValue.TIMESTAMP});var s=function(c){var r=c.val();ys(r)};ge.attach("studentStatus_"+e,K,"value",s),Pt=U.ref(".info/connected");var i=function(c){var r=c.val()===!0;vs(r),r?(console.log("[Adaptive Polling] Firebase connected - switching to balanced poll (5s)"),Ie=5e3,console.log("[Connectivity Recovery] Reconnected - triggering soft poll to sync state"),typeof oe=="function"&&oe(!0)):(console.log("[Adaptive Polling] Firebase disconnected - switching to fast poll (2.5s)"),Ie=2500)};ge.attach("connectionState",Pt,"value",i);var o="sessions/"+e+"/live_session";lt=U.ref(o);var a=!1,l=function(c){var r=c.val();if(r){if(console.log("[Firebase] Live Session update received:",r),typeof r.questionIndex=="number"){var u=r.questionIndex;at!==u&&console.log("[Sync Spine] Server question index ("+u+") differs from local ("+at+") - forcing sync")}if(r.questionText&&r.pollId&&typeof Ee=="function"){console.log("[Firebase] Fast Path: Updating view from pushed state");var f={pollId:r.pollId,questionIndex:r.questionIndex,status:r.status||"OPEN",questionText:r.questionText,questionImageURL:r.questionImageURL,options:r.options||[],totalQuestions:r.totalQuestions,sessionPhase:r.sessionPhase||r.metadata&&r.metadata.sessionPhase||"LIVE",resultsVisibility:r.resultsVisibility||r.metadata&&r.metadata.resultsVisibility||"HIDDEN"};if(r.metadata)for(var m in r.metadata)f.hasOwnProperty(m)||(f[m]=r.metadata[m]);Ee(f),setTimeout(Mt,50)}else r.status&&r.status!=="OPEN"&&(console.log("[Firebase] Fast Path (Status Only): Processing status change to "+r.status),typeof Ee=="function"&&Ee({pollId:r.pollId||e,questionIndex:r.questionIndex,status:r.status,sessionPhase:r.sessionPhase||"LIVE"})),console.log("[Firebase] Slow Path: Incomplete data, polling server to ensure consistency"),oe(!0)}};ge.attach("liveSession_"+e,lt,"value",l),console.log("[Firebase] Fetching initial live_session state..."),lt.once("value").then(function(c){var r=c.val();r&&!a&&(console.log("[Firebase] Initial state fetched:",r.status),a=!0,l(c))}).catch(function(c){console.warn("[Firebase] Initial fetch failed:",c)}),console.log("[Firebase] Sidecar initialized for",n,"(Listeners: "+ge.getActiveCount()+")")}}}var dt=!1,R=null;function vs(e){R||(R=document.createElement("div"),R.id="connectivity-toast",R.className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] px-6 py-3 rounded-full shadow-lg transition-all duration-300 flex items-center gap-3",R.style.cssText="opacity: 0; pointer-events: none;",document.body.appendChild(R)),!e&&!dt?(R.innerHTML='<span class="inline-block w-3 h-3 rounded-full bg-amber-400 animate-pulse"></span><span class="font-semibold text-amber-900">Reconnecting...</span>',R.className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] px-6 py-3 rounded-full shadow-lg transition-all duration-300 flex items-center gap-3 bg-amber-100 border border-amber-300",R.style.opacity="1",R.style.pointerEvents="auto",dt=!0,console.log("[Connectivity] Showing reconnecting toast")):e&&dt&&(R.innerHTML='<span class="inline-block w-3 h-3 rounded-full bg-emerald-500"></span><span class="font-semibold text-emerald-900">Connected</span>',R.className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] px-6 py-3 rounded-full shadow-lg transition-all duration-300 flex items-center gap-3 bg-emerald-100 border border-emerald-300",setTimeout(function(){R.style.opacity="0",R.style.pointerEvents="none",dt=!1,console.log("[Connectivity] Hiding toast - connection restored")},2e3))}async function wn(e,t,n,s,i,o,a){if(!U)return console.warn("[Firebase] DB not initialized, skipping fast write"),null;try{var l=o||window.STUDENT_EMAIL||sessionStorage.getItem("veritas_student_email");if(!l)return console.error("[Firebase] Cannot submit answer - no email found"),null;var c=ms(),r=new Date().toISOString(),u={responseId:c,pollId:e,questionIndex:t,answer:n,answerId:s,studentEmail:l,confidenceLevel:i||null,timestamp:r,clientTimestamp:Date.now(),timeOnQuestionMs:a?a.timeOnQuestion:null,usingCalculator:a?a.usingCalculator:!1,activityStatus:a?a.status:null},f=ne||l.replace(/\./g,",");if(!f)return console.error("[Firebase] No student key available for submission"),null;var m="answers/"+e+"/"+f,p=U.ref(m).set(u),I="sessions/"+e+"/students/"+f,L={status:"Submitted",lastActive:firebase.database.ServerValue.TIMESTAMP,lastSubmissionQuestionIndex:t,lastSubmissionTimestamp:firebase.database.ServerValue.TIMESTAMP},Q=U.ref(I).update(L);return await Promise.all([p,Q]),console.log("[Firebase] DUAL-WRITE successful:"),console.log("  - Answer path: "+m),console.log("  - Status path: "+I),{success:!0,responseId:c,timestamp:r}}catch(G){return console.error("[Firebase] Fast Answer Failed:",G),null}}var gs=(function(){var e=null;function t(){var n=[],s=null,i=null,o=null,a=null,l=null;document.hasFocus();var c=null,r=3e3,u=50;function f(w,D,B){s=w,i=D||"",o=B,a=Date.now(),l=null,c||(c=setInterval(re,r)),window._activityTrackerFocusAttached||(window.addEventListener("focus",G),window.addEventListener("blur",de),window._activityTrackerFocusAttached=!0),p("QUESTION_VIEW",{viewedAt:Date.now(),questionIndex:B})}function m(w){a=w||Date.now()}function p(w,D){if(s){var B={pollId:s,sessionId:i,questionIndex:o!==void 0?o:"",eventType:w,eventData:D||{},clientTimestamp:new Date().toISOString()};n.push(B),n.length>=u&&re()}}function I(w,D){var B=D?"ANSWER_CHANGED":"ANSWER_SELECTED",fe=a?Date.now()-a:0;p(B,{answer:w,previousAnswer:l,timeOnQuestionMs:fe}),l=w}function L(w,D){var B=a?Date.now()-a:0;p("ANSWER_SUBMITTED",{answer:w,confidenceLevel:D||null,timeOnQuestionMs:B,totalTimeMs:B})}function Q(w,D){p("OPTION_CLICKED",{optionIndex:w,optionText:D})}function G(){p("FOCUS_GAINED",{timestamp:Date.now()})}function de(){p("FOCUS_LOST",{timestamp:Date.now()})}async function re(){if(!(n.length===0||!U)){var w=n.slice();n=[];var D=ve||(w.length>0?w[0].pollId:null);if(!D||!ne){n=w.concat(n);return}try{var B=U.ref("sessions/"+D+"/activities/"+ne),fe={};w.forEach(function(d){var v=B.push().key;fe[v]=d}),await B.update(fe),console.log("[ActivityTracker] (Firebase) Flushed "+w.length+" events")}catch(d){console.error("[ActivityTracker] Firebase Flush failed:",d),n=w.concat(n)}}}function Pe(){re(),s=null,i=null,o=null,a=null,l=null}function Tt(){c&&(clearInterval(c),c=null),re()}return{init:f,setQuestionStart:m,recordActivity:p,recordAnswerSelected:I,recordAnswerSubmitted:L,recordOptionClick:Q,flushActivities:re,reset:Pe,destroy:Tt}}return{getInstance:function(){return e||(e=t()),e}}})(),Nt=gs.getInstance();function ys(e){console.log("[Firebase] Remote status update:",e);var t;if(typeof e=="string")t=e;else if(e&&typeof e=="object")t=e.status;else{console.warn("[Firebase] Invalid status data received:",e);return}if(t==="LOCKED"){if(!_.isLocked()){var n=e&&e.lastViolationReason||"Teacher Remote Lock";_.lock(n)}}else if(t==="ACTIVE"||t==="AWAITING_FULLSCREEN"){var s=_.isLocked()||Rt();s?(console.log("[Firebase] Unlock signal received - checking server for AWAITING_FULLSCREEN"),checkProctorState()):console.log("[Firebase] Unlock signal received but not locally locked - ignoring")}else t==="DISCONNECTED"&&console.log("[Firebase] Detected DISCONNECTED state - will recover on reconnect")}function ye(e,t){e&&sessionStorage.setItem("lock_reason",e);var n=t||A&&A.pollId||x&&x.pollId||window.currentPollId;if(!n)try{n=sessionStorage.getItem("veritas_active_poll_id")}catch{}if(K){if(K.update({status:"LOCKED",lastViolationReason:e,lastViolationAt:firebase.database.ServerValue.TIMESTAMP}).catch(function(a){console.error("[Firebase] Failed to report violation lock:",a)}),e&&n&&(window.studentKey||ne)){var s=window.studentKey||ne,i=U.ref("sessions/"+n+"/violations/"+s);i.push({reason:e,timestamp:firebase.database.ServerValue.TIMESTAMP})}}else if(U&&n&&(window.studentKey||ne)){var s=window.studentKey||ne,o="sessions/"+n+"/students/"+s;K=U.ref(o),ye(e,n)}else console.log("[Firebase] RTDB Ref not ready - relying on Cloud Function for violation report")}var ft=(function(){var e;function t(){var n=Date.now(),s=Date.now(),i=!1;function o(){n=Date.now()}function a(u){s=u||Date.now()}function l(u){i=!!u}function c(){var u=Date.now(),f=u-n,m=f>3e4?"IDLE":i?"CALCULATOR":"ACTIVE";return{status:m,lastInteraction:n,currentQuestionStart:s,timeOnQuestion:Math.max(0,u-s),usingCalculator:i}}function r(){["click","mousemove","keydown","touchstart"].forEach(function(f){document.addEventListener(f,o,{passive:!0})});var u=document.getElementById("calc-iframe");u&&(u.addEventListener("focus",function(){l(!0),o()}),u.addEventListener("blur",function(){l(!1)}))}return r(),{markInteraction:o,setQuestionStart:a,setCalculatorState:l,getTelemetry:c}}return{getInstance:function(){return e||(e=t()),e}}})(),Bt=null,Dt=null,De=null;try{window.SecureAssessmentShared?(Bt=window.SecureAssessmentShared.createCountdown({onTick:function(e){Ss(e)},onExpire:function(){Is()}}),Dt=window.SecureAssessmentShared.createHeartbeat({intervalMs:3500,onBeat:function(){Pn()}}),De=window.SecureAssessmentShared.createFullscreenManager(document,{onChange:Ys})):console.error("[Proctor] SecureAssessmentShared dependency is missing. Secure features will be disabled.")}catch(e){console.error("[Proctor] Failed to initialize SecureAssessmentShared modules:",e)}var Sn=null,mt=null,Ft=null;we&&we.addEventListener("click",function(){me=!me,bt()}),bt();var M=!1,E=null,z=null,vt=null,se=!1,gt=!1,yt=!1,Ot=!1,Fe=null,ie={views:["entry-screen","secure-lobby","status-container","pre-live-card","student-container","question-container","individual-timed-session","student-loader"],show:function(e){var t=["question-container","pre-live-card","status-container"].indexOf(e)!==-1;this.views.forEach(function(n){var s=document.getElementById(n);s&&(n===e||n==="student-container"&&t?(s.style.display="block",s.classList.remove("hidden")):(s.style.display="none",s.classList.add("hidden")))}),console.log("[ViewManager] Active View:",e)}};window.onerror=function(e,t,n,s,i){var o=document.getElementById("debug-content");if(o){var a=new Date().toLocaleTimeString();o.innerHTML+=`
[${a}] ERROR: ${e}
Line: ${n}`;var l=document.getElementById("debug-overlay");l&&e.indexOf("ScriptError")===-1&&l.classList.remove("hidden")}return!1};var _={isLocked:function(){try{return sessionStorage.getItem("veritas_lock_active")==="true"}catch{return!1}},lock:function(e){console.warn("[LockManager] LOCKING:",e);try{sessionStorage.setItem("veritas_lock_active","true"),sessionStorage.setItem("lock_reason",e||"unknown")}catch{}this.renderLockScreen(e);var t=typeof A<"u"&&A&&A.pollId||typeof x<"u"&&x&&x.pollId||typeof E<"u"&&E&&E.pollId||window.currentPollId;if(!t)try{t=sessionStorage.getItem("veritas_active_poll_id")}catch{}if(!t){console.error("[LockManager] CRITICAL: No pollId available for violation report!");return}typeof ye=="function"&&ye(e,t);var n=window.STUDENT_EMAIL||"";if(!n)try{n=sessionStorage.getItem("veritas_student_email")||""}catch{}console.log("[LockManager] Violation reported via Firebase path")},unlock:function(){console.log("[LockManager] UNLOCKING");try{sessionStorage.removeItem("veritas_lock_active"),sessionStorage.removeItem("lock_reason")}catch{}At()},renderLockScreen:function(e){V(e)}};function xn(){try{console.log("[Proctor] ANTIDOTE - Clearing Poison Pill lock state"),sessionStorage.removeItem("veritas_lock_active"),sessionStorage.removeItem("is_locally_locked"),sessionStorage.removeItem("lock_reason"),sessionStorage.removeItem("lock_timestamp")}catch(e){console.warn("[Proctor] Could not clear lock from sessionStorage:",e)}}function Rt(){try{return sessionStorage.getItem("veritas_lock_active")==="true"}catch{return!1}}function ps(){return M?"Secure Assessment":"Live Poll"}function qt(e){gn&&(gn.textContent=e?"Secure Assessment":"Live Poll"),j&&(j.classList.toggle("hidden",!e),e&&Me&&(Me.textContent=it||"00:00"))}function In(e){var t=Math.floor(e/60),n=e%60;return("0"+t).slice(-2)+":"+("0"+n).slice(-2)}function Vt(e,t){if(te){var n=typeof e=="number"?e:parseInt(e,10),s=typeof t=="number"?t:parseInt(t,10),i=isNaN(n)?0:Math.max(0,n),o=isNaN(s)||s<=0?"?":Math.max(1,s);te.textContent="QUESTION "+(i+1)+" OF "+o,te.classList.remove("hidden")}}function bs(e){return!e||!e.question?null:e.question.id?e.question.id:e.question.questionId?e.question.questionId:typeof e.actualQuestionIndex=="number"?(e.pollId||"poll")+":"+e.actualQuestionIndex:(e.pollId||"poll")+":"+(e.progressIndex||0)}function Ut(e){hn&&hn.classList.toggle("secure-mode-active",!!e)}function pt(e){kt&&(e?kt.classList.remove("hidden"):kt.classList.add("hidden"))}function Ln(){if(O){var e=O.querySelectorAll("button.secure-answer-option");e.forEach(function(t){var n=parseInt(t.dataset.optionIndex,10),s=n===z;t.classList.toggle("answer-option-selected",s),t.setAttribute("aria-pressed",s?"true":"false")})}}function Cn(e){if(_.isLocked()){console.log("[Proctor] showIndividualTimedView BLOCKED - Lock active"),_.renderLockScreen(sessionStorage.getItem("lock_reason"));return}if(ln(),ae&&(ae.style.display="none"),k&&(k.style.display="none"),W&&(W.style.display="none"),P.style.display="block",y.style.display="none",g.style.display="none",xe&&(xe.style.display="none"),F&&(F.style.display="block"),document.body.style.overflow="hidden",Ut(!0),M||(M=!0,Dt.start(!0)),qt(!0),mn(e.calculatorEnabled),j&&j.classList.remove("hidden"),_s(),pt(!0),Os(),E=e,e&&e.pollId){window.currentPollId=e.pollId;try{sessionStorage.setItem("veritas_active_poll_id",e.pollId)}catch{}}k&&(k.style.display="none"),W&&(W.style.display="none");var t=bs(e),n=vt!==t;if(vt=t,n&&(z=null,Fe=null,Ot=!1,ht(),ft.getInstance().setQuestionStart(Date.now())),se=!1,gt=!1,Oe(!1),te){var s=typeof e.progressIndex=="number"?e.progressIndex:typeof e.currentQuestionIndex=="number"?e.currentQuestionIndex:0,i=typeof e.totalQuestions=="number"?e.totalQuestions:e.question&&e.question.options?e.question.options.length:1;console.log("[Secure] Question progress:",{progressIdx:s,totalCount:i,state:e}),te.textContent="QUESTION "+(s+1)+" OF "+i}else console.warn("[Secure] questionProgressEl not found");hs(e),xs(e.timeRemainingSeconds||0),Yt(e)}function hs(e){if(e){if(_.isLocked()){console.log("[Proctor] renderSecureQuestion BLOCKED - Lock active"),_.renderLockScreen(sessionStorage.getItem("lock_reason"));return}Ot=!!(e.question&&e.question.metacognitionEnabled);var t=typeof e.progressIndex=="number"?e.progressIndex:typeof e.currentQuestionIndex=="number"?e.currentQuestionIndex:0,n=typeof e.totalQuestions=="number"?e.totalQuestions:e.question&&e.question.options?e.question.options.length:0;if(vn&&(vn.textContent="Question "+(t+1)+" of "+n),Vt(t,n),$){var s=e.question.html||e.question.questionText||"";$.innerHTML=ut(s),$.className="ql-editor",$.style.padding="0"}_t&&(_t.classList.add("hidden"),_t.textContent=""),X&&(e.question.questionImageURL?(X.src=e.question.questionImageURL,X.style.display="block"):X.style.display="none");var i=!!e.question.questionImageURL;if(yn&&yn.classList.toggle("no-image",!i),pn&&(pn.style.display=i?"flex":"none"),O){O.innerHTML="";var o="ABCDEFGHIJKLMNOPQRSTUVWXYZ",a=Array.isArray(e.question.options)?e.question.options:[];a.forEach(function(l,c){O.appendChild(Es(l,c,o.charAt(c)||"#"))}),Ln()}Qt()}}function Es(e,t,n){var s=e.isCorrect===!0,i=E&&E.sessionStatus==="REVEAL"||E&&E.question&&E.question.resultsVisibility==="REVEALED",o=document.createElement("li"),a=document.createElement("button");a.type="button",a.className="answer-option secure-answer-option relative w-full text-left",i&&(a.disabled=!0,s?a.classList.add("ring-2","ring-green-500","bg-green-50","dark:bg-green-900/20"):a.classList.add("opacity-75")),a.dataset.optionIndex=t,a.setAttribute("aria-pressed","false");var l=e&&e.text?e.text.toString():"",c=e&&e.html?ut(e.html):Lt(l).replace(/\n/g,"<br>"),r="";return e&&e.imageURL&&(r+='<img src="'+Lt(e.imageURL)+'" alt="Answer '+n+'" class="option-image" referrerpolicy="no-referrer">'),r+='<div class="option-leading">',r+='<div class="letter-badge" aria-hidden="true">'+n+"</div>",r+='<div class="option-body">',r+='<div class="option-text-wrapper">',r+='<div class="option-text ql-editor" style="padding:0;">'+c+"</div>",i&&s&&(r+='<span class="material-symbols-outlined text-green-600 ml-2">check_circle</span>'),r+='<span class="result-ribbon"></span>',r+='<span class="sr-only secure-selection-announcement"></span>',r+="</div>",r+='<span class="percentage-bubble"></span>',r+="</div>",r+="</div>",r+='<span class="result-indicator" aria-hidden="true"></span>',a.innerHTML=r,a.addEventListener("click",function(u){u&&u.target&&u.target.closest(".option-image")||i||ws(t)}),o.appendChild(a),o}function ws(e){O&&(z=e,Ln(),Qt())}function Qt(){if(H){var e=!!E,t=!e||se||gt;if(H.disabled=t,H.classList.toggle("opacity-60",t),nt&&e&&!se){var n=E.progressIndex>=E.totalQuestions-1;nt.textContent=n?"Submit Exam":"Submit & Next"}if(st)if(!e)st.textContent="";else if(typeof z=="number"){var s="ABCDEFGHIJKLMNOPQRSTUVWXYZ",i=s.charAt(z)||"#";st.textContent="Selected "+i+". Submit when ready."}else st.textContent="No answer selected — submitting will record this as blank."}}function Ht(e){se=e,H&&(H.disabled=e,H.classList.toggle("opacity-60",e),nt&&e&&(nt.textContent="Saving..."),e||Qt())}function Oe(e){O&&O.querySelectorAll("button.secure-answer-option").forEach(function(t){t.disabled=e,t.classList.toggle("answer-option-disabled",e)})}function An(e,t,n,s){if(!(!e||se)){if(Ot&&!s){console.log("Metacognition enabled - showing confidence prompt"),Ls(t,n);return}Kt(e,t,n,null)}}function Kt(e,t,n,s,i){if(!(!e||se)){Ht(!0),Oe(!0);var o={pollId:e.pollId,sessionId:e.sessionId,actualQuestionIndex:e.actualQuestionIndex,answer:t||"",answerId:n||null,confidenceLevel:s},a=ft.getInstance().getTelemetry();wn(o.pollId,o.actualQuestionIndex,o.answer,o.answerId,o.confidenceLevel,null,a).then(function(l){if(l&&l.success){console.log("Firebase write success, proceeding with optimistic UI update");try{localStorage.removeItem("secure_pending_answer")}catch{}Ht(!1),Oe(!1),ht(),z=null,E=null,vt=null,$&&($.innerHTML='<div style="display: flex; align-items: center; gap: 12px; padding: 20px 0;"><div style="width: 24px; height: 24px; border: 3px solid rgba(18, 56, 93, 0.2); border-top-color: #12385d; border-radius: 50%; animation: veritas-spin 0.7s linear infinite;"></div><span style="color: #4b5563; font-size: 1.1rem;">Answer Saved. Loading next...</span></div>'),X&&(X.style.display="none"),O&&(O.innerHTML=""),console.log("[Firebase] Submission finalized. Polling for next state."),setTimeout(function(){Pn()},50)}else{console.warn("[Firebase] Write failed. Saving to local backup for manual recovery.");try{localStorage.setItem("secure_pending_answer",JSON.stringify(o))}catch(c){console.error("Failed to backup answer",c)}Ht(!1),Oe(!1),ht(),fn("Submission failed. Your answer is backed up locally. Please check your connection and try again.")}})}}function Tn(){Bt.stop()}function bt(){if(!(!Me||!j)&&(Me.textContent=me?"••:••":it,j.classList.toggle("timer-hidden",me),we)){we.setAttribute("aria-pressed",me?"true":"false"),we.setAttribute("aria-label",me?"Show timer":"Hide timer");var e=we.querySelector(".material-symbols-outlined");e&&(e.textContent=me?"visibility_off":"visibility")}}function Ss(e){if(!(!Me||!j)){var t=Math.max(0,e);it=In(t),j.classList.remove("alert-warning","alert-danger");var n=ot>0?Math.max(0,Math.min(1,t/ot)):1;n<=.1?j.classList.add("alert-danger"):n<=.25&&j.classList.add("alert-warning"),bt()}}function xs(e){var t=Math.max(0,Math.floor(e||0));ot=t||ot,it=In(t),bt(),Bt.start(t)}function Is(){gt||(gt=!0,zt("TIME_UP","Time's up!","Hold tight while we finalize your work."),As(),_n(4e3))}function Ls(e,t){if(J){Fe=e,J.dataset.pendingAnswerId=t||"",$&&($.style.display="none"),X&&(X.style.display="none"),O&&(O.style.display="none"),H&&(H.style.display="none"),J.style.display="block",J.classList.remove("hidden");var n=J.querySelectorAll(".confidence-btn");n.forEach(function(s){s.onclick=function(){var i=s.getAttribute("data-confidence");Cs(i)}})}}function ht(){J&&(J.style.display="none",J.classList.add("hidden"),$&&($.style.display="block"),O&&(O.style.display="block"),H&&(H.style.display="block"))}function Cs(e){if(!(Fe==null||!E)){ht();var t=J.dataset.pendingAnswerId||null;Kt(E,Fe,t,e),Fe=null,J.dataset.pendingAnswerId=""}}function As(e){if(!(!E||se)){var t="",n=null;if(typeof z=="number"){var s=(E.question.options||[])[z];s&&(t=s.text||"",n=s.id)}An(E,t,n,!0)}}function kn(){try{document&&document.fullscreenElement&&document.exitFullscreen&&document.exitFullscreen().catch(function(e){console.warn("Error exiting fullscreen:",e)})}catch(e){console.warn("Unable to exit fullscreen",e)}typeof window<"u"&&typeof window.close=="function"&&window.close()}function Ts(){Se&&(clearTimeout(Se),Se=null)}function _n(e){if(!Se){var t=Math.max(500,Number(e)||2500);Se=setTimeout(function(){Se=null,kn()},t)}}function ks(){Ts(),kn()}function Wt(e,t,n){Tn(),pt(!1),M&&(Dt.stop(),M=!1),qt(!1),E=null,vt=null,z=null,se=!1,typeof Ze=="function"&&Ze(),zt(e,t,n),_n(2500)}function zt(e,t,n){var s="lock",i="text-red-300",o="text-white text-2xl font-semibold",a="text-white/80 text-base mt-4",l=e==="COMPLETED"||e==="ENDED",c=e==="ENDED"?"Exit Session":"Exit Secure Session",r="Use the button below to leave fullscreen and close the secure window when dismissed.";e==="COMPLETED"?(s="task_alt",i="text-green-300",o="text-green-200 text-2xl font-semibold"):e==="TIME_UP"?(s="hourglass_bottom",l=!1):e==="ENDED"?s="info":e==="LOCKED"&&(s="lock",i="text-red-600",o="text-gray-900 text-2xl font-bold",a="text-gray-800 text-base mt-4 whitespace-pre-line",l=!1),Ct({icon:s,iconClass:i,message:t||"",messageClass:o,subtext:n||"",subClass:a,showExitAction:l,exitActionLabel:c,exitActionDescription:r,showResume:!1,lockScroll:!0})}function _s(){document&&document.body&&document.body.classList.remove("secure-overlay-active"),g&&!S&&(g.style.display="none"),b&&(b.style.display="none",b.textContent="")}function Ps(e,t){Tn(),pt(!0),F&&(F.style.display="block"),Oe(!0),zt("LOCKED",e||"Assessment Paused",t),typeof Ze=="function"&&Ze()}function Yt(e){if(!(!e||!Ne)){var t=(e.connectionHealth||"").toUpperCase(),n=["bg-emerald-400","bg-amber-400","bg-red-500"];n.forEach(function(l){Ne.classList.remove(l)});var s="Synced",i="";t==="RED"?(Ne.classList.add("bg-red-500"),s="Connection issue",i="We are reconnecting and saving your work..."):t==="YELLOW"?(Ne.classList.add("bg-amber-400"),s="Reconnecting",i="Syncing your progress..."):(Ne.classList.add("bg-emerald-400"),s="Synced");var o=e.heartbeatLagMs?Math.max(0,Math.round(e.heartbeatLagMs/1e3)):0;if(bn){var a=s;o>0&&(a+=" • "+o+" second lag"),bn.textContent=a}Be&&(i?(Be.textContent=i,Be.classList.remove("hidden")):(Be.textContent="",Be.classList.add("hidden")))}}function Pn(){if(Rt()){console.log("[Proctor] POISON PILL ACTIVE in pollForIndividualSessionState - blocking"),S=!0,V();return}if(!yt){yt=!0,ft.getInstance().getTelemetry();var e=window.STUDENT_EMAIL||sessionStorage.getItem("veritas_student_email"),t=e?e.replace(/[.$#[\]]/g,"_"):"unknown",n=activePollId;Promise.all([firebase.database().ref("sessions/"+n+"/live_session").once("value"),firebase.database().ref("sessions/"+n+"/students/"+t).once("value")]).then(function(s){yt=!1,ae&&(ae.style.display="none");var i=sessionSnap.val()||{status:"CLOSED"},o=studentSnap.val(),a="ACTIVE",l="",c=!1;o&&(typeof o=="object"?(a=o.status||"ACTIVE",l=o.lastViolationReason||"",c=a==="LOCKED"):(a=o,c=a==="LOCKED"));var r={status:a,sessionStatus:i.status,locked:c,message:l,lockReason:l,completed:a==="FINISHED",completed:a==="FINISHED",question:i};if(r.sessionStatus==="PRE_LIVE"||!r.sessionStatus){Gn({status:"LOBBY",pollName:"Wait for teacher..."});return}if(r.status==="LOBBY"){Gn(r);return}ln();var u=(r.lockReason||"").toString().toUpperCase(),f=(r.message||"").toString().toLowerCase(),m=r.locked===!0||u==="FORCED_SUBMIT"||u==="TIME_EXPIRED"||f.indexOf("ended")>=0||f.indexOf("submitted")>=0;r.completed||o.status==="FINISHED"?(Yt(r),Wt("COMPLETED","Assessment Submitted","Your responses have been secured.")):i.status==="ENDED"?(Yt(r),Wt("ENDED","Session Concluded","The session has ended.")):m?Wt("ENDED",r.message||"Assessment Finalized","Your responses have been secured."):r.status==="LOCKED"?(F&&(F.style.display="block"),Ps(r.message||"Locked","Teacher intervention required.")):(r.status==="ACTIVE"||!r.status)&&(r.question=i,r.timeLimitMinutes=i.metadata?i.metadata.timeLimitMinutes:60,Cn(r))}).catch(function(s){yt=!1,fn(s)})}}H&&H.addEventListener("click",function(){if(!(!E||se)){var e="";if(typeof z=="number"){var t=(E.question.options||[])[z];t&&typeof t.text=="string"&&(e=t.text)}An(E,e)}}),X&&X.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault(),window.expandImage&&window.expandImage(this)}),console.log("Student poll script initializing...");try{var Mn=localStorage.getItem("secure_pending_answer");if(Mn){var Re=JSON.parse(Mn);setTimeout(function(){if(confirm("Veritas found an unsaved answer from a previous session. Would you like to retry submitting it?")){var e={pollId:Re.pollId,sessionId:Re.sessionId,actualQuestionIndex:Re.actualQuestionIndex,question:{}};Kt(e,Re.answer,Re.confidenceLevel)}else localStorage.removeItem("secure_pending_answer")},1e3)}}catch(e){console.error("Failed to check backup",e)}var ae=document.getElementById("student-loader"),xe=document.getElementById("pre-live-card"),g=document.getElementById("status-container"),C=document.getElementById("status-message"),y=document.getElementById("question-container"),T=document.getElementById("options-list"),pe=document.getElementById("question-text"),Z=document.getElementById("question-image"),le=document.getElementById("question-subline"),q=document.getElementById("no-responses-message"),k=document.getElementById("entry-screen"),Nn=document.getElementById("start-session-btn"),P=document.getElementById("student-container");Nn&&(console.log("Attaching onclick handler to start session button (Early Bind)"),Nn.onclick=function(){console.log("!!! BEGIN SESSION BUTTON CLICKED !!!"),Rn=!0,k&&(k.style.display="none"),P&&(P.style.display="block"),S=!1,Le=!1,Y=!1,Ve=!1;var e=document.getElementById("resume-controls");e&&(e.style.display="none");try{document.documentElement.requestFullscreen&&document.documentElement.requestFullscreen().catch(function(t){console.warn("Fullscreen denied or failed (benign):",t)})}catch(t){console.warn("Fullscreen execution error:",t)}ze(),oe(!0)}),window.expandImage=function(e){var t=e.src,n='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:pointer;" onclick="this.remove()">';n+='<img src="'+t+'" style="max-width:90%;max-height:90%;"/>',n+="</div>",document.body.insertAdjacentHTML("beforeend",n)},Z&&Z.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault(),window.expandImage(this)}),document.addEventListener("click",function(e){e.target.classList.contains("option-image")&&(e.stopPropagation(),e.preventDefault(),window.expandImage(e.target))}),document.getElementById("pre-live-primary"),document.getElementById("pre-live-subline"),document.getElementById("pre-live-reconnect-line");var Bn=document.getElementById("resume-session-btn"),Gt=document.getElementById("secure-exit-controls"),jt=document.getElementById("secure-exit-description"),Dn=document.getElementById("secure-exit-btn"),Fn=document.getElementById("secure-exit-label"),b=document.getElementById("status-submessage"),On=document.getElementById("connectivity-banner");document.getElementById("connectivity-icon"),document.getElementById("connectivity-message");var $t=document.getElementById("connectivity-submessage"),A={},qe=null,Ie=1500,Xt=8e3,Et=0,S=!1,Le=!1,ce=0,ue=!1,Y=!1,Jt=null,Ve=!1,Ue=null,Zt=null,en=!1,Ce=!1,Qe=!1,Ms=null,wt=Ie,M=!1,He=!1,Rn=!1,Ke="answer-option relative w-full text-left",Ns=Ke+" answer-option-selected",Bs=Ke+" answer-option-disabled",Ds=["Stay in fullscreen for the entire assessment","No tab or app switching is allowed","Mission Control monitors your progress in real time"],W=document.getElementById("secure-lobby"),qn=document.getElementById("secure-lobby-title"),be=document.getElementById("secure-lobby-summary"),Vn=document.getElementById("secure-lobby-time"),Un=document.getElementById("secure-lobby-questions"),Qn=document.getElementById("secure-window-message"),tn=document.getElementById("secure-access-code-group"),ee=document.getElementById("secure-access-code"),We=document.getElementById("secure-access-code-error"),N=document.getElementById("secure-begin-btn"),Ae=document.getElementById("secure-begin-label"),nn=document.getElementById("secure-rules-list"),x=null,Hn=!1,Kn=!1,St=!1;function Fs(e){try{sessionStorage.setItem("veritas_lock_active","true"),sessionStorage.setItem("lock_reason",e||"violation")}catch{}_.lock(e||"proctoring_violation"),typeof xt=="function"&&xt(e)}function Wn(e){Fs(e)}function zn(e){document.activeElement&&document.activeElement.id==="calc-iframe"||(sessionStorage.setItem("veritas_lock_active","true"),typeof sn=="function"?sn(e):typeof xt=="function"&&xt(e),V(e))}function sn(e){var t=window.currentPollId||window.pollData&&window.pollData.pollId||sessionStorage.getItem("veritas_active_poll_id");if(!t){console.error("[Proctor] CRITICAL: Attempted to report violation but Poll ID is missing. Retrying in 1s..."),setTimeout(function(){sn(e)},1e3);return}console.warn("[Proctor] Reporting violation:",e,"for Poll:",t);try{typeof ye=="function"&&ye(e,t)}catch(i){console.warn("[Proctor] Firebase reporting failed:",i)}var n=window.STUDENT_EMAIL||"";if(!n)try{n=sessionStorage.getItem("veritas_student_email")||""}catch{}var s=rt.httpsCallable("reportStudentViolation");s({pollId:t,studentEmail:n,reason:e}).then(function(i){console.log("[Proctor] Violation logged:",i.data),i.data&&i.data.lockVersion!==void 0&&(ce=i.data.lockVersion)}).catch(function(i){console.error("[Proctor] Violation report failed:",i)})}function xt(e){!S&&!Y&&M&&(console.log("[Proctor] Violation detected:",e,"- blocking interaction immediately"),S=!0,V(),ye(e)),Jt&&clearTimeout(Jt),Jt=setTimeout(function(){if(!Y){var t=A&&A.pollId||x&&x.pollId||window.currentPollId;if(!t)try{t=sessionStorage.getItem("veritas_active_poll_id")}catch{}if(!t){console.error("[Proctor] CRITICAL: Cannot report violation - no poll ID found in any source"),V();return}Y=!0,S=!0,console.log("[Proctor] Reporting violation to server:",e,"pollId:",t),ye(e,t);var n=window.STUDENT_EMAIL||"";if(!n)try{n=sessionStorage.getItem("veritas_student_email")||""}catch{}V();var s=rt.httpsCallable("reportStudentViolation");s({pollId:t,studentEmail:n,reason:e}).then(function(i){var o=i.data||i;console.log("[Proctor] Violation reported:",o),o.success&&(ce=o.lockVersion,V(),dn())}).catch(function(i){console.error("[Proctor] Violation report failed:",i),V()})}},100)}function Os(){Kn||(Kn=!0,window.addEventListener("blur",function(){if(!(!M||He||S||Le)&&!(A&&(A.status==="LOBBY"||A.status==="PRE_LIVE"||A.sessionPhase==="LOBBY"))){if(W&&W.style.display!=="none"){console.log("[Proctor] Blur ignored - Lobby is visible");return}Y=!0,zn("tab_switch")}}),document.addEventListener("visibilitychange",function(){if(document.hidden){if(!M||He||S||Le||A&&(A.status==="LOBBY"||A.status==="PRE_LIVE"||A.sessionPhase==="LOBBY"))return;if(W&&W.style.display!=="none"){console.log("[Proctor] visibilitychange ignored - Lobby is visible");return}Y=!0,zn("tab_hidden")}}))}var on=null,Rs=new Promise(function(e){function t(){on=window.VeritasModal||$s(),window.VeritasModal=on,e(on)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t,{once:!0}):t()});function qs(e){return Rs.then(function(t){return e(t)})}function rn(e,t){return qs(function(n){return n.alert(Object.assign({message:e},t||{}))})}function Vs(e){if(!e||e<=0)return"Untimed";if(e>=60){var t=Math.floor(e/60),n=e%60;return n===0?t+(t===1?" hour":" hours"):t+" hr "+n+" min"}return e+" min"}function Us(e){return typeof e!="number"||e<=0?"—":e+(e===1?" Question":" Questions")}function Qs(e){if(nn){nn.innerHTML="";var t=Array.isArray(e)&&e.length?e:Ds;t.forEach(function(n){var s=document.createElement("li"),i=document.createElement("span");i.className="material-symbols-outlined text-base text-veritas-navy mt-0.5",i.textContent="shield_person";var o=document.createElement("span");o.textContent=n,s.appendChild(i),s.appendChild(o),nn.appendChild(s)})}}function Te(e){We&&(e?(We.textContent=e,We.classList.remove("hidden")):(We.textContent="",We.classList.add("hidden")))}function Hs(e){return e==="NOT_YET_OPEN"?"Opens Soon":e==="PAST_DUE"?"Window Closed":"Begin Assessment"}function an(e){return e==="NOT_YET_OPEN"||e==="PAST_DUE"}function Yn(){if(N){var e=x?x.windowStatus:"OPEN",t=Hs(e),n=an(e),s=N.dataset.loading==="1";x&&(x.beginLabel=t),N.disabled=n||s,N.classList.toggle("opacity-60",n||s),Ae&&!s&&(Ae.textContent=t)}}function It(e){N&&(N.dataset.loading=e?"1":"0",e?(N.disabled=!0,N.classList.add("opacity-60"),Ae&&(Ae.textContent="Preparing...")):(N.classList.remove("opacity-60"),Yn()))}function ln(){W&&(W.style.display="none"),x=null,Te("")}function Ks(e,t){if(!e||!t)return!1;var n=an(e),s=an(t);return n&&!s}function Ws(){Hn||(Hn=!0,N&&(N.disabled=!0,N.classList.add("opacity-60")),Ae&&(Ae.textContent="Refreshing..."),setTimeout(function(){window.location.reload()},750))}function Gn(e){var t=x,n=t&&t.lobbyKey?t.lobbyKey:t?t.pollId+"|"+t.sessionId:null,s=(e.pollId||"poll")+"|"+(e.sessionId||""),i=n!==s,o=t?t.windowStatus:null;if(pt(!1),qt(!0),x={pollId:e.pollId,sessionId:e.sessionId,requiresAccessCode:!!e.requiresAccessCode,windowStatus:e.availability&&e.availability.windowStatus||e.windowStatus||"OPEN",lobbyKey:s},e.pollId){window.currentPollId=e.pollId;try{sessionStorage.setItem("veritas_active_poll_id",e.pollId)}catch{}}if(Ks(o,x.windowStatus)){Ws();return}k&&(k.style.display="none"),P&&(P.style.display="block"),ae&&(ae.style.display="none"),xe&&(xe.style.display="none"),g&&(g.style.display="none"),y&&(y.style.display="none"),F&&(F.style.display="none"),M=!1,Ut(!1),te&&(te.textContent="STANDBY"),W&&(W.style.display="block"),qn&&(qn.textContent=e.pollName||"Secure Assessment"),be&&(e.className?(be.textContent="Class: "+e.className,be.style.display="block",be.classList.remove("hidden")):(be.textContent="",be.style.display="none",be.classList.add("hidden"))),Vn&&(Vn.textContent=Vs(e.timeLimitMinutes)),Un&&(Un.textContent=Us(e.questionCount));var a=e.availability||{},l=a.message||"Available now";a.blockingMessage&&(l+=" • "+a.blockingMessage),Qn&&(Qn.textContent=l),tn&&(tn.style.display=x.requiresAccessCode?"block":"none",tn.classList.toggle("hidden",!x.requiresAccessCode)),ee&&i&&(ee.value=""),i&&Te(""),Qs(e.proctoringRules),Yn()}function zs(){return!De||De.isFullscreen()?Promise.resolve():De.request().catch(function(){return Promise.resolve()})}function Ys(e){if(console.log("[Proctor] Fullscreen change event:",{isFullscreen:e.isFullscreen,hidden:e.hidden,secureSessionActive:M,liveSessionActive:St,fullscreenEnteredOnce:Ve,isInteractionBlocked:S,violationLogged:Y}),e.isFullscreen){console.log("[Proctor] Fullscreen entered"),Ve=!0;return}if(e.hidden&&!S&&!Y){console.log("[Proctor] ZERO TOLERANCE: Tab blur detected - IMMEDIATE LOCK"),Wn("tab-blur");return}(Ve||M||St)&&!S&&!Y&&(console.log("[Proctor] ZERO TOLERANCE: Fullscreen exit detected - IMMEDIATE LOCK"),Wn("exit-fullscreen"))}function Gs(){if(!(!x||!N||N.disabled)){Te("");var e=ee?ee.value.trim():"";if(x.requiresAccessCode&&!e){Te("Access code is required."),ee&&ee.focus();return}zs().then(function(){if(It(!0),He=!0,setTimeout(function(){He=!1},3e3),!De.isFullscreen())throw new Error("Fullscreen failed");M=!0;var t=x.pollId,n=window.STUDENT_EMAIL||sessionStorage.getItem("veritas_student_email");if(!n){It(!1),rn("Student identity not found. Please refresh.",{title:"Error"});return}firebase.database().ref("polls/"+t).once("value").then(function(s){var i=s.val();if(!i)throw new Error("Poll not found");var o=i.accessCode?i.accessCode:"";if(o&&o!==e)throw new Error("Invalid access code.");var a=n.replace(/[.$#[\]]/g,"_");return firebase.database().ref("sessions/"+t+"/students/"+a).update({status:"ACTIVE",startedAt:firebase.database.ServerValue.TIMESTAMP,email:n,name:window.STUDENT_NAME||n.split("@")[0]})}).then(function(){It(!1),Xn(),k.style.display="none",x=null,oe(!0)}).catch(function(s){It(!1),He=!1,M=!1;var i=s.message||"Unable to begin assessment.";/access code/i.test(i)?(Te(i),ee&&ee.focus()):rn(i,{title:"Secure Assessment"})})}).catch(function(t){console.warn("Fullscreen request was rejected",t),rn("Fullscreen permission is required to begin the assessment.",{title:"Secure Assessment"})})}}function js(){var e=document.getElementById("veritas-modal-root");if(e)return e;var t=document.createElement("div");return t.id="veritas-modal-root",t.className="veritas-modal-root",t.setAttribute("aria-hidden","true"),t.innerHTML='<div class="veritas-modal-backdrop"></div><div class="veritas-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="veritas-modal-title" aria-describedby="veritas-modal-message"><div class="veritas-modal-header"><h2 id="veritas-modal-title">Notice</h2></div><div class="veritas-modal-body"><p id="veritas-modal-message"></p><div id="veritas-modal-subtext" class="veritas-modal-subtext"></div><div id="veritas-modal-input" class="veritas-modal-input" style="display: none;"><label for="veritas-modal-input-field" class="sr-only">Input</label><input id="veritas-modal-input-field" type="text" autocomplete="off" /></div><div class="veritas-modal-actions"><button type="button" class="veritas-modal-button secondary" data-action="cancel">Cancel</button><button type="button" class="veritas-modal-button primary" data-action="confirm"><span class="veritas-modal-spinner" aria-hidden="true"></span><span>Confirm</span></button></div></div>',(document.body||document.documentElement).appendChild(t),t}function $s(){var e=js(),t=e.querySelector(".veritas-modal-dialog"),n=e.querySelector("#veritas-modal-title"),s=e.querySelector("#veritas-modal-message"),i=e.querySelector("#veritas-modal-subtext"),o=e.querySelector("#veritas-modal-input"),a=e.querySelector("#veritas-modal-input-field"),l=e.querySelector('[data-action="confirm"]'),c=e.querySelector('[data-action="cancel"]'),r=l.querySelector("span:not(.veritas-modal-spinner)"),u=!1,f=null,m=null,p=null,I=!0,L=[];function Q(d){var v=[].slice.call(document.body.children);d?(L=[],v.forEach(function(h){h!==e&&(L.push({node:h,ariaHidden:h.getAttribute("aria-hidden"),inert:"inert"in h?h.inert:null}),h.setAttribute("aria-hidden","true"),"inert"in h&&(h.inert=!0))})):(L.forEach(function(h){h.ariaHidden===null?h.node.removeAttribute("aria-hidden"):h.node.setAttribute("aria-hidden",h.ariaHidden),"inert"in h.node&&(h.inert!==null?h.node.inert=h.inert:h.node.inert=!1)}),L=[])}function G(d){d?(l.classList.add("loading"),l.setAttribute("disabled","disabled"),c.style.display!=="none"&&c.setAttribute("disabled","disabled")):(l.classList.remove("loading"),l.removeAttribute("disabled"),c.removeAttribute("disabled"))}function de(){var d='button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',v=[].slice.call(t.querySelectorAll(d));return v.filter(function(h){return!h.hasAttribute("disabled")&&h.offsetParent!==null})}function re(){var d=de();d.length>0?d[0].focus():t.focus()}function Pe(d){if(u)if(d.key==="Escape"){if(!I)return;d.preventDefault(),B()}else if(d.key==="Tab"){var v=de();if(v.length===0){d.preventDefault();return}var h=v.indexOf(document.activeElement);d.shiftKey?h<=0&&(v[v.length-1].focus(),d.preventDefault()):h===v.length-1&&(v[0].focus(),d.preventDefault())}else d.key==="Enter"&&f&&f.mode==="prompt"&&document.activeElement===a&&(d.preventDefault(),D())}function Tt(d){u&&(t.contains(d.target)||(d.stopPropagation(),re()))}function w(d){u=!1,e.classList.remove("is-active"),e.setAttribute("aria-hidden","true"),document.body.classList.remove("veritas-modal-open"),e.removeEventListener("keydown",Pe,!0),document.removeEventListener("focus",Tt,!0),Q(!1),G(!1),p&&typeof p.focus=="function"&&setTimeout(function(){p.focus()},0),m&&m(d),f=null,m=null}function D(){if(u){G(!0);var d=f?f.mode:"alert",v;d==="prompt"?v=a.value:d==="confirm"&&(v=!0),w(v)}}function B(){if(u){var d=f?f.mode:"alert";if(d==="alert"){w(void 0);return}d==="confirm"?w(!1):d==="prompt"&&w(null)}}function fe(d,v){return v=v||{},f=Object.assign({},v,{mode:d}),I=v.allowEscape!==!1,n.textContent=v.title||(d==="confirm"?"Please Confirm":d==="prompt"?"Enter Response":"Notice"),v.html?s.innerHTML=v.html:s.textContent=v.message||"",v.subtext?(i.style.display="block",i.textContent=v.subtext):(i.style.display="none",i.textContent=""),d==="prompt"?(o.style.display="flex",a.value=v.defaultValue||"",v.placeholder?a.placeholder=v.placeholder:a.removeAttribute("placeholder")):(o.style.display="none",a.value="",a.removeAttribute("placeholder")),r.textContent=v.confirmText||(d==="confirm"?"Confirm":d==="prompt"?"Submit":"OK"),v.destructive?l.classList.add("destructive"):l.classList.remove("destructive"),c.style.display=d==="alert"?"none":"inline-flex",c.textContent=v.cancelText||"Cancel",G(!1),p=document.activeElement,e.classList.add("is-active"),e.setAttribute("aria-hidden","false"),document.body.classList.add("veritas-modal-open"),Q(!0),u=!0,e.addEventListener("keydown",Pe,!0),document.addEventListener("focus",Tt,!0),new Promise(function(h){m=h,setTimeout(function(){d==="prompt"?(a.focus(),a.select()):d==="confirm"&&v.focusCancel?c.focus():l.focus()},0)})}return l.addEventListener("click",D),c.addEventListener("click",B),e.addEventListener("click",function(d){if(d.target===e||d.target.classList.contains("veritas-modal-backdrop")){if(!f||f.allowBackdropClose===!1)return;B()}}),{alert:function(d){return fe("alert",d).then(function(){})},confirm:function(d){return fe("confirm",d).then(function(v){return v!==!1})},prompt:function(d){return fe("prompt",d).then(function(v){return v})}}}var he=[];function Xs(){return xe&&xe.style.display!=="none"}function ze(){On&&(clearTimeout(Ms),On.classList.add("hidden"),$t&&($t.textContent="",$t.classList.remove("opacity-0")))}function Ye(){qe&&(clearTimeout(qe),qe=null),Ce=!1}function cn(e){if(!S){Ye();var t=Math.min(Xt,Math.max(1e3,e)),n=Math.random()*.15*t;qe=setTimeout(function(){qe=null,jn()},t+n)}}function oe(e){if(sessionStorage.getItem("veritas_lock_active")==="true"){typeof V=="function"&&V();return}if(Rt()){console.log("[Proctor] POISON PILL ACTIVE in startPolling - blocking resume"),S=!0,V(),dn();return}Et=0,Qe=!1,e?(Ye(),jn()):cn(Ie)}function Js(e,t){typeof e.stateVersion=="number"&&e.stateVersion,typeof e.advisedPollIntervalMs=="number"?wt=e.advisedPollIntervalMs:wt=Ie,e.connectionHealth==="RECOVERED_AFTER_OUTAGE"||(e.connectionHealth==="RECOVERING"?(ze(),Xs()):Qe||ze()),Ee(e);var n=Math.max(500,Math.min(Xt,wt));cn(n)}function Zs(e){var t=e&&e.message?e.message:typeof e=="string"?e:"";if(t&&/Authentication|not enrolled|Invalid link/i.test(t)){Ye(),fn(e);return}Qe=!0;var n=Math.pow(1.6,Math.max(1,Et)),s=Math.min(Xt,Math.round((wt||Ie)*n));cn(s)}function Ge(e){if(P&&(P.style.display="block",P.classList.remove("hidden")),y&&(y.style.display="none"),g){g.style.display="block",g.classList.remove("hidden");var t=g.querySelector(".material-symbols-outlined");if(t){var n=`
                    <svg class="w-24 h-24 mx-auto mb-6 text-veritas-navy" viewBox="0 0 52 52" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle class="animate-draw-check" cx="26" cy="26" r="25" stroke="currentColor" stroke-width="2"/>
                        <path class="animate-draw-check" d="M14.1 27.2l7.1 7.2 16.7-16.8" stroke="currentColor" stroke-width="2" style="animation-delay: 0.2s"/>
                    </svg>
                    `;t.innerHTML=n,t.className="block mb-4",t.textContent="";var s=document.createElement("div");s.innerHTML=n,t.replaceWith(s)}}C&&(C.textContent=e||"Answer Saved",C.className="text-veritas-navy text-3xl font-bold tracking-tight animate-fade-in"),b&&(b.textContent="Response Recorded. Eyes on the board for results.",b.style.display="block",b.className="text-slate-500 font-medium mt-2 animate-fade-in");var i=document.getElementById("resume-controls");i&&(i.style.display="none")}function jn(){if(!(S||Ce)){if(!firebase||!firebase.apps||!firebase.apps.length){console.warn("[Polling] Firebase not initialized yet, skipping poll");return}Ce=!0,ft.getInstance().getTelemetry();var e=window.currentPollId||sessionStorage.getItem("veritas_active_poll_id");if(!e){console.warn("[Polling] No active poll ID found, skipping"),Ce=!1;return}firebase.database().ref("sessions/"+e+"/live_session").once("value").then(function(t){Ce=!1;var n=t.val();Et=0,Qe=!1,Js(n||{})}).catch(function(t){Ce=!1,Et+=1,console.error("Polling error",t),Zs(t)})}}function un(){var e=F&&F.style.display!=="none",t=y&&y.style.display!=="none";return(e||t)&&!_.isLocked()}window.addEventListener("offline",function(){un()&&(Qe=!0)}),window.addEventListener("online",function(){if(un()&&(oe(!0),un()&&!S)){var e=F&&F.style.display!=="none";e&&(M=!0)}}),Bn&&(Bn.onclick=function(){console.log("Resume button clicked - attempting fullscreen"),document.documentElement.requestFullscreen&&document.documentElement.requestFullscreen().then(function(){console.log("Fullscreen entered - confirming with server");var e=firebase.functions().httpsCallable("confirmFullscreen");e({pollId:CURRENT_POLL_ID||ACTIVE_SESSION&&ACTIVE_SESSION.pollId,studentEmail:STUDENT_INFO.id||STUDENT_INFO.email,lockVersion:ce}).then(function(t){t.data&&t.data.success?console.log("[Proctor] Server confirmed unlock via fullscreen confirmation - Firebase listener will handle state change."):(console.error("Failed to confirm fullscreen:",t.data?.reason),C.textContent="Failed to resume. Please try again.")}).catch(function(t){console.error("Error confirming fullscreen:",t),C.textContent="Error resuming session."})}).catch(function(e){console.warn("Fullscreen denied on resume:",e),C.textContent="Fullscreen is required. Please allow fullscreen and try again."})}),Dn&&Dn.addEventListener("click",function(){ks()});var $n=null;function ei(e,t){if(!$n){var n=typeof generateStudentKey=="function"?generateStudentKey(t):t.replace(/[.$#[\]]/g,"_"),s=firebase.database().ref("sessions/"+e+"/students/"+n);$n=s,console.log("[Proctor] Initializing Firebase listener for status updates"),s.on("value",function(i){var o=i.val();o&&(console.log("[Proctor] Status Update Received:",o.status,{version:o.lockVersion}),o.status==="AWAITING_FULLSCREEN"?(ce=o.lockVersion,mi()):o.status==="LOCKED"&&o.lockVersion!==ce?(ce=o.lockVersion,V()):o.status==="BLOCKED"?(Le=!0,ce=o.lockVersion||ce,fi()):o.status==="ACTIVE"&&(S||Y)&&(console.log("[Proctor] Status changed to ACTIVE - clearing local lock"),xn(),S=!1,Le=!1,Y=!1,Ve=!1,ze(),M=!0,oe(!0)))})}}function dn(){var e=A&&A.pollId||x&&x.pollId||E&&E.pollId,t=window.STUDENT_EMAIL||STUDENT_DATA&&STUDENT_DATA.email;e&&t&&ei(e,t)}function Xn(){["entry-screen","secure-lobby","status-container","pre-live-card","student-container","question-container","individual-timed-session"].forEach(function(e){var t=document.getElementById(e);t&&(t.style.display="none",t.classList.add("hidden"))}),S||(document.body.style.overflow="")}function Ee(e){e=e||{},e.pollId&&(window.currentPollId=e.pollId,sessionStorage.setItem("veritas_active_poll_id",e.pollId)),e.pollId&&e.status&&cs(e),console.log("[ViewManager] Update View State:",e);var t=typeof e.questionIndex=="number"?e.questionIndex:null,n=e.resultsVisibility||(e.status==="RESULTS_REVEALED"?"REVEALED":null),s=!1;try{s=sessionStorage.getItem("veritas_lock_active")==="true"}catch{s=!1}if(s)if(e&&e.unlock_granted===!0)xn(),s=!1,typeof At=="function"&&At();else{typeof V=="function"&&V(),S=!0,dn();return}if(_.isLocked())if(e.unlockApproved===!0)console.log("[LockManager] Server approved unlock - Clearing Poison Pill"),_.unlock();else{console.warn("[LockManager] Local Lock Active - Blocking View Update");var i=sessionStorage.getItem("lock_reason");_.renderLockScreen(i);return}else if(e.isLocked||e.status==="LOCKED"){_.lock(e.lockReason||"Server Command");return}var o=document.getElementById("paused-overlay");if(e.status==="PAUSED"?(console.log("[ViewManager] Session PAUSED - showing Eyes on Teacher overlay"),o&&(o.classList.remove("hidden"),o.style.display="flex"),S=!0):o&&o.style.display!=="none"&&(console.log("[ViewManager] Session resumed - hiding PAUSED overlay"),o.classList.add("hidden"),o.style.display="none",S=!1),e.hasSubmitted===!0&&t!==null&&(Sn=t),t!==null&&Sn===t&&e.status==="LIVE"&&n!=="REVEALED"){y&&(y.style.display="none"),Ge("Answer Saved. Waiting for next question...");return}if(Xn(),["entry-screen","secure-lobby","student-container"].forEach(function(p){var I=document.getElementById(p);I&&(I.style.display="none",I.classList.add("hidden"))}),!K&&e.pollId&&e.studentEmail&&En(e.pollId,e.studentEmail),e.resultsVisibility==="REVEALED"||e.status==="RESULTS_REVEALED"){var a=e.status||"RESULTS_REVEALED";e.status=a,ui(e);return}if(e.status==="RESULTS_HOLD"){Ge("Results Pending Analysis");return}var l=e.calculatorEnabled===!0;if(window.syncCalculatorVisibility&&window.syncCalculatorVisibility(l),e.status==="CLOSED"||e.sessionPhase==="ENDED"){window.hideCalculatorOnSessionEnd&&window.hideCalculatorOnSessionEnd(),ie.show("status-container"),di("Session Concluded","The live session has ended. Thanks for participating!");return}if(!e.sessionType&&!e.pollId){k&&(k.style.display="block",k.classList.remove("hidden")),ie.show("entry-screen");return}var c=at!==t&&t!==null;if(c){at=t;var r=document.getElementById("student-container");r&&(r.classList.remove("motion-slide-in-right"),r.offsetWidth,r.classList.add("motion-slide-in-right"))}P&&(P.style.display="block",P.classList.remove("hidden"));var u=e.sessionType==="SECURE_ASSESSMENT"||e.sessionType==="SECURE";if(u)if(e.status==="LOBBY"||e.sessionPhase==="LOBBY"){var f=document.getElementById("secure-lobby");f&&(f.style.display="block",f.classList.remove("hidden")),ie.show("secure-lobby"),renderSecureLobby(e)}else ie.show("individual-timed-session"),Cn(e);else{if(!Rn){console.log("[ViewManager] Blocking Live Poll render - student has not clicked Begin Poll"),k&&(k.style.display="block",k.classList.remove("hidden")),ie.show("entry-screen");return}if(e.sessionPhase==="LOBBY")ie.show("pre-live-card"),updatePreLiveCard(e);else if(ie.show("question-container"),e.status==="PRE_LIVE")St=!1,ue=!1,Ue=null,Ut(!1),te&&(te.textContent="QUESTION 1 OF ?"),ie.show("pre-live-card");else{if(mt===t&&Ft!==t){Jn(e.pollId,t);return}if(e.hasSubmitted===!0&&t!==null){Ge("Answer Saved. Waiting for next question...");return}ti(e)}}var m=document.getElementById("resume-controls");m&&(m.style.display="none")}function ti(e){if(_.isLocked()){console.log("[Proctor] renderQuestion BLOCKED - Lock active"),_.renderLockScreen(sessionStorage.getItem("lock_reason"));return}if(!y||!T||!pe){console.error("[renderQuestion] Critical DOM elements missing");var t=document.getElementById("render-error-overlay");t||(t=document.createElement("div"),t.id="render-error-overlay",t.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;color:white;font-family:sans-serif;",t.innerHTML='<h2 style="font-size:24px;margin-bottom:16px;">Unable to Load Question</h2><p style="max-width:400px;text-align:center;">Critical UI elements are missing. Please refresh the page or contact your teacher.</p>',document.body.appendChild(t));return}A=e,console.log("[renderQuestion] Rendering Live Poll question:",e);var n=e.metadata&&e.metadata.resetAt?e.metadata.resetAt:"",s=e.pollId+":"+e.questionIndex+":"+n,i=Ue!==s;if(i&&(console.log("[renderQuestion] Question changed from",Ue,"to",s),Ue=s,ue=!!e.hasSubmitted,he=[],St=!0,mt=null,Ft=null,Nt.init(e.pollId,e.sessionId||"",e.questionIndex)),en=!!e.metacognitionEnabled,Vt(e.questionIndex,e.totalQuestions),y.style.display="block",g&&(g.style.display="none"),pe){var o=e.questionText||e.text||e.stem||"";!o&&e.options&&e.options.length>0?(o='<span class="animate-pulse text-gray-500 italic">Loading question...</span>',console.error("[renderQuestion] Missing question text. Full data:",JSON.stringify(e,null,2)),console.warn("[renderQuestion] Question text is missing, showing loader"),typeof oe=="function"&&oe(!0)):o||(console.error("[renderQuestion] No question text and no options. Full data:",JSON.stringify(e,null,2)),o="[Question Text Missing]"),pe.innerHTML=ut(o),Mt(),pe.style.display="block",pe.classList.remove("hidden")}var a=!!e.questionImageURL;if(Z&&(a?(Z.src=e.questionImageURL,Z.style.display="block"):Z.style.display="none"),et&&et.classList.toggle("no-image",!a),tt&&(tt.style.display=a?"flex":"none"),le&&(le.classList.add("hidden"),le.textContent=""),q&&(q.classList.add("hidden"),q.textContent=""),ai(),i||T.children.length===0){var l=e.options||[],c=["A","B","C","D","E","F","G","H"];i&&e.shuffleOptions&&(l=ii(l.slice())),T.innerHTML="",he=[],l.forEach(function(r,u){var f={text:typeof r=="string"?r:r.text||"",imageURL:typeof r=="object"&&(r.imageURL||r.imageUrl)||"",id:typeof r=="object"&&r.id||null},m=c[u]||(u+1).toString(),p=es(f,m,e.pollId,e.questionIndex,u);ue&&(p.disabled=!0,p.classList.add("answer-option-disabled"));var I=document.createElement("li");I.appendChild(p),T.appendChild(I),he.push({text:f.text,imageURL:f.imageURL})}),ri(e.pollId,e.questionIndex)}else if(ue){Ge("Answer Saved. Waiting for next question...");return}Mt()}function ni(e,t,n,s){if(console.log("=== SUBMIT ANSWER CALLED ==="),console.log("currentMetacognitionEnabled:",en),console.log("answerText:",n),!S&&!ue){for(var i=T.querySelectorAll("button"),o=0;o<i.length;o++)i[o].disabled=!0,i[o].dataset.answerText===n?i[o].className=Ns:i[o].className=Bs;en?(console.log("Metacognition is enabled - showing confidence question"),Zt=n,g&&(g.dataset.pendingAnswerId=s||""),y.style.display="none",Jn(e,t)):(console.log("Metacognition is NOT enabled - submitting answer directly"),ue=!0,g.style.display="block",y.style.display="none",C&&(C.textContent="Submitting answer...",C.className="text-veritas-navy text-2xl font-bold"),b&&(b.textContent="Please wait while we confirm your submission.",b.style.display="block",b.className="text-slate-500 text-sm mt-2 animate-pulse"),Zn(e,t,n,s,null))}}function Jn(e,t){if(g.style.display="block",y.style.display="none",mt=t,C.textContent="How confident are you in your answer?",C.className="text-gray-800 text-xl font-semibold mb-4",b){b.innerHTML='<div class="confidence-selector mt-6 flex flex-col gap-3"><button class="confidence-btn h-14 px-6 rounded-xl bg-red-500/20 hover:bg-red-500/30 text-gray-900 border-2 border-red-500/40 hover:border-red-500/60 transition-all font-semibold text-lg" data-confidence="guessing"><span class="mr-2">🤔</span> Guessing</button><button class="confidence-btn h-14 px-6 rounded-xl bg-yellow-500/20 hover:bg-yellow-500/30 text-gray-900 border-2 border-yellow-500/40 hover:border-yellow-500/60 transition-all font-semibold text-lg" data-confidence="somewhat-sure"><span class="mr-2">🤷</span> Somewhat Sure</button><button class="confidence-btn h-14 px-6 rounded-xl bg-blue-500/20 hover:bg-blue-500/30 text-gray-900 border-2 border-blue-500/40 hover:border-blue-500/60 transition-all font-semibold text-lg" data-confidence="very-sure"><span class="mr-2">👍</span> Very Sure</button><button class="confidence-btn h-14 px-6 rounded-xl bg-green-500/20 hover:bg-green-500/30 text-gray-900 border-2 border-green-500/40 hover:border-green-500/60 transition-all font-semibold text-lg" data-confidence="certain"><span class="mr-2">💯</span> Absolutely Certain</button></div>',b.style.display="block",b.className="text-gray-700 text-base mt-4";for(var n=b.querySelectorAll(".confidence-btn"),s=0;s<n.length;s++)n[s].addEventListener("click",function(i){i.preventDefault();var o=this.dataset.confidence,a=g?g.dataset.pendingAnswerId:null;si(e,t,Zt,a,o)})}}N&&N.addEventListener("click",Gs),ee&&ee.addEventListener("input",function(){Te("")});function si(e,t,n,s,i){Nt.recordAnswerSubmitted(n,i),ue=!0,Ft=t,mt=null,C.textContent="Transmitting your response...",C.className="text-gray-900 text-2xl font-semibold",b&&(b.innerHTML="",b.style.display="none"),Zn(e,t,n,s,i)}function Zn(e,t,n,s,i){Zt=null,Ge("Answer Saved. Waiting for next question..."),console.log("[Optimistic UI] Showing success state immediately"),wn(e,t,n,s,i).then(function(o){o&&o.success?console.log("[Firebase] Dual-write confirmed successful"):console.warn("[Firebase] Dual-write may have failed, but UI already transitioned")}).catch(function(o){console.error("[Firebase] Dual-write error:",o)})}function ii(e){for(var t=e.slice(),n=t.length-1;n>0;n--){var s=Math.floor(Math.random()*(n+1)),i=t[n];t[n]=t[s],t[s]=i}return t}function es(e,t,n,s,i){var o=document.createElement("button");o.type="button",o.className=Ke,o.dataset.answerText=e.text||"",o.dataset.optionIndex=i;var a=(e.text||"").trim(),l="";e.imageURL&&(l+='<img src="'+Lt(e.imageURL)+'" alt="Answer '+t+'" class="option-image" referrerpolicy="no-referrer">'),l+='<div class="option-leading">',l+='<div class="letter-badge" aria-hidden="true">'+t+"</div>",l+='<div class="option-body">',l+='<div class="option-text-wrapper">',a&&(l+='<div class="option-text">',l+=ut(a),l+="</div>"),l+='<span class="sr-only result-announcement"></span>',l+="</div>",l+="</div>",l+="</div>",l+='<div class="result-metadata">',l+='<div class="percentage-flag" style="display:none"></div>',l+='<div class="result-icon-marker"></div>',l+="</div>",l+='<div class="result-badges"></div>',l+='<button type="button" class="cross-out-toggle" aria-label="Cross out this answer" title="Click to eliminate this option">',l+='<span class="material-symbols-outlined">visibility_off</span>',l+="</button>",o.innerHTML=l;var c=o.querySelector(".cross-out-toggle");return c&&c.addEventListener("click",function(r){r.stopPropagation(),r.preventDefault();var u=o.classList.toggle("crossed-out"),f=c.querySelector(".material-symbols-outlined");f&&(f.textContent=u?"visibility":"visibility_off"),c.setAttribute("aria-label",u?"Restore this answer":"Cross out this answer"),c.setAttribute("title",u?"Click to restore this option":"Click to eliminate this option"),oi(n,s)}),o.addEventListener("click",function(r){if(!(r&&r.target&&r.target.closest(".cross-out-toggle"))){if(r&&r.target&&(r.target.closest(".option-image")||r.target.closest("img"))){console.log("[Interaction] Image clicked - ignoring submission to allow zoom");return}if(o.classList.contains("crossed-out")){console.log("[Interaction] Crossed-out option clicked - ignoring");return}var u=Array.from(o.parentElement.parentElement.children).indexOf(o.parentElement);Nt.recordOptionClick(u,e.text),ni(n,s,e.text,e.id)}}),o}function ts(e,t){return"vlp_crossout_"+e+"_"+t}function oi(e,t){try{var n=[],s=T?T.querySelectorAll("button.answer-option"):[];s.forEach(function(o,a){o.classList.contains("crossed-out")&&n.push(a)});var i=ts(e,t);sessionStorage.setItem(i,JSON.stringify(n)),console.log("[CrossOut] Saved state:",n,"for key:",i)}catch(o){console.warn("[CrossOut] Failed to save state:",o)}}function ri(e,t){try{var n=ts(e,t),s=sessionStorage.getItem(n);if(!s)return;var i=JSON.parse(s);if(!Array.isArray(i))return;var o=T?T.querySelectorAll("button.answer-option"):[];i.forEach(function(a){if(o[a]){o[a].classList.add("crossed-out");var l=o[a].querySelector(".cross-out-toggle");if(l){var c=l.querySelector(".material-symbols-outlined");c&&(c.textContent="visibility"),l.setAttribute("aria-label","Restore this answer"),l.setAttribute("title","Click to restore this option")}}}),console.log("[CrossOut] Restored state:",i,"for key:",n)}catch(a){console.warn("[CrossOut] Failed to restore state:",a)}}function ai(){if(y){y.classList.remove("results-stage","showing-results","review-mode");var e=y.querySelector(".review-ribbon-strip");e&&e.remove()}var t=document.getElementById("flashlight-overlay");if(t&&(t.style.display="none"),y&&y.classList.remove("privacy-active"),le&&(le.classList.add("hidden"),le.textContent=""),q&&(q.classList.add("hidden"),q.textContent=""),!!T){var n=T.querySelectorAll("button");n.forEach(function(s){s.disabled=!1,s.className=Ke,s.classList.remove("result-readonly","result-correct","result-incorrect","result-your-choice","result-neutral");var i=s.querySelector(".percentage-flag");i&&(i.style.display="none",i.textContent="");var o=s.querySelector(".result-icon-marker");o&&(o.textContent="");var a=s.querySelector(".result-badges");a&&(a.innerHTML="")})}}function li(e){if(T&&!(T.children.length>0)){var t=he.length>0?he:e.options||[],n=["A","B","C","D","E","F","G","H"];T.innerHTML="",he=[],t.forEach(function(s,i){var o={text:s.text||s,imageURL:s.imageURL||s.imageUrl||""},a=n[i]||(i+1).toString(),l=es(o,a,e.pollId,e.questionIndex,i);l.disabled=!0,l.classList.add("result-readonly");var c=document.createElement("li");c.appendChild(l),T.appendChild(c),he.push({text:o.text||"",imageURL:o.imageURL||""})})}}function ci(e){if(T){var t=typeof e.totalResponses=="number"?e.totalResponses:0,n=e.resultPercentages||{},s=T.querySelectorAll("button");s.forEach(function(i){var o=i.dataset.answerText||"";i.disabled=!0,i.className=Ke+" result-readonly",i.classList.remove("result-correct","result-incorrect","result-your-choice");var a=i.querySelector(".result-announcement");if(a&&(a.textContent=""),e.status==="RESULTS_REVEALED"){var l=typeof n[o]=="number"?n[o]:0,c=i.querySelector(".percentage-flag");c&&(c.style.display="block",t>0||l>0?c.textContent=l+"%":c.textContent="0%");var r=e.correctAnswer&&o===e.correctAnswer,u=e.studentAnswer!==void 0&&e.studentAnswer!==null&&e.studentAnswer!=="",f=u&&o===e.studentAnswer,m=e.studentIsCorrect===null||e.studentIsCorrect===void 0?null:!!e.studentIsCorrect;r?i.classList.add("result-correct"):f&&(m===!1||!r)?i.classList.add("result-incorrect"):i.classList.add("result-neutral");var p=i.querySelector(".result-icon-marker");p&&(r?(p.textContent="check_circle",p.parentElement.parentElement.classList.add("result-correct")):f&&(m===!1||!r)?(p.textContent="cancel",p.parentElement.parentElement.classList.add("result-incorrect")):p.textContent="");var I=i.querySelector(".result-badges");if(I){if(I.innerHTML="",f){var L=document.createElement("span");L.className="badge-pill badge-your-choice",L.textContent="Your Choice",I.appendChild(L)}if(r){var L=document.createElement("span");L.className="badge-pill badge-correct",L.textContent="Correct",I.appendChild(L)}}if(a){var Q=[];r&&Q.push("Correct answer"),f&&Q.push("Your selection"),Q.push(l+"% of class selected this choice"),a.textContent=Q.join(". ")+"."}}})}}function ui(e){A=e;var t=e.metadata&&e.metadata.resetAt?e.metadata.resetAt:"";Ue=e.pollId+":"+e.questionIndex+":"+t,ue=!!e.hasSubmitted,P&&(P.style.display="block",P.classList.remove("hidden")),y.style.display="block",y.classList.remove("hidden"),g.style.display="none",(e.questionIndex||0)+1,e.totalQuestions,Vt(e.questionIndex,e.totalQuestions),pe&&(pe.textContent=e.questionText||"");var n=!!e.questionImageURL;if(Z&&(n?(Z.src=e.questionImageURL,Z.style.display="block"):Z.style.display="none"),et&&et.classList.toggle("no-image",!n),tt&&(tt.style.display=n?"flex":"none"),le&&le.classList.add("hidden"),e.status==="RESULTS_REVEALED"&&q?(e.totalResponses||0)===0?(q.textContent="No responses recorded for this question.",q.classList.remove("hidden")):(q.classList.add("hidden"),q.textContent=""):q&&(q.classList.add("hidden"),q.textContent=""),li(e),y.classList.add("results-stage","review-mode"),!y.querySelector(".review-ribbon-strip")){var s=document.createElement("div");s.className="review-ribbon-strip animate-fade-in",s.textContent="REVIEW",y.appendChild(s)}var i=document.getElementById("flashlight-overlay");i&&(i.style.display="none",i.style.setProperty("--x",window.innerWidth/2+"px"),i.style.setProperty("--y",window.innerHeight/2+"px")),y&&y.classList.add("privacy-active"),y.classList.remove("showing-results"),e.status==="RESULTS_REVEALED"&&requestAnimationFrame(function(){y.classList.add("showing-results")}),ci(e)}function Lt(e){if(!e)return"";var t=document.createElement("div");return t.textContent=e,t.innerHTML}function Ct(e){e=e||{},ze(),ln(),P&&(P.style.display="block"),k&&(k.style.display="none"),y&&(y.style.display="none"),F&&(F.style.display="none"),ae&&(ae.style.display="none"),g&&(g.style.display="block");var t=e.theme==="dark",n=g?g.querySelector(".status-card"):null;if(t){g&&(g.className="fixed inset-0 z-[9000] flex items-center justify-center p-6 transition-all duration-700 backdrop-blur-3xl bg-slate-950/40 select-none",g.style.display="flex"),n&&(n.className="status-card relative w-full max-w-xl mx-auto p-12 overflow-hidden rounded-[2.5rem] border border-white/10 bg-white/5 shadow-[0_32px_64px_-16px_rgba(0,0,0,0.5)] flex flex-col items-center text-center motion-slide-up",n.style.backdropFilter="blur(20px)",n.style.webkitBackdropFilter="blur(20px)");var s=document.querySelector(".student-header");s&&(s.style.display="none")}else{g&&(g.className="text-center py-12 animate-fade-in block",g.style.display="block"),n&&(n.className="status-card bg-white rounded-2xl border border-gray-200 p-8 sm:p-12 shadow-2xl max-w-3xl mx-auto",n.style.backdropFilter="none",n.style.webkitBackdropFilter="none");var s=document.querySelector(".student-header");s&&(s.style.display="")}C&&(C.textContent=e.message||"",C.className=e.messageClass||(t?"text-white text-4xl font-bold tracking-tight mb-2 drop-shadow-sm":"text-gray-900 text-2xl font-semibold")),b&&(e.subtext?(b.style.display="block",b.textContent=e.subtext,b.className=e.subClass||(t?"text-slate-300 text-xl mt-4 max-w-lg mx-auto leading-relaxed":"text-gray-700 text-lg mt-4")):(b.style.display="none",b.textContent=""));var i=g?g.querySelector(".material-symbols-outlined"):null;if(i&&(i.textContent=e.icon||"info",t?(i.className="material-symbols-outlined text-8xl mb-10 select-none "+(e.iconClass||"text-emerald-400"),i.style.textShadow="0 0 30px rgba(52, 211, 153, 0.4)"):(i.className="material-symbols-outlined text-6xl mb-4 inline-block "+(e.iconClass||"text-veritas-navy"),i.style.textShadow="none")),resumeControls&&(resumeControls.style.display=e.showResume?"block":"none",t&&e.showResume)){var o=document.getElementById("resume-session-btn");o&&(o.className="mx-auto mt-8 flex items-center justify-center gap-3 px-10 py-5 rounded-2xl bg-white text-slate-900 text-xl font-bold hover:bg-slate-50 transition-all duration-300 hover:scale-105 shadow-[0_20px_40px_-10px_rgba(255,255,255,0.2)] active:scale-95")}Gt&&(e.showExitAction?(Gt.classList.remove("hidden"),jt&&(jt.textContent=e.exitActionDescription||"Click below to exit fullscreen and close the secure window.",t&&(jt.className="text-slate-400 text-sm mt-12 mb-4 max-w-sm mx-auto")),secureExitBtn&&t&&(secureExitBtn.className="mx-auto flex items-center justify-center gap-2 px-8 py-4 rounded-xl border border-white/10 bg-white/5 text-slate-300 text-base font-medium hover:bg-white/10 transition-all duration-300 hover:text-white"),Fn&&(Fn.textContent=e.exitActionLabel||"Exit Secure Session")):Gt.classList.add("hidden")),document&&document.body&&(e.lockScroll?document.body.classList.add("secure-overlay-active"):document.body.classList.remove("secure-overlay-active"))}const ke={LOCKED:{title:"Assessment Paused",icon:"fullscreen_exit",body:"Fullscreen exit detected. Please wait for your instructor to re-admit you.",footer:"Your work has been saved. Stay on this screen.",badge:"PAUSED",statusLight:"CONNECTION ACTIVE"}};function V(e){var t=document.getElementById("lock-overlay");if(t){document.body.style.opacity="1",t.style.display="flex";var n=e?Lt(e):ke.LOCKED.body;t.innerHTML=`
                <div class="flex flex-col items-center justify-center h-full w-full max-w-2xl mx-auto p-8 animate-fade-in text-center">

                    <div class="h-20 w-20 bg-amber-900/20 rounded-full flex items-center justify-center mb-6 border-2 border-amber-700">
                        <span class="material-symbols-outlined text-4xl text-amber-400">
                            ${ke.LOCKED.icon}
                        </span>
                    </div>

                    <h1 class="text-3xl font-bold text-white mb-2 tracking-tight">
                        ${ke.LOCKED.title}
                    </h1>

                    <div class="w-full bg-amber-900/10 border-l-4 border-amber-500 p-5 my-6 text-left rounded-r-md">
                        <p class="text-xs font-semibold text-amber-400 uppercase tracking-wide mb-1">
                            ${ke.LOCKED.badge}
                        </p>
                        <p class="text-lg text-gray-100">
                            ${n}
                        </p>
                    </div>

                    <p class="text-base text-gray-400">
                        ${ke.LOCKED.footer}
                    </p>

                    <div class="mt-8 flex items-center gap-2 text-xs text-gray-500 font-medium">
                        <span class="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span>${ke.LOCKED.statusLight}</span>
                    </div>
                </div>
            `}}function At(){var e=document.getElementById("lock-overlay");e&&(e.style.display="none",e.innerHTML=""),document.body.style.opacity="1"}function di(e,t,n){n=n||{};var s=n.icon||"check_circle",i=n.iconClass||"text-veritas-navy";g&&(g.style.display="block"),y&&(y.style.display="none"),C&&(C.textContent=e,C.className="text-gray-900 text-2xl font-semibold"),b&&(b.textContent=t,b.style.display="block",b.className="text-gray-700 text-lg mt-4");var o=g?g.querySelector(".status-card"):null;if(o){var a=o.querySelector(".material-symbols-outlined")||o.querySelector("div:first-child");if(!a||a.tagName!=="SPAN"||!a.classList.contains("material-symbols-outlined")){var l=document.createElement("span");l.className="material-symbols-outlined text-6xl mb-4 inline-block "+i,l.textContent=s,a?a.replaceWith(l):o.insertBefore(l,o.firstChild)}else a.textContent=s,a.className="material-symbols-outlined text-6xl mb-4 inline-block "+i}var c=document.getElementById("resume-controls");c&&(c.style.display="none");var r=document.getElementById("secure-exit-controls");r&&n.showExit&&r.classList.remove("hidden")}function fi(){console.log("Showing teacher block message"),Ye(),S=!0,Le=!0,Ct({icon:"pause_circle",iconClass:"text-amber-600",message:"Session Paused",messageClass:"text-gray-900 text-xl font-semibold",subtext:"Your teacher has temporarily frozen responses. Hold position.",subClass:"text-gray-700 text-base mt-4",showResume:!1,lockScroll:!0})}function mi(){console.log("Showing resume prompt"),Ye(),At();var e=ps(),t=document.getElementById("resume-session-label");t&&(t.textContent="Resume "+e),Ct({theme:"dark",icon:"fullscreen",message:"Cleared for Re-Entry",subtext:"Click below to return to fullscreen and rejoin the session.",showResume:!0,lockScroll:!0})}function fn(e){console.error("Error:",e);var t=e.message||e||"Unknown error",n=String(t);typeof t=="string"&&t.indexOf("Error: ")===0&&(t=t.substring(7)),(n.includes("NetworkError")||n.includes("HTTP 0")||n.includes("Connection failure"))&&(t="Network connection interrupted. Please check your internet connection and try again."),Ct({icon:"error",iconClass:"text-veritas-navy",message:"An error occurred: "+t,messageClass:"text-gray-900 text-2xl font-bold",showResume:!1,lockScroll:!1}),resumeControls&&(resumeControls.style.display="none")}var je=document.getElementById("calc-fab"),_e=document.getElementById("calc-window");document.getElementById("calc-header");var ns=document.getElementById("calc-close"),$e=document.getElementById("calc-iframe"),ss=document.getElementById("calc-loader"),is=!1,Xe=!1;function mn(e){je&&(e?je.classList.remove("hidden"):(je.classList.add("hidden"),_e&&(_e.classList.add("hidden"),Xe=!1)))}function vi(){!_e||!$e||(_e.classList.remove("hidden"),Xe=!0,!is&&$e.dataset.src&&($e.src=$e.dataset.src,is=!0,$e.addEventListener("load",function(){ss&&(ss.style.display="none"),console.log("[Calculator] TI-84 iframe loaded")},{once:!0})))}function os(){_e&&(_e.classList.add("hidden"),Xe=!1)}je&&je.addEventListener("click",function(){Xe?os():vi()}),ns&&ns.addEventListener("click",function(e){e.stopPropagation(),os()});function gi(){var e=document.getElementById("calc-header"),t=document.getElementById("calc-window");if(document.getElementById("calc-iframe"),!e||!t)return;var n="veritas-drag-shield",s=document.getElementById(n);s||(s=document.createElement("div"),s.id=n,s.style.position="fixed",s.style.top="0",s.style.left="0",s.style.width="100vw",s.style.height="100vh",s.style.zIndex="2147483647",s.style.cursor="move",s.style.display="none",s.style.background="transparent",document.body.appendChild(s));var i=!1,o,a,l,c;function r(m){if(!m.target.closest("#calc-close")){i=!0,s.style.display="block";var p=m.type.indexOf("touch")!==-1?m.touches[0].clientX:m.clientX,I=m.type.indexOf("touch")!==-1?m.touches[0].clientY:m.clientY;o=p,a=I;var L=t.getBoundingClientRect();l=L.left,c=L.top,t.style.transform="none",t.style.left=l+"px",t.style.top=c+"px",t.style.right="auto",t.style.bottom="auto",m.cancelable&&!m.target.tagName.match(/INPUT|TEXTAREA|SELECT|BUTTON/i)&&m.preventDefault()}}function u(m){if(i){m.cancelable&&m.preventDefault();var p=m.type.indexOf("touch")!==-1?m.touches[0].clientX:m.clientX,I=m.type.indexOf("touch")!==-1?m.touches[0].clientY:m.clientY,L=p-o,Q=I-a,G=l+L,de=c+Q,re=window.innerWidth-t.offsetWidth,Pe=window.innerHeight-t.offsetHeight;G=Math.max(0,Math.min(G,re)),de=Math.max(0,Math.min(de,Pe)),t.style.left=G+"px",t.style.top=de+"px"}}function f(){i=!1,s.style.display="none"}e.style.cursor="move",e.addEventListener("mousedown",r),e.addEventListener("touchstart",r,{passive:!1}),s.addEventListener("mousemove",u),s.addEventListener("touchmove",u,{passive:!1}),s.addEventListener("mouseup",f),s.addEventListener("touchend",f),s.addEventListener("mouseleave",f)}function yi(){var e=document.getElementById("question-progress");e&&(e.classList.add("hidden"),e.textContent="WAITING TO START");var t=document.querySelectorAll("#entry-screen");if(t.length>1){console.warn("[VisualFix] Found "+t.length+" entry-screens. Removing duplicates.");for(var n=1;n<t.length;n++)t[n].remove()}else{var s=document.querySelectorAll("h1");if(s.length>1){console.warn("[VisualFix] Found duplicate H1 elements. Cleaning up.");for(var i=1;i<s.length;i++){var o=s[i].closest(".flex.items-center.gap-4");o?o.remove():s[i].remove()}}}}function pi(e){return new Promise(function(t,n){if(!e){console.warn("[findActivePollForClass] No className provided"),t(null);return}var s=firebase.database();console.log("[findActivePollForClass] Searching for active polls in class:",e),s.ref("polls").orderByChild("className").equalTo(e).once("value").then(function(i){var o=i.val()||{},a=Object.keys(o);if(console.log("[findActivePollForClass] Found",a.length,"polls for class"),a.length===0){t(null);return}var l=a.map(function(c){return s.ref("sessions/"+c+"/live_session").once("value").then(function(r){var u=r.val();return u&&u.status&&u.status!=="ENDED"&&u.status!=="PRE_LIVE"?(console.log("[findActivePollForClass] Active session found:",c,"status:",u.status),c):null}).catch(function(r){return console.warn("[findActivePollForClass] Could not check session for poll",c,r.message),null})});return Promise.all(l)}).then(function(i){if(!i){t(null);return}var o=i.find(function(a){return a!==null});o?console.log("[findActivePollForClass] Returning active poll:",o):console.log("[findActivePollForClass] No active polls found for class:",e),t(o||null)}).catch(function(i){console.error("[findActivePollForClass] Query error:",i),n(i)})})}function Je(){var e=fs();e&&console.log("[App] State rehydrated from cache - continuing with fresh fetch"),gi(),yi();var t=window.currentPollId||sessionStorage.getItem("veritas_active_poll_id"),n=window.STUDENT_EMAIL||sessionStorage.getItem("veritas_student_email");t&&n?(console.log("[App] Starting Firebase Sidecar for poll:",t),En(t,n)):console.warn("[App] Cannot start sidecar - missing pollId or email")}function rs(){var e=new URLSearchParams(window.location.search),t=e.get("token"),n=e.get("pollId");if(n&&(window.currentPollId=n,sessionStorage.setItem("veritas_active_poll_id",n)),t){console.log("[Auth] Token found in URL:",t);var s=document.getElementById("login-overlay");s&&(s.style.display="none");var i=document.getElementById("student-container");i&&(i.style.display="none"),!firebase.apps.length&&FIREBASE_CONFIG&&firebase.initializeApp(FIREBASE_CONFIG),firebase.auth().signInAnonymously().then(function(){return console.log("[Auth] Signed in anonymously"),firebase.database().ref("tokens/"+t).once("value")}).then(function(a){var l=a.val();if(l&&l.email){console.log("[Auth] Token verified. Student:",l.email,"Class:",l.className),window.STUDENT_EMAIL=l.email,window.SESSION_TOKEN=t,window.STUDENT_CLASS=l.className;try{sessionStorage.setItem("veritas_student_email",l.email),sessionStorage.setItem("veritas_session_token",t),l.className&&sessionStorage.setItem("veritas_student_class",l.className)}catch{}window.LoginManager&&LoginManager.hide();var c=document.getElementById("login-overlay");c&&(c.style.display="none");var r=document.getElementById("student-container");r&&(r.style.display="block"),window.currentPollId?Je():(console.log("[Auth] No pollId in URL, searching for active session..."),pi(l.className).then(function(u){u?(console.log("[Auth] Found active poll:",u),window.currentPollId=u,sessionStorage.setItem("veritas_active_poll_id",u)):console.warn("[Auth] No active poll found for class:",l.className),Je()}).catch(function(u){console.error("[Auth] Error finding active poll:",u),Je()}))}else throw new Error("Invalid or expired link.")}).catch(function(a){console.error("[Auth] Token validation failed:",a),a.code==="auth/admin-restricted-operation"?alert("Configuration Error: Anonymous Authentication is disabled in Firebase Console. Please enable it in Authentication > Sign-in method."):alert("Invalid link: "+a.message),as()})}else if(window.STUDENT_EMAIL)console.log("[Auth] Authenticated via injection:",window.STUDENT_EMAIL),firebase.auth&&!firebase.auth().currentUser&&(console.log("[Auth] ensuring anonymous auth for injected session..."),firebase.auth().signInAnonymously().catch(function(a){console.warn("[Auth] Background anon sign-in warning:",a)})),Je();else{var o=sessionStorage.getItem("veritas_student_email");o?(console.log("[Auth] Found persisted student email in sessionStorage:",o),window.STUDENT_EMAIL=o,Je()):(console.log("[Auth] No identity found. Initiating Login Flow."),as())}}function as(){document.body.classList.add("auth-required");var e=document.getElementById("student-container"),t=document.getElementById("entry-screen");if(e&&(e.style.display="none"),t&&(t.style.display="none"),window.LoginManager){var n=document.querySelector(".login-subtitle");n&&(n.textContent="Student Access"),LoginManager.init(function(s){console.log("[Auth] Student Login successful:",s.email);try{sessionStorage.setItem("veritas_student_email",s.email)}catch{}console.log("[Auth] Reloading to initialize session."),setTimeout(function(){window.location.reload()},500)}),LoginManager.show()}else console.error("LoginManager not loaded!"),alert("Authentication system missing. Please contact support.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",rs):rs();function Ze(){var e=document.getElementById("calc-fab"),t=document.getElementById("calc-window");e&&(e.style.display="none"),t&&(t.classList.add("hidden"),t.classList.remove("active"),t.style.display="none",Xe=!1)}window.syncCalculatorVisibility=mn,window.hideCalculatorOnSessionEnd=Ze,window.updateStudentView=Ee,window.LockManager=_,window.ViewManager=ie})();
