<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veritas Live Poll - Teacher Dashboard</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#002d6b",
            "brand-white": "#ffffff",
            "brand-light-gray": "#d9e0e7",
            "brand-dark-gray": "#242424",
            "background-light": "#f5f7f8",
            "background-dark": "#0f1723"
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
            serif: ["Noto Serif", "serif"]
          },
          borderRadius: {
            DEFAULT: "0.25rem",
            lg: "0.5rem",
            xl: "0.75rem",
            full: "9999px"
          }
        }
      }
    };
  </script>

  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style type="text/tailwindcss">
    @layer utilities {
      .correct-answer-bg {
        background-image: repeating-linear-gradient(
          45deg,
          rgba(217, 224, 231, 0.7),
          rgba(217, 224, 231, 0.7) 10px,
          rgba(217, 224, 231, 1) 10px,
          rgba(217, 224, 231, 1) 20px
        );
      }
      .dark .correct-answer-bg {
        background-image: repeating-linear-gradient(
          45deg,
          rgba(0, 46, 109, 0.2),
          rgba(0, 46, 109, 0.2) 10px,
          rgba(0, 46, 109, 0.3) 10px,
          rgba(0, 46, 109, 0.3) 20px
        );
      }
    }
  </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-brand-dark-gray dark:text-brand-white">
  <div class="flex h-screen w-full flex-col">
    <!-- Header -->
    <header class="flex shrink-0 items-center justify-between whitespace-nowrap border-b border-solid border-brand-light-gray dark:border-brand-dark-gray/20 bg-brand-light-gray dark:bg-brand-dark-gray/30 px-6 py-3 shadow-sm">
      <div class="flex items-center gap-4">
        <img alt="Malvern Prep Logo" class="h-10 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png"/>
        <div class="flex flex-col">
          <h1 class="text-primary dark:text-brand-white text-lg font-bold leading-tight tracking-[-0.015em]">Veritas Live Poll</h1>
          <p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm">Teacher Dashboard</p>
        </div>
      </div>
      <div id="loader" class="loader" style="display: block;">
        <div class="h-6 w-6 animate-spin rounded-full border-2 border-primary border-t-transparent"></div>
      </div>
    </header>

    <div class="flex flex-grow overflow-hidden">
      <!-- Main Content Area -->
      <main class="flex-1 overflow-y-auto">
        <div id="dashboard" class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
          <!-- Sidebar Controls -->
          <aside class="lg:col-span-1 flex flex-col gap-6">
            <!-- Poll Controls -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <h2 class="text-brand-dark-gray dark:text-brand-white text-xl font-bold leading-normal mb-4">Poll Controls</h2>
              <div class="form-group mb-4">
                <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white" for="poll-select">Select Poll</label>
                <select id="poll-select" class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                  <option value="">-- Choose a poll --</option>
                </select>
              </div>
              <button id="send-link-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 mb-2 bg-green-600 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span class="material-symbols-outlined text-xl">mail</span>
                <span class="truncate">Send Student Links</span>
              </button>
              <button id="view-links-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 mb-4 bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span class="material-symbols-outlined text-xl">visibility</span>
                <span class="truncate">View All Links</span>
              </button>
              <div class="form-group mb-4">
                <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white" for="poll-timer-input">Timer (seconds)</label>
                <input type="number" id="poll-timer-input" placeholder="60" min="10" max="600" class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50"/>
              </div>
              <button id="start-poll-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 mb-2 bg-primary text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
                <span class="material-symbols-outlined text-xl">play_arrow</span>
                <span class="truncate">Start Poll</span>
              </button>
              <button id="stop-poll-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 bg-red-600 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-red-700 transition-colors" style="display: none;">
                <span class="material-symbols-outlined text-xl">pause</span>
                <span class="truncate">Pause Poll</span>
              </button>
            </div>

            <!-- Create New Poll -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <h2 class="text-brand-dark-gray dark:text-brand-white text-xl font-bold leading-normal mb-4">Create New Poll</h2>
              <button id="open-creator-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">
                <span class="material-symbols-outlined text-xl">add_circle</span>
                <span class="truncate">Create New Poll</span>
              </button>
            </div>
          </aside>

          <!-- Live View -->
          <div id="live-view" class="lg:col-span-2 flex-col gap-6" style="display: none;">
            <!-- Question Display -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm mb-6">
              <div class="flex items-center gap-4 mb-4">
                <span class="status-badge inline-block px-4 py-1.5 rounded-full text-sm font-semibold bg-green-500/20 text-green-800 dark:text-green-300" id="poll-status-badge">OPEN</span>
                <span id="live-question-info" class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm font-medium">Question 1 of 10</span>
              </div>
              <h2 id="live-poll-name" class="font-serif text-brand-dark-gray dark:text-brand-white text-2xl font-bold leading-tight mb-4">Poll Name</h2>
              <div id="live-timer-display" class="text-center text-5xl font-bold text-primary dark:text-brand-white my-6 font-mono"></div>
              <div id="live-question-text" class="font-serif text-brand-dark-gray dark:text-brand-white text-xl leading-relaxed">Question text appears here</div>
            </div>

            <!-- Live Controls -->
            <div class="flex flex-wrap gap-3 mb-6">
              <button id="resume-question-btn" class="flex items-center justify-center gap-2 rounded-full h-10 px-6 bg-green-600 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-green-700 transition-colors" style="display: none;">
                <span class="material-symbols-outlined text-xl">play_arrow</span>
                <span class="truncate">Resume Question</span>
              </button>
              <button id="next-question-btn" class="flex items-center justify-center gap-2 rounded-full h-10 px-6 bg-primary text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
                <span class="material-symbols-outlined text-xl">skip_next</span>
                <span class="truncate">Next Question</span>
              </button>
              <button id="end-poll-btn" class="flex items-center justify-center gap-2 rounded-full h-10 px-6 bg-red-600 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-red-700 transition-colors">
                <span class="material-symbols-outlined text-xl">stop</span>
                <span class="truncate">End Poll</span>
              </button>
            </div>

            <!-- Results Section -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm mb-6">
              <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                <h3 class="text-brand-dark-gray dark:text-brand-white text-xl font-bold leading-normal">Live Results</h3>
                <div class="flex items-center gap-3">
                  <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-primary/10 text-primary dark:text-brand-white text-sm font-semibold">
                    <span class="material-symbols-outlined text-base">group</span>
                    <span id="response-count">0 / 0 responses</span>
                  </div>
                  <div class="px-3 py-1.5 rounded-full bg-green-500/10 text-green-800 dark:text-green-300 text-sm font-semibold">
                    <span id="correct-answer-display">Correct: -</span>
                  </div>
                </div>
              </div>
              <div id="chart-div" class="min-h-[300px]"></div>
            </div>

            <!-- Student Status -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                <h3 class="text-brand-dark-gray dark:text-brand-white text-xl font-bold leading-normal">Student Status</h3>
                <div class="flex items-center gap-2">
                  <button class="sort-btn active px-3 py-1.5 rounded-lg bg-primary text-brand-white text-sm font-semibold hover:bg-primary/90 transition-colors" data-sort="name">Name</button>
                  <button class="sort-btn px-3 py-1.5 rounded-lg bg-brand-light-gray text-brand-dark-gray text-sm font-semibold hover:bg-brand-light-gray/80 transition-colors" data-sort="time">Time</button>
                  <button class="sort-btn px-3 py-1.5 rounded-lg bg-brand-light-gray text-brand-dark-gray text-sm font-semibold hover:bg-brand-light-gray/80 transition-colors" data-sort="correctness">Correct</button>
                </div>
              </div>
              <div id="student-tile-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[500px] overflow-y-auto"></div>
            </div>
          </div>
        </div>
      </main>

      <!-- Right Sidebar Navigation -->
      <aside class="w-64 bg-brand-light-gray dark:bg-primary flex-col items-center p-4 border-l border-brand-light-gray/50 dark:border-primary/20 hidden xl:flex">
        <nav class="flex flex-col w-full gap-2">
          <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/20 dark:bg-brand-white/10 text-primary dark:text-brand-white hover:bg-primary/30 dark:hover:bg-brand-white/20 font-semibold transition-colors" href="#">
            <span class="material-symbols-outlined">ballot</span>
            <span>Polls List</span>
          </a>
          <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-brand-dark-gray/70 dark:text-brand-white/70 hover:bg-primary/10 dark:hover:bg-brand-white/20 hover:text-primary dark:hover:text-brand-white transition-colors" href="#">
            <span class="material-symbols-outlined">archive</span>
            <span>Archived Polls</span>
          </a>
          <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-brand-dark-gray/70 dark:text-brand-white/70 hover:bg-primary/10 dark:hover:bg-brand-white/20 hover:text-primary dark:hover:text-brand-white transition-colors" href="#">
            <span class="material-symbols-outlined">add_circle</span>
            <span>Create New Poll</span>
          </a>
          <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-brand-dark-gray/70 dark:text-brand-white/70 hover:bg-primary/10 dark:hover:bg-brand-white/20 hover:text-primary dark:hover:text-brand-white transition-colors" href="#">
            <span class="material-symbols-outlined">group</span>
            <span>Rosters</span>
          </a>
        </nav>
        <div class="mt-auto w-full">
          <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-brand-dark-gray/70 dark:text-brand-white/70 hover:bg-primary/10 dark:hover:bg-brand-white/20 hover:text-primary dark:hover:text-brand-white transition-colors" href="#">
            <span class="material-symbols-outlined">settings</span>
            <span>Settings</span>
          </a>
        </div>
      </aside>
    </div>
  </div>

  <!-- Poll Creator Modal -->
  <div id="poll-creator-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-brand-light-gray dark:bg-brand-dark-gray/50 px-6 py-4 border-b border-brand-light-gray dark:border-brand-dark-gray/40">
        <h2 class="text-brand-dark-gray dark:text-brand-white text-2xl font-bold">Create New Poll</h2>
      </div>
      <div class="p-6">
        <div class="form-group mb-4">
          <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white" for="new-poll-name">Poll Name</label>
          <input type="text" id="new-poll-name" placeholder="e.g., Week 5 Physics Quiz" class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50"/>
        </div>
        <div class="form-group mb-6">
          <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white" for="class-select">Class</label>
          <select id="class-select" class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
            <option value="">-- Select Class --</option>
          </select>
        </div>
        <div class="flex items-center justify-between mb-4 pb-4 border-b border-brand-light-gray dark:border-brand-dark-gray/40">
          <h3 class="text-brand-dark-gray dark:text-brand-white text-lg font-bold">Questions</h3>
          <button id="add-question-btn" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-bold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">
            <span class="material-symbols-outlined text-base">add</span>
            <span>Add Question</span>
          </button>
        </div>
        <div id="question-builder" class="max-h-[50vh] overflow-y-auto mb-6"></div>
        <div class="flex gap-3 pt-4 border-t border-brand-light-gray dark:border-brand-dark-gray/40">
          <button id="save-poll-btn" class="flex-1 flex items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
            <span class="material-symbols-outlined text-xl">save</span>
            <span>Save Poll</span>
          </button>
          <button id="close-modal-btn" class="flex-1 flex items-center justify-center gap-2 rounded-lg h-10 px-4 bg-brand-light-gray text-brand-dark-gray text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray/80 transition-colors">
            <span>Cancel</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Student Links Modal -->
  <div id="student-links-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-brand-light-gray dark:bg-brand-dark-gray/50 px-6 py-4 border-b border-brand-light-gray dark:border-brand-dark-gray/40">
        <h2 class="text-brand-dark-gray dark:text-brand-white text-2xl font-bold">Student Personalized Links</h2>
        <p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm mt-1">Each student has a unique tracking link.</p>
      </div>
      <div class="p-6">
        <div id="links-container" class="max-h-[60vh] overflow-y-auto"></div>
        <div class="mt-6 pt-4 border-t border-brand-light-gray dark:border-brand-dark-gray/40">
          <button id="close-links-modal-btn" class="flex items-center justify-center gap-2 rounded-lg h-10 px-6 bg-brand-light-gray text-brand-dark-gray text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray/80 transition-colors">
            <span>Close</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
(function(){
  // --- Main App State ---
  var mainLoader=document.getElementById('loader');
  var ALL_POLLS=[];
  var ALL_CLASSES=[];
  var CURRENT_POLL_DATA={};
  var currentStudentStatusData=[];
  var currentSort='name';
  var pollInterval=null;
  var questionTimer=null;
  var visualTimerInterval=null;
  var isPaused=false;
  var questionCounter=0;

  // --- Element Cache ---
  var pollSelect=document.getElementById('poll-select');
  var startPollBtn=document.getElementById('start-poll-btn');
  var stopPollBtn=document.getElementById('stop-poll-btn');
  var resumeQuestionBtn=document.getElementById('resume-question-btn');
  var nextQuestionBtn=document.getElementById('next-question-btn');
  var endPollBtn=document.getElementById('end-poll-btn');
  var liveView=document.getElementById('live-view');
  var modal=document.getElementById('poll-creator-modal');
  var linksModal=document.getElementById('student-links-modal');
  var pollStatusBadge=document.getElementById('poll-status-badge');

  // --- Initialization ---
  google.charts.load('current',{'packages':['corechart']});
  google.charts.setOnLoadCallback(loadInitialData);

  // --- Event Listeners ---
  document.getElementById('open-creator-btn').onclick = () => {
    const selectedPollId = pollSelect.value;
    if (selectedPollId) {
      const selectedPoll = ALL_POLLS.find(p => p.pollId === selectedPollId);
      openPollEditor(selectedPoll.className);
    } else {
      openPollEditor();
    }
  };
  document.getElementById('close-modal-btn').onclick=closePollCreator;
  document.getElementById('close-links-modal-btn').onclick=closeLinksModal;
  document.getElementById('add-question-btn').onclick=addQuestionToBuilder;
  document.getElementById('save-poll-btn').onclick=savePoll;
  startPollBtn.onclick=onStartPoll;
  stopPollBtn.onclick=onStopPoll;
  resumeQuestionBtn.onclick=onResumePoll;
  nextQuestionBtn.onclick=onNextQuestion;
  endPollBtn.onclick=onEndPoll;
  document.getElementById('send-link-btn').onclick=onSendLink;
  document.getElementById('view-links-btn').onclick=onViewLinks;

  // --- Initial Data Load ---
  function loadInitialData(){
    google.script.run
      .withSuccessHandler(onDashboardDataLoaded)
      .withFailureHandler(handleError)
      .getTeacherDashboardData();
  }

  function onDashboardDataLoaded(data){
    mainLoader.style.display='none';
    ALL_CLASSES=data.classes||[];
    ALL_POLLS=data.polls||[];

    var classSelect=document.getElementById('class-select');
    classSelect.innerHTML='<option value="">-- Select Class --</option>';
    ALL_CLASSES.forEach(function(className){
      var opt=document.createElement('option');
      opt.value=className;
      opt.textContent=className;
      classSelect.appendChild(opt);
    });

    updatePollDropdown();
    setupSortButtons();
    setupUnlockListener();
  }

  function updatePollDropdown(){
    pollSelect.innerHTML='<option value="">-- Choose a poll --</option>';
    ALL_POLLS.forEach(function(poll){
      var opt=document.createElement('option');
      opt.value=poll.pollId;
      opt.textContent=poll.pollName+' ('+poll.className+') - '+poll.questions.length+' questions';
      pollSelect.appendChild(opt);
    });
    pollSelect.onchange=onPollSelectChange;
    onPollSelectChange();
  }

  function onPollSelectChange(){
    var pollId=pollSelect.value;
    var sendBtn=document.getElementById('send-link-btn');
    var viewBtn=document.getElementById('view-links-btn');
    if(pollId){
      var selectedPoll=ALL_POLLS.find(function(p){return p.pollId===pollId;});
      if(selectedPoll){
        sendBtn.disabled=false;
        viewBtn.disabled=false;
        sendBtn.dataset.className=selectedPoll.className;
        viewBtn.dataset.className=selectedPoll.className;
      }
    } else {
      sendBtn.disabled=true;
      viewBtn.disabled=true;
    }
  }

  // --- Poll Lifecycle Controls ---
  function onStartPoll(){
    var pollId=pollSelect.value;
    if(!pollId){alert("Please select a poll first.");return;}
    startPollBtn.disabled=true;
    startMasterTimer();
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .startPoll(pollId);
  }

  function onStopPoll(){
    stopPollBtn.disabled=true;
    clearTimeout(questionTimer);
    stopVisualTimer();
    google.script.run
      .withSuccessHandler(function(data){
        isPaused=true;
        updateLiveView(data);
      })
      .withFailureHandler(handleError)
      .stopPoll();
  }

  function onResumePoll(){
    resumeQuestionBtn.disabled=true;
    google.script.run
      .withSuccessHandler(function(data){
        isPaused=false;
        startMasterTimer();
        updateLiveView(data);
      })
      .withFailureHandler(handleError)
      .resumePoll();
  }

  function onNextQuestion(){
    nextQuestionBtn.disabled=true;
    if(pollInterval)clearInterval(pollInterval);
    isPaused=false;
    startMasterTimer();
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .nextQuestion();
  }

  function onEndPoll(){
    if(!confirm('Are you sure you want to end this poll completely?'))return;
    endPollBtn.disabled=true;
    clearTimeout(questionTimer);
    stopVisualTimer();
    if(pollInterval)clearInterval(pollInterval);
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .closePoll();
  }

  // --- Live View & Data Polling ---
  function updateLiveView(data){
    mainLoader.style.display='none';
    startPollBtn.disabled=false;
    stopPollBtn.disabled=false;
    resumeQuestionBtn.disabled=false;
    nextQuestionBtn.disabled=false;
    endPollBtn.disabled=false;

    if(data.status==="CLOSED"){
      liveView.style.display='none';
      startPollBtn.style.display='inline-flex';
      stopPollBtn.style.display='none';
      if(pollInterval)clearInterval(pollInterval);
      CURRENT_POLL_DATA={};
      currentStudentStatusData=[];
      stopVisualTimer();
      return;
    }

    if(data.error){handleError(data.error);return;}

    CURRENT_POLL_DATA.pollId=pollSelect.value;
    CURRENT_POLL_DATA.questionIndex=data.questionIndex;
    CURRENT_POLL_DATA.correctAnswer=data.correctAnswer;
    CURRENT_POLL_DATA.isPaused=isPaused;

    liveView.style.display='flex';
    startPollBtn.style.display='none';

    if(isPaused){
      pollStatusBadge.textContent='PAUSED';
      pollStatusBadge.className='inline-block px-4 py-1.5 rounded-full text-sm font-semibold bg-yellow-500/20 text-yellow-800 dark:text-yellow-300';
      stopPollBtn.style.display='none';
      resumeQuestionBtn.style.display='inline-flex';
    } else {
      pollStatusBadge.textContent='OPEN';
      pollStatusBadge.className='inline-block px-4 py-1.5 rounded-full text-sm font-semibold bg-green-500/20 text-green-800 dark:text-green-300';
      stopPollBtn.style.display='inline-flex';
      resumeQuestionBtn.style.display='none';
    }

    document.getElementById('live-poll-name').textContent=data.pollName;
    document.getElementById('live-question-info').textContent='Question '+(data.questionIndex+1)+' of '+data.totalQuestions;
    document.getElementById('live-question-text').textContent=data.questionText;
    document.getElementById('response-count').textContent=data.totalResponses+' / '+data.totalStudents+' responses';
    document.getElementById('correct-answer-display').textContent=data.correctAnswer?'Correct: '+data.correctAnswer:'No correct answer set';

    var isLastQuestion=(data.questionIndex+1===data.totalQuestions);
    nextQuestionBtn.innerHTML='<span class="material-symbols-outlined text-xl">'+(isLastQuestion?'check_circle':'skip_next')+'</span><span class="truncate">'+(isLastQuestion?'Finish Poll':'Next Question')+'</span>';

    currentStudentStatusData=data.studentStatusList;
    renderStudentTiles();
    drawChart(data.results,data.correctAnswer);

    if(pollInterval)clearInterval(pollInterval);
    if(!isPaused){
      pollInterval=setInterval(pollForResults,2500);
    }
  }

  function pollForResults(){
    if(isPaused)return;
    var pollId=CURRENT_POLL_DATA.pollId;
    var questionIndex=CURRENT_POLL_DATA.questionIndex;
    if(pollId===undefined||questionIndex===undefined)return;

    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(function(e){console.warn('Poll refresh error:',e);})
      .getLivePollData(pollId,questionIndex);
  }

  // --- Timer Controls ---
  function startMasterTimer(){
    clearTimeout(questionTimer);
    var timerInput=document.getElementById('poll-timer-input');
    var seconds=parseInt(timerInput.value,10);

    if(seconds>0&&seconds<=600){
      startVisualTimer(seconds);
      questionTimer=setTimeout(onStopPoll,seconds*1000);
      timerInput.value='';
    } else {
      stopVisualTimer();
    }
  }

  function startVisualTimer(duration){
    stopVisualTimer();
    var timerDisplay=document.getElementById('live-timer-display');
    if(!timerDisplay)return;

    var timer=duration;
    var updateDisplay=function(){
      var minutes=Math.floor(timer/60);
      var seconds=timer%60;
      timerDisplay.textContent=minutes+':'+(seconds<10?'0':'')+seconds;

      if(timer<=10){
        timerDisplay.className='text-center text-5xl font-bold text-red-600 dark:text-red-400 my-6 font-mono animate-pulse';
      } else {
        timerDisplay.className='text-center text-5xl font-bold text-primary dark:text-brand-white my-6 font-mono';
      }

      if(timer<=0){
        stopVisualTimer();
        timerDisplay.textContent="Time's Up!";
      }
      timer--;
    };
    updateDisplay();
    visualTimerInterval=setInterval(updateDisplay,1000);
  }

  function stopVisualTimer(){
    clearInterval(visualTimerInterval);
    var timerDisplay=document.getElementById('live-timer-display');
    if(timerDisplay){
      timerDisplay.textContent='';
      timerDisplay.className='text-center text-5xl font-bold text-primary dark:text-brand-white my-6 font-mono';
    }
  }

  // --- Student Tile & Sorting ---
  function renderStudentTiles(){
    var grid=document.getElementById('student-tile-grid');
    if(!grid)return;

    var sortedData=currentStudentStatusData.slice();

    if(currentSort==='name'){
      sortedData.sort(function(a,b){return a.name.localeCompare(b.name);});
    } else if(currentSort==='time'){
      sortedData.sort(function(a,b){return a.timestamp-b.timestamp;});
    } else if(currentSort==='correctness'){
      sortedData.sort(function(a,b){
        if(a.isCorrect===b.isCorrect)return 0;
        if(a.isCorrect===true)return-1;
        if(b.isCorrect===true)return 1;
        if(a.isCorrect===false)return-1;
        if(b.isCorrect===false)return 1;
        return 0;
      });
    }

    grid.innerHTML='';
    sortedData.forEach(function(student){
      var tile=document.createElement('div');
      var baseClasses='bg-brand-white dark:bg-brand-dark-gray/20 rounded-lg border-l-4 p-3 shadow-sm transition-all hover:shadow-md';
      var statusClass='border-gray-400';

      if(student.status==='Submitted'){
        statusClass='border-green-500 bg-green-50 dark:bg-green-900/10';
      } else if(student.status==='LOCKED'){
        statusClass='border-red-500 bg-red-50 dark:bg-red-900/10';
      }

      tile.className=baseClasses+' '+statusClass;
      tile.dataset.email=student.email;

      var statusIcon='â³';
      var timeText='';
      if(student.status==='Submitted'){
        var isCorrect=student.isCorrect;
        statusIcon=isCorrect?'âœ…':(CURRENT_POLL_DATA.correctAnswer?'âŒ':'â—‰');
        var date=new Date(student.timestamp);
        timeText='<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">'+date.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'})+'</div>';
      } else if(student.status==='LOCKED'){
        statusIcon='ðŸ”’';
      }

      var html='';
      html+='<div class="flex items-center justify-between mb-2">';
      html+='<span class="font-semibold text-sm text-brand-dark-gray dark:text-brand-white">'+escapeHtml(student.name)+'</span>';
      html+='<span class="text-xl">'+statusIcon+'</span>';
      html+='</div>';
      html+='<div class="font-serif text-xs text-gray-600 dark:text-gray-300 truncate">'+(student.answer?escapeHtml(student.answer):'<i>'+student.status+'...</i>')+'</div>';
      html+=timeText;

      if(student.status==='LOCKED'){
        html+='<div class="mt-2"><button class="unlock-btn w-full px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors">Unlock</button></div>';
      }

      tile.innerHTML=html;
      grid.appendChild(tile);
    });
  }

  function setupSortButtons(){
    var sortButtons=document.querySelectorAll('.sort-btn');
    sortButtons.forEach(function(btn){
      btn.addEventListener('click',function(){
        var sortType=this.dataset.sort;
        if(sortType===currentSort)return;

        sortButtons.forEach(function(b){
          b.className='sort-btn px-3 py-1.5 rounded-lg bg-brand-light-gray text-brand-dark-gray text-sm font-semibold hover:bg-brand-light-gray/80 transition-colors';
        });
        this.className='sort-btn active px-3 py-1.5 rounded-lg bg-primary text-brand-white text-sm font-semibold hover:bg-primary/90 transition-colors';
        currentSort=sortType;
        renderStudentTiles();
      });
    });
  }

  function setupUnlockListener(){
    var grid=document.getElementById('student-tile-grid');
    if(!grid)return;

    grid.addEventListener('click',function(e){
      if(e.target.classList.contains('unlock-btn')){
        var tile=e.target.closest('[data-email]');
        var studentEmail=tile.dataset.email;
        var pollId=CURRENT_POLL_DATA.pollId;

        if(!studentEmail||!pollId){alert("Error unlocking");return;}

        e.target.disabled=true;
        e.target.textContent="Unlocking...";
        google.script.run
          .withSuccessHandler(pollForResults)
          .withFailureHandler(handleError)
          .unlockStudent(studentEmail,pollId);
      }
    });
  }

  // --- Student Link Controls ---
  function onSendLink(){
    var btn=document.getElementById('send-link-btn');
    var className=btn.dataset.className;
    if(!className){alert('Please select a poll first.');return;}
    if(!confirm('This will email a new, unique poll link to all students in '+className+'. Are you sure?'))return;

    btn.disabled=true;
    btn.innerHTML='<div class="h-5 w-5 animate-spin rounded-full border-2 border-white border-t-transparent"></div>';

    google.script.run
      .withSuccessHandler(function(response){
        alert('âœ… Successfully sent '+response.count+' poll links.');
        btn.disabled=false;
        btn.innerHTML='<span class="material-symbols-outlined text-xl">mail</span><span class="truncate">Send Student Links</span>';
      })
      .withFailureHandler(function(err){
        handleError(err);
        btn.disabled=false;
        btn.innerHTML='<span class="material-symbols-outlined text-xl">mail</span><span class="truncate">Send Student Links</span>';
      })
      .sendPollLinkToClass(className);
  }

  function onViewLinks(){
    var btn=document.getElementById('view-links-btn');
    var className=btn.dataset.className;
    if(!className){alert('Please select a poll first.');return;}
    btn.disabled=true;

    google.script.run
      .withSuccessHandler(function(response){
        if(!response.success)return handleError(new Error('Could not load links'));

        var container=document.getElementById('links-container');
        var html='<div class="overflow-x-auto"><table class="w-full border-collapse">';
        html+='<thead><tr class="bg-brand-light-gray dark:bg-brand-dark-gray/50 border-b-2 border-brand-light-gray dark:border-brand-dark-gray/40">';
        html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Student Name</th>';
        html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Email</th>';
        html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Link</th>';
        html+='<th class="px-4 py-3 text-center text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Actions</th>';
        html+='</tr></thead><tbody>';

        response.links.forEach(function(link){
          html+='<tr class="border-b border-brand-light-gray/50 dark:border-brand-dark-gray/20 hover:bg-brand-light-gray/30 dark:hover:bg-brand-dark-gray/10">';
          html+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+escapeHtml(link.name)+'</td>';
          html+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+escapeHtml(link.email)+'</td>';
          html+='<td class="px-4 py-3 text-xs font-mono text-brand-dark-gray/70 dark:text-brand-white/70 max-w-[200px] truncate" title="'+escapeHtml(link.url)+'">'+(link.hasActiveLink?escapeHtml(link.url):'<i class="text-gray-400">No active link</i>')+'</td>';
          html+='<td class="px-4 py-3 text-center">';
          if(link.hasActiveLink){
            html+='<button class="copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors" data-url="'+escapeHtml(link.url)+'">Copy</button>';
          }
          html+='</td></tr>';
        });

        html+='</tbody></table></div>';
        container.innerHTML=html;

        container.querySelectorAll('.copy-link-btn').forEach(function(btn){
          btn.onclick=function(){
            var url=this.dataset.url;
            try{
              var tempInput=document.createElement('input');
              document.body.appendChild(tempInput);
              tempInput.value=url;
              tempInput.select();
              document.execCommand('copy');
              document.body.removeChild(tempInput);

              btn.textContent='âœ“ Copied!';
              btn.className='copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-green-600 text-brand-white';
              setTimeout(function(){
                btn.textContent='Copy';
                btn.className='copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors';
              }, 2000);
            } catch(err) {
              alert('Could not copy link. Please copy it manually.');
            }
          };
        });

        linksModal.style.display='flex';
        btn.disabled=false;
      })
      .withFailureHandler(function(err){
        handleError(err);
        btn.disabled=false;
      })
      .getStudentLinksForClass(className);
  }

  function closeLinksModal(){
    linksModal.style.display='none';
  }

  // --- Google Chart ---
  function drawChart(resultsData,correctAnswer){
    if(!resultsData||Object.keys(resultsData).length===0){
      document.getElementById('chart-div').innerHTML='<p class="text-center text-gray-500 dark:text-gray-400 py-12">Waiting for first response...</p>';
      return;
    }

    var dataArray=[['Answer','Count',{role:'style'}]];
    var colors=[];
    var defaultColor='#002d6b';
    var correctColor='#28a745';

    Object.keys(resultsData).forEach(function(key){
      var count=resultsData[key];
      var color=defaultColor;
      if(key===correctAnswer){
        color=correctColor;
      }
      dataArray.push([key,count,color]);
      colors.push(color);
    });

    var data=google.visualization.arrayToDataTable(dataArray);
    var options={
      chartArea:{width:'75%',height:'70%'},
      hAxis:{title:'Students',minValue:0,textStyle:{fontSize:12},gridlines:{color:'#e9ecef'}},
      vAxis:{title:'Answer Choice',textStyle:{fontSize:11,bold:true},gridlines:{color:'transparent'}},
      legend:{position:'none'},
      animation:{startup:true,duration:400,easing:'out'},
      bar:{groupWidth:'70%'},
      colors:colors,
      tooltip:{textStyle:{fontSize:12}}
    };
    var chart=new google.visualization.BarChart(document.getElementById('chart-div'));
    chart.draw(data,options);
  }

  // --- Poll Creator Modal ---
  function openPollEditor(className) {
    mainLoader.style.display = 'block';
    google.script.run
      .withSuccessHandler(function(html) {
        document.getElementById('dashboard').innerHTML = html;
        mainLoader.style.display = 'none';
      })
      .withFailureHandler(handleError)
      .getPollEditorHtml(className);
  }

  function openPollCreator(){
    questionCounter=0;
    document.getElementById('question-builder').innerHTML="";
    document.getElementById('new-poll-name').value="";
    document.getElementById('class-select').value="";
    addQuestionToBuilder();
    modal.style.display='flex';
  }

  function closePollCreator(){
    modal.style.display='none';
    document.getElementById('question-builder').innerHTML="";
    questionCounter=0;
  }

  function addQuestionToBuilder(){
    var questionIndex=questionCounter++;
    var builder=document.getElementById('question-builder');
    var qDiv=document.createElement('div');
    qDiv.className='bg-brand-light-gray/50 dark:bg-brand-dark-gray/20 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-5 mb-4';
    qDiv.dataset.index=questionIndex;
    qDiv.id='question-'+questionIndex;

    var html='';
    html+='<div class="flex items-center justify-between mb-4 pb-3 border-b border-brand-light-gray dark:border-brand-dark-gray/40">';
    html+='<h4 class="text-brand-dark-gray dark:text-brand-white text-base font-bold">Question '+(questionIndex+1)+'</h4>';
    if(questionIndex>0){
      html+='<button type="button" class="delete-question-btn px-3 py-1 text-xs font-semibold rounded bg-red-600 text-white hover:bg-red-700 transition-colors" onclick="window.deleteQuestion('+questionIndex+')">Delete</button>';
    }
    html+='</div>';
    html+='<div class="mb-4">';
    html+='<label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Question Text (optional)</label>';
    html+='<textarea class="q-text w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm font-serif focus:outline-none focus:ring-2 focus:ring-primary/50" rows="3" placeholder="Enter your question here..."></textarea>';
    html+='</div>';
    html+='<div class="mb-4">';
    html+='<label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Question Image (optional)</label>';
    html+='<input type="file" class="q-image text-xs" accept="image/*" onchange="window.previewQuestionImage(this, '+questionIndex+')">';
    html+='<img src="" class="image-preview hidden mt-3 rounded-lg max-w-[200px] max-h-[120px] border border-brand-light-gray" id="q-img-preview-'+questionIndex+'">';
    html+='</div>';
    html+='<div>';
    html+='<label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Answer Choices</label>';
    html+='<div class="answer-choices-container space-y-2" id="q-answers-'+questionIndex+'"></div>';
    html+='<button type="button" class="add-answer-btn mt-3 w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-brand-light-gray text-brand-dark-gray text-sm font-semibold hover:bg-brand-light-gray/80 transition-colors" onclick="window.addAnswerToQuestion('+questionIndex+')"><span class="material-symbols-outlined text-base">add</span><span>Add Answer</span></button>';
    html+='</div>';
    html+='<div class="mt-4 p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-sm text-blue-800 dark:text-blue-300">';
    html+='<span class="material-symbols-outlined text-base align-middle">info</span> <strong>Tip:</strong> Select the radio button next to the correct answer';
    html+='</div>';

    qDiv.innerHTML=html;
    builder.appendChild(qDiv);

    window.addAnswerToQuestion(questionIndex);
    window.addAnswerToQuestion(questionIndex);
  }

  window.deleteQuestion=function(questionIndex){
    var qDiv=document.getElementById('question-'+questionIndex);
    if(qDiv){
      qDiv.remove();
      renumberQuestions();
    }
  };

  function renumberQuestions(){
    var questions=document.getElementById('question-builder').querySelectorAll('[id^="question-"]');
    questions.forEach(function(q,index){
      var header=q.querySelector('h4');
      if(header){
        header.textContent='Question '+(index+1);
      }
    });
  }

  window.addAnswerToQuestion=function(questionIndex){
    var container=document.getElementById('q-answers-'+questionIndex);
    if(!container)return;
    var answerIndex=container.children.length;
    var aDiv=document.createElement('div');
    aDiv.className='flex items-center gap-2 bg-brand-white dark:bg-brand-dark-gray/20 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-2';
    aDiv.dataset.index=answerIndex;
    aDiv.id='q'+questionIndex+'-answer-'+answerIndex;

    var html='';
    html+='<input type="radio" name="correct-answer-q'+questionIndex+'" class="a-correct h-5 w-5 cursor-pointer accent-green-600" value="'+answerIndex+'" title="Mark as correct answer">';
    html+='<input type="text" class="a-text flex-1 rounded border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-2 py-1.5 text-sm font-serif focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="Answer text (required)">';
    html+='<input type="file" class="a-image text-xs w-auto" accept="image/*" onchange="window.previewAnswerImage(this, '+questionIndex+', '+answerIndex+')">';
    if(answerIndex>=2){
      html+='<button type="button" class="delete-answer-btn px-2 py-1 text-xs font-semibold rounded bg-red-600 text-white hover:bg-red-700 transition-colors" onclick="window.deleteAnswer('+questionIndex+', '+answerIndex+')">âœ•</button>';
    } else {
      html+='<span class="w-[28px]"></span>';
    }
    html+='<img src="" class="image-preview hidden rounded max-w-[80px] max-h-[60px]" id="q'+questionIndex+'-a'+answerIndex+'-preview">';

    aDiv.innerHTML=html;
    container.appendChild(aDiv);
  };

  window.deleteAnswer=function(questionIndex,answerIndex){
    var aDiv=document.getElementById('q'+questionIndex+'-answer-'+answerIndex);
    if(aDiv){
      var container=document.getElementById('q-answers-'+questionIndex);
      if(container.children.length>2){
        aDiv.remove();
      } else {
        alert('Questions must have at least 2 answer choices.');
      }
    }
  };

  window.previewQuestionImage=function(input,questionIndex){
    var preview=document.getElementById('q-img-preview-'+questionIndex);
    if(!preview)return;
    if(input.files&&input.files[0]){
      var file=input.files[0];
      if(file.size>5*1024*1024){
        alert('File is too large. Maximum size is 5MB.');
        input.value='';
        return;
      }
      var reader=new FileReader();
      reader.onload=function(e){
        preview.src=e.target.result;
        preview.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    } else {
      preview.src="";
      preview.classList.add('hidden');
    }
  };

  window.previewAnswerImage=function(input,questionIndex,answerIndex){
    var preview=document.getElementById('q'+questionIndex+'-a'+answerIndex+'-preview');
    if(!preview)return;
    if(input.files&&input.files[0]){
      var file=input.files[0];
      if(file.size>5*1024*1024){
        alert('File is too large. Maximum size is 5MB.');
        input.value='';
        return;
      }
      var reader=new FileReader();
      reader.onload=function(e){
        preview.src=e.target.result;
        preview.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    } else {
      preview.src="";
      preview.classList.add('hidden');
    }
  };

  // --- Poll & Image Uploader ---
  function savePoll(){
    var savePollBtn=document.getElementById('save-poll-btn');
    savePollBtn.disabled=true;
    savePollBtn.innerHTML='<div class="h-5 w-5 animate-spin rounded-full border-2 border-white border-t-transparent"></div><span>Saving...</span>';

    var pollName=document.getElementById('new-poll-name').value.trim();
    var className=document.getElementById('class-select').value;

    if(!pollName||!className){
      alert("Please enter a poll name and select a class.");
      savePollBtn.disabled=false;
      savePollBtn.innerHTML='<span class="material-symbols-outlined text-xl">save</span><span>Save Poll</span>';
      return;
    }

    var questions=[];
    var questionItems=document.getElementById('question-builder').querySelectorAll('[id^="question-"]');
    var uploadTasks=[];

    if(questionItems.length===0){
      alert("Please add at least one question.");
      savePollBtn.disabled=false;
      savePollBtn.innerHTML='<span class="material-symbols-outlined text-xl">save</span><span>Save Poll</span>';
      return;
    }

    for(var qi=0;qi<questionItems.length;qi++){
      var item=questionItems[qi];
      var qText=item.querySelector('.q-text').value.trim();
      var qImageInput=item.querySelector('.q-image');

      var questionData={
        questionText:qText,
        questionImageURL:null,
        options:[],
        correctAnswer:null
      };

      if(qImageInput.files&&qImageInput.files[0]){
        (function(qData){
          uploadTasks.push(uploadFile(qImageInput.files[0]).then(function(url){
            qData.questionImageURL=url;
          }));
        })(questionData);
      }

      var correctRadio=item.querySelector('.a-correct:checked');
      var correctIndex=correctRadio?parseInt(correctRadio.value):-1;
      var answerItems=item.querySelectorAll('[id^="q'+qi+'-answer-"]');
      var validAnswerCount=0;

      for(var ai=0;ai<answerItems.length;ai++){
        var aItem=answerItems[ai];
        var aText=aItem.querySelector('.a-text').value.trim();
        var aImageInput=aItem.querySelector('.a-image');

        if(!aText&&!(aImageInput.files&&aImageInput.files[0])){
          continue;
        }

        var optionData={text:aText,imageURL:null};

        if(aImageInput.files&&aImageInput.files[0]){
          (function(oData){
            uploadTasks.push(uploadFile(aImageInput.files[0]).then(function(url){
              oData.imageURL=url;
            }));
          })(optionData);
        }

        if(ai===correctIndex){
          questionData.correctAnswer=aText;
        }
        questionData.options.push(optionData);
        validAnswerCount++;
      }

      if(validAnswerCount<2){
        alert("Question "+(qi+1)+" must have at least 2 answer choices.");
        savePollBtn.disabled=false;
        savePollBtn.innerHTML='<span class="material-symbols-outlined text-xl">save</span><span>Save Poll</span>';
        return;
      }

      if(!questionData.correctAnswer&&validAnswerCount>0){
        var result=confirm("Question "+(qi+1)+" doesn't have a correct answer selected. Continue anyway?");
        if(!result){
          savePollBtn.disabled=false;
          savePollBtn.innerHTML='<span class="material-symbols-outlined text-xl">save</span><span>Save Poll</span>';
          return;
        }
      }
      questions.push(questionData);
    }

    Promise.all(uploadTasks).then(function(){
      google.script.run
        .withSuccessHandler(function(newPollsList){
          ALL_POLLS=newPollsList;
          updatePollDropdown();
          savePollBtn.disabled=false;
          savePollBtn.innerHTML='<span class="material-symbols-outlined text-xl">save</span><span>Save Poll</span>';
          closePollCreator();
          alert('âœ… Poll created successfully with '+questions.length+' questions!');
        })
        .withFailureHandler(function(error){
          handleError(error);
          savePollBtn.disabled=false;
          savePollBtn.innerHTML='<span class="material-symbols-outlined text-xl">save</span><span>Save Poll</span>';
        })
        .createNewPoll(pollName,className,questions);
    }).catch(function(err){
      alert('âŒ Upload error: '+err.message);
      savePollBtn.disabled=false;
      savePollBtn.innerHTML='<span class="material-symbols-outlined text-xl">save</span><span>Save Poll</span>';
    });
  }

  function fileToBase64(file){
    return new Promise(function(resolve,reject){
      var reader=new FileReader();
      reader.readAsDataURL(file);
      reader.onload=function(){
        resolve(reader.result);
      };
      reader.onerror=function(error){
        reject(error);
      };
    });
  }

  function uploadFile(file){
    return new Promise(function(resolve,reject){
      fileToBase64(file).then(function(dataUrl){
        google.script.run
          .withSuccessHandler(function(response){
            if(response.success){
              resolve(response.url);
            } else {
              reject(new Error(response.error||'Upload failed'));
            }
          })
          .withFailureHandler(reject)
          .uploadImageToDrive(dataUrl,file.name);
      }).catch(reject);
    });
  }

  // --- Utilities ---
  function escapeHtml(text){
    if(!text)return'';
    var div=document.createElement('div');
    div.textContent=text;
    return div.innerHTML;
  }

  function handleError(error){
    mainLoader.style.display='none';
    console.error('Error:',error);
    alert('Error: '+(error.message||error));
    var buttons=document.querySelectorAll('button');
    buttons.forEach(function(btn){btn.disabled=false;});
  }

  console.log('âœ“ Teacher Panel Ready');
})();
  </script>
</body>
</html>
