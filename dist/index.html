<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veritas Live Poll</title>
  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <script type="module" crossorigin src="/assets/main-B4H8gUl5.js"></script>
  <link rel="modulepreload" crossorigin href="/assets/firebase-7PLbf-9k.js">
  <link rel="modulepreload" crossorigin href="/assets/proctoring-CP4HimPX.js">
  <link rel="stylesheet" crossorigin href="/assets/firebase-DBKeXWac.css">
  <link rel="stylesheet" crossorigin href="/assets/main-Bbksik6c.css">
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-brand-dark-gray dark:text-brand-white">
  <!-- ðŸŽ¯ Ambient State Overlay - Provides visual feedback for system states -->
  <div id="ambient-state-overlay" class="ambient-state-overlay state-normal"></div>

  <div id="login-overlay">
    <!-- Background Shapes -->
    <div class="bg-shape bg-shape-1"></div>
    <div class="bg-shape bg-shape-2"></div>

    <div class="login-card">
      <div class="login-logo">
        <!-- Custom SVG Logo: Learning, Growth, & Exams -->
        <svg class="logo-svg" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
          <!-- Open Book Base (Learning) -->
          <path d="M15 75C15 75 35 68 50 75C65 68 85 75 85 75V35C85 35 65 28 50 35C35 28 15 35 15 35V75Z"
            fill="#12385D" />

          <!-- Inner Pages (Knowledge) -->
          <path d="M15 38C32 30 48 36 50 36V72C48 72 32 66 15 72V38Z" fill="rgba(255,255,255,0.1)" />
          <path d="M85 38C68 30 52 36 50 36V72C52 72 68 66 85 72V38Z" fill="rgba(255,255,255,0.15)" />

          <!-- Rising Growth/Torch Element (Growth & Searching) -->
          <path d="M50 55V25" stroke="#C5A05A" stroke-width="6" stroke-linecap="round" />

          <!-- Leaves / Torch Flame (Growth) -->
          <path d="M50 25C50 25 35 15 35 30" stroke="#C5A05A" stroke-width="6" stroke-linecap="round" />
          <path d="M50 25C50 25 65 15 65 30" stroke="#C5A05A" stroke-width="6" stroke-linecap="round" />

          <!-- Exam Checkmark Badge (Exams) -->
          <circle cx="78" cy="22" r="10" fill="#12385D" stroke="#ffffff" stroke-width="2" />
          <path d="M73 22L76 25L83 18" stroke="#C5A05A" stroke-width="3" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
      </div>

      <h1 class="login-title">Veritas Live</h1>
      <p class="login-subtitle">Secure Teacher Dashboard Access</p>

      <div class="login-form-container">
        <div class="input-group">
          <label class="input-label">Username or Email</label>
          <input type="text" id="login-username" class="input-field" placeholder="Enter your credentials">
        </div>

        <div class="input-group">
          <label class="input-label">Password</label>
          <input type="password" id="login-password" class="input-field" placeholder="Enter your password">
        </div>

        <button id="simple-login-btn" class="login-btn btn-primary"
          style="opacity: 0; animation: fadeInUp 0.6s ease-out 0.5s forwards;">
          Sign In
        </button>
      </div>

      <div class="divider"><span>OR</span></div>

      <button id="google-login-btn" class="login-btn btn-google"
        style="opacity: 0; animation: fadeInUp 0.6s ease-out 0.6s forwards;">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" height="20"
          alt="Google">
        Sign in with Google
      </button>

      <div id="login-error" class="login-error"></div>

      <div class="login-footer">
        &copy; 2026 Veritas Education. Professional Grade.
      </div>
    </div>
  </div>

  <!-- ðŸ”” Toast Notification Container - For elegant, non-intrusive alerts -->
  <div id="toast-container" class="toast-container"></div>

  <div id="dashboard-root" style="display: none;" class="flex h-screen w-full flex-col">
    <!-- Header - Default State -->
    <header id="header-default"
      class="flex flex-wrap items-center gap-4 border-b border-solid border-veritas-navy/80 bg-veritas-navy px-6 py-4 shadow-md">
      <div class="flex items-center gap-3">
        <button id="dashboard-sidebar-toggle" type="button"
          class="flex h-10 w-10 items-center justify-center rounded-full bg-brand-white/10 text-brand-white transition-colors hover:bg-brand-white/20 focus:outline-none focus:ring-2 focus:ring-brand-white/60"
          aria-label="Hide navigation" aria-expanded="true">
          <span class="material-symbols-outlined text-2xl">menu_open</span>
        </button>
        <div class="flex items-center gap-4 cursor-pointer hover:opacity-80 transition-opacity"
          onclick="showDashboard()"
          onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();showDashboard();}" role="button"
          tabindex="0">
          <img alt="Veritas Logo" class="h-12 w-auto"
            src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png" />
          <div class="flex flex-col">
            <h1 class="text-brand-white text-xl font-bold tracking-wide uppercase" style="letter-spacing: 0.15em;">
              Veritas
            </h1>
            <p class="text-brand-white/70 text-xs tracking-wide">Teacher Dashboard</p>
          </div>
        </div>
      </div>

      <div id="header-session-controls" class="flex flex-1 flex-wrap items-center justify-center gap-3 text-sm">
        <div class="min-w-[220px]">
          <label for="poll-select" class="sr-only">Select Poll to Start Session</label>
          <select id="poll-select"
            class="w-full rounded-lg border border-brand-white/30 bg-brand-white/10 px-3 py-2 text-sm text-brand-white placeholder-brand-white/70 focus:border-brand-white focus:outline-none focus:ring-2 focus:ring-veritas-gold/60">
            <option value="">-- Choose a poll --</option>
          </select>
        </div>
        <div class="flex flex-col gap-2">
          <div class="flex flex-wrap items-center gap-2">
            <button id="start-session-main-btn" type="button"
              class="flex items-center gap-2 h-10 px-5 rounded-lg bg-veritas-gold text-white text-sm font-semibold hover:bg-veritas-gold/90 transition-colors shadow-sm disabled:cursor-not-allowed disabled:opacity-60"
              disabled>
              <span class="material-symbols-outlined text-lg">play_circle</span>
              <span>Start Session</span>
            </button>
            <button id="send-link-btn" type="button"
              class="flex items-center gap-2 h-10 px-5 rounded-lg bg-green-600 text-white text-sm font-semibold hover:bg-green-700 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
              disabled>
              <span class="material-symbols-outlined text-lg">mail</span>
              <span>Send Links</span>
            </button>
            <button id="view-links-btn" type="button"
              class="flex items-center gap-2 h-10 px-5 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
              disabled>
              <span class="material-symbols-outlined text-lg">visibility</span>
              <span>View Links</span>
            </button>
          </div>
          <div id="secure-session-meta"
            class="hidden flex flex-row items-center gap-6 text-xs text-brand-white/90 bg-white/10 rounded-lg px-3 py-1.5 border border-white/20"
            aria-live="polite" aria-hidden="true">
            <!-- Content dynamically populated by updateSecureSessionMeta() -->
          </div>
          <!-- Student Emulator Controls (Dev/Testing) -->
          <div id="emulator-controls"
            class="hidden flex flex-row items-center gap-3 text-xs text-brand-white/90 bg-amber-600/20 rounded-lg px-3 py-1.5 border border-amber-500/30">
            <span class="material-symbols-outlined text-amber-400 text-base">science</span>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="emulator-enabled"
                class="w-4 h-4 rounded border-white/30 bg-white/10 text-amber-500 focus:ring-amber-500/50">
              <span class="text-amber-200 font-medium">Emulate Students</span>
            </label>
            <div id="emulator-options" class="hidden flex items-center gap-2 ml-2 pl-2 border-l border-amber-500/30">
              <label class="flex items-center gap-1">
                <span class="text-white/70">Count:</span>
                <input type="number" id="emulator-student-count" value="5" min="1" max="50"
                  class="w-14 h-6 rounded border border-white/30 bg-white/10 px-2 text-xs text-white focus:ring-amber-500/50">
              </label>
              <label class="flex items-center gap-1">
                <input type="checkbox" id="emulator-concurrent"
                  class="w-3.5 h-3.5 rounded border-white/30 bg-white/10 text-amber-500">
                <span class="text-white/70">Concurrent</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="header-right ml-auto flex items-center gap-3">
        <div id="loader" class="loader" style="display: block;">
          <div class="h-6 w-6 animate-spin rounded-full border-2 border-brand-white/80 border-t-transparent"></div>
        </div>
      </div>
    </header>

    <!-- Header - Live Poll State (COMPACT REDESIGN - Mobile Optimized) -->
    <!-- Header - Live Poll State -->
    <header id="header-live" class="shrink-0 bg-veritas-navy shadow-md border-b border-veritas-gold/30 z-20"
      style="display: none;">
      <div
        class="flex w-full items-center justify-between px-2 sm:px-4 py-2 gap-2 sm:gap-4 min-h-[48px] sm:h-16 relative">

        <!-- Left: Poll Context -->
        <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-shrink z-10">
          <button id="dashboard-sidebar-toggle-live" type="button"
            class="flex-shrink-0 h-7 w-7 sm:h-8 sm:w-8 flex items-center justify-center rounded-full bg-white/10 text-white hover:bg-white/20 transition-colors"
            aria-label="Toggle navigation">
            <span class="material-symbols-outlined text-lg sm:text-xl">menu</span>
          </button>
          <div class="min-w-0 flex flex-col justify-center">
            <h1 id="header-poll-name"
              class="text-white font-bold text-xs sm:text-sm md:text-base truncate leading-tight max-w-[100px] sm:max-w-[200px]">
              Poll Name
            </h1>
            <div class="flex items-center gap-2">
              <span class="flex h-2 w-2 rounded-full bg-green-500"></span>
              <span class="text-white/60 text-[10px] sm:text-xs font-medium uppercase tracking-wider">Live</span>
            </div>
          </div>
        </div>

        <!-- Center: Question Navigation (Absolute Center) -->
        <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 flex items-center gap-3 z-10">
          <!-- Present Button -->
          <button id="header-present-btn" type="button"
            class="hidden h-8 px-3 rounded-full bg-veritas-gold text-white text-xs font-bold shadow-lg hover:bg-veritas-gold/90 transition-transform active:scale-95 flex items-center gap-1">
            <span class="material-symbols-outlined text-base">present_to_all</span>
            <span class="hidden sm:inline">Present</span>
          </button>

          <span id="live-question-info"
            class="hidden font-mono tracking-wider uppercase bg-white/10 px-2 py-0.5 rounded-md border border-white/5 text-white/80 text-xs">Q1
            / 10</span>

          <button id="header-prev-btn" type="button"
            class="p-1.5 rounded-full text-white/50 hover:text-white hover:bg-white/10 transition-colors disabled:opacity-30 disabled:hover:bg-transparent"
            disabled>
            <span class="material-symbols-outlined">chevron_left</span>
          </button>
          <div id="question-progress-container" class="flex items-center gap-1.5"></div>
          <button id="header-next-btn" type="button"
            class="p-1.5 rounded-full text-white/50 hover:text-white hover:bg-white/10 transition-colors disabled:opacity-30 disabled:hover:bg-transparent">
            <span class="material-symbols-outlined">chevron_right</span>
          </button>
        </div>

        <!-- Right: Timer & Actions -->
        <div class="flex items-center gap-1 sm:gap-3 flex-shrink-0 z-10">
          <!-- Timer Control -->
          <div id="timer-main-container"
            class="flex items-center gap-0.5 sm:gap-2 bg-black/20 rounded-lg p-0.5 sm:p-1 border border-white/10 transition-colors">
            <button id="subtract-10s-btn" type="button"
              class="hidden md:flex w-7 h-7 sm:w-8 sm:h-8 items-center justify-center rounded text-white/70 hover:text-white hover:bg-white/10 transition-colors"
              title="-10s">
              <span class="material-symbols-outlined text-base sm:text-lg">remove</span>
            </button>
            <input type="text" id="timer-display"
              class="w-12 sm:w-16 md:w-20 bg-transparent text-center text-sm sm:text-lg md:text-xl font-bold text-white tabular-nums focus:outline-none focus:ring-1 focus:ring-veritas-gold rounded px-0.5 sm:px-1 cursor-pointer hover:bg-white/5"
              value="00:00" title="Click to edit time">
            <button id="add-10s-btn" type="button"
              class="hidden md:flex w-7 h-7 sm:w-8 sm:h-8 items-center justify-center rounded text-white/70 hover:text-white hover:bg-white/10 transition-colors"
              title="+10s">
              <span class="material-symbols-outlined text-base sm:text-lg">add</span>
            </button>
          </div>

          <!-- Tools Group -->
          <div class="flex items-center gap-1 sm:gap-2 bg-black/20 rounded-lg p-0.5 sm:p-1 border border-white/10">
            <button id="header-calc-toggle" type="button"
              class="hidden sm:flex w-7 h-7 sm:w-8 sm:h-8 items-center justify-center rounded text-white/70 hover:text-white hover:bg-white/10 transition-colors"
              aria-pressed="false" aria-live="polite" data-role="calculator-toggle" title="Calculator">
              <span class="material-symbols-outlined text-lg sm:text-xl">calculate</span>
            </button>
            <button id="header-whiteboard-btn" type="button"
              class="hidden sm:flex w-7 h-7 sm:w-8 sm:h-8 items-center justify-center rounded text-white/70 hover:text-white hover:bg-white/10 transition-colors"
              title="Whiteboard">
              <span class="material-symbols-outlined text-lg sm:text-xl">draw</span>
            </button>
          </div>

          <!-- Playback Controls -->
          <div class="flex items-center gap-1 sm:gap-2">
            <button id="start-btn" type="button"
              class="w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center rounded bg-emerald-500 hover:bg-emerald-600 text-white shadow-sm transition-colors"
              title="Start (Space)">
              <span class="material-symbols-outlined text-lg sm:text-xl">play_arrow</span>
            </button>
            <button id="pause-btn" type="button"
              class="hidden w-7 h-7 sm:w-8 sm:h-8 items-center justify-center rounded bg-amber-500 hover:bg-amber-600 text-white shadow-sm transition-colors"
              title="Pause (Space)">
              <span class="material-symbols-outlined text-lg sm:text-xl">pause</span>
            </button>
            <button id="reset-btn" type="button"
              class="hidden sm:flex w-7 h-7 sm:w-8 sm:h-8 items-center justify-center rounded text-white/70 hover:text-white hover:bg-white/10 transition-colors"
              title="Reset (R)">
              <span class="material-symbols-outlined text-base sm:text-lg">refresh</span>
            </button>
          </div>

          <div class="hidden sm:block w-px h-6 bg-white/10 mx-1"></div>

          <button id="header-end-show-btn" type="button"
            class="flex items-center gap-1 sm:gap-2 h-7 sm:h-9 px-2 sm:px-4 rounded bg-veritas-gold text-white font-bold text-xs sm:text-sm shadow hover:bg-veritas-gold/90 transition-all"
            title="End & Reveal (E)">
            <span class="material-symbols-outlined text-sm sm:text-base">visibility</span>
            <span class="hidden sm:inline">Reveal</span>
          </button>

          <!-- More Actions Dropdown -->
          <div class="relative">
            <button id="live-more-actions-btn"
              class="h-7 w-7 sm:h-9 sm:w-9 flex items-center justify-center rounded text-white hover:bg-white/10 transition-colors"
              aria-label="More actions" aria-haspopup="true">
              <span class="material-symbols-outlined text-lg sm:text-xl">more_vert</span>
            </button>
            <!-- Dropdown Menu -->
            <div id="live-more-menu"
              class="hidden absolute right-0 top-full mt-2 w-56 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 py-1 z-50 origin-top-right ring-1 ring-black ring-opacity-5 focus:outline-none"
              role="menu">

              <!-- Calculator Toggle (Inside Menu - REMOVED, moved to top bar) -->


              <button id="header-edit-poll-btn"
                class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2"
                role="menuitem">
                <span class="material-symbols-outlined text-base">edit</span> Edit Poll
              </button>
              <button id="header-reset-question-btn"
                class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2"
                role="menuitem">
                <span class="material-symbols-outlined text-base">replay</span> Reset Question
              </button>
              <button id="header-send-link-btn"
                class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2"
                role="menuitem">
                <span class="material-symbols-outlined text-base">mail</span> Send Links
              </button>
              <button id="header-stop-btn"
                class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2"
                role="menuitem">
                <span class="material-symbols-outlined text-base">stop_circle</span> End Session
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Hidden legacy buttons to prevent JS errors -->
      <button id="header-start-btn" class="hidden"></button>
    </header>

    <div class="flex flex-grow overflow-hidden min-h-0">
      <!-- Left Navigation Sidebar -->
      <aside id="dashboard-sidebar"
        class="h-full w-64 flex flex-shrink-0 flex-col border-r border-veritas-navy/25 bg-veritas-navy p-4 text-brand-white shadow-lg transition-all duration-300 ease-in-out overflow-hidden">
        <div class="mb-4 px-1">
          <p class="text-xs font-semibold uppercase tracking-[0.32em] text-brand-white/60">Navigation</p>
        </div>
        <nav class="flex flex-1 flex-col gap-2">
          <button id="nav-polls-list" data-section-target="dashboard"
            class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg font-semibold transition-colors text-left"
            aria-current="page">
            <span class="material-symbols-outlined">monitoring</span>
            <span>Live Dashboard</span>
          </button>
          <button id="nav-create-poll"
            class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg text-left transition-colors font-semibold">
            <span class="material-symbols-outlined">add_circle</span>
            <span>Create New Poll</span>
          </button>
          <button id="nav-question-bank" onclick="window.location.href='/teacher/question_bank.html'"
            class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left text-brand-white/70 hover:text-brand-white hover:bg-white/10">
            <span class="material-symbols-outlined">library_books</span>
            <span>Question Bank</span>
          </button>
          <button id="nav-rosters" data-section-target="roster"
            class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left">
            <span class="material-symbols-outlined">group</span>
            <span>Classes &amp; Rosters</span>
          </button>
          <button id="nav-archived" data-section-target="archived"
            class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left">
            <span class="material-symbols-outlined">inventory_2</span>
            <span>Archived Polls</span>
          </button>
          <button id="nav-analytics" data-section-target="analytics"
            class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left">
            <span class="material-symbols-outlined">analytics</span>
            <span>Analytics Hub</span>
          </button>
          <button id="nav-migration" onclick="openMigrationModal()"
            class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left mt-auto text-brand-white/70 hover:text-brand-white hover:bg-white/10">
            <span class="material-symbols-outlined">cloud_upload</span>
            <span>Import Data</span>
          </button>
        </nav>
        <div
          class="mt-6 rounded-lg border border-brand-white/10 bg-brand-white/5 px-3 py-3 text-xs text-brand-white/70">
          <p class="font-semibold uppercase tracking-[0.18em] text-brand-white/60">Tip</p>
          <p class="mt-1 leading-relaxed">Use the controls in the top bar to quickly start a live session from any poll.
          </p>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main class="flex-1 min-h-0 overflow-y-auto bg-gray-50 dark:bg-brand-dark-gray/10 flex flex-col">
        <!-- Dashboard View (Default) - Redesigned -->
        <div id="dashboard" class="p-8 max-w-7xl mx-auto">
          <!-- Poll Library & Session Management (Combined) -->
          <div class="dashboard-card glass-card premium-shadow p-8 rounded-2xl">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
              <div>
                <h2 class="text-2xl font-bold text-veritas-navy mb-1">Poll Library & Session Management</h2>
                <p class="text-gray-600 text-sm">Use the session controls in the header to start a live session, or
                  create, edit, and manage your polls below.</p>
              </div>
            </div>

            <!-- Poll Library Controls -->
            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
              <h3 class="text-lg font-semibold text-veritas-navy">Your Polls</h3>
              <div class="flex flex-wrap items-center gap-3">
                <label class="flex items-center gap-2 text-sm text-gray-600">
                  <span class="hidden sm:inline">Sort by</span>
                  <select id="poll-sort-select"
                    class="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-veritas-gold">
                    <option value="updated_desc">Latest activity</option>
                    <option value="updated_asc">Oldest activity</option>
                    <option value="name_asc">Name A â†’ Z</option>
                    <option value="class_asc">Class A â†’ Z</option>
                  </select>
                </label>
                <label class="flex items-center gap-2 text-sm text-gray-600">
                  <span class="hidden sm:inline">Class</span>
                  <select id="poll-filter-select"
                    class="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-veritas-gold">
                    <option value="all">All classes</option>
                  </select>
                </label>
                <div id="poll-search-container" class="relative w-full sm:w-64">
                  <span
                    class="material-symbols-outlined pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-400 z-10">search</span>
                  <input id="poll-search-input" type="text" placeholder="Search polls, questions..."
                    class="w-full rounded-lg border border-gray-300 bg-white pl-9 pr-8 py-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-veritas-gold shadow-sm"
                    aria-label="Search polls" autocomplete="off" />
                  <button type="button"
                    class="absolute inset-y-0 right-0 flex items-center px-2 text-gray-400 hover:text-gray-600 focus:outline-none"
                    data-combobox-toggle>
                    <span class="material-symbols-outlined text-lg">unfold_more</span>
                  </button>
                  <button id="poll-search-clear-btn" type="button"
                    class="hidden absolute right-8 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none"
                    aria-label="Clear search">
                    <span class="material-symbols-outlined text-base leading-none">close</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- ENHANCED: Toggle between Table and Card View -->
            <div class="mb-4 flex items-center justify-end gap-2">
              <span class="text-xs text-gray-500 font-medium">View:</span>
              <button id="view-cards-btn"
                class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-veritas-navy/10 text-veritas-navy transition-colors"
                title="Card view">
                <span class="material-symbols-outlined text-base align-middle">grid_view</span>
              </button>
              <button id="view-table-btn"
                class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors"
                title="Table view">
                <span class="material-symbols-outlined text-base align-middle">table_rows</span>
              </button>
            </div>

            <!-- Card View (Default, More Visual) -->
            <div id="polls-card-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
              <!-- Poll cards will be dynamically inserted here -->
            </div>

            <!-- Table View (Optional, More Compact) -->
            <div id="polls-table-view" class="overflow-hidden rounded-lg border border-gray-200 hidden">
              <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50 text-gray-600">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold">Poll</th>
                    <th class="px-4 py-3 text-left font-semibold">Class</th>
                    <th class="px-4 py-3 text-left font-semibold">Questions</th>
                    <th class="px-4 py-3 text-left font-semibold">Mode</th>
                    <th class="px-4 py-3 text-left font-semibold">Last Edited</th>
                    <th class="px-4 py-3 text-right font-semibold">Actions</th>
                  </tr>
                </thead>
                <tbody id="polls-table-body" class="divide-y divide-gray-100 bg-white"></tbody>
              </table>
            </div>

            <!-- Enhanced Empty State -->
            <div id="polls-empty-state"
              class="hidden text-center p-12 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl">
              <div class="max-w-lg mx-auto">
                <div class="inline-block p-4 bg-veritas-navy/10 rounded-full mb-4">
                  <span
                    class="material-symbols-outlined text-5xl text-veritas-navy dark:text-veritas-gold">school</span>
                </div>
                <h3 class="text-2xl font-bold text-veritas-navy dark:text-white mb-2">Poll Library</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Create and manage your interactive polls and secure
                  assessments here.</p>
                <button onclick="Wizard.init()" class="dashboard-cta-button primary">
                  <span class="material-symbols-outlined">add_circle</span>
                  <span>Create New Poll</span>
                </button>
              </div>
            </div>
          </div>

        </div>

        <!-- Individual Timed Session Monitoring View -->
        <div id="individual-timed-view" class="p-6" style="display: none;">
          <div
            class="bg-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
              <div>
                <h2 id="individual-session-poll-name"
                  class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">Individual Timed Session</h2>
                <p id="individual-session-meta" class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm">
                  Monitoring student progress in real-time.</p>
              </div>
              <div class="flex items-center gap-2">
                <button id="secure-view-links-btn"
                  class="h-10 px-5 rounded-lg bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 transition-colors flex items-center gap-2">
                  <span class="material-symbols-outlined text-lg">link</span>
                  <span>View Links</span>
                </button>
                <button id="view-book-report-btn"
                  class="h-10 px-5 rounded-lg bg-veritas-gold text-white text-sm font-bold hover:bg-veritas-gold/90 transition-colors flex items-center gap-2">
                  <span class="material-symbols-outlined text-lg">menu_book</span>
                  <span>Book View</span>
                </button>
                <button id="end-individual-session-btn"
                  class="h-10 px-5 rounded-lg bg-red-600 text-white text-sm font-bold hover:bg-red-700 transition-colors">End
                  Session</button>
              </div>
            </div>
            <div id="mission-control-summary" class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
              <div class="p-4 rounded-xl border border-brand-light-gray/70 bg-slate-50 dark:bg-brand-dark-gray/20">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Not Started</p>
                <p id="summary-not-started" class="text-3xl font-bold text-slate-900 dark:text-white">0</p>
              </div>
              <div class="p-4 rounded-xl border border-emerald-200 bg-emerald-50 dark:bg-emerald-900/30">
                <p class="text-xs font-semibold uppercase tracking-wide text-emerald-700 dark:text-emerald-200">In
                  Progress</p>
                <p id="summary-in-progress" class="text-3xl font-bold text-emerald-800 dark:text-emerald-100">0</p>
              </div>
              <div class="p-4 rounded-xl border border-amber-200 bg-amber-50 dark:bg-amber-900/20">
                <p class="text-xs font-semibold uppercase tracking-wide text-amber-700 dark:text-amber-200">Locked /
                  Paused</p>
                <p id="summary-locked" class="text-3xl font-bold text-amber-800 dark:text-amber-100">0</p>
              </div>
              <div class="p-4 rounded-xl border border-slate-200 bg-slate-50 dark:bg-slate-800/40">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-300">Submitted
                </p>
                <p id="summary-completed" class="text-3xl font-bold text-slate-900 dark:text-white">0</p>
              </div>
            </div>
            <div class="grid gap-4 lg:grid-cols-[minmax(0,3fr)_minmax(0,2fr)] mb-6">
              <div
                class="p-4 rounded-xl border border-brand-light-gray/70 bg-white dark:bg-brand-dark-gray/20 shadow-sm">
                <div class="flex flex-col gap-3">
                  <div class="flex flex-wrap items-center gap-3">
                    <span
                      class="text-sm font-semibold text-brand-dark-gray dark:text-white uppercase tracking-wide">Extend
                      time</span>
                    <div class="flex items-center gap-2">
                      <input id="bulk-time-input" type="number" min="1" step="1" value="5"
                        class="w-20 rounded-lg border border-slate-200 bg-white/90 px-3 py-1.5 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-veritas-gold"
                        aria-label="Minutes to extend" />
                      <span class="text-xs text-slate-500">minutes</span>
                    </div>
                  </div>
                  <div class="flex flex-wrap items-center gap-3">
                    <button id="bulk-time-all-btn" type="button"
                      class="inline-flex items-center gap-2 rounded-full bg-veritas-navy text-white px-4 py-2 text-sm font-semibold shadow hover:bg-veritas-navy/90 transition-colors">
                      <span class="material-symbols-outlined text-base">schedule_add</span>
                      <span>Add to entire class</span>
                    </button>
                    <button id="bulk-time-selected-btn" type="button"
                      class="inline-flex items-center gap-2 rounded-full bg-emerald-600 text-white px-4 py-2 text-sm font-semibold shadow hover:bg-emerald-700 transition-colors disabled:opacity-60"
                      disabled>
                      <span class="material-symbols-outlined text-base">group_add</span>
                      <span id="bulk-selected-label">Add to selected</span>
                    </button>
                    <button id="bulk-selection-clear" type="button"
                      class="text-xs font-semibold text-slate-500 underline hidden">Clear selection</button>
                  </div>
                  <p class="text-xs text-slate-500">Selecting student cards enables targeted adjustments. <span
                      id="bulk-selection-count">0</span> students selected.</p>
                </div>
              </div>
              <div
                class="p-4 rounded-xl border border-brand-light-gray/70 bg-slate-50 dark:bg-brand-dark-gray/20 shadow-sm">
                <h4 class="text-sm font-semibold text-brand-dark-gray dark:text-white mb-2 flex items-center gap-2">
                  <span class="material-symbols-outlined text-base text-veritas-navy">visibility_lock</span>
                  Re-entry monitoring
                </h4>
                <p class="text-xs text-slate-500 leading-relaxed">Locked students will surface an "Approve re-entry"
                  action on their tile so you can clear violations without leaving Mission Control.</p>
              </div>
            </div>
            <div id="individual-session-students-grid"
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
              <!-- Student cards will be dynamically inserted here -->
            </div>
          </div>
        </div>

        <!-- Live Poll View (REDESIGNED FOR MISSION CONTROL) -->
        <div id="live-view" class="flex flex-col h-full min-h-0 overflow-hidden bg-gray-50 dark:bg-gray-900"
          style="display: none;">

          <!-- 1. Top Control Bar (REMOVED - Consolidated into header-live) -->


          <!-- 2. Main High-Density Grid -->
          <main class="flex-1 flex flex-col lg:flex-row overflow-hidden">

            <!-- LEFT PANEL: Question & Content (45% on large screens) -->
            <div id="live-question-panel"
              class="w-full lg:w-[45%] h-1/3 lg:h-full flex flex-col border-r border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10">
              <div class="flex-1 overflow-y-auto px-6 pb-6 pt-4 space-y-6">
                <!-- Question Card -->
                <div class="space-y-4">
                  <span class="text-xs font-bold tracking-widest text-indigo-500 uppercase">Current Question</span>
                  <h2 id="live-question-text"
                    class="text-2xl font-serif font-medium text-gray-900 dark:text-white leading-relaxed">
                    Loading question...
                  </h2>
                </div>

                <!-- Dynamic Media Container -->
                <div id="question-image-container"
                  class="relative group rounded-xl overflow-hidden border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 hidden">
                  <img id="live-question-image" src=""
                    class="w-full h-auto max-h-[400px] object-contain transition-transform group-hover:scale-[1.02]"
                    alt="Question Media">
                  <button
                    class="absolute top-2 right-2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-lg backdrop-blur-sm transition-opacity opacity-0 group-hover:opacity-100"
                    title="Expand Image">
                    <span class="material-symbols-outlined">zoom_in</span>
                  </button>
                </div>

                <!-- Answer Choices (Interactive Stats) -->
                <div class="space-y-3 pt-4">
                  <div class="flex items-center justify-between">
                    <span class="text-xs font-bold tracking-widest text-gray-400 uppercase">Responses</span>
                    <span id="response-count-header" class="text-xs font-medium text-gray-500">0 answered</span>
                  </div>
                  <div id="results-bars" class="space-y-3">
                    <!-- Populated dynamically: Bars with percentages -->
                  </div>
                </div>
              </div>
            </div>

            <!-- RIGHT PANEL: Proctoring Mission Control (55% on large screens) -->
            <div id="live-student-panel"
              class="w-full lg:w-[55%] h-2/3 lg:h-full flex flex-col bg-gray-50/50 dark:bg-gray-900/50">

              <!-- Metrics Heads-Up Display -->
              <div
                class="h-16 px-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-white/50 dark:bg-gray-800/50 backdrop-blur-md">
                <div class="flex gap-6">
                  <!-- Metric: Response Rate -->
                  <div class="flex items-baseline gap-2">
                    <span class="text-2xl font-bold text-gray-900 dark:text-white" id="hud-response-count">0/0</span>
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Responses</span>
                  </div>
                  <!-- Metric: Accuracy -->
                  <div class="flex items-baseline gap-2 pl-6 border-l border-gray-200 dark:border-gray-700">
                    <span class="text-2xl font-bold text-emerald-600" id="hud-accuracy-value">--%</span>
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Accuracy</span>
                  </div>
                  <!-- Metric: Metacognition Index (New) -->
                  <div class="flex items-baseline gap-2 pl-6 border-l border-gray-200 dark:border-gray-700"
                    title="Class Confidence Index">
                    <div class="flex items-center gap-1 text-indigo-600">
                      <span class="material-symbols-outlined text-lg">psychology</span>
                      <span class="text-xl font-bold" id="hud-metacognition-value">--</span>
                    </div>
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Confidence</span>
                  </div>
                </div>

                <!-- Filter Controls -->
                <div class="flex items-center gap-2 bg-gray-200 dark:bg-gray-700 p-1 rounded-lg">
                  <button id="filter-all-btn"
                    class="px-3 py-1 text-xs font-bold rounded-md bg-white dark:bg-gray-600 text-gray-800 dark:text-white shadow-sm transition-all">ALL</button>
                  <button id="filter-locked-only-btn"
                    class="px-3 py-1 text-xs font-bold rounded-md text-gray-500 hover:text-gray-700 dark:text-gray-400 hover:bg-gray-300 dark:hover:bg-gray-600 transition-all flex items-center gap-1">
                    <span>LOCKED</span>
                    <span id="locked-count"
                      class="bg-red-500 text-white text-[10px] px-1.5 rounded-full hidden">0</span>
                  </button>
                </div>
              </div>

              <!-- Student Grid (Scrollable) -->
              <div id="student-status-grid"
                class="flex-1 overflow-y-auto custom-scrollbar p-6 grid grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4 content-start">
                <!-- Cards injected here -->
                <!-- Example Card Structure for reference (created by JS):
                    <div class="student-card p-3 rounded-xl bg-white border border-gray-200 shadow-sm relative group hover:shadow-md transition-all">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-bold text-sm text-gray-800 truncate">Student Name</span>
                            <span class="status-indicator w-2 h-2 rounded-full bg-gray-300"></span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-mono text-gray-500">Thinking...</span>
                            <span class="metacognition-dot w-3 h-3 rounded-full bg-indigo-100"></span>
                        </div>
                    </div>
                    -->
              </div>
            </div>
          </main>

          <!-- TI-84 Iframe Container (Draggable) -->
          <!-- Hidden by default, toggled via #header-calc-toggle -->
          <div id="calculator-draggable"
            class="hidden absolute top-20 right-20 w-[400px] h-[640px] bg-white dark:bg-gray-800 rounded-3xl shadow-2xl border border-gray-200 dark:border-gray-700 z-50 overflow-hidden flex flex-col shadow-indigo-500/20">
            <!-- Drag Handle -->
            <div id="calculator-drag-handle"
              class="h-8 bg-gray-100 dark:bg-gray-700 cursor-move flex items-center justify-between px-3 border-b border-gray-200 dark:border-gray-600">
              <div class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-red-400"></span>
                <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
                <span class="w-2 h-2 rounded-full bg-green-400"></span>
              </div>
              <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">TI-84 Plus</span>
              <span class="material-symbols-outlined text-sm text-gray-400">drag_indicator</span>
            </div>
            <!-- Iframe -->
            <iframe src="https://mpcalc-aaa91.web.app/" class="w-full h-full border-0 bg-gray-100"
              title="TI-84 Calculator"></iframe>
          </div>

          <!-- Student Inspector Panel (Slide-over) -->
          <div id="student-inspector-panel"
            class="hidden fixed top-16 bottom-0 right-0 w-96 bg-white dark:bg-gray-800 shadow-2xl border-l border-gray-200 dark:border-gray-700 z-[60] transform transition-transform duration-300 flex flex-col">
            <!-- Content injected dynamically by openStudentInspector() -->
          </div>

          <!-- Whiteboard Overlay -->
          <div id="whiteboard-overlay"
            class="hidden fixed inset-0 z-[70] bg-white/95 dark:bg-gray-900/95 flex flex-col">
            <div class="h-14 flex items-center justify-between px-6 border-b border-gray-200 dark:border-gray-700">
              <h2 class="font-bold text-gray-800 dark:text-white">Whiteboard</h2>
              <div class="flex items-center gap-2">
                <button id="wb-clear-btn"
                  class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm font-bold">Clear</button>
                <button id="wb-close-btn"
                  class="p-2 text-gray-500 hover:text-gray-700 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
                  <span class="material-symbols-outlined">close</span>
                </button>
              </div>
            </div>
            <div class="flex-1 relative cursor-crosshair">
              <canvas id="wb-canvas" class="absolute inset-0 w-full h-full"></canvas>
              <div id="wb-controls"
                class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-white dark:bg-gray-800 shadow-lg rounded-full px-4 py-2 flex items-center gap-4 border border-gray-200 dark:border-gray-700">
                <button class="wb-tool active p-2 rounded-full hover:bg-gray-100 text-emerald-600" data-color="#059669"
                  data-size="4">
                  <span class="material-symbols-outlined">edit</span>
                </button>
                <button class="wb-tool p-2 rounded-full hover:bg-gray-100 text-blue-600" data-color="#2563eb"
                  data-size="4">
                  <span class="material-symbols-outlined">edit</span>
                </button>
                <button class="wb-tool p-2 rounded-full hover:bg-gray-100 text-red-600" data-color="#dc2626"
                  data-size="4">
                  <span class="material-symbols-outlined">edit</span>
                </button>
                <div class="w-px h-6 bg-gray-300"></div>
                <button class="wb-tool p-2 rounded-full hover:bg-gray-100 text-gray-500" data-mode="eraser">
                  <span class="material-symbols-outlined">ink_eraser</span>
                </button>
              </div>
            </div>
          </div>
        </div>


        <!-- Hidden elements for compatibility -->
        <div class="hidden">
          <div id="live-session-overview">
            <p id="live-overview-responses">0 / 0</p>
            <div id="live-overview-response-progress" style="width: 0%;"></div>
            <p id="live-overview-response-caption">0%</p>
            <p id="live-overview-accuracy">0%</p>
            <p id="live-overview-accuracy-caption"></p>
            <p id="live-overview-lockouts">0</p>
            <p id="live-overview-lockouts-caption"></p>
            <p id="live-overview-waiting">0</p>
            <p id="live-overview-waiting-caption"></p>
            <button id="focus-lockouts-btn" type="button" disabled></button>
          </div>
          <div id="response-count">0 / 0</div>
          <div id="violations-alert-panel"></div>
          <div id="violations-summary"></div>
          <div id="violations-quick-list"></div>
          <button id="dismiss-violations-alert"></button>
          <button id="toggle-exited-panel-btn"></button>
          <div id="exited-students-list"></div>
          <button id="toggle-sidebar-btn"></button>
          <span id="sidebar-toggle-icon"></span>
          <span id="sidebar-toggle-label"></span>
        </div>

    </div>

    <!-- âš¡ Floating Action Button (FAB) Cluster - Primary Actions for Live Session -->
    <div id="fab-container" class="fab-container" style="display: none;">
      <!-- FAB Menu Items -->
      <div id="fab-menu" class="fab-menu">
        <!-- Activity Feed Toggle -->
        <div class="fab-action">
          <span class="fab-label">Activity Feed</span>
          <button id="fab-activity-btn" class="fab-button fab-info" title="View recent activity"
            aria-label="Toggle activity feed">
            <span class="material-symbols-outlined">notifications</span>
          </button>
        </div>

        <!-- Next Question Action -->
        <div class="fab-action">
          <span class="fab-label">Next Question â†’</span>
          <button id="fab-next-btn" class="fab-button fab-primary" title="Advance to next question"
            aria-label="Next question">
            <span class="material-symbols-outlined">arrow_forward</span>
          </button>
        </div>

        <!-- Show Results Action -->
        <div class="fab-action">
          <span class="fab-label">Show Results</span>
          <button id="fab-show-results-btn" class="fab-button fab-success" title="Reveal answer to students"
            aria-label="Show results">
            <span class="material-symbols-outlined">visibility</span>
          </button>
        </div>

        <!-- Reset Question Action -->
        <div class="fab-action">
          <span class="fab-label">Reset Question</span>
          <button id="fab-reset-btn" class="fab-button fab-info" title="Reset current question"
            aria-label="Reset question">
            <span class="material-symbols-outlined">replay</span>
          </button>
        </div>

        <!-- Stop Session Action -->
        <div class="fab-action">
          <span class="fab-label">End Session</span>
          <button id="fab-stop-btn" class="fab-button fab-danger" title="End the entire session"
            aria-label="Stop session">
            <span class="material-symbols-outlined">stop</span>
          </button>
        </div>
      </div>

      <!-- FAB Main Toggle Button -->
      <button id="fab-main-toggle" class="fab-main" aria-label="Quick actions menu" aria-expanded="false">
        <span class="material-symbols-outlined">bolt</span>
      </button>
    </div>

    <!-- ðŸ“Š Real-Time Activity Feed - Shows recent student actions -->
    <div id="activity-feed" class="activity-feed">
      <div class="activity-feed-header">
        <div class="activity-feed-title">
          <span class="material-symbols-outlined">notifications</span>
          <span>Recent Activity</span>
          <span id="activity-feed-count" class="activity-feed-badge">0</span>
        </div>
        <button id="activity-feed-close" class="activity-feed-close" aria-label="Close activity feed">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div id="activity-feed-list" class="activity-feed-list">
        <!-- Activity items will be dynamically inserted here -->
        <div class="activity-feed-empty">
          <span class="material-symbols-outlined">inbox</span>
          <p>No recent activity</p>
        </div>
      </div>
    </div>

    <!-- End of Live Poll View Redesign -->
    <!-- Roster Manager View -->
    <div id="roster-manager"
      class="p-6 grid grid-cols-1 lg:grid-cols-4 gap-6 bg-gray-50 dark:bg-brand-dark-gray/10 min-h-full"
      style="display: none;">
      <div
        class="lg:col-span-1 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-5 shadow-sm flex flex-col">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white">Classes</h2>
          <button id="add-class-btn"
            class="flex items-center justify-center h-9 w-9 rounded-full bg-primary text-brand-white hover:bg-primary/90 transition-colors"
            title="Add class">
            <span class="material-symbols-outlined text-base">add</span>
          </button>
        </div>
        <div id="roster-class-list" class="flex-1 overflow-y-auto space-y-2">
          <!-- Classes will render here -->
        </div>
      </div>
      <div
        class="lg:col-span-3 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
        <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
          <div>
            <h2 id="roster-class-title" class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">Select a
              class</h2>
            <p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm">Manage student names and emails for
              rostered classes.</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="rename-class-btn"
              class="hidden h-9 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">Rename</button>
            <button id="delete-class-btn"
              class="hidden h-9 px-4 rounded-lg bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-sm font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors">Delete</button>
          </div>
        </div>
        <div id="roster-empty-state"
          class="border border-dashed border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-10 text-center text-brand-dark-gray/60 dark:text-brand-white/60">
          <p>Choose a class on the left to view its roster.</p>
        </div>
        <div id="roster-table-wrapper" class="hidden flex flex-col gap-4">
          <div class="overflow-x-auto border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg">
            <table class="min-w-full divide-y divide-brand-light-gray dark:divide-brand-dark-gray text-sm">
              <thead
                class="bg-brand-light-gray/50 dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white">
                <tr>
                  <th class="px-4 py-2 text-left font-semibold w-1/2">Student Name</th>
                  <th class="px-4 py-2 text-left font-semibold w-1/2">Email</th>
                  <th class="px-4 py-2 text-center font-semibold w-16">Remove</th>
                </tr>
              </thead>
              <tbody id="roster-table-body" class="divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/50">
              </tbody>
            </table>
          </div>
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="flex items-center gap-3">
              <button id="add-student-row-btn"
                class="h-10 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">+
                Add Student</button>
              <button id="bulk-add-students-btn"
                class="h-10 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">Bulk
                Add Students</button>
              <span id="roster-status" class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60"></span>
            </div>
            <button id="save-roster-btn"
              class="h-10 px-5 rounded-lg bg-primary text-brand-white text-sm font-bold hover:bg-primary/90 transition-colors">Save
              Roster</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Student Detail Inspector Modal (New for Phase 4) -->
    <div id="student-inspector-modal" class="fixed inset-0 z-[60] hidden">
      <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" data-close-inspector="true"></div>
      <div
        class="relative w-full max-w-4xl mx-auto my-12 bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col max-h-[90vh]">

        <!-- 1. Header -->
        <div
          class="flex items-start justify-between p-6 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-gray-800/50">
          <div class="flex items-center gap-4">
            <div
              class="h-16 w-16 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-2xl font-bold text-indigo-600 dark:text-indigo-400">
              <span id="inspector-initials">--</span>
            </div>
            <div>
              <h2 id="inspector-name" class="text-2xl font-bold text-gray-900 dark:text-white leading-tight">Student
                Name
              </h2>
              <div class="flex items-center gap-3 mt-1 text-sm">
                <span id="inspector-email" class="text-gray-500 font-medium">student@example.com</span>
                <span id="inspector-status-badge"
                  class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 text-xs font-bold uppercase tracking-wide">Offline</span>
              </div>
            </div>
          </div>
          <button
            class="h-10 w-10 flex items-center justify-center rounded-full bg-white dark:bg-gray-800 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors shadow-sm border border-gray-200 dark:border-gray-700"
            data-close-inspector="true">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>

        <!-- 2. Integrated Analytics Grid -->
        <div class="grid grid-cols-3 gap-6 p-6 pb-2">
          <!-- Accuracy Card -->
          <div
            class="p-4 rounded-xl bg-indigo-50 dark:bg-indigo-900/10 border border-indigo-100 dark:border-indigo-800 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
              <span class="material-symbols-outlined text-6xl text-indigo-600">check_circle</span>
            </div>
            <p class="text-xs font-bold uppercase tracking-wider text-indigo-600 dark:text-indigo-400 mb-1">Accuracy</p>
            <div class="flex items-baseline gap-2">
              <span id="inspector-accuracy" class="text-3xl font-black text-indigo-800 dark:text-indigo-300">--%</span>
              <span id="inspector-correct-count" class="text-sm font-semibold text-indigo-600/70">0/0 correct</span>
            </div>
          </div>

          <!-- Violations Card -->
          <div
            class="p-4 rounded-xl bg-amber-50 dark:bg-amber-900/10 border border-amber-100 dark:border-amber-800 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
              <span class="material-symbols-outlined text-6xl text-amber-600">warning</span>
            </div>
            <p class="text-xs font-bold uppercase tracking-wider text-amber-600 dark:text-amber-400 mb-1">Violations</p>
            <div class="flex items-baseline gap-2">
              <span id="inspector-violations" class="text-3xl font-black text-amber-800 dark:text-amber-300">0</span>
              <span class="text-sm font-semibold text-amber-600/70">tab switches</span>
            </div>
          </div>

          <!-- Speed Card -->
          <div
            class="p-4 rounded-xl bg-emerald-50 dark:bg-emerald-900/10 border border-emerald-100 dark:border-emerald-800 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
              <span class="material-symbols-outlined text-6xl text-emerald-600">timer</span>
            </div>
            <p class="text-xs font-bold uppercase tracking-wider text-emerald-600 dark:text-emerald-400 mb-1">Avg. Speed
            </p>
            <div class="flex items-baseline gap-2">
              <span id="inspector-speed" class="text-3xl font-black text-emerald-800 dark:text-emerald-300">--s</span>
              <span class="text-sm font-semibold text-emerald-600/70">per question</span>
            </div>
          </div>
        </div>

        <!-- 3. Session History Label -->
        <div class="px-6 py-2">
          <h3 class="text-sm font-bold uppercase tracking-wider text-gray-500">Session History</h3>
        </div>

        <!-- 4. Scrollable History Table -->
        <div class="flex-1 overflow-y-auto custom-scrollbar px-6 pb-6">
          <table class="w-full text-left text-sm">
            <thead class="sticky top-0 bg-white dark:bg-gray-900 z-10 box-decoration-clone">
              <tr class="text-xs text-gray-400 uppercase tracking-wide border-b border-gray-100 dark:border-gray-800">
                <th class="py-3 font-semibold">Q#</th>
                <th class="py-3 font-semibold">Question</th>
                <th class="py-3 font-semibold">Response</th>
                <th class="py-3 font-semibold text-center">Result</th>
                <th class="py-3 font-semibold text-right">Time</th>
              </tr>
            </thead>
            <tbody id="inspector-history-body" class="divide-y divide-gray-50 dark:divide-gray-800">
              <!-- Populated by JS -->
            </tbody>
          </table>

          <!-- Empty State -->
          <div id="inspector-empty-state" class="hidden py-12 text-center text-gray-400">
            <p>No activity recorded yet.</p>
          </div>
        </div>

        <!-- 5. Footer Actions -->
        <div
          class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-800 flex justify-end gap-3">
          <button class="px-4 py-2 rounded-lg font-bold text-gray-600 hover:bg-gray-200 transition-colors text-sm"
            data-close-inspector="true">Close</button>
        </div>
      </div>
    </div>
    <!-- Archived Polls View -->
    <div id="archived-view"
      class="p-6 grid grid-cols-1 lg:grid-cols-4 gap-6 bg-gray-50 dark:bg-brand-dark-gray/10 min-h-full"
      style="display: none;">
      <div
        class="lg:col-span-1 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-5 shadow-sm flex flex-col">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white">Archived Polls</h2>
          <button id="refresh-archived-btn"
            class="flex items-center justify-center h-9 w-9 rounded-full bg-primary text-brand-white hover:bg-primary/90 transition-colors"
            title="Refresh">
            <span class="material-symbols-outlined text-base">refresh</span>
          </button>
        </div>
        <label
          class="block text-xs font-semibold uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">Class
          Filter</label>
        <select id="archived-class-filter"
          class="mb-4 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
          <option value="all">All classes</option>
        </select>
        <div id="archived-list" class="flex-1 overflow-y-auto space-y-2">
          <!-- Archived polls list -->
        </div>
      </div>
      <div
        class="lg:col-span-3 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
        <div id="archived-empty-state"
          class="border border-dashed border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-10 text-center text-brand-dark-gray/60 dark:text-brand-white/60">
          <p>Select an archived poll to review student performance.</p>
        </div>
        <div id="archived-detail" class="hidden flex flex-col gap-6">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <h2 id="archived-poll-title" class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white"></h2>
              <p id="archived-poll-meta" class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm"></p>
            </div>
            <div class="flex items-center gap-4">
              <div class="text-right text-sm text-brand-dark-gray/60 dark:text-brand-white/60">
                <p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Questions:</span> <span
                    id="archived-question-count"></span></p>
                <p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Responses:</span> <span
                    id="archived-response-count"></span></p>
              </div>
              <button id="view-analytics-btn"
                class="h-12 px-6 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 text-brand-white text-sm font-semibold hover:from-blue-700 hover:to-purple-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                <span class="material-symbols-outlined text-lg">analytics</span>
                <span>View Analytics</span>
              </button>
            </div>
          </div>
          <div id="archived-questions-container" class="space-y-4">
            <!-- Question breakdowns will render here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Analytics Hub View -->
    <div id="analytics-view" class="p-6 flex flex-col gap-6 bg-gray-50 dark:bg-brand-dark-gray/10 min-h-full"
      style="display: none;">
      <!-- Filter Bar -->
      <div
        class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-4 shadow-sm">
        <div class="flex flex-wrap items-center gap-3 mb-3">
          <select id="analytics-class-filter"
            class="rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
            <option value="all">All Classes</option>
          </select>
          <div class="flex items-center gap-2">
            <label class="text-xs font-semibold text-brand-dark-gray/60 dark:text-brand-white/60">From:</label>
            <input type="date" id="analytics-date-from"
              class="rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
          </div>
          <div class="flex items-center gap-2">
            <label class="text-xs font-semibold text-brand-dark-gray/60 dark:text-brand-white/60">To:</label>
            <input type="date" id="analytics-date-to"
              class="rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
          </div>
          <button id="analytics-apply-filters-btn"
            class="px-4 py-2 rounded-lg bg-primary text-brand-white hover:bg-primary/90 transition-colors text-sm font-semibold">
            Apply Filters
          </button>
          <button id="analytics-clear-filters-btn"
            class="px-4 py-2 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/50 transition-colors text-sm">
            Clear
          </button>
          <button id="analytics-refresh-btn"
            class="flex items-center justify-center h-9 w-9 rounded-full bg-primary text-brand-white hover:bg-primary/90 transition-colors"
            title="Refresh">
            <span class="material-symbols-outlined text-base">refresh</span>
          </button>
          <button id="analytics-export-btn"
            class="ml-auto flex items-center gap-2 px-4 py-2 rounded-lg bg-veritas-gold text-brand-white hover:bg-veritas-gold/90 transition-colors text-sm font-semibold"
            title="Export Data">
            <span class="material-symbols-outlined text-base">download</span>
            <span>Export</span>
          </button>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <span class="text-xs font-semibold text-brand-dark-gray/60 dark:text-brand-white/60">Quick Filters:</span>
          <button
            class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold"
            data-days="7">
            Last 7 Days
          </button>
          <button
            class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold"
            data-days="30">
            Last 30 Days
          </button>
          <button
            class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold"
            data-days="90">
            Last 90 Days
          </button>
          <button
            class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold"
            data-preset="thisMonth">
            This Month
          </button>
          <button
            class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold"
            data-preset="lastMonth">
            Last Month
          </button>
          <button
            class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold"
            data-preset="all">
            All Time
          </button>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div
        class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 shadow-sm overflow-hidden">
        <div class="flex border-b border-brand-light-gray dark:border-brand-dark-gray/40">
          <button id="analytics-tab-overview"
            class="flex-1 px-6 py-3 font-semibold text-sm transition-colors analytics-tab bg-primary text-brand-white">
            Overview
          </button>
          <button id="analytics-tab-items"
            class="flex-1 px-6 py-3 font-semibold text-sm transition-colors analytics-tab text-brand-dark-gray/70 dark:text-brand-white/70 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30">
            Item Analysis
          </button>
          <button id="analytics-tab-students"
            class="flex-1 px-6 py-3 font-semibold text-sm transition-colors analytics-tab text-brand-dark-gray/70 dark:text-brand-white/70 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30">
            Student Trends
          </button>
        </div>

        <!-- Overview Tab Content -->
        <div id="analytics-content-overview" class="p-6 analytics-tab-content">
          <div id="analytics-overview-loading" class="text-center py-12">
            <div class="flex flex-row gap-2 justify-center mb-4">
              <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce"></div>
              <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.3s]"></div>
              <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.5s]"></div>
            </div>
            <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Loading analytics...</p>
          </div>
          <div id="analytics-overview-content" class="hidden">
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              <div id="analytics-kpi-container"></div>
            </div>

            <!-- Topic Heat Strip -->
            <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5 mb-6">
              <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Topic Mastery Over Time
              </h3>
              <div id="analytics-topic-heat" class="overflow-x-auto">
                <p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No topic data available</p>
              </div>
            </div>

            <!-- Item Quality Scatter -->
            <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5">
              <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Item Quality Map</h3>
              <div id="analytics-item-scatter" style="height: 300px;">
                <p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No item data available</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Item Analysis Tab Content -->
        <div id="analytics-content-items" class="p-6 analytics-tab-content hidden">
          <div id="analytics-items-loading" class="text-center py-12">
            <div class="flex flex-row gap-2 justify-center mb-4">
              <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce"></div>
              <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.3s]"></div>
              <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.5s]"></div>
            </div>
            <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Loading item analysis...</p>
          </div>
          <div id="analytics-items-content" class="hidden">
            <!-- Item Table -->
            <div class="overflow-x-auto">
              <table id="analytics-items-table" class="min-w-full text-sm">
                <thead
                  class="sticky top-0 bg-brand-light-gray dark:bg-brand-dark-gray text-xs uppercase tracking-wide text-brand-dark-gray/80 dark:text-brand-white/70">
                  <tr>
                    <th
                      class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80"
                      data-sort="qNum">Q#</th>
                    <th
                      class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80"
                      data-sort="topic">Topic</th>
                    <th
                      class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80"
                      data-sort="correctPct">Correct%</th>
                    <th
                      class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80"
                      data-sort="rbis">Disc</th>
                    <th class="py-3 px-4 text-left">Choices</th>
                    <th
                      class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80"
                      data-sort="medianTimeSec">Time(s)</th>
                    <th class="py-3 px-4 text-left">Flags</th>
                  </tr>
                </thead>
                <tbody id="analytics-items-tbody"
                  class="divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/40">
                  <!-- Items will be rendered here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Student Trends Tab Content -->
        <div id="analytics-content-students" class="p-6 analytics-tab-content hidden">
          <div id="analytics-students-loading" class="text-center py-12">
            <div class="flex flex-row gap-2 justify-center mb-4">
              <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce"></div>
              <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.3s]"></div>
              <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.5s]"></div>
            </div>
            <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Loading student data...</p>
          </div>
          <div id="analytics-students-content" class="hidden">
            <!-- STUDENT INSIGHTS PANEL (2025) -->
            <div id="student-insights-panel" class="mb-6">
              <h2 class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white mb-4">Student Insights</h2>

              <!-- Insight Cards Grid -->
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Struggling Students -->
                <div
                  class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700/50 rounded-lg p-4 cursor-pointer hover:shadow-md transition-shadow"
                  onclick="filterStudentsByFlag('struggling')">
                  <div class="flex items-center gap-3 mb-2">
                    <span class="material-symbols-outlined text-red-600 dark:text-red-400 text-2xl">trending_down</span>
                    <h3 class="font-bold text-red-800 dark:text-red-300 text-sm">Struggling</h3>
                  </div>
                  <p class="text-3xl font-black text-red-700 dark:text-red-400" id="struggling-count">0</p>
                  <p class="text-xs text-red-600/70 dark:text-red-400/70 mt-1">Accuracy &lt; 50%</p>
                </div>

                <!-- Non-Responders -->
                <div
                  class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-700/50 rounded-lg p-4 cursor-pointer hover:shadow-md transition-shadow"
                  onclick="filterStudentsByFlag('non-responder')">
                  <div class="flex items-center gap-3 mb-2">
                    <span
                      class="material-symbols-outlined text-orange-600 dark:text-orange-400 text-2xl">person_off</span>
                    <h3 class="font-bold text-orange-800 dark:text-orange-300 text-sm">Non-Responders</h3>
                  </div>
                  <p class="text-3xl font-black text-orange-700 dark:text-orange-400" id="non-responder-count">0</p>
                  <p class="text-xs text-orange-600/70 dark:text-orange-400/70 mt-1">Participation &lt; 50%</p>
                </div>

                <!-- Rule Violators -->
                <div
                  class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/50 rounded-lg p-4 cursor-pointer hover:shadow-md transition-shadow"
                  onclick="filterStudentsByFlag('rule-violator')">
                  <div class="flex items-center gap-3 mb-2">
                    <span class="material-symbols-outlined text-yellow-600 dark:text-yellow-400 text-2xl">warning</span>
                    <h3 class="font-bold text-yellow-800 dark:text-yellow-300 text-sm">Rule Violators</h3>
                  </div>
                  <p class="text-3xl font-black text-yellow-700 dark:text-yellow-400" id="rule-violator-count">0</p>
                  <p class="text-xs text-yellow-600/70 dark:text-yellow-400/70 mt-1">2+ violations</p>
                </div>

                <!-- High Performers -->
                <div
                  class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700/50 rounded-lg p-4 cursor-pointer hover:shadow-md transition-shadow"
                  onclick="filterStudentsByFlag('high-performer')">
                  <div class="flex items-center gap-3 mb-2">
                    <span
                      class="material-symbols-outlined text-green-600 dark:text-green-400 text-2xl">trending_up</span>
                    <h3 class="font-bold text-green-800 dark:text-green-300 text-sm">High Performers</h3>
                  </div>
                  <p class="text-3xl font-black text-green-700 dark:text-green-400" id="high-performer-count">0</p>
                  <p class="text-xs text-green-600/70 dark:text-green-400/70 mt-1">Accuracy â‰¥ 85%</p>
                </div>
              </div>

              <!-- Student List with Filtering -->
              <div
                class="bg-white dark:bg-brand-dark-gray/30 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg overflow-hidden">
                <div
                  class="bg-brand-light-gray/50 dark:bg-brand-dark-gray/50 px-4 py-3 flex items-center justify-between">
                  <h3 class="font-bold text-brand-dark-gray dark:text-brand-white">All Students</h3>
                  <div class="flex items-center gap-2">
                    <button id="clear-student-filter-btn"
                      class="hidden px-3 py-1 bg-brand-dark-gray/10 hover:bg-brand-dark-gray/20 dark:bg-brand-white/10 dark:hover:bg-brand-white/20 rounded text-xs font-semibold transition-colors"
                      onclick="clearStudentFilter()">
                      Clear Filter
                    </button>
                    <span id="student-insights-filter-badge"
                      class="hidden px-2 py-1 bg-primary/20 text-primary text-xs font-bold rounded"></span>
                  </div>
                </div>
                <div id="student-insights-table-container" class="overflow-x-auto max-h-96 overflow-y-auto">
                  <table class="w-full">
                    <thead class="bg-brand-light-gray/30 dark:bg-brand-dark-gray/30 sticky top-0">
                      <tr>
                        <th
                          class="px-4 py-2 text-left text-xs font-bold text-brand-dark-gray/70 dark:text-brand-white/70 cursor-pointer hover:bg-brand-light-gray/50 dark:hover:bg-brand-dark-gray/50"
                          onclick="sortStudentsBy('name')">
                          Student <span class="material-symbols-outlined text-xs">unfold_more</span>
                        </th>
                        <th
                          class="px-4 py-2 text-center text-xs font-bold text-brand-dark-gray/70 dark:text-brand-white/70 cursor-pointer hover:bg-brand-light-gray/50 dark:hover:bg-brand-dark-gray/50"
                          onclick="sortStudentsBy('accuracy')">
                          Accuracy <span class="material-symbols-outlined text-xs">unfold_more</span>
                        </th>
                        <th
                          class="px-4 py-2 text-center text-xs font-bold text-brand-dark-gray/70 dark:text-brand-white/70 cursor-pointer hover:bg-brand-light-gray/50 dark:hover:bg-brand-dark-gray/50"
                          onclick="sortStudentsBy('participation')">
                          Participation <span class="material-symbols-outlined text-xs">unfold_more</span>
                        </th>
                        <th
                          class="px-4 py-2 text-center text-xs font-bold text-brand-dark-gray/70 dark:text-brand-white/70 cursor-pointer hover:bg-brand-light-gray/50 dark:hover:bg-brand-dark-gray/50"
                          onclick="sortStudentsBy('violations')">
                          Violations <span class="material-symbols-outlined text-xs">unfold_more</span>
                        </th>
                        <th
                          class="px-4 py-2 text-left text-xs font-bold text-brand-dark-gray/70 dark:text-brand-white/70">
                          Flags
                        </th>
                      </tr>
                    </thead>
                    <tbody id="student-insights-table-body">
                      <!-- Populated by JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Student Search -->
            <div id="analytics-student-search-container" class="relative mb-6">
              <input type="text" id="analytics-student-search" placeholder="Search for a student..."
                class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 pl-4 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 shadow-sm"
                autocomplete="off" />
              <button type="button"
                class="absolute inset-y-0 right-0 flex items-center px-2 text-gray-400 hover:text-gray-600 focus:outline-none"
                data-combobox-toggle>
                <span class="material-symbols-outlined text-lg">unfold_more</span>
              </button>
            </div>

            <!-- Student Detail -->
            <div id="analytics-student-detail" class="hidden">
              <div id="analytics-student-summary"
                class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5 mb-6">
                <!-- Student summary card -->
              </div>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5">
                  <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Consistency Trend</h3>
                  <div id="analytics-student-sparkline"></div>
                </div>
                <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5">
                  <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Topic Mastery</h3>
                  <div id="analytics-student-topics"></div>
                </div>
              </div>
            </div>

            <div id="analytics-student-empty"
              class="text-center py-12 text-brand-dark-gray/60 dark:text-brand-white/60">
              <p>Search for a student to view their analytics</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Poll Creation Wizard View - Compact Design -->
    </main>
  </div> <!-- End dashboard-root -->

  <!-- Poll Creation Wizard View - Compact Design -->
  <div id="create-poll-view" class="hidden min-h-screen w-full flex flex-col bg-white dark:bg-brand-dark-gray">

    <!-- Compact Header with Inline Progress -->
    <div
      class="wizard-header bg-gradient-to-r from-primary to-primary/90 px-4 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3 shrink-0">
        <h2 id="wizard-title" class="text-lg font-bold text-white">Create Poll</h2>
      </div>

      <!-- Inline Progress Steps (hidden - now in main header) -->
      <div class="wizard-progress hidden"></div>

      <button type="button" onclick="closePollWizard()"
        class="shrink-0 h-8 w-8 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors"
        title="Close">
        <span class="material-symbols-outlined text-xl">close</span>
      </button>
    </div>

    <!-- Wizard Body - More Compact -->
    <div class="wizard-body flex-1 overflow-y-auto px-4 py-4 bg-slate-50 dark:bg-black/10">

      <!-- STEP 1: MODE SELECTION -->
      <div id="wizard-step-1" class="wizard-step active max-w-4xl mx-auto">
        <div class="text-center mb-10">
          <h3 class="text-3xl font-bold text-brand-dark-gray dark:text-white mb-3">Choose Your Poll Mode</h3>
          <p class="text-lg text-brand-dark-gray/60 dark:text-brand-white/60">Select the type of assessment
            experience for your students</p>
        </div>

        <div class="mode-cards grid grid-cols-1 md:grid-cols-2 gap-8">
          <button type="button"
            class="mode-card group relative overflow-hidden text-left p-8 rounded-2xl border-2 border-brand-light-gray hover:border-blue-500 hover:shadow-xl hover:-translate-y-1 transition-all duration-200"
            data-mode="live" onclick="selectPollMode('live')">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
              <span class="material-symbols-outlined text-9xl text-blue-500">groups</span>
            </div>
            <div class="relative z-10">
              <div
                class="h-14 w-14 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center mb-6 shadow-sm group-hover:scale-110 transition-transform">
                <span class="material-symbols-outlined text-3xl">groups</span>
              </div>
              <h4 class="text-xl font-bold text-brand-dark-gray dark:text-white mb-2">Live Poll</h4>
              <p class="text-brand-dark-gray/70 dark:text-brand-white/70 mb-6 leading-relaxed">Synchronous,
                teacher-paced questions for real-time class engagement and instant feedback.</p>
              <div class="flex flex-wrap gap-2">
                <span
                  class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-bold uppercase tracking-wider">Real-time</span>
                <span
                  class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-bold uppercase tracking-wider">Interactive</span>
              </div>
            </div>
          </button>

          <button type="button"
            class="mode-card group relative overflow-hidden text-left p-8 rounded-2xl border-2 border-brand-light-gray hover:border-amber-500 hover:shadow-xl hover:-translate-y-1 transition-all duration-200"
            data-mode="secure" onclick="selectPollMode('secure')">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
              <span class="material-symbols-outlined text-9xl text-amber-500">lock</span>
            </div>
            <div class="relative z-10">
              <div
                class="h-14 w-14 rounded-xl bg-amber-50 text-amber-600 flex items-center justify-center mb-6 shadow-sm group-hover:scale-110 transition-transform">
                <span class="material-symbols-outlined text-3xl">lock</span>
              </div>
              <h4 class="text-xl font-bold text-brand-dark-gray dark:text-white mb-2">Secure Assessment</h4>
              <p class="text-brand-dark-gray/70 dark:text-brand-white/70 mb-6 leading-relaxed">Asynchronous, timed
                exam with secure proctoring features and mission control monitoring.</p>
              <div class="flex flex-wrap gap-2">
                <span
                  class="px-3 py-1 rounded-full bg-amber-50 text-amber-700 text-xs font-bold uppercase tracking-wider">Timed</span>
                <span
                  class="px-3 py-1 rounded-full bg-amber-50 text-amber-700 text-xs font-bold uppercase tracking-wider">Proctored</span>
              </div>
            </div>
          </button>
        </div>
      </div>

      <!-- STEP 2: CONFIGURATION -->
      <div id="wizard-step-2" class="wizard-step hidden max-w-3xl mx-auto">
        <h3 class="text-2xl font-bold text-brand-dark-gray dark:text-white mb-6">Configure Your <span
            id="config-mode-label" class="text-blue-600">Poll</span></h3>

        <div
          class="bg-slate-50 dark:bg-white/5 rounded-xl p-6 border border-brand-light-gray dark:border-brand-dark-gray/40 space-y-6">
          <!-- Poll Name -->
          <div class="form-group">
            <label for="wizard-poll-name" class="block text-sm font-bold text-brand-dark-gray dark:text-white mb-2">Poll
              Name <span class="text-red-500">*</span></label>
            <input type="text" id="wizard-poll-name"
              class="w-full rounded-lg border border-brand-light-gray bg-white px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-shadow"
              placeholder="e.g., Chapter 5 Review" maxlength="100">
          </div>

          <!-- Class Selection -->
          <div class="form-group">
            <label for="wizard-class-select"
              class="block text-sm font-bold text-brand-dark-gray dark:text-white mb-2">Class <span
                class="text-red-500">*</span></label>
            <div class="relative">
              <select id="wizard-class-select"
                class="w-full rounded-lg border border-brand-light-gray bg-white px-4 py-3 text-base appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-shadow">
                <option value="">-- Select a class --</option>
              </select>
              <div
                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-brand-dark-gray/50">
                <span class="material-symbols-outlined">expand_more</span>
              </div>
            </div>
            <p class="text-xs text-brand-dark-gray/50 mt-2 flex items-center gap-1">
              <span class="material-symbols-outlined text-sm">info</span>
              Classes populate from your dashboard rosters.
            </p>
          </div>

          <!-- Secure Config -->
          <div id="secure-config-section"
            class="config-section hidden pt-6 mt-6 border-t border-brand-light-gray dark:border-brand-dark-gray/20">
            <h4 class="text-sm font-bold uppercase tracking-wider text-amber-600 mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-lg">shield_lock</span> Secure Settings
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="form-group">
                <label for="wizard-time-limit"
                  class="block text-sm font-bold text-brand-dark-gray dark:text-white mb-2">Time Limit (minutes)
                  <span class="text-red-500">*</span></label>
                <input type="number" id="wizard-time-limit"
                  class="w-full rounded-lg border border-brand-light-gray bg-white px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-amber-500/50 transition-shadow"
                  min="1" placeholder="45">
              </div>
              <!-- Add Access Code Field (missing in original) -->
              <div class="form-group">
                <label for="wizard-access-code"
                  class="block text-sm font-bold text-brand-dark-gray dark:text-white mb-2">Access Code
                  (Optional)</label>
                <input type="text" id="wizard-access-code"
                  class="w-full rounded-lg border border-brand-light-gray bg-white px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-amber-500/50 transition-shadow"
                  placeholder="e.g. EXAM2025">
              </div>
              <div class="form-group md:col-span-2">
                <div
                  class="flex items-start justify-between gap-4 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900 shadow-sm">
                  <div>
                    <div class="flex items-center gap-2 font-semibold">
                      <span class="material-symbols-outlined text-base">calculate</span>
                      TI-84 Calculator
                    </div>
                    <p class="mt-1 text-amber-800/80">Allow students to use a secure, embedded calculator during
                      this assessment.</p>
                  </div>
                  <label class="inline-flex items-center cursor-pointer select-none">
                    <input id="wizard-calculator-toggle" type="checkbox" class="peer sr-only">
                    <span
                      class="h-6 w-11 rounded-full bg-amber-200 peer-checked:bg-amber-500 transition-colors relative">
                      <span
                        class="absolute top-0.5 left-0.5 h-5 w-5 rounded-full bg-white shadow transition-all peer-checked:translate-x-5"></span>
                    </span>
                    <span class="ml-3 text-sm font-semibold text-amber-900 peer-checked:text-amber-800">Enable</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 3: QUESTIONS - Full Editor -->
      <div id="wizard-step-3" class="wizard-step hidden">
        <div class="max-w-6xl mx-auto flex gap-6">
          <!-- Timeline Navigation Sidebar -->
          <div id="wizard-timeline-sidebar" class="hidden lg:block shrink-0 w-16">
            <div class="sticky top-4">
              <div class="bg-white border border-brand-light-gray rounded-xl shadow-sm p-2 space-y-1">
                <p class="text-[10px] font-bold text-slate-400 uppercase text-center mb-2 tracking-wider">Jump to</p>
                <div id="wizard-timeline-items" class="space-y-1">
                  <!-- Timeline items populated by JS -->
                </div>
                <button type="button"
                  class="w-full h-8 rounded-lg border-2 border-dashed border-brand-light-gray/70 flex items-center justify-center text-slate-400 hover:border-primary hover:text-primary hover:bg-primary/5 transition-all"
                  onclick="addWizardQuestion()" title="Add Question">
                  <span class="material-symbols-outlined text-sm">add</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Main Content -->
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h3 class="text-2xl font-bold text-brand-dark-gray dark:text-white">Build Your Questions</h3>
                <p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm mt-1">Add questions with multiple
                  choice answers</p>
              </div>
              <span
                class="px-3 py-1.5 bg-green-50 text-green-700 text-xs font-bold rounded-full uppercase border border-green-200">
                Full Editor
              </span>
            </div>

            <!-- Questions Container - Populated by JS -->
            <div id="wizard-questions-list" class="questions-list space-y-6"></div>

            <button type="button"
              class="btn-add-question w-full mt-6 py-5 flex flex-col items-center justify-center gap-2 border-2 border-dashed border-brand-light-gray rounded-xl hover:border-primary hover:bg-primary/5 transition-all group bg-white"
              onclick="addWizardQuestion()">
              <div
                class="h-12 w-12 rounded-full bg-primary/10 text-primary flex items-center justify-center group-hover:scale-110 group-hover:bg-primary/20 transition-all">
                <span class="material-symbols-outlined text-2xl">add</span>
              </div>
              <span class="font-bold text-brand-dark-gray group-hover:text-primary transition-colors">Add New
                Question</span>
              <span class="text-xs text-brand-dark-gray/50">Click to add a multiple choice question</span>
            </button>
          </div>
        </div>
      </div>

      <!-- STEP 4: REVIEW -->
      <div id="wizard-step-4" class="wizard-step hidden max-w-3xl mx-auto">
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Review & Publish</h3>

        <div class="review-section space-y-6">
          <div class="review-card bg-white border border-brand-light-gray rounded-xl p-6 shadow-sm">
            <h4 class="review-heading text-lg font-bold text-gray-900 mb-4 border-b border-brand-light-gray pb-2">
              Basic Information</h4>
            <dl class="review-details grid grid-cols-[140px_1fr] gap-4 text-sm">
              <dt class="font-semibold text-brand-dark-gray/60">Mode:</dt>
              <dd id="review-mode" class="font-medium text-brand-dark-gray">-</dd>
              <dt class="font-semibold text-brand-dark-gray/60">Name:</dt>
              <dd id="review-name" class="font-medium text-brand-dark-gray">-</dd>
              <dt class="font-semibold text-brand-dark-gray/60">Class:</dt>
              <dd id="review-class" class="font-medium text-brand-dark-gray">-</dd>
            </dl>
          </div>

          <div class="review-card bg-white border border-brand-light-gray rounded-xl p-6 shadow-sm">
            <h4 class="review-heading text-lg font-bold text-gray-900 mb-4 border-b border-brand-light-gray pb-2">
              Questions</h4>
            <div id="review-questions-summary" class="text-sm text-brand-dark-gray/80">
              <!-- Populated via JS -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      class="wizard-footer bg-white dark:bg-brand-dark-gray border-t border-brand-light-gray dark:border-brand-dark-gray/40 px-8 py-4 flex items-center justify-between">
      <button type="button"
        class="btn-secondary h-12 px-6 rounded-lg font-bold text-red-600 hover:bg-red-50 transition-colors"
        onclick="closePollWizard()">Cancel</button>
      <div class="flex items-center gap-3">
        <button type="button"
          class="btn-secondary h-12 px-6 rounded-lg font-bold text-brand-dark-gray hover:bg-brand-light-gray/50 transition-colors disabled:opacity-50"
          id="wizard-back-btn" onclick="wizardGoBack()" disabled>Back</button>
        <button type="button"
          class="btn-primary h-12 px-8 rounded-lg bg-primary text-white font-bold shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all"
          id="wizard-next-btn" onclick="wizardGoNext()">Next</button>
        <button type="button"
          class="btn-primary hidden h-12 px-8 rounded-lg bg-green-600 text-white font-bold shadow-md hover:shadow-lg hover:-translate-y-0.5 hover:bg-green-700 transition-all flex items-center gap-2"
          id="wizard-publish-btn" onclick="publishWizardPoll()">
          <span class="material-symbols-outlined">rocket_launch</span>
          Publish Poll
        </button>
      </div>
    </div>
  </div>

  <!-- Student Manager Modal -->
  <div id="student-manager-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" data-close-manager="true"></div>
    <div
      class="relative w-full max-w-md mx-auto my-12 bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col max-h-[90vh]">
      <!-- Header -->
      <div
        class="flex items-center justify-between p-6 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-gray-800/50">
        <div class="flex items-center gap-4">
          <div
            class="h-12 w-12 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-xl font-bold text-indigo-600 dark:text-indigo-400">
            <span id="student-manager-initials">--</span>
          </div>
          <div>
            <h2 id="student-manager-name" class="text-xl font-bold text-gray-900 dark:text-white leading-tight">Student
              Name</h2>
            <div class="flex items-center gap-2 mt-1 text-sm">
              <span id="student-manager-email" class="text-gray-500 font-medium">student@example.com</span>
              <span id="student-manager-status-badge"
                class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 text-xs font-bold uppercase tracking-wide">Offline</span>
            </div>
          </div>
        </div>
        <button
          class="h-10 w-10 flex items-center justify-center rounded-full bg-white dark:bg-gray-800 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors shadow-sm border border-gray-200 dark:border-gray-700"
          data-close-manager="true">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <!-- Content -->
      <div class="flex-1 overflow-y-auto p-6 flex flex-col gap-6">
        <!-- Current Status -->
        <div class="rounded-2xl border border-slate-200 dark:border-brand-dark-gray/60 p-4">
          <p class="text-sm font-semibold text-slate-600 dark:text-slate-300 mb-3">Current Status</p>
          <div class="flex items-center gap-3">
            <span id="student-manager-current-status"
              class="px-3 py-1 rounded-full bg-gray-100 text-gray-600 text-sm font-bold uppercase tracking-wide">Thinking...</span>
            <span id="student-manager-current-time" class="text-sm text-slate-500">0:00</span>
          </div>
        </div>

        <!-- Time Controls (Restored) -->
        <div class="rounded-2xl border border-slate-200 dark:border-brand-dark-gray/60 p-4">
          <p class="text-sm font-semibold text-slate-600 dark:text-slate-300 mb-3">Time Controls</p>
          <div class="flex flex-wrap items-center gap-2">
            <button id="student-manager-add-5"
              class="inline-flex items-center gap-2 rounded-full bg-emerald-600 text-white px-4 py-2 text-sm font-semibold shadow hover:bg-emerald-700 transition-colors">
              <span class="material-symbols-outlined text-base">add</span>
              +5 min
            </button>
            <button id="student-manager-add-10"
              class="inline-flex items-center gap-2 rounded-full bg-emerald-600 text-white px-4 py-2 text-sm font-semibold shadow hover:bg-emerald-700 transition-colors">
              <span class="material-symbols-outlined text-base">add</span>
              +10 min
            </button>
            <button id="student-manager-pause"
              class="inline-flex items-center gap-2 rounded-full bg-amber-500 text-white px-4 py-2 text-sm font-semibold shadow hover:bg-amber-600 transition-colors">
              <span class="material-symbols-outlined text-base">pause_circle</span>
              Pause Timer
            </button>
          </div>
        </div>

        <div>
          <p class="text-xs font-semibold uppercase text-slate-500 mb-2">Actions</p>
          <div class="flex flex-wrap items-center gap-3">
            <button id="student-manager-unlock"
              class="inline-flex items-center gap-2 rounded-full bg-blue-600 text-white px-5 py-2 text-sm font-semibold shadow hover:bg-blue-700 transition-colors">
              <span class="material-symbols-outlined text-base">lock_open</span>
              Approve Unlock
            </button>
            <button id="student-manager-force-submit"
              class="inline-flex items-center gap-2 rounded-full bg-red-600 text-white px-5 py-2 text-sm font-semibold shadow hover:bg-red-700 transition-colors">
              <span class="material-symbols-outlined text-base">task</span>
              Force Submit
            </button>
            <p id="student-manager-message" class="text-sm text-slate-500"></p>
          </div>
        </div>
        <div id="student-manager-loading" class="hidden text-sm text-slate-500">Working...</div>
      </div>
    </div>
  </div>

  <!-- Student Detail Inspector Modal (New for Phase 4) -->
  <div id="student-inspector-modal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" data-close-inspector="true"></div>
    <div
      class="relative w-full max-w-4xl mx-auto my-12 bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col max-h-[90vh]">

      <!-- 1. Header -->
      <div
        class="flex items-start justify-between p-6 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-gray-800/50">
        <div class="flex items-center gap-4">
          <div
            class="h-16 w-16 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-2xl font-bold text-indigo-600 dark:text-indigo-400">
            <span id="inspector-initials">--</span>
          </div>
          <div>
            <h2 id="inspector-name" class="text-2xl font-bold text-gray-900 dark:text-white leading-tight">Student Name
            </h2>
            <div class="flex items-center gap-3 mt-1 text-sm">
              <span id="inspector-email" class="text-gray-500 font-medium">student@example.com</span>
              <span id="inspector-status-badge"
                class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 text-xs font-bold uppercase tracking-wide">Offline</span>
            </div>
          </div>
        </div>
        <button
          class="h-10 w-10 flex items-center justify-center rounded-full bg-white dark:bg-gray-800 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors shadow-sm border border-gray-200 dark:border-gray-700"
          data-close-inspector="true">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <!-- 2. Integrated Analytics Grid -->
      <div class="grid grid-cols-3 gap-6 p-6 pb-2">
        <!-- Accuracy Card -->
        <div
          class="p-4 rounded-xl bg-indigo-50 dark:bg-indigo-900/10 border border-indigo-100 dark:border-indigo-800 relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
            <span class="material-symbols-outlined text-6xl text-indigo-600">check_circle</span>
          </div>
          <p class="text-xs font-bold uppercase tracking-wider text-indigo-600 dark:text-indigo-400 mb-1">Accuracy</p>
          <div class="flex items-baseline gap-2">
            <span id="inspector-accuracy" class="text-3xl font-black text-indigo-800 dark:text-indigo-300">--%</span>
            <span id="inspector-correct-count" class="text-sm font-semibold text-indigo-600/70">0/0 correct</span>
          </div>
        </div>

        <!-- Violations Card -->
        <div
          class="p-4 rounded-xl bg-amber-50 dark:bg-amber-900/10 border border-amber-100 dark:border-amber-800 relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
            <span class="material-symbols-outlined text-6xl text-amber-600">warning</span>
          </div>
          <p class="text-xs font-bold uppercase tracking-wider text-amber-600 dark:text-amber-400 mb-1">Violations</p>
          <div class="flex items-baseline gap-2">
            <span id="inspector-violations" class="text-3xl font-black text-amber-800 dark:text-amber-300">0</span>
            <span class="text-sm font-semibold text-amber-600/70">tab switches</span>
          </div>
        </div>

        <!-- Speed Card -->
        <div
          class="p-4 rounded-xl bg-emerald-50 dark:bg-emerald-900/10 border border-emerald-100 dark:border-emerald-800 relative overflow-hidden group">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
            <span class="material-symbols-outlined text-6xl text-emerald-600">timer</span>
          </div>
          <p class="text-xs font-bold uppercase tracking-wider text-emerald-600 dark:text-emerald-400 mb-1">Avg. Speed
          </p>
          <div class="flex items-baseline gap-2">
            <span id="inspector-speed" class="text-3xl font-black text-emerald-800 dark:text-emerald-300">--s</span>
            <span class="text-sm font-semibold text-emerald-600/70">per question</span>
          </div>
        </div>
      </div>

      <!-- 3. Session History Label -->
      <div class="px-6 py-2">
        <h3 class="text-sm font-bold uppercase tracking-wider text-gray-500">Session History</h3>
      </div>

      <!-- 4. Scrollable History Table -->
      <div class="flex-1 overflow-y-auto px-6 pb-6">
        <table class="w-full text-left text-sm">
          <thead class="sticky top-0 bg-white dark:bg-gray-900 z-10 box-decoration-clone">
            <tr class="text-xs text-gray-400 uppercase tracking-wide border-b border-gray-100 dark:border-gray-800">
              <th class="py-3 font-semibold">Q#</th>
              <th class="py-3 font-semibold">Question</th>
              <th class="py-3 font-semibold">Response</th>
              <th class="py-3 font-semibold text-center">Result</th>
              <th class="py-3 font-semibold text-right">Time</th>
            </tr>
          </thead>
          <tbody id="inspector-history-body" class="divide-y divide-gray-50 dark:divide-gray-800">
            <!-- Populated by JS -->
          </tbody>
        </table>

        <!-- Empty State -->
        <div id="inspector-empty-state" class="hidden py-12 text-center text-gray-400">
          <p>No activity recorded yet.</p>
        </div>
      </div>

      <!-- 5. Footer Actions -->
      <div
        class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-800 flex justify-end gap-3">
        <button class="px-4 py-2 rounded-lg font-bold text-gray-600 hover:bg-gray-200 transition-colors text-sm"
          data-close-inspector="true">Close</button>
      </div>
    </div>
  </div>

  <!-- Book View Modal -->
  <div id="book-view-modal" class="fixed inset-0 z-50 hidden overflow-y-auto custom-scrollbar">
    <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeBookView()"></div>
    <div
      class="relative w-full max-w-[95vw] mx-auto my-8 bg-white dark:bg-brand-dark-gray rounded-2xl shadow-2xl border border-brand-light-gray dark:border-brand-dark-gray/40">
      <!-- Header -->
      <div
        class="sticky top-0 z-10 flex items-start justify-between gap-4 p-6 border-b border-slate-200 dark:border-brand-dark-gray/60 bg-white dark:bg-brand-dark-gray">
        <div>
          <div class="flex items-center gap-3 mb-2">
            <span class="material-symbols-outlined text-3xl text-veritas-gold">menu_book</span>
            <h2 id="book-view-title" class="text-3xl font-bold text-brand-dark-gray dark:text-white">Assessment Book
              View
            </h2>
          </div>
          <p id="book-view-subtitle" class="text-sm text-slate-500">Comprehensive student performance analysis</p>
        </div>
        <button onclick="closeBookView()"
          class="h-10 w-10 inline-flex items-center justify-center rounded-full bg-slate-100 dark:bg-brand-dark-gray/70 text-slate-600 dark:text-white hover:bg-slate-200 transition-colors">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div id="book-view-loading" class="p-12 text-center">
        <div class="flex flex-row gap-2 justify-center mb-4">
          <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce"></div>
          <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.3s]"></div>
          <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.5s]"></div>
        </div>
        <p class="mt-4 text-slate-600 dark:text-slate-400">Loading book view data...</p>
      </div>

      <div id="book-view-content" class="hidden p-6 space-y-6">
        <!-- Class Overview Section -->
        <div class="bg-gradient-to-r from-veritas-navy to-veritas-navy/80 rounded-xl p-6 text-white shadow-lg">
          <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined">analytics</span>
            Class Overview
          </h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
              <p class="text-sm opacity-80">Total Students</p>
              <p id="book-class-total-students" class="text-3xl font-bold">0</p>
            </div>
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
              <p class="text-sm opacity-80">Class Average</p>
              <p id="book-class-average" class="text-3xl font-bold">0%</p>
            </div>
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
              <p class="text-sm opacity-80">Median Score</p>
              <p id="book-class-median" class="text-3xl font-bold">0</p>
            </div>
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
              <p class="text-sm opacity-80">Std. Deviation</p>
              <p id="book-class-stddev" class="text-3xl font-bold">0.0</p>
            </div>
          </div>
          <div id="book-class-interpretation" class="mt-4 p-3 bg-white/10 backdrop-blur-sm rounded-lg text-sm">
            <!-- Interpretation messages will be inserted here -->
          </div>
        </div>

        <!-- View Toggle -->
        <div class="flex gap-3 border-b border-slate-200 dark:border-brand-dark-gray/40">
          <button id="book-tab-students"
            class="px-6 py-3 font-semibold text-sm transition-colors border-b-2 border-veritas-gold text-veritas-gold">
            Student Roster
          </button>
          <button id="book-tab-questions"
            class="px-6 py-3 font-semibold text-sm transition-colors border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-veritas-gold hover:border-veritas-gold/30">
            Question Analysis
          </button>
          <button id="book-tab-matrix"
            class="px-6 py-3 font-semibold text-sm transition-colors border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-veritas-gold hover:border-veritas-gold/30">
            Response Matrix
          </button>
        </div>

        <!-- Student Roster Tab -->
        <div id="book-content-students" class="book-tab-content">
          <div
            class="bg-white dark:bg-brand-dark-gray/30 rounded-xl border border-slate-200 dark:border-brand-dark-gray/40 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-100 dark:bg-brand-dark-gray/50">
                  <tr>
                    <th
                      class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-700 dark:text-slate-300">
                      Rank</th>
                    <th
                      class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-700 dark:text-slate-300">
                      Student Name</th>
                    <th
                      class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wide text-slate-700 dark:text-slate-300">
                      Score</th>
                    <th
                      class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wide text-slate-700 dark:text-slate-300">
                      Percentage</th>
                    <th
                      class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wide text-slate-700 dark:text-slate-300">
                      Percentile</th>
                    <th
                      class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wide text-slate-700 dark:text-slate-300">
                      Actions</th>
                  </tr>
                </thead>
                <tbody id="book-students-table-body" class="divide-y divide-slate-200 dark:divide-brand-dark-gray/40">
                  <!-- Student rows will be inserted here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Question Analysis Tab -->
        <div id="book-content-questions" class="book-tab-content hidden">
          <div class="space-y-4" id="book-questions-container">
            <!-- Question analysis cards will be inserted here -->
          </div>
        </div>

        <!-- Response Matrix Tab -->
        <div id="book-content-matrix" class="book-tab-content hidden">
          <div
            class="bg-white dark:bg-brand-dark-gray/30 rounded-xl border border-slate-200 dark:border-brand-dark-gray/40 overflow-hidden">
            <div class="p-4 bg-slate-100 dark:bg-brand-dark-gray/50">
              <h3 class="text-lg font-bold text-brand-dark-gray dark:text-white">Complete Response Matrix</h3>
              <p class="text-sm text-slate-600 dark:text-slate-400">Each cell shows student's answer with
                correct/incorrect indicator</p>
            </div>
            <div class="overflow-x-auto p-4">
              <table class="w-full text-xs">
                <thead>
                  <tr id="book-matrix-header-row">
                    <th
                      class="sticky left-0 bg-slate-100 dark:bg-brand-dark-gray/50 px-3 py-2 text-left font-semibold border-r border-slate-300 dark:border-brand-dark-gray/60">
                      Student</th>
                    <!-- Question headers will be injected here -->
                    <th class="bg-slate-100 dark:bg-brand-dark-gray/50 px-3 py-2 text-center font-semibold">Total</th>
                  </tr>
                </thead>
                <tbody id="book-matrix-table-body">
                  <!-- Matrix rows will be inserted here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Individual Student Detail View (expandable) -->
        <div id="book-student-detail" class="hidden fixed inset-0 z-50 overflow-y-auto">
          <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeStudentDetail()"></div>
          <div
            class="relative w-full max-w-5xl mx-auto my-8 bg-white dark:bg-brand-dark-gray rounded-2xl shadow-2xl border border-brand-light-gray dark:border-brand-dark-gray/40">
            <div
              class="sticky top-0 z-10 flex items-start justify-between gap-4 p-6 border-b border-slate-200 dark:border-brand-dark-gray/60 bg-white dark:bg-brand-dark-gray">
              <div>
                <h3 id="student-detail-name" class="text-2xl font-bold text-brand-dark-gray dark:text-white">Student
                  Name
                </h3>
                <div class="flex items-center gap-4 mt-2 text-sm text-slate-600 dark:text-slate-400">
                  <span>Score: <strong id="student-detail-score">0/0</strong></span>
                  <span>Percentage: <strong id="student-detail-percentage">0%</strong></span>
                  <span>Rank: <strong id="student-detail-rank">0</strong></span>
                  <span>Percentile: <strong id="student-detail-percentile">0th</strong></span>
                </div>
              </div>
              <button onclick="closeStudentDetail()"
                class="h-10 w-10 inline-flex items-center justify-center rounded-full bg-slate-100 dark:bg-brand-dark-gray/70 text-slate-600 dark:text-white hover:bg-red-500 hover:text-white transition-colors focus:outline-none focus:ring-2 focus:ring-red-500"
                title="Close" aria-label="Close student detail view">
                <span class="material-symbols-outlined">close</span>
              </button>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
              <div id="student-detail-responses" class="space-y-4">
                <!-- Question-by-question responses will be inserted here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="book-view-error" class="hidden p-12 text-center">
        <span class="material-symbols-outlined text-6xl text-red-500">error</span>
        <p class="mt-4 text-lg font-semibold text-slate-800 dark:text-slate-200">Error Loading Data</p>
        <p id="book-view-error-message" class="text-slate-600 dark:text-slate-400"></p>
      </div>
    </div>
  </div>





  <!-- NEW FEATURE: Question Bank Import Modal -->
  <div id="question-bank-modal"
    class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div
      class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="sticky top-0 bg-amber-600 px-6 py-4 border-b border-amber-700 z-10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="material-symbols-outlined text-white text-2xl">inventory_2</span>
          <div>
            <h2 class="text-white text-xl font-bold">Question Bank</h2>
            <p class="text-white/80 text-sm">Import questions from previous polls</p>
          </div>
        </div>
        <button id="close-question-bank-btn"
          class="h-10 px-4 rounded-lg bg-white/20 text-white text-sm font-bold hover:bg-white/30 transition-colors">
          Close
        </button>
      </div>
      <div class="p-6 flex-1 overflow-y-auto">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Filter by
            Poll</label>
          <select id="bank-poll-filter"
            class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-white dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500/50">
            <option value="">All Polls</option>
          </select>
        </div>
        <div id="bank-questions-container" class="space-y-3 max-h-[50vh] overflow-y-auto">
          <p class="text-center text-brand-dark-gray/60 dark:text-brand-white/60 py-8">Loading questions...</p>
        </div>
      </div>
      <div
        class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-brand-light-gray dark:border-brand-dark-gray/40 flex justify-between items-center">
        <span id="bank-selected-count" class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70">0 questions
          selected</span>
        <button id="import-selected-btn"
          class="h-10 px-6 rounded-lg bg-amber-600 text-white text-sm font-bold hover:bg-amber-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          disabled>
          Import Selected
        </button>
      </div>
    </div>
  </div>

  <!-- AP BIOLOGY 2025 TOPIC TAGGER -->
  <div id="ai-suggestions-modal"
    class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div
      class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
      <div
        class="sticky top-0 bg-gradient-to-r from-green-700 to-emerald-600 px-6 py-4 border-b border-green-800 z-10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="material-symbols-outlined text-white text-2xl">science</span>
          <div>
            <h2 class="text-white text-xl font-bold">AP Biology 2025 Topic Tagger</h2>
            <p class="text-white/80 text-sm">Align questions with the official AP Bio curriculum</p>
          </div>
        </div>
        <button id="close-ai-modal-btn"
          class="h-10 px-4 rounded-lg bg-white/20 text-white text-sm font-bold hover:bg-white/30 transition-colors">
          Close
        </button>
      </div>
      <div class="p-6 flex-1 overflow-y-auto">
        <div
          class="mb-4 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-700/30">
          <p class="text-sm font-medium text-green-900 dark:text-green-200 mb-2">Current Question:</p>
          <p id="ai-current-question" class="text-sm text-green-800 dark:text-green-300 italic">"No question text
            entered"</p>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-semibold mb-2 text-brand-dark-gray dark:text-brand-white">Select AP Bio
            Unit</label>
          <select id="apbio-unit-select"
            class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-white dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500/50">
            <option value="">-- Select Unit --</option>
            <option value="Unit 1">Unit 1: Chemistry of Life (8-11%)</option>
            <option value="Unit 2">Unit 2: Cell Structure and Function (10-13%)</option>
            <option value="Unit 3">Unit 3: Cellular Energetics (12-16%)</option>
            <option value="Unit 4">Unit 4: Cell Communication and Cell Cycle (10-15%)</option>
            <option value="Unit 5">Unit 5: Heredity (8-11%)</option>
            <option value="Unit 6">Unit 6: Gene Expression and Regulation (12-16%)</option>
            <option value="Unit 7">Unit 7: Natural Selection (13-20%)</option>
            <option value="Unit 8">Unit 8: Ecology (10-15%)</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-semibold mb-2 text-brand-dark-gray dark:text-brand-white">Select
            Topic</label>
          <select id="apbio-topic-select"
            class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-white dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500/50"
            disabled>
            <option value="">-- Select Unit First --</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-semibold mb-2 text-brand-dark-gray dark:text-brand-white">Big Idea
            Connection</label>
          <div class="grid grid-cols-2 gap-2">
            <label
              class="flex items-center gap-2 p-3 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors">
              <input type="checkbox" id="bigidea-evo"
                class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
              <span class="text-sm text-brand-dark-gray dark:text-brand-white"><strong>EVO</strong> - Evolution</span>
            </label>
            <label
              class="flex items-center gap-2 p-3 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors">
              <input type="checkbox" id="bigidea-ene"
                class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
              <span class="text-sm text-brand-dark-gray dark:text-brand-white"><strong>ENE</strong> - Energetics</span>
            </label>
            <label
              class="flex items-center gap-2 p-3 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors">
              <input type="checkbox" id="bigidea-ist"
                class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
              <span class="text-sm text-brand-dark-gray dark:text-brand-white"><strong>IST</strong> - Information
                Storage</span>
            </label>
            <label
              class="flex items-center gap-2 p-3 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors">
              <input type="checkbox" id="bigidea-syi"
                class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
              <span class="text-sm text-brand-dark-gray dark:text-brand-white"><strong>SYI</strong> - Systems
                Interactions</span>
            </label>
          </div>
        </div>

        <div id="apbio-preview"
          class="p-4 bg-slate-50 dark:bg-slate-800/30 rounded-lg border border-slate-200 dark:border-slate-700/30 hidden">
          <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-2">Tag Preview
          </p>
          <p id="apbio-tag-preview" class="text-sm font-medium text-brand-dark-gray dark:text-brand-white"></p>
        </div>
      </div>
      <div
        class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-brand-light-gray dark:border-brand-dark-gray/40 flex justify-end gap-3">
        <button id="cancel-apbio-btn"
          class="h-10 px-6 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white text-sm font-bold hover:bg-brand-light-gray/30 transition-colors">
          Cancel
        </button>
        <button id="generate-ai-btn"
          class="h-10 px-6 rounded-lg bg-gradient-to-r from-green-600 to-emerald-600 text-white text-sm font-bold hover:from-green-700 hover:to-emerald-700 transition-colors flex items-center gap-2">
          <span class="material-symbols-outlined text-base">label</span>
          Apply Topic Tag
        </button>
      </div>
    </div>
  </div>

  <!-- NEW FEATURE: Stimulus/Passage Modal -->
  <div id="stimulus-modal"
    class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div
      class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
      <div
        class="sticky top-0 bg-gradient-to-r from-emerald-600 to-teal-600 px-6 py-4 border-b border-emerald-700 z-10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="material-symbols-outlined text-white text-2xl">article</span>
          <div>
            <h2 class="text-white text-xl font-bold">Add Stimulus/Passage</h2>
            <p class="text-white/80 text-sm">Create a shared passage for multiple questions</p>
          </div>
        </div>
        <button id="close-stimulus-modal-btn"
          class="h-10 px-4 rounded-lg bg-white/20 text-white text-sm font-bold hover:bg-white/30 transition-colors">
          Close
        </button>
      </div>
      <div class="p-6 flex-1 overflow-y-auto">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Stimulus
            Title</label>
          <input type="text" id="stimulus-title-input"
            class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-white dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/50"
            placeholder="e.g., Reading Passage 1, Experiment Data Table">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Passage
            Content</label>
          <div id="stimulus-content-editor" class="bg-white text-black h-64 rounded-lg overflow-hidden"></div>
        </div>
        <div
          class="mb-4 p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg border border-emerald-200 dark:border-emerald-700/30">
          <p class="text-xs text-emerald-800 dark:text-emerald-200"><span class="font-semibold">Tip:</span> After
            creating a stimulus, add questions that reference it. The stimulus will be displayed above those questions
            during the assessment.</p>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Number of Questions
            to Create</label>
          <input type="number" id="stimulus-question-count" min="1" max="10" value="2"
            class="w-32 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-white dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/50">
        </div>
      </div>
      <div
        class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-brand-light-gray dark:border-brand-dark-gray/40 flex justify-end gap-3">
        <button id="cancel-stimulus-btn"
          class="h-10 px-6 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white text-sm font-bold hover:bg-brand-light-gray/30 transition-colors">
          Cancel
        </button>
        <button id="create-stimulus-btn"
          class="h-10 px-6 rounded-lg bg-emerald-600 text-white text-sm font-bold hover:bg-emerald-700 transition-colors">
          Create Stimulus & Questions
        </button>
      </div>
    </div>
  </div>

  <!-- Student Links Modal -->
  <div id="student-links-modal"
    class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div
      class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/70">
        <h2 class="text-brand-white text-2xl font-bold">Student Personalized Links</h2>
        <p class="text-brand-white/80 text-sm mt-1">Each student has a unique tracking link.</p>
      </div>
      <div class="p-6">
        <div id="links-container" class="max-h-[60vh] overflow-y-auto"></div>
        <div class="mt-6 pt-4 border-t border-primary/20">
          <button id="close-links-modal-btn"
            class="flex items-center justify-center gap-2 rounded-lg h-10 px-6 bg-primary text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
            <span>Close</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Add Students Modal -->
  <div id="bulk-add-students-modal"
    class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div
      class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/70">
        <h2 class="text-brand-white text-2xl font-bold">Bulk Add Students</h2>
        <p class="text-brand-white/80 text-sm mt-1">Add multiple students at once. Enter one student per line in format:
          Name, Email</p>
      </div>
      <div class="p-6 flex-1 overflow-y-auto">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Student Data</label>
          <textarea id="bulk-student-input"
            class="w-full h-64 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 font-mono"
            placeholder="John Smith, jsmith@school.edu&#10;Jane Doe, jdoe@school.edu&#10;Bob Johnson, bjohnson@school.edu"></textarea>
          <p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-2">Format: Name, Email (one per line).
            Duplicates will be skipped automatically.</p>
        </div>
      </div>
      <div
        class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-primary/20 flex justify-end gap-3">
        <button id="cancel-bulk-add-btn"
          class="h-10 px-5 rounded-lg bg-brand-dark-gray/10 dark:bg-brand-white/10 text-brand-dark-gray dark:text-brand-white text-sm font-semibold hover:bg-brand-dark-gray/20 dark:hover:bg-brand-white/20 transition-colors">Cancel</button>
        <button id="confirm-bulk-add-btn"
          class="h-10 px-5 rounded-lg bg-primary text-brand-white text-sm font-bold hover:bg-primary/90 transition-colors">Add
          Students</button>
      </div>
    </div>
  </div>

  <!-- Poll Preview Modal -->
  <!-- REDESIGNED: Unified Poll Editor & Preview Modal -->
  <div id="poll-preview-modal"
    class="modal fixed inset-0 z-[100] hidden bg-gray-100 dark:bg-gray-900 flex-col overflow-hidden font-sans">

    <!-- 1. Header Area -->
    <header
      class="bg-white dark:bg-brand-dark-gray border-b border-gray-200 dark:border-gray-700 h-16 flex items-center justify-between px-6 shadow-sm z-20 flex-shrink-0">
      <div class="flex items-center gap-4">
        <div
          class="h-10 w-10 rounded-xl bg-veritas-navy text-white flex items-center justify-center shadow-lg shadow-veritas-navy/20">
          <span class="material-symbols-outlined text-2xl">edit_note</span>
        </div>
        <div>
          <h2 id="preview-poll-name" class="text-lg font-bold text-gray-900 dark:text-white leading-tight">Poll Name
          </h2>
          <div class="flex items-center gap-2 text-xs text-gray-500 font-medium">
            <span id="preview-poll-meta">Class â€¢ 0 Questions</span>
            <span class="mx-1">â€¢</span>
            <span class="text-emerald-600 dark:text-emerald-400 flex items-center gap-1">
              <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
              Auto-saving
            </span>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button id="preview-view-links-btn"
          class="hidden sm:flex items-center gap-2 px-4 py-2 rounded-lg bg-indigo-50 text-indigo-700 hover:bg-indigo-100 transition-colors text-sm font-semibold">
          <span class="material-symbols-outlined text-lg">link</span>
          Student Links
        </button>
        <div class="h-8 w-px bg-gray-200 dark:bg-gray-700 mx-1"></div>
        <button onclick="closePollPreview()"
          class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-sm font-semibold">
          Close
        </button>
        <button id="preview-save-btn" onclick="saveAndClosePreview()"
          class="flex items-center gap-2 px-6 py-2 rounded-lg bg-veritas-navy text-white hover:bg-veritas-navy/90 transition-all shadow-lg shadow-veritas-navy/20 text-sm font-bold">
          <span class="material-symbols-outlined text-lg">save</span>
          Save & Close
        </button>
      </div>
    </header>

    <!-- 2. Main Workspace -->
    <div class="flex-1 flex overflow-hidden">

      <!-- A. Left Sidebar: Question Navigator -->
      <aside
        class="w-72 bg-white dark:bg-brand-dark-gray border-r border-gray-200 dark:border-gray-700 flex flex-col flex-shrink-0 z-10 transition-all duration-300"
        id="editor-sidebar">
        <div
          class="p-4 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-gray-800/10 backdrop-blur-sm">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Questions</h3>
            <span id="preview-question-count-badge"
              class="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-[10px] font-bold px-1.5 py-0.5 rounded">0</span>
          </div>
          <button id="editor-add-question-btn" onclick="addNewQuestionToPoll()"
            class="w-full py-2.5 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 hover:border-veritas-gold hover:text-veritas-gold dark:hover:border-veritas-gold dark:hover:text-veritas-gold hover:bg-veritas-gold/5 transition-all text-sm font-bold flex items-center justify-center gap-2 group">
            <span class="material-symbols-outlined group-hover:scale-110 transition-transform">add_circle</span>
            Add Question
          </button>
        </div>

        <div id="preview-questions-nav" class="flex-1 overflow-y-auto p-3 space-y-2 scrollbar-thin">
          <!-- Questions injected here -->
        </div>
      </aside>

      <!-- B. Middle Panel: Editor Form -->
      <main class="flex-1 flex flex-col min-w-0 bg-gray-50 dark:bg-gray-900 relative">
        <div class="flex-1 overflow-y-auto p-6 md:p-8 xl:p-12 scrollbar-hide">
          <div class="max-w-3xl mx-auto space-y-8 pb-20">

            <!-- Editor Header -->
            <div class="flex items-center justify-between">
              <h1 class="text-2xl font-bold text-gray-900 dark:text-white font-display">Edit Question <span
                  id="editor-current-num">1</span></h1>
              <div class="flex items-center gap-2">
                <button id="editor-delete-btn" onclick="deleteCurrentQuestion()"
                  class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                  title="Delete Question">
                  <span class="material-symbols-outlined">delete</span>
                </button>
                <button id="editor-duplicate-btn" onclick="duplicateCurrentQuestion()"
                  class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                  title="Duplicate Question">
                  <span class="material-symbols-outlined">content_copy</span>
                </button>
              </div>
            </div>

            <!-- Question Input -->
            <div
              class="bg-white dark:bg-brand-dark-gray p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 space-y-4">
              <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wide">Question
                Text</label>
              <div id="editor-question-input" class="bg-gray-50 dark:bg-gray-800 rounded-lg min-h-[100px]"></div>

              <!-- Media & Timer Row -->
              <div class="flex flex-wrap gap-4 pt-2">
                <div class="flex-1 min-w-[200px]">
                  <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Attached
                    Media</label>
                  <div class="flex items-center gap-3">
                    <button id="editor-upload-img-btn"
                      onclick="document.getElementById('editor-hidden-file-input').click()"
                      class="flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 text-sm font-semibold transition-colors">
                      <span class="material-symbols-outlined text-lg">image</span>
                      Upload Image
                    </button>
                    <div id="editor-img-preview-container" class="hidden relative group h-10 w-10">
                      <img id="editor-img-thumbnail" src=""
                        class="h-10 w-10 object-cover rounded-lg border border-gray-300">
                      <button id="editor-remove-img-btn" onclick="removeQuestionImage()"
                        class="absolute -top-1.5 -right-1.5 bg-red-500 text-white rounded-full p-0.5 hover:bg-red-600 shadow-sm opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="material-symbols-outlined text-[10px]">close</span>
                      </button>
                    </div>
                  </div>
                  <input type="file" id="editor-hidden-file-input" class="hidden" accept="image/*"
                    onchange="handleQuestionImageUpload(this)">
                </div>

                <div class="w-32">
                  <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Timer (sec)</label>
                  <div class="relative">
                    <span
                      class="absolute left-3 top-1/2 -translate-y-1/2 material-symbols-outlined text-gray-400 text-sm">timer</span>
                    <input type="number" id="editor-timer-input" value="60" min="10" step="10"
                      class="w-full pl-9 pr-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-brand-dark-gray/50 focus:ring-2 focus:ring-veritas-gold focus:border-veritas-gold text-sm font-semibold">
                  </div>
                </div>
              </div>
            </div>

            <!-- Answers Input -->
            <div class="space-y-4">
              <div class="flex items-center justify-between">
                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wide">Answer
                  Options</label>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-500">Correct Answer</span>
                </div>
              </div>

              <div id="editor-options-list" class="space-y-3">
                <!-- Options injected here -->
              </div>

              <div class="flex justify-center pt-2">
                <button id="editor-add-option-btn" onclick="addOptionToQuestion()"
                  class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 text-sm font-bold transition-colors">
                  <span class="material-symbols-outlined text-lg">add</span>
                  Add Option
                </button>
              </div>
            </div>

          </div>
        </div>
      </main>

      <!-- C. Right Panel: True Preview (Hidden on small screens) -->
      <aside
        class="hidden xl:flex w-[500px] bg-gray-100 dark:bg-black/20 border-l border-gray-200 dark:border-gray-700 flex-col flex-shrink-0 relative">
        <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-transparent via-veritas-gold/40 to-transparent">
        </div>

        <div
          class="p-4 flex items-center justify-between bg-white dark:bg-brand-dark-gray border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">smartphone</span>
            Student View (Preview)
          </h3>
          <span class="text-[10px] text-gray-400">Live Updates</span>
        </div>

        <div class="flex-1 overflow-y-auto p-6 flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-900">
          <!-- Simulated Device Frame -->
          <div
            class="w-full max-w-[400px] h-[750px] bg-white border-8 border-gray-900 rounded-[3rem] shadow-2xl flex flex-col overflow-hidden relative">
            <!-- Status Bar Mockup -->
            <div class="h-6 bg-gray-900 w-full flex items-center justify-between px-6">
              <div class="text-[10px] text-white font-medium">9:41</div>
              <div class="flex items-center gap-1.5">
                <span class="material-symbols-outlined text-[10px] text-white">signal_cellular_alt</span>
                <span class="material-symbols-outlined text-[10px] text-white">wifi</span>
                <span class="material-symbols-outlined text-[10px] text-white">battery_full</span>
              </div>
            </div>

            <!-- Student Interface Mockup -->
            <div class="flex-1 bg-white overflow-y-auto relative scrollbar-hide">

              <!-- Header -->
              <div
                class="h-14 bg-veritas-navy text-white flex items-center px-4 justify-between sticky top-0 z-10 shadow-md">
                <span class="font-bold tracking-widest text-sm">VERITAS</span>
                <div class="flex items-center gap-2">
                  <span
                    class="bg-black/20 rounded-full w-8 h-8 flex items-center justify-center text-xs font-mono">0:45</span>
                </div>
              </div>

              <!-- Question Content (The True Preview) -->
              <div class="p-5 font-sans">
                <div id="true-preview-container">
                  <!-- Injected formatted question goes here -->
                  <div class="question-visual float-right ml-3 mb-3 max-w-[120px] hidden" id="preview-student-visual">
                    <img src="" class="rounded-lg border border-gray-200 w-full object-contain bg-white">
                  </div>
                  <h2 class="text-[#12385d] font-serif text-lg leading-relaxed mb-4" id="preview-student-stem">Question
                    text...</h2>

                  <div class="clear-both space-y-3 mt-6" id="preview-student-options">
                    <!-- Options -->
                  </div>
                </div>
              </div>

              <!-- Footer -->
              <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-100 bg-white">
                <div
                  class="w-full h-12 bg-gray-100 rounded-xl flex items-center justify-center text-gray-400 font-bold text-sm">
                  Submit Answer
                </div>
              </div>
            </div>

            <!-- Home Indicator -->
            <div class="absolute bottom-1 left-1/2 -translate-x-1/2 w-32 h-1 bg-white/20 rounded-full"></div>
          </div>
        </div>
      </aside>

    </div>

    <!-- Scoped Styles for True Preview (inline to ensure they are available) -->
    <style>
      /* Mimic Student Styles within the preview container */
      #true-preview-container .student-option {
        border: 1px solid #d1d5db;
        border-radius: 12px;
        padding: 10px 12px;
        background: white;
        color: black;
        transition: all 0.2s;
      }

      #true-preview-container .student-option.correct-preview {
        border-color: #22c55e;
        background-color: #f0fdf4;
      }

      #true-preview-container .student-badge {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        background: #f8fafc;
        border: 1px solid #cbd5e1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #12385d;
        flex-shrink: 0;
      }

      #true-preview-container .student-option.correct-preview .student-badge {
        background: #22c55e;
        border-color: #22c55e;
        color: white;
      }
    </style>
  </div>

  <!-- Post-Poll Analytics Modal -->
  <div id="post-poll-analytics-modal"
    class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div
      class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-7xl max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header -->
      <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-4 border-b border-white/20">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <h2 id="analytics-poll-name" class="text-brand-white text-2xl font-bold">Psychometric Analysis</h2>
            <p id="analytics-poll-meta" class="text-brand-white/90 text-sm mt-1">Professional Assessment Quality Report
            </p>
          </div>
          <button id="close-analytics-modal-btn"
            class="flex items-center justify-center h-10 w-10 rounded-lg bg-brand-white/20 text-brand-white hover:bg-brand-white/30 transition-colors">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
      </div>

      <!-- Body -->
      <div class="flex-1 overflow-y-auto p-6">
        <div id="analytics-content">
          <!-- Loading state -->
          <div id="analytics-loading" class="flex items-center justify-center py-12">
            <div class="flex flex-col items-center gap-3">
              <div class="flex flex-row gap-2 justify-center mb-1">
                <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce"></div>
                <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.3s]"></div>
                <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.5s]"></div>
              </div>
              <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Computing analytics...</p>
            </div>
          </div>

          <!-- Content will be rendered here -->
          <div id="analytics-report" class="hidden">
            <!-- Action Items / Insights Section -->
            <div id="analytics-actions-container" class="mb-6 empty:hidden"></div>

            <!-- Class Overview Section -->
            <div class="mb-6">
              <h3 class="text-xl font-bold text-brand-dark-gray dark:text-brand-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">bar_chart</span>
                Class Overview
              </h3>
              <div id="class-overview-content"></div>
            </div>

            <!-- Metacognition Section -->
            <div id="metacognition-section" class="mb-6 hidden">
              <h3 class="text-xl font-bold text-brand-dark-gray dark:text-brand-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-purple-600">psychology</span>
                Metacognition Analysis
              </h3>
              <div id="metacognition-content"></div>
            </div>

            <!-- Item Analysis Section -->
            <div class="mb-6">
              <h3 class="text-xl font-bold text-brand-dark-gray dark:text-brand-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-blue-600">assignment</span>
                Item-by-Item Analysis
              </h3>
              <div id="item-analysis-content"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div
        class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-brand-light-gray dark:border-brand-dark-gray/40 flex items-center justify-between">
        <div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">
          <p>ðŸ“Š Powered by professional psychometric analysis</p>
        </div>
        <button id="export-analytics-btn"
          class="h-10 px-5 rounded-lg bg-veritas-gold text-brand-white text-sm font-semibold hover:bg-veritas-gold/90 transition-colors">
          <span class="material-symbols-outlined text-sm align-middle mr-1">download</span>
          Export Report
        </button>
      </div>
    </div>
  </div>

  <!-- Data Migration Modal -->
  <div id="migration-modal"
    class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
    <div
      class="w-full max-w-lg rounded-2xl bg-white dark:bg-gray-800 p-6 shadow-xl border border-gray-200 dark:border-gray-700">
      <div class="mb-6 flex items-start justify-between">
        <div>
          <h3 class="text-xl font-bold text-gray-900 dark:text-white">Import Data from Sheets</h3>
          <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Upload the JSON export file from your legacy Google
            Sheet.</p>
        </div>
        <button onclick="document.getElementById('migration-modal').classList.add('hidden')"
          class="rounded-lg p-1 text-gray-400 hover:bg-gray-100 hover:text-gray-500 dark:hover:bg-gray-700">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div class="space-y-4">
        <div class="flex items-center justify-center w-full">
          <label for="migration-file-input"
            class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:hover:bg-gray-800 dark:bg-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:hover:border-gray-500">
            <div class="flex flex-col items-center justify-center pt-5 pb-6">
              <span class="material-symbols-outlined text-3xl text-gray-400 mb-2">upload_file</span>
              <p class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Click to
                  upload</span> veritas_full_export.json</p>
            </div>
            <input id="migration-file-input" type="file" class="hidden" accept=".json"
              onchange="handleMigrationFileSelect(this)" />
          </label>
        </div>

        <div id="migration-file-info"
          class="hidden p-3 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 rounded-lg text-sm flex items-center gap-2">
          <span class="material-symbols-outlined text-base">description</span>
          <span id="migration-filename" class="font-mono">filename.json</span>
        </div>

        <div id="migration-progress-container" class="hidden space-y-2">
          <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400">
            <span id="migration-status-text">Processing...</span>
            <span id="migration-percent">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
            <div id="migration-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
          </div>
          <div id="migration-log"
            class="h-24 overflow-y-auto bg-gray-900 text-green-400 font-mono text-xs p-2 rounded-lg">
            <!-- Log output -->
          </div>
        </div>
      </div>

      <div class="mt-6 flex justify-end gap-3">
        <button onclick="document.getElementById('migration-modal').classList.add('hidden')"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600 transition-colors">
          Cancel
        </button>
        <button id="start-migration-btn" onclick="startMigration()" disabled
          class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2">
          <span class="material-symbols-outlined text-base">rocket_launch</span>
          Start Import
        </button>
      </div>
    </div>
  </div>

  <!-- Poll Creation Wizard View -->

  <!-- Global Math Formula Modal -->
  <div id="formula-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-2xl transform rounded-xl bg-white p-6 shadow-2xl transition-all dark:bg-brand-dark-gray">
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-xl font-bold text-brand-dark-gray dark:text-white">Insert Math Formula</h3>
        <button id="close-formula-modal" class="text-slate-400 hover:text-slate-600">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <!-- The MathLive Visual Editor -->
      <div
        class="mb-6 rounded-lg border border-brand-light-gray bg-slate-50 p-4 dark:border-slate-600 dark:bg-slate-800">
        <math-field id="math-editor-field" class="w-full bg-transparent text-2xl" style="outline: none; border: none;">
          f(x) = \sqrt{x^2 + 1}
        </math-field>
      </div>

      <div class="flex justify-end gap-3">
        <button id="cancel-formula-btn"
          class="rounded-lg px-4 py-2 text-sm font-medium text-slate-500 hover:bg-slate-100">Cancel</button>
        <button id="insert-formula-btn"
          class="rounded-lg bg-primary px-6 py-2 text-sm font-bold text-white hover:bg-primary/90">Insert
          Formula</button>
      </div>
    </div>
  </div>
</body>

</html>