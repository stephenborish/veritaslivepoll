<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veritas Live Poll - Student</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#002d6b",
            "brand-white": "#ffffff",
            "brand-light-gray": "#d9e0e7",
            "brand-dark-gray": "#242424",
            "background-light": "#f5f7f8",
            "background-dark": "#0f1723"
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
            serif: ["Noto Serif", "serif"]
          },
          borderRadius: {
            DEFAULT: "0.25rem",
            lg: "0.5rem",
            xl: "0.75rem",
            full: "9999px"
          }
        }
      }
    };
  </script>
  <script>window.SESSION_TOKEN = '<?= sessionToken ?>';</script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-brand-dark-gray dark:text-brand-white min-h-screen">
  <!-- Header -->
  <header class="flex shrink-0 items-center justify-between whitespace-nowrap border-b border-solid border-primary/80 bg-primary px-6 py-3 shadow-sm">
    <div class="flex items-center gap-4">
      <img alt="Malvern Prep Logo" class="h-10 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png"/>
      <div class="flex flex-col">
        <h1 class="text-brand-white text-lg font-bold leading-tight tracking-[-0.015em]">Veritas Live Poll</h1>
        <p class="text-brand-white/80 text-sm">Student View</p>
      </div>
    </div>
    <div id="loader" class="loader" style="display: none;">
      <div class="h-6 w-6 animate-spin rounded-full border-2 border-brand-white/80 border-t-transparent"></div>
    </div>
  </header>

  <main class="flex flex-col items-center justify-center p-6">
    <!-- Entry Screen -->
    <div id="entry-screen" class="container max-w-3xl mx-auto text-center py-12">
      <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-8 shadow-lg">
        <span class="material-symbols-outlined text-6xl text-primary dark:text-brand-white mb-4 inline-block">ballot</span>
        <h1 class="text-primary dark:text-brand-white text-4xl font-bold mb-4">Live Poll</h1>
        <p class="text-brand-dark-gray/80 dark:text-brand-white/80 text-lg mb-6 leading-relaxed">
          Welcome to Veritas Live Poll! Click <strong>"Begin Session"</strong> to start participating.
        </p>

        <!-- Important Security Notice -->
        <div class="bg-red-50 dark:bg-red-900/20 border-2 border-red-500 dark:border-red-700 rounded-lg p-6 mb-8">
          <div class="flex items-start gap-3 mb-3">
            <span class="material-symbols-outlined text-3xl text-red-600 dark:text-red-400 flex-shrink-0">warning</span>
            <h4 class="text-red-600 dark:text-red-400 text-xl font-bold text-left">Important Security Notice</h4>
          </div>
          <p class="text-red-800 dark:text-red-300 text-base text-left leading-relaxed">
            This poll must be completed in this tab.
            <strong>Do not switch tabs, open other windows, or exit fullscreen mode</strong>,
            or your session will be permanently locked and you will need your teacher to unlock you.
          </p>
        </div>

        <button id="start-session-btn" class="flex items-center justify-center gap-3 mx-auto px-12 py-4 rounded-full bg-primary text-brand-white text-xl font-bold hover:bg-primary/90 transition-colors shadow-lg hover:shadow-xl">
          <span class="material-symbols-outlined text-2xl">play_circle</span>
          <span>Begin Session</span>
        </button>
      </div>
    </div>

    <!-- Student App Container -->
    <div class="container max-w-4xl mx-auto" id="student-container" style="display: none;">
      <div id="student-loader" class="text-center py-12" style="display: block;">
        <div class="h-16 w-16 animate-spin rounded-full border-4 border-primary border-t-transparent mx-auto mb-4"></div>
        <p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-lg">Connecting to poll...</p>
      </div>

      <!-- Status Container -->
      <div id="status-container" class="text-center py-12" style="display: none;">
        <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-8 shadow-lg">
          <span class="material-symbols-outlined text-6xl text-primary dark:text-brand-white mb-4 inline-block">schedule</span>
          <h2 id="status-message" class="text-brand-dark-gray dark:text-brand-white text-2xl font-semibold">Connecting to poll...</h2>
          <div id="resume-controls" class="mt-6 space-y-3" style="display: none;">
            <p class="text-brand-dark-gray/80 dark:text-brand-white/80 text-base leading-relaxed">
              Click below to return to fullscreen and resume the poll.
            </p>
            <button id="resume-session-btn" class="mx-auto flex items-center justify-center gap-2 px-8 py-3 rounded-full bg-primary text-brand-white text-lg font-semibold hover:bg-primary/90 transition-colors shadow">
              <span class="material-symbols-outlined text-xl">fullscreen</span>
              <span>Resume Poll</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Question Container -->
      <div id="question-container" class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border-2 border-primary/20 dark:border-primary/40 shadow-2xl" style="display: none;">
        <!-- Question Header -->
        <div class="bg-primary/5 dark:bg-primary/10 px-6 py-4 border-b-2 border-primary/20">
          <p id="question-number" class="text-sm font-bold text-primary dark:text-brand-white/80 uppercase tracking-wide"></p>
        </div>

        <!-- Question Content -->
        <div id="question-content" class="p-8">
          <img id="question-image" src="" alt="Question" class="max-w-full max-h-[500px] rounded-xl mx-auto mb-8 shadow-xl border-2 border-gray-200 dark:border-gray-700" referrerpolicy="no-referrer" onerror="this.style.display='none';" style="display: none;" />
          <h2 id="question-text" class="font-serif text-brand-dark-gray dark:text-brand-white text-4xl font-bold leading-snug text-center mb-8"></h2>
        </div>

        <!-- Answer Options -->
        <div class="px-6 pb-8">
          <div id="options-list" class="space-y-3"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    (function() {
        var studentLoader = document.getElementById('student-loader');
        var statusContainer = document.getElementById('status-container');
        var statusMessage = document.getElementById('status-message');
        var questionContainer = document.getElementById('question-container');
        var optionsList = document.getElementById('options-list');
        var entryScreen = document.getElementById('entry-screen');
        var startSessionBtn = document.getElementById('start-session-btn');
        var studentContainer = document.getElementById('student-container');
        var resumeControls = document.getElementById('resume-controls');
        var resumeSessionBtn = document.getElementById('resume-session-btn');

        var currentPollState = {};
        var pollInterval = null;
        var proctorPollInterval = null;
        var isInteractionBlocked = false;
        var currentLockVersion = 0;
        var hasAnsweredCurrent = false;
        var violationLogged = false;
        var violationDebounceTimer = null;

        if (resumeSessionBtn) {
            resumeSessionBtn.onclick = function() {
                console.log('Resume button clicked - attempting fullscreen');
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen()
                        .then(function() {
                            console.log('Fullscreen entered - confirming with server');
                            // Call studentConfirmFullscreen with the current lockVersion
                            google.script.run
                                .withSuccessHandler(function(response) {
                                    if (response.success && response.status === 'OK') {
                                        console.log('Server confirmed unlock - resuming poll');
                                        isInteractionBlocked = false;
                                        violationLogged = false;
                                        if (proctorPollInterval) {
                                            clearInterval(proctorPollInterval);
                                            proctorPollInterval = null;
                                        }
                                        if (resumeControls) {
                                            resumeControls.style.display = 'none';
                                        }
                                        if (pollInterval) clearInterval(pollInterval);
                                        pollInterval = setInterval(pollForStatus, 2500);
                                        pollForStatus();
                                    } else {
                                        console.error('Failed to confirm fullscreen:', response);
                                        statusMessage.textContent = 'Failed to resume. Please try again.';
                                    }
                                })
                                .withFailureHandler(function(error) {
                                    console.error('Error confirming fullscreen:', error);
                                    statusMessage.textContent = 'Error resuming session.';
                                })
                                .studentConfirmFullscreen(currentLockVersion, SESSION_TOKEN);
                        })
                        .catch(function(e) {
                            console.warn('Fullscreen denied on resume:', e);
                            statusMessage.textContent = 'Fullscreen is required. Please allow fullscreen and try again.';
                        });
                }
            };
        }

        startSessionBtn.onclick = function() {
            console.log('Starting session...');
            entryScreen.style.display = 'none';
            studentContainer.style.display = 'block';
            isInteractionBlocked = false;
            violationLogged = false;
            if (resumeControls) {
                resumeControls.style.display = 'none';
            }

            try {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen().catch(function(e) {
                        console.warn('Fullscreen denied:', e);
                    });
                }
            } catch (e) {
                console.error('Fullscreen error:', e);
            }

            function reportViolationDebounced(reason) {
                // Clear any existing timer
                if (violationDebounceTimer) {
                    clearTimeout(violationDebounceTimer);
                }

                // Set a new timer for 300ms
                violationDebounceTimer = setTimeout(function() {
                    // Check if already reported to prevent duplicates
                    if (violationLogged || isInteractionBlocked) {
                        console.log('Violation already reported, skipping');
                        return;
                    }

                    console.log('VIOLATION: ' + reason);
                    // Set flags BEFORE RPC to prevent retry-based double-bump
                    violationLogged = true;
                    isInteractionBlocked = true;

                    google.script.run
                        .withSuccessHandler(function(response) {
                            if (response.success) {
                                currentLockVersion = response.lockVersion;
                                showLockedMessage();
                                startProctorPolling();
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('Violation report failed:', error);
                            // Keep flags set - student stays locked locally even if server unreachable
                            showLockedMessage();
                        })
                        .reportStudentViolation(reason, SESSION_TOKEN);
                }, 300);
            }

            document.addEventListener('visibilitychange', function() {
                if (document.hidden && !isInteractionBlocked && !violationLogged) {
                    reportViolationDebounced('tab-blur');
                }
            });

            document.addEventListener('fullscreenchange', function() {
                if (!document.fullscreenElement && !isInteractionBlocked && !violationLogged) {
                    reportViolationDebounced('exit-fullscreen');
                }
            });

            pollForStatus();
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            pollInterval = setInterval(pollForStatus, 2500);
        };

        function pollForStatus() {
            if (isInteractionBlocked) return;
            google.script.run
                .withSuccessHandler(updateStudentView)
                .withFailureHandler(handleError)
                .getStudentPollStatus(SESSION_TOKEN);
        }

        function startProctorPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            if (proctorPollInterval) {
                clearInterval(proctorPollInterval);
            }
            proctorPollInterval = setInterval(checkProctorState, 2500);
            checkProctorState();
        }

        function checkProctorState() {
            google.script.run
                .withSuccessHandler(function(response) {
                    if (!response.success) {
                        console.error('Proctor state check failed:', response.error);
                        return;
                    }

                    // Check if status is AWAITING_FULLSCREEN and lockVersion matches
                    if (response.status === 'AWAITING_FULLSCREEN' && response.lockVersion === currentLockVersion) {
                        if (proctorPollInterval) {
                            clearInterval(proctorPollInterval);
                            proctorPollInterval = null;
                        }
                        showResumePrompt();
                    } else if (response.status === 'LOCKED' && response.lockVersion !== currentLockVersion) {
                        // New violation or version mismatch - update lockVersion
                        currentLockVersion = response.lockVersion;
                        showLockedMessage();
                    } else if (response.status === 'OK') {
                        // Unlocked - resume normal polling
                        if (proctorPollInterval) {
                            clearInterval(proctorPollInterval);
                            proctorPollInterval = null;
                        }
                        isInteractionBlocked = false;
                        violationLogged = false;
                        if (pollInterval) clearInterval(pollInterval);
                        pollInterval = setInterval(pollForStatus, 2500);
                        pollForStatus();
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Proctor state check error:', error);
                })
                .getStudentProctorState(SESSION_TOKEN);
        }

        function updateStudentView(data) {
            console.log('Status update:', data.status);
            if (studentLoader) studentLoader.style.display = 'none';

            if (data.status === 'LOCKED' || data.status === 'AWAITING_FULLSCREEN') {
                console.log('Server confirmed lock status on page load:', data.status);
                isInteractionBlocked = true;
                google.script.run
                    .withSuccessHandler(function(proctorResponse) {
                        if (proctorResponse.success) {
                            currentLockVersion = proctorResponse.lockVersion;
                            if (proctorResponse.status === 'AWAITING_FULLSCREEN') {
                                showResumePrompt();
                            } else if (proctorResponse.status === 'LOCKED') {
                                showLockedMessage();
                                startProctorPolling();
                            }
                        }
                    })
                    .withFailureHandler(handleError)
                    .getStudentProctorState(SESSION_TOKEN);
                return;
            }

            if (resumeControls) {
                resumeControls.style.display = 'none';
            }

            if (data.status === 'OPEN') {
                var isNewQuestion = (
                    currentPollState.pollId !== data.pollId ||
                    currentPollState.questionIndex !== data.questionIndex
                );

                if (isNewQuestion) {
                    hasAnsweredCurrent = !!data.hasSubmitted;
                    currentPollState = data;
                    statusContainer.style.display = 'none';
                    questionContainer.style.display = 'block';

                    // Set question number
                    var qNum = (data.questionIndex || 0) + 1;
                    var qTotal = data.totalQuestions || '?';
                    document.getElementById('question-number').textContent = 'Question ' + qNum + ' of ' + qTotal;

                    // Set question text
                    document.getElementById('question-text').textContent = data.questionText || '';

                    // Set question image
                    var qImgEl = document.getElementById('question-image');
                    if (data.questionImageURL) {
                        qImgEl.src = data.questionImageURL;
                        qImgEl.style.display = 'block';
                    } else {
                        qImgEl.style.display = 'none';
                    }

                    // Render answer options with letter labels
                    optionsList.innerHTML = "";
                    var shuffled = shuffle(data.options || []);
                    var letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

                    shuffled.forEach(function(option, index) {
                        var btn = document.createElement('button');
                        btn.className = 'answer-option w-full p-5 rounded-xl border-3 border-gray-300 dark:border-gray-600 bg-gradient-to-r from-brand-white to-gray-50 dark:from-brand-dark-gray/20 dark:to-brand-dark-gray/30 hover:border-primary hover:from-primary/5 hover:to-primary/10 dark:hover:from-primary/10 dark:hover:to-primary/15 transition-all hover:shadow-xl hover:scale-[1.02] cursor-pointer active:scale-[0.98]';
                        btn.dataset.answerText = option.text || '';

                        var letter = letters[index] || (index + 1).toString();
                        var content = '<div class="flex items-start gap-4">';

                        // Letter badge
                        content += '<div class="flex-shrink-0 w-10 h-10 rounded-lg bg-primary/10 dark:bg-primary/20 flex items-center justify-center border-2 border-primary/30">';
                        content += '<span class="text-primary dark:text-brand-white font-bold text-lg">' + letter + '</span>';
                        content += '</div>';

                        // Content area
                        content += '<div class="flex-grow flex flex-col items-center gap-3 min-w-0">';
                        if (option.imageURL) {
                            content += '<img src="' + escapeHtml(option.imageURL) + '" alt="Answer ' + letter + '" class="max-w-full max-h-[250px] rounded-lg object-contain shadow-md border-2 border-gray-200 dark:border-gray-600" referrerpolicy="no-referrer">';
                        }
                        if (option.text) {
                            content += '<p class="font-serif text-brand-dark-gray dark:text-brand-white text-2xl font-semibold leading-relaxed text-center w-full">' + escapeHtml(option.text) + '</p>';
                        }
                        content += '</div></div>';

                        btn.innerHTML = content;
                        btn.onclick = function() {
                            submitAnswer(data.pollId, data.questionIndex, option.text);
                        };
                        optionsList.appendChild(btn);
                    });
                } else if (hasAnsweredCurrent && !data.hasSubmitted) {
                    hasAnsweredCurrent = false;
                    questionContainer.style.display = 'block';
                    statusContainer.style.display = 'none';
                    var resetButtons = optionsList.querySelectorAll('button');
                    for (var b = 0; b < resetButtons.length; b++) {
                        resetButtons[b].disabled = false;
                        resetButtons[b].className = 'answer-option w-full p-5 rounded-xl border-3 border-gray-300 dark:border-gray-600 bg-gradient-to-r from-brand-white to-gray-50 dark:from-brand-dark-gray/20 dark:to-brand-dark-gray/30 hover:border-primary hover:from-primary/5 hover:to-primary/10 dark:hover:from-primary/10 dark:hover:to-primary/15 transition-all hover:shadow-xl hover:scale-[1.02] cursor-pointer active:scale-[0.98]';
                    }
                }

                if (data.hasSubmitted) {
                    hasAnsweredCurrent = true;
                }

                if (hasAnsweredCurrent) {
                    questionContainer.style.display = 'none';
                    statusContainer.style.display = 'block';
                    statusMessage.textContent = "Your answer has been submitted! Waiting for the next question...";
                    statusMessage.className = 'text-green-600 dark:text-green-400 text-2xl font-semibold';
                    var iconEl = statusContainer.querySelector('.material-symbols-outlined');
                    if (iconEl) {
                        iconEl.textContent = 'check_circle';
                        iconEl.className = 'material-symbols-outlined text-6xl text-green-600 dark:text-green-400 mb-4 inline-block';
                    }
                }
            } else {
                currentPollState = {};
                questionContainer.style.display = 'none';
                statusContainer.style.display = 'block';
                var statusIcon = 'schedule';
                var statusClass = 'text-primary';
                var statusTextClass = 'text-brand-dark-gray dark:text-brand-white text-2xl font-semibold';

                if (data.status === 'WAITING') {
                    if (data.hasSubmitted) {
                        hasAnsweredCurrent = true;
                        statusMessage.textContent = data.message || "Your answer has been submitted! Waiting for the next question...";
                        statusTextClass = 'text-green-600 dark:text-green-400 text-2xl font-semibold';
                        statusIcon = 'check_circle';
                        statusClass = 'text-green-600 dark:text-green-400';
                    } else {
                        hasAnsweredCurrent = false;
                        statusMessage.textContent = data.message || "Waiting for next question...";
                        statusIcon = 'schedule';
                        statusClass = 'text-primary';
                    }
                } else if (data.status === 'NOT_ENROLLED') {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || "You are not enrolled.";
                    statusTextClass = 'text-red-600 dark:text-red-400 text-2xl font-bold';
                    statusIcon = 'error';
                    statusClass = 'text-red-600 dark:text-red-400';
                    clearInterval(pollInterval);
                } else if (data.status === 'ERROR') {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || "An error occurred.";
                    statusTextClass = 'text-red-600 dark:text-red-400 text-2xl font-bold';
                    statusIcon = 'error';
                    statusClass = 'text-red-600 dark:text-red-400';
                } else {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || "The poll is not active.";
                    statusIcon = 'schedule';
                    statusClass = 'text-primary';
                }
                statusMessage.className = statusTextClass;
                var iconEl = statusContainer.querySelector('.material-symbols-outlined');
                if (iconEl) {
                    iconEl.textContent = statusIcon;
                    iconEl.className = 'material-symbols-outlined text-6xl mb-4 inline-block ' + statusClass;
                }
            }
        }

        function submitAnswer(pollId, questionIndex, answerText) {
            if (isInteractionBlocked) {
                return;
            }
            if (hasAnsweredCurrent) {
                return;
            }

            var buttons = optionsList.querySelectorAll('button');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].disabled = true;
                if (buttons[i].dataset.answerText === answerText) {
                    buttons[i].className = 'answer-option w-full p-5 rounded-xl border-3 border-primary bg-primary/15 dark:bg-primary/25 shadow-xl ring-4 ring-primary/30';
                } else {
                    buttons[i].className = 'answer-option w-full p-5 rounded-xl border-3 border-gray-300 dark:border-gray-600 bg-gradient-to-r from-brand-white to-gray-50 dark:from-brand-dark-gray/20 dark:to-brand-dark-gray/30 opacity-40';
                }
            }
            hasAnsweredCurrent = true;
            statusContainer.style.display = 'block';
            questionContainer.style.display = 'none';
            statusMessage.textContent = "Submitting...";
            google.script.run
                .withSuccessHandler(function(response) {
                    if (!response.success) {
                        hasAnsweredCurrent = false;
                        statusMessage.textContent = response.error || "Error occurred.";
                        setTimeout(function() {
                            if (!isInteractionBlocked) {
                                questionContainer.style.display = 'block';
                                statusContainer.style.display = 'none';
                                var buttons = optionsList.querySelectorAll('button');
                                for (var i = 0; i < buttons.length; i++) {
                                    buttons[i].disabled = false;
                                    buttons[i].className = 'answer-option w-full p-5 rounded-xl border-3 border-gray-300 dark:border-gray-600 bg-gradient-to-r from-brand-white to-gray-50 dark:from-brand-dark-gray/20 dark:to-brand-dark-gray/30 hover:border-primary hover:from-primary/5 hover:to-primary/10 dark:hover:from-primary/10 dark:hover:to-primary/15 transition-all hover:shadow-xl hover:scale-[1.02] cursor-pointer active:scale-[0.98]';
                                }
                            }
                        }, 2000);
                    }
                })
                .withFailureHandler(function(error) {
                    hasAnsweredCurrent = false;
                    handleError(error);
                })
                .submitStudentAnswer(pollId, questionIndex, answerText, SESSION_TOKEN);
        }

        function shuffle(array) {
            var arr = array.slice();
            for (var i = arr.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = arr[i];
                arr[i] = arr[j];
                arr[j] = temp;
            }
            return arr;
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showLockedMessage() {
            console.log('Showing locked message');
            studentContainer.style.display = 'block';
            entryScreen.style.display = 'none';
            questionContainer.style.display = 'none';
            statusContainer.style.display = 'block';
            if (studentLoader) studentLoader.style.display = 'none';

            statusMessage.textContent = 'Your session has been locked because you exited fullscreen mode. Your teacher must unlock you.';
            statusMessage.className = 'text-red-600 dark:text-red-400 text-xl font-semibold';

            var iconEl = statusContainer.querySelector('.material-symbols-outlined');
            if (iconEl) {
                iconEl.textContent = 'lock';
                iconEl.className = 'material-symbols-outlined text-6xl text-red-600 dark:text-red-400 mb-4 inline-block';
            }
            if (resumeControls) {
                resumeControls.style.display = 'none';
            }
        }

        function showResumePrompt() {
            console.log('Showing resume prompt');
            studentContainer.style.display = 'block';
            entryScreen.style.display = 'none';
            questionContainer.style.display = 'none';
            statusContainer.style.display = 'block';
            if (studentLoader) studentLoader.style.display = 'none';

            // Use exact text from requirements
            statusMessage.textContent = 'Your teacher has unlocked your session. Resume fullscreen to continue.';
            statusMessage.className = 'text-primary dark:text-brand-white text-xl font-semibold';

            var iconEl = statusContainer.querySelector('.material-symbols-outlined');
            if (iconEl) {
                iconEl.textContent = 'fullscreen';
                iconEl.className = 'material-symbols-outlined text-6xl text-primary mb-4 inline-block';
            }

            if (resumeControls) {
                resumeControls.style.display = 'block';
            }
        }

        function handleError(error) {
            console.error('Error:', error);
            statusContainer.style.display = 'block';
            questionContainer.style.display = 'none';
            if (studentLoader) studentLoader.style.display = 'none';
            if (resumeControls) resumeControls.style.display = 'none';

            statusMessage.textContent = 'An error occurred: ' + (error.message || error);
            statusMessage.className = 'text-red-600 dark:text-red-400 text-2xl font-bold';

            var iconEl = statusContainer.querySelector('.material-symbols-outlined');
            if (iconEl) {
                iconEl.textContent = 'error';
                iconEl.className = 'material-symbols-outlined text-6xl text-red-600 dark:text-red-400 mb-4 inline-block';
            }
        }
    })();
    </script>
</body>
</html>
