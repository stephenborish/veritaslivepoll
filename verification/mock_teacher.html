<!DOCTYPE html>
<html>
<head>
    <title>Mock Teacher Dashboard</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #loader { display: none; background: #eee; padding: 10px; }
        #live-poll-view { margin-top: 20px; padding: 20px; border: 2px solid green; background: #e0ffe0; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Frontend Verification: Robust Fallback</h1>
    <div id="loader">Loading...</div>

    <!-- UI Elements expected by script -->
    <div id="dashboard-sidebar"></div>
    <div id="dashboard"></div>
    <div id="live-view"></div>
    <div id="roster-manager"></div>
    <div id="archived-view"></div>
    <div id="analytics-view"></div>

    <select id="poll-select"><option value="poll_test_123">Poll 1</option></select>
    <select id="class-filter"></select>
    <div id="student-table-body"></div>
    <div id="poll-details-card"></div>
    <button id="start-poll-btn">Start Session</button>
    <button id="end-poll-btn" style="display:none">End Session</button>
    <div id="live-poll-view" style="display:none;"></div>

    <!-- Mocks -->
    <script>
        window.SecureAssessmentShared = {
            createHeartbeat: function() { return { start: function(){}, stop: function(){} }; }
        };

        // Mock global firebase if needed
        var firebase = {
            apps: [],
            initializeApp: function() {},
            database: function() {
                return { ref: function() { return { on: function(){}, off: function(){} } } }
            },
            ServerValue: { TIMESTAMP: 12345 }
        };
        // Also ensure database property exists for the initial access
        firebase.database.ServerValue = { TIMESTAMP: 12345 };

        var broadcastSessionState = function(pid, payload) {
            console.log('Mock Broadcast:', pid, payload);
        };

        // Mock Config
        var FIREBASE_CONFIG = {};

        // Mock Google Script Run
        var google = {
            script: {
                run: {
                    withSuccessHandler: function(success) {
                        return {
                            withFailureHandler: function(failure) {
                                return {
                                    getLivePollData: function(pollId, qIndex) {
                                        console.log('Mock: getLivePollData called with', pollId, qIndex);
                                        // Simulate server response after delay
                                        setTimeout(function() {
                                            console.log('Mock: Server returning full data');
                                            try {
                                                success({
                                                    pollId: pollId,
                                                    questionIndex: qIndex,
                                                    status: 'LIVE',
                                                    metadata: { sessionPhase: 'LIVE', resultsVisibility: 'HIDDEN' },
                                                    calculatorEnabled: false,
                                                    // Minimal data for updateLiveView
                                                    questions: [{text: 'Q1'}],
                                                    correctAnswer: 'A'
                                                });

                                                // UI verification hook
                                                document.body.setAttribute('data-verification', 'success');
                                                document.getElementById('live-poll-view').style.display = 'block';
                                                document.getElementById('live-poll-view').innerText = 'Live View Updated Successfully via Fallback!';
                                                console.log('Mock: Success handler completed');
                                            } catch (e) {
                                                console.error('Mock: Success handler CRASHED:', e);
                                            }
                                        }, 100);
                                    },
                                    startPoll: function(pollId) { console.log('Mock: startPoll'); },
                                    withUserObject: function() { return this; }
                                }
                            }
                        }
                    }
                }
            }
        };

        // Mock other helpers
        function veritasAlert(msg) { console.log('Alert:', msg); }
        function previewOnlyNotice() {}
        function showDashboard() {}
        function setButtonLoading(btn, loading) {
            if(btn) btn.innerText = loading ? 'Loading...' : 'Start Session';
        }
        function initFirebaseMissionControl() {}
        function handleError(e) { console.error("handleError:", e); }

    </script>

    <!-- Load the extracted script -->
    <script src="Teacher_Scripts_Content.js"></script>

    <script>
        // Test Trigger
        window.onload = function() {
            setTimeout(function() {
                console.log('--- TEST STARTING ---');
                // Check globals
                console.log('pollSelect exists:', !!pollSelect);
                console.log('updateLiveView exists:', typeof updateLiveView);

                console.log('Simulating lightweight update with missing CURRENT_POLL_DATA...');

                // Ensure CURRENT_POLL_DATA is in "bad" state (no questions)
                if (typeof CURRENT_POLL_DATA !== 'undefined') {
                    CURRENT_POLL_DATA = {};
                    console.log('Forced CURRENT_POLL_DATA to {}');
                }

                var data = {
                    mode: 'lightweight',
                    pollId: 'poll_test_123',
                    questionIndex: 0,
                    status: 'OPEN',
                    metadata: { sessionPhase: 'LIVE' }
                };

                try {
                    handleLightweightSessionUpdate(data);
                } catch (e) {
                    console.error('Error running handleLightweightSessionUpdate:', e);
                    document.body.innerText = 'Error: ' + e.message;
                }

            }, 500);
        };
    </script>
</body>
</html>
