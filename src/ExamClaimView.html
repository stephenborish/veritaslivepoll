<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= HtmlService.createHtmlOutputFromFile('src/Common_Head').getContent() ?>
  <?!= HtmlService.createHtmlOutputFromFile('src/Common_Styles').getContent() ?>
  <title>Veritas - Claim Exam Seat</title>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

  <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-8 text-center">
    <div class="mb-6">
      <span class="material-symbols-outlined text-6xl text-veritas-navy">id_card</span>
    </div>

    <h1 class="text-2xl font-bold text-gray-900 mb-2">Exam Access</h1>
    <p class="text-gray-500 mb-6">Please enter your student email or ID to access this exam.</p>

    <form id="claimForm" onsubmit="handleClaim(event)" class="text-left">
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-1">Student Email / ID</label>
        <input type="text" name="identifier" class="w-full form-input rounded-lg border-gray-300 focus:ring-veritas-navy focus:border-veritas-navy" placeholder="e.g. sborish@malvernprep.org" required>
      </div>

      <button type="submit" class="btn-primary w-full justify-center py-3 text-lg">
        Verify & Enter
      </button>
    </form>

    <div id="errorMessage" class="mt-4 text-red-600 text-sm hidden bg-red-50 p-3 rounded"></div>
  </div>

  <script>
    const EXAM_ID = "<?= examId ?>";

    function handleClaim(e) {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      const input = e.target.querySelector('input');
      const errEl = document.getElementById('errorMessage');

      btn.disabled = true;
      btn.textContent = 'Verifying...';
      errEl.classList.add('hidden');

      google.script.run
        .withSuccessHandler(response => {
           if (response.success && response.redirectUrl) {
              window.location.href = response.redirectUrl;
           } else {
              showError(response.error || 'Verification failed');
              btn.disabled = false;
              btn.textContent = 'Verify & Enter';
           }
        })
        .withFailureHandler(err => {
           showError(err.message || 'Server error');
           btn.disabled = false;
           btn.textContent = 'Verify & Enter';
        })
        .claimExamSeat(EXAM_ID, input.value);
    }

    function showError(msg) {
       const el = document.getElementById('errorMessage');
       el.textContent = msg;
       el.classList.remove('hidden');
    }
  </script>
</body>
</html>
