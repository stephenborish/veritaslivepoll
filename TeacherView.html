<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veritas Live Poll - Teacher</title>
  <?!= include('Styling.html'); ?>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    /* IMPROVED TEACHER VIEW STYLES */
    #dashboard {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 24px;
      padding: 24px;
      max-width: 100%;
      margin: 0 auto;
    }
    
    aside {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .control-panel {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .control-panel h2 {
      font-size: 1.3rem;
      margin: 0 0 20px 0;
      padding-bottom: 12px;
      border-bottom: 2px solid #e9ecef;
      color: #212529;
    }
    
    .btn-block {
      width: 100%;
      margin-bottom: 10px;
      padding: 12px 20px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.2s;
      border: none;
      cursor: pointer;
    }
    
    .btn-block:last-child {
      margin-bottom: 0;
    }
    
    .btn-block:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .btn-block:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    #live-view {
      background: white;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: none;
    }
    
    #live-view.active {
      display: block;
    }
    
    .question-display {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 32px;
      border-radius: 12px;
      margin-bottom: 32px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .question-display h2 {
      color: white;
      margin: 0 0 8px 0;
      font-size: 1.8rem;
    }
    
    .question-meta {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 16px;
      opacity: 0.9;
      font-size: 0.95rem;
    }
    
    .question-text {
      font-size: 1.4rem;
      line-height: 1.6;
      margin: 16px 0 0 0;
      font-weight: 500;
    }
    
    .timer-display {
      font-size: 4rem;
      font-weight: 700;
      color: white;
      text-align: center;
      margin: 20px 0;
      font-variant-numeric: tabular-nums;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .timer-display.ending {
      color: #ff6b6b;
      animation: pulse 1s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    .status-badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
    }
    
    .status-badge.paused {
      background: rgba(255, 193, 7, 0.3);
    }
    
    .status-badge.open {
      background: rgba(40, 167, 69, 0.3);
    }
    
    .live-controls {
      display: flex;
      gap: 12px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .live-controls button {
      flex: 1;
      padding: 14px;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .results-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .results-header h3 {
      margin: 0;
      font-size: 1.3rem;
      color: #212529;
    }
    
    .stats-pills {
      display: flex;
      gap: 16px;
    }
    
    .stat-pill {
      background: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-pill.responses {
      color: #007bff;
      border: 2px solid #007bff;
    }
    
    .stat-pill.correct {
      color: #28a745;
      border: 2px solid #28a745;
    }
    
    #chart-div {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      min-height: 300px;
    }
    
    .students-section {
      margin-top: 32px;
    }
    
    .students-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e9ecef;
    }
    
    .students-header h3 {
      margin: 0;
      font-size: 1.3rem;
    }
    
    .sort-buttons {
      display: flex;
      gap: 8px;
    }
    
    .sort-buttons button {
      padding: 6px 16px;
      font-size: 0.9rem;
      background: white;
      color: #495057;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }
    
    .sort-buttons button:hover {
      background: #f8f9fa;
    }
    
    .sort-buttons button.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    
    #student-tile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
      max-height: 600px;
      overflow-y: auto;
      padding: 4px;
    }
    
    .student-tile {
      background: white;
      border-radius: 8px;
      padding: 14px;
      border-left: 4px solid #6c757d;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      transition: all 0.2s;
    }
    
    .student-tile:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }
    
    .student-tile.status-submitted {
      border-left-color: #28a745;
      background: linear-gradient(135deg, #ffffff 0%, #f0fff4 100%);
    }
    
    .student-tile.status-locked {
      border-left-color: #dc3545;
      background: linear-gradient(135deg, #ffffff 0%, #fff5f5 100%);
    }
    
    .tile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .tile-name {
      font-size: 1rem;
      font-weight: 600;
      color: #212529;
    }
    
    .tile-status-icon {
      font-size: 1.5rem;
    }
    
    .tile-answer {
      font-size: 0.9rem;
      color: #495057;
      margin-bottom: 6px;
      word-wrap: break-word;
    }
    
    .tile-time {
      font-size: 0.85rem;
      color: #868e96;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal-content h2 {
      margin-top: 0;
      margin-bottom: 24px;
      font-size: 1.8rem;
      color: #212529;
    }
    
    #question-builder {
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 10px;
    }
    
    .question-builder-item {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      position: relative;
    }
    
    .question-builder-item h3 {
      margin: 0 0 20px 0;
      padding-bottom: 12px;
      border-bottom: 2px solid #dee2e6;
      color: #495057;
      font-size: 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .delete-question-btn {
      padding: 4px 12px;
      font-size: 0.85rem;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .answer-choices-container {
      margin: 16px 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .answer-builder-item {
      display: grid;
      grid-template-columns: 40px 1fr auto auto;
      gap: 12px;
      align-items: center;
      padding: 16px;
      background: white;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      transition: all 0.2s;
    }
    
    .answer-builder-item:hover {
      border-color: #007bff;
      box-shadow: 0 2px 8px rgba(0,123,255,0.1);
    }
    
    .answer-builder-item input[type="radio"] {
      width: 24px;
      height: 24px;
      cursor: pointer;
      accent-color: #28a745;
    }
    
    .answer-builder-item input[type="text"] {
      flex-grow: 1;
      padding: 10px 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 1rem;
    }
    
    .answer-builder-item input[type="file"] {
      font-size: 0.85rem;
      padding: 6px;
    }
    
    .delete-answer-btn {
      padding: 6px 12px;
      font-size: 0.85rem;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .image-preview {
      grid-column: 2 / -1;
      max-width: 200px;
      max-height: 120px;
      border-radius: 6px;
      margin-top: 8px;
      display: none;
    }
    
    .add-answer-btn {
      width: 100%;
      margin-top: 12px;
      padding: 10px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .add-answer-btn:hover {
      background: #545b62;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #495057;
      font-size: 0.95rem;
    }
    
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }
    
    textarea {
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }
    
    @media (max-width: 1200px) {
      #dashboard {
        grid-template-columns: 1fr;
      }
      aside {
        order: 2;
      }
      #live-view {
        order: 1;
      }
    }
    
    @media (max-width: 768px) {
      .question-display {
        padding: 20px;
      }
      .timer-display {
        font-size: 3rem;
      }
      .live-controls {
        flex-direction: column;
      }
      #student-tile-grid {
        grid-template-columns: 1fr;
      }
      .answer-builder-item {
        grid-template-columns: 40px 1fr;
      }
      .answer-builder-item input[type="file"],
      .delete-answer-btn {
        grid-column: 2;
      }
      .stats-pills {
        flex-direction: column;
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>üìä Veritas Live Poll - Teacher Dashboard</h1>
      <div id="loader" class="loader" style="display: block;"></div>
    </div>
  </header>

  <main>
    <div id="dashboard">
      <aside>
        <div class="control-panel">
          <h2>‚ñ∂Ô∏è Poll Controls</h2>
          <div class="form-group">
            <label for="poll-select">Select Poll</label>
            <select id="poll-select">
              <option value="">-- Choose a poll --</option>
            </select>
          </div>
          <button id="send-link-btn" class="btn-block btn-secondary" style="background-color: #28a745;" disabled>‚úâÔ∏è Send Student Links</button>
          <button id="view-links-btn" class="btn-block btn-secondary" disabled>üëÅÔ∏è View All Links</button>
          <div class="form-group" style="margin-top: 20px;">
            <label for="poll-timer-input">Timer (seconds)</label>
            <input type="number" id="poll-timer-input" placeholder="60" min="10" max="600">
          </div>
          <button id="start-poll-btn" class="btn-block btn-primary">üöÄ Start Poll</button>
          <button id="stop-poll-btn" class="btn-block btn-danger" style="display: none;">‚è∏Ô∏è Pause Poll</button>
        </div>
        <div class="control-panel">
          <h2>‚ûï Create New Poll</h2>
          <button id="open-creator-btn" class="btn-block btn-secondary">Create New Poll</button>
        </div>
      </aside>

      <div id="live-view">
        <div class="question-display">
          <div class="question-meta">
            <span class="status-badge open" id="poll-status-badge">OPEN</span>
            <span id="live-question-info">Question 1 of 10</span>
          </div>
          <h2 id="live-poll-name">Poll Name</h2>
          <div id="live-timer-display" class="timer-display"></div>
          <div class="question-text" id="live-question-text">Question text appears here</div>
        </div>
        <div class="live-controls">
          <button id="resume-question-btn" class="btn-success" style="display: none;">‚ñ∂Ô∏è Resume Question</button>
          <button id="next-question-btn" class="btn-primary">Next Question ‚Üí</button>
          <button id="end-poll-btn" class="btn-danger">üèÅ End Poll</button>
        </div>
        <div class="results-section">
          <div class="results-header">
            <h3>üìä Live Results</h3>
            <div class="stats-pills">
              <div class="stat-pill responses"><span id="response-count">0 / 0 responses</span></div>
              <div class="stat-pill correct"><span id="correct-answer-display">Correct: -</span></div>
            </div>
          </div>
          <div id="chart-div"></div>
        </div>
        <div class="students-section">
          <div class="students-header">
            <h3>üë• Student Status</h3>
            <div class="sort-buttons">
              <button class="sort-btn active" data-sort="name">Name</button>
              <button class="sort-btn" data-sort="time">Time</button>
              <button class="sort-btn" data-sort="correctness">Correct</button>
            </div>
          </div>
          <div id="student-tile-grid"></div>
        </div>
      </div>
    </div>
  </main>

  <div id="poll-creator-modal" class="modal">
    <div class="modal-content">
      <h2>Create New Poll</h2>
      <div class="form-group">
        <label for="new-poll-name">Poll Name</label>
        <input type="text" id="new-poll-name" placeholder="e.g., Week 5 Physics Quiz">
      </div>
      <div class="form-group">
        <label for="class-select">Class</label>
        <select id="class-select"><option value="">-- Select Class --</option></select>
      </div>
      <hr style="margin: 24px 0; border: none; border-top: 2px solid #e9ecef;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="margin: 0;">Questions</h3>
        <button id="add-question-btn" class="btn-secondary">+ Add Question</button>
      </div>
      <div id="question-builder"></div>
      <hr style="margin: 24px 0; border: none; border-top: 2px solid #e9ecef;">
      <div style="display: flex; gap: 12px;">
        <button id="save-poll-btn" class="btn-primary" style="flex: 1;">üíæ Save Poll</button>
        <button id="close-modal-btn" class="btn-secondary" style="flex: 1;">Cancel</button>
      </div>
    </div>
  </div>

  <div id="student-links-modal" class="modal">
    <div class="modal-content">
      <h2>Student Personalized Links</h2>
      <p style="color: #6c757d; margin-bottom: 20px;">Each student has a unique tracking link.</p>
      <div id="links-container" style="max-height: 500px; overflow-y: auto;"></div>
      <div style="margin-top: 20px;">
        <button id="close-links-modal-btn" class="btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <script>
(function(){
  // --- Main App State ---
  var mainLoader=document.getElementById('loader');
  var ALL_POLLS=[];
  var ALL_CLASSES=[];
  var CURRENT_POLL_DATA={};
  var currentStudentStatusData=[];
  var currentSort='name';
  var pollInterval=null;
  var questionTimer=null;
  var visualTimerInterval=null;
  var isPaused=false;
  var questionCounter=0;

  // --- Element Cache ---
  var pollSelect=document.getElementById('poll-select');
  var startPollBtn=document.getElementById('start-poll-btn');
  var stopPollBtn=document.getElementById('stop-poll-btn');
  var resumeQuestionBtn=document.getElementById('resume-question-btn');
  var nextQuestionBtn=document.getElementById('next-question-btn');
  var endPollBtn=document.getElementById('end-poll-btn');
  var liveView=document.getElementById('live-view');
  var modal=document.getElementById('poll-creator-modal');
  var linksModal=document.getElementById('student-links-modal');
  var pollStatusBadge=document.getElementById('poll-status-badge');

  // --- Initialization ---
  google.charts.load('current',{'packages':['corechart']});
  google.charts.setOnLoadCallback(loadInitialData);
  
  // --- Event Listeners ---
  document.getElementById('open-creator-btn').onclick=openPollCreator;
  document.getElementById('close-modal-btn').onclick=closePollCreator;
  document.getElementById('close-links-modal-btn').onclick=closeLinksModal;
  document.getElementById('add-question-btn').onclick=addQuestionToBuilder;
  document.getElementById('save-poll-btn').onclick=savePoll;
  startPollBtn.onclick=onStartPoll;
  stopPollBtn.onclick=onStopPoll;
  resumeQuestionBtn.onclick=onResumePoll;
  nextQuestionBtn.onclick=onNextQuestion;
  endPollBtn.onclick=onEndPoll;
  document.getElementById('send-link-btn').onclick=onSendLink;
  document.getElementById('view-links-btn').onclick=onViewLinks;

  // --- Initial Data Load ---
  function loadInitialData(){
    google.script.run
      .withSuccessHandler(onDashboardDataLoaded)
      .withFailureHandler(handleError)
      .getTeacherDashboardData();
  }
  
  function onDashboardDataLoaded(data){
    mainLoader.style.display='none';
    ALL_CLASSES=data.classes||[];
    ALL_POLLS=data.polls||[];
    
    var classSelect=document.getElementById('class-select');
    classSelect.innerHTML='<option value="">-- Select Class --</option>';
    ALL_CLASSES.forEach(function(className){
      var opt=document.createElement('option');
      opt.value=className;
      opt.textContent=className;
      classSelect.appendChild(opt);
    });
    
    updatePollDropdown();
    setupSortButtons();
    setupUnlockListener();
  }
  
  function updatePollDropdown(){
    pollSelect.innerHTML='<option value="">-- Choose a poll --</option>';
    ALL_POLLS.forEach(function(poll){
      var opt=document.createElement('option');
      opt.value=poll.pollId;
      opt.textContent=poll.pollName+' ('+poll.className+') - '+poll.questions.length+' questions';
      pollSelect.appendChild(opt);
    });
    pollSelect.onchange=onPollSelectChange;
    onPollSelectChange();
  }
  
  function onPollSelectChange(){
    var pollId=pollSelect.value;
    var sendBtn=document.getElementById('send-link-btn');
    var viewBtn=document.getElementById('view-links-btn');
    if(pollId){
      var selectedPoll=ALL_POLLS.find(function(p){return p.pollId===pollId;});
      if(selectedPoll){
        sendBtn.disabled=false;
        viewBtn.disabled=false;
        sendBtn.dataset.className=selectedPoll.className;
        viewBtn.dataset.className=selectedPoll.className;
      }
    } else {
      sendBtn.disabled=true;
      viewBtn.disabled=true;
    }
  }

  // --- Poll Lifecycle Controls ---
  function onStartPoll(){
    var pollId=pollSelect.value;
    if(!pollId){alert("Please select a poll first.");return;}
    startPollBtn.disabled=true;
    startMasterTimer();
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .startPoll(pollId);
  }
  
  function onStopPoll(){
    stopPollBtn.disabled=true;
    clearTimeout(questionTimer);
    stopVisualTimer();
    google.script.run
      .withSuccessHandler(function(data){
        isPaused=true;
        updateLiveView(data);
      })
      .withFailureHandler(handleError)
      .stopPoll();
  }
  
  function onResumePoll(){
    resumeQuestionBtn.disabled=true;
    google.script.run
      .withSuccessHandler(function(data){
        isPaused=false;
        startMasterTimer();
        updateLiveView(data);
      })
      .withFailureHandler(handleError)
      .resumePoll();
  }
  
  function onNextQuestion(){
    nextQuestionBtn.disabled=true;
    if(pollInterval)clearInterval(pollInterval);
    isPaused=false;
    startMasterTimer();
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .nextQuestion();
  }
  
  function onEndPoll(){
    if(!confirm('Are you sure you want to end this poll completely?'))return;
    endPollBtn.disabled=true;
    clearTimeout(questionTimer);
    stopVisualTimer();
    if(pollInterval)clearInterval(pollInterval);
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .closePoll();
  }

  // --- Live View & Data Polling ---
  function updateLiveView(data){
    mainLoader.style.display='none';
    startPollBtn.disabled=false;
    stopPollBtn.disabled=false;
    resumeQuestionBtn.disabled=false;
    nextQuestionBtn.disabled=false;
    endPollBtn.disabled=false;
    
    if(data.status==="CLOSED"){
      liveView.classList.remove('active');
      startPollBtn.style.display='inline-block';
      stopPollBtn.style.display='none';
      if(pollInterval)clearInterval(pollInterval);
      CURRENT_POLL_DATA={};
      currentStudentStatusData=[];
      stopVisualTimer();
      return;
    }
    
    if(data.error){handleError(data.error);return;}
    
    CURRENT_POLL_DATA.pollId=pollSelect.value;
    CURRENT_POLL_DATA.questionIndex=data.questionIndex;
    CURRENT_POLL_DATA.correctAnswer=data.correctAnswer;
    CURRENT_POLL_DATA.isPaused=isPaused;
    
    liveView.classList.add('active');
    startPollBtn.style.display='none';
    
    if(isPaused){
      pollStatusBadge.textContent='PAUSED';
      pollStatusBadge.className='status-badge paused';
      stopPollBtn.style.display='none';
      resumeQuestionBtn.style.display='inline-block';
    } else {
      pollStatusBadge.textContent='OPEN';
      pollStatusBadge.className='status-badge open';
      stopPollBtn.style.display='inline-block';
      resumeQuestionBtn.style.display='none';
    }
    
    document.getElementById('live-poll-name').textContent=data.pollName;
    document.getElementById('live-question-info').textContent='Question '+(data.questionIndex+1)+' of '+data.totalQuestions;
    document.getElementById('live-question-text').textContent=data.questionText;
    document.getElementById('response-count').textContent=data.totalResponses+' / '+data.totalStudents+' responses';
    document.getElementById('correct-answer-display').textContent=data.correctAnswer?'Correct: '+data.correctAnswer:'No correct answer set';
    
    var isLastQuestion=(data.questionIndex+1===data.totalQuestions);
    nextQuestionBtn.textContent=isLastQuestion?"üèÅ Finish Poll":"Next Question ‚Üí";
    
    currentStudentStatusData=data.studentStatusList;
    renderStudentTiles();
    drawChart(data.results,data.correctAnswer);
    
    if(pollInterval)clearInterval(pollInterval);
    if(!isPaused){
      pollInterval=setInterval(pollForResults,2500);
    }
  }
  
  function pollForResults(){
    if(isPaused)return;
    var pollId=CURRENT_POLL_DATA.pollId;
    var questionIndex=CURRENT_POLL_DATA.questionIndex;
    if(pollId===undefined||questionIndex===undefined)return;
    
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(function(e){console.warn('Poll refresh error:',e);})
      .getLivePollData(pollId,questionIndex);
  }

  // --- Timer Controls ---
  function startMasterTimer(){
    clearTimeout(questionTimer);
    var timerInput=document.getElementById('poll-timer-input');
    var seconds=parseInt(timerInput.value,10);
    
    if(seconds>0&&seconds<=600){
      startVisualTimer(seconds);
      questionTimer=setTimeout(onStopPoll,seconds*1000);
      timerInput.value='';
    } else {
      stopVisualTimer();
    }
  }
  
  function startVisualTimer(duration){
    stopVisualTimer();
    var timerDisplay=document.getElementById('live-timer-display');
    if(!timerDisplay)return;
    
    var timer=duration;
    var updateDisplay=function(){
      var minutes=Math.floor(timer/60);
      var seconds=timer%60;
      timerDisplay.textContent=minutes+':'+(seconds<10?'0':'')+seconds;
      
      if(timer<=10){
        timerDisplay.classList.add('ending');
      } else {
        timerDisplay.classList.remove('ending');
      }
      
      if(timer<=0){
        stopVisualTimer();
        timerDisplay.textContent="Time's Up!";
      }
      timer--;
    };
    updateDisplay();
    visualTimerInterval=setInterval(updateDisplay,1000);
  }
  
  function stopVisualTimer(){
    clearInterval(visualTimerInterval);
    var timerDisplay=document.getElementById('live-timer-display');
    if(timerDisplay){
      timerDisplay.textContent='';
      timerDisplay.classList.remove('ending');
    }
  }

  // --- Student Tile & Sorting ---
  function renderStudentTiles(){
    var grid=document.getElementById('student-tile-grid');
    if(!grid)return;
    
    var sortedData=currentStudentStatusData.slice();
    
    if(currentSort==='name'){
      sortedData.sort(function(a,b){return a.name.localeCompare(b.name);});
    } else if(currentSort==='time'){
      sortedData.sort(function(a,b){return a.timestamp-b.timestamp;});
    } else if(currentSort==='correctness'){
      sortedData.sort(function(a,b){
        if(a.isCorrect===b.isCorrect)return 0;
        if(a.isCorrect===true)return-1;
        if(b.isCorrect===true)return 1;
        if(a.isCorrect===false)return-1;
        if(b.isCorrect===false)return 1;
        return 0;
      });
    }
    
    grid.innerHTML='';
    sortedData.forEach(function(student){
      var tile=document.createElement('div');
      tile.className='student-tile status-'+(student.status==='Submitted'?'submitted':student.status==='LOCKED'?'locked':'waiting');
      tile.dataset.email=student.email;
      
      var statusIcon='‚è≥';
      var timeText='';
      if(student.status==='Submitted'){
        var isCorrect=student.isCorrect;
        statusIcon=isCorrect?'‚úÖ':(CURRENT_POLL_DATA.correctAnswer?'‚ùå':'‚óâ');
        var date=new Date(student.timestamp);
        timeText='<div class="tile-time">'+date.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'})+'</div>';
      } else if(student.status==='LOCKED'){
        statusIcon='üîí';
      }
      
      var html='';
      html+='<div class="tile-header">';
      html+='<span class="tile-name">'+escapeHtml(student.name)+'</span>';
      html+='<span class="tile-status-icon">'+statusIcon+'</span>';
      html+='</div>';
      html+='<div class="tile-answer">'+(student.answer?escapeHtml(student.answer):'<i>'+student.status+'...</i>')+'</div>';
      html+=timeText;
      
      if(student.status==='LOCKED'){
        html+='<div style="margin-top: 10px;"><button class="unlock-btn" style="width: 100%; padding: 6px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Unlock</button></div>';
      }
      
      tile.innerHTML=html;
      grid.appendChild(tile);
    });
  }
  
  function setupSortButtons(){
    var sortContainer=document.querySelector('.sort-buttons');
    if(!sortContainer)return;
    
    sortContainer.addEventListener('click',function(e){
      if(e.target.classList.contains('sort-btn')){
        var sortType=e.target.dataset.sort;
        if(sortType===currentSort)return;
        
        sortContainer.querySelectorAll('.sort-btn').forEach(function(btn){btn.classList.remove('active');});
        e.target.classList.add('active');
        currentSort=sortType;
        renderStudentTiles();
      }
    });
  }
  
  function setupUnlockListener(){
    var grid=document.getElementById('student-tile-grid');
    if(!grid)return;
    
    grid.addEventListener('click',function(e){
      if(e.target.classList.contains('unlock-btn')){
        var tile=e.target.closest('.student-tile');
        var studentEmail=tile.dataset.email;
        var pollId=CURRENT_POLL_DATA.pollId;
        
        if(!studentEmail||!pollId){alert("Error unlocking");return;}
        
        e.target.disabled=true;
        e.target.textContent="Unlocking...";
        google.script.run
          .withSuccessHandler(pollForResults)
          .withFailureHandler(handleError)
          .unlockStudent(studentEmail,pollId);
      }
    });
  }

  // --- Student Link Controls ---
  function onSendLink(){
    var btn=document.getElementById('send-link-btn');
    var className=btn.dataset.className;
    if(!className){alert('Please select a poll first.');return;}
    if(!confirm('This will email a new, unique poll link to all students in '+className+'. Are you sure?'))return;
    
    btn.disabled=true;
    btn.innerHTML='<div class="loader" style="width: 20px; height: 20px; border-width: 2px; margin: 0 auto;"></div>';
    
    google.script.run
      .withSuccessHandler(function(response){
        alert('‚úÖ Successfully sent '+response.count+' poll links.');
        btn.disabled=false;
        btn.innerHTML='‚úâÔ∏è Send Student Links';
      })
      .withFailureHandler(function(err){
        handleError(err);
        btn.disabled=false;
        btn.innerHTML='‚úâÔ∏è Send Student Links';
      })
      .sendPollLinkToClass(className);
  }
  
  function onViewLinks(){
    var btn=document.getElementById('view-links-btn');
    var className=btn.dataset.className;
    if(!className){alert('Please select a poll first.');return;}
    btn.disabled=true;
    
    google.script.run
      .withSuccessHandler(function(response){
        if(!response.success)return handleError(new Error('Could not load links'));
        
        var container=document.getElementById('links-container');
        var html='<table style="width: 100%; border-collapse: collapse;">';
        html+='<thead><tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">';
        html+='<th style="padding: 12px; text-align: left;">Student Name</th>';
        html+='<th style="padding: 12px; text-align: left;">Email</th>';
        html+='<th style="padding: 12px; text-align: left;">Link</th>';
        html+='<th style="padding: 12px; text-align: center;">Actions</th>';
        html+='</tr></thead><tbody>';
        
        response.links.forEach(function(link){
          html+='<tr style="border-bottom: 1px solid #e9ecef;">';
          html+='<td style="padding: 10px;">'+escapeHtml(link.name)+'</td>';
          html+='<td style="padding: 10px;">'+escapeHtml(link.email)+'</td>';
          html+='<td style="padding: 10px; font-family: monospace; font-size: 0.9em; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="'+escapeHtml(link.url)+'">'+(link.hasActiveLink?escapeHtml(link.url):'<i>No active link</i>')+'</td>';
          html+='<td style="padding: 10px; text-align: center;">';
          if(link.hasActiveLink){
            html+='<button class="copy-link-btn" data-url="'+escapeHtml(link.url)+'" style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Copy</button>';
          }
          html+='</td></tr>';
        });
        
        html+='</tbody></table>';
        container.innerHTML=html;
        
        container.querySelectorAll('.copy-link-btn').forEach(function(btn){
          btn.onclick=function(){
            var url=this.dataset.url;
            try{
              // --- Fixed Clipboard Logic ---
              var tempInput=document.createElement('input');
              document.body.appendChild(tempInput);
              tempInput.value=url;
              tempInput.select();
              document.execCommand('copy');
              document.body.removeChild(tempInput);
              
              btn.textContent='‚úì Copied!';
              btn.style.background='#28a745';
              setTimeout(function(){
                btn.textContent='Copy';
                btn.style.background='#007bff';
              }, 2000);
            } catch(err) {
              alert('Could not copy link. Please copy it manually.');
            }
          };
        });
        
        linksModal.style.display='flex';
        btn.disabled=false;
      })
      .withFailureHandler(function(err){
        handleError(err);
        btn.disabled=false;
      })
      .getStudentLinksForClass(className);
  }
  
  function closeLinksModal(){
    linksModal.style.display='none';
  }
  
  // --- Google Chart ---
  function drawChart(resultsData,correctAnswer){
    if(!resultsData||Object.keys(resultsData).length===0){
      document.getElementById('chart-div').innerHTML='<p style="text-align: center; color: #6c757d; padding-top: 50px;">Waiting for first response...</p>';
      return;
    }
    
    var dataArray=[['Answer','Count',{role:'style'}]];
    var colors=[];
    var defaultColor='#007bff';
    var correctColor='#28a745';
    
    Object.keys(resultsData).forEach(function(key){
      var count=resultsData[key];
      var color=defaultColor;
      if(key===correctAnswer){
        color=correctColor;
      }
      dataArray.push([key,count,color]);
      colors.push(color);
    });
    
    var data=google.visualization.arrayToDataTable(dataArray);
    var options={
      chartArea:{width:'80%',height:'75%'},
      hAxis:{title:'Students',minValue:0,textStyle:{color:'#6c757d'},gridlines:{color:'#e9ecef'}},
      vAxis:{title:'Answer Choice',textStyle:{color:'#212529',fontSize:12,bold:true},gridlines:{color:'transparent'}},
      legend:{position:'none'},
      animation:{startup:true,duration:500,easing:'out',},
      bar:{groupWidth:'75%'},
      colors:colors,
      tooltip:{textStyle:{color:'#212529'},showColorCode:true}
    };
    var chart=new google.visualization.BarChart(document.getElementById('chart-div'));
    chart.draw(data,options);
  }
  
  // --- Poll Creator Modal ---
  function openPollCreator(){
    questionCounter=0;
    document.getElementById('question-builder').innerHTML="";
    document.getElementById('new-poll-name').value="";
    document.getElementById('class-select').value="";
    addQuestionToBuilder();
    modal.style.display='flex';
  }
  
  function closePollCreator(){
    modal.style.display='none';
    document.getElementById('question-builder').innerHTML="";
    questionCounter=0;
  }
  
  function addQuestionToBuilder(){
    var questionIndex=questionCounter++;
    var builder=document.getElementById('question-builder');
    var qDiv=document.createElement('div');
    qDiv.className='question-builder-item';
    qDiv.dataset.index=questionIndex;
    qDiv.id='question-'+questionIndex;
    
    var html='';
    html+='<h3>';
    html+='Question '+(questionIndex+1);
    if(questionIndex>0){
      html+='<button type="button" class="delete-question-btn" onclick="window.deleteQuestion('+questionIndex+')">Delete</button>';
    }
    html+='</h3>';
    html+='<div class="form-group">';
    html+='<label>Question Text (optional)</label>';
    html+='<textarea class="q-text" rows="3" placeholder="Enter your question here..."></textarea>';
    html+='</div>';
    html+='<div class="form-group">';
    html+='<label>Question Image (optional)</label>';
    html+='<input type="file" class="q-image" accept="image/*" onchange="window.previewQuestionImage(this, '+questionIndex+')">';
    html+='<img src="" class="image-preview" id="q-img-preview-'+questionIndex+'" style="display: none; margin-top: 12px;">';
    html+='</div>';
    html+='<div class="form-group">';
    html+='<label>Answer Choices</label>';
    html+='<div class="answer-choices-container" id="q-answers-'+questionIndex+'"></div>';
    html+='<button type="button" class="add-answer-btn" onclick="window.addAnswerToQuestion('+questionIndex+')">+ Add Answer</button>';
    html+='</div>';
    html+='<div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin-top: 16px;">';
    html+='<p style="margin: 0; font-size: 0.9em; color: #0c5460;">üí° <strong>Tip:</strong> Select the radio button next to the correct answer</p>';
    html+='</div>';
    
    qDiv.innerHTML=html;
    builder.appendChild(qDiv);
    
    window.addAnswerToQuestion(questionIndex);
    window.addAnswerToQuestion(questionIndex);
  }
  
  window.deleteQuestion=function(questionIndex){
    var qDiv=document.getElementById('question-'+questionIndex);
    if(qDiv){
      qDiv.remove();
      renumberQuestions();
    }
  };
  
  function renumberQuestions(){
    var questions=document.getElementById('question-builder').querySelectorAll('.question-builder-item');
    questions.forEach(function(q,index){
      var h3=q.querySelector('h3');
      var deleteBtn=h3.querySelector('.delete-question-btn');
      if(deleteBtn){
        h3.innerHTML='Question '+(index+1)+' ';
        h3.appendChild(deleteBtn);
      } else {
        h3.textContent='Question '+(index+1);
      }
    });
  }
  
  window.addAnswerToQuestion=function(questionIndex){
    var container=document.getElementById('q-answers-'+questionIndex);
    if(!container)return;
    var answerIndex=container.children.length;
    var aDiv=document.createElement('div');
    aDiv.className='answer-builder-item';
    aDiv.dataset.index=answerIndex;
    aDiv.id='q'+questionIndex+'-answer-'+answerIndex;
    
    var html='';
    html+='<input type="radio" name="correct-answer-q'+questionIndex+'" class="a-correct" value="'+answerIndex+'" title="Mark as correct answer">';
    html+='<input type="text" class="a-text" placeholder="Answer text (required)" style="flex-grow: 1;">';
    html+='<input type="file" class="a-image" accept="image/*" onchange="window.previewAnswerImage(this, '+questionIndex+', '+answerIndex+')" style="width: auto;">';
    if(answerIndex>=2){
      html+='<button type="button" class="delete-answer-btn" onclick="window.deleteAnswer('+questionIndex+', '+answerIndex+')">‚ùå</button>';
    } else {
      html+='<span style="width: 32px;"></span>'; // Placeholder for alignment
    }
    html+='<img src="" class="image-preview" id="q'+questionIndex+'-a'+answerIndex+'-preview" style="display: none;">';
    
    aDiv.innerHTML=html;
    container.appendChild(aDiv);
  };
  
  window.deleteAnswer=function(questionIndex,answerIndex){
    var aDiv=document.getElementById('q'+questionIndex+'-answer-'+answerIndex);
    if(aDiv){
      var container=document.getElementById('q-answers-'+questionIndex);
      if(container.children.length>2){
        aDiv.remove();
      } else {
        alert('Questions must have at least 2 answer choices.');
      }
    }
  };
  
  window.previewQuestionImage=function(input,questionIndex){
    var preview=document.getElementById('q-img-preview-'+questionIndex);
    if(!preview)return;
    if(input.files&&input.files[0]){
      var file=input.files[0];
      if(file.size>5*1024*1024){
        alert('File is too large. Maximum size is 5MB.');
        input.value='';
        return;
      }
      var reader=new FileReader();
      reader.onload=function(e){
        preview.src=e.target.result;
        preview.style.display='block';
      };
      reader.readAsDataURL(file);
    } else {
      preview.src="";
      preview.style.display='none';
    }
  };
  
  window.previewAnswerImage=function(input,questionIndex,answerIndex){
    var preview=document.getElementById('q'+questionIndex+'-a'+answerIndex+'-preview');
    if(!preview)return;
    if(input.files&&input.files[0]){
      var file=input.files[0];
      if(file.size>5*1024*1024){
        alert('File is too large. Maximum size is 5MB.');
        input.value='';
        return;
      }
      var reader=new FileReader();
      reader.onload=function(e){
        preview.src=e.target.result;
        preview.style.display='block';
      };
      reader.readAsDataURL(file);
    } else {
      preview.src="";
      preview.style.display='none';
    }
  };

  // --- Poll & Image Uploader ---
  function savePoll(){
    var savePollBtn=document.getElementById('save-poll-btn');
    savePollBtn.disabled=true;
    savePollBtn.textContent='Saving...';
    
    var pollName=document.getElementById('new-poll-name').value.trim();
    var className=document.getElementById('class-select').value;
    
    if(!pollName||!className){
      alert("Please enter a poll name and select a class.");
      savePollBtn.disabled=false;
      savePollBtn.textContent='üíæ Save Poll';
      return;
    }
    
    var questions=[];
    var questionItems=document.getElementById('question-builder').querySelectorAll('.question-builder-item');
    var uploadTasks=[];
    
    if(questionItems.length===0){
      alert("Please add at least one question.");
      savePollBtn.disabled=false;
      savePollBtn.textContent='üíæ Save Poll';
      return;
    }
    
    for(var qi=0;qi<questionItems.length;qi++){
      var item=questionItems[qi];
      var qText=item.querySelector('.q-text').value.trim();
      var qImageInput=item.querySelector('.q-image');
      
      var questionData={
        questionText:qText,
        questionImageURL:null,
        options:[],
        correctAnswer:null
      };
      
      if(qImageInput.files&&qImageInput.files[0]){
        (function(qData){
          uploadTasks.push(uploadFile(qImageInput.files[0]).then(function(url){
            qData.questionImageURL=url;
          }));
        })(questionData);
      }
      
      var correctRadio=item.querySelector('.a-correct:checked');
      var correctIndex=correctRadio?parseInt(correctRadio.value):-1;
      var answerItems=item.querySelectorAll('.answer-builder-item');
      var validAnswerCount=0;
      
      for(var ai=0;ai<answerItems.length;ai++){
        var aItem=answerItems[ai];
        var aText=aItem.querySelector('.a-text').value.trim();
        var aImageInput=aItem.querySelector('.a-image');
        
        if(!aText&&!(aImageInput.files&&aImageInput.files[0])){
          continue; // Skip empty answer
        }
        
        var optionData={text:aText,imageURL:null};
        
        if(aImageInput.files&&aImageInput.files[0]){
          (function(oData){
            uploadTasks.push(uploadFile(aImageInput.files[0]).then(function(url){
              oData.imageURL=url;
            }));
          })(optionData);
        }
        
        if(ai===correctIndex){
          questionData.correctAnswer=aText;
        }
        questionData.options.push(optionData);
        validAnswerCount++;
      }
      
      if(validAnswerCount<2){
        alert("Question "+(qi+1)+" must have at least 2 answer choices.");
        savePollBtn.disabled=false;
        savePollBtn.textContent='üíæ Save Poll';
        return;
      }
      
      if(!questionData.correctAnswer&&validAnswerCount>0){
        var result=confirm("Question "+(qi+1)+" doesn't have a correct answer selected. Continue anyway?");
        if(!result){
          savePollBtn.disabled=false;
          savePollBtn.textContent='üíæ Save Poll';
          return;
        }
      }
      questions.push(questionData);
    }
    
    Promise.all(uploadTasks).then(function(){
      google.script.run
        .withSuccessHandler(function(newPollsList){
          ALL_POLLS=newPollsList;
          updatePollDropdown();
          savePollBtn.disabled=false;
          savePollBtn.textContent='üíæ Save Poll';
          closePollCreator();
          alert('‚úÖ Poll created successfully with '+questions.length+' questions!');
        })
        .withFailureHandler(function(error){
          handleError(error);
          savePollBtn.disabled=false;
          savePollBtn.textContent='üíæ Save Poll';
        })
        .createNewPoll(pollName,className,questions);
    }).catch(function(err){
      alert('‚ùå Upload error: '+err.message);
      savePollBtn.disabled=false;
      savePollBtn.textContent='üíæ Save Poll';
    });
  }
  
  function fileToBase64(file){
    return new Promise(function(resolve,reject){
      var reader=new FileReader();
      reader.readAsDataURL(file);
      reader.onload=function(){
        resolve(reader.result);
      };
      reader.onerror=function(error){
        reject(error);
      };
    });
  }
  
  function uploadFile(file){
    return new Promise(function(resolve,reject){
      fileToBase64(file).then(function(dataUrl){
        google.script.run
          .withSuccessHandler(function(response){
            if(response.success){
              resolve(response.url);
            } else {
              reject(new Error(response.error||'Upload failed'));
            }
          })
          .withFailureHandler(reject)
          .uploadImageToDrive(dataUrl,file.name);
      }).catch(reject);
    });
  }

  // --- Utilities ---
  function escapeHtml(text){
    if(!text)return'';
    var div=document.createElement('div');
    div.textContent=text;
    return div.innerHTML;
  }
  
  function handleError(error){
    mainLoader.style.display='none';
    console.error('Error:',error);
    alert('Error: '+(error.message||error));
    var buttons=document.querySelectorAll('button');
    buttons.forEach(function(btn){btn.disabled=false;});
  }
  
  console.log('‚úì Teacher Panel Ready');
})();
  </script>
</body>
</html>

