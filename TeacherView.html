<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veritas Live Poll - Teacher Dashboard</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#002d6b",
            "veritas-navy": "#12385d",
            "veritas-gold": "#c5a05a",
            "brand-white": "#ffffff",
            "brand-light-gray": "#d9e0e7",
            "brand-dark-gray": "#242424",
            "background-light": "#f7f8fa",
            "background-dark": "#0f1723"
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
            serif: ["Noto Serif", "serif"]
          },
          borderRadius: {
            DEFAULT: "0.25rem",
            lg: "0.5rem",
            xl: "0.75rem",
            full: "9999px"
          },
          animation: {
            'fade-up': 'fadeUp 0.4s ease-out forwards',
            'pulse-glow': 'pulseGlow 3s ease-in-out infinite',
            'shimmer': 'shimmer 2s linear infinite'
          },
          keyframes: {
            fadeUp: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            },
            pulseGlow: {
              '0%, 100%': { boxShadow: '0 0 0 0 rgba(197, 160, 90, 0.4)' },
              '50%': { boxShadow: '0 0 20px 4px rgba(197, 160, 90, 0.4)' }
            },
            shimmer: {
              '0%': { backgroundPosition: '-1000px 0' },
              '100%': { backgroundPosition: '1000px 0' }
            }
          }
        }
      }
    };
  </script>

  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style type="text/tailwindcss">
    @layer utilities {
      .correct-answer-bg {
        background-image: repeating-linear-gradient(
          45deg,
          rgba(217, 224, 231, 0.7),
          rgba(217, 224, 231, 0.7) 10px,
          rgba(217, 224, 231, 1) 10px,
          rgba(217, 224, 231, 1) 20px
        );
      }
      .dark .correct-answer-bg {
        background-image: repeating-linear-gradient(
          45deg,
          rgba(0, 46, 109, 0.2),
          rgba(0, 46, 109, 0.2) 10px,
          rgba(0, 46, 109, 0.3) 10px,
          rgba(0, 46, 109, 0.3) 20px
        );
      }
    }
  </style>
  <style>
    .teacher-question-image {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(18, 56, 93, 0.06);
      border: 1px solid rgba(18, 56, 93, 0.12);
    }

    .teacher-question-image-el {
      width: 100%;
      max-height: 360px;
      object-fit: contain;
      display: block;
      background: #ffffff;
    }

    .teacher-question-image-zoom {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(18, 24, 40, 0.45);
      color: #ffffff;
      opacity: 0;
      transition: opacity 180ms ease;
      border: none;
      cursor: pointer;
    }

    .teacher-question-image:hover .teacher-question-image-zoom,
    .teacher-question-image-zoom:focus-visible {
      opacity: 1;
    }

    .teacher-question-image-zoom:focus-visible {
      outline: 3px solid rgba(18, 56, 93, 0.45);
      outline-offset: 2px;
    }

    .teacher-result-card {
      position: relative;
      overflow: hidden;
      border-radius: 14px;
      border: 1px solid rgba(18, 56, 93, 0.14);
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(18, 56, 93, 0.08);
      margin-bottom: 16px;
    }

    .teacher-result-card:last-child {
      margin-bottom: 0;
    }

    .teacher-result-progress {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0%;
      background: rgba(18, 56, 93, 0.12);
      transition: width 220ms ease;
    }

    .teacher-result-progress.is-correct {
      background: rgba(46, 125, 50, 0.2);
    }

    .teacher-result-content-row {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: stretch;
      gap: 16px;
      padding: 18px 20px;
    }

    .teacher-result-leading {
      display: flex;
      align-items: center;
    }

    .teacher-result-letter {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: rgba(18, 56, 93, 0.12);
      color: #12385d;
      font-weight: 700;
      font-size: 1.05rem;
    }

    .teacher-result-body {
      flex: 1;
      display: flex;
      gap: 16px;
      align-items: flex-start;
      min-width: 0;
    }

    .teacher-result-image-wrap {
      width: 110px;
      max-width: 110px;
      flex-shrink: 0;
    }

    .teacher-result-image {
      width: 100%;
      max-height: 110px;
      object-fit: contain;
      border-radius: 10px;
      border: 1px solid rgba(18, 56, 93, 0.18);
      background: #f8fafc;
    }

    .teacher-result-text {
      color: #12385d;
      font-size: 0.98rem;
      line-height: 1.55;
    }

    .teacher-result-text--empty {
      font-style: italic;
      color: #6b7280;
    }

    .teacher-result-percentage {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
      gap: 4px;
      min-width: 90px;
      color: #12385d;
      font-weight: 700;
    }

    .teacher-result-percentage span:first-child {
      font-size: 1.05rem;
    }

    .teacher-result-count {
      font-size: 0.8rem;
      font-weight: 500;
      color: #4b5563;
    }

    .teacher-result-students {
      position: relative;
      z-index: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px 20px 18px;
      border-top: 1px solid rgba(18, 56, 93, 0.12);
      background: rgba(18, 56, 93, 0.06);
    }

    .teacher-result-student {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(18, 56, 93, 0.15);
      color: #12385d;
    }

    .teacher-result-card.is-correct {
      border-color: rgba(46, 125, 50, 0.4);
      background: #edf7f0;
    }

    .teacher-result-card.is-correct .teacher-result-letter {
      background: rgba(46, 125, 50, 0.22);
      color: #1b5e20;
    }

    .teacher-result-card.is-correct .teacher-result-text {
      color: #1b5e20;
    }

    .teacher-result-card.is-correct .teacher-result-count {
      color: #2f855a;
    }

    .teacher-result-card.is-correct .teacher-result-students {
      border-color: rgba(46, 125, 50, 0.28);
      background: rgba(46, 125, 50, 0.16);
    }

    .teacher-result-card.is-correct .teacher-result-student {
      background: rgba(46, 125, 50, 0.2);
      color: #1b5e20;
    }

    .dark .teacher-question-image {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.18);
    }

    .dark .teacher-question-image-el {
      background: transparent;
    }

    .dark .teacher-question-image-zoom {
      background: rgba(15, 23, 42, 0.65);
    }

    .dark .teacher-result-card {
      background: rgba(15, 23, 35, 0.78);
      border-color: rgba(148, 163, 184, 0.28);
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.4);
    }

    .dark .teacher-result-progress {
      background: rgba(59, 130, 246, 0.28);
    }

    .dark .teacher-result-letter {
      background: rgba(148, 163, 184, 0.25);
      color: #e2e8f0;
    }

    .dark .teacher-result-text {
      color: #f8fafc;
    }

    .dark .teacher-result-count {
      color: #cbd5f5;
    }

    .dark .teacher-result-students {
      border-color: rgba(148, 163, 184, 0.25);
      background: rgba(148, 163, 184, 0.16);
    }

    .dark .teacher-result-student {
      background: rgba(148, 163, 184, 0.3);
      color: #f8fafc;
    }

    .dark .teacher-result-card.is-correct {
      background: rgba(34, 197, 94, 0.22);
      border-color: rgba(34, 197, 94, 0.45);
    }

    .dark .teacher-result-card.is-correct .teacher-result-letter {
      background: rgba(34, 197, 94, 0.32);
      color: #ecfdf5;
    }

    .dark .teacher-result-card.is-correct .teacher-result-text {
      color: #ecfdf5;
    }

    .dark .teacher-result-card.is-correct .teacher-result-count {
      color: #bbf7d0;
    }

    .dark .teacher-result-card.is-correct .teacher-result-students {
      border-color: rgba(34, 197, 94, 0.45);
      background: rgba(34, 197, 94, 0.3);
    }

    .dark .teacher-result-card.is-correct .teacher-result-student {
      background: rgba(34, 197, 94, 0.4);
      color: #052e16;
    }

    @media (max-width: 768px) {
      .teacher-result-content-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .teacher-result-percentage {
        flex-direction: row;
        align-items: center;
        gap: 8px;
      }

      .teacher-result-image-wrap {
        width: 100%;
        max-width: 100%;
      }

      .teacher-result-image {
        max-height: 220px;
      }
    }

    .veritas-modal-root {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .veritas-modal-root.is-active {
      display: flex;
    }

    .veritas-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(9, 17, 34, 0.55);
      backdrop-filter: blur(3px);
    }

    .veritas-modal-dialog {
      position: relative;
      z-index: 1;
      width: min(520px, 92vw);
      border-radius: 16px;
      background: #ffffff;
      border-top: 4px solid #c5a05a;
      box-shadow: 0 24px 48px rgba(9, 17, 34, 0.25);
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      animation: veritas-modal-in 220ms ease;
    }

    .veritas-modal-header h2 {
      margin: 0;
      font-size: 1.25rem;
      color: #12385d;
      font-weight: 700;
    }

    .veritas-modal-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
      color: #1c1c1c;
      font-size: 0.98rem;
      line-height: 1.55;
    }

    .veritas-modal-subtext {
      color: #4b5563;
      font-size: 0.85rem;
    }

    .veritas-modal-input {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .veritas-modal-input input {
      border-radius: 10px;
      border: 1px solid rgba(18, 56, 93, 0.28);
      padding: 10px 12px;
      font-size: 0.95rem;
      transition: border-color 160ms ease, box-shadow 160ms ease;
    }

    .veritas-modal-input input:focus-visible {
      outline: none;
      border-color: #12385d;
      box-shadow: 0 0 0 3px rgba(18, 56, 93, 0.2);
    }

    .veritas-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }

    .veritas-modal-button {
      border: none;
      border-radius: 999px;
      padding: 10px 22px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 140ms ease, box-shadow 140ms ease, background-color 140ms ease, color 140ms ease;
    }

    .veritas-modal-button.primary {
      background: #12385d;
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(18, 56, 93, 0.25);
    }

    .veritas-modal-button.primary:hover:not([disabled]) {
      background: #0f2d4a;
      transform: translateY(-1px);
    }

    .veritas-modal-button.secondary {
      background: transparent;
      color: #12385d;
      border: 1px solid rgba(18, 56, 93, 0.3);
    }

    .veritas-modal-button.secondary:hover:not([disabled]) {
      background: rgba(18, 56, 93, 0.08);
    }

    .veritas-modal-button.destructive {
      background: #c62828;
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(198, 40, 40, 0.25);
    }

    .veritas-modal-button.destructive:hover:not([disabled]) {
      background: #a61b1b;
    }

    .veritas-modal-button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .veritas-modal-spinner {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.6);
      border-top-color: transparent;
      animation: veritas-spin 0.7s linear infinite;
      display: none;
      margin-left: 10px;
    }

    .veritas-modal-button.loading .veritas-modal-spinner {
      display: inline-block;
    }

    .veritas-modal-button.loading span {
      opacity: 0.75;
    }

    .dark .veritas-modal-dialog {
      background: rgba(15, 23, 35, 0.96);
      color: #e2e8f0;
      border-top-color: #c5a05a;
      box-shadow: 0 24px 48px rgba(2, 6, 23, 0.55);
    }

    .dark .veritas-modal-header h2 {
      color: #f8fafc;
    }

    .dark .veritas-modal-body {
      color: #f1f5f9;
    }

    .dark .veritas-modal-subtext {
      color: #cbd5f5;
    }

    .dark .veritas-modal-input input {
      background: rgba(15, 23, 42, 0.7);
      border-color: rgba(148, 163, 184, 0.4);
      color: #f8fafc;
    }

    .dark .veritas-modal-input input:focus-visible {
      border-color: #93c5fd;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35);
    }

    .dark .veritas-modal-button.secondary {
      color: #e2e8f0;
      border-color: rgba(148, 163, 184, 0.4);
    }

    .dark .veritas-modal-button.secondary:hover:not([disabled]) {
      background: rgba(148, 163, 184, 0.16);
    }

    .dark .veritas-modal-button.primary {
      background: #234776;
    }

    .dark .veritas-modal-button.primary:hover:not([disabled]) {
      background: #1a3456;
    }

    .dark .veritas-modal-backdrop {
      background: rgba(2, 6, 23, 0.7);
      backdrop-filter: blur(4px);
    }

    body.veritas-modal-open {
      overflow: hidden;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @keyframes veritas-modal-in {
      from {
        opacity: 0;
        transform: translateY(16px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes veritas-spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 480px) {
      .veritas-modal-dialog {
        width: min(92vw, 360px);
        padding: 22px;
        gap: 16px;
      }

      .veritas-modal-actions {
        width: 100%;
        justify-content: stretch;
      }

      .veritas-modal-button {
        flex: 1;
      }
    }

    /* New Dashboard Styles */
    .dashboard-card {
      background: white;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 2px 8px rgba(18, 56, 93, 0.08);
      transition: all 200ms ease;
      animation: fadeUp 0.4s ease-out forwards;
      opacity: 0;
    }

    .dashboard-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(18, 56, 93, 0.12);
    }

    .dashboard-card.primary-cta {
      background: linear-gradient(135deg, #12385d 0%, #0f2d4a 100%);
      color: white;
      border-top: 4px solid #c5a05a;
      position: relative;
      overflow: hidden;
    }

    .dashboard-card.primary-cta::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, transparent, rgba(197, 160, 90, 0.3), transparent);
      animation: shimmer 3s linear infinite;
      pointer-events: none;
      z-index: 0;
    }

    .dashboard-card.primary-cta > * {
      position: relative;
      z-index: 1;
    }

    .dashboard-card-title {
      font-size: 20px;
      font-weight: 600;
      color: #12385d;
      margin-bottom: 8px;
    }

    .dashboard-card.primary-cta .dashboard-card-title {
      color: white;
    }

    .dashboard-card-subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 20px;
    }

    .dashboard-card.primary-cta .dashboard-card-subtitle {
      color: rgba(255, 255, 255, 0.8);
    }

    .dashboard-cta-button {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      border-radius: 9999px;
      font-weight: 600;
      font-size: 15px;
      transition: all 140ms ease;
      cursor: pointer;
      border: none;
    }

    .dashboard-cta-button:hover {
      transform: translateY(-1px);
    }

    .dashboard-cta-button.primary {
      background: #c5a05a;
      color: white;
      box-shadow: 0 4px 12px rgba(197, 160, 90, 0.3);
    }

    .dashboard-cta-button.primary:hover {
      background: #b8954f;
      box-shadow: 0 6px 16px rgba(197, 160, 90, 0.4);
    }

    .dashboard-cta-button.secondary {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .dashboard-cta-button.secondary:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .dashboard-list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid rgba(18, 56, 93, 0.08);
      transition: all 140ms ease;
    }

    .dashboard-list-item:last-child {
      border-bottom: none;
    }

    .dashboard-list-item:hover {
      padding-left: 8px;
    }

    .dashboard-stat-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 9999px;
      font-size: 13px;
      font-weight: 600;
    }

    .dashboard-stat-badge.success {
      background: rgba(34, 197, 94, 0.15);
      color: #16a34a;
    }

    .dashboard-stat-badge.warning {
      background: rgba(245, 158, 11, 0.15);
      color: #d97706;
    }

    .dashboard-stat-badge.neutral {
      background: rgba(18, 56, 93, 0.1);
      color: #12385d;
    }

    .dashboard-quick-tool {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 20px;
      background: rgba(18, 56, 93, 0.04);
      border-radius: 12px;
      transition: all 180ms ease;
      cursor: pointer;
      text-decoration: none;
      color: #12385d;
    }

    .dashboard-quick-tool:hover {
      background: rgba(18, 56, 93, 0.08);
      transform: translateY(-2px);
    }

    .dashboard-quick-tool .icon {
      font-size: 32px;
      transition: transform 180ms ease;
    }

    .dashboard-quick-tool:hover .icon {
      transform: rotate(15deg);
    }

    .dashboard-icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(18, 56, 93, 0.06);
      color: #12385d;
      transition: all 160ms ease;
      cursor: pointer;
      border: none;
    }

    .dashboard-icon-btn:hover {
      background: rgba(18, 56, 93, 0.12);
      transform: scale(1.05);
    }

    .dashboard-status-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      border-radius: 9999px;
      font-size: 13px;
      font-weight: 600;
      background: rgba(148, 163, 184, 0.15);
      color: #475569;
    }

    .dashboard-status-chip.active {
      background: rgba(34, 197, 94, 0.15);
      color: #16a34a;
    }

    .dashboard-status-chip .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .dashboard-status-chip.active .dot {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .activity-chart-placeholder {
      width: 100%;
      height: 180px;
      background: linear-gradient(to top, rgba(197, 160, 90, 0.1), rgba(18, 56, 93, 0.05));
      border-radius: 8px;
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      padding: 20px;
      gap: 8px;
    }

    .activity-bar {
      flex: 1;
      background: linear-gradient(to top, #c5a05a, #12385d);
      border-radius: 4px 4px 0 0;
      min-height: 20px;
      transition: all 300ms ease;
    }

    .activity-bar:hover {
      filter: brightness(1.2);
      transform: scaleY(1.05);
    }

    /* Stagger animation delays */
    .dashboard-card:nth-child(1) { animation-delay: 0ms; }
    .dashboard-card:nth-child(2) { animation-delay: 100ms; }
    .dashboard-card:nth-child(3) { animation-delay: 200ms; }
    .dashboard-card:nth-child(4) { animation-delay: 300ms; }

    @media (max-width: 768px) {
      .dashboard-card {
        padding: 20px;
      }
    }
  </style>
  </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-brand-dark-gray dark:text-brand-white">
  <div class="flex h-screen w-full flex-col">
    <!-- Header - Default State -->
    <header id="header-default" class="flex shrink-0 items-center justify-between whitespace-nowrap border-b border-solid border-veritas-navy/80 bg-veritas-navy px-6 py-4 shadow-md">
      <div class="flex items-center gap-6 flex-1">
        <div class="flex items-center gap-4">
          <img alt="Malvern Prep Logo" class="h-12 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png"/>
          <div class="flex flex-col">
            <h1 class="text-brand-white text-xl font-bold tracking-wide uppercase" style="letter-spacing: 0.15em;">Veritas</h1>
            <p class="text-brand-white/70 text-xs tracking-wide">Teacher Dashboard</p>
          </div>
        </div>

        <!-- Subheader Strip -->
        <div class="hidden md:flex items-center gap-6 ml-8">
          <div class="flex items-center gap-2 text-brand-white/80 text-sm">
            <span class="material-symbols-outlined text-lg">school</span>
            <select id="header-class-select" class="bg-veritas-navy/50 border border-brand-white/20 rounded-lg px-3 py-1.5 text-sm text-brand-white focus:outline-none focus:ring-2 focus:ring-veritas-gold">
              <option>All Classes</option>
              <option>AP Biology – Period 5</option>
              <option>Chemistry – Period 2</option>
            </select>
          </div>
          <div class="flex items-center gap-2 text-brand-white/70 text-sm">
            <span class="material-symbols-outlined text-lg">schedule</span>
            <span id="header-datetime"></span>
          </div>
          <div id="header-poll-status" class="dashboard-status-chip" style="background: rgba(148, 163, 184, 0.25); color: rgba(255, 255, 255, 0.9);">
            <span class="dot"></span>
            <span>No active session</span>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button class="dashboard-icon-btn" style="background: rgba(255, 255, 255, 0.1); color: white;" title="Settings" onclick="showRosterManager()">
          <span class="material-symbols-outlined text-xl">settings</span>
        </button>
        <button class="dashboard-icon-btn" style="background: rgba(255, 255, 255, 0.1); color: white;" title="Analytics" onclick="showAnalyticsView()">
          <span class="material-symbols-outlined text-xl">analytics</span>
        </button>
        <button class="dashboard-icon-btn" style="background: rgba(255, 255, 255, 0.1); color: white;" title="Notifications" onclick="void(0)">
          <span class="material-symbols-outlined text-xl">notifications</span>
        </button>
        <div id="loader" class="loader" style="display: block;">
          <div class="h-6 w-6 animate-spin rounded-full border-2 border-brand-white/80 border-t-transparent"></div>
        </div>
      </div>
    </header>

    <!-- Header - Live Poll State -->
    <header id="header-live" class="flex shrink-0 items-center justify-between whitespace-nowrap border-b border-solid border-primary/80 bg-primary px-6 py-3 shadow-sm" style="display: none;">
      <div class="flex items-center gap-4">
        <img alt="Malvern Prep Logo" class="h-10 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png"/>
        <div class="flex flex-col">
          <h1 id="header-poll-name" class="text-brand-white text-lg font-bold leading-tight tracking-[-0.015em]">Poll Name</h1>
          <p class="text-brand-white/80 text-sm">Live Poll</p>
        </div>
      </div>
      <div class="flex items-center gap-2 flex-wrap justify-between flex-1">
        <div class="flex items-center gap-2">
          <button id="header-start-btn" class="flex min-w-[80px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-brand-white text-primary text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-brand-light-gray transition-colors">
            <span class="material-symbols-outlined text-xl">play_arrow</span>
            <span class="truncate">Start</span>
          </button>
          <button id="header-end-show-btn" class="flex min-w-[80px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-green-600 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-green-700 transition-colors" style="display: none;" title="Close responses and reveal answer to students">
            <span class="material-symbols-outlined text-xl">check_circle</span>
            <span class="truncate">End & Reveal Answer</span>
          </button>
          <div class="mx-2 h-6 w-px bg-brand-white/30"></div>
          <button id="header-back-btn" class="flex min-w-[80px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-brand-white/30 transition-colors">
            <span class="material-symbols-outlined text-xl">skip_previous</span>
            <span class="truncate">Back</span>
          </button>
          <div id="question-dots" class="flex items-center gap-1.5 rounded-full bg-brand-white/20 px-3 py-1.5 text-sm font-medium text-brand-white">
            <!-- Question dots will be populated dynamically -->
          </div>
          <button id="header-next-btn" class="flex min-w-[80px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-brand-white/30 transition-colors">
            <span class="material-symbols-outlined text-xl">skip_next</span>
            <span class="truncate">Next</span>
          </button>
          <button id="header-reset-question-btn" class="flex min-w-[110px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-brand-white/30 transition-colors">
            <span class="material-symbols-outlined text-xl">replay</span>
            <span class="truncate">Reset Question</span>
          </button>
          <button id="header-skip-btn" class="flex min-w-[80px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-brand-white/30 transition-colors">
            <span class="material-symbols-outlined text-xl">fast_forward</span>
            <span class="truncate">Skip Question</span>
          </button>
        </div>
        <button id="header-stop-btn" class="flex min-w-[100px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-red-600 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:bg-red-700 transition-colors" title="End the entire session and finish the poll">
          <span class="material-symbols-outlined text-xl">stop</span>
          <span class="truncate">Finish Session</span>
        </button>
      </div>
    </header>

    <div class="flex flex-grow overflow-hidden">
      <!-- Main Content Area -->
      <main class="flex-1 overflow-y-auto">
        <!-- Dashboard View (Default) - Redesigned -->
        <div id="dashboard" class="p-8 max-w-7xl mx-auto">
          <!-- Dashboard Grid - 2x2 Layout -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">

            <!-- 1. Start/Manage Session (Primary CTA) -->
            <div class="dashboard-card primary-cta">
              <h2 class="dashboard-card-title text-2xl mb-2">Start / Manage Session</h2>
              <p class="dashboard-card-subtitle">Manage live participation and monitor student focus in real time.</p>

              <div class="form-group mb-5" style="position: relative; z-index: 1;">
                <label class="block text-sm font-medium mb-2 text-white/90" for="poll-select">Select Poll</label>
                <select id="poll-select" class="w-full rounded-lg border border-white/20 bg-white/10 text-white px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-veritas-gold backdrop-blur-sm">
                  <option value="" style="color: #111;">-- Choose a poll --</option>
                </select>
              </div>

              <div class="flex flex-wrap gap-3">
                <button id="start-poll-btn" class="dashboard-cta-button primary">
                  <span class="material-symbols-outlined text-xl">play_circle</span>
                  <span>Start New Poll</span>
                </button>
                <button class="dashboard-cta-button secondary" onclick="void(0)">
                  <span class="material-symbols-outlined text-xl">resume</span>
                  <span>Continue Session</span>
                </button>
              </div>

              <div class="mt-5 flex flex-wrap gap-2">
                <button id="send-link-btn" class="dashboard-cta-button secondary text-sm py-2 px-4" disabled style="opacity: 0.6;">
                  <span class="material-symbols-outlined text-lg">mail</span>
                  <span>Send Links</span>
                </button>
                <button id="view-links-btn" class="dashboard-cta-button secondary text-sm py-2 px-4" disabled style="opacity: 0.6;">
                  <span class="material-symbols-outlined text-lg">visibility</span>
                  <span>View Links</span>
                </button>
              </div>
            </div>

            <!-- 2. Recent Sessions Summary -->
            <div class="dashboard-card">
              <h2 class="dashboard-card-title">Recent Sessions</h2>
              <p class="dashboard-card-subtitle">Your last 5 live poll sessions</p>

              <div class="space-y-0">
                <div class="dashboard-list-item">
                  <div class="flex-1 min-w-0">
                    <p class="font-semibold text-sm text-veritas-navy">Unit 3 Assessment</p>
                    <p class="text-xs text-gray-500 mt-0.5">Nov 5, 2025 · AP Biology</p>
                  </div>
                  <div class="flex items-center gap-3">
                    <div class="dashboard-stat-badge success">
                      <span class="material-symbols-outlined text-sm">check_circle</span>
                      <span>92%</span>
                    </div>
                    <span class="text-xs text-gray-500">Avg 78%</span>
                  </div>
                </div>

                <div class="dashboard-list-item">
                  <div class="flex-1 min-w-0">
                    <p class="font-semibold text-sm text-veritas-navy">Enzyme Kinetics Quiz</p>
                    <p class="text-xs text-gray-500 mt-0.5">Nov 3, 2025 · Chemistry</p>
                  </div>
                  <div class="flex items-center gap-3">
                    <div class="dashboard-stat-badge warning">
                      <span class="material-symbols-outlined text-sm">warning</span>
                      <span>2 flags</span>
                    </div>
                    <span class="text-xs text-gray-500">Avg 65%</span>
                  </div>
                </div>

                <div class="dashboard-list-item">
                  <div class="flex-1 min-w-0">
                    <p class="font-semibold text-sm text-veritas-navy">Cell Division Review</p>
                    <p class="text-xs text-gray-500 mt-0.5">Oct 30, 2025 · AP Biology</p>
                  </div>
                  <div class="flex items-center gap-3">
                    <div class="dashboard-stat-badge success">
                      <span class="material-symbols-outlined text-sm">check_circle</span>
                      <span>88%</span>
                    </div>
                    <span class="text-xs text-gray-500">Avg 81%</span>
                  </div>
                </div>

                <div class="dashboard-list-item">
                  <div class="flex-1 min-w-0">
                    <p class="font-semibold text-sm text-veritas-navy">Periodic Table Challenge</p>
                    <p class="text-xs text-gray-500 mt-0.5">Oct 28, 2025 · Chemistry</p>
                  </div>
                  <div class="flex items-center gap-3">
                    <div class="dashboard-stat-badge neutral">
                      <span>85%</span>
                    </div>
                    <span class="text-xs text-gray-500">Avg 72%</span>
                  </div>
                </div>

                <div class="dashboard-list-item">
                  <div class="flex-1 min-w-0">
                    <p class="font-semibold text-sm text-veritas-navy">DNA Replication Pop Quiz</p>
                    <p class="text-xs text-gray-500 mt-0.5">Oct 25, 2025 · AP Biology</p>
                  </div>
                  <div class="flex items-center gap-3">
                    <div class="dashboard-stat-badge success">
                      <span>94%</span>
                    </div>
                    <span class="text-xs text-gray-500">Avg 85%</span>
                  </div>
                </div>
              </div>

              <button class="mt-4 text-veritas-navy text-sm font-semibold hover:text-veritas-gold transition-colors flex items-center gap-1" onclick="showAnalyticsView()">
                <span>View All</span>
                <span class="material-symbols-outlined text-lg">arrow_forward</span>
              </button>
            </div>

            <!-- 3. Student Activity Pulse -->
            <div class="dashboard-card">
              <h2 class="dashboard-card-title">Student Activity Pulse</h2>
              <p class="dashboard-card-subtitle">Total interactions over the last 7 days</p>

              <div class="activity-chart-placeholder">
                <div class="activity-bar" style="height: 45%;" title="Monday: 23 interactions"></div>
                <div class="activity-bar" style="height: 62%;" title="Tuesday: 31 interactions"></div>
                <div class="activity-bar" style="height: 38%;" title="Wednesday: 19 interactions"></div>
                <div class="activity-bar" style="height: 78%;" title="Thursday: 39 interactions"></div>
                <div class="activity-bar" style="height: 85%;" title="Friday: 42 interactions"></div>
                <div class="activity-bar" style="height: 28%;" title="Saturday: 14 interactions"></div>
                <div class="activity-bar" style="height: 52%;" title="Today: 26 interactions"></div>
              </div>

              <div class="mt-4 flex items-center justify-between">
                <p class="text-sm text-gray-600">
                  <span class="font-semibold text-veritas-gold">↑ 12%</span> compared to last week
                </p>
                <span class="text-xs text-gray-400 italic">Nicely done.</span>
              </div>

              <p class="mt-3 text-xs text-gray-400 italic">
                Correlation ≠ causation, but we'll take it.
              </p>
            </div>

            <!-- 4. Quick Access Tools -->
            <div class="dashboard-card">
              <h2 class="dashboard-card-title">Quick Access</h2>
              <p class="dashboard-card-subtitle">Common actions and shortcuts</p>

              <div class="grid grid-cols-2 gap-4 mt-4">
                <button class="dashboard-quick-tool" id="open-creator-btn">
                  <span class="material-symbols-outlined icon">add_circle</span>
                  <span class="text-sm font-semibold">Create Question Bank</span>
                </button>

                <button class="dashboard-quick-tool">
                  <span class="material-symbols-outlined icon">image</span>
                  <span class="text-sm font-semibold">Upload Image</span>
                </button>

                <button class="dashboard-quick-tool" onclick="showAnalyticsView()">
                  <span class="material-symbols-outlined icon">monitoring</span>
                  <span class="text-sm font-semibold">Review Student Trends</span>
                </button>

                <button class="dashboard-quick-tool" onclick="showRosterManager()">
                  <span class="material-symbols-outlined icon">settings</span>
                  <span class="text-sm font-semibold">Adjust Settings</span>
                </button>
              </div>
            </div>

          </div>

          <!-- Poll Library Section (Expandable) -->
          <div class="dashboard-card" style="animation-delay: 400ms;">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
              <div>
                <h2 class="text-2xl font-bold text-veritas-navy mb-1">Poll Library</h2>
                <p class="text-gray-600 text-sm">Sort, filter, edit, or delete any poll</p>
              </div>
              <div class="flex flex-wrap items-center gap-3">
                <label class="flex items-center gap-2 text-sm text-gray-600">
                  <span class="hidden sm:inline">Sort by</span>
                  <select id="poll-sort-select" class="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-veritas-gold">
                    <option value="updated_desc">Latest activity</option>
                    <option value="updated_asc">Oldest activity</option>
                    <option value="name_asc">Name A → Z</option>
                    <option value="class_asc">Class A → Z</option>
                  </select>
                </label>
                <label class="flex items-center gap-2 text-sm text-gray-600">
                  <span class="hidden sm:inline">Class</span>
                  <select id="poll-filter-select" class="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-veritas-gold">
                    <option value="all">All classes</option>
                  </select>
                </label>
              </div>
            </div>

            <div class="overflow-hidden rounded-lg border border-gray-200">
              <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50 text-gray-600">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold">Poll</th>
                    <th class="px-4 py-3 text-left font-semibold">Class</th>
                    <th class="px-4 py-3 text-left font-semibold">Questions</th>
                    <th class="px-4 py-3 text-left font-semibold">Last Edited</th>
                    <th class="px-4 py-3 text-right font-semibold">Actions</th>
                  </tr>
                </thead>
                <tbody id="polls-table-body" class="divide-y divide-gray-100 bg-white"></tbody>
              </table>
              <div id="polls-empty-state" class="p-6 text-center text-gray-500 hidden">
                <p>No polls found. Create your first poll to get started.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Live Poll View -->
        <div id="live-view" class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6" style="display: none;">
          <!-- Main Content (2/3) -->
          <div class="lg:col-span-2 flex flex-col gap-6">
            <!-- Question Display -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <div class="flex flex-col gap-4">
                <p id="live-question-info" class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm font-medium leading-normal">Question 1 of 10</p>
                <h2 id="live-question-text" class="font-serif text-brand-dark-gray dark:text-brand-white tracking-tight text-xl leading-snug">Question text appears here</h2>
                <div id="question-image-container" class="teacher-question-image" style="display: none;">
                  <img id="live-question-image" alt="Question" class="teacher-question-image-el" src="" referrerpolicy="no-referrer" onerror="this.style.display='none';"/>
                  <button class="teacher-question-image-zoom" type="button" onclick="window.expandQuestionImage()">
                    <span class="material-symbols-outlined">zoom_in</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Live Results -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <div class="flex justify-between items-center mb-6">
                <h3 class="text-brand-dark-gray dark:text-brand-white text-xl font-bold leading-normal">Live Results</h3>
                <div class="flex items-center gap-3">
                  <span class="material-symbols-outlined text-primary dark:text-brand-white">group</span>
                  <span id="response-count" class="text-brand-dark-gray dark:text-brand-white text-base font-medium">0 / 0 answered</span>
                </div>
              </div>
              <div id="results-bars" class="flex flex-col gap-3">
                <!-- Results bars will be populated dynamically -->
              </div>
              <div id="results-reveal-strip" class="mt-6 hidden">
                <div class="flex flex-wrap items-center justify-between gap-3 rounded-lg border border-green-600/20 bg-green-600/5 px-4 py-3 dark:border-green-500/20 dark:bg-green-500/5">
                  <div class="min-w-[200px]">
                    <p class="text-sm font-semibold text-green-700 dark:text-green-400">Answer revealed to students</p>
                    <p id="results-strip-status" class="text-xs text-green-700/70 dark:text-green-400/70">Students can now see the correct answer and results.</p>
                  </div>
                  <div class="flex flex-wrap items-center gap-2">
                    <button id="hide-results-btn" class="flex items-center gap-2 rounded-full bg-brand-light-gray/60 text-brand-dark-gray px-4 py-2 text-sm font-semibold tracking-[0.015em] transition-colors hover:bg-brand-light-gray disabled:cursor-not-allowed disabled:opacity-60 dark:bg-brand-white/10 dark:text-brand-white dark:hover:bg-brand-white/20" type="button">
                      <span class="material-symbols-outlined text-base">visibility_off</span>
                      <span>Hide Results</span>
                    </button>
                    <button id="strip-next-btn" class="flex items-center gap-2 rounded-full bg-primary text-brand-white px-4 py-2 text-sm font-semibold tracking-[0.015em] shadow-sm transition-colors hover:bg-primary/90 dark:text-brand-white dark:bg-primary dark:hover:bg-primary/90" type="button">
                      <span class="material-symbols-outlined text-base">skip_next</span>
                      <span>Next Question</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sidebar (1/3) -->
          <aside class="lg:col-span-1 flex flex-col gap-6">
            <!-- Timer -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
              <h3 class="text-brand-dark-gray dark:text-brand-white text-lg font-bold leading-normal mb-4 text-center">Question Timer</h3>

              <!-- Compact Timer Bar -->
              <div class="timer-bar" role="toolbar" aria-label="Question timer controls">
                <!-- Timer Chip -->
                <div class="timer-chip" aria-live="polite">
                  <div id="live-timer-display" class="time">01:30</div>
                  <div id="timer-state-label" class="state">Paused</div>
                </div>

                <!-- Preset Controls -->
                <div class="preset">
                  <button id="timer-decrease-btn" class="btn btn-ghost" data-act="dec" aria-label="Decrease preset" type="button">–</button>
                  <span id="timer-preset-display" class="preset-val">90s</span>
                  <button id="timer-increase-btn" class="btn btn-ghost" data-act="inc" aria-label="Increase preset" type="button">+</button>
                </div>

                <!-- Start/Pause Toggle -->
                <button id="timer-start-btn" class="btn btn-primary" data-act="toggle" type="button">▶ Start</button>

                <!-- Reset Button -->
                <button id="timer-reset-btn" class="btn btn-icon" data-act="reset" aria-label="Reset timer" type="button">↺</button>
              </div>

              <p id="timer-status-message" class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 text-center mt-3">Timer idle.</p>
            </div>

            <style>
              .timer-bar{display:flex;align-items:center;gap:10px;height:44px;padding:6px 10px;background:#eff3f9;border-radius:10px;flex-wrap:wrap}
              .dark .timer-bar{background:rgba(255,255,255,0.05)}
              .timer-chip{display:flex;flex-direction:column;justify-content:center;align-items:center;min-width:92px;padding:2px 8px;border:1px solid #cbd5e1;border-radius:999px;background:#fff}
              .dark .timer-chip{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.2)}
              .timer-chip .time{font:600 20px/1 'Inter',Arial;color:#12385d}
              .dark .timer-chip .time{color:#f8fafc}
              .timer-chip .state{font:500 10px/1.2 Arial;color:#6b7280;margin-top:2px}
              .dark .timer-chip .state{color:#cbd5e1}
              .preset{display:flex;align-items:center;gap:8px;color:#555}
              .dark .preset{color:#cbd5e1}
              .preset-val{min-width:42px;text-align:center;font:600 13px/1 Arial}
              .btn{height:32px;padding:0 12px;border-radius:8px;border:1px solid transparent;font:600 13px/1 Arial;cursor:pointer;transition:all 140ms ease}
              .btn-primary{background:#12385d;color:#fff;border-color:#0f2f4d}
              .btn-primary:hover:not(:disabled){background:#0f2d4a;transform:translateY(-1px)}
              .btn-primary.gold{background:#c5a05a;border-color:#b08a4f;color:#111}
              .btn-primary.gold:hover:not(:disabled){background:#b08a4f}
              .btn-ghost{background:#fff;border-color:#cbd5e1;color:#12385d}
              .dark .btn-ghost{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.2);color:#f8fafc}
              .btn-ghost:hover:not(:disabled){background:#f3f4f6}
              .dark .btn-ghost:hover:not(:disabled){background:rgba(255,255,255,0.15)}
              .btn-icon{width:32px;height:32px;background:#fff;border:1px solid #cbd5e1;border-radius:8px;padding:0;font-size:18px}
              .dark .btn-icon{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.2);color:#f8fafc}
              .btn-icon:hover:not(:disabled){background:#f3f4f6}
              .dark .btn-icon:hover:not(:disabled){background:rgba(255,255,255,0.15)}
              .btn:disabled{opacity:0.5;cursor:not-allowed}
              .timer-bar:focus-within .timer-chip{box-shadow:0 0 0 2px rgba(18,56,93,.12)}
              .timer-bar.running .timer-chip .time{color:#12385d}
              .dark .timer-bar.running .timer-chip .time{color:#60a5fa}
              .timer-bar.paused .timer-chip .time{color:#c5a05a}
              .timer-bar.expired .timer-chip .time{color:#9a9a9a}
              @media (max-width:980px){.timer-bar{flex-wrap:wrap;gap:8px;height:auto}}
            </style>

            <!-- Student Status -->
            <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm overflow-y-auto max-h-[600px]">
              <h3 class="text-brand-dark-gray dark:text-brand-white text-xl font-bold leading-normal mb-4">Student Status</h3>
              <div id="student-status-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2 gap-3">
                <!-- Student status tiles will be populated dynamically -->
              </div>
            </div>
          </aside>
        </div>

        <!-- Roster Manager View -->
        <div id="roster-manager" class="p-6 grid grid-cols-1 lg:grid-cols-4 gap-6" style="display: none;">
          <div class="lg:col-span-1 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-5 shadow-sm flex flex-col">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white">Classes</h2>
              <button id="add-class-btn" class="flex items-center justify-center h-9 w-9 rounded-full bg-primary text-brand-white hover:bg-primary/90 transition-colors" title="Add class">
                <span class="material-symbols-outlined text-base">add</span>
              </button>
            </div>
            <div id="roster-class-list" class="flex-1 overflow-y-auto space-y-2">
              <!-- Classes will render here -->
            </div>
          </div>
          <div class="lg:col-span-3 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
              <div>
                <h2 id="roster-class-title" class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">Select a class</h2>
                <p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm">Manage student names and emails for rostered classes.</p>
              </div>
              <div class="flex items-center gap-2">
                <button id="rename-class-btn" class="hidden h-9 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">Rename</button>
                <button id="delete-class-btn" class="hidden h-9 px-4 rounded-lg bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-sm font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors">Delete</button>
              </div>
            </div>
            <div id="roster-empty-state" class="border border-dashed border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-10 text-center text-brand-dark-gray/60 dark:text-brand-white/60">
              <p>Choose a class on the left to view its roster.</p>
            </div>
            <div id="roster-table-wrapper" class="hidden flex flex-col gap-4">
              <div class="overflow-x-auto border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg">
                <table class="min-w-full divide-y divide-brand-light-gray dark:divide-brand-dark-gray text-sm">
                  <thead class="bg-brand-light-gray/50 dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white">
                    <tr>
                      <th class="px-4 py-2 text-left font-semibold w-1/2">Student Name</th>
                      <th class="px-4 py-2 text-left font-semibold w-1/2">Email</th>
                      <th class="px-4 py-2 text-center font-semibold w-16">Remove</th>
                    </tr>
                  </thead>
                  <tbody id="roster-table-body" class="divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/50"></tbody>
                </table>
              </div>
              <div class="flex flex-wrap items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                  <button id="add-student-row-btn" class="h-10 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">+ Add Student</button>
                  <button id="bulk-add-students-btn" class="h-10 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">Bulk Add Students</button>
                  <span id="roster-status" class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60"></span>
                </div>
                <button id="save-roster-btn" class="h-10 px-5 rounded-lg bg-primary text-brand-white text-sm font-bold hover:bg-primary/90 transition-colors">Save Roster</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Archived Polls View -->
        <div id="archived-view" class="p-6 grid grid-cols-1 lg:grid-cols-4 gap-6" style="display: none;">
          <div class="lg:col-span-1 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-5 shadow-sm flex flex-col">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white">Archived Polls</h2>
              <button id="refresh-archived-btn" class="flex items-center justify-center h-9 w-9 rounded-full bg-primary text-brand-white hover:bg-primary/90 transition-colors" title="Refresh">
                <span class="material-symbols-outlined text-base">refresh</span>
              </button>
            </div>
            <label class="block text-xs font-semibold uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">Class Filter</label>
            <select id="archived-class-filter" class="mb-4 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
              <option value="all">All classes</option>
            </select>
            <div id="archived-list" class="flex-1 overflow-y-auto space-y-2">
              <!-- Archived polls list -->
            </div>
          </div>
          <div class="lg:col-span-3 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
            <div id="archived-empty-state" class="border border-dashed border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-10 text-center text-brand-dark-gray/60 dark:text-brand-white/60">
              <p>Select an archived poll to review student performance.</p>
            </div>
            <div id="archived-detail" class="hidden flex flex-col gap-6">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <div>
                  <h2 id="archived-poll-title" class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white"></h2>
                  <p id="archived-poll-meta" class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm"></p>
                </div>
                <div class="text-right text-sm text-brand-dark-gray/60 dark:text-brand-white/60">
                  <p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Questions:</span> <span id="archived-question-count"></span></p>
                  <p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Responses:</span> <span id="archived-response-count"></span></p>
                </div>
              </div>
              <div id="archived-questions-container" class="space-y-4">
                <!-- Question breakdowns will render here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Analytics Hub View -->
        <div id="analytics-view" class="p-6 flex flex-col gap-6" style="display: none;">
          <!-- Filter Bar -->
          <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-4 shadow-sm">
            <div class="flex flex-wrap items-center gap-3">
              <select id="analytics-class-filter" class="rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                <option value="all">All Classes</option>
              </select>
              <div class="flex items-center gap-2">
                <label class="text-xs font-semibold text-brand-dark-gray/60 dark:text-brand-white/60">From:</label>
                <input type="date" id="analytics-date-from" class="rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
              </div>
              <div class="flex items-center gap-2">
                <label class="text-xs font-semibold text-brand-dark-gray/60 dark:text-brand-white/60">To:</label>
                <input type="date" id="analytics-date-to" class="rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
              </div>
              <button id="analytics-apply-filters-btn" class="px-4 py-2 rounded-lg bg-primary text-brand-white hover:bg-primary/90 transition-colors text-sm font-semibold">
                Apply Filters
              </button>
              <button id="analytics-clear-filters-btn" class="px-4 py-2 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/50 transition-colors text-sm">
                Clear
              </button>
              <button id="analytics-refresh-btn" class="ml-auto flex items-center justify-center h-9 w-9 rounded-full bg-primary text-brand-white hover:bg-primary/90 transition-colors" title="Refresh">
                <span class="material-symbols-outlined text-base">refresh</span>
              </button>
            </div>
          </div>

          <!-- Tab Navigation -->
          <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 shadow-sm overflow-hidden">
            <div class="flex border-b border-brand-light-gray dark:border-brand-dark-gray/40">
              <button id="analytics-tab-overview" class="flex-1 px-6 py-3 font-semibold text-sm transition-colors analytics-tab bg-primary text-brand-white">
                Overview
              </button>
              <button id="analytics-tab-items" class="flex-1 px-6 py-3 font-semibold text-sm transition-colors analytics-tab text-brand-dark-gray/70 dark:text-brand-white/70 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30">
                Item Analysis
              </button>
              <button id="analytics-tab-students" class="flex-1 px-6 py-3 font-semibold text-sm transition-colors analytics-tab text-brand-dark-gray/70 dark:text-brand-white/70 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30">
                Student Trends
              </button>
            </div>

            <!-- Overview Tab Content -->
            <div id="analytics-content-overview" class="p-6 analytics-tab-content">
              <div id="analytics-overview-loading" class="text-center py-12">
                <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Loading analytics...</p>
              </div>
              <div id="analytics-overview-content" class="hidden">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                  <div id="analytics-kpi-container"></div>
                </div>

                <!-- Topic Heat Strip -->
                <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5 mb-6">
                  <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Topic Mastery Over Time</h3>
                  <div id="analytics-topic-heat" class="overflow-x-auto">
                    <p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No topic data available</p>
                  </div>
                </div>

                <!-- Item Quality Scatter -->
                <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5">
                  <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Item Quality Map</h3>
                  <div id="analytics-item-scatter" style="height: 300px;">
                    <p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No item data available</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Item Analysis Tab Content -->
            <div id="analytics-content-items" class="p-6 analytics-tab-content hidden">
              <div id="analytics-items-loading" class="text-center py-12">
                <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Loading item analysis...</p>
              </div>
              <div id="analytics-items-content" class="hidden">
                <!-- Item Table -->
                <div class="overflow-x-auto">
                  <table id="analytics-items-table" class="min-w-full text-sm">
                    <thead class="sticky top-0 bg-brand-light-gray dark:bg-brand-dark-gray text-xs uppercase tracking-wide text-brand-dark-gray/80 dark:text-brand-white/70">
                      <tr>
                        <th class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80" data-sort="qNum">Q#</th>
                        <th class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80" data-sort="topic">Topic</th>
                        <th class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80" data-sort="correctPct">Correct%</th>
                        <th class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80" data-sort="rbis">Disc</th>
                        <th class="py-3 px-4 text-left">Choices</th>
                        <th class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80" data-sort="medianTimeSec">Time(s)</th>
                        <th class="py-3 px-4 text-left">Flags</th>
                      </tr>
                    </thead>
                    <tbody id="analytics-items-tbody" class="divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/40">
                      <!-- Items will be rendered here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Student Trends Tab Content -->
            <div id="analytics-content-students" class="p-6 analytics-tab-content hidden">
              <div id="analytics-students-loading" class="text-center py-12">
                <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Loading student data...</p>
              </div>
              <div id="analytics-students-content" class="hidden">
                <!-- Student Search -->
                <div class="mb-6">
                  <input type="text" id="analytics-student-search" placeholder="Search for a student..." class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
                  <div id="analytics-student-suggestions" class="hidden mt-2 bg-brand-white dark:bg-brand-dark-gray/40 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 shadow-lg max-h-60 overflow-y-auto">
                    <!-- Search suggestions -->
                  </div>
                </div>

                <!-- Student Detail -->
                <div id="analytics-student-detail" class="hidden">
                  <div id="analytics-student-summary" class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5 mb-6">
                    <!-- Student summary card -->
                  </div>
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5">
                      <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Consistency Trend</h3>
                      <div id="analytics-student-sparkline"></div>
                    </div>
                    <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5">
                      <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Topic Mastery</h3>
                      <div id="analytics-student-topics"></div>
                    </div>
                  </div>
                </div>

                <div id="analytics-student-empty" class="text-center py-12 text-brand-dark-gray/60 dark:text-brand-white/60">
                  <p>Search for a student to view their analytics</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Right Sidebar Navigation -->
      <aside class="w-64 bg-primary flex-col items-center p-4 border-l border-primary/20 hidden lg:flex">
        <nav class="flex flex-col w-full gap-2">
          <button id="nav-polls-list" class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-brand-white/10 text-brand-white hover:bg-brand-white/20 font-semibold transition-colors text-left">
            <span class="material-symbols-outlined">monitoring</span>
            <span>Live Dashboard</span>
          </button>
          <button id="nav-create-poll" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-brand-white/70 hover:bg-brand-white/20 hover:text-brand-white transition-colors text-left">
            <span class="material-symbols-outlined">add_circle</span>
            <span>Create New Poll</span>
          </button>
          <button id="nav-rosters" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-brand-white/70 hover:bg-brand-white/20 hover:text-brand-white transition-colors text-left">
            <span class="material-symbols-outlined">group</span>
            <span>Classes &amp; Rosters</span>
          </button>
          <button id="nav-archived" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-brand-white/70 hover:bg-brand-white/20 hover:text-brand-white transition-colors text-left">
            <span class="material-symbols-outlined">inventory_2</span>
            <span>Archived Polls</span>
          </button>
          <button id="nav-analytics" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-brand-white/70 hover:bg-brand-white/20 hover:text-brand-white transition-colors text-left">
            <span class="material-symbols-outlined">analytics</span>
            <span>Analytics Hub</span>
          </button>
        </nav>
      </aside>
    </div>
  </div>

  <!-- Poll Creator Modal -->
  <div id="poll-creator-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/20 z-10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img alt="Malvern Prep Logo" class="h-8 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png"/>
          <input type="text" id="new-poll-name" placeholder="Chapter 5 Quiz" class="bg-transparent text-brand-white text-xl font-bold border-none focus:ring-0 p-0 placeholder-brand-white/70 min-w-[300px]"/>
        </div>
        <div class="flex items-center gap-2">
          <span id="save-status" class="text-sm text-brand-white/80 mr-2">All changes saved</span>
          <button id="close-modal-btn" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-white/30 transition-colors">
            <span class="truncate">Cancel</span>
          </button>
          <button id="save-poll-btn" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-white text-primary text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray transition-colors">
            <span class="truncate">Publish Poll</span>
          </button>
        </div>
      </div>

      <div class="flex flex-grow overflow-hidden">
        <!-- Question Navigator Sidebar -->
        <aside class="w-64 flex-shrink-0 border-r border-solid border-brand-light-gray dark:border-brand-dark-gray/20 bg-brand-white dark:bg-background-dark overflow-y-auto">
          <div class="flex h-full flex-col justify-between p-4">
            <div id="question-navigator" class="flex flex-col gap-2">
              <!-- Question items will be added dynamically -->
            </div>
            <button id="add-question-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary/20 dark:bg-primary/30 text-primary dark:text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/30 dark:hover:bg-primary/40 transition-colors mt-4">
              <span class="truncate">+ Add Question</span>
            </button>
          </div>
        </aside>

        <!-- Editing Workspace -->
        <main class="flex-1 p-8 overflow-y-auto">
          <div class="form-group mb-6">
            <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white" for="class-select">Class</label>
            <select id="class-select" class="w-full max-w-md rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
              <option value="">-- Select Class --</option>
            </select>
          </div>

          <div id="question-builder-workspace">
            <!-- Question editing workspace will be populated dynamically -->
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- Student Links Modal -->
  <div id="student-links-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/70">
        <h2 class="text-brand-white text-2xl font-bold">Student Personalized Links</h2>
        <p class="text-brand-white/80 text-sm mt-1">Each student has a unique tracking link.</p>
      </div>
      <div class="p-6">
        <div id="links-container" class="max-h-[60vh] overflow-y-auto"></div>
        <div class="mt-6 pt-4 border-t border-primary/20">
          <button id="close-links-modal-btn" class="flex items-center justify-center gap-2 rounded-lg h-10 px-6 bg-primary text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
            <span>Close</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Add Students Modal -->
  <div id="bulk-add-students-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/70">
        <h2 class="text-brand-white text-2xl font-bold">Bulk Add Students</h2>
        <p class="text-brand-white/80 text-sm mt-1">Add multiple students at once. Enter one student per line in format: Name, Email</p>
      </div>
      <div class="p-6 flex-1 overflow-y-auto">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Student Data</label>
          <textarea id="bulk-student-input" class="w-full h-64 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 font-mono" placeholder="John Smith, jsmith@school.edu&#10;Jane Doe, jdoe@school.edu&#10;Bob Johnson, bjohnson@school.edu"></textarea>
          <p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-2">Format: Name, Email (one per line). Duplicates will be skipped automatically.</p>
        </div>
      </div>
      <div class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-primary/20 flex justify-end gap-3">
        <button id="cancel-bulk-add-btn" class="h-10 px-5 rounded-lg bg-brand-dark-gray/10 dark:bg-brand-white/10 text-brand-dark-gray dark:text-brand-white text-sm font-semibold hover:bg-brand-dark-gray/20 dark:hover:bg-brand-white/20 transition-colors">Cancel</button>
        <button id="confirm-bulk-add-btn" class="h-10 px-5 rounded-lg bg-primary text-brand-white text-sm font-bold hover:bg-primary/90 transition-colors">Add Students</button>
      </div>
    </div>
  </div>

  <script>
(function(){
  // --- Main App State ---
  var mainLoader=document.getElementById('loader');
  var ALL_POLLS=[];
  var ALL_CLASSES=[];
  var CURRENT_POLL_DATA={};
  var currentStudentStatusData=[];
  var pollInterval=null;
  var visualTimerInterval=null;
  var isPaused=false;
  var isLiveSession=false;
  var questionCounter=0;
  var questions=[];
  var selectedQuestionIndex=0;
  var editingPollId=null;
  var isPollDirty=false;
  var pollSortMode='updated_desc';
  var pollClassFilter='all';
  var rosterData={};
  var selectedRosterClass='';
  var rosterDirty=false;
  var archivedPolls=[];
  var archivedClassFilter='all';
  var selectedArchivedPollId='';
  var BASE_CLASSES=[];

  // Update header datetime
  function updateHeaderDateTime() {
    var datetimeEl = document.getElementById('header-datetime');
    if (datetimeEl) {
      var now = new Date();
      var options = { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' };
      datetimeEl.textContent = now.toLocaleDateString('en-US', options);
    }
  }
  updateHeaderDateTime();
  setInterval(updateHeaderDateTime, 60000); // Update every minute

  var VeritasModal=null;
  var veritasModalReady=new Promise(function(resolve){
    function initializeModal(){
      VeritasModal=window.VeritasModal||createVeritasModal();
      window.VeritasModal=VeritasModal;
      resolve(VeritasModal);
    }

    if(document.readyState==='loading'){
      document.addEventListener('DOMContentLoaded',initializeModal,{once:true});
    }else{
      initializeModal();
    }
  });

  function withVeritasModal(callback){
    return veritasModalReady.then(function(controller){
      return callback(controller);
    });
  }

  function veritasAlert(message,options){
    return withVeritasModal(function(modal){
      return modal.alert(Object.assign({message:message},options||{}));
    });
  }

  function veritasConfirm(message,options){
    return withVeritasModal(function(modal){
      return modal.confirm(Object.assign({message:message},options||{}));
    });
  }

  function veritasPrompt(message,options){
    return withVeritasModal(function(modal){
      return modal.prompt(Object.assign({message:message},options||{}));
    });
  }

  function ensureVeritasModalRoot(){
    var existing=document.getElementById('veritas-modal-root');
    if(existing){
      return existing;
    }

    var root=document.createElement('div');
    root.id='veritas-modal-root';
    root.className='veritas-modal-root';
    root.setAttribute('aria-hidden','true');
    root.innerHTML=''+
      '<div class="veritas-modal-backdrop"></div>'+
      '<div class="veritas-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="veritas-modal-title" aria-describedby="veritas-modal-message">'+
        '<div class="veritas-modal-header">'+
          '<h2 id="veritas-modal-title">Notice</h2>'+
        '</div>'+
        '<div class="veritas-modal-body">'+
          '<p id="veritas-modal-message"></p>'+
          '<div id="veritas-modal-subtext" class="veritas-modal-subtext"></div>'+
          '<div id="veritas-modal-input" class="veritas-modal-input" style="display: none;">'+
            '<label for="veritas-modal-input-field" class="sr-only">Input</label>'+
            '<input id="veritas-modal-input-field" type="text" autocomplete="off" />'+
          '</div>'+
        '</div>'+
        '<div class="veritas-modal-actions">'+
          '<button type="button" class="veritas-modal-button secondary" data-action="cancel">Cancel</button>'+
          '<button type="button" class="veritas-modal-button primary" data-action="confirm">'+
            '<span class="veritas-modal-spinner" aria-hidden="true"></span>'+
            '<span>Confirm</span>'+
          '</button>'+
        '</div>'+
      '</div>';

    (document.body||document.documentElement).appendChild(root);
    return root;
  }

  function createVeritasModal(){
    var root=ensureVeritasModalRoot();

    var dialog=root.querySelector('.veritas-modal-dialog');
    var titleEl=root.querySelector('#veritas-modal-title');
    var messageEl=root.querySelector('#veritas-modal-message');
    var subtextEl=root.querySelector('#veritas-modal-subtext');
    var inputWrap=root.querySelector('#veritas-modal-input');
    var inputField=root.querySelector('#veritas-modal-input-field');
    var confirmBtn=root.querySelector('[data-action="confirm"]');
    var cancelBtn=root.querySelector('[data-action="cancel"]');
    var confirmLabel=confirmBtn.querySelector('span:not(.veritas-modal-spinner)');
    var active=false;
    var currentConfig=null;
    var resolveFn=null;
    var previousFocus=null;
    var allowEscape=true;
    var hiddenNodes=[];

    function toggleBackground(state){
      var siblings=[].slice.call(document.body.children);
      if(state){
        hiddenNodes=[];
        siblings.forEach(function(node){
          if(node===root)return;
          hiddenNodes.push({
            node:node,
            ariaHidden:node.getAttribute('aria-hidden'),
            inert:('inert' in node)?node.inert:null
          });
          node.setAttribute('aria-hidden','true');
          if('inert' in node){
            node.inert=true;
          }
        });
      } else {
        hiddenNodes.forEach(function(record){
          if(record.ariaHidden===null){
            record.node.removeAttribute('aria-hidden');
          } else {
            record.node.setAttribute('aria-hidden',record.ariaHidden);
          }
          if('inert' in record.node){
            if(record.inert!==null){
              record.node.inert=record.inert;
            } else {
              record.node.inert=false;
            }
          }
        });
        hiddenNodes=[];
      }
    }

    function setPending(state){
      if(state){
        confirmBtn.classList.add('loading');
        confirmBtn.setAttribute('disabled','disabled');
        if(cancelBtn.style.display!=='none'){
          cancelBtn.setAttribute('disabled','disabled');
        }
      } else {
        confirmBtn.classList.remove('loading');
        confirmBtn.removeAttribute('disabled');
        cancelBtn.removeAttribute('disabled');
      }
    }

    function getFocusable(){
      var selectors='button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
      var nodes=[].slice.call(dialog.querySelectorAll(selectors));
      return nodes.filter(function(node){
        return !node.hasAttribute('disabled')&&node.offsetParent!==null;
      });
    }

    function focusFirst(){
      var focusable=getFocusable();
      if(focusable.length>0){
        focusable[0].focus();
      } else {
        dialog.focus();
      }
    }

    function trapKey(event){
      if(!active)return;
      if(event.key==='Escape'){
        if(!allowEscape)return;
        event.preventDefault();
        handleCancel();
      } else if(event.key==='Tab'){
        var focusable=getFocusable();
        if(focusable.length===0){
          event.preventDefault();
          return;
        }
        var index=focusable.indexOf(document.activeElement);
        if(event.shiftKey){
          if(index<=0){
            focusable[focusable.length-1].focus();
            event.preventDefault();
          }
        } else {
          if(index===focusable.length-1){
            focusable[0].focus();
            event.preventDefault();
          }
        }
      } else if(event.key==='Enter'&&currentConfig&&currentConfig.mode==='prompt'){
        if(document.activeElement===inputField){
          event.preventDefault();
          handleConfirm();
        }
      }
    }

    function enforceFocus(event){
      if(!active)return;
      if(!dialog.contains(event.target)){
        event.stopPropagation();
        focusFirst();
      }
    }

    function closeModal(result){
      active=false;
      root.classList.remove('is-active');
      root.setAttribute('aria-hidden','true');
      document.body.classList.remove('veritas-modal-open');
      root.removeEventListener('keydown',trapKey,true);
      document.removeEventListener('focus',enforceFocus,true);
      toggleBackground(false);
      setPending(false);
      if(previousFocus&&typeof previousFocus.focus==='function'){
        setTimeout(function(){previousFocus.focus();},0);
      }
      if(resolveFn){
        resolveFn(result);
      }
      currentConfig=null;
      resolveFn=null;
    }

    function handleConfirm(){
      if(!active)return;
      setPending(true);
      var mode=currentConfig?currentConfig.mode:'alert';
      var result;
      if(mode==='prompt'){
        result=inputField.value;
      } else if(mode==='confirm'){
        result=true;
      }
      closeModal(result);
    }

    function handleCancel(){
      if(!active)return;
      var mode=currentConfig?currentConfig.mode:'alert';
      if(mode==='alert'){
        closeModal(undefined);
        return;
      }
      if(mode==='confirm'){
        closeModal(false);
      } else if(mode==='prompt'){
        closeModal(null);
      }
    }

    function openModal(mode,options){
      options=options||{};
      currentConfig=Object.assign({},options,{mode:mode});
      allowEscape=options.allowEscape!==false;
      titleEl.textContent=options.title||(mode==='confirm'?'Please Confirm':(mode==='prompt'?'Enter Response':'Notice'));
      if(options.html){
        messageEl.innerHTML=options.html;
      } else {
        messageEl.textContent=options.message||'';
      }
      if(options.subtext){
        subtextEl.style.display='block';
        subtextEl.textContent=options.subtext;
      } else {
        subtextEl.style.display='none';
        subtextEl.textContent='';
      }
      if(mode==='prompt'){
        inputWrap.style.display='flex';
        inputField.value=options.defaultValue||'';
        if(options.placeholder){
          inputField.placeholder=options.placeholder;
        } else {
          inputField.removeAttribute('placeholder');
        }
      } else {
        inputWrap.style.display='none';
        inputField.value='';
        inputField.removeAttribute('placeholder');
      }
      confirmLabel.textContent=options.confirmText||(mode==='confirm'?'Confirm':(mode==='prompt'?'Submit':'OK'));
      if(options.destructive){
        confirmBtn.classList.add('destructive');
      } else {
        confirmBtn.classList.remove('destructive');
      }
      cancelBtn.style.display=mode==='alert'?'none':'inline-flex';
      cancelBtn.textContent=options.cancelText||'Cancel';
      setPending(false);
      previousFocus=document.activeElement;
      root.classList.add('is-active');
      root.setAttribute('aria-hidden','false');
      document.body.classList.add('veritas-modal-open');
      toggleBackground(true);
      active=true;
      root.addEventListener('keydown',trapKey,true);
      document.addEventListener('focus',enforceFocus,true);

      return new Promise(function(resolve){
        resolveFn=resolve;
        setTimeout(function(){
          if(mode==='prompt'){
            inputField.focus();
            inputField.select();
          } else if(mode==='confirm'&&options.focusCancel){
            cancelBtn.focus();
          } else {
            confirmBtn.focus();
          }
        },0);
      });
    }

    confirmBtn.addEventListener('click',handleConfirm);
    cancelBtn.addEventListener('click',handleCancel);
    root.addEventListener('click',function(event){
      if(event.target===root||event.target.classList.contains('veritas-modal-backdrop')){
        if(!currentConfig||currentConfig.allowBackdropClose===false){
          return;
        }
        handleCancel();
      }
    });

    return {
      alert:function(options){
        return openModal('alert',options).then(function(){return;});
      },
      confirm:function(options){
        return openModal('confirm',options).then(function(result){return result!==false;});
      },
      prompt:function(options){
        return openModal('prompt',options).then(function(result){return result;});
      }
    };
  }

  // --- Element Cache ---
  var pollSelect=document.getElementById('poll-select');
  var startPollBtn=document.getElementById('start-poll-btn');
  var dashboard=document.getElementById('dashboard');
  var liveView=document.getElementById('live-view');
  var rosterManager=document.getElementById('roster-manager');
  var archivedView=document.getElementById('archived-view');
  var analyticsView=document.getElementById('analytics-view');
  var headerDefault=document.getElementById('header-default');
  var headerLive=document.getElementById('header-live');
  var modal=document.getElementById('poll-creator-modal');
  var linksModal=document.getElementById('student-links-modal');
  var pollSortSelect=document.getElementById('poll-sort-select');
  var pollFilterSelect=document.getElementById('poll-filter-select');
  var pollsTableBody=document.getElementById('polls-table-body');
  var pollsEmptyState=document.getElementById('polls-empty-state');
  var classSelect=document.getElementById('class-select');
  var archivedClassFilterSelect=document.getElementById('archived-class-filter');
  var archivedList=document.getElementById('archived-list');
  var archivedEmptyState=document.getElementById('archived-empty-state');
  var archivedDetail=document.getElementById('archived-detail');
  var archivedPollTitle=document.getElementById('archived-poll-title');
  var archivedPollMeta=document.getElementById('archived-poll-meta');
  var archivedQuestionCount=document.getElementById('archived-question-count');
  var archivedResponseCount=document.getElementById('archived-response-count');
  var archivedQuestionsContainer=document.getElementById('archived-questions-container');
  var rosterClassList=document.getElementById('roster-class-list');
  var rosterClassTitle=document.getElementById('roster-class-title');
  var rosterEmptyState=document.getElementById('roster-empty-state');
  var rosterTableWrapper=document.getElementById('roster-table-wrapper');
  var rosterTableBody=document.getElementById('roster-table-body');
  var rosterStatus=document.getElementById('roster-status');
  var renameClassBtn=document.getElementById('rename-class-btn');
  var deleteClassBtn=document.getElementById('delete-class-btn');
  var addClassBtn=document.getElementById('add-class-btn');
  var addStudentRowBtn=document.getElementById('add-student-row-btn');
  var saveRosterBtn=document.getElementById('save-roster-btn');
  var refreshArchivedBtn=document.getElementById('refresh-archived-btn');

  // --- Initialization ---
  google.charts.load('current',{'packages':['corechart']});
  google.charts.setOnLoadCallback(loadInitialData);

  // --- Event Listeners ---
  document.getElementById('open-creator-btn').onclick=function(){openPollCreator();};
  document.getElementById('nav-create-poll').onclick=function(){openPollCreator();};
  document.getElementById('nav-polls-list').onclick=showDashboard;
  document.getElementById('nav-rosters').onclick=showRosterManager;
  document.getElementById('nav-archived').onclick=showArchivedView;
  document.getElementById('nav-analytics').onclick=showAnalyticsView;
  document.getElementById('close-modal-btn').onclick=closePollCreator;
  document.getElementById('close-links-modal-btn').onclick=closeLinksModal;
  document.getElementById('add-question-btn').onclick=addQuestion;
  document.getElementById('save-poll-btn').onclick=savePoll;
  document.getElementById('new-poll-name').addEventListener('input',markPollDirty);
  classSelect.addEventListener('change',markPollDirty);
  startPollBtn.onclick=onStartPoll;
  document.getElementById('header-start-btn').onclick=onResumePoll;
  document.getElementById('header-end-show-btn').onclick=onEndQuestionAndShowAnswer;
  document.getElementById('header-stop-btn').onclick=onEndPoll;
  document.getElementById('header-back-btn').onclick=onPreviousQuestion;
  document.getElementById('header-next-btn').onclick=onNextQuestion;
  document.getElementById('header-reset-question-btn').onclick=onResetQuestion;
  document.getElementById('header-skip-btn').onclick=onNextQuestion;
  document.getElementById('hide-results-btn').onclick=onHideResults;
  document.getElementById('strip-next-btn').onclick=onNextQuestion;
  document.getElementById('timer-start-btn').onclick=function(){
    if(timerActive){
      pauseTimerCountdown();
    } else {
      startTimerCountdown();
    }
  };
  document.getElementById('timer-reset-btn').onclick=resetTimerCountdown;
  document.getElementById('timer-decrease-btn').onclick=function(){adjustTimerPreset(-15);};
  document.getElementById('timer-increase-btn').onclick=function(){adjustTimerPreset(15);};

  // Keyboard shortcuts for timer (when timer bar is focused or in view)
  document.addEventListener('keydown',function(e){
    var timerBar = document.querySelector('.timer-bar');
    if(!timerBar || !timerBar.offsetParent) return; // Timer not visible

    // Prevent shortcuts when typing in input fields
    if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

    if(e.key === ' '){
      e.preventDefault();
      if(timerActive){
        pauseTimerCountdown();
      } else {
        startTimerCountdown();
      }
    } else if(e.key === 'r' || e.key === 'R'){
      e.preventDefault();
      resetTimerCountdown();
    } else if(!timerActive && (e.key === 'ArrowLeft' || e.key === 'ArrowDown')){
      e.preventDefault();
      adjustTimerPreset(-15);
    } else if(!timerActive && (e.key === 'ArrowRight' || e.key === 'ArrowUp')){
      e.preventDefault();
      adjustTimerPreset(15);
    }
  });

  updateTimerInputs();
  updateTimerStatus('Timer idle.','info');
  document.getElementById('send-link-btn').onclick=onSendLink;
  document.getElementById('view-links-btn').onclick=onViewLinks;
  pollSelect.onchange=onPollSelectChange;
  pollSortSelect.onchange=function(){pollSortMode=this.value;refreshPollViews();};
  pollFilterSelect.onchange=function(){pollClassFilter=this.value;refreshPollViews();};
  archivedClassFilterSelect.onchange=function(){archivedClassFilter=this.value;renderArchivedList();};
  addClassBtn.onclick=onAddClass;
  addStudentRowBtn.onclick=addRosterRow;
  document.getElementById('bulk-add-students-btn').onclick=openBulkAddStudentsModal;
  document.getElementById('cancel-bulk-add-btn').onclick=closeBulkAddStudentsModal;
  document.getElementById('confirm-bulk-add-btn').onclick=confirmBulkAddStudents;
  saveRosterBtn.onclick=saveRoster;
  renameClassBtn.onclick=onRenameClass;
  deleteClassBtn.onclick=onDeleteClass;
  refreshArchivedBtn.onclick=function(){loadArchivedPolls(true);};

  function setMainSection(section){
    dashboard.style.display=section==='dashboard'?'block':'none';
    liveView.style.display=section==='live'?'grid':'none';
    rosterManager.style.display=section==='roster'?'grid':'none';
    archivedView.style.display=section==='archived'?'grid':'none';
    analyticsView.style.display=section==='analytics'?'flex':'none';
  }

  function clearLiveIntervals(){
    if(pollInterval){
      clearInterval(pollInterval);
      pollInterval=null;
    }
    pauseTimerCountdown();
    stopVisualTimer();
    timerRemainingSeconds=timerPresetSeconds;
    timerActive=false;
    updateTimerDisplay();
    updateTimerStatus('Timer idle.','info');
  }

  function showDashboard(){
    clearLiveIntervals();
    isLiveSession=false;
    CURRENT_POLL_DATA={};
    headerDefault.style.display='flex';
    headerLive.style.display='none';
    setMainSection('dashboard');
  }

  function showRosterManager(){
    clearLiveIntervals();
    headerDefault.style.display='flex';
    headerLive.style.display='none';
    setMainSection('roster');
    if(Object.keys(rosterData).length===0){
      loadRosterData();
    } else {
      renderRosterClassList();
      if(selectedRosterClass){
        renderRosterTable();
      } else {
        rosterEmptyState.classList.remove('hidden');
        rosterTableWrapper.classList.add('hidden');
        renameClassBtn.classList.add('hidden');
        deleteClassBtn.classList.add('hidden');
      }
    }
  }

  function showArchivedView(){
    clearLiveIntervals();
    headerDefault.style.display='flex';
    headerLive.style.display='none';
    setMainSection('archived');
    if(archivedPolls.length===0){
      loadArchivedPolls();
    } else {
      renderArchivedList();
      renderArchivedDetail();
    }
  }

  // --- Initial Data Load ---
  function loadInitialData(){
    google.script.run
      .withSuccessHandler(onDashboardDataLoaded)
      .withFailureHandler(handleError)
      .getTeacherDashboardData();
  }

  function onDashboardDataLoaded(data){
    mainLoader.style.display='none';
    ALL_POLLS=data.polls||[];
    refreshClassOptions(data.classes||[]);
    refreshPollViews();
  }

  function updatePollDropdown(polls){
    polls=polls||getFilteredSortedPolls();
    var previousValue=pollSelect.value;
    pollSelect.innerHTML='<option value="">-- Choose a poll --</option>';
    var hasSelection=false;
    polls.forEach(function(poll){
      var opt=document.createElement('option');
      opt.value=poll.pollId;
      opt.textContent=poll.pollName+' ('+poll.className+') - '+poll.questions.length+' questions';
      if(poll.pollId===previousValue){
        opt.selected=true;
        hasSelection=true;
      }
      pollSelect.appendChild(opt);
    });
    if(!hasSelection){
      pollSelect.value='';
    }
    onPollSelectChange();
  }

  function refreshClassOptions(classList){
    BASE_CLASSES=(classList||[]).map(function(name){return (name||'').toString().trim();}).filter(function(name){return name!=='';});
    var classSet=new Set();
    BASE_CLASSES.forEach(function(name){classSet.add(name);});
    Object.keys(rosterData).forEach(function(name){if(name)classSet.add(name);});
    ALL_POLLS.forEach(function(poll){
      if(poll.className){
        classSet.add(poll.className);
      }
    });
    ALL_CLASSES=Array.from(classSet).sort();

    var previousSelection=classSelect.value;
    classSelect.innerHTML='<option value="">-- Select Class --</option>';
    ALL_CLASSES.forEach(function(className){
      var opt=document.createElement('option');
      opt.value=className;
      opt.textContent=className;
      classSelect.appendChild(opt);
    });
    if(previousSelection&&ALL_CLASSES.indexOf(previousSelection)!==-1){
      classSelect.value=previousSelection;
    } else {
      classSelect.value='';
    }

    updateClassFilters();
  }

  function updateClassFilters(){
    var previousPollFilter=pollClassFilter;
    pollFilterSelect.innerHTML='<option value="all">All classes</option>';
    ALL_CLASSES.forEach(function(className){
      var opt=document.createElement('option');
      opt.value=className;
      opt.textContent=className;
      pollFilterSelect.appendChild(opt);
    });
    if(previousPollFilter&&ALL_CLASSES.indexOf(previousPollFilter)!==-1){
      pollClassFilter=previousPollFilter;
    } else {
      pollClassFilter='all';
    }
    pollFilterSelect.value=pollClassFilter;

    var previousArchivedFilter=archivedClassFilter;
    archivedClassFilterSelect.innerHTML='<option value="all">All classes</option>';
    ALL_CLASSES.forEach(function(className){
      var opt=document.createElement('option');
      opt.value=className;
      opt.textContent=className;
      archivedClassFilterSelect.appendChild(opt);
    });
    if(previousArchivedFilter&&ALL_CLASSES.indexOf(previousArchivedFilter)!==-1){
      archivedClassFilter=previousArchivedFilter;
    } else {
      archivedClassFilter='all';
    }
    archivedClassFilterSelect.value=archivedClassFilter;
  }

  function getFilteredSortedPolls(){
    var list=ALL_POLLS.slice();
    if(pollClassFilter!=='all'){
      list=list.filter(function(poll){return poll.className===pollClassFilter;});
    }

    list.sort(function(a,b){
      switch(pollSortMode){
        case 'updated_asc':
          return getPollTimestamp(a)-getPollTimestamp(b);
        case 'name_asc':
          return (a.pollName||'').localeCompare(b.pollName||'');
        case 'class_asc':
          var classCompare=(a.className||'').localeCompare(b.className||'');
          if(classCompare!==0)return classCompare;
          return (a.pollName||'').localeCompare(b.pollName||'');
        case 'updated_desc':
        default:
          return getPollTimestamp(b)-getPollTimestamp(a);
      }
    });
    return list;
  }

  function getPollTimestamp(poll){
    var value=poll && (poll.updatedAt||poll.lastRunAt||poll.createdAt||'');
    var time=value?Date.parse(value):NaN;
    return isNaN(time)?0:time;
  }

  function refreshPollViews(){
    var polls=getFilteredSortedPolls();
    renderPollTable(polls);
    updatePollDropdown(polls);
    if(polls.length===0){
      pollsEmptyState.classList.remove('hidden');
    } else {
      pollsEmptyState.classList.add('hidden');
    }
  }

  function startEditPoll(pollId,triggerButton){
    if(!pollId)return;
    var button=triggerButton||null;
    var originalLabel=button?button.innerHTML:'';
    if(button){
      button.disabled=true;
      button.textContent='Loading...';
    }

    google.script.run
      .withSuccessHandler(function(poll){
        if(button){
          button.disabled=false;
          button.innerHTML=originalLabel;
        }
        openPollCreator(poll);
      })
      .withFailureHandler(function(error){
        if(button){
          button.disabled=false;
          button.innerHTML=originalLabel;
        }
        handleError(error);
      })
      .getPollForEditing(pollId);
  }

  function renderPollTable(polls){
    polls=polls||getFilteredSortedPolls();
    pollsTableBody.innerHTML='';

    if(polls.length===0){
      return;
    }

    polls.forEach(function(poll){
      var row=document.createElement('tr');
      row.className='hover:bg-brand-light-gray/40 dark:hover:bg-brand-dark-gray/40 transition-colors';
      var lastEdited=formatDateTime(poll.updatedAt||poll.lastRunAt||poll.createdAt);
      var createdLabel=poll.createdAt?formatDateTime(poll.createdAt):'—';
      var htmlParts=[];
      htmlParts.push('<td class="px-4 py-3 align-top">');
      htmlParts.push('<div class="font-semibold text-brand-dark-gray dark:text-brand-white">'+escapeHtml(poll.pollName||'Untitled Poll')+'</div>');
      htmlParts.push('<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/50">Created '+createdLabel+'</div>');
      htmlParts.push('</td>');
      htmlParts.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+escapeHtml(poll.className||'—')+'</td>');
      htmlParts.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+(poll.questions?poll.questions.length:0)+'</td>');
      htmlParts.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+lastEdited+'</td>');
      htmlParts.push('<td class="px-4 py-3 align-top">');
      htmlParts.push('<div class="flex justify-end gap-2">');
      htmlParts.push('<button class="poll-select-btn h-8 px-3 rounded-md bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-xs font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors" data-poll-id="'+poll.pollId+'">Select</button>');
      htmlParts.push('<button class="poll-copy-btn h-8 px-3 rounded-md bg-green-600/10 text-green-600 dark:text-green-300 dark:bg-green-500/20 text-xs font-semibold hover:bg-green-600/20 dark:hover:bg-green-500/30 transition-colors" data-poll-id="'+poll.pollId+'" title="Copy this poll">Copy</button>');
      htmlParts.push('<button class="poll-edit-btn h-8 px-3 rounded-md bg-primary text-brand-white text-xs font-semibold hover:bg-primary/90 transition-colors" data-poll-id="'+poll.pollId+'">Edit</button>');
      htmlParts.push('<button class="poll-delete-btn h-8 px-3 rounded-md bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-xs font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors" data-poll-id="'+poll.pollId+'">Delete</button>');
      htmlParts.push('</div>');
      htmlParts.push('</td>');
      row.innerHTML=htmlParts.join('');
      pollsTableBody.appendChild(row);
    });

    pollsTableBody.querySelectorAll('.poll-select-btn').forEach(function(btn){
      btn.onclick=function(){
        var id=this.dataset.pollId;
        pollSelect.value=id;
        onPollSelectChange();
        showDashboard();
      };
    });

    pollsTableBody.querySelectorAll('.poll-copy-btn').forEach(function(btn){
      btn.onclick=async function(){
        var pollId=this.dataset.pollId;
        var poll=ALL_POLLS.find(function(p){return p.pollId===pollId;});
        if(!poll)return;

        var newName=await veritasPrompt('Enter a name for the copied poll:',{
          defaultValue:poll.pollName+' (Copy)',
          title:'Copy poll'
        });
        if(newName===null)return;

        newName=newName.trim();
        if(newName===''){
          await veritasAlert('Poll name cannot be empty',{title:'Copy poll'});
          return;
        }

        btn.disabled=true;
        btn.textContent='Copying...';

        google.script.run
          .withSuccessHandler(async function(result){
            if(result.success){
              refreshPollData(result.polls);
              await veritasAlert(result.message,{title:'Poll copied'});
            } else {
              await veritasAlert('Failed to copy poll: '+(result.error||'Unknown error'),{
                title:'Copy poll failed',
                destructive:true
              });
            }
            btn.disabled=false;
            btn.textContent='Copy';
          })
          .withFailureHandler(function(error){
            handleError(error);
            btn.disabled=false;
            btn.textContent='Copy';
          })
          .copyPoll(pollId,newName,poll.className);
      };
    });

    pollsTableBody.querySelectorAll('.poll-edit-btn').forEach(function(btn){
      btn.onclick=function(){
        startEditPoll(this.dataset.pollId,this);
      };
    });

    pollsTableBody.querySelectorAll('.poll-delete-btn').forEach(function(btn){
      btn.onclick=async function(){
        var id=this.dataset.pollId;
        var confirmed=await veritasConfirm('Delete this poll permanently? This will also remove all responses.',{
          title:'Delete poll',
          confirmText:'Delete',
          destructive:true
        });
        if(!confirmed)return;

        google.script.run
          .withSuccessHandler(function(polls){
            refreshPollData(polls);
          })
          .withFailureHandler(handleError)
          .deletePoll(id);
      };
    });
  }

  function refreshPollData(polls){
    ALL_POLLS=polls||[];
    refreshClassOptions(BASE_CLASSES);
    refreshPollViews();
  }

  function onPollSelectChange(){
    var pollId=pollSelect.value;
    var sendBtn=document.getElementById('send-link-btn');
    var viewBtn=document.getElementById('view-links-btn');
    if(pollId){
      var selectedPoll=ALL_POLLS.find(function(p){return p.pollId===pollId;});
      if(selectedPoll){
        sendBtn.disabled=false;
        viewBtn.disabled=false;
        sendBtn.dataset.className=selectedPoll.className;
        viewBtn.dataset.className=selectedPoll.className;
      }
    } else {
      sendBtn.disabled=true;
      viewBtn.disabled=true;
    }
  }

  // --- Roster Management ---
  function loadRosterData(){
    rosterStatus.textContent='Loading roster...';
    google.script.run
      .withSuccessHandler(function(data){
        rosterStatus.textContent='';
        onRosterDataLoaded(data, selectedRosterClass);
      })
      .withFailureHandler(function(error){
        rosterStatus.textContent='';
        handleError(error);
      })
      .getRosterManagerData();
  }

  function onRosterDataLoaded(data, focusClass){
    rosterDirty=false;
    rosterData=data&&data.rosters?data.rosters:{};
    refreshClassOptions((data&&data.classes)||BASE_CLASSES);

    if(focusClass){
      selectedRosterClass=focusClass;
    }

    if(selectedRosterClass && !rosterData[selectedRosterClass]){
      selectedRosterClass='';
    }

    renderRosterClassList();

    if(selectedRosterClass){
      renderRosterTable();
    } else {
      rosterClassTitle.textContent='Select a class';
      rosterEmptyState.classList.remove('hidden');
      rosterTableWrapper.classList.add('hidden');
      renameClassBtn.classList.add('hidden');
      deleteClassBtn.classList.add('hidden');
      rosterStatus.textContent='';
    }
  }

  function renderRosterClassList(){
    rosterClassList.innerHTML='';
    if(ALL_CLASSES.length===0){
      rosterClassList.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No classes yet. Click the + button to add one.</p>';
      return;
    }

    ALL_CLASSES.forEach(function(className){
      var button=document.createElement('button');
      button.type='button';
      var isActive=className===selectedRosterClass;
      button.className='w-full text-left px-3 py-2 rounded-lg transition-colors '+(isActive?'bg-primary text-brand-white shadow-sm':'bg-brand-light-gray/40 dark:bg-brand-dark-gray/30 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/60 dark:hover:bg-brand-dark-gray/50');
      button.textContent=className;
      button.onclick=function(){
        selectRosterClass(className);
      };
      rosterClassList.appendChild(button);
    });
  }

  function selectRosterClass(className){
    selectedRosterClass=className;
    rosterDirty=false;
    rosterStatus.textContent='';
    renderRosterClassList();
    renderRosterTable();
  }

  function renderRosterTable(){
    if(!selectedRosterClass){
      return;
    }

    var entries=rosterData[selectedRosterClass]||[];
    rosterData[selectedRosterClass]=entries;

    if(entries.length===0){
      entries.push({name:'',email:''});
    }

    rosterClassTitle.textContent=selectedRosterClass;
    rosterEmptyState.classList.add('hidden');
    rosterTableWrapper.classList.remove('hidden');
    renameClassBtn.classList.remove('hidden');
    deleteClassBtn.classList.remove('hidden');

    rosterTableBody.innerHTML='';
    entries.forEach(function(entry,index){
      var row=document.createElement('tr');
      row.innerHTML=
        '<td class="px-4 py-2 align-top">'+
          '<input type="text" class="roster-name-input w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" data-index="'+index+'" placeholder="Student Name" value="'+escapeHtml(entry.name||'')+'" />'+
        '</td>'+
        '<td class="px-4 py-2 align-top">'+
          '<input type="email" class="roster-email-input w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" data-index="'+index+'" placeholder="email@example.com" value="'+escapeHtml(entry.email||'')+'" />'+
        '</td>'+
        '<td class="px-4 py-2 align-top text-center">'+
          '<button class="remove-roster-row-btn h-8 w-8 rounded-full bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors" data-index="'+index+'" title="Remove">'+
            '<span class="material-symbols-outlined text-base">close</span>'+
          '</button>'+
        '</td>';
      rosterTableBody.appendChild(row);
    });

    rosterTableBody.querySelectorAll('.roster-name-input').forEach(function(input){
      input.oninput=function(){
        var idx=parseInt(this.dataset.index,10);
        rosterData[selectedRosterClass][idx].name=this.value;
        markRosterDirty();
      };
    });

    rosterTableBody.querySelectorAll('.roster-email-input').forEach(function(input){
      input.oninput=function(){
        var idx=parseInt(this.dataset.index,10);
        rosterData[selectedRosterClass][idx].email=this.value;
        markRosterDirty();
      };
    });

    rosterTableBody.querySelectorAll('.remove-roster-row-btn').forEach(function(btn){
      btn.onclick=function(){
        var idx=parseInt(this.dataset.index,10);
        removeRosterRow(idx);
      };
    });
  }

  function markRosterDirty(){
    rosterDirty=true;
    rosterStatus.textContent='Unsaved changes';
  }

  async function addRosterRow(){
    if(!selectedRosterClass){
      await veritasAlert('Select a class first.',{title:'Roster'});
      return;
    }
    if(!rosterData[selectedRosterClass]){
      rosterData[selectedRosterClass]=[];
    }
    rosterData[selectedRosterClass].push({name:'',email:''});
    markRosterDirty();
    renderRosterTable();
  }

  function removeRosterRow(index){
    if(!selectedRosterClass)return;
    var entries=rosterData[selectedRosterClass]||[];
    if(entries.length>index){
      entries.splice(index,1);
      markRosterDirty();
      if(entries.length===0){
        entries.push({name:'',email:''});
      }
      renderRosterTable();
    }
  }

  async function saveRoster(){
    if(!selectedRosterClass){
      await veritasAlert('Select a class to save.',{title:'Roster'});
      return;
    }

    var entries=(rosterData[selectedRosterClass]||[]).map(function(entry){
      return {
        name:(entry.name||'').trim(),
        email:(entry.email||'').trim()
      };
    }).filter(function(entry){
      return entry.name!==''&&entry.email!=='';
    });

    saveRosterBtn.disabled=true;
    rosterStatus.textContent='Saving roster...';

    google.script.run
      .withSuccessHandler(function(data){
        saveRosterBtn.disabled=false;
        rosterStatus.textContent='Roster saved.';
        rosterDirty=false;
        onRosterDataLoaded(data, selectedRosterClass);
      })
      .withFailureHandler(function(error){
        saveRosterBtn.disabled=false;
        handleError(error);
      })
      .saveRoster(selectedRosterClass, entries);
  }

  async function openBulkAddStudentsModal(){
    if(!selectedRosterClass){
      await veritasAlert('Select a class first.',{title:'Roster'});
      return;
    }
    document.getElementById('bulk-student-input').value='';
    document.getElementById('bulk-add-students-modal').style.display='flex';
  }

  function closeBulkAddStudentsModal(){
    document.getElementById('bulk-add-students-modal').style.display='none';
  }

  async function confirmBulkAddStudents(){
    if(!selectedRosterClass){
      await veritasAlert('Select a class first.',{title:'Roster'});
      closeBulkAddStudentsModal();
      return;
    }

    var input=document.getElementById('bulk-student-input').value;
    var lines=input.split('\n');
    var entries=[];

    lines.forEach(function(line){
      line=line.trim();
      if(line==='')return;

      // Parse format: Name, Email
      var parts=line.split(',');
      if(parts.length>=2){
        var name=parts[0].trim();
        var email=parts.slice(1).join(',').trim();
        if(name&&email){
          entries.push({name:name,email:email});
        }
      }
    });

    if(entries.length===0){
      await veritasAlert('No valid student entries found. Use format: Name, Email',{title:'Bulk add students'});
      return;
    }

    var confirmBtn=document.getElementById('confirm-bulk-add-btn');
    confirmBtn.disabled=true;
    confirmBtn.textContent='Adding...';

    google.script.run
      .withSuccessHandler(async function(result){
        confirmBtn.disabled=false;
        confirmBtn.textContent='Add Students';
        closeBulkAddStudentsModal();

        if(result.success){
          await veritasAlert(result.message,{title:'Students added'});
          rosterDirty=false;
          onRosterDataLoaded(result.data,selectedRosterClass);
        } else {
          await veritasAlert('Failed to add students: '+(result.error||'Unknown error'),{
            title:'Bulk add students',
            destructive:true
          });
        }
      })
      .withFailureHandler(function(error){
        confirmBtn.disabled=false;
        confirmBtn.textContent='Add Students';
        handleError(error);
      })
      .bulkAddStudentsToRoster(selectedRosterClass,entries);
  }

  async function onAddClass(){
    var className=await veritasPrompt('Class name',{title:'Add class',confirmText:'Create'});
    if(!className)return;
    className=className.trim();
    if(className==='')return;
    rosterStatus.textContent='Creating class...';
    google.script.run
      .withSuccessHandler(function(data){
        rosterStatus.textContent='Class created.';
        selectedRosterClass=className;
        onRosterDataLoaded(data, className);
      })
      .withFailureHandler(function(error){
        rosterStatus.textContent='';
        handleError(error);
      })
      .createClassRecord(className,'');
  }

  async function onRenameClass(){
    if(!selectedRosterClass){
      await veritasAlert('Select a class first.',{title:'Roster'});
      return;
    }
    var newName=await veritasPrompt('Rename class',{title:'Rename class',defaultValue:selectedRosterClass,confirmText:'Rename'});
    if(!newName)return;
    newName=newName.trim();
    if(newName===''){return;}
    if(newName===selectedRosterClass)return;
    rosterStatus.textContent='Renaming class...';
    google.script.run
      .withSuccessHandler(function(data){
        rosterStatus.textContent='Class renamed.';
        selectedRosterClass=newName;
        onRosterDataLoaded(data, newName);
      })
      .withFailureHandler(function(error){
        rosterStatus.textContent='';
        handleError(error);
      })
      .renameClass(selectedRosterClass,newName);
  }

  async function onDeleteClass(){
    if(!selectedRosterClass){
      await veritasAlert('Select a class first.',{title:'Roster'});
      return;
    }
    var confirmed=await veritasConfirm('Delete class "'+selectedRosterClass+'" and remove all students?',{
      title:'Delete class',
      confirmText:'Delete',
      destructive:true
    });
    if(!confirmed)return;
    rosterStatus.textContent='Deleting class...';
    var classToDelete=selectedRosterClass;
    google.script.run
      .withSuccessHandler(function(data){
        rosterStatus.textContent='Class deleted.';
        selectedRosterClass='';
        onRosterDataLoaded(data, '');
      })
      .withFailureHandler(function(error){
        rosterStatus.textContent='';
        handleError(error);
      })
      .deleteClassRecord(classToDelete);
  }

  // --- Archived Polls ---
  function loadArchivedPolls(force){
    if(archivedPolls.length>0&&!force){
      renderArchivedList();
      renderArchivedDetail();
      return;
    }

    archivedList.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">Loading archived polls...</p>';
    archivedEmptyState.classList.remove('hidden');
    archivedDetail.classList.add('hidden');

    google.script.run
      .withSuccessHandler(function(polls){
        archivedPolls=polls||[];
        if(archivedPolls.length>0){
          if(!archivedPolls.some(function(p){return p.pollId===selectedArchivedPollId;})){
            selectedArchivedPollId=archivedPolls[0].pollId;
          }
        } else {
          selectedArchivedPollId='';
        }
        renderArchivedList();
        renderArchivedDetail();
      })
      .withFailureHandler(handleError)
      .getArchivedPolls();
  }

  function renderArchivedList(){
    archivedList.innerHTML='';
    var filtered=archivedClassFilter==='all'?archivedPolls:archivedPolls.filter(function(poll){return poll.className===archivedClassFilter;});

    if(filtered.length===0){
      archivedList.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No archived polls for this filter.</p>';
      archivedEmptyState.classList.remove('hidden');
      archivedDetail.classList.add('hidden');
      return;
    }

    filtered.forEach(function(poll){
      var button=document.createElement('button');
      button.type='button';
      var isActive=poll.pollId===selectedArchivedPollId;
      button.className='w-full text-left px-3 py-2 rounded-lg transition-colors '+(isActive?'bg-primary text-brand-white shadow-sm':'bg-brand-light-gray/40 dark:bg-brand-dark-gray/30 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/60 dark:hover:bg-brand-dark-gray/50');
      var metaText=(poll.className||'Unassigned')+' • '+formatDateTime(poll.lastRunAt||poll.updatedAt||poll.createdAt);
      button.innerHTML='<div class="font-semibold">'+escapeHtml(poll.pollName||'Untitled Poll')+'</div><div class="text-xs opacity-80">'+escapeHtml(metaText)+'</div>';
      button.onclick=function(){
        selectedArchivedPollId=poll.pollId;
        renderArchivedList();
        renderArchivedDetail();
      };
      archivedList.appendChild(button);
    });
  }

  function renderArchivedDetail(){
    var poll=archivedPolls.find(function(p){return p.pollId===selectedArchivedPollId;});
    if(!poll){
      archivedEmptyState.classList.remove('hidden');
      archivedDetail.classList.add('hidden');
      return;
    }

    archivedEmptyState.classList.add('hidden');
    archivedDetail.classList.remove('hidden');

    archivedPollTitle.textContent=poll.pollName||'Untitled Poll';
    archivedPollMeta.textContent=(poll.className||'Unassigned')+' • Last run '+formatDateTime(poll.lastRunAt||poll.updatedAt||poll.createdAt);
    archivedQuestionCount.textContent=poll.questionCount||0;
    archivedResponseCount.textContent=(poll.totalResponses||0)+' of '+(poll.totalStudents||0);

    archivedQuestionsContainer.innerHTML='';
    poll.questions.forEach(function(question,index){
      var card=document.createElement('div');
      card.className='border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-4 bg-brand-white dark:bg-brand-dark-gray/40';
      var summary=question.summary||{correct:0,incorrect:0,noResponse:0,violations:0};
      var responses=Array.isArray(question.responses)?question.responses:[];
      var nonResponders=Array.isArray(question.nonResponders)?question.nonResponders:[];
      summary.correct=summary.correct||0;
      summary.incorrect=summary.incorrect||0;
      summary.noResponse=summary.noResponse||0;
      summary.violations=summary.violations||0;

      var responsesHtml='';
      if(responses.length===0){
        responsesHtml='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No responses recorded.</p>';
      } else {
        responsesHtml='<table class="min-w-full text-sm divide-y divide-brand-light-gray dark:divide-brand-dark-gray/40"><thead class="text-xs uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/50"><tr><th class="py-2 text-left">Student</th><th class="py-2 text-left">Answer</th><th class="py-2 text-left">Status</th></tr></thead><tbody class="divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/40">';
        responses.forEach(function(response){
          var status=response.violation?'Violation':(response.isCorrect?'Correct':'Incorrect');
          var statusClass=response.violation?'text-orange-600 dark:text-orange-300':(response.isCorrect?'text-green-600 dark:text-green-300':'text-red-600 dark:text-red-300');
          responsesHtml+='<tr><td class="py-2 pr-3">'+escapeHtml(response.name||response.email)+'</td><td class="py-2 pr-3">'+escapeHtml(response.answer||'—')+'</td><td class="py-2 pr-3 '+statusClass+'">'+status+'</td></tr>';
        });
        responsesHtml+='</tbody></table>';
      }

      var nonResponderHtml='';
      if(nonResponders.length>0){
        nonResponderHtml='<div class="mt-3"><h4 class="text-xs font-semibold uppercase text-brand-dark-gray/60 dark:text-brand-white/60">No Response</h4><div class="flex flex-wrap gap-2 mt-1">';
        nonResponders.forEach(function(student){
          var chipClass=student.violation?'bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-200':'bg-brand-light-gray text-brand-dark-gray dark:bg-brand-dark-gray/50 dark:text-brand-white/80';
          nonResponderHtml+='<span class="px-2 py-1 rounded-full text-xs '+chipClass+'">'+escapeHtml(student.name||student.email)+'</span>';
        });
        nonResponderHtml+='</div></div>';
      }

      var imageHtml=question.questionImageURL?'<div class="mt-3"><img src="'+escapeHtml(question.questionImageURL)+'" class="max-h-48 rounded-lg object-contain" alt="Question image" /></div>':'';
      var questionHtml='<div><h3 class="font-serif text-lg text-brand-dark-gray dark:text-brand-white">Question '+(index+1)+'</h3><p class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 mt-1">'+escapeHtml(question.questionText||'')+'</p></div>';
      var summaryHtml='<div class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 text-right">'+
        '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Correct:</span> '+summary.correct+'</p>'+
        '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Incorrect:</span> '+summary.incorrect+'</p>'+
        '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">No Response:</span> '+summary.noResponse+'</p>'+
        '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Violations:</span> '+summary.violations+'</p>'+
      '</div>';
      card.innerHTML='<div class="flex flex-wrap items-start justify-between gap-3">'+questionHtml+summaryHtml+'</div>'+imageHtml+'<div class="mt-4">'+responsesHtml+'</div>'+nonResponderHtml;

      archivedQuestionsContainer.appendChild(card);
    });
  }

  // =============================================================================
  // ANALYTICS HUB - CLIENT-SIDE CODE
  // =============================================================================

  var analyticsData = null;
  var analyticsCurrentTab = 'overview';
  var analyticsFilters = { className: 'all' };
  var analyticsItemsSort = { field: 'qNum', direction: 'asc' };
  var analyticsSelectedStudent = null;

  function showAnalyticsView() {
    clearLiveIntervals();
    headerDefault.style.display = 'flex';
    headerLive.style.display = 'none';
    setMainSection('analytics');

    // Populate class filter
    var analyticsClassFilter = document.getElementById('analytics-class-filter');
    analyticsClassFilter.innerHTML = '<option value="all">All Classes</option>';
    var classes = Array.from(new Set(ALL_POLLS.map(function(p) { return p.className; })));
    classes.forEach(function(className) {
      var opt = document.createElement('option');
      opt.value = className;
      opt.textContent = className;
      analyticsClassFilter.appendChild(opt);
    });

    if (!analyticsData) {
      loadAnalytics();
    } else {
      renderAnalyticsByTab();
    }
  }

  function loadAnalytics(filters) {
    analyticsFilters = filters || analyticsFilters;

    // Show loading states
    document.getElementById('analytics-overview-loading').classList.remove('hidden');
    document.getElementById('analytics-overview-content').classList.add('hidden');
    document.getElementById('analytics-items-loading').classList.remove('hidden');
    document.getElementById('analytics-items-content').classList.add('hidden');
    document.getElementById('analytics-students-loading').classList.remove('hidden');
    document.getElementById('analytics-students-content').classList.add('hidden');

    google.script.run
      .withSuccessHandler(function(data) {
        analyticsData = data;
        renderAnalyticsByTab();
      })
      .withFailureHandler(handleError)
      .getAnalyticsData(analyticsFilters);
  }

  function renderAnalyticsByTab() {
    if (analyticsCurrentTab === 'overview') {
      renderAnalyticsOverview();
    } else if (analyticsCurrentTab === 'items') {
      renderAnalyticsItems();
    } else if (analyticsCurrentTab === 'students') {
      renderAnalyticsStudents();
    }
  }

  // --- Overview Tab ---
  function renderAnalyticsOverview() {
    document.getElementById('analytics-overview-loading').classList.add('hidden');
    document.getElementById('analytics-overview-content').classList.remove('hidden');

    if (!analyticsData) return;

    // Render KPIs
    var kpiContainer = document.getElementById('analytics-kpi-container');
    kpiContainer.innerHTML = '';

    (analyticsData.kpis || []).forEach(function(kpi) {
      var card = document.createElement('div');
      card.className = 'bg-brand-white dark:bg-brand-dark-gray/40 rounded-xl p-5 border border-brand-light-gray dark:border-brand-dark-gray/40 shadow-sm hover:shadow-md transition-shadow cursor-pointer';
      card.title = kpi.tooltip;

      var deltaHtml = '';
      if (kpi.delta !== undefined && kpi.delta !== null) {
        var deltaColor = kpi.delta >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
        var deltaIcon = kpi.delta >= 0 ? '▲' : '▼';
        deltaHtml = '<div class="text-xs font-semibold ' + deltaColor + ' mt-1">' + deltaIcon + ' ' + Math.abs(kpi.delta) + '</div>';
      }

      card.innerHTML = '<div class="text-xs font-semibold uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">' +
        escapeHtml(kpi.label) + '</div>' +
        '<div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">' +
        escapeHtml(kpi.value) + '</div>' + deltaHtml;

      kpiContainer.appendChild(card);
    });

    // Render Topic Heat (simplified version)
    var topicHeat = document.getElementById('analytics-topic-heat');
    if (analyticsData.topics && analyticsData.topics.length > 0) {
      var topicHtml = '<div class="space-y-2">';
      analyticsData.topics.forEach(function(topic) {
        var color = topic.masteryPct >= 70 ? 'bg-green-500' : topic.masteryPct >= 50 ? 'bg-yellow-500' : 'bg-red-500';
        topicHtml += '<div class="flex items-center gap-3">';
        topicHtml += '<div class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white min-w-[120px]">' + escapeHtml(topic.topic) + '</div>';
        topicHtml += '<div class="flex-1 bg-brand-light-gray dark:bg-brand-dark-gray/30 rounded-full h-6 overflow-hidden">';
        topicHtml += '<div class="' + color + ' h-full flex items-center justify-end px-2 text-xs text-white font-semibold" style="width: ' + topic.masteryPct + '%">';
        if (topic.masteryPct > 15) topicHtml += topic.masteryPct + '%';
        topicHtml += '</div></div>';
        topicHtml += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 min-w-[60px] text-right">' + topic.questionCount + ' items</div>';
        topicHtml += '</div>';
      });
      topicHtml += '</div>';
      topicHeat.innerHTML = topicHtml;
    } else {
      topicHeat.innerHTML = '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No topic data available. Add topic tags to your questions.</p>';
    }

    // Render Item Scatter (simplified - using Google Charts)
    if (analyticsData.items && analyticsData.items.length > 0 && typeof google !== 'undefined') {
      var scatterData = [['Difficulty (% Correct)', 'Discrimination', 'Question']];
      analyticsData.items.forEach(function(item) {
        scatterData.push([item.correctPct, item.rbis, 'Q' + item.qNum]);
      });

      var data = google.visualization.arrayToDataTable(scatterData);
      var options = {
        title: 'Item Difficulty vs Discrimination',
        hAxis: { title: 'Difficulty (% Correct)', minValue: 0, maxValue: 100 },
        vAxis: { title: 'Discrimination (r_bis)', minValue: -0.5, maxValue: 1.0 },
        legend: 'none',
        pointSize: 5,
        backgroundColor: 'transparent',
        chartArea: { width: '85%', height: '75%' }
      };

      var chart = new google.visualization.ScatterChart(document.getElementById('analytics-item-scatter'));
      chart.draw(data, options);
    }
  }

  // --- Items Tab ---
  function renderAnalyticsItems() {
    document.getElementById('analytics-items-loading').classList.add('hidden');
    document.getElementById('analytics-items-content').classList.remove('hidden');

    if (!analyticsData || !analyticsData.items) return;

    var items = analyticsData.items.slice();

    // Sort items
    items.sort(function(a, b) {
      var aVal = a[analyticsItemsSort.field];
      var bVal = b[analyticsItemsSort.field];
      if (typeof aVal === 'number' && typeof bVal === 'number') {
        return analyticsItemsSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
      }
      var aStr = String(aVal || '');
      var bStr = String(bVal || '');
      return analyticsItemsSort.direction === 'asc'
        ? aStr.localeCompare(bStr)
        : bStr.localeCompare(aStr);
    });

    var tbody = document.getElementById('analytics-items-tbody');
    tbody.innerHTML = '';

    items.forEach(function(item) {
      var row = document.createElement('tr');
      row.className = 'hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30 cursor-pointer';

      // Q#
      var qNumCell = document.createElement('td');
      qNumCell.className = 'py-3 px-4 font-semibold';
      qNumCell.textContent = item.qNum;
      row.appendChild(qNumCell);

      // Topic
      var topicCell = document.createElement('td');
      topicCell.className = 'py-3 px-4 text-xs';
      topicCell.textContent = item.topic || 'Untagged';
      row.appendChild(topicCell);

      // Correct%
      var correctCell = document.createElement('td');
      correctCell.className = 'py-3 px-4 font-semibold';
      var correctColor = item.correctPct >= 70 ? 'text-green-600 dark:text-green-400' :
                        item.correctPct >= 50 ? 'text-yellow-600 dark:text-yellow-400' :
                        'text-red-600 dark:text-red-400';
      correctCell.innerHTML = '<span class="' + correctColor + '">' + item.correctPct + '%</span>';
      row.appendChild(correctCell);

      // Discrimination
      var discCell = document.createElement('td');
      discCell.className = 'py-3 px-4 font-semibold';
      var discColor = item.rbis >= 0.3 ? 'text-green-600 dark:text-green-400' :
                     item.rbis >= 0.15 ? 'text-yellow-600 dark:text-yellow-400' :
                     'text-red-600 dark:text-red-400';
      discCell.innerHTML = '<span class="' + discColor + '">' + item.rbis.toFixed(2) + '</span>';
      row.appendChild(discCell);

      // Choices (inline bar)
      var choicesCell = document.createElement('td');
      choicesCell.className = 'py-3 px-4';
      choicesCell.innerHTML = renderChoiceBar(item);
      row.appendChild(choicesCell);

      // Time
      var timeCell = document.createElement('td');
      timeCell.className = 'py-3 px-4';
      timeCell.textContent = item.medianTimeSec + 's';
      row.appendChild(timeCell);

      // Flags
      var flagsCell = document.createElement('td');
      flagsCell.className = 'py-3 px-4';
      if (item.flags && item.flags.length > 0) {
        var flagsHtml = '';
        item.flags.forEach(function(flag) {
          var flagColor = 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300';
          if (flag === 'low-disc') flagColor = 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300';
          flagsHtml += '<span class="inline-block px-2 py-0.5 rounded text-xs font-semibold ' + flagColor + ' mr-1">' + escapeHtml(flag) + '</span>';
        });
        flagsCell.innerHTML = flagsHtml;
      }
      row.appendChild(flagsCell);

      tbody.appendChild(row);
    });
  }

  function renderChoiceBar(item) {
    var total = item.total || 1;
    var choices = ['A', 'B', 'C', 'D'];
    var colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
    var html = '<div class="flex items-center gap-1 text-xs">';

    choices.forEach(function(choice, idx) {
      var count = item.choiceCounts[choice] || 0;
      var pct = (count / total * 100).toFixed(0);
      var isCorrect = idx === item.correctIndex;
      var borderStyle = isCorrect ? 'border-2 border-brand-dark-gray dark:border-brand-white' : '';

      if (count > 0) {
        html += '<div class="flex items-center gap-0.5">';
        html += '<span class="font-semibold">' + choice + '</span>';
        html += '<div class="h-4 rounded ' + borderStyle + '" style="width: ' + (pct * 0.8) + 'px; background-color: ' + colors[idx] + '; opacity: 0.7;"></div>';
        html += '<span class="text-brand-dark-gray/60 dark:text-brand-white/60">' + pct + '%</span>';
        html += '</div>';
      }
    });

    html += '</div>';
    return html;
  }

  // --- Students Tab ---
  function renderAnalyticsStudents() {
    document.getElementById('analytics-students-loading').classList.add('hidden');
    document.getElementById('analytics-students-content').classList.remove('hidden');

    if (!analyticsData || !analyticsData.students) return;

    var studentsArray = Object.values(analyticsData.students);

    // Setup student search
    var searchInput = document.getElementById('analytics-student-search');
    var suggestions = document.getElementById('analytics-student-suggestions');

    searchInput.oninput = function() {
      var query = searchInput.value.toLowerCase();
      if (query.length < 2) {
        suggestions.classList.add('hidden');
        return;
      }

      var matches = studentsArray.filter(function(s) {
        return s.name.toLowerCase().includes(query) || s.email.toLowerCase().includes(query);
      }).slice(0, 10);

      if (matches.length > 0) {
        suggestions.innerHTML = '';
        matches.forEach(function(student) {
          var div = document.createElement('div');
          div.className = 'px-4 py-2 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/50 cursor-pointer';
          div.textContent = student.name;
          div.onclick = function() {
            selectStudent(student);
            suggestions.classList.add('hidden');
            searchInput.value = '';
          };
          suggestions.appendChild(div);
        });
        suggestions.classList.remove('hidden');
      } else {
        suggestions.classList.add('hidden');
      }
    };
  }

  function selectStudent(student) {
    analyticsSelectedStudent = student;
    document.getElementById('analytics-student-empty').classList.add('hidden');
    document.getElementById('analytics-student-detail').classList.remove('hidden');

    // Render student summary
    var summary = document.getElementById('analytics-student-summary');
    summary.innerHTML = '<div class="flex flex-wrap items-center justify-between gap-4">' +
      '<div><h3 class="text-xl font-bold text-brand-dark-gray dark:text-brand-white">' + escapeHtml(student.name) + '</h3>' +
      '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">' + escapeHtml(student.email) + '</p></div>' +
      '<div class="grid grid-cols-3 gap-4 text-center">' +
      '<div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">' + student.successLast10.toFixed(1) + '%</div>' +
      '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Success Rate</div></div>' +
      '<div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">' + student.participationPct.toFixed(0) + '%</div>' +
      '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Participation</div></div>' +
      '<div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">' + student.integrityCount + '</div>' +
      '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Integrity Events</div></div>' +
      '</div></div>';

    // Render sparkline (last 10 sessions)
    var sparkline = document.getElementById('analytics-student-sparkline');
    var sessions = student.sessions || [];
    if (sessions.length > 0) {
      var sparkHtml = '<div class="flex gap-2">';
      sessions.slice(0, 10).reverse().forEach(function(session) {
        var color = session.scorePct >= 70 ? 'bg-green-500' : session.scorePct >= 50 ? 'bg-yellow-500' : 'bg-red-500';
        sparkHtml += '<div class="flex-1 flex flex-col items-center gap-1" title="' + escapeHtml(session.sessionName) + ': ' + session.scorePct + '%">';
        sparkHtml += '<div class="w-full rounded ' + color + '" style="height: ' + (session.scorePct * 0.8) + 'px; min-height: 20px;"></div>';
        sparkHtml += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">' + session.scorePct.toFixed(0) + '%</div>';
        sparkHtml += '</div>';
      });
      sparkHtml += '</div>';
      sparkline.innerHTML = sparkHtml;
    } else {
      sparkline.innerHTML = '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No session data</p>';
    }

    // Render topic bands
    var topicsDiv = document.getElementById('analytics-student-topics');
    var topics = Object.keys(student.topicPerformance || {});
    if (topics.length > 0) {
      var topicsHtml = '<div class="space-y-2">';
      topics.forEach(function(topic) {
        var perf = student.topicPerformance[topic];
        var pct = perf.total > 0 ? (perf.correct / perf.total * 100).toFixed(0) : 0;
        var color = pct >= 70 ? 'bg-green-500' : pct >= 50 ? 'bg-yellow-500' : 'bg-red-500';
        topicsHtml += '<div class="flex items-center gap-2">';
        topicsHtml += '<div class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white min-w-[100px]">' + escapeHtml(topic) + '</div>';
        topicsHtml += '<div class="flex-1 bg-brand-light-gray dark:bg-brand-dark-gray/30 rounded-full h-5 overflow-hidden">';
        topicsHtml += '<div class="' + color + ' h-full flex items-center justify-end px-2 text-xs text-white font-semibold" style="width: ' + pct + '%">';
        if (pct > 15) topicsHtml += pct + '%';
        topicsHtml += '</div></div>';
        topicsHtml += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">' + perf.correct + '/' + perf.total + '</div>';
        topicsHtml += '</div>';
      });
      topicsHtml += '</div>';
      topicsDiv.innerHTML = topicsHtml;
    } else {
      topicsDiv.innerHTML = '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No topic data</p>';
    }
  }

  // --- Analytics Event Listeners ---
  document.getElementById('analytics-apply-filters-btn').onclick = function() {
    var className = document.getElementById('analytics-class-filter').value;
    var dateFrom = document.getElementById('analytics-date-from').value;
    var dateTo = document.getElementById('analytics-date-to').value;
    loadAnalytics({ className: className, dateFrom: dateFrom, dateTo: dateTo });
  };

  document.getElementById('analytics-clear-filters-btn').onclick = function() {
    document.getElementById('analytics-class-filter').value = 'all';
    document.getElementById('analytics-date-from').value = '';
    document.getElementById('analytics-date-to').value = '';
    loadAnalytics({ className: 'all' });
  };

  document.getElementById('analytics-refresh-btn').onclick = function() {
    loadAnalytics(analyticsFilters);
  };

  // Tab switching
  document.querySelectorAll('.analytics-tab').forEach(function(tab) {
    tab.onclick = function() {
      var tabId = tab.id.replace('analytics-tab-', '');
      analyticsCurrentTab = tabId;

      // Update tab styles
      document.querySelectorAll('.analytics-tab').forEach(function(t) {
        t.classList.remove('bg-primary', 'text-brand-white');
        t.classList.add('text-brand-dark-gray/70', 'dark:text-brand-white/70', 'hover:bg-brand-light-gray/20', 'dark:hover:bg-brand-dark-gray/30');
      });
      tab.classList.add('bg-primary', 'text-brand-white');
      tab.classList.remove('text-brand-dark-gray/70', 'dark:text-brand-white/70', 'hover:bg-brand-light-gray/20', 'dark:hover:bg-brand-dark-gray/30');

      // Update content
      document.querySelectorAll('.analytics-tab-content').forEach(function(content) {
        content.classList.add('hidden');
      });
      document.getElementById('analytics-content-' + tabId).classList.remove('hidden');

      renderAnalyticsByTab();
    };
  });

  // Item table sorting
  document.querySelectorAll('#analytics-items-table th[data-sort]').forEach(function(th) {
    th.onclick = function() {
      var field = th.getAttribute('data-sort');
      if (analyticsItemsSort.field === field) {
        analyticsItemsSort.direction = analyticsItemsSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        analyticsItemsSort.field = field;
        analyticsItemsSort.direction = 'asc';
      }
      renderAnalyticsItems();
    };
  });

  // --- Poll Lifecycle Controls ---
  async function onStartPoll(){
    var pollId=pollSelect.value;
    if(!pollId){
      await veritasAlert('Please select a poll first.',{title:'Live poll'});
      return;
    }
    startPollBtn.disabled=true;
    clearLiveIntervals();
    isPaused=false;
    isLiveSession=true;
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .startPoll(pollId);
  }

  function onResumePoll(){
    if(pollInterval)clearInterval(pollInterval);
    pauseTimerCountdown();
    stopVisualTimer();
    timerExpiredHandled=false;
    timerActive=false;
    timerRemainingSeconds=timerPresetSeconds;
    updateTimerDisplay();
    updateTimerStatus('Timer idle.','info');
    isPaused=false;
    isLiveSession=true;
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .resumePoll();
  }

  function onStopPoll(){
    pauseTimerCountdown();
    stopVisualTimer();
    timerActive=false;
    timerRemainingSeconds=timerPresetSeconds;
    updateTimerDisplay();
    updateTimerStatus('Timer idle.','info');
    google.script.run
      .withSuccessHandler(function(data){
        isPaused=true;
        updateLiveView(data);
      })
      .withFailureHandler(handleError)
      .stopPoll();
  }

  function onEndQuestionAndShowAnswer(){
    pauseTimerCountdown();
    stopVisualTimer();
    timerActive=false;
    timerRemainingSeconds=timerPresetSeconds;
    updateTimerDisplay();
    updateTimerStatus('Timer idle.','info');
    var endShowBtn=document.getElementById('header-end-show-btn');
    if(endShowBtn){endShowBtn.disabled=true;}
    google.script.run
      .withSuccessHandler(function(data){
        if(endShowBtn){endShowBtn.disabled=false;}
        isPaused=true;
        updateLiveView(data);
      })
      .withFailureHandler(function(error){
        if(endShowBtn){endShowBtn.disabled=false;}
        handleError(error);
      })
      .endQuestionAndRevealResults();
  }

  function onPreviousQuestion(){
    if(pollInterval)clearInterval(pollInterval);
    pauseTimerCountdown();
    stopVisualTimer();
    timerExpiredHandled=false;
    timerActive=false;
    timerRemainingSeconds=timerPresetSeconds;
    updateTimerDisplay();
    updateTimerStatus('Timer ready for previous question.','info');
    isPaused=false;
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .previousQuestion();
  }

  function onNextQuestion(){
    if(pollInterval)clearInterval(pollInterval);
    pauseTimerCountdown();
    stopVisualTimer();
    timerExpiredHandled=false;
    timerActive=false;
    timerRemainingSeconds=timerPresetSeconds;
    updateTimerDisplay();
    updateTimerStatus('Timer ready for next question.','info');
    isPaused=false;
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .nextQuestion();
  }

  async function onResetQuestion(){
    var pollId=CURRENT_POLL_DATA.pollId;
    var questionIndex=CURRENT_POLL_DATA.questionIndex;
    if(!pollId||typeof questionIndex==='undefined'){
      await veritasAlert('No active question to reset.',{title:'Reset question'});
      return;
    }
    var proceed=await veritasConfirm('Reset the current question for all students?',{
      title:'Reset question',
      confirmText:'Reset question',
      destructive:true
    });
    if(!proceed){
      return;
    }
    var clearResponses=await veritasConfirm('Select OK to reset and clear responses, or Cancel to reset while keeping submissions.',{
      title:'Responses',
      confirmText:'Reset & clear',
      cancelText:'Keep submissions',
      destructive:true
    });
    pauseTimerCountdown();
    stopVisualTimer();
    timerExpiredHandled=false;
    timerActive=false;
    timerRemainingSeconds=timerPresetSeconds;
    updateTimerDisplay();
    updateTimerStatus('Timer idle.','info');

    google.script.run
      .withSuccessHandler(function(data){
        isPaused=false;
        updateLiveView(data);
      })
      .withFailureHandler(handleError)
      .resetLiveQuestion(pollId,questionIndex,clearResponses);
  }

  function onRevealResults(){
    var revealBtn=document.getElementById('reveal-results-btn');
    if(revealBtn){revealBtn.disabled=true;}
    google.script.run
      .withSuccessHandler(function(data){
        if(revealBtn){revealBtn.disabled=false;}
        updateLiveView(data);
      })
      .withFailureHandler(function(error){
        if(revealBtn){revealBtn.disabled=false;}
        handleError(error);
      })
      .revealResultsToStudents();
  }

  function onHideResults(){
    var hideBtn=document.getElementById('hide-results-btn');
    if(hideBtn){hideBtn.disabled=true;}
    google.script.run
      .withSuccessHandler(function(data){
        if(hideBtn){hideBtn.disabled=false;}
        updateLiveView(data);
      })
      .withFailureHandler(function(error){
        if(hideBtn){hideBtn.disabled=false;}
        handleError(error);
      })
      .hideResultsFromStudents();
  }

  async function onEndPoll(){
    var confirmed=await veritasConfirm('Are you sure you want to end this poll completely?',{
      title:'End poll',
      confirmText:'End poll',
      destructive:true
    });
    if(!confirmed)return;
    showDashboard();
    google.script.run
      .withSuccessHandler(function(data){
        if(data&&data.status!=='ENDED'){
          showDashboard();
        }
      })
      .withFailureHandler(handleError)
      .closePoll();
  }

  // --- Live View & Data Polling ---
  function updateLiveView(data){
    mainLoader.style.display='none';
    startPollBtn.disabled=false;

    if(!data){return;}

    var status=data.status||'PRE_LIVE';
    var metadata=data.metadata||{};
    var isCollecting=typeof metadata.isCollecting==='boolean'?metadata.isCollecting:(status==='LIVE');
    var resultsVisibility=metadata.resultsVisibility||'HIDDEN';
    var isResultsRevealed=resultsVisibility==='REVEALED';
    var isPreLive=status==='PRE_LIVE';
    var isEnded=status==='ENDED';

    if(!isLiveSession && !isPreLive){
      return;
    }

    if(isPreLive||isEnded){
      showDashboard();
      return;
    }

    if(data.error){handleError(data.error);return;}

    var previousQuestionIndex=typeof CURRENT_POLL_DATA.questionIndex==='number'?CURRENT_POLL_DATA.questionIndex:null;
    isPaused=!isCollecting;

    CURRENT_POLL_DATA.pollId=data.pollId||pollSelect.value;
    CURRENT_POLL_DATA.questionIndex=data.questionIndex;
    CURRENT_POLL_DATA.correctAnswer=data.correctAnswer;
    CURRENT_POLL_DATA.totalQuestions=data.totalQuestions;
    CURRENT_POLL_DATA.timerSeconds=data.timerSeconds||null;
    CURRENT_POLL_DATA.options=data.options||[];

    var questionChanged=previousQuestionIndex===null||data.questionIndex!==previousQuestionIndex;

    // Show live view
    setMainSection('live');
    headerDefault.style.display='none';
    headerLive.style.display='flex';

    // Update header
    document.getElementById('header-poll-name').textContent=data.pollName;

    // Update question dots
    updateQuestionDots(data.questionIndex,data.totalQuestions);

    // Enable/disable navigation buttons
    var backBtn=document.getElementById('header-back-btn');
    var nextBtn=document.getElementById('header-next-btn');
    if(backBtn){
      backBtn.disabled=data.questionIndex<=0;
      if(data.questionIndex<=0){
        backBtn.style.opacity='0.5';
        backBtn.style.cursor='not-allowed';
      } else {
        backBtn.style.opacity='1';
        backBtn.style.cursor='pointer';
      }
    }
    if(nextBtn){
      var isLastQuestion=data.questionIndex>=data.totalQuestions-1;
      nextBtn.disabled=isLastQuestion;
      if(isLastQuestion){
        nextBtn.style.opacity='0.5';
        nextBtn.style.cursor='not-allowed';
      } else {
        nextBtn.style.opacity='1';
        nextBtn.style.cursor='pointer';
      }
    }

    // Show/hide end-show/start buttons
    if(isPaused){
      document.getElementById('header-start-btn').style.display='flex';
      document.getElementById('header-end-show-btn').style.display='none';
    } else {
      document.getElementById('header-start-btn').style.display='none';
      document.getElementById('header-end-show-btn').style.display='flex';
    }

    if(questionChanged){
      var defaultSeconds=data.timerSeconds?Math.min(600,Math.max(15,parseInt(data.timerSeconds,10))):90;
      timerPresetSeconds=defaultSeconds;
      timerRemainingSeconds=timerPresetSeconds;
      timerExpiredHandled=false;
      timerActive=false;
      updateTimerInputs();
      updateTimerStatus('Timer idle.','info');
    }

    if(data.metadata){
      if(data.metadata.reason==='TIMER_EXPIRED'){
        timerRemainingSeconds=0;
        var previousState=timerActive;
        timerActive=true;
        updateTimerDisplay();
        timerActive=previousState;
        timerExpiredHandled=true;
        updateTimerStatus('Time expired — poll paused.','danger');
      } else if(data.metadata.reason==='MANUAL_PAUSE'){
        updateTimerStatus('Poll paused.','info');
      } else if(data.metadata.reason==='RESPONSES_CLOSED'){
        updateTimerStatus('Responses closed. Ready to reveal.','info');
      } else if(data.metadata.reason==='RESULTS_REVEALED'){
        updateTimerStatus('Results shared with students.','success');
      } else if(data.metadata.reason==='RESULTS_HIDDEN'){
        updateTimerStatus('Results hidden from students.','info');
      } else {
        updateTimerStatus('Timer idle.','info');
      }
    }

    // DEBUG: Log what teacher received
    console.log('=== TEACHER RECEIVED DATA ===');
    console.log('questionImageURL:', data.questionImageURL);
    console.log('options:', data.options);
    if(data.options && data.options.length>0){
      data.options.forEach(function(opt,idx){
        console.log('  Option '+idx+':', 'text="'+opt.text+'", imageURL='+opt.imageURL);
      });
    }

    // Update question display
    document.getElementById('live-question-info').textContent='Question '+(data.questionIndex+1)+' of '+data.totalQuestions;
    document.getElementById('live-question-text').textContent=data.questionText;

    // Handle question image with cache-busting
    var questionImageContainer=document.getElementById('question-image-container');
    var questionImageEl=document.getElementById('live-question-image');
    if(data.questionImageURL){
      questionImageContainer.style.display='block';

      // Add cache-busting query parameter based on question index
      // This ensures the browser re-fetches when switching questions
      var imageUrl=data.questionImageURL;
      var cacheBuster='q='+data.questionIndex;
      var separator=imageUrl.includes('?')?'&':'?';
      questionImageEl.src=imageUrl+separator+cacheBuster;
      questionImageEl.style.display='block';

      // Also set referrerpolicy for cross-origin images
      questionImageEl.setAttribute('referrerpolicy','no-referrer');
    } else {
      questionImageContainer.style.display='none';
      questionImageEl.src='';
    }

    // Update response count
    document.getElementById('response-count').textContent=data.totalResponses+' / '+data.totalStudents+' answered';

    // Update results bars
    renderResultsBars(data.results,data.correctAnswer,data.studentStatusList);

    var resultsStrip=document.getElementById('results-reveal-strip');
    if(resultsStrip){
      var hasQuestion=typeof data.questionIndex==='number'&&data.questionIndex>=0;
      // Only show the strip when results are revealed
      if(isCollecting||!hasQuestion||!isResultsRevealed){
        resultsStrip.classList.add('hidden');
      } else {
        resultsStrip.classList.remove('hidden');
        var hideBtn=document.getElementById('hide-results-btn');
        var stripNextBtn=document.getElementById('strip-next-btn');
        var stripStatus=document.getElementById('results-strip-status');
        if(hideBtn){
          hideBtn.disabled=!hasQuestion;
        }
        if(stripNextBtn){
          stripNextBtn.disabled=!hasQuestion;
        }
        if(stripStatus){
          var suffix=data.totalResponses===0?' No responses were recorded.':'';
          stripStatus.textContent='Students can now see the correct answer and results.'+suffix;
        }
      }
    }

    // Update student status
    currentStudentStatusData=data.studentStatusList;
    renderStudentStatus();

    if(pollInterval)clearInterval(pollInterval);
    if(!isPaused){
      pollInterval=setInterval(pollForResults,2500);
    }
  }

  function updateQuestionDots(current,total){
    var dotsContainer=document.getElementById('question-dots');
    dotsContainer.innerHTML='';
    for(var i=0;i<total;i++){
      var dot=document.createElement('span');
      dot.className='h-2 w-2 rounded-full '+(i===current?'bg-primary':'bg-primary/50');
      dotsContainer.appendChild(dot);
    }
  }

  function renderResultsBars(results,correctAnswer,studentsList){
    var container=document.getElementById('results-bars');
    container.innerHTML='';

    var optionDefs=Array.isArray(CURRENT_POLL_DATA.options)?CURRENT_POLL_DATA.options.slice():[];
    var knownKeys={};
    optionDefs.forEach(function(option){
      knownKeys[(option&&option.text)||'']=true;
    });

    if(results){
      Object.keys(results).forEach(function(answerText){
        if(!knownKeys[answerText||'']){
          optionDefs.push({text:answerText||'',imageURL:''});
          knownKeys[answerText||'']=true;
        }
      });
    }

    if(optionDefs.length===0){
      optionDefs=(results&&Object.keys(results).length>0)?Object.keys(results).map(function(key){return {text:key,imageURL:''};}):[];
    }

    if(optionDefs.length===0){
      container.innerHTML='<p class="text-center text-gray-500 py-4">Waiting for responses...</p>';
      return;
    }

    var total=optionDefs.reduce(function(sum,opt){
      var key=(opt&&opt.text)||'';
      var value=(results&&typeof results[key]==='number')?results[key]:0;
      return sum+value;
    },0);

    var letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ';

    optionDefs.forEach(function(option,index){
      var answerText=(option&&option.text)||'';
      var count=(results&&typeof results[answerText]==='number')?results[answerText]:0;
      var percentage=total>0?Math.round((count/total)*100):0;
      var isCorrect=answerText===correctAnswer;
      var letter=letters[index]||String(index+1);
      var imageURL=option&&option.imageURL;

      var card=document.createElement('div');
      card.className='teacher-result-card'+(isCorrect?' is-correct':'');

      var safePercentage=Math.max(0,Math.min(100,percentage));
      var progressClass='teacher-result-progress'+(isCorrect?' is-correct':'');
      var barHtml='<div class="'+progressClass+'" style="width: '+safePercentage+'%;"></div>';
      barHtml+='<div class="teacher-result-content-row">';
      barHtml+='<div class="teacher-result-leading" aria-hidden="true"><span class="teacher-result-letter">'+letter+'</span></div>';
      barHtml+='<div class="teacher-result-body">';
      if(imageURL){
        barHtml+='<div class="teacher-result-image-wrap"><img src="'+escapeHtml(imageURL)+'" class="teacher-result-image" alt="Answer '+letter+' image" referrerpolicy="no-referrer"/></div>';
      }
      if(answerText){
        barHtml+='<p class="teacher-result-text">'+escapeHtml(answerText)+'</p>';
      } else if(!imageURL){
        barHtml+='<p class="teacher-result-text teacher-result-text--empty">(No content)</p>';
      }
      barHtml+='</div>';
      barHtml+='<div class="teacher-result-percentage">'+
        '<span>'+percentage+'%</span>'+
        '<span class="teacher-result-count">'+count+' votes</span>'+
      '</div>';
      barHtml+='</div>';

      var studentsWithAnswer=Array.isArray(studentsList)?studentsList.filter(function(s){return s.answer===answerText;}):[];
      if(studentsWithAnswer.length>0){
        barHtml+='<div class="teacher-result-students">';
        studentsWithAnswer.forEach(function(student){
          barHtml+='<span class="teacher-result-student">'+escapeHtml(student.name)+'</span>';
        });
        barHtml+='</div>';
      }

      card.innerHTML=barHtml;
      container.appendChild(card);
    });
  }

  function renderStudentStatus(){
    var grid=document.getElementById('student-status-grid');
    if(!grid)return;

    grid.innerHTML='';
    currentStudentStatusData.forEach(function(student){
      var tile=document.createElement('div');

      if(student.status==='Submitted'){
        var isCorrect=student.isCorrect===true;
        var isIncorrect=student.isCorrect===false;
        var icon=isCorrect?'check_circle':(isIncorrect?'cancel':'task_alt');
        var baseColorClass=isCorrect?'bg-green-500/10 dark:bg-green-500/20':(isIncorrect?'bg-red-500/10 dark:bg-red-500/20':'bg-blue-500/10 dark:bg-blue-500/20');
        var iconClass=isCorrect?'text-green-600 dark:text-green-300':(isIncorrect?'text-red-600 dark:text-red-300':'text-blue-600 dark:text-blue-300');
        var textClass=isCorrect?'text-green-800 dark:text-green-200':(isIncorrect?'text-red-800 dark:text-red-200':'text-blue-800 dark:text-blue-200');
        var subTextClass=isCorrect?'text-green-700/80 dark:text-green-200/80':(isIncorrect?'text-red-700/80 dark:text-red-200/80':'text-blue-700/80 dark:text-blue-200/80');
        var statusLabel=isCorrect?'Correct':(isIncorrect?'Incorrect':'Submitted');
        var answerLabel=student.answer?(' • '+escapeHtml(student.answer)):'';

        tile.className='flex items-center justify-between gap-3 p-3 rounded-lg '+baseColorClass;
        tile.innerHTML='<div class="flex items-center gap-3 min-w-0">'+
          '<span class="material-symbols-outlined text-xl '+iconClass+'">'+icon+'</span>'+
          '<div class="flex flex-col min-w-0">'+
          '<span class="text-sm font-semibold '+textClass+' truncate">'+escapeHtml(student.name)+'</span>'+
          '<span class="text-xs '+subTextClass+' truncate">'+statusLabel+answerLabel+'</span>'+
          '</div></div>'+
          '<button class="reset-btn flex-shrink-0 flex items-center justify-center gap-1 h-7 px-2.5 rounded-md bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-xs font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors" data-email="'+student.email+'">'+
          '<span class="material-symbols-outlined text-sm">refresh</span><span>Reset</span></button>';
      } else if(student.status==='LOCKED'){
        var lockedDuration='';
        if(student.lockedAt){
          try {
            var lockedMs=new Date()-new Date(student.lockedAt);
            var lockedSec=Math.floor(lockedMs/1000);
            lockedDuration=' • '+lockedSec+'s';
          } catch(e){
            lockedDuration='';
          }
        }
        tile.className='flex items-center justify-between p-3 rounded-lg bg-red-500/10 dark:bg-red-500/20 gap-3';
        tile.innerHTML='<div class="flex items-center gap-3 min-w-0">'+
          '<span class="material-symbols-outlined text-xl text-red-600 dark:text-red-300">lock</span>'+
          '<div class="flex flex-col min-w-0">'+
          '<span class="text-sm font-semibold text-red-800 dark:text-red-200 truncate">'+escapeHtml(student.name)+'</span>'+
          '<span class="text-xs text-red-600 dark:text-red-300">Locked v'+(student.lockVersion||0)+lockedDuration+'</span>'+
          '</div></div>'+
          '<button class="unlock-btn flex-shrink-0 flex items-center justify-center gap-1 h-7 px-2.5 rounded-md bg-red-500/20 text-red-700 dark:bg-red-400/20 dark:text-red-200 text-xs font-semibold hover:bg-red-500/30 transition-colors" data-email="'+student.email+'" data-poll-id="'+CURRENT_POLL_DATA.pollId+'" data-lock-version="'+(student.lockVersion || 0)+'">'+
          '<span class="material-symbols-outlined text-sm">lock_open</span><span>Approve</span></button>';
      } else if(student.status==='AWAITING_FULLSCREEN'){
        tile.className='flex items-center justify-between p-3 rounded-lg bg-blue-500/10 dark:bg-blue-500/20 gap-3';
        tile.innerHTML='<div class="flex items-center gap-3 min-w-0">'+
          '<span class="material-symbols-outlined text-xl text-blue-600 dark:text-blue-300">hourglass_empty</span>'+
          '<div class="flex flex-col min-w-0">'+
          '<span class="text-sm font-semibold text-blue-800 dark:text-blue-200 truncate">'+escapeHtml(student.name)+'</span>'+
          '<span class="text-xs text-blue-600 dark:text-blue-300">Awaiting fullscreen confirmation</span>'+
          '</div></div>';
      } else if(student.status==='Waiting...'){
        tile.className='flex items-center justify-between p-3 rounded-lg bg-gray-500/10 dark:bg-gray-500/20';
        tile.innerHTML='<div class="flex items-center gap-3">'+
          '<span class="material-symbols-outlined text-xl text-gray-500 dark:text-gray-300">pending</span>'+
          '<span class="text-sm font-medium text-gray-600 dark:text-gray-300 truncate">'+escapeHtml(student.name)+'</span></div>';
      } else {
        tile.className='flex items-center justify-between p-3 rounded-lg bg-orange-500/10 dark:bg-orange-500/20';
        tile.innerHTML='<div class="flex items-center gap-3">'+
          '<span class="material-symbols-outlined text-xl text-orange-600 dark:text-orange-300">error</span>'+
          '<span class="text-sm font-medium text-orange-700 dark:text-orange-200 truncate">'+escapeHtml(student.name)+'</span></div>';
      }

      grid.appendChild(tile);
    });

    // Setup unlock listeners
    grid.querySelectorAll('.unlock-btn').forEach(function(btn){
      btn.onclick=async function(){
        var email=this.dataset.email;
        var pollId=this.dataset.pollId;
        var lockVersion = parseInt(this.dataset.lockVersion, 10);

        if(!email||!pollId)return;

        var approved=await veritasConfirm('Approve unlock for '+email+'?',{
          title:'Approve unlock',
          confirmText:'Approve'
        });
        if(!approved){
            return;
        }

        this.disabled=true;
        this.querySelector('span:last-child').textContent='Unlocking...';

        google.script.run
          .withSuccessHandler(async function(response) {
            if (response.ok) {
              currentStudentStatusData=currentStudentStatusData.map(function(s){
                if(s.email===email){
                  return {
                    name: s.name,
                    email: s.email,
                    status: 'AWAITING_FULLSCREEN',
                    lockVersion: response.lockVersion || lockVersion,
                    lockReason: s.lockReason,
                    lockedAt: s.lockedAt,
                    answer: s.answer,
                    isCorrect: s.isCorrect,
                    timestamp: s.timestamp
                  };
                }
                return s;
              });
              renderStudentStatus();
              pollForResults();
            } else if (response.reason === 'version_mismatch') {
              await veritasAlert('Student has a newer violation (v' + response.lockVersion + '). Please refresh and try again.',{
                title:'Approve unlock',
                destructive:true
              });
              pollForResults();
            } else if (response.reason === 'not_locked') {
              await veritasAlert('Student is not locked. Status: ' + (response.status || 'unknown'),{
                title:'Approve unlock'
              });
              pollForResults();
            } else {
              await veritasAlert('Unlock failed: ' + (response.reason || 'Unknown error'),{
                title:'Approve unlock',
                destructive:true
              });
              pollForResults();
            }
            btn.disabled=false;
            btn.querySelector('span:last-child').textContent='Approve';
          })
          .withFailureHandler(async function(error) {
            await veritasAlert('Error: ' + (error && error.message ? error.message : error),{
              title:'Approve unlock',
              destructive:true
            });
            btn.disabled = false;
            btn.querySelector('span:last-child').textContent = 'Approve';
          })
          .teacherApproveUnlock(email, pollId, lockVersion);
      };
    });

    grid.querySelectorAll('.reset-btn').forEach(function(btn){
      btn.onclick=function(){
        var email=this.dataset.email;
        var pollId=CURRENT_POLL_DATA.pollId;
        var questionIndex=CURRENT_POLL_DATA.questionIndex;
        if(!email||pollId===undefined||questionIndex===undefined)return;
        var button=this;
        button.disabled=true;
        button.querySelector('span:last-child').textContent='Resetting...';
        google.script.run
          .withSuccessHandler(pollForResults)
          .withFailureHandler(function(error){
            handleError(error);
            button.disabled=false;
            button.querySelector('span:last-child').textContent='Reset';
          })
          .resetStudentResponse(email,pollId,questionIndex);
      };
    });
  }

  function pollForResults(){
    if(isPaused||!isLiveSession)return;
    var pollId=CURRENT_POLL_DATA.pollId;
    var questionIndex=CURRENT_POLL_DATA.questionIndex;
    if(pollId===undefined||questionIndex===undefined)return;

    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(function(e){console.warn('Poll refresh error:',e);})
      .getLivePollData(pollId,questionIndex);
  }

  // --- Timer Controls ---
  var timerPresetSeconds = 90;
  var timerRemainingSeconds = 90;
  var timerExpiredHandled = false;
  var timerActive = false;

  function formatSeconds(seconds){
    var safeSeconds = Math.max(0, Math.round(seconds || 0));
    var minutes = Math.floor(safeSeconds/60);
    var secs = safeSeconds%60;
    return (minutes<10?'0':'')+minutes+':' + (secs<10?'0':'')+secs;
  }

  function parseTimerValue(value){
    if(!value)return null;
    var trimmed=value.trim();
    if(trimmed.length===0)return null;
    if(trimmed.includes(':')){
      var parts=trimmed.split(':');
      if(parts.length===2){
        var minutes=parseInt(parts[0],10);
        var seconds=parseInt(parts[1],10);
        if(isFinite(minutes)&&isFinite(seconds)){
          var total=(minutes*60)+seconds;
          return Math.min(600,Math.max(15,total));
        }
      }
    }
    var numeric=parseInt(trimmed,10);
    if(isFinite(numeric)){
      return Math.min(600,Math.max(15,numeric));
    }
    return null;
  }

  function updateTimerInputs(){
    var presetDisplay=document.getElementById('timer-preset-display');
    if(presetDisplay){
      presetDisplay.textContent=timerPresetSeconds+'s';
    }
    updateTimerDisplay();
  }

  function updateTimerDisplay(){
    var timerDisplay=document.getElementById('live-timer-display');
    var stateLabel=document.getElementById('timer-state-label');
    var timerBar=document.querySelector('.timer-bar');
    var toggleBtn=document.getElementById('timer-start-btn');
    var decreaseBtn=document.getElementById('timer-decrease-btn');
    var increaseBtn=document.getElementById('timer-increase-btn');
    var resetBtn=document.getElementById('timer-reset-btn');

    if(!timerDisplay)return;

    var displaySeconds;
    var state = 'paused';
    var stateText = 'Paused';

    if(timerActive){
      displaySeconds=timerRemainingSeconds;
      state = 'running';
      stateText = 'Running';
    } else if(timerExpiredHandled && timerRemainingSeconds<=0){
      displaySeconds=0;
      state = 'expired';
      stateText = "Time's Up!";
    } else {
      displaySeconds=timerRemainingSeconds>0?timerRemainingSeconds:timerPresetSeconds;
      state = 'paused';
      stateText = 'Paused';
    }

    timerDisplay.textContent = formatSeconds(displaySeconds);
    if(stateLabel) stateLabel.textContent = stateText;

    // Update timer bar state classes
    if(timerBar){
      timerBar.classList.remove('running','paused','expired');
      timerBar.classList.add(state);
    }

    // Update toggle button
    if(toggleBtn){
      toggleBtn.classList.remove('gold');
      if(timerActive){
        toggleBtn.innerHTML='<span>❚❚ Pause</span>';
        toggleBtn.classList.add('gold');
      } else {
        toggleBtn.innerHTML='<span>▶ Start</span>';
      }
      toggleBtn.disabled = (state === 'expired');
    }

    // Disable preset controls when running
    if(decreaseBtn) decreaseBtn.disabled = timerActive;
    if(increaseBtn) increaseBtn.disabled = timerActive;
    if(resetBtn) resetBtn.disabled = false;
  }

  function updateTimerStatus(message, tone){
    var statusEl=document.getElementById('timer-status-message');
    if(!statusEl)return;
    statusEl.textContent=message;
    if(tone==='danger'){
      statusEl.className='text-xs text-red-600 dark:text-red-400 text-center font-medium';
    } else if(tone==='success'){
      statusEl.className='text-xs text-green-600 dark:text-green-400 text-center font-medium';
    } else {
      statusEl.className='text-xs text-brand-dark-gray/60 dark:text-brand-white/60 text-center';
    }
  }

  function adjustTimerPreset(delta){
    if(timerActive)return;
    timerPresetSeconds = Math.min(600, Math.max(15, timerPresetSeconds + delta));
    timerRemainingSeconds = timerPresetSeconds;
    timerExpiredHandled=false;
    updateTimerInputs();
    updateTimerStatus('Preset updated to '+formatSeconds(timerPresetSeconds)+'.','info');
  }

  function startTimerCountdown(){
    if(timerActive)return;
    timerExpiredHandled=false;
    if(timerRemainingSeconds<=0){
      timerRemainingSeconds=timerPresetSeconds;
    }
    timerActive=true;
    updateTimerDisplay();
    updateTimerStatus('Timer running…','info');
    stopVisualTimer();
    visualTimerInterval=setInterval(function(){
      timerRemainingSeconds-=1;
      updateTimerDisplay();
      if(timerRemainingSeconds<=0){
        clearInterval(visualTimerInterval);
        timerActive=false;
        updateTimerDisplay();
        if(!timerExpiredHandled){
          timerExpiredHandled=true;
          updateTimerStatus('Time expired — poll paused.','danger');
          google.script.run
            .withSuccessHandler(function(data){
              isPaused=true;
              updateLiveView(data);
            })
            .withFailureHandler(handleError)
            .pausePollForTimerExpiry();
        }
      }
    },1000);
  }

  function pauseTimerCountdown(){
    if(!timerActive)return;
    timerActive=false;
    clearInterval(visualTimerInterval);
    updateTimerDisplay();
    updateTimerStatus('Timer paused at '+formatSeconds(timerRemainingSeconds)+'.','info');
  }

  function resetTimerCountdown(){
    clearInterval(visualTimerInterval);
    timerActive=false;
    timerPresetSeconds=90;
    timerRemainingSeconds=timerPresetSeconds;
    timerExpiredHandled=false;
    updateTimerInputs();
    updateTimerStatus('Timer reset to 01:30.','info');
  }

  function stopVisualTimer(){
    clearInterval(visualTimerInterval);
    visualTimerInterval=null;
  }

  // --- Student Link Controls ---
  async function onSendLink(){
    var btn=document.getElementById('send-link-btn');
    var className=btn.dataset.className;
    if(!className){
      await veritasAlert('Please select a poll first.',{title:'Send poll links'});
      return;
    }
    var confirmed=await veritasConfirm('This will email a new, unique poll link to all students in '+className+'. Are you sure?',{
      title:'Send poll links',
      confirmText:'Send links'
    });
    if(!confirmed)return;

    btn.disabled=true;
    btn.innerHTML='<div class="h-5 w-5 animate-spin rounded-full border-2 border-white border-t-transparent"></div>';

    google.script.run
      .withSuccessHandler(async function(response){
        await veritasAlert('✅ Successfully sent '+response.count+' poll links.',{title:'Send poll links'});
        btn.disabled=false;
        btn.innerHTML='<span class="material-symbols-outlined text-xl">mail</span><span class="truncate">Send Student Links</span>';
      })
      .withFailureHandler(function(err){
        handleError(err);
        btn.disabled=false;
        btn.innerHTML='<span class="material-symbols-outlined text-xl">mail</span><span class="truncate">Send Student Links</span>';
      })
      .sendPollLinkToClass(className);
  }

  async function onViewLinks(){
    var btn=document.getElementById('view-links-btn');
    var className=btn.dataset.className;
    if(!className){
      await veritasAlert('Please select a poll first.',{title:'View links'});
      return;
    }
    btn.disabled=true;

    google.script.run
      .withSuccessHandler(function(response){
        if(!response.success)return handleError(new Error('Could not load links'));

        var container=document.getElementById('links-container');
        var html='<div class="overflow-x-auto"><table class="w-full border-collapse">';
        html+='<thead><tr class="bg-brand-light-gray dark:bg-brand-dark-gray/50 border-b-2 border-brand-light-gray dark:border-brand-dark-gray/40">';
        html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Student Name</th>';
        html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Email</th>';
        html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Link</th>';
        html+='<th class="px-4 py-3 text-center text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Actions</th>';
        html+='</tr></thead><tbody>';

        response.links.forEach(function(link){
          html+='<tr class="border-b border-brand-light-gray/50 dark:border-brand-dark-gray/20 hover:bg-brand-light-gray/30 dark:hover:bg-brand-dark-gray/10">';
          html+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+escapeHtml(link.name)+'</td>';
          html+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+escapeHtml(link.email)+'</td>';
          html+='<td class="px-4 py-3 text-xs font-mono text-brand-dark-gray/70 dark:text-brand-white/70 max-w-[200px] truncate" title="'+escapeHtml(link.url)+'">'+(link.hasActiveLink?escapeHtml(link.url):'<i class="text-gray-400">No active link</i>')+'</td>';
          html+='<td class="px-4 py-3 text-center">';
          if(link.hasActiveLink){
            html+='<button class="copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors" data-url="'+escapeHtml(link.url)+'">Copy</button>';
          }
          html+='</td></tr>';
        });

        html+='</tbody></table></div>';
        container.innerHTML=html;

        container.querySelectorAll('.copy-link-btn').forEach(function(btn){
          btn.onclick=async function(){
            var url=this.dataset.url;
            try{
              var tempInput=document.createElement('input');
              document.body.appendChild(tempInput);
              tempInput.value=url;
              tempInput.select();
              document.execCommand('copy');
              document.body.removeChild(tempInput);

              btn.textContent='✓ Copied!';
              btn.className='copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-green-600 text-brand-white';
              setTimeout(function(){
                btn.textContent='Copy';
                btn.className='copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors';
              }, 2000);
            } catch(err) {
              await veritasAlert('Could not copy link. Please copy it manually.',{title:'Copy link',destructive:true});
            }
          };
        });

        linksModal.style.display='flex';
        btn.disabled=false;
      })
      .withFailureHandler(function(err){
        handleError(err);
        btn.disabled=false;
      })
      .getStudentLinksForClass(className);
  }

  function closeLinksModal(){
    linksModal.style.display='none';
  }

  function setSaveStatus(message){
    var saveStatus=document.getElementById('save-status');
    if(saveStatus){
      saveStatus.textContent=message;
    }
  }

  function markPollDirty(){
    if(!isPollDirty){
      isPollDirty=true;
    }
    setSaveStatus('Unsaved changes');
  }

  function resetPollDirty(message){
    isPollDirty=false;
    setSaveStatus(message||'All changes saved');
  }

  // --- Poll Creator Modal ---
  function openPollCreator(existingPoll){
    var saveButton=document.getElementById('save-poll-btn');

    questionCounter=0;
    questions=[];
    selectedQuestionIndex=0;

    if(existingPoll){
      editingPollId=existingPoll.pollId;
      document.getElementById('new-poll-name').value=existingPoll.pollName||'';
      if(existingPoll.className){
        refreshClassOptions(BASE_CLASSES.concat([existingPoll.className]));
      }
      classSelect.value=existingPoll.className||'';
      questions=existingPoll.questions.map(function(question){
        var answers=(question.options||[]).map(function(opt){
          return {
            text:opt.text||'',
            image:opt.imageURL||null,
            imageURL:opt.imageURL||null,
            imageFileId:opt.imageFileId||null
          };
        });
        if(answers.length<2){
          while(answers.length<2){
            answers.push({text:'',image:null,imageURL:null,imageFileId:null});
          }
        }
        var correctIndex=0;
        answers.forEach(function(answer,idx){
          if(answer.text===question.correctAnswer){
            correctIndex=idx;
          }
        });
        return {
          questionText:question.questionText||'',
          questionImage:null,
          questionImageURL:question.questionImageURL||null,
          questionImageFileId:question.questionImageFileId||null,
          answers:answers,
          correctAnswerIndex:correctIndex,
          timerSeconds:question.timerSeconds||null
        };
      });
      if(questions.length===0){
        addQuestion(true);
      }
      questionCounter=questions.length;
      selectedQuestionIndex=0;
      saveButton.innerHTML='<span class="truncate">Save Changes</span>';
      resetPollDirty('Editing existing poll');
    } else {
      editingPollId=null;
      document.getElementById('new-poll-name').value='';
      classSelect.value='';
      addQuestion(true);
      saveButton.innerHTML='<span class="truncate">Publish Poll</span>';
      resetPollDirty('All changes saved');
    }

    renderQuestionNavigator();
    renderQuestionWorkspace();
    modal.style.display='flex';
  }

  function closePollCreator(){
    modal.style.display='none';
    questions=[];
    questionCounter=0;
    selectedQuestionIndex=0;
    editingPollId=null;
    document.getElementById('save-poll-btn').innerHTML='<span class="truncate">Publish Poll</span>';
    resetPollDirty('All changes saved');
  }

  function addQuestion(suppressDirty){
    var skipDirty=suppressDirty===true;
    var newQuestion={
      questionText:'',
      questionImage:null,
      questionImageURL:null,
      questionImageFileId:null,
      answers:[
        {text:'',image:null,imageURL:null,imageFileId:null},
        {text:'',image:null,imageURL:null,imageFileId:null}
      ],
      correctAnswerIndex:0,
      timerSeconds:null
    };
    questions.push(newQuestion);
    selectedQuestionIndex=questions.length-1;
    if(!skipDirty){
      markPollDirty();
    }
    renderQuestionNavigator();
    renderQuestionWorkspace();
  }

  async function deleteQuestion(index){
    if(questions.length<=1){
      await veritasAlert('A poll must have at least one question.',{title:'Edit poll'});
      return;
    }
    questions.splice(index,1);
    selectedQuestionIndex=Math.max(0,Math.min(selectedQuestionIndex,questions.length-1));
    renderQuestionNavigator();
    renderQuestionWorkspace();
    markPollDirty();
  }

  async function duplicateQuestionLocal(index){
    if(questions.length>=50){
      await veritasAlert('Maximum 50 questions per poll. Cannot duplicate.',{title:'Edit poll'});
      return;
    }
    // Deep copy the question
    var questionToDuplicate=questions[index];
    var duplicatedQuestion=JSON.parse(JSON.stringify(questionToDuplicate));

    // Insert the duplicated question right after the original
    questions.splice(index+1,0,duplicatedQuestion);
    questionCounter++;
    selectedQuestionIndex=index+1;

    renderQuestionNavigator();
    renderQuestionWorkspace();
    markPollDirty();
  }

  function renderQuestionNavigator(){
    var nav=document.getElementById('question-navigator');
    nav.innerHTML='';
    
    questions.forEach(function(q,index){
      var isSelected=index===selectedQuestionIndex;
      var div=document.createElement('div');
      div.className='group relative flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer '+(isSelected?'bg-primary/20 dark:bg-primary/30':'hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10');
      
      var html='<span class="material-symbols-outlined '+(isSelected?'text-brand-dark-gray dark:text-brand-white':'text-brand-dark-gray/50 dark:text-brand-white/50')+'">drag_indicator</span>';
      html+='<p class="'+(isSelected?'text-primary dark:text-brand-white':'text-brand-dark-gray dark:text-brand-white')+' text-sm font-medium leading-normal">Question '+(index+1)+'</p>';

      html+='<div class="absolute right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">';
      html+='<button class="duplicate-question-btn p-1 rounded-full hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10" data-index="'+index+'" title="Duplicate question">';
      html+='<span class="material-symbols-outlined text-brand-dark-gray dark:text-brand-white text-base">content_copy</span>';
      html+='</button>';
      if(questions.length>1){
        html+='<button class="delete-question-btn p-1 rounded-full hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10" data-index="'+index+'" title="Delete question">';
        html+='<span class="material-symbols-outlined text-brand-dark-gray dark:text-brand-white text-base">close</span>';
        html+='</button>';
      }
      html+='</div>';

      div.innerHTML=html;

      div.onclick=function(e){
        if(e.target.classList.contains('material-symbols-outlined')&&(e.target.textContent==='close'||e.target.textContent==='content_copy'))return;
        selectedQuestionIndex=index;
        renderQuestionNavigator();
        renderQuestionWorkspace();
      };

      var duplicateBtn=div.querySelector('.duplicate-question-btn');
      if(duplicateBtn){
        duplicateBtn.onclick=function(e){
          e.stopPropagation();
          duplicateQuestionLocal(parseInt(this.dataset.index));
        };
      }

      var closeBtn=div.querySelector('.delete-question-btn');
      if(closeBtn){
        closeBtn.onclick=function(e){
          e.stopPropagation();
          deleteQuestion(parseInt(this.dataset.index));
        };
      }
      
      nav.appendChild(div);
    });
  }

  function renderQuestionWorkspace(){
    var workspace=document.getElementById('question-builder-workspace');
    var question=questions[selectedQuestionIndex];

    var html='<div class="max-w-4xl mx-auto">';
    html+='<div class="flex flex-wrap justify-between gap-3 mb-6">';
    html+='<div class="flex min-w-72 flex-col gap-1">';
    html+='<p class="text-brand-dark-gray dark:text-brand-white tracking-light text-[32px] font-bold leading-tight">Question '+(selectedQuestionIndex+1)+'</p>';
    html+='<p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm font-normal leading-normal">Edit the question and answer choices below.</p>';
    html+='</div></div>';

    html+='<div class="bg-brand-white dark:bg-brand-dark-gray/20 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/30 p-6 shadow-sm mb-6">';
    html+='<label class="flex flex-col w-full">';
    html+='<p class="text-brand-dark-gray dark:text-brand-white text-base font-medium leading-normal pb-2">Question Text</p>';
    html+='<textarea id="question-text-input" class="form-input flex w-full min-w-0 flex-1 resize-y overflow-hidden rounded-lg text-brand-dark-gray dark:text-brand-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 focus:border-primary min-h-36 placeholder:text-brand-dark-gray/50 dark:placeholder:text-brand-white/50 p-[15px] text-base font-normal leading-normal" placeholder="Type your question here...">'+escapeHtml(question.questionText||'')+'</textarea>';
    html+='</label>';
    html+='<div class="flex mt-4 items-center gap-3 flex-wrap">';
    html+='<label class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-light-gray dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white gap-2 pl-3 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/60 transition-colors">';
    html+='<span class="material-symbols-outlined text-xl">image</span>';
    html+='<span class="truncate">Upload Image</span>';
    html+='<input type="file" class="hidden" accept="image/*" id="question-image-input">';
    html+='</label>';
    html+='</div>';

    // Show image preview or uploading state
    var questionImagePreview=getImagePreviewUrl(question.questionImage||question.questionImageURL,question.questionImageFileId);
    var isUploading=question.questionImage==='UPLOADING';

    if(questionImagePreview||isUploading){
      html+='<div class="mt-4 flex flex-wrap items-center gap-3 bg-primary/5 dark:bg-primary/10 p-3 rounded-lg">';
      if(isUploading){
        html+='<div class="flex items-center gap-2 text-primary dark:text-brand-white">';
        html+='<div class="h-5 w-5 animate-spin rounded-full border-2 border-primary border-t-transparent"></div>';
        html+='<span class="text-sm font-medium">Uploading image...</span>';
        html+='</div>';
      } else if(questionImagePreview){
        html+='<img src="'+questionImagePreview+'" class="rounded-lg max-w-xs h-auto" referrerpolicy="no-referrer">';
        html+='<button type="button" class="remove-question-image-btn h-9 px-4 rounded-lg bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-sm font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors">Remove Image</button>';
      }
      html+='</div>';
    }

    html+='<div class="mt-4">';
    html+='<label class="text-brand-dark-gray dark:text-brand-white text-sm font-medium leading-normal block pb-2" for="question-timer-input">Suggested Timer (seconds)</label>';
    html+='<input id="question-timer-input" type="number" min="0" max="600" class="w-40 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" value="'+(question.timerSeconds||'')+'">';
    html+='<p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-1">Leave blank to control the timer manually during the live poll.</p>';
    html+='</div>';

    html+='</div>';

    html+='<div class="bg-brand-white dark:bg-brand-dark-gray/20 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/30 p-6 shadow-sm">';
    html+='<p class="text-brand-dark-gray dark:text-brand-white text-base font-medium leading-normal pb-4">Answer Choices</p>';
    html+='<div class="flex flex-col gap-4">';

    question.answers.forEach(function(answer,aIndex){
      html+=renderAnswerChoice(answer,aIndex,question.correctAnswerIndex===aIndex);
    });

    html+='</div>';
    html+='<div class="mt-4">';
    html+='<button id="add-answer-btn" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-light-gray dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/60 transition-colors">';
    html+='<span class="truncate">+ Add Answer Choice</span>';
    html+='</button></div></div></div>';

    workspace.innerHTML=html;

    document.getElementById('question-text-input').oninput=function(){
      questions[selectedQuestionIndex].questionText=this.value;
      markPollDirty();
    };

    var qImgInput=document.getElementById('question-image-input');
    if(qImgInput){
      qImgInput.onchange=function(){
        if(this.files&&this.files[0]){
          var file=this.files[0];

          // Show loading state
          var currentQuestion=questions[selectedQuestionIndex];
          currentQuestion.questionImage='UPLOADING';
          currentQuestion.questionImageURL=null;
          renderQuestionWorkspace();

          // Upload immediately to Drive
          uploadFile(file).then(function(fileId){
            // Store the fileId (not URL) - URLs generated at render time via proxy
            questions[selectedQuestionIndex].questionImageFileId=fileId;
            questions[selectedQuestionIndex].questionImage=null;
            questions[selectedQuestionIndex].questionImageURL=null;
            markPollDirty();
            renderQuestionWorkspace();
          }).catch(async function(error){
            await veritasAlert('Image upload failed: '+(error.message||error),{title:'Upload image',destructive:true});
            questions[selectedQuestionIndex].questionImage=null;
            questions[selectedQuestionIndex].questionImageFileId=null;
            questions[selectedQuestionIndex].questionImageURL=null;
            renderQuestionWorkspace();
          });
        }
      };
    }

    var removeQImgBtn=workspace.querySelector('.remove-question-image-btn');
    if(removeQImgBtn){
      removeQImgBtn.onclick=function(){
        questions[selectedQuestionIndex].questionImage=null;
        questions[selectedQuestionIndex].questionImageURL=null;
        questions[selectedQuestionIndex].questionImageFileId=null;
        markPollDirty();
        renderQuestionWorkspace();
      };
    }

    var timerInput=document.getElementById('question-timer-input');
    if(timerInput){
      timerInput.oninput=function(){
        var value=parseInt(this.value,10);
        questions[selectedQuestionIndex].timerSeconds=isNaN(value)||value<=0?null:value;
        markPollDirty();
      };
    }

    document.getElementById('add-answer-btn').onclick=function(){
      questions[selectedQuestionIndex].answers.push({text:'',image:null,imageURL:null,imageFileId:null});
      markPollDirty();
      renderQuestionWorkspace();
    };

    workspace.querySelectorAll('.answer-text-input').forEach(function(input,index){
      input.oninput=function(){
        questions[selectedQuestionIndex].answers[index].text=this.value;
        markPollDirty();
      };
    });

    workspace.querySelectorAll('.correct-radio').forEach(function(radio,index){
      radio.onchange=function(){
        if(this.checked){
          questions[selectedQuestionIndex].correctAnswerIndex=index;
          markPollDirty();
        }
      };
    });

    workspace.querySelectorAll('.delete-answer-btn').forEach(function(btn,index){
      btn.onclick=function(){
        deleteAnswer(index);
      };
    });

    workspace.querySelectorAll('.answer-image-input').forEach(function(input,index){
      input.onchange=function(){
        if(this.files&&this.files[0]){
          var file=this.files[0];

          // Show loading state
          var currentAnswer=questions[selectedQuestionIndex].answers[index];
          currentAnswer.image='UPLOADING';
          currentAnswer.imageURL=null;
          renderQuestionWorkspace();

          // Upload immediately to Drive
          uploadFile(file).then(function(fileId){
            // Store the fileId (not URL) - URLs generated at render time via proxy
            questions[selectedQuestionIndex].answers[index].imageFileId=fileId;
            questions[selectedQuestionIndex].answers[index].image=null;
            questions[selectedQuestionIndex].answers[index].imageURL=null;
            markPollDirty();
            renderQuestionWorkspace();
          }).catch(async function(error){
            await veritasAlert('Image upload failed: '+(error.message||error),{title:'Upload image',destructive:true});
            questions[selectedQuestionIndex].answers[index].image=null;
            questions[selectedQuestionIndex].answers[index].imageFileId=null;
            questions[selectedQuestionIndex].answers[index].imageURL=null;
            renderQuestionWorkspace();
          });
        }
      };
    });

    workspace.querySelectorAll('.remove-answer-image-btn').forEach(function(btn){
      btn.onclick=function(){
        var idx=parseInt(this.dataset.index,10);
        questions[selectedQuestionIndex].answers[idx].image=null;
        questions[selectedQuestionIndex].answers[idx].imageURL=null;
        questions[selectedQuestionIndex].answers[idx].imageFileId=null;
        markPollDirty();
        renderQuestionWorkspace();
      };
    });
  }

  function renderAnswerChoice(answer,index,isCorrect){
    var html='<div class="flex items-center gap-3">';
    html+='<label class="relative flex items-center justify-center cursor-pointer" title="Set as correct answer">';
    html+='<input class="correct-radio peer h-5 w-5 cursor-pointer appearance-none rounded-full border border-brand-light-gray dark:border-brand-white/30 checked:border-primary checked:bg-primary transition-all" name="correct_answer" type="radio" '+(isCorrect?'checked':'')+'/>';
    html+='<span class="material-symbols-outlined absolute text-brand-white transition-opacity opacity-0 peer-checked:opacity-100 text-sm">check</span>';
    html+='</label>';
    html+='<input class="answer-text-input form-input flex-1 rounded-lg text-brand-dark-gray dark:text-brand-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 focus:border-primary placeholder:text-brand-dark-gray/50 dark:placeholder:text-brand-white/50 p-3 text-base" placeholder="Answer '+String.fromCharCode(65+index)+'" type="text" value="'+escapeHtml(answer.text||'')+'"/>';
    html+='<label class="p-2 rounded-lg hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10 transition-colors cursor-pointer" title="Upload image for this answer">';
    html+='<span class="material-symbols-outlined text-brand-dark-gray/60 dark:text-brand-white/60">image</span>';
    html+='<input type="file" class="answer-image-input hidden" accept="image/*">';
    html+='</label>';

    if(questions[selectedQuestionIndex].answers.length>2){
      html+='<button class="delete-answer-btn p-2 rounded-lg hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10 transition-colors" title="Remove this answer">';
      html+='<span class="material-symbols-outlined text-brand-dark-gray/60 dark:text-brand-white/60">delete</span>';
      html+='</button>';
    } else {
      html+='<div class="w-10"></div>';
    }

    html+='</div>';

    // Show image preview or uploading state for answer choices
    var answerPreview=getImagePreviewUrl(answer.image||answer.imageURL,answer.imageFileId);
    var isAnswerUploading=answer.image==='UPLOADING';

    if(answerPreview||isAnswerUploading){
      html+='<div class="mt-2 flex items-center gap-3 bg-primary/5 dark:bg-primary/10 p-2 rounded-lg">';
      if(isAnswerUploading){
        html+='<div class="flex items-center gap-2 text-primary dark:text-brand-white">';
        html+='<div class="h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent"></div>';
        html+='<span class="text-xs font-medium">Uploading...</span>';
        html+='</div>';
      } else if(answerPreview){
        html+='<img src="'+answerPreview+'" class="rounded-md max-w-[160px] h-auto" referrerpolicy="no-referrer">';
        html+='<button type="button" class="remove-answer-image-btn h-8 px-3 rounded-md bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-xs font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors" data-index="'+index+'">Remove</button>';
      }
      html+='</div>';
    }

    return html;
  }

  async function deleteAnswer(index){
    if(questions[selectedQuestionIndex].answers.length<=2){
      await veritasAlert('A question must have at least two answer choices.',{title:'Edit poll'});
      return;
    }
    questions[selectedQuestionIndex].answers.splice(index,1);
    if(questions[selectedQuestionIndex].correctAnswerIndex>=index){
      questions[selectedQuestionIndex].correctAnswerIndex=Math.max(0,questions[selectedQuestionIndex].correctAnswerIndex-1);
    }
    markPollDirty();
    renderQuestionWorkspace();
  }

  // Helper to get web app base URL for generating proxy URLs
  function getWebAppUrl(){
    // Use current page URL (web app deployment URL)
    var url=window.location.href;
    // Remove query parameters
    var baseUrl=url.split('?')[0];
    return baseUrl;
  }

  // Helper to generate Google Drive thumbnail URL from fileId
  function generateProxyUrl(fileId){
    if(!fileId||typeof fileId!=='string'){
      return'';
    }
    // Use Google Drive thumbnail API for direct image display
    // sz=w1000 specifies max width of 1000px (adjustable)
    return 'https://drive.google.com/thumbnail?id='+encodeURIComponent(fileId)+'&sz=w1000';
  }

  function getImagePreviewUrl(imageData,fileId){
    // If fileId is provided, generate proxy URL
    if(fileId&&typeof fileId==='string'){
      return generateProxyUrl(fileId);
    }

    // Otherwise handle legacy data
    if(imageData instanceof File){
      return URL.createObjectURL(imageData);
    }
    if(typeof imageData==='string'&&imageData){
      // Return the URL, unless it's the special UPLOADING marker
      if(imageData==='UPLOADING'){
        return'';
      }
      return imageData;
    }
    return'';
  }

  // --- Poll & Image Uploader ---
  async function savePoll(){
    var savePollBtn=document.getElementById('save-poll-btn');
    var defaultLabel=editingPollId?'<span class="truncate">Save Changes</span>':'<span class="truncate">Publish Poll</span>';

    savePollBtn.disabled=true;
    savePollBtn.innerHTML='<div class="h-5 w-5 animate-spin rounded-full border-2 border-primary border-t-transparent"></div><span>Saving...</span>';

    var pollName=document.getElementById('new-poll-name').value.trim();
    var className=(classSelect.value||'').trim();

    if(!pollName||!className){
      await veritasAlert('Please enter a poll name and select a class.',{title:'Save poll'});
      savePollBtn.disabled=false;
      savePollBtn.innerHTML=defaultLabel;
      return;
    }

    if(questions.length===0){
      await veritasAlert('Please add at least one question.',{title:'Save poll'});
      savePollBtn.disabled=false;
      savePollBtn.innerHTML=defaultLabel;
      return;
    }

    var validationError='';
    questions.forEach(function(question,index){
      if(validationError)return;
      var questionText=(question.questionText||'').trim();
      if(questionText===''){
        validationError='Question '+(index+1)+' needs question text.';
        return;
      }
      var answerTexts=question.answers.map(function(answer){return(answer.text||'').trim();});
      var filledAnswers=answerTexts.filter(function(text){return text!=='';});
      if(filledAnswers.length<2){
        validationError='Question '+(index+1)+' must include at least two answer choices with text.';
        return;
      }
      var correctIndex=typeof question.correctAnswerIndex==='number'?question.correctAnswerIndex:0;
      if(correctIndex<0||correctIndex>=answerTexts.length){
        validationError='Question '+(index+1)+' has an invalid correct answer selection.';
        return;
      }
      if(answerTexts[correctIndex]===''){
        validationError='Question '+(index+1)+' must mark a correct answer with text.';
      }
    });

    if(validationError){
      await veritasAlert(validationError,{title:'Save poll'});
      savePollBtn.disabled=false;
      savePollBtn.innerHTML=defaultLabel;
      return;
    }

    // Check for any images still uploading
    var uploadsInProgress=false;
    var uploadMessages=[];
    questions.forEach(function(question,index){
      if(question.questionImage==='UPLOADING'){
        uploadsInProgress=true;
        uploadMessages.push('Question '+(index+1)+' image is still uploading. Please wait for upload to complete.');
      }
      question.answers.forEach(function(answer,aIndex){
        if(answer.image==='UPLOADING'){
          uploadsInProgress=true;
          uploadMessages.push('Question '+(index+1)+', answer '+(aIndex+1)+' image is still uploading. Please wait for upload to complete.');
        }
      });
    });

    if(uploadsInProgress){
      await veritasAlert(uploadMessages.join('\n'),{title:'Save poll'});
      savePollBtn.disabled=false;
      savePollBtn.innerHTML=defaultLabel;
      return;
    }

    // Build sanitized questions - all images should already be uploaded
    var sanitizedQuestions=questions.map(function(question){
      var answers=question.answers.map(function(answer){
        var text=(answer.text||'').trim();
        // Use imageFileId as canonical field (not URL)
        return{
          text:text,
          imageFileId:answer.imageFileId||null,
          imageURL:answer.imageURL||null  // Keep for backward compatibility
        };
      });

      var correctIndex=typeof question.correctAnswerIndex==='number'?question.correctAnswerIndex:0;
      if(correctIndex<0){correctIndex=0;}
      if(correctIndex>=answers.length){
        correctIndex=Math.max(0,answers.length-1);
      }

      var timerValue=null;
      if(typeof question.timerSeconds==='number'){
        timerValue=question.timerSeconds;
      } else if(typeof question.timerSeconds==='string'&&question.timerSeconds.trim()!==''){
        timerValue=parseInt(question.timerSeconds,10);
      }
      if(timerValue&&(!isFinite(timerValue)||timerValue<=0)){
        timerValue=null;
      }
      if(timerValue){
        timerValue=Math.min(Math.round(timerValue),600);
      }

      // Use questionImageFileId as canonical field (not URL)
      return{
        questionText:(question.questionText||'').trim(),
        questionImageFileId:question.questionImageFileId||null,
        questionImageURL:question.questionImageURL||null,  // Keep for backward compatibility
        answers:answers,
        correctAnswerIndex:correctIndex,
        timerSeconds:timerValue&&timerValue>0?timerValue:null
      };
    });

    try{
      var payloadQuestions=sanitizedQuestions.map(function(question){
        var options=question.answers.map(function(answer){
          var imageUrl=answer.imageURL||null;
          var imageFileId=answer.imageFileId||null;
          return{
            text:answer.text,
            image:imageUrl,
            imageURL:imageUrl,
            imageFileId:imageFileId
          };
        });
        var correctIndex=question.correctAnswerIndex;
        if(correctIndex<0||correctIndex>=options.length){
          correctIndex=Math.max(0,options.length-1);
        }
        var correctAnswerText=options[correctIndex]?options[correctIndex].text:null;
        var imageUrl=question.questionImageURL||null;
        var imageFileId=question.questionImageFileId||null;
        return{
          questionText:question.questionText,
          questionImage:imageUrl,
          questionImageURL:imageUrl,
          questionImageFileId:imageFileId,
          options:options,
          correctAnswer:correctAnswerText,
          timerSeconds:question.timerSeconds||null
        };
      });

      // Validate payload before sending
      if(!payloadQuestions||payloadQuestions.length===0){
        await veritasAlert('❌ Error: No valid questions to save. Please check your poll data.',{title:'Save poll',destructive:true});
        savePollBtn.disabled=false;
        savePollBtn.innerHTML=defaultLabel;
        return;
      }

      // Capture question count immediately for success message
      var questionCount=payloadQuestions.length;
      console.log('Saving poll with '+questionCount+' questions');

      var request=google.script.run
        .withSuccessHandler(async function(updatedPolls){
          // Use the captured questionCount variable (not from server response)
          refreshPollData(updatedPolls);
          resetPollDirty('All changes saved');
          savePollBtn.disabled=false;
          savePollBtn.innerHTML=defaultLabel;

          // Generate success message with the count we know is correct
          var successMessage=editingPollId
            ?'✅ Poll updated successfully with '+questionCount+' question'+(questionCount===1?'':'s')+'!'
            :'✅ Poll created successfully with '+questionCount+' question'+(questionCount===1?'':'s')+'!';

          console.log(successMessage);

          var shouldSelectNew=!editingPollId;
          closePollCreator();
          if(shouldSelectNew){
            pollSelect.value='';
            onPollSelectChange();
          }
          await veritasAlert(successMessage,{title:'Save poll'});
        })
        .withFailureHandler(function(error){
          console.error('Poll save error:',error);
          handleError(error);
          savePollBtn.disabled=false;
          savePollBtn.innerHTML=defaultLabel;
        });

      if(editingPollId){
        request.updatePoll(editingPollId,pollName,className,payloadQuestions);
      } else {
        request.createNewPoll(pollName,className,payloadQuestions);
      }
    } catch(err){
      console.error('Upload/save error:',err);
      await veritasAlert('❌ Upload error: '+(err.message||err),{title:'Save poll',destructive:true});
      savePollBtn.disabled=false;
      savePollBtn.innerHTML=defaultLabel;
    }
  }

  function fileToBase64(file){
    return new Promise(function(resolve,reject){
      // Validate file input
      if(!file){
        reject(new Error('No file provided'));
        return;
      }
      if(!(file instanceof File)){
        reject(new Error('Invalid file object'));
        return;
      }
      if(!file.type.startsWith('image/')){
        reject(new Error('File must be an image'));
        return;
      }
      if(file.size===0){
        reject(new Error('File is empty'));
        return;
      }
      if(file.size>5*1024*1024){
        reject(new Error('File exceeds 5MB limit'));
        return;
      }

      var reader=new FileReader();
      reader.readAsDataURL(file);
      reader.onload=function(){
        if(reader.result&&typeof reader.result==='string'){
          resolve(reader.result);
        } else {
          reject(new Error('Failed to read file data'));
        }
      };
      reader.onerror=function(error){
        reject(new Error('File read error: '+(error.message||'Unknown error')));
      };
    });
  }

  function uploadFile(file){
    return new Promise(function(resolve,reject){
      // Validate file before processing
      if(!file){
        reject(new Error('No file provided for upload'));
        return;
      }
      if(!file.name){
        reject(new Error('File has no name'));
        return;
      }

      fileToBase64(file).then(function(dataUrl){
        // Double-check dataUrl before sending
        if(!dataUrl||typeof dataUrl!=='string'){
          reject(new Error('Invalid data URL generated from file'));
          return;
        }

        google.script.run
          .withSuccessHandler(function(response){
            if(response&&response.success){
              // Server now returns fileId instead of url
              resolve(response.fileId);
            } else {
              reject(new Error(response.error||'Upload failed'));
            }
          })
          .withFailureHandler(function(error){
            reject(new Error('Server error: '+(error.message||error)));
          })
          .uploadImageToDrive(dataUrl,file.name);
      }).catch(function(error){
        reject(new Error('File conversion error: '+(error.message||error)));
      });
    });
  }

  // --- Utilities ---
  function formatDateTime(value){
    if(!value)return'—';
    var date=new Date(value);
    if(isNaN(date.getTime())){
      return value;
    }
    return date.toLocaleString();
  }

  function escapeHtml(text){
    if(!text)return'';
    var div=document.createElement('div');
    div.textContent=text;
    return div.innerHTML;
  }

  async function handleError(error){
    mainLoader.style.display='none';
    console.error('Error:',error);
    await veritasAlert('Error: '+(error&&error.message?error.message:error),{
      title:'Something went wrong',
      destructive:true
    });
  }

  // Expand question image in modal
  window.expandQuestionImage=function(){
    var imgSrc=document.getElementById('live-question-image').src;
    var modalHtml='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;" onclick="this.remove()">';
    modalHtml+='<img src="'+imgSrc+'" style="max-width:90%;max-height:90%;"/>';
    modalHtml+='</div>';
    document.body.insertAdjacentHTML('beforeend',modalHtml);
  };

  console.log('✓ Teacher Panel Ready');
})();
  </script>
  
</body>
</html>
