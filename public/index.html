<!DOCTYPE html>
<html class="light" lang="en">

<head>
  <!-- =============================================================================
     VERITAS LIVE POLL - SHARED HEAD ELEMENTS
     =============================================================================
     Purpose: Common <head> elements for all pages
     Used by: TeacherView.html, StudentView.html
     Phase: 3A - Shared Components
     ============================================================================= -->

<base target="_top">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

<!-- Material Symbols -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <title>Veritas Live Poll - Teacher Dashboard</title>

  <!-- =============================================================================
     VERITAS LIVE POLL - SHARED TAILWIND CONFIGURATION
     =============================================================================
     Purpose: Centralized Tailwind CSS configuration for design system consistency
     Used by: TeacherView.html, StudentView.html
     Phase: 3A - Shared Components
     ============================================================================= -->

<!-- Tailwind CSS CDN with Plugins -->
<script src="https://cdn.tailwindcss.com/3.3.5"></script>

<!-- Tailwind Configuration -->
<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          // Veritas Brand Colors (Primary Design System)
          "veritas-navy": "#12385d",
          "veritas-gold": "#c5a05a",
          primary: "#12385d",

          // Supporting Brand Colors
          "brand-white": "#ffffff",
          "brand-light-gray": "#d9e0e7",
          "brand-dark-gray": "#242424",
          "background-light": "#f7f8fa",
          "background-dark": "#0f1723",

          // Semantic Colors
          "success-green": "#1b5e20",
          "success-bg": "#e8f5ec",
          "error-red": "#c62828",
          "text-primary": "#111111",
          "text-secondary": "#4b5563",
          "text-muted": "#6b7280"
        },
        fontFamily: {
          display: ["Inter", "sans-serif"],
          serif: ["Noto Serif", "serif"]
        },
        borderRadius: {
          DEFAULT: "0.25rem",
          lg: "0.5rem",
          xl: "0.75rem",
          "2xl": "1rem",
          full: "9999px"
        },
        spacing: {
          '18': '4.5rem',
          '88': '22rem',
          '128': '32rem'
        },
        animation: {
          // Teacher animations
          'fade-up': 'fadeUp 0.4s ease-out forwards',
          'pulse-glow': 'pulseGlow 3s ease-in-out infinite',

          // Student animations
          'fade-in': 'fadeIn 0.6s ease-out forwards',
          'spin-slow': 'spin 3s linear infinite',
          'pulse-dot': 'pulseDot 1.2s ease-in-out infinite'
        },
        keyframes: {
          fadeUp: {
            '0%': { opacity: '0', transform: 'translateY(20px)' },
            '100%': { opacity: '1', transform: 'translateY(0)' }
          },
          pulseGlow: {
            '0%, 100%': { boxShadow: '0 0 0 0 rgba(197, 160, 90, 0.4)' },
            '50%': { boxShadow: '0 0 20px 4px rgba(197, 160, 90, 0.4)' }
          },
          fadeIn: {
            'from': { opacity: '0', transform: 'translateY(10px)' },
            'to': { opacity: '1', transform: 'translateY(0)' }
          },
          pulseDot: {
            '0%, 80%, 100%': { opacity: '0.25', transform: 'scale(0.85)' },
            '40%': { opacity: '1', transform: 'scale(1)' }
          }
        }
      }
    }
  };
</script>
  <script>
(function (global) {
  'use strict';

  function clampSeconds(value) {
    var seconds = Number(value);
    if (!isFinite(seconds)) {
      seconds = 0;
    }
    return Math.max(0, Math.floor(seconds));
  }

  function formatClock(seconds) {
    var total = clampSeconds(seconds);
    var minutes = Math.floor(total / 60);
    var remaining = total % 60;
    var m = minutes < 10 ? '0' + minutes : String(minutes);
    var s = remaining < 10 ? '0' + remaining : String(remaining);
    return m + ':' + s;
  }

  function createCountdown(options) {
    options = options || {};
    var onTick = typeof options.onTick === 'function' ? options.onTick : function () {};
    var onExpire = typeof options.onExpire === 'function' ? options.onExpire : function () {};
    var intervalId = null;
    var remaining = 0;
    var running = false;

    function clearTimer() {
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
      running = false;
    }

    function notifyTick() {
      onTick(remaining);
    }

    function tickOnce() {
      if (!running) return;
      remaining = Math.max(0, remaining - 1);
      notifyTick();
      if (remaining <= 0) {
        clearTimer();
        onExpire();
      }
    }

    return {
      start: function (seconds) {
        remaining = clampSeconds(seconds);
        clearTimer();
        if (remaining === 0) {
          notifyTick();
          onExpire();
          return;
        }
        running = true;
        notifyTick();
        intervalId = setInterval(tickOnce, 1000);
      },
      pause: function () {
        if (!running) return;
        clearTimer();
      },
      stop: function () {
        clearTimer();
      },
      add: function (deltaSeconds) {
        var next = clampSeconds(remaining + Number(deltaSeconds));
        remaining = next;
        notifyTick();
        if (remaining === 0 && running) {
          clearTimer();
          onExpire();
        }
      },
      set: function (seconds) {
        remaining = clampSeconds(seconds);
        notifyTick();
        if (remaining === 0 && running) {
          clearTimer();
          onExpire();
        }
      },
      getRemaining: function () {
        return remaining;
      },
      isRunning: function () {
        return running;
      }
    };
  }

  function createHeartbeat(options) {
    options = options || {};
    var onBeat = typeof options.onBeat === 'function' ? options.onBeat : function () {};
    var intervalMs = Math.max(500, Number(options.intervalMs) || 3000);
    var timerId = null;

    function scheduleNext() {
      timerId = setTimeout(function () {
        timerId = null;
        onBeat();
        scheduleNext();
      }, intervalMs);
    }

    return {
      start: function (fireImmediately) {
        if (timerId) return;
        if (fireImmediately) {
          onBeat();
        }
        scheduleNext();
      },
      stop: function () {
        if (timerId) {
          clearTimeout(timerId);
          timerId = null;
        }
      },
      isRunning: function () {
        return timerId !== null;
      },
      pulse: function () {
        onBeat();
      },
      updateInterval: function (nextInterval) {
        intervalMs = Math.max(500, Number(nextInterval) || intervalMs);
        if (timerId) {
          clearTimeout(timerId);
          timerId = null;
          scheduleNext();
        }
      }
    };
  }

  function createFullscreenManager(doc, options) {
    var documentRef = doc || document;
    options = options || {};
    var onChange = typeof options.onChange === 'function' ? options.onChange : function () {};
    var targetElement = options.element || documentRef.documentElement;

    function isFullscreen() {
      return !!(documentRef.fullscreenElement || documentRef.webkitFullscreenElement || documentRef.msFullscreenElement);
    }

    function request() {
      if (!targetElement) {
        return Promise.reject(new Error('No element available for fullscreen'));
      }
      var req = targetElement.requestFullscreen || targetElement.webkitRequestFullscreen || targetElement.msRequestFullscreen;
      if (!req) {
        return Promise.reject(new Error('Fullscreen API unavailable'));
      }
      return req.call(targetElement);
    }

    function exit() {
      var exitFn = documentRef.exitFullscreen || documentRef.webkitExitFullscreen || documentRef.msExitFullscreen;
      if (exitFn) {
        return exitFn.call(documentRef);
      }
      return Promise.resolve();
    }

    function handleChange() {
      onChange({
        isFullscreen: isFullscreen(),
        hidden: documentRef.hidden
      });
    }

    documentRef.addEventListener('fullscreenchange', handleChange);
    documentRef.addEventListener('webkitfullscreenchange', handleChange);
    documentRef.addEventListener('visibilitychange', handleChange);

    return {
      request: request,
      exit: exit,
      isFullscreen: isFullscreen,
      dispose: function () {
        documentRef.removeEventListener('fullscreenchange', handleChange);
        documentRef.removeEventListener('webkitfullscreenchange', handleChange);
        documentRef.removeEventListener('visibilitychange', handleChange);
      }
    };
  }

  global.SecureAssessmentShared = {
    formatClock: formatClock,
    createCountdown: createCountdown,
    createHeartbeat: createHeartbeat,
    createFullscreenManager: createFullscreenManager
  };
})(this);
</script>


  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-functions-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <script>
    var FIREBASE_CONFIG = {"apiKey":"AIzaSyAv0bCe5KIuQx_sou8toBy5DG2PYaB_pBM","authDomain":"classroomproctor.firebaseapp.com","databaseURL":"https://classroomproctor-default-rtdb.firebaseio.com","projectId":"classroomproctor","storageBucket":"classroomproctor.firebasestorage.app","messagingSenderId":"600627073908","appId":"1:600627073908:web:935970f5849b28f6ad5221"};
    if (!FIREBASE_CONFIG) {
      console.warn('FIREBASE_CONFIG missing, using default fallback.');
      FIREBASE_CONFIG = {
        apiKey: "AIzaSyAv0bCe5KIuQx_sou8toBy5DG2PYaB_pBM",
        authDomain: "classroomproctor.firebaseapp.com",
        databaseURL: "https://classroomproctor-default-rtdb.firebaseio.com",
        projectId: "classroomproctor",
        storageBucket: "classroomproctor.firebasestorage.app",
        messagingSenderId: "600627073908",
        appId: "1:600627073908:web:935970f5849b28f6ad5221"
      };
      window.USING_FALLBACK_CONFIG = true;
    }
    var Veritas = Veritas || {};
    Veritas.Config = Veritas.Config || {};
    Veritas.Config.DEBUG_FIREBASE = <?!= Veritas.Config.DEBUG_FIREBASE ? 'true' : 'false' ?>;
  </script>

  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <!-- =============================================================================
     VERITAS LIVE POLL - SHARED CSS CUSTOM PROPERTIES
     =============================================================================
     Purpose: Centralized CSS variables for design system consistency
     Used by: TeacherView.html, StudentView.html
     Phase: 3A - Shared Components
     ============================================================================= -->

<style>
  /* Veritas Design System - CSS Custom Properties */
  :root {
    /* Brand Colors */
    --veritas-navy: #12385d;
    --veritas-gold: #c5a05a;
    --brand-white: #ffffff;
    --brand-light-gray: #d9e0e7;
    --brand-dark-gray: #242424;

    /* Background Colors */
    --bg-light: #f7f8fa;
    --bg-dark: #0f1723;
    --bg-card: #ffffff;
    --bg-elevated: #f8fafc;
    --bg-glass: rgba(255, 255, 255, 0.7);
    --bg-glass-dark: rgba(15, 23, 42, 0.7);

    /* Text Colors */
    --text-primary: #111111;
    --text-secondary: #4b5563;
    --text-muted: #6b7280;
    --text-on-navy: #ffffff;

    /* Semantic Colors */
    --success-green: #1b5e20;
    --success-light: #2e7d32;
    --success-bg: #e8f5ec;
    --success-bg-light: #ecfdf5;
    --error-red: #c62828;

    /* Opacity Modifiers */
    --navy-06: rgba(18, 56, 93, 0.06);
    --navy-10: rgba(18, 56, 93, 0.1);
    --navy-12: rgba(18, 56, 93, 0.12);
    --navy-14: rgba(18, 56, 93, 0.14);
    --gold-08: rgba(197, 160, 90, 0.08);

    /* Spacing Scale (following 8px baseline) */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 32px;
    --space-2xl: 48px;

    /* Border Radius */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 14px;
    --radius-xl: 16px;
    --radius-2xl: 24px;
    --radius-full: 9999px;

    /* Depth & Glassmorphism */
    --glass-blur: blur(12px);
    --glass-border: rgba(255, 255, 255, 0.2);
    --glass-border-dark: rgba(255, 255, 255, 0.1);
    --shadow-glass: 0 8px 32px 0 rgba(18, 56, 93, 0.1);
    --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

    /* Interactive Glows */
    --glow-navy: 0 0 15px rgba(18, 56, 93, 0.3);
    --glow-gold: 0 0 15px rgba(197, 160, 90, 0.3);

    /* Enhanced Semantic Colors (WCAG AA Compliant) */
    --primary: #12385d;
    --primary-hover: #0f2d4a;
    --primary-light: #1a4a7a;
    --secondary: #c5a05a;
    --secondary-hover: #b08f4d;

    /* Status Colors with Better Contrast */
    --success: #16a34a;
    --success-bg: #dcfce7;
    --success-border: #86efac;
    --warning: #f59e0b;
    --warning-bg: #fef3c7;
    --warning-border: #fcd34d;
    --error: #dc2626;
    --error-bg: #fee2e2;
    --error-border: #fca5a5;
    --info: #3b82f6;
    --info-bg: #dbeafe;
    --info-border: #93c5fd;

    /* Interactive States */
    --focus-ring: 0 0 0 3px rgba(18, 56, 93, 0.2);
    --hover-lift: 0 4px 12px rgba(0, 0, 0, 0.1);
    --active-press: 0 2px 4px rgba(0, 0, 0, 0.1);

    /* Typography Scale */
    --text-xs: 0.75rem;
    /* 12px */
    --text-sm: 0.875rem;
    /* 14px */
    --text-base: 1rem;
    /* 16px */
    --text-lg: 1.125rem;
    /* 18px */
    --text-xl: 1.25rem;
    /* 20px */
    --text-2xl: 1.5rem;
    /* 24px */
    --text-3xl: 1.875rem;
    /* 30px */
    --text-4xl: 2.25rem;
    /* 36px */

    /* Line Heights */
    --leading-tight: 1.25;
    --leading-normal: 1.5;
    --leading-relaxed: 1.75;

    /* Animation Timings */
    --duration-fast: 150ms;
    --duration-normal: 200ms;
    --duration-slow: 300ms;
    --ease-out: cubic-bezier(0.4, 0, 0.2, 1);
    --ease-in-out: cubic-bezier(0.4, 0, 0.6, 1);
  }
</style>
  <style type="text/tailwindcss">
  @layer utilities {
      .correct-answer-bg {
        background-image: repeating-linear-gradient(
          45deg,
          rgba(217, 224, 231, 0.7),
          rgba(217, 224, 231, 0.7) 10px,
          rgba(217, 224, 231, 1) 10px,
          rgba(217, 224, 231, 1) 20px
        );
      }
      .dark .correct-answer-bg {
        background-image: repeating-linear-gradient(
          45deg,
          rgba(0, 46, 109, 0.2),
          rgba(0, 46, 109, 0.2) 10px,
          rgba(0, 46, 109, 0.3) 10px,
          rgba(0, 46, 109, 0.3) 20px
        );
      }
    }
  </style>
<style>
  /* Veritas Design System - CSS Custom Properties */
  :root {
    /* Brand Colors */
    --veritas-navy: #12385d;
    --veritas-gold: #c5a05a;
    --brand-white: #ffffff;
    --brand-light-gray: #d9e0e7;
    --brand-dark-gray: #242424;

    /* Background Colors */
    --bg-light: #f7f8fa;
    --bg-dark: #0f1723;
    --bg-card: #ffffff;
    --bg-elevated: #f8fafc;

    /* Text Colors */
    --text-primary: #111111;
    --text-secondary: #4b5563;
    --text-muted: #6b7280;
    --text-on-navy: #ffffff;

    /* Semantic Colors */
    --success-green: #1b5e20;
    --success-light: #2e7d32;
    --success-bg: #e8f5ec;
    --success-bg-light: #ecfdf5;
    --error-red: #c62828;

    /* Opacity Modifiers */
    --navy-06: rgba(18, 56, 93, 0.06);
    --navy-10: rgba(18, 56, 93, 0.1);
    --navy-12: rgba(18, 56, 93, 0.12);
    --navy-14: rgba(18, 56, 93, 0.14);
    --gold-08: rgba(197, 160, 90, 0.08);

    /* Spacing Scale (following 8px baseline) */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 32px;
    --space-2xl: 48px;

    /* Border Radius */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 14px;
    --radius-xl: 16px;
    --radius-full: 9999px;

    /* View Transitions Names */
    --vt-header: header-main;
    --vt-sidebar: sidebar-main;
    --vt-content: content-main;

    /* Animation Timing */
    --transition-smooth: 400ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-fast: 200ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-bounce: 500ms cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .motion-safe-transition {
    transition: all var(--transition-smooth);
  }

  .motion-pulse {
    animation: motion-pulse 2s infinite ease-in-out;
  }

  .motion-slide-up {
    animation: motion-slide-up var(--transition-smooth) forwards;
  }

  .motion-slide-in-right {
    animation: motion-slide-in-right var(--transition-smooth) forwards;
  }

  .motion-fade-in {
    animation: motion-fade-in var(--transition-fast) forwards;
  }

  @keyframes motion-pulse {

    0%,
    100% {
      transform: scale(1);
      opacity: 0.8;
    }

    50% {
      transform: scale(1.15);
      opacity: 1;
    }
  }

  @keyframes motion-slide-up {
    from {
      transform: translateY(12px);
      opacity: 0;
    }

    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes motion-slide-in-right {
    from {
      transform: translateX(20px);
      opacity: 0;
    }

    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes motion-fade-in {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  /* View Transition Assignments */
  #header-default,
  #header-live {
    view-transition-name: var(--vt-header);
  }

  #dashboard-sidebar {
    view-transition-name: var(--vt-sidebar);
  }

  main {
    view-transition-name: var(--vt-content);
  }

  /* Glassmorphism Utilities */
  .glass-card {
    background: var(--bg-glass);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border: 1px solid var(--glass-border);
    box-shadow: var(--shadow-glass);
  }

  .dark .glass-card {
    background: var(--bg-glass-dark);
    border-color: var(--glass-border-dark);
  }

  .premium-shadow {
    box-shadow: var(--shadow-premium);
  }

  .premium-glow-navy:hover {
    box-shadow: var(--glow-navy);
  }

  .premium-glow-gold:hover {
    box-shadow: var(--glow-gold);
  }

  .teacher-question-image {
    position: relative;
    border-radius: var(--radius-md);
    overflow: hidden;
    background: var(--navy-06);
    border: 1px solid var(--navy-12);
  }

  /* ========================================
     PREMIUM BUTTON INTERACTIONS
     ======================================== */
  .btn-primary,
  .btn-secondary,
  .btn-success {
    position: relative;
    overflow: hidden;
    transition: all var(--duration-normal) var(--ease-out);
  }

  .btn-primary::before,
  .btn-secondary::before,
  .btn-success::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
    pointer-events: none;
  }

  .btn-primary:active::before,
  .btn-secondary:active::before,
  .btn-success:active::before {
    width: 300px;
    height: 300px;
  }

  .btn-primary:hover:not(:disabled),
  .btn-secondary:hover:not(:disabled),
  .btn-success:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--hover-lift);
  }

  .btn-primary:active:not(:disabled),
  .btn-secondary:active:not(:disabled),
  .btn-success:active:not(:disabled) {
    transform: translateY(0);
    box-shadow: var(--active-press);
  }

  .btn-primary:focus-visible,
  .btn-secondary:focus-visible,
  .btn-success:focus-visible {
    outline: none;
    box-shadow: var(--focus-ring);
  }

  /* ========================================
     LOADING SKELETONS
     ======================================== */
  .skeleton {
    background: linear-gradient(90deg,
        #f0f0f0 25%,
        #e0e0e0 50%,
        #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: var(--radius-sm);
  }

  .dark .skeleton {
    background: linear-gradient(90deg,
        #2a2a2a 25%,
        #1a1a1a 50%,
        #2a2a2a 75%);
    background-size: 200% 100%;
  }

  @keyframes shimmer {
    0% {
      background-position: 200% 0;
    }

    100% {
      background-position: -200% 0;
    }
  }

  .skeleton-card {
    padding: 1.5rem;
    border: 1px solid var(--brand-light-gray);
    border-radius: var(--radius-lg);
  }

  .skeleton-header {
    height: 24px;
    width: 60%;
    margin-bottom: 1rem;
  }

  .skeleton-line {
    height: 16px;
    width: 100%;
    margin-bottom: 0.75rem;
  }

  .skeleton-line.short {
    width: 70%;
  }

  /* ========================================
     ENHANCED TOAST NOTIFICATIONS
     ======================================== */
  .toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-width: 400px;
  }

  .toast {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem;
    border-radius: var(--radius-lg);
    background: white;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    border-left: 4px solid;
    min-width: 300px;
  }

  .toast-success {
    border-left-color: var(--success);
    background: var(--success-bg);
  }

  .toast-error {
    border-left-color: var(--error);
    background: var(--error-bg);
  }

  .toast-warning {
    border-left-color: var(--warning);
    background: var(--warning-bg);
  }

  .toast-info {
    border-left-color: var(--info);
    background: var(--info-bg);
  }

  .toast-icon {
    font-size: 24px;
    flex-shrink: 0;
  }

  .toast-success .toast-icon {
    color: var(--success);
  }

  .toast-error .toast-icon {
    color: var(--error);
  }

  .toast-warning .toast-icon {
    color: var(--warning);
  }

  .toast-info .toast-icon {
    color: var(--info);
  }

  .toast-content {
    flex: 1;
    min-width: 0;
  }

  .toast-title {
    font-weight: 600;
    font-size: var(--text-sm);
    margin-bottom: 0.25rem;
    color: var(--text-primary);
  }

  .toast-message {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    line-height: var(--leading-normal);
  }

  .toast-close {
    flex-shrink: 0;
    padding: 0.25rem;
    border-radius: var(--radius-sm);
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--text-muted);
    transition: all var(--duration-fast) var(--ease-out);
  }

  .toast-close:hover {
    background: rgba(0, 0, 0, 0.05);
    color: var(--text-primary);
  }

  @keyframes slide-in {
    from {
      transform: translateX(100%);
      opacity: 0;
    }

    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slide-out {
    from {
      transform: translateX(0);
      opacity: 1;
    }

    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  .animate-slide-in {
    animation: slide-in var(--duration-normal) var(--ease-out);
  }

  .animate-slide-out {
    animation: slide-out var(--duration-normal) var(--ease-out);
  }

  /* ========================================
     EMPTY STATES
     ======================================== */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    max-width: 400px;
    margin: 0 auto;
  }

  .empty-state-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    border-radius: 50%;
    background: var(--navy-06);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .empty-state-icon .material-symbols-outlined {
    font-size: 40px;
    color: var(--primary);
  }

  .empty-state h3 {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .empty-state p {
    font-size: var(--text-base);
    color: var(--text-secondary);
    line-height: var(--leading-relaxed);
    margin-bottom: 1.5rem;
  }

  /* ========================================
     PROGRESS INDICATORS
     ======================================== */
  .progress-tracker {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
  }

  .progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
  }

  .step-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: var(--text-sm);
    background: var(--brand-light-gray);
    color: var(--text-muted);
    transition: all var(--duration-normal) var(--ease-out);
  }

  .progress-step.completed .step-icon {
    background: var(--success);
    color: white;
  }

  .progress-step.active .step-icon {
    background: var(--primary);
    color: white;
    box-shadow: 0 0 0 4px rgba(18, 56, 93, 0.1);
  }

  .step-icon.spinner {
    border: 2px solid var(--brand-light-gray);
    border-top-color: var(--primary);
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .progress-step span {
    font-size: var(--text-xs);
    color: var(--text-muted);
    font-weight: 500;
  }

  .progress-step.active span {
    color: var(--primary);
    font-weight: 600;
  }

  .progress-step.completed span {
    color: var(--success);
  }

  /* ========================================
     MOBILE TOUCH TARGET OPTIMIZATION
     ======================================== */
  /* Ensure minimum 44x44px touch targets for accessibility */
  button,
  .btn,
  .icon-btn,
  input[type="checkbox"],
  input[type="radio"],
  a.clickable,
  [role="button"] {
    min-width: 44px;
    min-height: 44px;
  }

  /* Larger tap areas for mobile devices */
  @media (max-width: 768px) {

    .btn,
    button {
      padding: 12px 24px;
      font-size: 16px;
      /* Prevents iOS zoom on focus */
    }

    input,
    select,
    textarea {
      font-size: 16px;
      /* Prevents iOS zoom */
    }

    /* Increase spacing for easier tapping */
    .btn+.btn {
      margin-left: 12px;
    }

    /* Mobile-friendly navigation */
    .mobile-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--brand-light-gray);
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: color var(--duration-fast) var(--ease-out);
      min-width: 64px;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-item .material-symbols-outlined {
      font-size: 24px;
    }

    .nav-item span:last-child {
      font-size: 11px;
      font-weight: 500;
    }

    /* Add padding to main content to account for bottom nav */
    body.has-mobile-nav main {
      padding-bottom: 80px;
    }
  }

  /* ========================================
     IMPROVED ERROR HANDLING
     ======================================== */
  .error-message {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    border-radius: var(--radius-lg);
    background: var(--error-bg);
    border-left: 4px solid var(--error);
    margin: 16px 0;
  }

  .error-message .material-symbols-outlined {
    color: var(--error);
    font-size: 24px;
    flex-shrink: 0;
  }

  .error-content {
    flex: 1;
  }

  .error-title {
    font-weight: 600;
    color: var(--error);
    margin-bottom: 4px;
  }

  .error-description {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    line-height: var(--leading-normal);
  }

  .error-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }

  .error-action-btn {
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    font-size: var(--text-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);
  }

  .error-action-primary {
    background: var(--error);
    color: white;
    border: none;
  }

  .error-action-primary:hover {
    background: var(--error-red);
  }

  .error-action-secondary {
    background: transparent;
    color: var(--error);
    border: 1px solid var(--error);
  }

  .error-action-secondary:hover {
    background: var(--error-bg);
  }

  /* Warning variant */
  .warning-message {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    border-radius: var(--radius-lg);
    background: var(--warning-bg);
    border-left: 4px solid var(--warning);
    margin: 16px 0;
  }

  .warning-message .material-symbols-outlined {
    color: var(--warning);
    font-size: 24px;
    flex-shrink: 0;
  }

  .warning-title {
    font-weight: 600;
    color: var(--warning);
    margin-bottom: 4px;
  }

  /* Info variant */
  .info-message {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    border-radius: var(--radius-lg);
    background: var(--info-bg);
    border-left: 4px solid var(--info);
    margin: 16px 0;
  }

  .info-message .material-symbols-outlined {
    color: var(--info);
    font-size: 24px;
    flex-shrink: 0;
  }

  .info-title {
    font-weight: 600;
    color: var(--info);
    margin-bottom: 4px;
  }

  .teacher-question-image-el {
    width: 100%;
    max-height: 360px;
    object-fit: contain;
    display: block;
    background: var(--bg-card);
  }

  .teacher-question-image-zoom {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(18, 24, 40, 0.45);
    color: var(--brand-white);
    opacity: 0;
    transition: opacity 180ms ease;
    border: none;
    cursor: pointer;
  }

  .teacher-question-image:hover .teacher-question-image-zoom,
  .teacher-question-image-zoom:focus-visible {
    opacity: 1;
  }

  .teacher-question-image-zoom:focus-visible {
    outline: 3px solid rgba(18, 56, 93, 0.45);
    outline-offset: 2px;
  }

  /* Student-view-style question layout */
  .question-layout-grid {
    display: block;
    /* Change from grid to block for float wrapping */
    width: 100%;
    position: relative;
    overflow: hidden;
    /* Clearfix behavior */
  }

  .question-layout-grid.no-image {
    display: block;
  }

  .question-text-area {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .question-stem-text {
    font-family: "Noto Serif", serif;
    font-size: 1.125rem;
    /* Standardized to 18px */
    line-height: 1.6;
    font-weight: 400;
    color: #000000;
    margin: 0;
    text-align: left;
    word-wrap: break-word;
  }

  .dark .question-stem-text {
    color: #ffffff;
  }

  .question-image-area {
    float: right;
    /* Standard wrap behavior */
    margin-left: 24px;
    margin-bottom: 12px;
    max-width: min(320px, 40%);
    /* Capped width for wrap */
    display: flex;
    justify-content: flex-end;
  }

  .question-image-frame {
    width: 100%;
    max-height: min(420px, 50vh);
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 10px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .question-image-clickable {
    max-height: 100%;
    width: 100%;
    object-fit: contain;
    border-radius: 8px;
    cursor: zoom-in;
    transition: transform 0.2s ease;
  }

  .question-image-clickable:hover {
    transform: scale(1.02);
  }

  .dark .question-image-frame {
    background: rgba(36, 36, 36, 0.55);
    border-color: rgba(255, 255, 255, 0.18);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
  }

  .teacher-result-card {
    position: relative;
    overflow: hidden;
    border-radius: var(--radius-md);
    border: 1px solid var(--navy-14);
    background: var(--bg-card);
    box-shadow: 0 1px 4px rgba(18, 56, 93, 0.06);
    margin-bottom: 10px;
  }

  .teacher-result-card:last-child {
    margin-bottom: 0;
  }

  .teacher-result-progress {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 0%;
    background: rgba(18, 56, 93, 0.12);
    transition: width 220ms ease;
  }

  .teacher-result-progress.is-correct {
    background: rgba(46, 125, 50, 0.2);
  }

  .teacher-result-content-row {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: stretch;
    gap: 12px;
    padding: 12px 16px;
  }

  .teacher-result-leading {
    display: flex;
    align-items: center;
  }

  .teacher-result-letter {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: var(--navy-12);
    color: var(--veritas-navy);
    font-weight: 700;
    font-size: 0.95rem;
  }

  .teacher-result-body {
    flex: 1;
    display: flex;
    gap: 10px;
    align-items: flex-start;
    min-width: 0;
  }

  .teacher-result-image-wrap {
    width: 80px;
    max-width: 80px;
    flex-shrink: 0;
  }

  .teacher-result-image {
    width: 100%;
    max-height: 80px;
    object-fit: contain;
    border-radius: 6px;
    border: 1px solid rgba(18, 56, 93, 0.18);
    background: var(--bg-elevated);
  }

  .teacher-result-text {
    color: var(--veritas-navy);
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .teacher-result-text--empty {
    font-style: italic;
    color: var(--text-muted);
  }

  .teacher-result-percentage {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    justify-content: center;
    gap: 2px;
    min-width: 70px;
    color: var(--veritas-navy);
    font-weight: 700;
  }

  .teacher-result-percentage span:first-child {
    font-size: 0.95rem;
  }

  .teacher-result-count {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .teacher-result-students {
    position: relative;
    z-index: 1;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    padding: 8px 16px 10px;
    border-top: 1px solid var(--navy-12);
    background: var(--navy-06);
  }

  .teacher-result-student {
    font-size: 0.7rem;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: var(--radius-full);
    background: rgba(18, 56, 93, 0.15);
    color: var(--veritas-navy);
  }

  .teacher-result-card.is-correct {
    border-color: rgba(46, 125, 50, 0.4);
    background: var(--success-bg);
  }

  .teacher-result-card.is-correct .teacher-result-letter {
    background: rgba(46, 125, 50, 0.22);
    color: var(--success-green);
  }

  .teacher-result-card.is-correct .teacher-result-text {
    color: var(--success-green);
  }

  .teacher-result-card.is-correct .teacher-result-count {
    color: var(--success-light);
  }

  .teacher-result-card.is-correct .teacher-result-students {
    border-color: rgba(46, 125, 50, 0.28);
    background: rgba(46, 125, 50, 0.16);
  }

  .teacher-result-card.is-correct .teacher-result-student {
    background: rgba(46, 125, 50, 0.2);
    color: var(--success-green);
  }

  /* Live view layout guards to prevent clipping at the bottom of the dashboard */
  #live-view,
  .live-view-shell,
  .live-view-grid {
    min-height: 0;
  }

  .live-view-grid>* {
    min-height: 0;
  }

  .dark .teacher-question-image {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.18);
  }

  .dark .teacher-question-image-el {
    background: transparent;
  }

  .dark .teacher-question-image-zoom {
    background: rgba(15, 23, 42, 0.65);
  }

  .dark .teacher-result-card {
    background: rgba(15, 23, 35, 0.78);
    border-color: rgba(148, 163, 184, 0.28);
    box-shadow: 0 2px 8px rgba(15, 23, 42, 0.4);
  }

  .dark .teacher-result-progress {
    background: rgba(59, 130, 246, 0.28);
  }

  .dark .teacher-result-letter {
    background: rgba(148, 163, 184, 0.25);
    color: #e2e8f0;
  }

  .dark .teacher-result-text {
    color: #f8fafc;
  }

  .dark .teacher-result-count {
    color: #cbd5f5;
  }

  .dark .teacher-result-students {
    border-color: rgba(148, 163, 184, 0.25);
    background: rgba(148, 163, 184, 0.16);
  }

  .dark .teacher-result-student {
    background: rgba(148, 163, 184, 0.3);
    color: #f8fafc;
  }

  .dark .teacher-result-card.is-correct {
    background: rgba(34, 197, 94, 0.22);
    border-color: rgba(34, 197, 94, 0.45);
  }

  .dark .teacher-result-card.is-correct .teacher-result-letter {
    background: rgba(34, 197, 94, 0.32);
    color: #ecfdf5;
  }

  .dark .teacher-result-card.is-correct .teacher-result-text {
    color: #ecfdf5;
  }

  .dark .teacher-result-card.is-correct .teacher-result-count {
    color: #bbf7d0;
  }

  .dark .teacher-result-card.is-correct .teacher-result-students {
    border-color: rgba(34, 197, 94, 0.45);
    background: rgba(34, 197, 94, 0.3);
  }

  .dark .teacher-result-card.is-correct .teacher-result-student {
    background: rgba(34, 197, 94, 0.4);
    color: #052e16;
  }

  @media (max-width: 768px) {
    .teacher-result-content-row {
      flex-direction: column;
      align-items: flex-start;
    }

    .teacher-result-percentage {
      flex-direction: row;
      align-items: center;
      gap: 8px;
    }

    .teacher-result-image-wrap {
      width: 100%;
      max-width: 100%;
    }

    .teacher-result-image {
      max-height: 220px;
    }
  }

  .veritas-modal-root {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .veritas-modal-root.is-active {
    display: flex;
  }

  .veritas-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(9, 17, 34, 0.55);
    backdrop-filter: blur(3px);
  }

  .veritas-modal-dialog {
    position: relative;
    z-index: 1;
    width: min(520px, 92vw);
    border-radius: 16px;
    background: #ffffff;
    border-top: 4px solid #c5a05a;
    box-shadow: 0 24px 48px rgba(9, 17, 34, 0.25);
    padding: 28px;
    display: flex;
    flex-direction: column;
    gap: 18px;
    animation: veritas-modal-in 220ms ease;
  }

  .veritas-modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
    color: #12385d;
    font-weight: 700;
  }

  .veritas-modal-body {
    display: flex;
    flex-direction: column;
    gap: 12px;
    color: #1c1c1c;
    font-size: 0.98rem;
    line-height: 1.55;
  }

  .veritas-modal-subtext {
    color: #4b5563;
    font-size: 0.85rem;
  }

  .veritas-modal-input {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .veritas-modal-input input {
    border-radius: 10px;
    border: 1px solid rgba(18, 56, 93, 0.28);
    padding: 10px 12px;
    font-size: 0.95rem;
    transition: border-color 160ms ease, box-shadow 160ms ease;
  }

  .veritas-modal-input input:focus-visible {
    outline: none;
    border-color: #12385d;
    box-shadow: 0 0 0 3px rgba(18, 56, 93, 0.2);
  }

  .veritas-modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    flex-wrap: wrap;
  }

  .veritas-modal-button {
    border: none;
    border-radius: 999px;
    padding: 10px 22px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: transform 140ms ease, box-shadow 140ms ease, background-color 140ms ease, color 140ms ease;
  }

  .veritas-modal-button.primary {
    background: #12385d;
    color: #ffffff;
    box-shadow: 0 8px 20px rgba(18, 56, 93, 0.25);
  }

  .veritas-modal-button.primary:hover:not([disabled]) {
    background: #0f2d4a;
    transform: translateY(-1px);
  }

  .veritas-modal-button.secondary {
    background: transparent;
    color: #12385d;
    border: 1px solid rgba(18, 56, 93, 0.3);
  }

  .veritas-modal-button.secondary:hover:not([disabled]) {
    background: rgba(18, 56, 93, 0.08);
  }

  .veritas-modal-button.destructive {
    background: #c62828;
    color: #ffffff;
    box-shadow: 0 8px 18px rgba(198, 40, 40, 0.25);
  }

  .veritas-modal-button.destructive:hover:not([disabled]) {
    background: #a61b1b;
  }

  .veritas-modal-button[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .veritas-modal-spinner {
    width: 18px;
    height: 18px;
    border-radius: 999px;
    border: 2px solid rgba(255, 255, 255, 0.6);
    border-top-color: transparent;
    animation: veritas-spin 0.7s linear infinite;
    display: none;
    margin-left: 10px;
  }

  .veritas-modal-button.loading .veritas-modal-spinner {
    display: inline-block;
  }

  .veritas-modal-button.loading span {
    opacity: 0.75;
  }

  .dark .veritas-modal-dialog {
    background: rgba(15, 23, 35, 0.96);
    color: #e2e8f0;
    border-top-color: #c5a05a;
    box-shadow: 0 24px 48px rgba(2, 6, 23, 0.55);
  }

  .dark .veritas-modal-header h2 {
    color: #f8fafc;
  }

  .dark .veritas-modal-body {
    color: #f1f5f9;
  }

  .dark .veritas-modal-subtext {
    color: #cbd5f5;
  }

  .dark .veritas-modal-input input {
    background: rgba(15, 23, 42, 0.7);
    border-color: rgba(148, 163, 184, 0.4);
    color: #f8fafc;
  }

  .dark .veritas-modal-input input:focus-visible {
    border-color: #93c5fd;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35);
  }

  .dark .veritas-modal-button.secondary {
    color: #e2e8f0;
    border-color: rgba(148, 163, 184, 0.4);
  }

  .dark .veritas-modal-button.secondary:hover:not([disabled]) {
    background: rgba(148, 163, 184, 0.16);
  }

  .dark .veritas-modal-button.primary {
    background: #234776;
  }

  .dark .veritas-modal-button.primary:hover:not([disabled]) {
    background: #1a3456;
  }

  .dark .veritas-modal-backdrop {
    background: rgba(2, 6, 23, 0.7);
    backdrop-filter: blur(4px);
  }

  body.veritas-modal-open {
    overflow: hidden;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  @keyframes veritas-modal-in {
    from {
      opacity: 0;
      transform: translateY(16px) scale(0.98);
    }

    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes veritas-spin {
    from {
      transform: rotate(0deg);
    }

    to {
      transform: rotate(360deg);
    }
  }

  @media (max-width: 480px) {
    .veritas-modal-dialog {
      width: min(92vw, 360px);
      padding: 22px;
      gap: 16px;
    }

    .veritas-modal-actions {
      width: 100%;
      justify-content: stretch;
    }

    .veritas-modal-button {
      flex: 1;
    }
  }

  /* New Dashboard Styles */
  .sidebar-nav-btn {
    background: transparent;
    color: rgba(255, 255, 255, 0.72);
    transition: background-color 160ms ease, color 160ms ease, box-shadow 160ms ease;
  }

  .sidebar-nav-btn .material-symbols-outlined {
    transition: transform 160ms ease, color 160ms ease;
  }

  .sidebar-nav-btn:hover {
    background: rgba(255, 255, 255, 0.12);
    color: #ffffff;
  }

  .sidebar-nav-btn:hover .material-symbols-outlined {
    transform: translateX(2px);
  }

  .sidebar-nav-btn.is-active,
  .sidebar-nav-btn[aria-current="page"] {
    background: rgba(255, 255, 255, 0.18);
    color: #ffffff;
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.15);
  }

  .sidebar-nav-btn.is-active .material-symbols-outlined,
  .sidebar-nav-btn[aria-current="page"] .material-symbols-outlined {
    color: #ffffff;
    transform: translateX(2px);
  }

  .question-nav-item.dragging {
    opacity: 0.55;
  }

  .question-nav-item.drop-before::before,
  .question-nav-item.drop-after::after {
    content: '';
    position: absolute;
    left: 12px;
    right: 12px;
    height: 2px;
    background: var(--veritas-gold);
    border-radius: 9999px;
  }

  .question-nav-item.drop-before::before {
    top: -4px;
  }

  .question-nav-item.drop-after::after {
    bottom: -4px;
  }

  .dashboard-card {
    background: white;
    border-radius: 16px;
    padding: 28px;
    box-shadow: 0 2px 8px rgba(18, 56, 93, 0.08);
    transition: all 200ms ease;
    animation: fadeUp 0.4s ease-out forwards;
    opacity: 0;
  }

  .dashboard-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(18, 56, 93, 0.12);
  }

  /* Enhanced Poll Card Design */
  .poll-card {
    position: relative;
    background-color: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(18, 56, 93, 0.08);
    transition: all 200ms ease;
    overflow: hidden;
    /* To contain the gradient border */
  }

  .poll-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(to right, var(--veritas-navy), var(--veritas-gold));
    opacity: 0.8;
    transition: opacity 200ms ease;
  }

  .poll-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 28px rgba(18, 56, 93, 0.15);
  }

  .poll-card:hover::before {
    opacity: 1;
  }

  .dark .poll-card {
    background-color: rgba(15, 23, 35, 0.85);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  .dark .poll-card:hover {
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.5);
  }

  .dashboard-card.primary-cta {
    background: linear-gradient(135deg, #12385d 0%, #0f2d4a 100%);
    color: white;
    border-top: 4px solid #c5a05a;
  }

  .dashboard-card-title {
    font-size: 20px;
    font-weight: 600;
    color: #12385d;
    margin-bottom: 8px;
  }

  .dashboard-card.primary-cta .dashboard-card-title {
    color: white;
  }

  .dashboard-card-subtitle {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 20px;
  }

  .dashboard-card.primary-cta .dashboard-card-subtitle {
    color: rgba(255, 255, 255, 0.8);
  }

  .dashboard-cta-button {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 12px 24px;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 15px;
    transition: all 140ms ease;
    cursor: pointer;
    border: none;
  }

  .dashboard-cta-button:hover {
    transform: translateY(-1px);
  }

  .dashboard-cta-button.primary {
    background: #c5a05a;
    color: white;
    box-shadow: 0 4px 12px rgba(197, 160, 90, 0.3);
  }

  .dashboard-cta-button.primary:hover {
    background: #b8954f;
    box-shadow: 0 6px 16px rgba(197, 160, 90, 0.4);
  }

  .dashboard-cta-button.secondary {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .dashboard-cta-button.secondary:hover {
    background: rgba(255, 255, 255, 0.25);
  }

  .dashboard-list-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 0;
    border-bottom: 1px solid rgba(18, 56, 93, 0.08);
    transition: all 140ms ease;
  }

  .dashboard-list-item:last-child {
    border-bottom: none;
  }

  .dashboard-list-item:hover {
    padding-left: 8px;
  }

  .dashboard-stat-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 9999px;
    font-size: 13px;
    font-weight: 600;
  }

  .dashboard-stat-badge.success {
    background: rgba(34, 197, 94, 0.15);
    color: #16a34a;
  }

  .dashboard-stat-badge.warning {
    background: rgba(245, 158, 11, 0.15);
    color: #d97706;
  }

  .dashboard-stat-badge.neutral {
    background: rgba(18, 56, 93, 0.1);
    color: #12385d;
  }

  .dashboard-quick-tool {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 20px;
    background: rgba(18, 56, 93, 0.04);
    border-radius: 12px;
    transition: all 180ms ease;
    cursor: pointer;
    text-decoration: none;
    color: #12385d;
  }

  .dashboard-quick-tool:hover {
    background: rgba(18, 56, 93, 0.08);
    transform: translateY(-2px);
  }

  .dashboard-quick-tool .icon {
    font-size: 32px;
    transition: transform 180ms ease;
  }

  .dashboard-quick-tool:hover .icon {
    transform: rotate(15deg);
  }

  .dashboard-icon-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: rgba(18, 56, 93, 0.06);
    color: #12385d;
    transition: all 160ms ease;
    cursor: pointer;
    border: none;
  }

  .dashboard-icon-btn:hover {
    background: rgba(18, 56, 93, 0.12);
    transform: scale(1.05);
  }

  .dashboard-status-chip {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 14px;
    border-radius: 9999px;
    font-size: 13px;
    font-weight: 600;
    background: rgba(148, 163, 184, 0.15);
    color: #475569;
  }

  .dashboard-status-chip.active {
    background: rgba(34, 197, 94, 0.15);
    color: #16a34a;
  }

  .dashboard-status-chip .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
  }

  .dashboard-status-chip.active .dot {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  @keyframes pulse {

    0%,
    100% {
      opacity: 1;
    }

    50% {
      opacity: 0.5;
    }
  }

  .activity-chart-placeholder {
    width: 100%;
    height: 180px;
    background: linear-gradient(to top, rgba(197, 160, 90, 0.1), rgba(18, 56, 93, 0.05));
    border-radius: 8px;
    display: flex;
    align-items: flex-end;
    justify-content: space-around;
    padding: 20px;
    gap: 8px;
  }

  .activity-bar {
    flex: 1;
    background: linear-gradient(to top, #c5a05a, #12385d);
    border-radius: 4px 4px 0 0;
    min-height: 20px;
    transition: all 300ms ease;
  }

  .activity-bar:hover {
    filter: brightness(1.2);
    transform: scaleY(1.05);
  }

  @keyframes fadeUp {
    from {
      opacity: 0;
      transform: translateY(18px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes pulseGlow {

    0%,
    100% {
      box-shadow: 0 0 0 0 rgba(197, 160, 90, 0.35);
    }

    50% {
      box-shadow: 0 0 18px 3px rgba(197, 160, 90, 0.45);
    }
  }


  /* Stagger animation delays */
  .dashboard-card:nth-child(1) {
    animation-delay: 0ms;
  }

  .dashboard-card:nth-child(2) {
    animation-delay: 100ms;
  }

  .dashboard-card:nth-child(3) {
    animation-delay: 200ms;
  }

  .dashboard-card:nth-child(4) {
    animation-delay: 300ms;
  }

  @media (max-width: 768px) {
    .dashboard-card {
      padding: 20px;
    }
  }

  /* Timer animations */
  @keyframes timer-flash {

    0%,
    100% {
      color: inherit;
    }

    50% {
      color: #0ea5e9;
    }

    /* sky-500 */
  }

  .timer-finished {
    animation: timer-flash 0.5s 2;
  }

  /* Ensure tabular numbers for timer display */
  #timer-display {
    font-feature-settings: 'tnum';
    font-variant-numeric: tabular-nums;
  }

  /* Slow pulse animation for violations */
  @keyframes pulse-slow {

    0%,
    100% {
      opacity: 1;
    }

    50% {
      opacity: 0.95;
    }
  }

  .animate-pulse-slow {
    animation: pulse-slow 2s ease-in-out infinite;
  }

  /* ENHANCED TIMER VISUAL FEEDBACK SYSTEM */
  /* Timer state classes - applied dynamically based on time remaining */
  .timer-warning {
    background: rgba(245, 158, 11, 0.25) !important;
    border-color: rgba(245, 158, 11, 0.4) !important;
  }

  .timer-warning #timer-display,
  .timer-warning #timer-display-compact {
    color: #fbbf24 !important;
    /* amber-400 */
  }

  .timer-critical {
    background: rgba(239, 68, 68, 0.25) !important;
    border-color: rgba(239, 68, 68, 0.5) !important;
    animation: timer-pulse-critical 1s ease-in-out infinite;
  }

  .timer-critical #timer-display,
  .timer-critical #timer-display-compact {
    color: #f87171 !important;
    /* red-400 */
  }

  @keyframes timer-pulse-critical {

    0%,
    100% {
      box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
    }

    50% {
      box-shadow: 0 0 20px 4px rgba(239, 68, 68, 0.6);
    }
  }

  /* Next Question button pulse when ready */
  .pulse-ready {
    animation: pulse-glow-gold 2s ease-in-out infinite;
  }

  /* Green state for timer */
  .timer-safe {
    background: rgba(16, 185, 129, 0.15) !important;
    border-color: rgba(16, 185, 129, 0.3) !important;
  }

  .timer-safe #timer-display,
  .timer-safe #timer-display-compact {
    color: #6ee7b7 !important;
    /* emerald-300 */
  }

  @keyframes pulse-glow-gold {

    0%,
    100% {
      box-shadow: 0 4px 12px rgba(197, 160, 90, 0.4);
    }

    50% {
      box-shadow: 0 8px 24px rgba(197, 160, 90, 0.7), 0 0 40px rgba(197, 160, 90, 0.3);
    }
  }

  /* Student tile animations for attention */
  .student-needs-attention {
    animation: border-pulse 2s ease-in-out infinite;
  }

  @keyframes border-pulse {

    0%,
    100% {
      border-color: rgba(239, 68, 68, 0.5);
    }

    50% {
      border-color: rgba(239, 68, 68, 1);
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
    }
  }

  /* Celebration animation for all-responded */
  @keyframes celebrate-bounce {

    0%,
    100% {
      transform: scale(1);
    }

    25% {
      transform: scale(1.05);
    }

    50% {
      transform: scale(0.95);
    }

    75% {
      transform: scale(1.02);
    }
  }

  .celebrate {
    animation: celebrate-bounce 0.6s ease-out;
  }

  /* ========================================
        ENHANCED DESIGN SYSTEM v2.0
       Optimized for Live Classroom Scenarios
       ======================================== */

  /* === FLOATING ACTION BUTTON (FAB) SYSTEM === */
  .fab-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 1000;
    display: flex;
    flex-direction: column-reverse;
    align-items: flex-end;
    gap: 12px;
  }

  .fab-main {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--veritas-navy), #0f2d4a);
    color: white;
    border: none;
    box-shadow: 0 8px 24px rgba(18, 56, 93, 0.35),
      0 0 0 0 rgba(197, 160, 90, 0.4);
    cursor: pointer;
    transition: all 280ms cubic-bezier(0.34, 1.56, 0.64, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .fab-main:hover {
    transform: scale(1.08) rotate(5deg);
    box-shadow: 0 12px 32px rgba(18, 56, 93, 0.45),
      0 0 40px rgba(197, 160, 90, 0.3);
  }

  .fab-main:active {
    transform: scale(0.95);
  }

  .fab-main .material-symbols-outlined {
    font-size: 28px;
    transition: transform 280ms ease;
  }

  .fab-main.is-open .material-symbols-outlined {
    transform: rotate(45deg);
  }

  .fab-menu {
    display: flex;
    flex-direction: column-reverse;
    gap: 12px;
    opacity: 0;
    pointer-events: none;
    transform: translateY(20px);
    transition: all 320ms cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .fab-menu.is-open {
    opacity: 1;
    pointer-events: all;
    transform: translateY(0);
  }

  .fab-action {
    display: flex;
    align-items: center;
    gap: 12px;
    animation: fab-slide-in 320ms cubic-bezier(0.34, 1.56, 0.64, 1) both;
  }

  .fab-action:nth-child(1) {
    animation-delay: 50ms;
  }

  .fab-action:nth-child(2) {
    animation-delay: 100ms;
  }

  .fab-action:nth-child(3) {
    animation-delay: 150ms;
  }

  .fab-action:nth-child(4) {
    animation-delay: 200ms;
  }

  @keyframes fab-slide-in {
    from {
      opacity: 0;
      transform: translateX(20px) scale(0.8);
    }

    to {
      opacity: 1;
      transform: translateX(0) scale(1);
    }
  }

  .fab-label {
    background: rgba(18, 56, 93, 0.95);
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    opacity: 0;
    transition: opacity 200ms ease;
  }

  .fab-action:hover .fab-label {
    opacity: 1;
  }

  .fab-button {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    transition: all 200ms ease;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
  }

  .fab-button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
  }

  .fab-button.fab-primary {
    background: linear-gradient(135deg, #c5a05a, #b8954f);
    color: white;
  }

  .fab-button.fab-success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
  }

  .fab-button.fab-info {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
  }

  .fab-button.fab-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
  }

  /* === TOAST NOTIFICATION SYSTEM === */
  .toast-container {
    position: fixed;
    top: 80px;
    right: 24px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-width: 420px;
  }

  .toast {
    display: flex;
    align-items: flex-start;
    gap: 14px;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15),
      0 2px 8px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    animation: toast-slide-in 320ms cubic-bezier(0.34, 1.56, 0.64, 1) both;
    border-left: 4px solid currentColor;
    position: relative;
    overflow: hidden;
  }

  @keyframes toast-slide-in {
    from {
      opacity: 0;
      transform: translateX(100%) scale(0.9);
    }

    to {
      opacity: 1;
      transform: translateX(0) scale(1);
    }
  }

  .toast.toast-out {
    animation: toast-slide-out 280ms ease-out both;
  }

  @keyframes toast-slide-out {
    to {
      opacity: 0;
      transform: translateX(100%) scale(0.9);
    }
  }

  .toast-success {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95));
    color: white;
  }

  .toast-error {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
    color: white;
  }

  .toast-warning {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(217, 119, 6, 0.95));
    color: white;
  }

  .toast-info {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
    color: white;
  }

  .toast-icon {
    flex-shrink: 0;
    font-size: 24px;
    animation: toast-icon-pop 400ms cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes toast-icon-pop {
    0% {
      transform: scale(0);
    }

    50% {
      transform: scale(1.2);
    }

    100% {
      transform: scale(1);
    }
  }

  .toast-content {
    flex: 1;
    min-width: 0;
  }

  .toast-title {
    font-weight: 700;
    font-size: 0.95rem;
    margin-bottom: 4px;
  }

  .toast-message {
    font-size: 0.85rem;
    opacity: 0.95;
    line-height: 1.4;
  }

  .toast-close {
    flex-shrink: 0;
    background: none;
    border: none;
    color: currentColor;
    cursor: pointer;
    padding: 4px;
    opacity: 0.7;
    transition: opacity 150ms ease;
    border-radius: 4px;
  }

  .toast-close:hover {
    opacity: 1;
    background: rgba(255, 255, 255, 0.1);
  }

  .toast-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: rgba(255, 255, 255, 0.3);
    transform-origin: left;
    animation: toast-progress 5s linear;
  }

  @keyframes toast-progress {
    from {
      transform: scaleX(1);
    }

    to {
      transform: scaleX(0);
    }
  }

  /* === PROGRESS RING ANIMATIONS === */
  .progress-ring-container {
    position: relative;
    width: 52px;
    height: 52px;
  }

  .progress-ring {
    transform: rotate(-90deg);
    width: 100%;
    height: 100%;
  }

  .progress-ring-circle-bg {
    fill: none;
    stroke: rgba(18, 56, 93, 0.1);
    stroke-width: 4;
  }

  .dark .progress-ring-circle-bg {
    stroke: rgba(255, 255, 255, 0.08);
  }

  .progress-ring-circle {
    fill: none;
    stroke: var(--veritas-navy);
    stroke-width: 4;
    stroke-linecap: round;
    transition: stroke-dashoffset 500ms cubic-bezier(0.4, 0, 0.2, 1),
      stroke 300ms ease;
  }

  .dark .progress-ring-circle {
    stroke: rgba(59, 130, 246, 0.85);
  }

  .progress-ring-circle.ring-success {
    stroke: #10b981;
  }

  .progress-ring-circle.ring-warning {
    stroke: #f59e0b;
  }

  .progress-ring-circle.ring-danger {
    stroke: #ef4444;
  }

  .progress-ring-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--veritas-navy);
  }

  .dark .progress-ring-text {
    color: white;
  }

  /* === SPARKLINE TREND VISUALIZATION === */
  .sparkline-container {
    width: 100%;
    height: 28px;
    margin-top: 8px;
  }

  .sparkline {
    width: 100%;
    height: 100%;
  }

  .sparkline-line {
    fill: none;
    stroke: var(--veritas-gold);
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
    opacity: 0.7;
  }

  .sparkline-area {
    fill: url(#sparkline-gradient);
    opacity: 0.3;
  }

  .sparkline-dot {
    fill: var(--veritas-gold);
    r: 3;
    opacity: 0;
    transition: opacity 200ms ease;
  }

  .sparkline-container:hover .sparkline-dot {
    opacity: 1;
  }

  /* === ENHANCED HUD CARDS WITH PROGRESS === */
  .hud-card-enhanced {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .hud-card-progress {
    flex-shrink: 0;
  }

  .hud-card-info {
    flex: 1;
    min-width: 0;
  }

  /* === AMBIENT STATE INDICATORS === */
  .ambient-state-overlay {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 5;
    transition: background-color 600ms ease;
  }

  .ambient-state-overlay.state-normal {
    background: transparent;
  }

  .ambient-state-overlay.state-all-responded {
    background: radial-gradient(circle at top,
        rgba(16, 185, 129, 0.08) 0%,
        transparent 60%);
    animation: ambient-pulse-success 3s ease-in-out infinite;
  }

  .ambient-state-overlay.state-time-critical {
    background: radial-gradient(circle at top,
        rgba(245, 158, 11, 0.08) 0%,
        transparent 60%);
    animation: ambient-pulse-warning 2s ease-in-out infinite;
  }

  .ambient-state-overlay.state-lockouts {
    background: radial-gradient(circle at top,
        rgba(239, 68, 68, 0.08) 0%,
        transparent 60%);
    animation: ambient-pulse-danger 1.5s ease-in-out infinite;
  }

  @keyframes ambient-pulse-success {

    0%,
    100% {
      opacity: 0.5;
    }

    50% {
      opacity: 1;
    }
  }

  @keyframes ambient-pulse-warning {

    0%,
    100% {
      opacity: 0.6;
    }

    50% {
      opacity: 1;
    }
  }

  @keyframes ambient-pulse-danger {

    0%,
    100% {
      opacity: 0.7;
    }

    50% {
      opacity: 1;
    }
  }

  /* === KEYBOARD SHORTCUT HINTS === */
  .kbd-hint {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(18, 56, 93, 0.1);
    border: 1px solid rgba(18, 56, 93, 0.2);
    font-size: 0.7rem;
    font-weight: 600;
    font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
    color: var(--veritas-navy);
    margin-left: 6px;
    opacity: 0;
    transition: opacity 200ms ease;
  }

  .dark .kbd-hint {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
    color: white;
  }

  button:hover .kbd-hint,
  button:focus .kbd-hint {
    opacity: 0.7;
  }

  /* === GESTURE HINT SYSTEM === */
  .gesture-hint {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 8px;
    padding: 6px 12px;
    background: rgba(18, 56, 93, 0.95);
    color: white;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 200ms ease, transform 200ms ease;
    z-index: 1000;
  }

  .gesture-hint::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: rgba(18, 56, 93, 0.95);
  }

  *:hover>.gesture-hint,
  *:focus>.gesture-hint {
    opacity: 1;
    transform: translateX(-50%) translateY(-4px);
  }

  /* === LIVE DASHBOARD: MOBILE LAYOUT === */
  .live-mobile-nav {
    display: flex;
    gap: 8px;
    padding: 10px 16px;
    background: linear-gradient(180deg, rgba(18, 56, 93, 0.12), rgba(18, 56, 93, 0));
    border-bottom: 1px solid rgba(18, 56, 93, 0.12);
    position: sticky;
    top: 0;
    z-index: 15;
  }

  .dark .live-mobile-nav {
    background: linear-gradient(180deg, rgba(15, 23, 35, 0.92), rgba(15, 23, 35, 0.7));
    border-color: rgba(255, 255, 255, 0.1);
  }

  .live-mobile-tab {
    flex: 1;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(18, 56, 93, 0.05);
    color: var(--veritas-navy);
    font-weight: 700;
    font-size: 0.9rem;
    border: 1px solid transparent;
    transition: all 180ms ease;
  }

  .dark .live-mobile-tab {
    background: rgba(255, 255, 255, 0.05);
    color: white;
  }

  .live-mobile-tab.is-active {
    background: white;
    color: var(--veritas-navy);
    border-color: rgba(18, 56, 93, 0.12);
    box-shadow: 0 10px 24px rgba(18, 56, 93, 0.08);
  }

  .dark .live-mobile-tab.is-active {
    background: rgba(255, 255, 255, 0.12);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .live-mobile-tab-chip {
    margin-left: auto;
    padding: 4px 8px;
    border-radius: 999px;
    background: rgba(18, 56, 93, 0.08);
    font-size: 0.8rem;
    font-weight: 800;
    color: var(--veritas-navy);
  }

  .dark .live-mobile-tab-chip {
    background: rgba(255, 255, 255, 0.1);
    color: white;
  }

  .live-mobile-panel {
    min-height: 0;
  }

  @media (max-width: 1024px) {
    .live-mobile-panel {
      display: none;
    }

    .live-mobile-panel.is-active {
      display: flex;
    }
  }

  @media (min-width: 1025px) {
    .live-mobile-panel {
      display: flex !important;
    }

    .live-mobile-nav {
      display: none;
    }
  }

  .live-mobile-actions {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 12px 16px 14px;
    background: rgba(255, 255, 255, 0.96);
    backdrop-filter: blur(12px);
    box-shadow: 0 -8px 28px rgba(18, 56, 93, 0.15);
    border-top: 1px solid rgba(18, 56, 93, 0.08);
    z-index: 50;
    display: none;
    flex-direction: column;
    gap: 12px;
  }

  .dark .live-mobile-actions {
    background: rgba(15, 23, 35, 0.94);
    border-color: rgba(255, 255, 255, 0.08);
  }

  .live-mobile-actions__row {
    display: flex;
    gap: 12px;
    align-items: stretch;
    flex-wrap: wrap;
  }

  .live-mobile-timer {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 8px;
    flex: 1;
  }

  .live-mobile-metrics {
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 160px;
  }

  .live-mobile-metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(18, 56, 93, 0.05);
    color: var(--veritas-navy);
    border: 1px solid rgba(18, 56, 93, 0.08);
  }

  .dark .live-mobile-metric {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(255, 255, 255, 0.1);
    color: white;
  }

  .live-mobile-metric-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 700;
  }

  .live-mobile-metric-value {
    font-weight: 900;
    font-size: 1rem;
  }

  .live-mobile-timebox {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 6px;
    align-items: center;
  }

  .live-mobile-timebox input {
    text-align: center;
    border-radius: 10px;
    border: 1px solid rgba(18, 56, 93, 0.12);
    padding: 10px 8px;
    font-weight: 800;
    color: var(--veritas-navy);
    background: white;
  }

  .dark .live-mobile-timebox input {
    border-color: rgba(255, 255, 255, 0.14);
    background: rgba(255, 255, 255, 0.05);
    color: white;
  }

  .live-mobile-timebox button {
    border-radius: 10px;
    border: 1px solid rgba(18, 56, 93, 0.12);
    padding: 10px 6px;
    font-weight: 800;
    color: var(--veritas-navy);
    background: rgba(18, 56, 93, 0.04);
    transition: all 150ms ease;
  }

  .live-mobile-timebox button:active {
    transform: translateY(1px);
  }

  .dark .live-mobile-timebox button {
    color: white;
    border-color: rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.05);
  }

  .live-mobile-pill {
    width: 100%;
    border-radius: 12px;
    padding: 10px 12px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-weight: 800;
    border: 1px solid transparent;
  }

  .live-mobile-pill-primary {
    background: linear-gradient(135deg, #0f2d4a, var(--veritas-navy));
    color: white;
    box-shadow: 0 8px 18px rgba(18, 56, 93, 0.3);
  }

  .live-mobile-pill-muted {
    background: rgba(18, 56, 93, 0.06);
    color: var(--veritas-navy);
    border-color: rgba(18, 56, 93, 0.16);
  }

  .live-mobile-pill-warning {
    background: rgba(245, 158, 11, 0.12);
    border-color: rgba(245, 158, 11, 0.28);
    color: #b45309;
    font-weight: 800;
  }

  .dark .live-mobile-pill-muted {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.12);
    color: white;
  }

  .dark .live-mobile-pill-warning {
    background: rgba(245, 158, 11, 0.2);
    border-color: rgba(245, 158, 11, 0.28);
    color: #fcd34d;
  }

  .live-mobile-actions__buttons {
    display: grid;
    grid-template-columns: repeat(5, minmax(0, 1fr));
    gap: 8px;
  }

  .live-mobile-action {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 12px 10px;
    border-radius: 12px;
    font-weight: 800;
    font-size: 0.95rem;
    border: 1px solid transparent;
    transition: all 160ms ease;
  }

  .live-mobile-action-primary {
    background: linear-gradient(135deg, var(--veritas-gold), #b58a42);
    color: white;
    box-shadow: 0 8px 18px rgba(197, 160, 90, 0.3);
  }

  .live-mobile-action-info {
    background: rgba(59, 130, 246, 0.12);
    border-color: rgba(59, 130, 246, 0.28);
    color: #1d4ed8;
  }

  .live-mobile-action-danger {
    background: rgba(239, 68, 68, 0.12);
    border-color: rgba(239, 68, 68, 0.28);
    color: #b91c1c;
  }

  .live-mobile-action-ghost {
    background: rgba(18, 56, 93, 0.05);
    border-color: rgba(18, 56, 93, 0.12);
    color: var(--veritas-navy);
  }

  .dark .live-mobile-action-ghost {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.12);
    color: white;
  }

  .live-mobile-action:disabled,
  .live-mobile-pill:disabled {
    opacity: 0.55;
    cursor: not-allowed;
  }

  @media (max-width: 640px) {
    .live-mobile-actions__buttons {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .live-mobile-actions__buttons button:nth-child(3) {
      grid-column: span 2 / span 2;
    }
  }


  /* === RESPONSIVE ENHANCEMENTS === */
  @media (max-width: 1024px) {
    .fab-container {
      bottom: 16px;
      right: 16px;
    }

    .fab-main {
      width: 56px;
      height: 56px;
    }

    .fab-button {
      width: 48px;
      height: 48px;
    }

    .toast-container {
      right: 16px;
      left: 16px;
      max-width: none;
    }
  }

  @media (max-width: 768px) {
    .fab-container {
      bottom: 12px;
      right: 12px;
    }

    .fab-label {
      display: none;
    }

    .toast-container {
      top: 72px;
    }

    .progress-ring-container {
      width: 44px;
      height: 44px;
    }
  }

  /* === UTILITY ANIMATIONS === */
  @keyframes shimmer {
    0% {
      background-position: -200% 0;
    }

    100% {
      background-position: 200% 0;
    }
  }

  .shimmer {
    background: linear-gradient(90deg,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.3) 50%,
        rgba(255, 255, 255, 0) 100%);
    background-size: 200% 100%;
    animation: shimmer 2s infinite;
  }

  @keyframes bounce-subtle {

    0%,
    100% {
      transform: translateY(0);
    }

    50% {
      transform: translateY(-4px);
    }
  }

  .bounce-subtle {
    animation: bounce-subtle 2s ease-in-out infinite;
  }

  /* ========================================
        PHASE 3: ACTIVITY FEED & ENHANCEMENTS
       ======================================== */

  /* === ACTIVITY FEED SYSTEM === */
  .activity-feed {
    position: fixed;
    bottom: 100px;
    right: 24px;
    width: 320px;
    max-height: 400px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(18, 56, 93, 0.2);
    border: 1px solid rgba(18, 56, 93, 0.1);
    display: flex;
    flex-direction: column;
    z-index: 999;
    opacity: 0;
    transform: translateY(20px);
    pointer-events: none;
    transition: all 300ms cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .dark .activity-feed {
    background: rgba(15, 23, 35, 0.95);
    border-color: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
  }

  .activity-feed.is-open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: all;
  }

  .activity-feed-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(18, 56, 93, 0.1);
  }

  .dark .activity-feed-header {
    border-color: rgba(255, 255, 255, 0.1);
  }

  .activity-feed-title {
    font-weight: 700;
    font-size: 0.95rem;
    color: var(--veritas-navy);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .dark .activity-feed-title {
    color: white;
  }

  .activity-feed-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    border-radius: 10px;
    background: var(--veritas-gold);
    color: white;
    font-size: 0.7rem;
    font-weight: 700;
  }

  .activity-feed-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px;
    border-radius: 6px;
    transition: all 150ms ease;
  }

  .activity-feed-close:hover {
    background: rgba(18, 56, 93, 0.1);
    color: var(--veritas-navy);
  }

  .dark .activity-feed-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
  }

  .activity-feed-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px 0;
  }

  .activity-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 20px;
    border-left: 3px solid transparent;
    transition: all 150ms ease;
    animation: activity-slide-in 300ms cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes activity-slide-in {
    from {
      opacity: 0;
      transform: translateX(20px);
    }

    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .activity-item:hover {
    background: rgba(18, 56, 93, 0.04);
    border-left-color: var(--veritas-gold);
  }

  .dark .activity-item:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .activity-icon {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .activity-icon.success {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
  }

  .activity-icon.warning {
    background: rgba(245, 158, 11, 0.15);
    color: #f59e0b;
  }

  .activity-icon.error {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
  }

  .activity-icon.info {
    background: rgba(59, 130, 246, 0.15);
    color: #3b82f6;
  }

  .activity-content {
    flex: 1;
    min-width: 0;
  }

  .activity-message {
    font-size: 0.875rem;
    color: var(--text-primary);
    line-height: 1.4;
    margin-bottom: 2px;
  }

  .dark .activity-message {
    color: rgba(255, 255, 255, 0.9);
  }

  .activity-time {
    font-size: 0.75rem;
    color: var(--text-secondary);
  }

  .activity-feed-empty {
    padding: 40px 20px;
    text-align: center;
    color: var(--text-secondary);
  }

  .activity-feed-empty .material-symbols-outlined {
    font-size: 48px;
    opacity: 0.3;
    margin-bottom: 8px;
  }

  /* === ENHANCED STUDENT STATUS TILES === */
  .student-tile {
    position: relative;
    padding: 12px 16px;
    border-radius: 12px;
    border: 2px solid transparent;
    background: white;
    transition: all 200ms ease;
    cursor: pointer;
  }

  .dark .student-tile {
    background: rgba(15, 23, 35, 0.5);
  }

  .student-tile:hover {
    border-color: var(--veritas-gold);
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(18, 56, 93, 0.15);
  }

  .student-tile.status-correct {
    border-left: 4px solid #10b981;
    background: linear-gradient(to right, rgba(16, 185, 129, 0.08), transparent);
  }

  .student-tile.status-incorrect {
    border-left: 4px solid #ef4444;
    background: linear-gradient(to right, rgba(239, 68, 68, 0.08), transparent);
  }

  .student-tile.status-locked {
    border-left: 4px solid #f59e0b;
    background: linear-gradient(to right, rgba(245, 158, 11, 0.08), transparent);
    animation: pulse-gentle 2s ease-in-out infinite;
  }

  @keyframes pulse-gentle {

    0%,
    100% {
      opacity: 1;
    }

    50% {
      opacity: 0.85;
    }
  }

  .student-tile.status-waiting {
    border-left: 4px solid #94a3b8;
    background: linear-gradient(to right, rgba(148, 163, 184, 0.08), transparent);
  }

  .student-tile-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
  }

  .student-name {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
  }

  .dark .student-name {
    color: rgba(255, 255, 255, 0.95);
  }

  .student-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
  }

  .student-status-badge.correct {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
  }

  .student-status-badge.incorrect {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
  }

  .student-status-badge.locked {
    background: rgba(245, 158, 11, 0.15);
    color: #f59e0b;
  }

  .student-status-badge.waiting {
    background: rgba(148, 163, 184, 0.15);
    color: #64748b;
  }

  .student-details {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .student-answer {
    font-weight: 600;
  }

  .student-tile-actions {
    display: flex;
    gap: 6px;
    margin-top: 8px;
    opacity: 0;
    transition: opacity 200ms ease;
  }

  .student-tile:hover .student-tile-actions {
    opacity: 1;
  }

  .student-action-btn {
    flex: 1;
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid rgba(18, 56, 93, 0.2);
    background: white;
    color: var(--veritas-navy);
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 150ms ease;
  }

  .dark .student-action-btn {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: white;
  }

  .student-action-btn:hover {
    background: var(--veritas-navy);
    color: white;
    border-color: var(--veritas-navy);
  }

  .dark .student-action-btn:hover {
    background: rgba(255, 255, 255, 0.15);
  }

  /* === ENHANCED MODAL DESIGNS === */
  .modal-section {
    margin-bottom: 24px;
  }

  .modal-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
    cursor: pointer;
    user-select: none;
    transition: all 150ms ease;
  }

  .modal-section-header:hover {
    color: var(--veritas-gold);
  }

  .modal-section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 0.95rem;
  }

  .modal-section-toggle {
    transition: transform 200ms ease;
  }

  .modal-section.is-collapsed .modal-section-toggle {
    transform: rotate(-90deg);
  }

  .modal-section-content {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 300ms cubic-bezier(0.4, 0, 0.2, 1);
  }

  .modal-section.is-collapsed .modal-section-content {
    max-height: 0;
  }

  /* === RESPONSIVE ADJUSTMENTS === */
  @media (max-width: 1024px) {
    .activity-feed {
      width: 280px;
      bottom: 80px;
      right: 16px;
    }
  }

  @media (max-width: 768px) {
    .activity-feed {
      width: calc(100vw - 32px);
      right: 16px;
      left: 16px;
      bottom: 70px;
    }
  }

  /* Session HUD cards for quick-glance metrics */
  .session-hud-surface {
    background: linear-gradient(135deg, rgba(18, 56, 93, 0.04), rgba(197, 160, 90, 0.08));
  }

  .dark .session-hud-surface {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.7), rgba(56, 189, 248, 0.12));
  }

  .session-hud-grid {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }

  .hud-card {
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 8px;
    padding: 18px;
    border-radius: 18px;
    background: rgba(255, 255, 255, 0.85);
    border: 1px solid rgba(18, 56, 93, 0.08);
    box-shadow: 0 10px 30px -18px rgba(18, 56, 93, 0.45);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .dark .hud-card {
    background: rgba(15, 23, 35, 0.85);
    border-color: rgba(255, 255, 255, 0.05);
    box-shadow: 0 10px 35px -22px rgba(15, 23, 35, 0.9);
  }

  .hud-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 18px 40px -18px rgba(18, 56, 93, 0.4);
  }

  .hud-card-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: rgba(17, 24, 39, 0.55);
  }

  .dark .hud-card-label {
    color: rgba(255, 255, 255, 0.55);
  }

  .hud-card-value {
    font-size: 1.85rem;
    font-weight: 800;
    color: var(--veritas-navy);
    letter-spacing: -0.02em;
  }

  .dark .hud-card-value {
    color: rgba(255, 255, 255, 0.92);
  }

  .hud-card-caption {
    font-size: 0.85rem;
    color: rgba(55, 65, 81, 0.75);
  }

  .dark .hud-card-caption {
    color: rgba(226, 232, 240, 0.65);
  }

  .hud-trend {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .hud-trend-up {
    color: #15803d;
  }

  .hud-trend-down {
    color: #b91c1c;
  }

  .hud-trend-steady {
    color: rgba(55, 65, 81, 0.75);
  }

  .dark .hud-trend-steady {
    color: rgba(226, 232, 240, 0.7);
  }

  .hud-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border-radius: 999px;
    font-size: 0.7rem;
    padding: 4px 10px;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .hud-chip[data-variant="ready"] {
    background: rgba(59, 130, 246, 0.12);
    color: #2563eb;
  }

  .hud-chip[data-variant="running"] {
    background: rgba(16, 185, 129, 0.12);
    color: #059669;
  }

  .hud-chip[data-variant="critical"] {
    background: rgba(248, 113, 113, 0.18);
    color: #dc2626;
    animation: timer-pulse-critical 1s ease-in-out infinite;
  }

  .hud-chip[data-variant="paused"] {
    background: rgba(148, 163, 184, 0.16);
    color: rgba(30, 41, 59, 0.8);
  }

  .hud-chip[data-variant="complete"] {
    background: rgba(34, 197, 94, 0.18);
    color: #15803d;
  }

  @media (max-width: 768px) {
    .session-hud-grid {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }

    .hud-card {
      padding: 16px;
    }

    .hud-card-value {
      font-size: 1.55rem;
    }
  }


  /* View Toggle Button States */
  #view-cards-btn.active {
    background: #12385d !important;
    color: white !important;
  }

  #view-table-btn.active {
    background: #12385d !important;
    color: white !important;
  }

  /* Toast Action Button */
  .toast-action-btn {
    margin-top: 8px;
    display: inline-block;
    padding: 6px 12px;
    background-color: rgba(255, 255, 255, 0.9);
    color: #12385d;
    /* Veritas Navy */
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .toast-action-btn:hover {
    background-color: #ffffff;
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
  }

  .toast-action-btn:active {
    transform: translateY(0);
  }

  /* Live view spacing adjustments */
  .live-view-shell {
    padding-top: 0;
    min-height: calc(100vh - 4rem);
    height: auto;
  }

  .live-view-grid {
    gap: 1rem !important;
    height: 100%;
    align-items: flex-start;
  }

  /* P0-6 & P0-7 FIX: Consistent question card layout */
  .live-question-card {
    margin-top: 0;
    margin-bottom: 0;
    padding-top: 16px;
    padding-bottom: 16px;
    /* Prevent margin collapse and ensure consistent position */
  }

  .live-question-card .question-stem-text {
    margin-top: 0;
    margin-bottom: 0;
    white-space: pre-wrap;
    /* P0-5: Preserve newlines like student view */
  }

  /* P0-6 FIX: Prevent flex growth in left column that causes variable gap */
  .live-view-grid>div:first-child {
    /* Left column should not use flex-1 growth on the answer section */
    /* This ensures question card always appears at consistent distance from header */
  }

  .live-student-panel {
    box-shadow: 0 8px 20px rgba(18, 56, 93, 0.06);
  }

  /* Student Grid Layout - Compact Mode */
  #student-status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 0.5rem;
    padding-top: 2px;
  }

  .student-tile {
    min-height: 48px;
    border: 1px solid #e2e8f0;
    background: #ffffff;
    border-radius: 10px;
    padding: 8px 10px;
    box-shadow: 0 4px 12px rgba(18, 56, 93, 0.04);
    transition: all 150ms ease;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: default;
  }

  .student-tile:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 16px rgba(18, 56, 93, 0.08);
    border-color: #cbd5e1;
  }

  .dark .student-tile {
    background: rgba(18, 56, 93, 0.35);
    border-color: rgba(255, 255, 255, 0.08);
    box-shadow: none;
  }

  .student-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid rgba(0, 0, 0, 0.05);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.01em;
  }

  .student-name {
    font-size: 13px;
    font-weight: 700;
    line-height: 1.25;
    color: #0f172a;
  }

  .dark .student-name {
    color: #f8fafc;
  }

  .student-sub {
    font-size: 12px;
    color: #475569;
    line-height: 1.2;
  }

  .dark .student-sub {
    color: #e2e8f0;
    opacity: 0.75;
  }

  .student-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .student-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    border: 1px solid #e2e8f0;
    color: #0f172a;
    background: #f8fafc;
  }

  .dark .student-badge {
    border-color: rgba(255, 255, 255, 0.08);
    color: #e2e8f0;
    background: rgba(255, 255, 255, 0.05);
  }

  .student-actions {
    display: inline-flex;
    gap: 6px;
    align-items: center;
  }

  .student-action-btn {
    height: 26px;
    width: 26px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    background: #fff;
    color: #0f172a;
    transition: background-color 120ms ease, border-color 120ms ease;
  }

  .student-action-btn:hover {
    background: #eef2ff;
    border-color: #c7d2fe;
  }

  .dark .student-action-btn {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: #e2e8f0;
  }

  .student-tile.locked {
    border-color: #f87171;
    background: #fef2f2;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.1);
  }

  .student-tile.submitted.correct {
    border-color: #34d399;
    background: #ecfdf5;
  }

  .student-tile.submitted.incorrect {
    border-color: #fb7185;
    background: #fff1f2;
  }

  /* Popover Enhancement */
  #locked-students-popover {
    transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: top center;
  }

  #locked-students-popover:not(.hidden) {
    animation: popover-entrance 200ms ease-out;
  }

  @keyframes popover-entrance {
    from {
      opacity: 0;
      transform: translate(-50%, -10px) scale(0.95);
    }

    to {
      opacity: 1;
      transform: translate(-50%, 0) scale(1);
    }
  }

  .student-top {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .student-status-icon {
    height: 34px;
    width: 34px;
    border-radius: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 700;
  }

  .student-status-icon .material-symbols-outlined {
    font-size: 20px;
    font-variation-settings: 'FILL' 0, 'wght' 600, 'GRAD' 0, 'opsz' 20;
    line-height: 1;
  }

  .student-status-icon.waiting {
    background: #eef2ff;
    color: #334155;
    border: 1px solid #e2e8f0;
  }

  .student-status-icon.correct {
    background: #ecfdf3;
    color: #059669;
    border: 1px solid #bbf7d0;
  }

  .student-status-icon.incorrect {
    background: #fef3c7;
    color: #b45309;
    border: 1px solid #fde68a;
  }

  .student-status-icon.locked {
    background: #fee2e2;
    color: #b91c1c;
    border: 1px solid #fecaca;
  }

  .student-status-icon.blocked {
    background: #fff1f2;
    color: #be123c;
    border: 1px solid #fecdd3;
  }

  .student-status-icon.fullscreen {
    background: #e0f2fe;
    color: #0369a1;
    border: 1px solid #bae6fd;
  }

  .badge-violation {
    background: #fef2f2;
    border-color: #fecdd3;
    color: #b91c1c;
  }

  .dark .badge-violation {
    background: rgba(248, 113, 113, 0.12);
    border-color: rgba(248, 113, 113, 0.3);
    color: #fecdd3;
  }

  .student-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .student-top {
    align-items: center;
  }

  /* Confidence pulse card */
  #live-metacognition-card {
    box-shadow: 0 8px 20px rgba(18, 56, 93, 0.06);
  }

  .confidence-row {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 10px;
    border-radius: 12px;
    border: 1px solid rgba(15, 23, 42, 0.06);
    background: #f8fafc;
  }

  .dark .confidence-row {
    border-color: rgba(255, 255, 255, 0.08);
    background: rgba(255, 255, 255, 0.03);
  }

  .confidence-bar-track {
    height: 8px;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.06);
    overflow: hidden;
  }

  .confidence-bar-fill {
    height: 100%;
    border-radius: 999px;
    transition: width 180ms ease;
  }

  /* Gentle pulse animation for locked students */
  @keyframes pulse-gentle {

    0%,
    100% {
      opacity: 1;
    }

    50% {
      opacity: 0.85;
    }
  }

  .animate-pulse-gentle {
    animation: pulse-gentle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  /* ===========================
       POLL WIZARD STYLES
       =========================== */

  .modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
  }

  .modal-overlay.hidden {
    display: none;
  }

  .modal-content-wizard {
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .wizard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e5e7eb;
    background: linear-gradient(135deg, #12385d 0%, #1e4976 100%);
  }

  .wizard-main-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    margin: 0;
  }

  .modal-close-btn {
    background: transparent;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
  }

  .modal-close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  /* Progress Indicator */
  .wizard-progress {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem 2rem;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
  }

  .progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
    opacity: 0.5;
    transition: opacity 0.3s;
  }

  .progress-step.active {
    opacity: 1;
  }

  .progress-step.completed .progress-circle {
    background: #10b981;
    border-color: #10b981;
    color: white;
  }

  .progress-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid #d1d5db;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1rem;
    color: #6b7280;
    transition: all 0.3s;
  }

  .progress-step.active .progress-circle {
    border-color: #12385d;
    color: #12385d;
    background: #dbeafe;
    box-shadow: 0 0 0 4px rgba(18, 56, 93, 0.1);
  }

  /* Progress labels in the wizard modal (light background) */
  .wizard-progress .progress-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
  }

  .wizard-progress .progress-step.active .progress-label {
    color: #12385d;
    font-weight: 600;
  }

  /* Header progress labels use Tailwind classes (text-white/80 etc.) - no override needed */

  .progress-connector {
    flex: 1;
    height: 2px;
    background: #d1d5db;
    margin: 0 0.5rem;
    position: relative;
    top: -12px;
  }

  /* Wizard Body */
  .wizard-body {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
  }

  .wizard-step {
    display: none;
    animation: slideIn 0.3s ease-out;
  }

  .wizard-step.active {
    display: block;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(20px);
    }

    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .step-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0 0 0.5rem 0;
  }

  .step-description {
    font-size: 1rem;
    color: #6b7280;
    margin: 0 0 2rem 0;
  }

  /* Mode Selection Cards */
  .mode-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .mode-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .mode-card:hover {
    border-color: #12385d;
    box-shadow: 0 8px 24px rgba(18, 56, 93, 0.15);
    transform: translateY(-4px);
  }

  .mode-card.selected {
    border-color: #12385d;
    background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
    box-shadow: 0 0 0 4px rgba(18, 56, 93, 0.1);
  }

  .mode-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #12385d 0%, #1e4976 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
  }

  .mode-icon .material-symbols-outlined {
    font-size: 3rem;
    color: white;
  }

  .mode-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
  }

  .mode-description {
    font-size: 0.95rem;
    color: #6b7280;
    line-height: 1.6;
    margin: 0;
  }

  .mode-features {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 1rem;
  }

  .mode-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #f3f4f6;
    color: #4b5563;
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 9999px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .mode-card.selected .mode-badge {
    background: #12385d;
    color: white;
  }

  /* Form Styles */
  .config-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #e5e7eb;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
  }

  .form-label.required::after {
    content: ' *';
    color: #ef4444;
  }

  .form-sublabel {
    display: block;
    font-weight: 500;
    color: #6b7280;
    margin-bottom: 0.4rem;
    font-size: 0.875rem;
  }

  .form-input,
  .form-select,
  .form-textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
    color: #1f2937;
    background: white;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .form-input:focus,
  .form-select:focus,
  .form-textarea:focus {
    outline: none;
    border-color: #12385d;
    box-shadow: 0 0 0 3px rgba(18, 56, 93, 0.1);
  }

  .form-textarea {
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .field-hint {
    display: block;
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.4rem;
  }

  .field-error {
    display: block;
    font-size: 0.875rem;
    color: #ef4444;
    margin-top: 0.4rem;
    font-weight: 500;
  }

  .form-checkbox {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    padding: 0.5rem 0;
  }

  .form-checkbox input[type="checkbox"],
  .form-checkbox input[type="radio"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }

  .checkbox-label {
    font-size: 0.95rem;
    color: #374151;
    cursor: pointer;
  }

  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 8px;
  }

  /* Questions Builder */
  .questions-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .question-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
    transition: box-shadow 0.2s;
  }

  .question-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .question-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
  }

  .question-number {
    font-weight: 700;
    color: #12385d;
    font-size: 1rem;
  }

  .question-card-body {
    padding: 1.5rem;
  }

  .btn-add-question {
    width: 100%;
    padding: 1rem;
    background: #f3f4f6;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    font-weight: 600;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-add-question:hover {
    background: #e5e7eb;
    border-color: #12385d;
    color: #12385d;
  }

  .btn-icon,
  .btn-icon-danger {
    background: transparent;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: background 0.2s;
  }

  .btn-icon:hover {
    background: #f3f4f6;
  }

  .btn-icon-danger {
    color: #ef4444;
  }

  .btn-icon-danger:hover {
    background: #fee2e2;
  }

  /* Review Section */
  .review-section {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .review-card {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
  }

  .review-heading {
    font-size: 1.125rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0 0 1rem 0;
  }

  .review-details {
    display: grid;
    grid-template-columns: 140px 1fr;
    gap: 0.75rem 1rem;
    margin: 0;
  }

  .review-details dt {
    font-weight: 600;
    color: #6b7280;
  }

  .review-details dd {
    margin: 0;
    color: #1f2937;
  }

  .review-questions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .review-question-item {
    padding: 0.75rem 1rem;
    background: white;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }

  .review-question-title {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.5rem;
  }

  .review-question-meta {
    font-size: 0.875rem;
    color: #6b7280;
  }

  .review-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #e5e7eb;
  }

  /* Wizard Footer */
  .wizard-footer {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem 2rem;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
  }

  .footer-spacer {
    flex: 1;
  }

  .btn-primary,
  .btn-secondary {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
    border: none;
  }

  .btn-primary {
    background: #12385d;
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    background: #0f2d4a;
    box-shadow: 0 4px 12px rgba(18, 56, 93, 0.3);
  }

  .btn-primary:disabled {
    background: #d1d5db;
    color: #9ca3af;
    cursor: not-allowed;
  }

  .btn-secondary {
    background: white;
    color: #374151;
    border: 1px solid #d1d5db;
  }

  .btn-secondary:hover:not(:disabled) {
    background: #f9fafb;
    border-color: #9ca3af;
  }

  .btn-secondary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Responsive Adjustments */
  @media (max-width: 768px) {
    .modal-content-wizard {
      width: 95%;
      max-height: 95vh;
    }

    .wizard-progress {
      padding: 1rem;
    }

    /* Only hide wizard modal progress labels on small screens */
    .wizard-progress .progress-label {
      display: none;
    }

    .wizard-body {
      padding: 1.5rem;
    }

    .mode-cards {
      grid-template-columns: 1fr;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .wizard-footer {
      flex-wrap: wrap;
    }
  }

  /* =============================================================================
     MOBILE LIVE SESSION LAYOUT FIXES
     ============================================================================= */

  /* Mobile: Make live session header more compact */
  @media (max-width: 640px) {

    /* Reduce header height and make it single-line */
    #header-live {
      height: auto;
      min-height: 48px;
      padding: 8px 12px;
    }

    #header-live .flex.w-full {
      flex-wrap: wrap;
      gap: 8px;
    }

    /* Compact poll context */
    #header-live .min-w-0.flex.flex-col {
      flex: 0 1 auto;
      min-width: 0;
    }

    #header-poll-name {
      font-size: 12px !important;
      max-width: 120px;
    }

    /* Make timer controls more compact on mobile */
    #timer-main-container {
      padding: 4px !important;
      gap: 4px !important;
    }

    #timer-display {
      width: 50px !important;
      font-size: 14px !important;
      padding: 0 !important;
    }

    #timer-main-container button {
      width: 28px !important;
      height: 28px !important;
    }

    #timer-main-container .material-symbols-outlined {
      font-size: 18px !important;
    }

    /* Hide less essential buttons on very small screens */
    #reset-btn,
    #header-next-btn {
      display: none !important;
    }

    /* Compact reveal button */
    #header-end-show-btn {
      padding: 6px 10px !important;
      font-size: 12px !important;
      height: auto !important;
    }

    #header-end-show-btn .material-symbols-outlined {
      font-size: 16px !important;
    }

    /* More actions button */
    #live-more-actions-btn {
      width: 32px !important;
      height: 32px !important;
    }
  }

  /* Mobile: Live status bar compactness */
  @media (max-width: 640px) {
    #live-status-bar {
      padding: 6px 12px !important;
      gap: 8px !important;
      height: auto !important;
      min-height: 36px;
      flex-wrap: wrap;
    }

    #live-status-bar .material-symbols-outlined {
      font-size: 14px !important;
    }

    #live-status-bar .font-bold {
      font-size: 13px !important;
    }

    #live-status-bar .text-sm {
      font-size: 11px !important;
    }

    /* Hide sparklines on mobile */
    #live-status-bar [id*="sparkline"],
    #live-status-bar .sparkline-container {
      display: none !important;
    }
  }

  /* Mobile: Main content area adjustments */
  @media (max-width: 768px) {
    .live-view-shell {
      padding: 8px !important;
      padding-bottom: 80px !important;
      /* Space for FAB */
    }

    .live-view-grid {
      gap: 8px !important;
    }

    /* Question card compact mode */
    .live-question-card {
      padding: 12px !important;
    }

    .live-question-card .question-stem-text {
      font-size: 15px !important;
      line-height: 1.4 !important;
    }

    /* Answer choices on mobile */
    #results-bars {
      gap: 6px !important;
    }

    #results-bars .answer-choice-btn,
    #results-bars button {
      padding: 10px 12px !important;
      font-size: 14px !important;
      min-height: 44px !important;
    }

    /* Student panel - collapse by default on very small screens */
    #live-sidebar {
      max-height: 200px;
      overflow-y: auto;
    }

    .live-student-panel {
      max-height: 180px;
    }

    #student-status-grid {
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)) !important;
      gap: 4px !important;
    }

    .student-tile {
      padding: 6px 8px !important;
      min-height: 40px !important;
    }

    .student-name {
      font-size: 11px !important;
    }

    .student-sub {
      font-size: 10px !important;
    }
  }

  /* Very small screens (iPhone SE etc) */
  @media (max-width: 375px) {
    #header-live {
      padding: 6px 8px;
    }

    #header-poll-name {
      max-width: 80px;
      font-size: 11px !important;
    }

    #timer-display {
      width: 44px !important;
      font-size: 12px !important;
    }

    .live-question-card .question-stem-text {
      font-size: 14px !important;
    }

    #results-bars button {
      padding: 8px 10px !important;
      font-size: 13px !important;
    }

    /* Collapse sidebar completely on very small screens */
    #live-sidebar {
      max-height: 150px;
    }
  }

  /* Fix for answer bars overflow on mobile */
  @media (max-width: 640px) {

    .answer-choice-container,
    .answer-bar-wrapper {
      overflow-x: hidden;
    }

    .answer-bar-wrapper .answer-text,
    #results-bars .answer-text {
      white-space: normal !important;
      word-break: break-word;
    }
  }

  /* Ensure FAB doesn't overlap content on mobile */
  @media (max-width: 640px) {
    .fab-container {
      bottom: 12px !important;
      right: 12px !important;
    }

    .fab-button {
      width: 48px !important;
      height: 48px !important;
    }

    .fab-action {
      margin-bottom: 8px !important;
    }
  }
</style>
</style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-brand-dark-gray dark:text-brand-white">
</head>

<body class="light">
  <!--  Ambient State Overlay - Provides visual feedback for system states -->
<div id="ambient-state-overlay" class="ambient-state-overlay state-normal"></div>

<!--  Toast Notification Container - For elegant, non-intrusive alerts -->
<div id="toast-container" class="toast-container"></div>

<div class="flex h-screen w-full flex-col">
  <!-- Header - Default State -->
  <header id="header-default"
    class="flex flex-wrap items-center gap-4 border-b border-solid border-veritas-navy/80 bg-veritas-navy px-6 py-4 shadow-md">
    <div class="flex items-center gap-3">
      <button id="dashboard-sidebar-toggle" type="button"
        class="flex h-10 w-10 items-center justify-center rounded-full bg-brand-white/10 text-brand-white transition-colors hover:bg-brand-white/20 focus:outline-none focus:ring-2 focus:ring-brand-white/60"
        aria-label="Hide navigation" aria-expanded="true">
        <span class="material-symbols-outlined text-2xl">menu_open</span>
      </button>
      <div class="flex items-center gap-4 cursor-pointer hover:opacity-80 transition-opacity" onclick="showDashboard()"
        onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();showDashboard();}" role="button"
        tabindex="0">
        <img alt="Malvern Prep Logo" class="h-12 w-auto"
          src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png" />
        <div class="flex flex-col">
          <h1 class="text-brand-white text-xl font-bold tracking-wide uppercase" style="letter-spacing: 0.15em;">Veritas
          </h1>
          <p class="text-brand-white/70 text-xs tracking-wide">Teacher Dashboard</p>
        </div>
      </div>
    </div>

    <!-- Wizard Progress Steps in Header (shown only during wizard) -->
    <div id="header-wizard-progress" class="hidden items-center gap-1 ml-4">
      <div class="progress-step active flex items-center gap-1" data-step="1">
        <div
          class="progress-circle h-6 w-6 rounded-full bg-white/20 text-white text-xs font-bold flex items-center justify-center">
          1</div>
        <span class="progress-label text-white/80 text-xs font-medium hidden md:inline">Mode</span>
      </div>
      <div class="progress-connector w-4 h-0.5 bg-white/30"></div>

      <div class="progress-step flex items-center gap-1" data-step="2">
        <div
          class="progress-circle h-6 w-6 rounded-full bg-white/20 text-white/70 text-xs font-bold flex items-center justify-center">
          2</div>
        <span class="progress-label text-white/60 text-xs font-medium hidden md:inline">Configure</span>
      </div>
      <div class="progress-connector w-4 h-0.5 bg-white/30"></div>

      <div class="progress-step flex items-center gap-1" data-step="3">
        <div
          class="progress-circle h-6 w-6 rounded-full bg-white/20 text-white/70 text-xs font-bold flex items-center justify-center">
          3</div>
        <span class="progress-label text-white/60 text-xs font-medium hidden md:inline">Questions</span>
      </div>
      <div class="progress-connector w-4 h-0.5 bg-white/30"></div>

      <div class="progress-step flex items-center gap-1" data-step="4">
        <div
          class="progress-circle h-6 w-6 rounded-full bg-white/20 text-white/70 text-xs font-bold flex items-center justify-center">
          4</div>
        <span class="progress-label text-white/60 text-xs font-medium hidden md:inline">Review</span>
      </div>
    </div>


    <div id="header-session-controls" class="flex flex-1 flex-wrap items-center justify-center gap-3 text-sm">
      <div class="min-w-[220px]">
        <label for="poll-select" class="sr-only">Select Poll to Start Session</label>
        <select id="poll-select"
          class="w-full rounded-lg border border-brand-white/30 bg-brand-white/10 px-3 py-2 text-sm text-brand-white placeholder-brand-white/70 focus:border-brand-white focus:outline-none focus:ring-2 focus:ring-veritas-gold/60">
          <option value="">-- Choose a poll --</option>
        </select>
      </div>
      <div class="flex flex-col gap-2">
        <div class="flex flex-wrap items-center gap-2">
          <button id="start-poll-btn" type="button"
            class="flex items-center gap-2 h-10 px-5 rounded-lg bg-veritas-gold text-white text-sm font-semibold hover:bg-veritas-gold/90 transition-colors shadow-sm disabled:cursor-not-allowed disabled:opacity-60"
            disabled>
            <span class="material-symbols-outlined text-lg">play_circle</span>
            <span>Start Session</span>
          </button>
          <button id="send-link-btn" type="button"
            class="flex items-center gap-2 h-10 px-5 rounded-lg bg-green-600 text-white text-sm font-semibold hover:bg-green-700 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
            disabled>
            <span class="material-symbols-outlined text-lg">mail</span>
            <span>Send Links</span>
          </button>
          <button id="view-links-btn" type="button"
            class="flex items-center gap-2 h-10 px-5 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
            disabled>
            <span class="material-symbols-outlined text-lg">visibility</span>
            <span>View Links</span>
          </button>
        </div>
        <div id="secure-session-meta"
          class="hidden flex flex-row items-center gap-6 text-xs text-brand-white/90 bg-white/10 rounded-lg px-3 py-1.5 border border-white/20"
          aria-live="polite" aria-hidden="true">
          <!-- Content dynamically populated by updateSecureSessionMeta() -->
        </div>
        <!-- Student Emulator Controls (Dev/Testing) -->
        <div id="emulator-controls"
          class="hidden flex flex-row items-center gap-3 text-xs text-brand-white/90 bg-amber-600/20 rounded-lg px-3 py-1.5 border border-amber-500/30">
          <span class="material-symbols-outlined text-amber-400 text-base">science</span>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="emulator-enabled"
              class="w-4 h-4 rounded border-white/30 bg-white/10 text-amber-500 focus:ring-amber-500/50">
            <span class="text-amber-200 font-medium">Emulate Students</span>
          </label>
          <div id="emulator-options" class="hidden flex items-center gap-2 ml-2 pl-2 border-l border-amber-500/30">
            <label class="flex items-center gap-1">
              <span class="text-white/70">Count:</span>
              <input type="number" id="emulator-student-count" value="5" min="1" max="50"
                class="w-14 h-6 rounded border border-white/30 bg-white/10 px-2 text-xs text-white focus:ring-amber-500/50">
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" id="emulator-concurrent"
                class="w-3.5 h-3.5 rounded border-white/30 bg-white/10 text-amber-500">
              <span class="text-white/70">Concurrent</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="ml-auto flex items-center gap-3">
      <div id="loader" class="loader" style="display: block;">
        <div class="h-6 w-6 animate-spin rounded-full border-2 border-brand-white/80 border-t-transparent"></div>
      </div>
    </div>
  </header>

  <!-- Header - Live Poll State (COMPACT REDESIGN - Mobile Optimized) -->
  <header id="header-live" class="shrink-0 bg-veritas-navy shadow-md border-b border-veritas-gold/30 z-20"
    style="display: none;">
    <div class="flex w-full items-center justify-between px-2 sm:px-4 py-2 gap-2 sm:gap-4 min-h-[48px] sm:h-16">

      <!-- Left: Poll Context (More compact on mobile) -->
      <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-shrink">
        <button id="dashboard-sidebar-toggle-live" type="button"
          class="flex-shrink-0 h-7 w-7 sm:h-8 sm:w-8 flex items-center justify-center rounded-full bg-white/10 text-white hover:bg-white/20 transition-colors"
          aria-label="Toggle navigation">
          <span class="material-symbols-outlined text-lg sm:text-xl">menu</span>
        </button>
        <div class="min-w-0 flex flex-col justify-center">
          <h1 id="header-poll-name"
            class="text-white font-bold text-xs sm:text-sm md:text-base truncate leading-tight max-w-[100px] sm:max-w-none">
            Poll Name
          </h1>
          <div class="flex items-center gap-1 sm:gap-2 text-[10px] sm:text-xs text-white/70">
            <span id="live-question-info"
              class="font-mono tracking-wider uppercase bg-white/10 px-1 sm:px-1.5 py-0.5 rounded">Q1 / 10</span>
            <span id="question-dots" class="hidden md:flex gap-1"></span>
          </div>
        </div>
      </div>

      <!-- Right: Timer & Primary Actions (Compact on mobile) -->
      <div class="flex items-center gap-1 sm:gap-3 flex-shrink-0">
        <!-- Timer Control (Compact on mobile) -->
        <div id="timer-main-container"
          class="flex items-center gap-0.5 sm:gap-2 bg-black/20 rounded-lg p-0.5 sm:p-1 border border-white/10 transition-colors">
          <button id="subtract-10s-btn" type="button"
            class="hidden md:flex w-7 h-7 sm:w-8 sm:h-8 items-center justify-center rounded text-white/70 hover:text-white hover:bg-white/10 transition-colors"
            title="-10s">
            <span class="material-symbols-outlined text-base sm:text-lg">remove</span>
          </button>
          <input type="text" id="timer-display"
            class="w-12 sm:w-16 md:w-20 bg-transparent text-center text-sm sm:text-lg md:text-xl font-bold text-white tabular-nums focus:outline-none focus:ring-1 focus:ring-veritas-gold rounded px-0.5 sm:px-1 cursor-pointer hover:bg-white/5"
            value="00:00" title="Click to edit time">
          <button id="add-10s-btn" type="button"
            class="hidden md:flex w-7 h-7 sm:w-8 sm:h-8 items-center justify-center rounded text-white/70 hover:text-white hover:bg-white/10 transition-colors"
            title="+10s">
            <span class="material-symbols-outlined text-base sm:text-lg">add</span>
          </button>

          <div class="w-px h-4 sm:h-5 bg-white/20 mx-0.5 sm:mx-1"></div>

          <button id="start-btn" type="button"
            class="w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center rounded bg-emerald-500 hover:bg-emerald-600 text-white shadow-sm transition-colors"
            title="Start (Space)">
            <span class="material-symbols-outlined text-lg sm:text-xl">play_arrow</span>
          </button>
          <button id="pause-btn" type="button"
            class="hidden w-7 h-7 sm:w-8 sm:h-8 items-center justify-center rounded bg-amber-500 hover:bg-amber-600 text-white shadow-sm transition-colors"
            title="Pause (Space)">
            <span class="material-symbols-outlined text-lg sm:text-xl">pause</span>
          </button>
          <button id="reset-btn" type="button"
            class="hidden sm:flex w-7 h-7 sm:w-8 sm:h-8 items-center justify-center rounded text-white/70 hover:text-white hover:bg-white/10 transition-colors"
            title="Reset (R)">
            <span class="material-symbols-outlined text-base sm:text-lg">refresh</span>
          </button>
        </div>

        <div class="hidden sm:block w-px h-6 bg-white/10 mx-1"></div>
        <button id="header-next-btn" type="button"
          class="hidden md:flex items-center gap-2 h-8 sm:h-9 px-3 sm:px-4 rounded bg-white text-veritas-navy font-bold text-xs sm:text-sm shadow hover:bg-gray-100 transition-all"
          title="Next Question ()">
          <span>Next</span>
          <span class="material-symbols-outlined text-sm sm:text-base">arrow_forward</span>
        </button>
        <button id="header-end-show-btn" type="button"
          class="flex items-center gap-1 sm:gap-2 h-7 sm:h-9 px-2 sm:px-4 rounded bg-veritas-gold text-white font-bold text-xs sm:text-sm shadow hover:bg-veritas-gold/90 transition-all"
          title="End & Reveal (E)">
          <span class="material-symbols-outlined text-sm sm:text-base">visibility</span>
          <span class="hidden sm:inline">Reveal</span>
        </button>

        <!-- More Actions Dropdown Trigger -->
        <div class="relative">
          <button id="live-more-actions-btn"
            class="h-7 w-7 sm:h-9 sm:w-9 flex items-center justify-center rounded text-white hover:bg-white/10 transition-colors"
            aria-label="More actions" aria-haspopup="true">
            <span class="material-symbols-outlined text-lg sm:text-xl">more_vert</span>
          </button>
          <!-- Dropdown Menu -->
          <div id="live-more-menu"
            class="hidden absolute right-0 top-full mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 py-1 z-50 origin-top-right ring-1 ring-black ring-opacity-5 focus:outline-none"
            role="menu">
            <button id="header-edit-poll-btn"
              class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2"
              role="menuitem">
              <span class="material-symbols-outlined text-base">edit</span> Edit Poll
            </button>
            <div class="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>
            <button id="header-back-btn"
              class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2"
              role="menuitem">
              <span class="material-symbols-outlined text-base">arrow_back</span> Previous Question
            </button>
            <button id="header-reset-question-btn"
              class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2"
              role="menuitem">
              <span class="material-symbols-outlined text-base">replay</span> Reset Question
            </button>
            <div class="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>
            <button id="add-30s-btn-preset"
              class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2"
              role="menuitem">
              <span class="material-symbols-outlined text-base">av_timer</span> Add 30 Seconds
            </button>
            <button id="add-60s-btn-preset"
              class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2"
              role="menuitem">
              <span class="material-symbols-outlined text-base">av_timer</span> Add 1 Minute
            </button>
            <div class="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>
            <button id="header-send-link-btn"
              class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2"
              role="menuitem">
              <span class="material-symbols-outlined text-base">mail</span> Send Links
            </button>
            <button id="header-view-links-btn"
              class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2"
              role="menuitem">
              <span class="material-symbols-outlined text-base">link</span> View Links
            </button>
            <div class="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>
            <button id="header-stop-btn"
              class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2"
              role="menuitem">
              <span class="material-symbols-outlined text-base">stop_circle</span> End Session
            </button>
          </div>
        </div>

        <div class="w-px h-6 bg-white/10 mx-1"></div>
        <button id="header-calc-toggle" type="button"
          class="flex items-center gap-2 h-9 px-3 rounded bg-white/10 text-white text-sm font-semibold hover:bg-white/15 transition-colors"
          aria-pressed="false" aria-live="polite" data-role="calculator-toggle">
          <span class="material-symbols-outlined text-base">calculate</span>
          <span class="hidden sm:inline">Calculator</span>
          <span id="header-calc-state" class="text-xs uppercase tracking-wide opacity-80">Off</span>
        </button>
      </div>
    </div>

    <!-- Hidden legacy buttons to prevent JS errors -->
    <button id="header-start-btn" class="hidden"></button>
  </header>

  <div class="flex flex-grow overflow-hidden min-h-0">
    <!-- Left Navigation Sidebar -->
    <aside id="dashboard-sidebar"
      class="hidden lg:flex h-full w-64 flex-shrink-0 flex-col border-r border-veritas-navy/25 bg-veritas-navy p-4 text-brand-white shadow-lg">
      <div class="mb-4 px-1">
        <p class="text-xs font-semibold uppercase tracking-[0.32em] text-brand-white/60">Navigation</p>
      </div>
      <nav class="flex flex-1 flex-col gap-2">
        <button id="nav-polls-list" data-section-target="dashboard"
          class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg font-semibold transition-colors text-left"
          aria-current="page">
          <span class="material-symbols-outlined">monitoring</span>
          <span>Live Dashboard</span>
        </button>
        <button id="nav-create-poll"
          class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg text-left transition-colors font-semibold">
          <span class="material-symbols-outlined">add_circle</span>
          <span>Create New Poll</span>
        </button>
        <button id="nav-rosters" data-section-target="roster"
          class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left">
          <span class="material-symbols-outlined">group</span>
          <span>Classes &amp; Rosters</span>
        </button>
        <button id="nav-archived" data-section-target="archived"
          class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left">
          <span class="material-symbols-outlined">inventory_2</span>
          <span>Archived Polls</span>
        </button>
        <button id="nav-analytics" data-section-target="analytics"
          class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left">
          <span class="material-symbols-outlined">analytics</span>
          <span>Analytics Hub</span>
        </button>
        <button id="nav-migration" onclick="openMigrationModal()"
          class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left mt-auto text-brand-white/70 hover:text-brand-white hover:bg-white/10">
          <span class="material-symbols-outlined">cloud_upload</span>
          <span>Import Data</span>
        </button>
      </nav>
      <div class="mt-6 rounded-lg border border-brand-white/10 bg-brand-white/5 px-3 py-3 text-xs text-brand-white/70">
        <p class="font-semibold uppercase tracking-[0.18em] text-brand-white/60">Tip</p>
        <p class="mt-1 leading-relaxed">Use the controls in the top bar to quickly start a live session from any poll.
        </p>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 min-h-0 overflow-y-auto pb-6">
      <!-- Dashboard View (Default) - Redesigned -->
      <div id="dashboard" class="p-8 max-w-7xl mx-auto">
        <!-- Poll Library & Session Management (Combined) -->
        <div class="dashboard-card glass-card premium-shadow p-8 rounded-2xl">
          <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-bold text-veritas-navy mb-1">Poll Library & Session Management</h2>
              <p class="text-gray-600 text-sm">Use the session controls in the header to start a live session, or
                create, edit, and manage your polls below.</p>
            </div>
          </div>

          <!-- Poll Library Controls -->
          <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
            <h3 class="text-lg font-semibold text-veritas-navy">Your Polls</h3>
            <div class="flex flex-wrap items-center gap-3">
              <label class="flex items-center gap-2 text-sm text-gray-600">
                <span class="hidden sm:inline">Sort by</span>
                <select id="poll-sort-select"
                  class="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-veritas-gold">
                  <option value="updated_desc">Latest activity</option>
                  <option value="updated_asc">Oldest activity</option>
                  <option value="name_asc">Name A  Z</option>
                  <option value="class_asc">Class A  Z</option>
                </select>
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-600">
                <span class="hidden sm:inline">Class</span>
                <select id="poll-filter-select"
                  class="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-veritas-gold">
                  <option value="all">All classes</option>
                </select>
              </label>
              <div id="poll-search-container" class="relative w-full sm:w-64">
                <span
                  class="material-symbols-outlined pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-400 z-10">search</span>
                <input id="poll-search-input" type="text" placeholder="Search polls, questions..."
                  class="w-full rounded-lg border border-gray-300 bg-white pl-9 pr-8 py-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-veritas-gold shadow-sm"
                  aria-label="Search polls" autocomplete="off" />
                <button type="button"
                  class="absolute inset-y-0 right-0 flex items-center px-2 text-gray-400 hover:text-gray-600 focus:outline-none"
                  data-combobox-toggle>
                  <span class="material-symbols-outlined text-lg">unfold_more</span>
                </button>
                <button id="poll-search-clear-btn" type="button"
                  class="hidden absolute right-8 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none"
                  aria-label="Clear search">
                  <span class="material-symbols-outlined text-base leading-none">close</span>
                </button>
              </div>
            </div>
          </div>

          <!-- ENHANCED: Toggle between Table and Card View -->
          <div class="mb-4 flex items-center justify-end gap-2">
            <span class="text-xs text-gray-500 font-medium">View:</span>
            <button id="view-cards-btn"
              class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-veritas-navy/10 text-veritas-navy transition-colors"
              title="Card view">
              <span class="material-symbols-outlined text-base align-middle">grid_view</span>
            </button>
            <button id="view-table-btn"
              class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors"
              title="Table view">
              <span class="material-symbols-outlined text-base align-middle">table_rows</span>
            </button>
          </div>

          <!-- Card View (Default, More Visual) -->
          <div id="polls-card-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <!-- Poll cards will be dynamically inserted here -->
          </div>

          <!-- Table View (Optional, More Compact) -->
          <div id="polls-table-view" class="overflow-hidden rounded-lg border border-gray-200 hidden">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
              <thead class="bg-gray-50 text-gray-600">
                <tr>
                  <th class="px-4 py-3 text-left font-semibold">Poll</th>
                  <th class="px-4 py-3 text-left font-semibold">Class</th>
                  <th class="px-4 py-3 text-left font-semibold">Questions</th>
                  <th class="px-4 py-3 text-left font-semibold">Mode</th>
                  <th class="px-4 py-3 text-left font-semibold">Last Edited</th>
                  <th class="px-4 py-3 text-right font-semibold">Actions</th>
                </tr>
              </thead>
              <tbody id="polls-table-body" class="divide-y divide-gray-100 bg-white"></tbody>
            </table>
          </div>

          <!-- Enhanced Empty State -->
          <div id="polls-empty-state"
            class="hidden text-center p-12 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl">
            <div class="max-w-lg mx-auto">
              <div class="inline-block p-4 bg-veritas-navy/10 rounded-full mb-4">
                <span class="material-symbols-outlined text-5xl text-veritas-navy dark:text-veritas-gold">school</span>
              </div>
              <h3 class="text-2xl font-bold text-veritas-navy dark:text-white mb-2">Welcome to Your Poll Library</h3>
              <p class="text-gray-600 dark:text-gray-400 mb-6">This is where your polls will live. Create your first
                interactive poll to engage your students and gather real-time feedback.</p>
              <button onclick="openPollCreator()" class="dashboard-cta-button primary">
                <span class="material-symbols-outlined">add_circle</span>
                <span>Create Your First Poll</span>
              </button>
            </div>
          </div>
        </div>

      </div>

      <!-- Individual Timed Session Monitoring View -->
      <div id="individual-timed-view" class="p-6" style="display: none;">
        <div
          class="bg-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
            <div>
              <h2 id="individual-session-poll-name"
                class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">Individual Timed Session</h2>
              <p id="individual-session-meta" class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm">
                Monitoring student progress in real-time.</p>
            </div>
            <div class="flex items-center gap-2">
              <button id="secure-view-links-btn"
                class="h-10 px-5 rounded-lg bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined text-lg">link</span>
                <span>View Links</span>
              </button>
              <button id="view-book-report-btn"
                class="h-10 px-5 rounded-lg bg-veritas-gold text-white text-sm font-bold hover:bg-veritas-gold/90 transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined text-lg">menu_book</span>
                <span>Book View</span>
              </button>
              <button id="end-individual-session-btn"
                class="h-10 px-5 rounded-lg bg-red-600 text-white text-sm font-bold hover:bg-red-700 transition-colors">End
                Session</button>
            </div>
          </div>
          <div id="mission-control-summary" class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
            <div class="p-4 rounded-xl border border-brand-light-gray/70 bg-slate-50 dark:bg-brand-dark-gray/20">
              <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Not Started</p>
              <p id="summary-not-started" class="text-3xl font-bold text-slate-900 dark:text-white">0</p>
            </div>
            <div class="p-4 rounded-xl border border-emerald-200 bg-emerald-50 dark:bg-emerald-900/30">
              <p class="text-xs font-semibold uppercase tracking-wide text-emerald-700 dark:text-emerald-200">In
                Progress</p>
              <p id="summary-in-progress" class="text-3xl font-bold text-emerald-800 dark:text-emerald-100">0</p>
            </div>
            <div class="p-4 rounded-xl border border-amber-200 bg-amber-50 dark:bg-amber-900/20">
              <p class="text-xs font-semibold uppercase tracking-wide text-amber-700 dark:text-amber-200">Locked /
                Paused</p>
              <p id="summary-locked" class="text-3xl font-bold text-amber-800 dark:text-amber-100">0</p>
            </div>
            <div class="p-4 rounded-xl border border-slate-200 bg-slate-50 dark:bg-slate-800/40">
              <p class="text-xs font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-300">Submitted</p>
              <p id="summary-completed" class="text-3xl font-bold text-slate-900 dark:text-white">0</p>
            </div>
          </div>
          <div class="grid gap-4 lg:grid-cols-[minmax(0,3fr)_minmax(0,2fr)] mb-6">
            <div class="p-4 rounded-xl border border-brand-light-gray/70 bg-white dark:bg-brand-dark-gray/20 shadow-sm">
              <div class="flex flex-col gap-3">
                <div class="flex flex-wrap items-center gap-3">
                  <span
                    class="text-sm font-semibold text-brand-dark-gray dark:text-white uppercase tracking-wide">Extend
                    time</span>
                  <div class="flex items-center gap-2">
                    <input id="bulk-time-input" type="number" min="1" step="1" value="5"
                      class="w-20 rounded-lg border border-slate-200 bg-white/90 px-3 py-1.5 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-veritas-gold"
                      aria-label="Minutes to extend" />
                    <span class="text-xs text-slate-500">minutes</span>
                  </div>
                </div>
                <div class="flex flex-wrap items-center gap-3">
                  <button id="bulk-time-all-btn" type="button"
                    class="inline-flex items-center gap-2 rounded-full bg-veritas-navy text-white px-4 py-2 text-sm font-semibold shadow hover:bg-veritas-navy/90 transition-colors">
                    <span class="material-symbols-outlined text-base">schedule_add</span>
                    <span>Add to entire class</span>
                  </button>
                  <button id="bulk-time-selected-btn" type="button"
                    class="inline-flex items-center gap-2 rounded-full bg-emerald-600 text-white px-4 py-2 text-sm font-semibold shadow hover:bg-emerald-700 transition-colors disabled:opacity-60"
                    disabled>
                    <span class="material-symbols-outlined text-base">group_add</span>
                    <span id="bulk-selected-label">Add to selected</span>
                  </button>
                  <button id="bulk-selection-clear" type="button"
                    class="text-xs font-semibold text-slate-500 underline hidden">Clear selection</button>
                </div>
                <p class="text-xs text-slate-500">Selecting student cards enables targeted adjustments. <span
                    id="bulk-selection-count">0</span> students selected.</p>
              </div>
            </div>
            <div
              class="p-4 rounded-xl border border-brand-light-gray/70 bg-slate-50 dark:bg-brand-dark-gray/20 shadow-sm">
              <h4 class="text-sm font-semibold text-brand-dark-gray dark:text-white mb-2 flex items-center gap-2">
                <span class="material-symbols-outlined text-base text-veritas-navy">visibility_lock</span>
                Re-entry monitoring
              </h4>
              <p class="text-xs text-slate-500 leading-relaxed">Locked students will surface an "Approve re-entry"
                action on their tile so you can clear violations without leaving Mission Control.</p>
            </div>
          </div>
          <div id="individual-session-students-grid"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- Student cards will be dynamically inserted here -->
          </div>
        </div>
      </div>

      <!-- Live Poll View (REDESIGNED FOR OPTIMAL TEACHER WORKFLOW) -->
      <div id="live-view" class="flex flex-col h-full min-h-0 overflow-hidden p-0" style="display: none;">

        <!--  Proctoring notifications now use lightweight toasts. Legacy banners removed for a calmer experience. -->

        <!-- New Status Bar (Replaces Session HUD) -->
        <div id="live-status-bar"
          class="flex-shrink-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 px-4 py-2 flex items-center gap-4 sm:gap-6 overflow-x-auto text-sm shadow-sm z-10 h-12">
          <!-- Responses Metric -->
          <div class="flex items-center gap-2 whitespace-nowrap">
            <span class="material-symbols-outlined text-veritas-navy dark:text-gray-400 text-lg">group</span>
            <span class="font-bold text-gray-900 dark:text-white text-base" id="hud-response-count">0 / 0</span>
            <span class="text-gray-500 text-xs uppercase tracking-wide font-semibold">Responded</span>
          </div>

          <div class="w-px h-4 bg-gray-300 dark:bg-gray-700"></div>

          <!-- Accuracy Metric -->
          <div class="flex items-center gap-2 whitespace-nowrap">
            <span class="material-symbols-outlined text-emerald-600 text-lg">check_circle</span>
            <span class="font-bold text-gray-900 dark:text-white text-base" id="hud-accuracy-value">--%</span>
            <span class="text-gray-500 text-xs uppercase tracking-wide font-semibold">Accuracy</span>
          </div>

          <div class="w-px h-4 bg-gray-300 dark:bg-gray-700"></div>

          <!-- Locked Metric -->
          <div class="flex items-center gap-2 whitespace-nowrap">
            <span class="material-symbols-outlined text-amber-500 text-lg">lock_person</span>
            <span class="font-bold text-gray-900 dark:text-white text-base" id="hud-lockouts-value">0</span>
            <span class="text-gray-500 text-xs uppercase tracking-wide font-semibold">Locked</span>
            <button id="hud-focus-lockouts-btn"
              class="flex items-center gap-1 px-2 py-1 rounded-md bg-amber-100 hover:bg-amber-200 text-amber-900 text-xs font-bold transition-colors ml-1"
              disabled>
              <span class="material-symbols-outlined text-sm">open_in_new</span>
              <span>VIEW</span>
            </button>
            <!-- Locked Students Popover -->
            <div id="locked-students-popover"
              class="hidden absolute top-14 left-1/2 -translate-x-1/2 w-80 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-2xl z-50 p-4">
              <div class="flex items-center justify-between mb-3 border-b border-gray-100 dark:border-gray-700 pb-2">
                <span class="font-bold text-gray-900 dark:text-white text-sm">Locked Students</span>
                <button onclick="document.getElementById('locked-students-popover').classList.add('hidden')"
                  class="text-gray-400 hover:text-gray-600"><span
                    class="material-symbols-outlined text-sm">close</span></button>
              </div>
              <div id="locked-popover-list" class="flex flex-col gap-2 max-h-60 overflow-y-auto">
                <!-- Populated via JS -->
              </div>
            </div>
          </div>

          <!-- Spacer -->
          <div class="flex-1"></div>

          <!-- Status Message / Timer Pace (Simplified) -->
          <div class="flex items-center gap-2 text-xs text-gray-500 whitespace-nowrap hidden sm:flex">
            <span id="timer-status-message" class="italic hidden">Ready</span>
            <span id="hud-pace-value"
              class="font-mono font-semibold bg-gray-100 dark:bg-gray-800 px-1.5 rounded hidden">--:--</span>
          </div>

          <!-- Hidden placeholders for legacy JS compatibility -->
          <div id="hud-response-ring" class="hidden"></div>
          <div id="hud-response-percent" class="hidden"></div>
          <div id="hud-response-caption" class="hidden"></div>
          <div id="hud-accuracy-ring" class="hidden"></div>
          <div id="hud-accuracy-percent" class="hidden"></div>
          <div id="hud-accuracy-caption" class="hidden"></div>
          <div id="hud-lockouts-caption" class="hidden"></div>
          <div id="hud-pace-caption" class="hidden"></div>
          <div id="hud-pace-chip" class="hidden"></div>
        </div>

        <!-- Mobile Nav Controls (phone/tablet) -->
        <div id="live-mobile-nav" class="live-mobile-nav" style="display: none;" role="tablist"
          aria-label="Live dashboard sections">
          <button class="live-mobile-tab is-active" data-panel="question" role="tab" aria-selected="true">
            <span class="material-symbols-outlined text-base">quiz</span>
            <span>Question</span>
            <span id="mobile-response-chip" class="live-mobile-tab-chip">0 / 0</span>
          </button>
          <button class="live-mobile-tab" data-panel="students" role="tab" aria-selected="false">
            <span class="material-symbols-outlined text-base">group</span>
            <span>Students</span>
            <span id="mobile-lock-chip" class="live-mobile-tab-chip">0</span>
          </button>
        </div>

        <!-- Main Content Wrapper (Scrollable) -->
        <div class="flex-1 min-h-0 overflow-y-auto bg-gray-50 dark:bg-gray-800 px-4 pb-32 lg:pb-10 live-view-shell">

          <div class="flex flex-col lg:flex-row gap-4 h-full min-h-0 live-view-grid">
            <!-- LEFT COLUMN: Question + Answer Choices (Adaptive Width) -->
            <section id="live-question-panel" class="live-mobile-panel flex-1 min-w-0 flex flex-col gap-4"
              data-mobile-panel="question">

              <!-- Question Display Area -->
              <div
                class="bg-white dark:bg-brand-dark-gray/30 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm shrink-0 live-question-card">
                <!-- Hidden elements for JS compatibility -->
                <!-- P0-5 FIX: Apply whitespace-pre-wrap to compact version too -->
                <h2 id="live-question-text-compact" class="hidden whitespace-pre-wrap"></h2>
                <span id="live-question-info" class="hidden">Q1 / 10</span>
                <span id="response-count-header" class="hidden">0 / 0 answered</span>

                <!-- Student-view-style layout: text on left, image on right -->
                <div id="question-layout-container" class="question-layout-grid">
                  <div class="question-text-area">
                    <h2 id="live-question-text" class="question-stem-text whitespace-pre-wrap">Question text will appear
                      here...</h2>
                  </div>
                  <div id="question-image-container" class="question-image-area" style="display: none;">
                    <div class="question-image-frame">
                      <img id="live-question-image" alt="Question" src="" class="question-image-clickable">
                    </div>
                  </div>
                </div>
              </div>

              <!-- Answer Choices (Student View Style) -->
              <!-- P0-6 FIX: Remove flex-1 from answer section to prevent variable gap under question card -->
              <!-- flex-1 causes the section to grow/shrink, creating dynamic spacing above it -->
              <div class="flex flex-col min-h-0 flex-shrink">
                <div class="overflow-y-auto">
                  <div id="results-bars" class="flex flex-col gap-2" aria-live="polite">
                    <!-- Answer choices will be populated dynamically in student-view style -->
                  </div>

                  <!-- Results Reveal Strip -->
                  <div id="results-reveal-strip" class="mt-4 hidden">
                    <div
                      class="flex flex-wrap items-center justify-between gap-3 rounded-lg border border-green-600/20 bg-green-600/5 px-4 py-2.5">
                      <div class="min-w-[200px]">
                        <p class="text-sm font-semibold text-green-700 dark:text-green-400">Answer revealed to students
                        </p>
                        <p id="results-strip-status" class="text-xs text-green-700/70">Students can now see the correct
                          answer.</p>
                      </div>
                      <div class="flex items-center gap-2">
                        <button id="hide-results-btn"
                          class="flex items-center gap-2 rounded-lg bg-gray-200 text-gray-700 px-3 py-1.5 text-sm font-semibold hover:bg-gray-300 transition-colors"
                          type="button">
                          <span class="material-symbols-outlined text-base">visibility_off</span>
                          <span>Hide</span>
                        </button>
                        <button id="strip-next-btn"
                          class="flex items-center gap-2 rounded-lg bg-veritas-navy text-white px-3 py-1.5 text-sm font-semibold hover:bg-veritas-navy/90 transition-colors"
                          type="button">
                          <span>Next</span>
                          <span class="material-symbols-outlined text-base">arrow_forward</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <!-- RIGHT COLUMN: STUDENTS + CONFIDENCE PULSE (Fixed Width) -->
            <section id="live-students-panel"
              class="live-mobile-panel w-full lg:w-96 flex-none flex flex-col gap-4 h-full overflow-hidden min-h-0 transition-all duration-300 ease-in-out"
              data-mobile-panel="students">

              <!-- STUDENTS PANEL -->
              <div id="live-sidebar"
                class="flex-1 flex flex-col bg-white dark:bg-brand-dark-gray/30 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden min-h-0 live-student-panel">

                <!-- Student Header with Status Summary -->
                <div class="flex-shrink-0 border-b border-gray-200 dark:border-gray-700 px-4 py-2.5">
                  <div class="flex items-center justify-between mb-2">
                    <h3 class="text-brand-dark-gray dark:text-brand-white text-base font-bold">Students</h3>
                    <div class="flex items-center gap-1.5">
                      <button id="filter-locked-only-btn"
                        class="h-6 w-6 flex items-center justify-center rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 hover:bg-red-200 transition-colors"
                        title="Show locked only">
                        <span class="material-symbols-outlined text-sm">lock</span>
                      </button>
                      <button id="filter-all-btn"
                        class="h-6 w-6 flex items-center justify-center rounded-lg bg-gray-100 dark:bg-gray-900/30 text-gray-700 dark:text-gray-400 hover:bg-gray-200 transition-colors"
                        title="Show all">
                        <span class="material-symbols-outlined text-sm">group</span>
                      </button>
                    </div>
                  </div>

                  <!-- Status Pills (Always Visible) -->
                  <div class="flex flex-wrap gap-1">
                    <div
                      class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full bg-green-100 dark:bg-green-900/30 text-xs font-semibold text-green-700 dark:text-green-400">
                      <span> <span id="correct-count">0</span></span>
                    </div>
                    <div
                      class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full bg-red-100 dark:bg-red-900/30 text-xs font-semibold text-red-700 dark:text-red-400">
                      <span> <span id="locked-count">0</span></span>
                    </div>
                    <div
                      class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full bg-amber-100 dark:bg-amber-900/30 text-xs font-semibold text-amber-700 dark:text-amber-400">
                      <span> <span id="blocked-count">0</span></span>
                    </div>
                    <div
                      class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full bg-gray-100 dark:bg-gray-900/30 text-xs font-semibold text-gray-700 dark:text-gray-400">
                      <span> <span id="waiting-count">0</span></span>
                    </div>
                  </div>

                  <!-- Hidden elements for compatibility -->
                  <div class="hidden">
                    <div id="student-search-container">
                      <input type="text" id="student-search-input" />
                    </div>
                    <select id="student-sort-select">
                      <option value="name">Name</option>
                      <option value="status">Status</option>
                      <option value="answer">Answer</option>
                    </select>
                    <button id="student-sort-direction-btn"></button>
                  </div>
                </div>


                <!-- Student Grid (Scrollable, Compact Tiles) -->
                <div id="student-status-grid" class="flex-1 overflow-y-auto px-3 py-2" aria-live="polite">
                  <!-- Students will be populated with full names, inline status, hover actions -->
                </div>

              </div>

              <!-- CONFIDENCE PULSE PANEL -->
              <div id="confidence-pulse-container" class="shrink-0">
                <!-- Confidence pulse will be rendered here dynamically -->
              </div>
            </section>
            <!-- END STUDENTS PANEL -->

          </div>
          <!-- END RIGHT COLUMN -->

        </div> <!-- Closes the new .flex.gap-6 -->
      </div> <!-- Closes the new .flex-1.overflow-y-auto -->

      <!-- Sticky Mobile Action Bar -->
      <div id="live-mobile-actions" class="live-mobile-actions" style="display: none;" aria-live="polite">
        <div class="live-mobile-actions__row">
          <div class="live-mobile-timer" id="timer-compact-container">
            <button id="mobile-start-btn" type="button" class="live-mobile-pill live-mobile-pill-primary">
              <span class="material-symbols-outlined text-base">play_arrow</span>
              <span id="mobile-timer-label">Start</span>
            </button>
            <button id="mobile-pause-btn" type="button" class="live-mobile-pill live-mobile-pill-muted hidden">
              <span class="material-symbols-outlined text-base">pause</span>
              <span>Pause</span>
            </button>
            <div class="live-mobile-timebox">
              <button id="subtract-10s-btn-mobile" type="button" aria-label="Subtract 10 seconds">-10s</button>
              <input id="timer-display-compact" type="text" aria-label="Timer" readonly />
              <button id="add-10s-btn-mobile" type="button" aria-label="Add 10 seconds">+10s</button>
            </div>
          </div>
          <div class="live-mobile-metrics">
            <div class="live-mobile-metric">
              <span class="live-mobile-metric-label">Accuracy</span>
              <span id="mobile-accuracy-chip" class="live-mobile-metric-value">--%</span>
            </div>
            <button id="mobile-locks-btn" type="button" class="live-mobile-pill live-mobile-pill-warning" disabled>
              <span class="material-symbols-outlined text-base">lock_person</span>
              <span id="mobile-locks-label">Locked</span>
            </button>
          </div>
        </div>
        <div class="live-mobile-actions__buttons">
          <button id="mobile-resume-btn" type="button" class="live-mobile-action live-mobile-action-ghost hidden">
            <span class="material-symbols-outlined text-base">play_circle</span>
            <span>Resume</span>
          </button>
          <button id="mobile-reveal-btn" type="button" class="live-mobile-action live-mobile-action-primary">
            <span class="material-symbols-outlined text-base">visibility</span>
            <span>Reveal</span>
          </button>
          <button id="mobile-next-btn" type="button" class="live-mobile-action live-mobile-action-info">
            <span class="material-symbols-outlined text-base">arrow_forward</span>
            <span>Next</span>
          </button>
          <button id="mobile-reset-btn" type="button" class="live-mobile-action live-mobile-action-ghost">
            <span class="material-symbols-outlined text-base">replay</span>
            <span>Reset</span>
          </button>
          <button id="mobile-stop-btn" type="button" class="live-mobile-action live-mobile-action-danger">
            <span class="material-symbols-outlined text-base">stop_circle</span>
            <span>End</span>
          </button>
        </div>
      </div>

      <!-- Hidden elements for compatibility -->
      <div class="hidden">
        <div id="live-session-overview">
          <p id="live-overview-responses">0 / 0</p>
          <div id="live-overview-response-progress" style="width: 0%;"></div>
          <p id="live-overview-response-caption">0%</p>
          <p id="live-overview-accuracy">0%</p>
          <p id="live-overview-accuracy-caption"></p>
          <p id="live-overview-lockouts">0</p>
          <p id="live-overview-lockouts-caption"></p>
          <p id="live-overview-waiting">0</p>
          <p id="live-overview-waiting-caption"></p>
          <button id="focus-lockouts-btn" type="button" disabled></button>
        </div>
        <div id="response-count">0 / 0</div>
        <div id="violations-alert-panel"></div>
        <div id="violations-summary"></div>
        <div id="violations-quick-list"></div>
        <button id="dismiss-violations-alert"></button>
        <button id="toggle-exited-panel-btn"></button>
        <div id="exited-students-list"></div>
        <button id="toggle-sidebar-btn"></button>
        <span id="sidebar-toggle-icon"></span>
        <span id="sidebar-toggle-label"></span>
      </div>

  </div>

  <!--  Floating Action Button (FAB) Cluster - Primary Actions for Live Session -->
  <div id="fab-container" class="fab-container" style="display: none;">
    <!-- FAB Menu Items -->
    <div id="fab-menu" class="fab-menu">
      <!-- Activity Feed Toggle -->
      <div class="fab-action">
        <span class="fab-label">Activity Feed</span>
        <button id="fab-activity-btn" class="fab-button fab-info" title="View recent activity"
          aria-label="Toggle activity feed">
          <span class="material-symbols-outlined">notifications</span>
        </button>
      </div>

      <!-- Next Question Action -->
      <div class="fab-action">
        <span class="fab-label">Next Question </span>
        <button id="fab-next-btn" class="fab-button fab-primary" title="Advance to next question"
          aria-label="Next question">
          <span class="material-symbols-outlined">arrow_forward</span>
        </button>
      </div>

      <!-- Show Results Action -->
      <div class="fab-action">
        <span class="fab-label">Show Results</span>
        <button id="fab-show-results-btn" class="fab-button fab-success" title="Reveal answer to students"
          aria-label="Show results">
          <span class="material-symbols-outlined">visibility</span>
        </button>
      </div>

      <!-- Reset Question Action -->
      <div class="fab-action">
        <span class="fab-label">Reset Question</span>
        <button id="fab-reset-btn" class="fab-button fab-info" title="Reset current question"
          aria-label="Reset question">
          <span class="material-symbols-outlined">replay</span>
        </button>
      </div>

      <!-- Stop Session Action -->
      <div class="fab-action">
        <span class="fab-label">End Session</span>
        <button id="fab-stop-btn" class="fab-button fab-danger" title="End the entire session"
          aria-label="Stop session">
          <span class="material-symbols-outlined">stop</span>
        </button>
      </div>
    </div>

    <!-- FAB Main Toggle Button -->
    <button id="fab-main-toggle" class="fab-main" aria-label="Quick actions menu" aria-expanded="false">
      <span class="material-symbols-outlined">bolt</span>
    </button>
  </div>

  <!--  Real-Time Activity Feed - Shows recent student actions -->
  <div id="activity-feed" class="activity-feed">
    <div class="activity-feed-header">
      <div class="activity-feed-title">
        <span class="material-symbols-outlined">notifications</span>
        <span>Recent Activity</span>
        <span id="activity-feed-count" class="activity-feed-badge">0</span>
      </div>
      <button id="activity-feed-close" class="activity-feed-close" aria-label="Close activity feed">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div id="activity-feed-list" class="activity-feed-list">
      <!-- Activity items will be dynamically inserted here -->
      <div class="activity-feed-empty">
        <span class="material-symbols-outlined">inbox</span>
        <p>No recent activity</p>
      </div>
    </div>
  </div>

  <!-- End of Live Poll View Redesign -->
  <!-- Roster Manager View -->
  <div id="roster-manager" class="p-6 grid grid-cols-1 lg:grid-cols-4 gap-6" style="display: none;">
    <div
      class="lg:col-span-1 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-5 shadow-sm flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white">Classes</h2>
        <button id="add-class-btn"
          class="flex items-center justify-center h-9 w-9 rounded-full bg-primary text-brand-white hover:bg-primary/90 transition-colors"
          title="Add class">
          <span class="material-symbols-outlined text-base">add</span>
        </button>
      </div>
      <div id="roster-class-list" class="flex-1 overflow-y-auto space-y-2">
        <!-- Classes will render here -->
      </div>
    </div>
    <div
      class="lg:col-span-3 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
        <div>
          <h2 id="roster-class-title" class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">Select a
            class</h2>
          <p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm">Manage student names and emails for
            rostered classes.</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="rename-class-btn"
            class="hidden h-9 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">Rename</button>
          <button id="delete-class-btn"
            class="hidden h-9 px-4 rounded-lg bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-sm font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors">Delete</button>
        </div>
      </div>
      <div id="roster-empty-state"
        class="border border-dashed border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-10 text-center text-brand-dark-gray/60 dark:text-brand-white/60">
        <p>Choose a class on the left to view its roster.</p>
      </div>
      <div id="roster-table-wrapper" class="hidden flex flex-col gap-4">
        <div class="overflow-x-auto border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg">
          <table class="min-w-full divide-y divide-brand-light-gray dark:divide-brand-dark-gray text-sm">
            <thead class="bg-brand-light-gray/50 dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white">
              <tr>
                <th class="px-4 py-2 text-left font-semibold w-1/2">Student Name</th>
                <th class="px-4 py-2 text-left font-semibold w-1/2">Email</th>
                <th class="px-4 py-2 text-center font-semibold w-16">Remove</th>
              </tr>
            </thead>
            <tbody id="roster-table-body" class="divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/50">
            </tbody>
          </table>
        </div>
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <button id="add-student-row-btn"
              class="h-10 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">+
              Add Student</button>
            <button id="bulk-add-students-btn"
              class="h-10 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">Bulk
              Add Students</button>
            <span id="roster-status" class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60"></span>
          </div>
          <button id="save-roster-btn"
            class="h-10 px-5 rounded-lg bg-primary text-brand-white text-sm font-bold hover:bg-primary/90 transition-colors">Save
            Roster</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Archived Polls View -->
  <div id="archived-view" class="p-6 grid grid-cols-1 lg:grid-cols-4 gap-6" style="display: none;">
    <div
      class="lg:col-span-1 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-5 shadow-sm flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white">Archived Polls</h2>
        <button id="refresh-archived-btn"
          class="flex items-center justify-center h-9 w-9 rounded-full bg-primary text-brand-white hover:bg-primary/90 transition-colors"
          title="Refresh">
          <span class="material-symbols-outlined text-base">refresh</span>
        </button>
      </div>
      <label
        class="block text-xs font-semibold uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">Class
        Filter</label>
      <select id="archived-class-filter"
        class="mb-4 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
        <option value="all">All classes</option>
      </select>
      <div id="archived-list" class="flex-1 overflow-y-auto space-y-2">
        <!-- Archived polls list -->
      </div>
    </div>
    <div
      class="lg:col-span-3 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
      <div id="archived-empty-state"
        class="border border-dashed border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-10 text-center text-brand-dark-gray/60 dark:text-brand-white/60">
        <p>Select an archived poll to review student performance.</p>
      </div>
      <div id="archived-detail" class="hidden flex flex-col gap-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h2 id="archived-poll-title" class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white"></h2>
            <p id="archived-poll-meta" class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm"></p>
          </div>
          <div class="flex items-center gap-4">
            <div class="text-right text-sm text-brand-dark-gray/60 dark:text-brand-white/60">
              <p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Questions:</span> <span
                  id="archived-question-count"></span></p>
              <p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Responses:</span> <span
                  id="archived-response-count"></span></p>
            </div>
            <button id="view-analytics-btn"
              class="h-12 px-6 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 text-brand-white text-sm font-semibold hover:from-blue-700 hover:to-purple-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2">
              <span class="material-symbols-outlined text-lg">analytics</span>
              <span>View Analytics</span>
            </button>
          </div>
        </div>
        <div id="archived-questions-container" class="space-y-4">
          <!-- Question breakdowns will render here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics Hub View -->
  <div id="analytics-view" class="p-6 flex flex-col gap-6" style="display: none;">
    <!-- Filter Bar -->
    <div
      class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-4 shadow-sm">
      <div class="flex flex-wrap items-center gap-3 mb-3">
        <select id="analytics-class-filter"
          class="rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
          <option value="all">All Classes</option>
        </select>
        <div class="flex items-center gap-2">
          <label class="text-xs font-semibold text-brand-dark-gray/60 dark:text-brand-white/60">From:</label>
          <input type="date" id="analytics-date-from"
            class="rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
        </div>
        <div class="flex items-center gap-2">
          <label class="text-xs font-semibold text-brand-dark-gray/60 dark:text-brand-white/60">To:</label>
          <input type="date" id="analytics-date-to"
            class="rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
        </div>
        <button id="analytics-apply-filters-btn"
          class="px-4 py-2 rounded-lg bg-primary text-brand-white hover:bg-primary/90 transition-colors text-sm font-semibold">
          Apply Filters
        </button>
        <button id="analytics-clear-filters-btn"
          class="px-4 py-2 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/50 transition-colors text-sm">
          Clear
        </button>
        <button id="analytics-refresh-btn"
          class="flex items-center justify-center h-9 w-9 rounded-full bg-primary text-brand-white hover:bg-primary/90 transition-colors"
          title="Refresh">
          <span class="material-symbols-outlined text-base">refresh</span>
        </button>
        <button id="analytics-export-btn"
          class="ml-auto flex items-center gap-2 px-4 py-2 rounded-lg bg-veritas-gold text-brand-white hover:bg-veritas-gold/90 transition-colors text-sm font-semibold"
          title="Export Data">
          <span class="material-symbols-outlined text-base">download</span>
          <span>Export</span>
        </button>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <span class="text-xs font-semibold text-brand-dark-gray/60 dark:text-brand-white/60">Quick Filters:</span>
        <button
          class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold"
          data-days="7">
          Last 7 Days
        </button>
        <button
          class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold"
          data-days="30">
          Last 30 Days
        </button>
        <button
          class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold"
          data-days="90">
          Last 90 Days
        </button>
        <button
          class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold"
          data-preset="thisMonth">
          This Month
        </button>
        <button
          class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold"
          data-preset="lastMonth">
          Last Month
        </button>
        <button
          class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold"
          data-preset="all">
          All Time
        </button>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div
      class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 shadow-sm overflow-hidden">
      <div class="flex border-b border-brand-light-gray dark:border-brand-dark-gray/40">
        <button id="analytics-tab-overview"
          class="flex-1 px-6 py-3 font-semibold text-sm transition-colors analytics-tab bg-primary text-brand-white">
          Overview
        </button>
        <button id="analytics-tab-items"
          class="flex-1 px-6 py-3 font-semibold text-sm transition-colors analytics-tab text-brand-dark-gray/70 dark:text-brand-white/70 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30">
          Item Analysis
        </button>
        <button id="analytics-tab-students"
          class="flex-1 px-6 py-3 font-semibold text-sm transition-colors analytics-tab text-brand-dark-gray/70 dark:text-brand-white/70 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30">
          Student Trends
        </button>
      </div>

      <!-- Overview Tab Content -->
      <div id="analytics-content-overview" class="p-6 analytics-tab-content">
        <div id="analytics-overview-loading" class="text-center py-12">
          <div class="flex flex-row gap-2 justify-center mb-4">
            <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce"></div>
            <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.3s]"></div>
            <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.5s]"></div>
          </div>
          <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Loading analytics...</p>
        </div>
        <div id="analytics-overview-content" class="hidden">
          <!-- KPI Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div id="analytics-kpi-container"></div>
          </div>

          <!-- Topic Heat Strip -->
          <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5 mb-6">
            <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Topic Mastery Over Time
            </h3>
            <div id="analytics-topic-heat" class="overflow-x-auto">
              <p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No topic data available</p>
            </div>
          </div>

          <!-- Item Quality Scatter -->
          <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5">
            <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Item Quality Map</h3>
            <div id="analytics-item-scatter" style="height: 300px;">
              <p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No item data available</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Item Analysis Tab Content -->
      <div id="analytics-content-items" class="p-6 analytics-tab-content hidden">
        <div id="analytics-items-loading" class="text-center py-12">
          <div class="flex flex-row gap-2 justify-center mb-4">
            <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce"></div>
            <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.3s]"></div>
            <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.5s]"></div>
          </div>
          <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Loading item analysis...</p>
        </div>
        <div id="analytics-items-content" class="hidden">
          <!-- Item Table -->
          <div class="overflow-x-auto">
            <table id="analytics-items-table" class="min-w-full text-sm">
              <thead
                class="sticky top-0 bg-brand-light-gray dark:bg-brand-dark-gray text-xs uppercase tracking-wide text-brand-dark-gray/80 dark:text-brand-white/70">
                <tr>
                  <th
                    class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80"
                    data-sort="qNum">Q#</th>
                  <th
                    class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80"
                    data-sort="topic">Topic</th>
                  <th
                    class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80"
                    data-sort="correctPct">Correct%</th>
                  <th
                    class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80"
                    data-sort="rbis">Disc</th>
                  <th class="py-3 px-4 text-left">Choices</th>
                  <th
                    class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80"
                    data-sort="medianTimeSec">Time(s)</th>
                  <th class="py-3 px-4 text-left">Flags</th>
                </tr>
              </thead>
              <tbody id="analytics-items-tbody"
                class="divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/40">
                <!-- Items will be rendered here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Student Trends Tab Content -->
      <div id="analytics-content-students" class="p-6 analytics-tab-content hidden">
        <div id="analytics-students-loading" class="text-center py-12">
          <div class="flex flex-row gap-2 justify-center mb-4">
            <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce"></div>
            <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.3s]"></div>
            <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.5s]"></div>
          </div>
          <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Loading student data...</p>
        </div>
        <div id="analytics-students-content" class="hidden">
          <!-- STUDENT INSIGHTS PANEL (2025) -->
          <div id="student-insights-panel" class="mb-6">
            <h2 class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white mb-4">Student Insights</h2>

            <!-- Insight Cards Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              <!-- Struggling Students -->
              <div
                class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700/50 rounded-lg p-4 cursor-pointer hover:shadow-md transition-shadow"
                onclick="filterStudentsByFlag('struggling')">
                <div class="flex items-center gap-3 mb-2">
                  <span class="material-symbols-outlined text-red-600 dark:text-red-400 text-2xl">trending_down</span>
                  <h3 class="font-bold text-red-800 dark:text-red-300 text-sm">Struggling</h3>
                </div>
                <p class="text-3xl font-black text-red-700 dark:text-red-400" id="struggling-count">0</p>
                <p class="text-xs text-red-600/70 dark:text-red-400/70 mt-1">Accuracy < 50%</p>
              </div>

              <!-- Non-Responders -->
              <div
                class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-700/50 rounded-lg p-4 cursor-pointer hover:shadow-md transition-shadow"
                onclick="filterStudentsByFlag('non-responder')">
                <div class="flex items-center gap-3 mb-2">
                  <span
                    class="material-symbols-outlined text-orange-600 dark:text-orange-400 text-2xl">person_off</span>
                  <h3 class="font-bold text-orange-800 dark:text-orange-300 text-sm">Non-Responders</h3>
                </div>
                <p class="text-3xl font-black text-orange-700 dark:text-orange-400" id="non-responder-count">0</p>
                <p class="text-xs text-orange-600/70 dark:text-orange-400/70 mt-1">Participation < 50%</p>
              </div>

              <!-- Rule Violators -->
              <div
                class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/50 rounded-lg p-4 cursor-pointer hover:shadow-md transition-shadow"
                onclick="filterStudentsByFlag('rule-violator')">
                <div class="flex items-center gap-3 mb-2">
                  <span class="material-symbols-outlined text-yellow-600 dark:text-yellow-400 text-2xl">warning</span>
                  <h3 class="font-bold text-yellow-800 dark:text-yellow-300 text-sm">Rule Violators</h3>
                </div>
                <p class="text-3xl font-black text-yellow-700 dark:text-yellow-400" id="rule-violator-count">0</p>
                <p class="text-xs text-yellow-600/70 dark:text-yellow-400/70 mt-1">2+ violations</p>
              </div>

              <!-- High Performers -->
              <div
                class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700/50 rounded-lg p-4 cursor-pointer hover:shadow-md transition-shadow"
                onclick="filterStudentsByFlag('high-performer')">
                <div class="flex items-center gap-3 mb-2">
                  <span class="material-symbols-outlined text-green-600 dark:text-green-400 text-2xl">trending_up</span>
                  <h3 class="font-bold text-green-800 dark:text-green-300 text-sm">High Performers</h3>
                </div>
                <p class="text-3xl font-black text-green-700 dark:text-green-400" id="high-performer-count">0</p>
                <p class="text-xs text-green-600/70 dark:text-green-400/70 mt-1">Accuracy  85%</p>
              </div>
            </div>

            <!-- Student List with Filtering -->
            <div
              class="bg-white dark:bg-brand-dark-gray/30 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg overflow-hidden">
              <div
                class="bg-brand-light-gray/50 dark:bg-brand-dark-gray/50 px-4 py-3 flex items-center justify-between">
                <h3 class="font-bold text-brand-dark-gray dark:text-brand-white">All Students</h3>
                <div class="flex items-center gap-2">
                  <button id="clear-student-filter-btn"
                    class="hidden px-3 py-1 bg-brand-dark-gray/10 hover:bg-brand-dark-gray/20 dark:bg-brand-white/10 dark:hover:bg-brand-white/20 rounded text-xs font-semibold transition-colors"
                    onclick="clearStudentFilter()">
                    Clear Filter
                  </button>
                  <span id="student-insights-filter-badge"
                    class="hidden px-2 py-1 bg-primary/20 text-primary text-xs font-bold rounded"></span>
                </div>
              </div>
              <div id="student-insights-table-container" class="overflow-x-auto max-h-96 overflow-y-auto">
                <table class="w-full">
                  <thead class="bg-brand-light-gray/30 dark:bg-brand-dark-gray/30 sticky top-0">
                    <tr>
                      <th
                        class="px-4 py-2 text-left text-xs font-bold text-brand-dark-gray/70 dark:text-brand-white/70 cursor-pointer hover:bg-brand-light-gray/50 dark:hover:bg-brand-dark-gray/50"
                        onclick="sortStudentsBy('name')">
                        Student <span class="material-symbols-outlined text-xs">unfold_more</span>
                      </th>
                      <th
                        class="px-4 py-2 text-center text-xs font-bold text-brand-dark-gray/70 dark:text-brand-white/70 cursor-pointer hover:bg-brand-light-gray/50 dark:hover:bg-brand-dark-gray/50"
                        onclick="sortStudentsBy('accuracy')">
                        Accuracy <span class="material-symbols-outlined text-xs">unfold_more</span>
                      </th>
                      <th
                        class="px-4 py-2 text-center text-xs font-bold text-brand-dark-gray/70 dark:text-brand-white/70 cursor-pointer hover:bg-brand-light-gray/50 dark:hover:bg-brand-dark-gray/50"
                        onclick="sortStudentsBy('participation')">
                        Participation <span class="material-symbols-outlined text-xs">unfold_more</span>
                      </th>
                      <th
                        class="px-4 py-2 text-center text-xs font-bold text-brand-dark-gray/70 dark:text-brand-white/70 cursor-pointer hover:bg-brand-light-gray/50 dark:hover:bg-brand-dark-gray/50"
                        onclick="sortStudentsBy('violations')">
                        Violations <span class="material-symbols-outlined text-xs">unfold_more</span>
                      </th>
                      <th
                        class="px-4 py-2 text-left text-xs font-bold text-brand-dark-gray/70 dark:text-brand-white/70">
                        Flags
                      </th>
                    </tr>
                  </thead>
                  <tbody id="student-insights-table-body">
                    <!-- Populated by JS -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Student Search -->
          <div id="analytics-student-search-container" class="relative mb-6">
            <input type="text" id="analytics-student-search" placeholder="Search for a student..."
              class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 pl-4 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 shadow-sm"
              autocomplete="off" />
            <button type="button"
              class="absolute inset-y-0 right-0 flex items-center px-2 text-gray-400 hover:text-gray-600 focus:outline-none"
              data-combobox-toggle>
              <span class="material-symbols-outlined text-lg">unfold_more</span>
            </button>
          </div>

          <!-- Student Detail -->
          <div id="analytics-student-detail" class="hidden">
            <div id="analytics-student-summary"
              class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5 mb-6">
              <!-- Student summary card -->
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5">
                <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Consistency Trend</h3>
                <div id="analytics-student-sparkline"></div>
              </div>
              <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5">
                <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Topic Mastery</h3>
                <div id="analytics-student-topics"></div>
              </div>
            </div>
          </div>

          <div id="analytics-student-empty" class="text-center py-12 text-brand-dark-gray/60 dark:text-brand-white/60">
            <p>Search for a student to view their analytics</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Poll Creation Wizard View - Compact Design -->
  <div id="create-poll-view" class="hidden h-full flex flex-col bg-white dark:bg-brand-dark-gray">

    <!-- Compact Header with Inline Progress -->
    <div
      class="wizard-header bg-gradient-to-r from-primary to-primary/90 px-4 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3 shrink-0">
        <h2 id="wizard-title" class="text-lg font-bold text-white">Create Poll</h2>
      </div>

      <!-- Inline Progress Steps (hidden - now in main header) -->
      <div class="wizard-progress hidden items-center gap-1 flex-1 justify-center max-w-xl">
        <div class="progress-step active flex items-center gap-1.5" data-step="1">
          <div
            class="progress-circle h-7 w-7 rounded-full bg-white/20 text-white text-xs font-bold flex items-center justify-center">
            1</div>
          <span class="progress-label text-white/80 text-xs font-medium hidden sm:inline">Mode</span>
        </div>
        <div class="progress-connector w-6 h-0.5 bg-white/30"></div>

        <div class="progress-step flex items-center gap-1.5" data-step="2">
          <div
            class="progress-circle h-7 w-7 rounded-full bg-white/20 text-white/70 text-xs font-bold flex items-center justify-center">
            2</div>
          <span class="progress-label text-white/60 text-xs font-medium hidden sm:inline">Configure</span>
        </div>
        <div class="progress-connector w-6 h-0.5 bg-white/30"></div>

        <div class="progress-step flex items-center gap-1.5" data-step="3">
          <div
            class="progress-circle h-7 w-7 rounded-full bg-white/20 text-white/70 text-xs font-bold flex items-center justify-center">
            3</div>
          <span class="progress-label text-white/60 text-xs font-medium hidden sm:inline">Questions</span>
        </div>
        <div class="progress-connector w-6 h-0.5 bg-white/30"></div>

        <div class="progress-step flex items-center gap-1.5" data-step="4">
          <div
            class="progress-circle h-7 w-7 rounded-full bg-white/20 text-white/70 text-xs font-bold flex items-center justify-center">
            4</div>
          <span class="progress-label text-white/60 text-xs font-medium hidden sm:inline">Review</span>
        </div>
      </div>

      <button type="button" onclick="closePollWizard()"
        class="shrink-0 h-8 w-8 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors"
        title="Close">
        <span class="material-symbols-outlined text-xl">close</span>
      </button>
    </div>

    <!-- Wizard Body - More Compact -->
    <div class="wizard-body flex-1 overflow-y-auto px-4 py-4 bg-slate-50 dark:bg-black/10">

      <!-- STEP 1: MODE SELECTION -->
      <div id="wizard-step-1" class="wizard-step active max-w-4xl mx-auto">
        <div class="text-center mb-10">
          <h3 class="text-3xl font-bold text-brand-dark-gray dark:text-white mb-3">Choose Your Poll Mode</h3>
          <p class="text-lg text-brand-dark-gray/60 dark:text-brand-white/60">Select the type of assessment
            experience for your students</p>
        </div>

        <div class="mode-cards grid grid-cols-1 md:grid-cols-2 gap-8">
          <button type="button"
            class="mode-card group relative overflow-hidden text-left p-8 rounded-2xl border-2 border-brand-light-gray hover:border-blue-500 hover:shadow-xl hover:-translate-y-1 transition-all duration-200"
            data-mode="live" onclick="selectPollMode('live')">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
              <span class="material-symbols-outlined text-9xl text-blue-500">groups</span>
            </div>
            <div class="relative z-10">
              <div
                class="h-14 w-14 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center mb-6 shadow-sm group-hover:scale-110 transition-transform">
                <span class="material-symbols-outlined text-3xl">groups</span>
              </div>
              <h4 class="text-xl font-bold text-brand-dark-gray dark:text-white mb-2">Live Poll</h4>
              <p class="text-brand-dark-gray/70 dark:text-brand-white/70 mb-6 leading-relaxed">Synchronous,
                teacher-paced questions for real-time class engagement and instant feedback.</p>
              <div class="flex flex-wrap gap-2">
                <span
                  class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-bold uppercase tracking-wider">Real-time</span>
                <span
                  class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-bold uppercase tracking-wider">Interactive</span>
              </div>
            </div>
          </button>

          <button type="button"
            class="mode-card group relative overflow-hidden text-left p-8 rounded-2xl border-2 border-brand-light-gray hover:border-amber-500 hover:shadow-xl hover:-translate-y-1 transition-all duration-200"
            data-mode="secure" onclick="selectPollMode('secure')">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
              <span class="material-symbols-outlined text-9xl text-amber-500">lock</span>
            </div>
            <div class="relative z-10">
              <div
                class="h-14 w-14 rounded-xl bg-amber-50 text-amber-600 flex items-center justify-center mb-6 shadow-sm group-hover:scale-110 transition-transform">
                <span class="material-symbols-outlined text-3xl">lock</span>
              </div>
              <h4 class="text-xl font-bold text-brand-dark-gray dark:text-white mb-2">Secure Assessment</h4>
              <p class="text-brand-dark-gray/70 dark:text-brand-white/70 mb-6 leading-relaxed">Asynchronous, timed
                exam with secure proctoring features and mission control monitoring.</p>
              <div class="flex flex-wrap gap-2">
                <span
                  class="px-3 py-1 rounded-full bg-amber-50 text-amber-700 text-xs font-bold uppercase tracking-wider">Timed</span>
                <span
                  class="px-3 py-1 rounded-full bg-amber-50 text-amber-700 text-xs font-bold uppercase tracking-wider">Proctored</span>
              </div>
            </div>
          </button>
        </div>
      </div>

      <!-- STEP 2: CONFIGURATION -->
      <div id="wizard-step-2" class="wizard-step hidden max-w-3xl mx-auto">
        <h3 class="text-2xl font-bold text-brand-dark-gray dark:text-white mb-6">Configure Your <span
            id="config-mode-label" class="text-blue-600">Poll</span></h3>

        <div
          class="bg-slate-50 dark:bg-white/5 rounded-xl p-6 border border-brand-light-gray dark:border-brand-dark-gray/40 space-y-6">
          <!-- Poll Name -->
          <div class="form-group">
            <label for="wizard-poll-name" class="block text-sm font-bold text-brand-dark-gray dark:text-white mb-2">Poll
              Name <span class="text-red-500">*</span></label>
            <input type="text" id="wizard-poll-name"
              class="w-full rounded-lg border border-brand-light-gray bg-white px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-shadow"
              placeholder="e.g., Chapter 5 Review" maxlength="100">
          </div>

          <!-- Class Selection -->
          <div class="form-group">
            <label for="wizard-class-select"
              class="block text-sm font-bold text-brand-dark-gray dark:text-white mb-2">Class <span
                class="text-red-500">*</span></label>
            <div class="relative">
              <select id="wizard-class-select"
                class="w-full rounded-lg border border-brand-light-gray bg-white px-4 py-3 text-base appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-shadow">
                <option value="">-- Select a class --</option>
              </select>
              <div
                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-brand-dark-gray/50">
                <span class="material-symbols-outlined">expand_more</span>
              </div>
            </div>
            <p class="text-xs text-brand-dark-gray/50 mt-2 flex items-center gap-1">
              <span class="material-symbols-outlined text-sm">info</span>
              Classes populate from your dashboard rosters.
            </p>
          </div>

          <!-- Secure Config -->
          <div id="secure-config-section"
            class="config-section hidden pt-6 mt-6 border-t border-brand-light-gray dark:border-brand-dark-gray/20">
            <h4 class="text-sm font-bold uppercase tracking-wider text-amber-600 mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-lg">shield_lock</span> Secure Settings
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="form-group">
                <label for="wizard-time-limit"
                  class="block text-sm font-bold text-brand-dark-gray dark:text-white mb-2">Time Limit (minutes)
                  <span class="text-red-500">*</span></label>
                <input type="number" id="wizard-time-limit"
                  class="w-full rounded-lg border border-brand-light-gray bg-white px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-amber-500/50 transition-shadow"
                  min="1" placeholder="45">
              </div>
              <!-- Add Access Code Field (missing in original) -->
              <div class="form-group">
                <label for="wizard-access-code"
                  class="block text-sm font-bold text-brand-dark-gray dark:text-white mb-2">Access Code
                  (Optional)</label>
                <input type="text" id="wizard-access-code"
                  class="w-full rounded-lg border border-brand-light-gray bg-white px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-amber-500/50 transition-shadow"
                  placeholder="e.g. EXAM2025">
              </div>
              <div class="form-group md:col-span-2">
                <div
                  class="flex items-start justify-between gap-4 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900 shadow-sm">
                  <div>
                    <div class="flex items-center gap-2 font-semibold">
                      <span class="material-symbols-outlined text-base">calculate</span>
                      TI-84 Calculator
                    </div>
                    <p class="mt-1 text-amber-800/80">Allow students to use a secure, embedded calculator during
                      this assessment.</p>
                  </div>
                  <label class="inline-flex items-center cursor-pointer select-none">
                    <input id="wizard-calculator-toggle" type="checkbox" class="peer sr-only">
                    <span
                      class="h-6 w-11 rounded-full bg-amber-200 peer-checked:bg-amber-500 transition-colors relative">
                      <span
                        class="absolute top-0.5 left-0.5 h-5 w-5 rounded-full bg-white shadow transition-all peer-checked:translate-x-5"></span>
                    </span>
                    <span class="ml-3 text-sm font-semibold text-amber-900 peer-checked:text-amber-800">Enable</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 3: QUESTIONS - Full Editor -->
      <div id="wizard-step-3" class="wizard-step hidden">
        <div class="max-w-5xl mx-auto">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h3 class="text-2xl font-bold text-brand-dark-gray dark:text-white">Build Your Questions</h3>
              <p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm mt-1">Add questions with multiple
                choice answers</p>
            </div>
            <span
              class="px-3 py-1.5 bg-green-50 text-green-700 text-xs font-bold rounded-full uppercase border border-green-200">
              Full Editor
            </span>
          </div>

          <!-- Questions Container - Populated by JS -->
          <div id="wizard-questions-list" class="questions-list space-y-6"></div>

          <button type="button"
            class="btn-add-question w-full mt-6 py-5 flex flex-col items-center justify-center gap-2 border-2 border-dashed border-brand-light-gray rounded-xl hover:border-primary hover:bg-primary/5 transition-all group bg-white"
            onclick="addWizardQuestion()">
            <div
              class="h-12 w-12 rounded-full bg-primary/10 text-primary flex items-center justify-center group-hover:scale-110 group-hover:bg-primary/20 transition-all">
              <span class="material-symbols-outlined text-2xl">add</span>
            </div>
            <span class="font-bold text-brand-dark-gray group-hover:text-primary transition-colors">Add New
              Question</span>
            <span class="text-xs text-brand-dark-gray/50">Click to add a multiple choice question</span>
          </button>
        </div>
      </div>

      <!-- STEP 4: REVIEW -->
      <div id="wizard-step-4" class="wizard-step hidden max-w-3xl mx-auto">
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Review & Publish</h3>

        <div class="review-section space-y-6">
          <div class="review-card bg-white border border-brand-light-gray rounded-xl p-6 shadow-sm">
            <h4 class="review-heading text-lg font-bold text-gray-900 mb-4 border-b border-brand-light-gray pb-2">
              Basic Information</h4>
            <dl class="review-details grid grid-cols-[140px_1fr] gap-4 text-sm">
              <dt class="font-semibold text-brand-dark-gray/60">Mode:</dt>
              <dd id="review-mode" class="font-medium text-brand-dark-gray">-</dd>
              <dt class="font-semibold text-brand-dark-gray/60">Name:</dt>
              <dd id="review-name" class="font-medium text-brand-dark-gray">-</dd>
              <dt class="font-semibold text-brand-dark-gray/60">Class:</dt>
              <dd id="review-class" class="font-medium text-brand-dark-gray">-</dd>
            </dl>
          </div>

          <div class="review-card bg-white border border-brand-light-gray rounded-xl p-6 shadow-sm">
            <h4 class="review-heading text-lg font-bold text-gray-900 mb-4 border-b border-brand-light-gray pb-2">
              Questions</h4>
            <div id="review-questions-summary" class="text-sm text-brand-dark-gray/80">
              <!-- Populated via JS -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      class="wizard-footer bg-white dark:bg-brand-dark-gray border-t border-brand-light-gray dark:border-brand-dark-gray/40 px-8 py-4 flex items-center justify-between">
      <button type="button"
        class="btn-secondary h-12 px-6 rounded-lg font-bold text-brand-dark-gray hover:bg-brand-light-gray/50 transition-colors disabled:opacity-50"
        id="wizard-back-btn" onclick="wizardGoBack()" disabled>Back</button>
      <div class="flex items-center gap-3">
        <button type="button"
          class="btn-secondary h-12 px-6 rounded-lg font-bold text-red-600 hover:bg-red-50 transition-colors"
          onclick="closePollWizard()">Cancel</button>
        <button type="button"
          class="btn-primary h-12 px-8 rounded-lg bg-primary text-white font-bold shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all"
          id="wizard-next-btn" onclick="wizardGoNext()">Next</button>
        <button type="button"
          class="btn-primary hidden h-12 px-8 rounded-lg bg-green-600 text-white font-bold shadow-md hover:shadow-lg hover:-translate-y-0.5 hover:bg-green-700 transition-all flex items-center gap-2"
          id="wizard-publish-btn" onclick="publishWizardPoll()">
          <span class="material-symbols-outlined">rocket_launch</span>
          Publish Poll
        </button>
      </div>
    </div>
  </div>
</div>
</main>

</div>
</div>

<!-- Student Manager Modal -->
<div id="student-manager-modal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-slate-900/60" data-student-manager-close="true"></div>
  <div
    class="relative w-full max-w-2xl mx-auto my-12 bg-white dark:bg-brand-dark-gray rounded-2xl shadow-2xl border border-brand-light-gray dark:border-brand-dark-gray/40">
    <div class="flex items-start justify-between gap-4 p-6 border-b border-slate-100 dark:border-brand-dark-gray/60">
      <div>
        <p class="text-xs font-semibold tracking-[0.2em] uppercase text-slate-500">Student Manager</p>
        <h3 id="student-manager-name" class="text-2xl font-bold text-brand-dark-gray dark:text-white">Student Name</h3>
        <p id="student-manager-status" class="text-sm font-semibold text-slate-500">Status</p>
      </div>
      <button id="student-manager-close"
        class="h-10 w-10 inline-flex items-center justify-center rounded-full bg-slate-100 dark:bg-brand-dark-gray/70 text-slate-600 dark:text-white hover:bg-slate-200">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="p-6 space-y-6">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="p-3 rounded-xl bg-slate-50 dark:bg-brand-dark-gray/40">
          <p class="text-xs font-semibold uppercase text-slate-500">Question</p>
          <p id="student-manager-progress" class="text-xl font-bold text-brand-dark-gray dark:text-white">--</p>
        </div>
        <div class="p-3 rounded-xl bg-slate-50 dark:bg-brand-dark-gray/40">
          <p class="text-xs font-semibold uppercase text-slate-500">Time Remaining</p>
          <p id="student-manager-time" class="text-xl font-bold text-brand-dark-gray dark:text-white">--:--</p>
        </div>
        <div class="p-3 rounded-xl bg-slate-50 dark:bg-brand-dark-gray/40">
          <p class="text-xs font-semibold uppercase text-slate-500">Extra Time</p>
          <p id="student-manager-extra" class="text-xl font-bold text-brand-dark-gray dark:text-white">+0m</p>
        </div>
        <div class="p-3 rounded-xl bg-slate-50 dark:bg-brand-dark-gray/40">
          <p class="text-xs font-semibold uppercase text-slate-500">Connection</p>
          <div class="flex items-center gap-2">
            <span id="student-manager-connection-dot" class="h-3 w-3 rounded-full bg-slate-300"></span>
            <p id="student-manager-connection" class="text-sm font-semibold text-brand-dark-gray dark:text-white">
              Unknown</p>
          </div>
        </div>
      </div>
      <div class="rounded-2xl border border-slate-200 dark:border-brand-dark-gray/60 p-4">
        <p class="text-sm font-semibold text-slate-600 dark:text-slate-300 mb-3">Time Controls</p>
        <div class="flex flex-wrap items-center gap-2">
          <button id="student-manager-add-5"
            class="inline-flex items-center gap-2 rounded-full bg-emerald-600 text-white px-4 py-2 text-sm font-semibold shadow hover:bg-emerald-700">
            <span class="material-symbols-outlined text-base">add</span>
            +5 min
          </button>
          <button id="student-manager-add-10"
            class="inline-flex items-center gap-2 rounded-full bg-emerald-600 text-white px-4 py-2 text-sm font-semibold shadow hover:bg-emerald-700">
            <span class="material-symbols-outlined text-base">add</span>
            +10 min
          </button>
          <button id="student-manager-pause"
            class="inline-flex items-center gap-2 rounded-full bg-amber-500 text-white px-4 py-2 text-sm font-semibold shadow hover:bg-amber-600">
            <span class="material-symbols-outlined text-base">pause_circle</span>
            Pause Timer
          </button>
        </div>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <button id="student-manager-unlock"
          class="inline-flex items-center gap-2 rounded-full bg-blue-600 text-white px-5 py-2 text-sm font-semibold shadow hover:bg-blue-700">
          <span class="material-symbols-outlined text-base">lock_open</span>
          Approve Unlock
        </button>
        <button id="student-manager-force-submit"
          class="inline-flex items-center gap-2 rounded-full bg-red-600 text-white px-5 py-2 text-sm font-semibold shadow hover:bg-red-700">
          <span class="material-symbols-outlined text-base">task</span>
          Force Submit
        </button>
        <p id="student-manager-message" class="text-sm text-slate-500"></p>
      </div>
      <div id="student-manager-loading" class="hidden text-sm text-slate-500">Working...</div>
    </div>
  </div>
</div>

<!-- Book View Modal -->
<div id="book-view-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
  <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeBookView()"></div>
  <div
    class="relative w-full max-w-[95vw] mx-auto my-8 bg-white dark:bg-brand-dark-gray rounded-2xl shadow-2xl border border-brand-light-gray dark:border-brand-dark-gray/40">
    <!-- Header -->
    <div
      class="sticky top-0 z-10 flex items-start justify-between gap-4 p-6 border-b border-slate-200 dark:border-brand-dark-gray/60 bg-white dark:bg-brand-dark-gray">
      <div>
        <div class="flex items-center gap-3 mb-2">
          <span class="material-symbols-outlined text-3xl text-veritas-gold">menu_book</span>
          <h2 id="book-view-title" class="text-3xl font-bold text-brand-dark-gray dark:text-white">Assessment Book View
          </h2>
        </div>
        <p id="book-view-subtitle" class="text-sm text-slate-500">Comprehensive student performance analysis</p>
      </div>
      <button onclick="closeBookView()"
        class="h-10 w-10 inline-flex items-center justify-center rounded-full bg-slate-100 dark:bg-brand-dark-gray/70 text-slate-600 dark:text-white hover:bg-slate-200 transition-colors">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <div id="book-view-loading" class="p-12 text-center">
      <div class="flex flex-row gap-2 justify-center mb-4">
        <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce"></div>
        <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.3s]"></div>
        <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.5s]"></div>
      </div>
      <p class="mt-4 text-slate-600 dark:text-slate-400">Loading book view data...</p>
    </div>

    <div id="book-view-content" class="hidden p-6 space-y-6">
      <!-- Class Overview Section -->
      <div class="bg-gradient-to-r from-veritas-navy to-veritas-navy/80 rounded-xl p-6 text-white shadow-lg">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
          <span class="material-symbols-outlined">analytics</span>
          Class Overview
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
            <p class="text-sm opacity-80">Total Students</p>
            <p id="book-class-total-students" class="text-3xl font-bold">0</p>
          </div>
          <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
            <p class="text-sm opacity-80">Class Average</p>
            <p id="book-class-average" class="text-3xl font-bold">0%</p>
          </div>
          <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
            <p class="text-sm opacity-80">Median Score</p>
            <p id="book-class-median" class="text-3xl font-bold">0</p>
          </div>
          <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
            <p class="text-sm opacity-80">Std. Deviation</p>
            <p id="book-class-stddev" class="text-3xl font-bold">0.0</p>
          </div>
        </div>
        <div id="book-class-interpretation" class="mt-4 p-3 bg-white/10 backdrop-blur-sm rounded-lg text-sm">
          <!-- Interpretation messages will be inserted here -->
        </div>
      </div>

      <!-- View Toggle -->
      <div class="flex gap-3 border-b border-slate-200 dark:border-brand-dark-gray/40">
        <button id="book-tab-students"
          class="px-6 py-3 font-semibold text-sm transition-colors border-b-2 border-veritas-gold text-veritas-gold">
          Student Roster
        </button>
        <button id="book-tab-questions"
          class="px-6 py-3 font-semibold text-sm transition-colors border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-veritas-gold hover:border-veritas-gold/30">
          Question Analysis
        </button>
        <button id="book-tab-matrix"
          class="px-6 py-3 font-semibold text-sm transition-colors border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-veritas-gold hover:border-veritas-gold/30">
          Response Matrix
        </button>
      </div>

      <!-- Student Roster Tab -->
      <div id="book-content-students" class="book-tab-content">
        <div
          class="bg-white dark:bg-brand-dark-gray/30 rounded-xl border border-slate-200 dark:border-brand-dark-gray/40 overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-slate-100 dark:bg-brand-dark-gray/50">
                <tr>
                  <th
                    class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-700 dark:text-slate-300">
                    Rank</th>
                  <th
                    class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-700 dark:text-slate-300">
                    Student Name</th>
                  <th
                    class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wide text-slate-700 dark:text-slate-300">
                    Score</th>
                  <th
                    class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wide text-slate-700 dark:text-slate-300">
                    Percentage</th>
                  <th
                    class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wide text-slate-700 dark:text-slate-300">
                    Percentile</th>
                  <th
                    class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wide text-slate-700 dark:text-slate-300">
                    Actions</th>
                </tr>
              </thead>
              <tbody id="book-students-table-body" class="divide-y divide-slate-200 dark:divide-brand-dark-gray/40">
                <!-- Student rows will be inserted here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Question Analysis Tab -->
      <div id="book-content-questions" class="book-tab-content hidden">
        <div class="space-y-4" id="book-questions-container">
          <!-- Question analysis cards will be inserted here -->
        </div>
      </div>

      <!-- Response Matrix Tab -->
      <div id="book-content-matrix" class="book-tab-content hidden">
        <div
          class="bg-white dark:bg-brand-dark-gray/30 rounded-xl border border-slate-200 dark:border-brand-dark-gray/40 overflow-hidden">
          <div class="p-4 bg-slate-100 dark:bg-brand-dark-gray/50">
            <h3 class="text-lg font-bold text-brand-dark-gray dark:text-white">Complete Response Matrix</h3>
            <p class="text-sm text-slate-600 dark:text-slate-400">Each cell shows student's answer with
              correct/incorrect indicator</p>
          </div>
          <div class="overflow-x-auto p-4">
            <table class="w-full text-xs">
              <thead>
                <tr id="book-matrix-header-row">
                  <th
                    class="sticky left-0 bg-slate-100 dark:bg-brand-dark-gray/50 px-3 py-2 text-left font-semibold border-r border-slate-300 dark:border-brand-dark-gray/60">
                    Student</th>
                  <!-- Question headers will be injected here -->
                  <th class="bg-slate-100 dark:bg-brand-dark-gray/50 px-3 py-2 text-center font-semibold">Total</th>
                </tr>
              </thead>
              <tbody id="book-matrix-table-body">
                <!-- Matrix rows will be inserted here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Individual Student Detail View (expandable) -->
      <div id="book-student-detail" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeStudentDetail()"></div>
        <div
          class="relative w-full max-w-5xl mx-auto my-8 bg-white dark:bg-brand-dark-gray rounded-2xl shadow-2xl border border-brand-light-gray dark:border-brand-dark-gray/40">
          <div
            class="sticky top-0 z-10 flex items-start justify-between gap-4 p-6 border-b border-slate-200 dark:border-brand-dark-gray/60 bg-white dark:bg-brand-dark-gray">
            <div>
              <h3 id="student-detail-name" class="text-2xl font-bold text-brand-dark-gray dark:text-white">Student Name
              </h3>
              <div class="flex items-center gap-4 mt-2 text-sm text-slate-600 dark:text-slate-400">
                <span>Score: <strong id="student-detail-score">0/0</strong></span>
                <span>Percentage: <strong id="student-detail-percentage">0%</strong></span>
                <span>Rank: <strong id="student-detail-rank">0</strong></span>
                <span>Percentile: <strong id="student-detail-percentile">0th</strong></span>
              </div>
            </div>
            <button onclick="closeStudentDetail()"
              class="h-10 w-10 inline-flex items-center justify-center rounded-full bg-slate-100 dark:bg-brand-dark-gray/70 text-slate-600 dark:text-white hover:bg-red-500 hover:text-white transition-colors focus:outline-none focus:ring-2 focus:ring-red-500"
              title="Close" aria-label="Close student detail view">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
          <div class="p-6 max-h-[70vh] overflow-y-auto">
            <div id="student-detail-responses" class="space-y-4">
              <!-- Question-by-question responses will be inserted here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="book-view-error" class="hidden p-12 text-center">
      <span class="material-symbols-outlined text-6xl text-red-500">error</span>
      <p class="mt-4 text-lg font-semibold text-slate-800 dark:text-slate-200">Error Loading Data</p>
      <p id="book-view-error-message" class="text-slate-600 dark:text-slate-400"></p>
    </div>
  </div>



  <!-- Poll Creator Modal -->
  <div id="poll-creator-modal"
    class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div
      class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/20 z-10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img alt="Malvern Prep Logo" class="h-8 w-auto"
            src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png" />
          <input type="text" id="new-poll-name" placeholder="Chapter 5 Quiz"
            class="bg-transparent text-brand-white text-xl font-bold border-none focus:ring-0 p-0 placeholder-brand-white/70 min-w-[300px]" />
        </div>
        <div class="flex items-center gap-2">
          <span id="save-status" class="text-sm text-brand-white/80 mr-2">All changes saved</span>
          <button id="close-modal-btn"
            class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-white/30 transition-colors">
            <span class="truncate">Cancel</span>
          </button>
          <button id="save-poll-btn"
            class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-white text-primary text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray transition-colors">
            <span class="truncate">Publish Poll</span>
          </button>
        </div>
      </div>

      <div class="flex flex-grow overflow-hidden">
        <!-- Question Navigator Sidebar -->
        <aside
          class="w-64 flex-shrink-0 border-r border-solid border-brand-light-gray dark:border-brand-dark-gray/20 bg-brand-white dark:bg-background-dark overflow-y-auto">
          <div class="flex h-full flex-col justify-between p-4">
            <div class="mb-4">
              <p
                class="text-xs font-semibold uppercase tracking-[0.2em] text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">
                Question Order</p>
              <div class="flex items-start justify-between gap-2">
                <p id="question-sort-help"
                  class="flex-1 text-xs leading-relaxed text-brand-dark-gray/60 dark:text-brand-white/60">Drag questions
                  to reorder them manually.</p>
                <button id="question-sort-reset-btn" type="button"
                  class="h-9 px-3 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 bg-brand-white dark:bg-brand-dark-gray/30 text-xs font-semibold text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/40 dark:hover:bg-brand-dark-gray/50 transition-colors">Reset
                  order</button>
              </div>
            </div>
            <div id="question-navigator" class="flex flex-col gap-2">
              <!-- Question items will be added dynamically -->
            </div>
            <button id="add-question-btn"
              class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary/20 dark:bg-primary/30 text-primary dark:text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/30 dark:hover:bg-primary/40 transition-colors mt-4">
              <span class="truncate">+ Add Question</span>
            </button>
            <!-- NEW FEATURE: Import from Question Bank -->
            <button id="import-from-bank-btn"
              class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 bg-amber-500/20 dark:bg-amber-500/30 text-amber-700 dark:text-amber-200 text-sm font-semibold leading-normal tracking-[0.015em] hover:bg-amber-500/30 dark:hover:bg-amber-500/40 transition-colors mt-2">
              <span class="material-symbols-outlined text-base">inventory_2</span>
              <span class="truncate">Import from Bank</span>
            </button>
            <!-- AP BIOLOGY 2025 TOPIC TAGGER -->
            <button id="ai-suggest-btn"
              class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 bg-green-500/20 dark:bg-green-500/30 text-green-700 dark:text-green-200 text-sm font-semibold leading-normal tracking-[0.015em] hover:bg-green-500/30 dark:hover:bg-green-500/40 transition-colors mt-2">
              <span class="material-symbols-outlined text-base">science</span>
              <span class="truncate"> AP Bio Topics</span>
            </button>
            <!-- NEW FEATURE: Stimulus/Passage for grouped questions -->
            <button id="add-stimulus-btn"
              class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 bg-emerald-500/20 dark:bg-emerald-500/30 text-emerald-700 dark:text-emerald-200 text-sm font-semibold leading-normal tracking-[0.015em] hover:bg-emerald-500/30 dark:hover:bg-emerald-500/40 transition-colors mt-2">
              <span class="material-symbols-outlined text-base">article</span>
              <span class="truncate">Add Stimulus/Passage</span>
            </button>
          </div>
        </aside>

        <!-- Editing Workspace -->
        <main class="flex-1 p-8 overflow-y-auto">
          <div class="form-group mb-6">
            <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white"
              for="class-select">Class</label>
            <select id="class-select"
              class="w-full max-w-md rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
              <option value="">-- Select Class --</option>
            </select>
          </div>

          <div
            class="bg-brand-white dark:bg-brand-dark-gray/20 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm mb-6">
            <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
              <div>
                <p
                  class="text-xs font-semibold uppercase tracking-[0.2em] text-brand-dark-gray/60 dark:text-brand-white/60">
                  Session Mode</p>
                <h3 class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white mt-1">Choose how students will
                  experience this activity</h3>
                <p class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 mt-2">Use Live Poll for synchronous,
                  teacher-paced checks. Secure Assessment enables timed, randomized, proctored exams.</p>
              </div>
              <div
                class="inline-flex rounded-full border border-brand-light-gray dark:border-brand-dark-gray/50 overflow-hidden">
                <button type="button" id="builder-mode-live" data-session-type="LIVE_POLL"
                  class="builder-session-toggle px-4 py-2 text-sm font-semibold transition-colors focus:outline-none">Live
                  Poll</button>
                <button type="button" id="builder-mode-secure" data-session-type="SECURE_ASSESSMENT"
                  class="builder-session-toggle px-4 py-2 text-sm font-semibold transition-colors focus:outline-none">Secure
                  Assessment</button>
              </div>
            </div>

            <div id="secure-assessment-settings" class="mt-5 hidden">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                <div>
                  <label for="secure-time-limit-input"
                    class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Time Limit
                    (minutes)</label>
                  <input id="secure-time-limit-input" type="number" min="5" step="5" placeholder="60"
                    class="mt-2 w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/40" />
                  <p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-2">Required for Secure
                    Assessments. Each student receives a personal countdown.</p>
                </div>
                <div>
                  <label for="secure-access-code-input"
                    class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Access Code
                    (optional)</label>
                  <input id="secure-access-code-input" type="text" maxlength="24" placeholder="BIO101"
                    class="mt-2 w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/40 uppercase tracking-[0.2em]" />
                  <p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-2">Students must enter this code
                    before the exam begins.</p>
                </div>
                <div>
                  <label for="secure-available-input"
                    class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Available From</label>
                  <input id="secure-available-input" type="datetime-local"
                    class="mt-2 w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/40" />
                  <p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-2">Students cannot start before
                    this window opens.</p>
                </div>
                <div>
                  <label for="secure-due-input"
                    class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Due By</label>
                  <input id="secure-due-input" type="datetime-local"
                    class="mt-2 w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/40" />
                  <p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-2">Sessions end automatically
                    after this deadline.</p>
                </div>
              </div>

              <div
                class="mt-5 flex items-start gap-3 rounded-xl border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/20 p-4">
                <span class="material-symbols-outlined text-blue-600 dark:text-blue-300">shield_lock</span>
                <div>
                  <p class="text-sm font-semibold text-blue-900 dark:text-blue-200">Secure Assessment requirements</p>
                  <p class="text-sm text-blue-900/80 dark:text-blue-100/70 mt-1">Students must stay in fullscreen, avoid
                    tab switching, and will appear in Mission Control for live monitoring.</p>
                </div>
              </div>
            </div>
          </div>


          <div id="question-builder-workspace">
            <!-- Question editing workspace will be populated dynamically -->
          </div>
      </div>
    </div>
  </div>

  <!-- NEW FEATURE: Question Bank Import Modal -->
  <div id="question-bank-modal"
    class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div
      class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="sticky top-0 bg-amber-600 px-6 py-4 border-b border-amber-700 z-10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="material-symbols-outlined text-white text-2xl">inventory_2</span>
          <div>
            <h2 class="text-white text-xl font-bold">Question Bank</h2>
            <p class="text-white/80 text-sm">Import questions from previous polls</p>
          </div>
        </div>
        <button id="close-question-bank-btn"
          class="h-10 px-4 rounded-lg bg-white/20 text-white text-sm font-bold hover:bg-white/30 transition-colors">
          Close
        </button>
      </div>
      <div class="p-6 flex-1 overflow-y-auto">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Filter by
            Poll</label>
          <select id="bank-poll-filter"
            class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-white dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500/50">
            <option value="">All Polls</option>
          </select>
        </div>
        <div id="bank-questions-container" class="space-y-3 max-h-[50vh] overflow-y-auto">
          <p class="text-center text-brand-dark-gray/60 dark:text-brand-white/60 py-8">Loading questions...</p>
        </div>
      </div>
      <div
        class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-brand-light-gray dark:border-brand-dark-gray/40 flex justify-between items-center">
        <span id="bank-selected-count" class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70">0 questions
          selected</span>
        <button id="import-selected-btn"
          class="h-10 px-6 rounded-lg bg-amber-600 text-white text-sm font-bold hover:bg-amber-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          disabled>
          Import Selected
        </button>
      </div>
    </div>
  </div>

  <!-- AP BIOLOGY 2025 TOPIC TAGGER -->
  <div id="ai-suggestions-modal"
    class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div
      class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
      <div
        class="sticky top-0 bg-gradient-to-r from-green-700 to-emerald-600 px-6 py-4 border-b border-green-800 z-10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="material-symbols-outlined text-white text-2xl">science</span>
          <div>
            <h2 class="text-white text-xl font-bold">AP Biology 2025 Topic Tagger</h2>
            <p class="text-white/80 text-sm">Align questions with the official AP Bio curriculum</p>
          </div>
        </div>
        <button id="close-ai-modal-btn"
          class="h-10 px-4 rounded-lg bg-white/20 text-white text-sm font-bold hover:bg-white/30 transition-colors">
          Close
        </button>
      </div>
      <div class="p-6 flex-1 overflow-y-auto">
        <div
          class="mb-4 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-700/30">
          <p class="text-sm font-medium text-green-900 dark:text-green-200 mb-2">Current Question:</p>
          <p id="ai-current-question" class="text-sm text-green-800 dark:text-green-300 italic">"No question text
            entered"</p>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-semibold mb-2 text-brand-dark-gray dark:text-brand-white">Select AP Bio
            Unit</label>
          <select id="apbio-unit-select"
            class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-white dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500/50">
            <option value="">-- Select Unit --</option>
            <option value="Unit 1">Unit 1: Chemistry of Life (8-11%)</option>
            <option value="Unit 2">Unit 2: Cell Structure and Function (10-13%)</option>
            <option value="Unit 3">Unit 3: Cellular Energetics (12-16%)</option>
            <option value="Unit 4">Unit 4: Cell Communication and Cell Cycle (10-15%)</option>
            <option value="Unit 5">Unit 5: Heredity (8-11%)</option>
            <option value="Unit 6">Unit 6: Gene Expression and Regulation (12-16%)</option>
            <option value="Unit 7">Unit 7: Natural Selection (13-20%)</option>
            <option value="Unit 8">Unit 8: Ecology (10-15%)</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-semibold mb-2 text-brand-dark-gray dark:text-brand-white">Select
            Topic</label>
          <select id="apbio-topic-select"
            class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-white dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500/50"
            disabled>
            <option value="">-- Select Unit First --</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-semibold mb-2 text-brand-dark-gray dark:text-brand-white">Big Idea
            Connection</label>
          <div class="grid grid-cols-2 gap-2">
            <label
              class="flex items-center gap-2 p-3 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors">
              <input type="checkbox" id="bigidea-evo"
                class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
              <span class="text-sm text-brand-dark-gray dark:text-brand-white"><strong>EVO</strong> - Evolution</span>
            </label>
            <label
              class="flex items-center gap-2 p-3 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors">
              <input type="checkbox" id="bigidea-ene"
                class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
              <span class="text-sm text-brand-dark-gray dark:text-brand-white"><strong>ENE</strong> - Energetics</span>
            </label>
            <label
              class="flex items-center gap-2 p-3 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors">
              <input type="checkbox" id="bigidea-ist"
                class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
              <span class="text-sm text-brand-dark-gray dark:text-brand-white"><strong>IST</strong> - Information
                Storage</span>
            </label>
            <label
              class="flex items-center gap-2 p-3 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors">
              <input type="checkbox" id="bigidea-syi"
                class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
              <span class="text-sm text-brand-dark-gray dark:text-brand-white"><strong>SYI</strong> - Systems
                Interactions</span>
            </label>
          </div>
        </div>

        <div id="apbio-preview"
          class="p-4 bg-slate-50 dark:bg-slate-800/30 rounded-lg border border-slate-200 dark:border-slate-700/30 hidden">
          <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-2">Tag Preview
          </p>
          <p id="apbio-tag-preview" class="text-sm font-medium text-brand-dark-gray dark:text-brand-white"></p>
        </div>
      </div>
      <div
        class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-brand-light-gray dark:border-brand-dark-gray/40 flex justify-end gap-3">
        <button id="cancel-apbio-btn"
          class="h-10 px-6 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white text-sm font-bold hover:bg-brand-light-gray/30 transition-colors">
          Cancel
        </button>
        <button id="generate-ai-btn"
          class="h-10 px-6 rounded-lg bg-gradient-to-r from-green-600 to-emerald-600 text-white text-sm font-bold hover:from-green-700 hover:to-emerald-700 transition-colors flex items-center gap-2">
          <span class="material-symbols-outlined text-base">label</span>
          Apply Topic Tag
        </button>
      </div>
    </div>
  </div>

  <!-- NEW FEATURE: Stimulus/Passage Modal -->
  <div id="stimulus-modal"
    class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div
      class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
      <div
        class="sticky top-0 bg-gradient-to-r from-emerald-600 to-teal-600 px-6 py-4 border-b border-emerald-700 z-10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="material-symbols-outlined text-white text-2xl">article</span>
          <div>
            <h2 class="text-white text-xl font-bold">Add Stimulus/Passage</h2>
            <p class="text-white/80 text-sm">Create a shared passage for multiple questions</p>
          </div>
        </div>
        <button id="close-stimulus-modal-btn"
          class="h-10 px-4 rounded-lg bg-white/20 text-white text-sm font-bold hover:bg-white/30 transition-colors">
          Close
        </button>
      </div>
      <div class="p-6 flex-1 overflow-y-auto">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Stimulus
            Title</label>
          <input type="text" id="stimulus-title-input"
            class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-white dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/50"
            placeholder="e.g., Reading Passage 1, Experiment Data Table">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Passage
            Content</label>
          <textarea id="stimulus-content-input" rows="8"
            class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-white dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/50 resize-y"
            placeholder="Enter the reading passage, experiment description, data table, or other stimulus material that students should reference when answering the following questions..."></textarea>
        </div>
        <div
          class="mb-4 p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg border border-emerald-200 dark:border-emerald-700/30">
          <p class="text-xs text-emerald-800 dark:text-emerald-200"><span class="font-semibold">Tip:</span> After
            creating a stimulus, add questions that reference it. The stimulus will be displayed above those questions
            during the assessment.</p>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Number of Questions
            to Create</label>
          <input type="number" id="stimulus-question-count" min="1" max="10" value="2"
            class="w-32 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-white dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/50">
        </div>
      </div>
      <div
        class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-brand-light-gray dark:border-brand-dark-gray/40 flex justify-end gap-3">
        <button id="cancel-stimulus-btn"
          class="h-10 px-6 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white text-sm font-bold hover:bg-brand-light-gray/30 transition-colors">
          Cancel
        </button>
        <button id="create-stimulus-btn"
          class="h-10 px-6 rounded-lg bg-emerald-600 text-white text-sm font-bold hover:bg-emerald-700 transition-colors">
          Create Stimulus & Questions
        </button>
      </div>
    </div>
  </div>

  <!-- Student Links Modal -->
  <div id="student-links-modal"
    class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div
      class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/70">
        <h2 class="text-brand-white text-2xl font-bold">Student Personalized Links</h2>
        <p class="text-brand-white/80 text-sm mt-1">Each student has a unique tracking link.</p>
      </div>
      <div class="p-6">
        <div id="links-container" class="max-h-[60vh] overflow-y-auto"></div>
        <div class="mt-6 pt-4 border-t border-primary/20">
          <button id="close-links-modal-btn"
            class="flex items-center justify-center gap-2 rounded-lg h-10 px-6 bg-primary text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
            <span>Close</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Add Students Modal -->
  <div id="bulk-add-students-modal"
    class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div
      class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/70">
        <h2 class="text-brand-white text-2xl font-bold">Bulk Add Students</h2>
        <p class="text-brand-white/80 text-sm mt-1">Add multiple students at once. Enter one student per line in format:
          Name, Email</p>
      </div>
      <div class="p-6 flex-1 overflow-y-auto">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Student Data</label>
          <textarea id="bulk-student-input"
            class="w-full h-64 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 font-mono"
            placeholder="John Smith, jsmith@school.edu&#10;Jane Doe, jdoe@school.edu&#10;Bob Johnson, bjohnson@school.edu"></textarea>
          <p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-2">Format: Name, Email (one per line).
            Duplicates will be skipped automatically.</p>
        </div>
      </div>
      <div
        class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-primary/20 flex justify-end gap-3">
        <button id="cancel-bulk-add-btn"
          class="h-10 px-5 rounded-lg bg-brand-dark-gray/10 dark:bg-brand-white/10 text-brand-dark-gray dark:text-brand-white text-sm font-semibold hover:bg-brand-dark-gray/20 dark:hover:bg-brand-white/20 transition-colors">Cancel</button>
        <button id="confirm-bulk-add-btn"
          class="h-10 px-5 rounded-lg bg-primary text-brand-white text-sm font-bold hover:bg-primary/90 transition-colors">Add
          Students</button>
      </div>
    </div>
  </div>

  <!-- Poll Preview Modal -->
  <div id="poll-preview-modal"
    class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div
      class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header -->
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/70">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <h2 id="preview-poll-name" class="text-brand-white text-2xl font-bold">Poll Preview</h2>
            <p id="preview-poll-meta" class="text-brand-white/80 text-sm mt-1">Class Name  5 Questions</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="preview-open-links-btn"
              class="flex items-center justify-center gap-2 h-10 px-5 rounded-lg bg-green-600 text-white text-sm font-semibold hover:bg-green-700 transition-colors">
              <span class="material-symbols-outlined text-lg">link</span>
              <span>View Student Links</span>
            </button>
            <button id="close-preview-modal-btn"
              class="flex items-center justify-center h-10 w-10 rounded-lg bg-brand-white/20 text-brand-white hover:bg-brand-white/30 transition-colors">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Body -->
      <div class="flex-1 overflow-hidden flex">
        <!-- Left Sidebar - Question Navigation -->
        <div
          class="w-64 border-r border-brand-light-gray dark:border-brand-dark-gray/40 overflow-y-auto bg-gray-50 dark:bg-brand-dark-gray/20">
          <div class="p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Questions</h3>
              <button id="preview-reorder-btn"
                class="text-xs px-2 py-1 rounded bg-brand-dark-gray/10 dark:bg-brand-white/10 text-brand-dark-gray dark:text-brand-white hover:bg-brand-dark-gray/20 dark:hover:bg-brand-white/20 transition-colors">
                <span class="material-symbols-outlined text-sm align-middle">swap_vert</span>
              </button>
            </div>
            <div id="preview-questions-nav" class="space-y-2">
              <!-- Question navigation items will be added here -->
            </div>
          </div>
        </div>

        <!-- Main Content - Question Display -->
        <div class="flex-1 overflow-y-auto p-6">
          <div id="preview-question-display">
            <!-- Question content will be displayed here -->
          </div>
        </div>
      </div>

      <!-- Footer - Navigation Controls -->
      <div
        class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-brand-light-gray dark:border-brand-dark-gray/40 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <button id="preview-edit-question-btn"
            class="h-10 px-4 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors">
            <span class="material-symbols-outlined text-sm align-middle mr-1">edit</span>
            Edit Question
          </button>
          <button id="preview-delete-question-btn"
            class="h-10 px-4 rounded-lg bg-red-600/10 text-red-600 dark:bg-red-500/20 dark:text-red-300 text-sm font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors">
            <span class="material-symbols-outlined text-sm align-middle mr-1">delete</span>
            Delete
          </button>
        </div>
        <div class="flex items-center gap-2">
          <button id="preview-prev-question-btn"
            class="h-10 px-4 rounded-lg bg-brand-dark-gray/10 dark:bg-brand-white/10 text-brand-dark-gray dark:text-brand-white text-sm font-semibold hover:bg-brand-dark-gray/20 dark:hover:bg-brand-white/20 transition-colors">
            <span class="material-symbols-outlined text-sm align-middle mr-1">arrow_back</span>
            Previous
          </button>
          <span id="preview-question-counter" class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60 px-2">1 /
            5</span>
          <button id="preview-next-question-btn"
            class="h-10 px-4 rounded-lg bg-brand-dark-gray/10 dark:bg-brand-white/10 text-brand-dark-gray dark:text-brand-white text-sm font-semibold hover:bg-brand-dark-gray/20 dark:hover:bg-brand-white/20 transition-colors">
            Next
            <span class="material-symbols-outlined text-sm align-middle ml-1">arrow_forward</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Post-Poll Analytics Modal -->
  <div id="post-poll-analytics-modal"
    class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div
      class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-7xl max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header -->
      <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-4 border-b border-white/20">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <h2 id="analytics-poll-name" class="text-brand-white text-2xl font-bold">Psychometric Analysis</h2>
            <p id="analytics-poll-meta" class="text-brand-white/90 text-sm mt-1">Professional Assessment Quality Report
            </p>
          </div>
          <button id="close-analytics-modal-btn"
            class="flex items-center justify-center h-10 w-10 rounded-lg bg-brand-white/20 text-brand-white hover:bg-brand-white/30 transition-colors">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
      </div>

      <!-- Body -->
      <div class="flex-1 overflow-y-auto p-6">
        <div id="analytics-content">
          <!-- Loading state -->
          <div id="analytics-loading" class="flex items-center justify-center py-12">
            <div class="flex flex-col items-center gap-3">
              <div class="flex flex-row gap-2 justify-center mb-1">
                <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce"></div>
                <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.3s]"></div>
                <div class="w-4 h-4 rounded-full bg-veritas-navy animate-bounce [animation-delay:-.5s]"></div>
              </div>
              <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Computing analytics...</p>
            </div>
          </div>

          <!-- Content will be rendered here -->
          <div id="analytics-report" class="hidden">
            <!-- Action Items / Insights Section -->
            <div id="analytics-actions-container" class="mb-6 empty:hidden"></div>

            <!-- Class Overview Section -->
            <div class="mb-6">
              <h3 class="text-xl font-bold text-brand-dark-gray dark:text-brand-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">bar_chart</span>
                Class Overview
              </h3>
              <div id="class-overview-content"></div>
            </div>

            <!-- Metacognition Section -->
            <div id="metacognition-section" class="mb-6 hidden">
              <h3 class="text-xl font-bold text-brand-dark-gray dark:text-brand-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-purple-600">psychology</span>
                Metacognition Analysis
              </h3>
              <div id="metacognition-content"></div>
            </div>

            <!-- Item Analysis Section -->
            <div class="mb-6">
              <h3 class="text-xl font-bold text-brand-dark-gray dark:text-brand-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-blue-600">assignment</span>
                Item-by-Item Analysis
              </h3>
              <div id="item-analysis-content"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div
        class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-brand-light-gray dark:border-brand-dark-gray/40 flex items-center justify-between">
        <div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">
          <p> Powered by professional psychometric analysis</p>
        </div>
        <button id="export-analytics-btn"
          class="h-10 px-5 rounded-lg bg-veritas-gold text-brand-white text-sm font-semibold hover:bg-veritas-gold/90 transition-colors">
          <span class="material-symbols-outlined text-sm align-middle mr-1">download</span>
          Export Report
        </button>
      </div>
    </div>
  </div>

  <!-- Data Migration Modal -->
  <div id="migration-modal"
    class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
    <div
      class="w-full max-w-lg rounded-2xl bg-white dark:bg-gray-800 p-6 shadow-xl border border-gray-200 dark:border-gray-700">
      <div class="mb-6 flex items-start justify-between">
        <div>
          <h3 class="text-xl font-bold text-gray-900 dark:text-white">Import Data from Sheets</h3>
          <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Upload the JSON export file from your legacy Google
            Sheet.</p>
        </div>
        <button onclick="document.getElementById('migration-modal').classList.add('hidden')"
          class="rounded-lg p-1 text-gray-400 hover:bg-gray-100 hover:text-gray-500 dark:hover:bg-gray-700">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div class="space-y-4">
        <div class="flex items-center justify-center w-full">
          <label for="migration-file-input"
            class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:hover:bg-gray-800 dark:bg-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:hover:border-gray-500">
            <div class="flex flex-col items-center justify-center pt-5 pb-6">
              <span class="material-symbols-outlined text-3xl text-gray-400 mb-2">upload_file</span>
              <p class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Click to
                  upload</span> veritas_full_export.json</p>
            </div>
            <input id="migration-file-input" type="file" class="hidden" accept=".json"
              onchange="handleMigrationFileSelect(this)" />
          </label>
        </div>

        <div id="migration-file-info"
          class="hidden p-3 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 rounded-lg text-sm flex items-center gap-2">
          <span class="material-symbols-outlined text-base">description</span>
          <span id="migration-filename" class="font-mono">filename.json</span>
        </div>

        <div id="migration-progress-container" class="hidden space-y-2">
          <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400">
            <span id="migration-status-text">Processing...</span>
            <span id="migration-percent">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
            <div id="migration-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
          </div>
          <div id="migration-log"
            class="h-24 overflow-y-auto bg-gray-900 text-green-400 font-mono text-xs p-2 rounded-lg">
            <!-- Log output -->
          </div>
        </div>
      </div>

      <div class="mt-6 flex justify-end gap-3">
        <button onclick="document.getElementById('migration-modal').classList.add('hidden')"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600 transition-colors">
          Cancel
        </button>
        <button id="start-migration-btn" onclick="startMigration()" disabled
          class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2">
          <span class="material-symbols-outlined text-base">rocket_launch</span>
          Start Import
        </button>
      </div>
    </div>
  </div>

  <!-- Poll Creation Wizard View -->
  <style>
    /* Login Screen Styles */
    #login-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Inter', sans-serif;
    }

    .login-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        border-radius: 24px;
        padding: 48px;
        width: 100%;
        max-width: 420px;
        text-align: center;
        animation: loginSlideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes loginSlideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .login-logo {
        width: 64px;
        height: 64px;
        margin: 0 auto 24px;
        background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
    }

    .login-logo span {
        font-size: 32px;
        color: white;
    }

    .login-title {
        color: white;
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 8px;
        letter-spacing: -0.02em;
    }

    .login-subtitle {
        color: #94a3b8;
        font-size: 15px;
        margin-bottom: 32px;
        line-height: 1.5;
    }

    .login-btn {
        width: 100%;
        background: white;
        color: #0f172a;
        border: none;
        padding: 14px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        transition: all 0.2s ease;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .login-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        background: #f8fafc;
    }

    .login-btn:active {
        transform: translateY(0);
    }

    .login-btn-icon {
        width: 20px;
        height: 20px;
    }

    .login-error {
        margin-top: 16px;
        padding: 12px;
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 8px;
        color: #fca5a5;
        font-size: 13px;
        display: none;
        animation: shake 0.4s ease-in-out;
    }

    @keyframes shake {

        0%,
        100% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-4px);
        }

        75% {
            transform: translateX(4px);
        }
    }

    .login-footer {
        margin-top: 32px;
        color: #64748b;
        font-size: 12px;
    }
</style>

<div id="login-overlay" style="display: none;">
    <div class="login-card">
        <div class="login-logo">
            <span class="material-symbols-outlined">school</span>
        </div>
        <h1 class="login-title">Veritas Live</h1>
        <p class="login-subtitle">Sign in to access your classroom polls and assessments.</p>

        <button id="google-login-btn" class="login-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="login-btn-icon"
                alt="Google">
            Sign in with Google
        </button>

        <div id="login-error" class="login-error"></div>

        <div class="login-footer">
            &copy; 2024 Veritas Education. Secure & Private.
        </div>
    </div>
</div>

<script>
    (function () {
        // Expose LoginManager globally
        window.LoginManager = {
            show: function () {
                var el = document.getElementById('login-overlay');
                if (el) el.style.display = 'flex';
            },
            hide: function () {
                var el = document.getElementById('login-overlay');
                if (el) el.style.display = 'none';
            },
            setError: function (msg) {
                var el = document.getElementById('login-error');
                if (el) {
                    el.textContent = msg;
                    el.style.display = 'block';
                }
            },
            init: function (onSuccess) {
                var btn = document.getElementById('google-login-btn');
                if (btn) {
                    btn.addEventListener('click', function () {
                        var provider = new firebase.auth.GoogleAuthProvider();
                        // Force account selection
                        provider.setCustomParameters({
                            prompt: 'select_account'
                        });

                        firebase.auth().signInWithPopup(provider)
                            .then(function (result) {
                                var user = result.user;
                                console.log('[Auth] Signed in as:', user.email);

                                // Persist session
                                sessionStorage.setItem('veritas_session_token', user.uid); // Using UID as token for now
                                sessionStorage.setItem('veritas_student_email', user.email);

                                // Update Global State
                                window.SESSION_TOKEN = user.uid;
                                window.STUDENT_EMAIL = user.email;

                                LoginManager.hide();
                                if (onSuccess) onSuccess(user);
                            })
                            .catch(function (error) {
                                console.error('[Auth] Login failed:', error);
                                LoginManager.setError(error.message);
                            });
                    });
                }
            }
        };
    })();
</script>
  <script>
(function(global) {
  'use strict';

  // Deterministic Student Key Generation (SHA-256)
  // This matches the user's requirement for a collision-resistant key.
  // We use Web Crypto API which is available in modern browsers.

  async function generateStudentHash(email, pollId) {
    if (!email) return 'unknown_student';

    // Normalize: lowercase, trim
    const normalized = email.toLowerCase().trim();

    // Namespace with pollId if provided (optional but good for isolation)
    const data = pollId ? `${pollId}:${normalized}` : normalized;

    const encoder = new TextEncoder();
    const dataBuffer = encoder.encode(data);

    try {
      const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      // Convert to hex string
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      // Return first 16 chars as key (enough entropy for this context)
      return hashHex.substring(0, 16);
    } catch (e) {
      console.warn('Web Crypto unavailable, falling back to simple hash', e);
      // Fallback for very old browsers (unlikely in this context but safe)
      var hash = 0;
      for (var i = 0; i < data.length; i++) {
        var char = data.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return 'fb_' + Math.abs(hash).toString(16);
    }
  }

  // Export
  global.VeritasShared = global.VeritasShared || {};
  global.VeritasShared.generateStudentKey = generateStudentHash;

  // ========================================================================
  // VERITAS DEBUG HELPER
  // Accessible from browser console: VeritasDebug.printFirebaseConfig()
  // Safe no-op if Firebase is not available.
  // ========================================================================
  global.VeritasDebug = {
    /**
     * Print Firebase configuration details to console.
     * Call from browser DevTools: VeritasDebug.printFirebaseConfig()
     */
    printFirebaseConfig: function() {
      console.group(' VeritasDebug: Firebase Configuration');

      // Check FIREBASE_CONFIG
      if (typeof FIREBASE_CONFIG !== 'undefined' && FIREBASE_CONFIG) {
        console.log(' FIREBASE_CONFIG exists');
        console.log('  databaseURL:', FIREBASE_CONFIG.databaseURL || '(not set)');
        console.log('  projectId:', FIREBASE_CONFIG.projectId || '(not set)');
        console.log('  Full config:', FIREBASE_CONFIG);
      } else {
        console.warn(' FIREBASE_CONFIG is NOT defined');
      }

      // Check firebase SDK
      if (typeof firebase !== 'undefined') {
        console.log(' firebase SDK is loaded');
        console.log('  firebase.apps.length:', firebase.apps ? firebase.apps.length : 'n/a');
        if (firebase.apps && firebase.apps.length > 0) {
          console.log('  Default app name:', firebase.apps[0].name);
          console.log('  Database URL:', firebase.apps[0].options.databaseURL || '(not set)');
        }
      } else {
        console.warn(' firebase SDK is NOT loaded');
      }

      // Check firebaseDb reference (if exists in scope)
      if (typeof firebaseDb !== 'undefined' && firebaseDb) {
        console.log(' firebaseDb reference exists');
      } else {
        console.log(' firebaseDb reference not in scope (normal before init)');
      }

      console.groupEnd();
      return {
        configExists: typeof FIREBASE_CONFIG !== 'undefined',
        databaseURL: (typeof FIREBASE_CONFIG !== 'undefined' && FIREBASE_CONFIG) ? FIREBASE_CONFIG.databaseURL : null,
        firebaseLoaded: typeof firebase !== 'undefined',
        appsLength: (typeof firebase !== 'undefined' && firebase.apps) ? firebase.apps.length : 0
      };
    },

    /**
     * Print current page context for debugging
     */
    printContext: function() {
      console.group(' VeritasDebug: Page Context');
      console.log('Location:', window.location.href);
      console.log('Page type:', document.title);

      // Check for session token (student pages)
      if (typeof SESSION_TOKEN !== 'undefined') {
        console.log('SESSION_TOKEN:', SESSION_TOKEN ? '(present, length=' + SESSION_TOKEN.length + ')' : '(empty)');
      }

      // Check for poll data (teacher pages)
      if (typeof CURRENT_POLL_DATA !== 'undefined') {
        console.log('CURRENT_POLL_DATA:', CURRENT_POLL_DATA);
      }

      console.groupEnd();
    }
  };

})(this);
</script>

  <script>
  (function () {
    // --- Main App State ---
    var mainLoader = document.getElementById('loader');

    // FIX: Initialize poll containers early to prevent race condition with loadInitialData
    var pollsCardView = document.getElementById('polls-card-view');
    var pollsTableView = document.getElementById('polls-table-view');
    var pollsTableBody = document.getElementById('polls-table-body');
    var pollsEmptyState = document.getElementById('polls-empty-state');
    var ALL_POLLS = [];
    var ALL_CLASSES = [];
    var CURRENT_POLL_DATA = {};
    var currentStudentStatusData = [];
    var studentSearchQuery = '';
    var studentTableSort = { column: 'lastName', direction: 'asc' };
    var pollInterval = null;
    var missionControlHeartbeat = window.SecureAssessmentShared.createHeartbeat({
      intervalMs: 2500,
      onBeat: function () {
        pollIndividualSessionState();
      }
    });
    var missionControlPollFailures = 0;
    var missionControlBackoffMs = 0;
    var currentSecureSessionId = null;
    var currentMissionControlPollId = null;
    var missionControlStudents = [];
    var missionControlSelectedEmails = new Set();
    var previouslyLockedEmails = new Set();
    var bulkControlsLoading = false;
    var currentManagedStudent = null;
    var isPaused = false;
    var isLiveSession = false;
    var isNavigating = false; // Flag to prevent polling during question navigation
    var navigationRequestInFlight = false; // Prevent double-advances
    var questionCounter = 0;
    var questions = [];
    var questionIdCounter = 0;
    var customQuestionOrder = [];
    var initialQuestionOrder = [];
    var draggedQuestionId = null;
    var pollSearchQuery = '';
    var sessionHudState = {
      lastCompletionPct: null,
      lastAccuracyPct: null,
      lastLockoutTotal: null,
      allRespondedCelebrated: false
    };
    var lockToastState = {};
    var firebaseDb = null;
    var firebaseRef = null;
    var firebaseFunctions = null; // Backend Functions
    var realtimeStatuses = {}; // key -> status
    var realtimeConnected = false;
    var lastQuestionIndex = -1;
    var currentMainSection = 'dashboard';
    var activeMobilePanel = 'question';

    // OPTIMIZATION: Adaptive polling with backoff (like student view)
    var pollFailureCount = 0;
    var basePollInterval = 2500;
    var currentPollInterval = 2500;
    var maxPollInterval = 10000;

    // OPTIMIZATION: Client-side caching with localStorage
    var LocalCache = {
      get: function (key) {
        try {
          var cached = localStorage.getItem('vlp_' + key);
          if (!cached) return null;
          var data = JSON.parse(cached);
          if (data.expires && Date.now() > data.expires) return null;
          return data.value;
        } catch (e) {
          console.warn('LocalCache get error:', e);
          return null;
        }
      },
      set: function (key, value, ttlMs) {
        try {
          var data = {
            value: value,
            expires: ttlMs ? Date.now() + ttlMs : null
          };
          localStorage.setItem('vlp_' + key, JSON.stringify(data));
        } catch (e) {
          console.warn('LocalCache set error:', e);
        }
      },
      invalidate: function (key) {
        try {
          localStorage.removeItem('vlp_' + key);
        } catch (e) {
          console.warn('LocalCache invalidate error:', e);
        }
      }
    };

    // Enhanced Error Handling
    var ERROR_MESSAGES = {
      'NetworkError': { title: 'Connection Problem', message: 'Please check your internet and try again.' },
      'permission-denied': { title: 'Access Denied', message: 'You don\'t have permission for this action.' },
      'not-found': { title: 'Not Found', message: 'The requested item could not be found.' },
      'default': { title: 'Error', message: 'An unexpected error occurred. Please try again.' }
    };

    function showUserFriendlyError(error) {
      var errorKey = (error && error.code) || 'default';
      var errorInfo = ERROR_MESSAGES[errorKey] || ERROR_MESSAGES['default'];
      if (typeof showToast === 'function') {
        showToast('error', errorInfo.title, errorInfo.message);
      } else {
        console.error(errorInfo.title + ': ' + errorInfo.message, error);
      }
    }

    var CONFIDENCE_LEVEL_STYLES = {
      'guessing': {
        label: 'Guessing',
        emoji: '',
        textClass: 'text-red-700 dark:text-red-200',
        badgeClass: 'bg-red-500/10 text-red-700 dark:text-red-200 border border-red-500/30',
        barClass: 'bg-red-500',
        accentClass: 'text-red-700/80 dark:text-red-200/80'
      },
      'somewhat-sure': {
        label: 'Somewhat sure',
        emoji: '',
        textClass: 'text-amber-700 dark:text-amber-200',
        badgeClass: 'bg-amber-500/10 text-amber-700 dark:text-amber-200 border border-amber-500/30',
        barClass: 'bg-amber-500',
        accentClass: 'text-amber-700/80 dark:text-amber-200/80'
      },
      'very-sure': {
        label: 'Very sure',
        emoji: '',
        textClass: 'text-blue-700 dark:text-blue-200',
        badgeClass: 'bg-blue-500/10 text-blue-700 dark:text-blue-200 border border-blue-500/30',
        barClass: 'bg-blue-500',
        accentClass: 'text-blue-700/80 dark:text-blue-200/80'
      },
      'certain': {
        label: 'Absolutely certain',
        emoji: '',
        textClass: 'text-green-700 dark:text-green-200',
        badgeClass: 'bg-green-500/10 text-green-700 dark:text-green-200 border border-green-500/30',
        barClass: 'bg-green-500',
        accentClass: 'text-green-700/80 dark:text-green-200/80'
      }
    };

    /* ========================================
        ENHANCED UI SYSTEM - JAVASCRIPT
       ======================================== */

    // === Toast Notification System ===
    const TOAST_DURATIONS_MS = {
      success: 4000,
      info: 5000,
      warning: 7000,
      error: 0 // Sticky
    };

    function showToast(type, title, message, duration = null, action = null) {
      const container = document.getElementById('toast-container');
      if (!container) return;

      // Normalize type to ensure config lookup works
      // Map 'warn' to 'warning' if needed, though most calls seem to use 'warning'
      const normalizedType = type === 'warn' ? 'warning' : type;

      const toast = document.createElement('div');
      toast.className = `toast toast-${normalizedType}`;

      const icons = {
        success: 'check_circle',
        error: 'error',
        warning: 'warning',
        info: 'info'
      };

      let actionHtml = '';
      if (action && action.label) {
        actionHtml = `<button class="toast-action-btn">${action.label}</button>`;
      }

      toast.innerHTML = `
      <span class="material-symbols-outlined toast-icon">${icons[normalizedType] || 'notifications'}</span>
      <div class="toast-content">
        <div class="toast-title">${title}</div>
        <div class="toast-message">${message}</div>
        ${actionHtml}
      </div>
      <button class="toast-close" onclick="this.closest('.toast').remove()">
        <span class="material-symbols-outlined" style="font-size: 18px">close</span>
      </button>
      <div class="toast-progress"></div>
    `;

      if (action && action.onClick) {
        const btn = toast.querySelector('.toast-action-btn');
        if (btn) {
          btn.onclick = function (e) {
            e.stopPropagation();
            action.onClick();
            toast.remove();
          };
        }
      }

      container.appendChild(toast);

      // Determine duration
      // Use explicit duration if provided (and not null/undefined), otherwise fallback to config
      let effectiveDuration = (duration !== null && duration !== undefined)
        ? duration
        : (TOAST_DURATIONS_MS[normalizedType] ?? TOAST_DURATIONS_MS.info);

      // Auto-remove after duration if not sticky (<= 0)
      if (effectiveDuration > 0) {
        setTimeout(() => {
          toast.classList.add('toast-out');
          setTimeout(() => toast.remove(), 300);
        }, effectiveDuration);
      }
    }
    window.showToast = showToast;

    // === Floating Action Button (FAB) System ===
    let fabMenuOpen = false;

    function initializeFAB() {
      const fabMainToggle = document.getElementById('fab-main-toggle');
      const fabMenu = document.getElementById('fab-menu');
      const fabContainer = document.getElementById('fab-container');

      if (!fabMainToggle || !fabMenu) return;

      fabMainToggle.addEventListener('click', function () {
        fabMenuOpen = !fabMenuOpen;

        if (fabMenuOpen) {
          fabMenu.classList.add('is-open');
          fabMainToggle.classList.add('is-open');
          fabMainToggle.setAttribute('aria-expanded', 'true');
        } else {
          fabMenu.classList.remove('is-open');
          fabMainToggle.classList.remove('is-open');
          fabMainToggle.setAttribute('aria-expanded', 'false');
        }
      });

      // Wire up FAB actions to existing functions
      const fabNextBtn = document.getElementById('fab-next-btn');
      const fabShowResultsBtn = document.getElementById('fab-show-results-btn');
      const fabResetBtn = document.getElementById('fab-reset-btn');
      const fabStopBtn = document.getElementById('fab-stop-btn');

      if (fabNextBtn) {
        fabNextBtn.addEventListener('click', function () {
          nextQuestion();
          closeFABMenu();
        });
      }

      if (fabShowResultsBtn) {
        fabShowResultsBtn.addEventListener('click', function () {
          const endShowBtn = document.getElementById('header-end-show-btn');
          if (endShowBtn && endShowBtn.style.display !== 'none') {
            endShowBtn.click();
          }
          closeFABMenu();
        });
      }

      if (fabResetBtn) {
        fabResetBtn.addEventListener('click', function () {
          resetLiveQuestion();
          closeFABMenu();
        });
      }

      if (fabStopBtn) {
        fabStopBtn.addEventListener('click', function () {
          stopPoll();
          closeFABMenu();
        });
      }

      // Close FAB menu when clicking outside
      document.addEventListener('click', function (e) {
        if (fabMenuOpen && !fabContainer.contains(e.target)) {
          closeFABMenu();
        }
      });
    }

    function closeFABMenu() {
      fabMenuOpen = false;
      const fabMenu = document.getElementById('fab-menu');
      const fabMainToggle = document.getElementById('fab-main-toggle');
      if (fabMenu) fabMenu.classList.remove('is-open');
      if (fabMainToggle) {
        fabMainToggle.classList.remove('is-open');
        fabMainToggle.setAttribute('aria-expanded', 'false');
      }
    }

    // === Progress Ring Updates ===
    function updateProgressRing(ringId, percentage) {
      const ring = document.getElementById(ringId);
      if (!ring) return;

      const circumference = 138.23; // 2 *  * 22 (radius)
      const offset = circumference - (percentage / 100) * circumference;
      ring.style.strokeDashoffset = offset;

      // Update ring color based on percentage
      ring.classList.remove('ring-success', 'ring-warning', 'ring-danger');
      if (percentage >= 70) {
        ring.classList.add('ring-success');
      } else if (percentage >= 40) {
        ring.classList.add('ring-warning');
      } else {
        ring.classList.add('ring-danger');
      }
    }

    // === Ambient State Management ===
    function setAmbientState(state) {
      const overlay = document.getElementById('ambient-state-overlay');
      if (!overlay) return;

      // Remove all state classes
      overlay.className = 'ambient-state-overlay';

      // Add new state class
      if (state && state !== 'normal') {
        overlay.classList.add(`state-${state}`);
      } else {
        overlay.classList.add('state-normal');
      }
    }

    // === Sparkline Visualization System ===
    // Track historical data for sparklines
    var sparklineData = {
      responses: [],
      accuracy: [],
      maxPoints: 20 // Keep last 20 data points
    };

    function addSparklineDataPoint(metric, value) {
      if (!sparklineData[metric]) {
        sparklineData[metric] = [];
      }
      sparklineData[metric].push(value);

      // Keep only maxPoints
      if (sparklineData[metric].length > sparklineData.maxPoints) {
        sparklineData[metric].shift();
      }
    }

    function renderSparkline(containerId, data, color) {
      const container = document.getElementById(containerId);
      if (!container || !data || data.length < 2) return;

      const width = 100;
      const height = 28;
      const padding = 2;

      // Calculate min/max for scaling
      const min = Math.min(...data);
      const max = Math.max(...data);
      const range = max - min || 1;

      // Create SVG if it does not exist
      let svg = container.querySelector('svg');
      if (!svg) {
        svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('class', 'sparkline');
        svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

        // Add gradient definition
        const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
        gradient.setAttribute('id', `sparkline-gradient-${containerId}`);
        gradient.setAttribute('x1', '0%');
        gradient.setAttribute('y1', '0%');
        gradient.setAttribute('x2', '0%');
        gradient.setAttribute('y2', '100%');

        const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop1.setAttribute('offset', '0%');
        stop1.setAttribute('stop-color', color || '#c5a05a');
        stop1.setAttribute('stop-opacity', '0.5');

        const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop2.setAttribute('offset', '100%');
        stop2.setAttribute('stop-color', color || '#c5a05a');
        stop2.setAttribute('stop-opacity', '0.1');

        gradient.appendChild(stop1);
        gradient.appendChild(stop2);
        defs.appendChild(gradient);
        svg.appendChild(defs);

        container.appendChild(svg);
      }

      // Clear previous content except defs
      const defs = svg.querySelector('defs');
      svg.innerHTML = '';
      if (defs) svg.appendChild(defs);

      // Calculate points
      const stepX = (width - 2 * padding) / (data.length - 1);
      let linePoints = '';
      let areaPoints = `${padding},${height - padding}`;

      data.forEach((value, index) => {
        const x = padding + index * stepX;
        const y = padding + (height - 2 * padding) * (1 - (value - min) / range);

        if (index === 0) {
          linePoints = `M ${x},${y}`;
        } else {
          linePoints += ` L ${x},${y}`;
        }

        areaPoints += ` ${x},${y}`;
      });

      areaPoints += ` ${padding + (data.length - 1) * stepX},${height - padding}`;

      // Create area path
      const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      area.setAttribute('d', areaPoints + ' Z');
      area.setAttribute('class', 'sparkline-area');
      area.setAttribute('fill', `url(#sparkline-gradient-${containerId})`);
      svg.appendChild(area);

      // Create line path
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      line.setAttribute('d', linePoints);
      line.setAttribute('class', 'sparkline-line');
      line.setAttribute('stroke', color || '#c5a05a');
      svg.appendChild(line);

      // Add dots
      data.forEach((value, index) => {
        const x = padding + index * stepX;
        const y = padding + (height - 2 * padding) * (1 - (value - min) / range);

        const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        dot.setAttribute('cx', x);
        dot.setAttribute('cy', y);
        dot.setAttribute('class', 'sparkline-dot');
        dot.setAttribute('fill', color || '#c5a05a');
        svg.appendChild(dot);
      });
    }

    // === Loading Skeleton System ===
    function createSkeletonLoader(type = 'card') {
      const skeleton = document.createElement('div');
      skeleton.className = 'animate-pulse';

      if (type === 'card') {
        skeleton.innerHTML = `
        <div class="bg-gray-200 dark:bg-gray-700 h-40 rounded-t-2xl"></div>
        <div class="p-4 space-y-3">
          <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
          <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
          <div class="flex gap-2 mt-4">
            <div class="h-8 bg-gray-200 dark:bg-gray-700 rounded flex-1"></div>
            <div class="h-8 bg-gray-200 dark:bg-gray-700 rounded flex-1"></div>
          </div>
        </div>
      `;
      } else if (type === 'hud') {
        skeleton.innerHTML = `
        <div class="flex gap-4">
          <div class="w-12 h-12 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
          <div class="flex-1 space-y-2">
            <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/3"></div>
            <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
          </div>
        </div>
      `;
      }

      return skeleton;
    }

    // === Enhanced Visual Timer States ===
    function updateTimerVisualState(remainingSeconds, totalSeconds) {
      const timerContainers = [
        document.getElementById('timer-main-container'),
        document.getElementById('timer-compact-container')
      ];

      timerContainers.forEach(function (container) {
        if (!container) return;

        // Remove all state classes
        container.classList.remove('timer-warning', 'timer-critical');

        // Calculate percentage remaining
        const percentage = totalSeconds > 0 ? (remainingSeconds / totalSeconds) * 100 : 100;

        // Apply appropriate state class
        if (remainingSeconds <= 10 && remainingSeconds > 0) {
          container.classList.add('timer-critical');
          setAmbientState('time-critical');
        } else if (percentage <= 25 && remainingSeconds > 10) {
          container.classList.add('timer-warning');
        } else {
          setAmbientState('normal');
        }
      });
    }

    // === Celebration Animation System ===
    function triggerCelebration(element, type = 'default') {
      if (!element) return;

      element.classList.remove('celebrate');

      // Force reflow to restart animation
      void element.offsetWidth;

      element.classList.add('celebrate');

      // Remove class after animation completes
      setTimeout(function () {
        element.classList.remove('celebrate');
      }, 600);

      // Show toast notification for major milestones
      if (type === 'all-responded') {
        showToast('success', ' All Students Responded!', 'Great work! Everyone has submitted their answer.');
        setAmbientState('all-responded');
        playSoundEffect('celebration');
      } else if (type === 'perfect-accuracy') {
        showToast('success', ' Perfect Accuracy!', '100% of students got the answer correct!');
        playSoundEffect('celebration');
      }
    }

    // === Activity Feed System ===
    var activityFeedData = [];
    var activityFeedOpen = false;
    var maxActivityItems = 50; // Keep last 50 activities

    function initializeActivityFeed() {
      const activityFeed = document.getElementById('activity-feed');
      const activityFeedClose = document.getElementById('activity-feed-close');
      const fabActivityBtn = document.getElementById('fab-activity-btn');

      if (!activityFeed) return;

      // Close button handler
      if (activityFeedClose) {
        activityFeedClose.addEventListener('click', function () {
          closeActivityFeed();
        });
      }

      // FAB toggle button handler
      if (fabActivityBtn) {
        fabActivityBtn.addEventListener('click', function () {
          toggleActivityFeed();
          closeFABMenu();
        });
      }

      // Click outside to close
      document.addEventListener('click', function (e) {
        if (activityFeedOpen &&
          !activityFeed.contains(e.target) &&
          !fabActivityBtn.contains(e.target)) {
          closeActivityFeed();
        }
      });
    }

    function toggleActivityFeed() {
      if (activityFeedOpen) {
        closeActivityFeed();
      } else {
        openActivityFeed();
      }
    }

    function openActivityFeed() {
      const activityFeed = document.getElementById('activity-feed');
      if (!activityFeed) return;

      activityFeed.classList.add('is-open');
      activityFeedOpen = true;
    }

    function closeActivityFeed() {
      const activityFeed = document.getElementById('activity-feed');
      if (!activityFeed) return;

      activityFeed.classList.remove('is-open');
      activityFeedOpen = false;
    }

    function addActivityItem(type, icon, message) {
      const timestamp = new Date();
      const activity = {
        type: type, // 'success', 'warning', 'error', 'info'
        icon: icon, // Material icon name
        message: message,
        timestamp: timestamp
      };

      activityFeedData.unshift(activity); // Add to beginning

      // Keep only maxActivityItems
      if (activityFeedData.length > maxActivityItems) {
        activityFeedData = activityFeedData.slice(0, maxActivityItems);
      }

      renderActivityFeed();
    }

    function renderActivityFeed() {
      const list = document.getElementById('activity-feed-list');
      const count = document.getElementById('activity-feed-count');

      if (!list) return;

      if (activityFeedData.length === 0) {
        list.innerHTML = `
        <div class="activity-feed-empty">
          <span class="material-symbols-outlined">inbox</span>
          <p>No recent activity</p>
        </div>
      `;
        if (count) count.textContent = '0';
        return;
      }

      if (count) count.textContent = activityFeedData.length.toString();

      const items = activityFeedData.map(function (activity) {
        const timeAgo = getTimeAgo(activity.timestamp);
        return `
        <div class="activity-item">
          <div class="activity-icon ${activity.type}">
            <span class="material-symbols-outlined">${activity.icon}</span>
          </div>
          <div class="activity-content">
            <div class="activity-message">${escapeHtml(activity.message)}</div>
            <div class="activity-time">${timeAgo}</div>
          </div>
        </div>
      `;
      }).join('');

      list.innerHTML = items;
    }

    function getTimeAgo(timestamp) {
      const now = new Date();
      const seconds = Math.floor((now - timestamp) / 1000);

      if (seconds < 10) return 'just now';
      if (seconds < 60) return seconds + 's ago';

      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return minutes + 'm ago';

      const hours = Math.floor(minutes / 60);
      if (hours < 24) return hours + 'h ago';

      const days = Math.floor(hours / 24);
      return days + 'd ago';
    }

    // Hook into existing events to add activities
    function trackStudentResponse(studentName, isCorrect) {
      const type = isCorrect ? 'success' : 'info';
      const icon = isCorrect ? 'check_circle' : 'radio_button_unchecked';
      const message = `${studentName} answered ${isCorrect ? 'correctly' : ''}`;
      addActivityItem(type, icon, message);
    }

    function trackStudentLockout(studentName) {
      addActivityItem('warning', 'lock_person', `${studentName} was locked out`);
    }

    function trackStudentUnlock(studentName) {
      addActivityItem('success', 'lock_open', `${studentName} was unlocked`);
    }

    function trackAllResponded() {
      addActivityItem('success', 'celebration', 'All students responded!');
    }

    function trackQuestionAdvance(questionNum) {
      addActivityItem('info', 'arrow_forward', `Advanced to Question ${questionNum}`);
    }

    // === Sound Effects System ===
    var soundEffectsEnabled = false; // Disabled by default, can be enabled via settings
    var audioContext = null;

    function initializeAudioContext() {
      if (!audioContext && typeof AudioContext !== 'undefined') {
        audioContext = new AudioContext();
      } else if (!audioContext && typeof webkitAudioContext !== 'undefined') {
        audioContext = new webkitAudioContext();
      }
      return audioContext;
    }

    function playSoundEffect(type) {
      if (!soundEffectsEnabled) return;

      const ctx = initializeAudioContext();
      if (!ctx) return;

      const oscillator = ctx.createOscillator();
      const gainNode = ctx.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(ctx.destination);

      // Configure sound based on type
      switch (type) {
        case 'success':
          // Happy ascending chime
          oscillator.frequency.setValueAtTime(523.25, ctx.currentTime); // C5
          oscillator.frequency.exponentialRampToValueAtTime(783.99, ctx.currentTime + 0.1); // G5
          gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
          oscillator.start(ctx.currentTime);
          oscillator.stop(ctx.currentTime + 0.3);
          break;

        case 'celebration':
          // Triple ascending tones
          playTone(ctx, 523.25, 0.0, 0.1, 0.25); // C5
          playTone(ctx, 659.25, 0.1, 0.1, 0.25); // E5
          playTone(ctx, 783.99, 0.2, 0.15, 0.3); // G5
          break;

        case 'warning':
          // Descending tone
          oscillator.frequency.setValueAtTime(440, ctx.currentTime); // A4
          oscillator.frequency.exponentialRampToValueAtTime(220, ctx.currentTime + 0.15);
          gainNode.gain.setValueAtTime(0.25, ctx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
          oscillator.start(ctx.currentTime);
          oscillator.stop(ctx.currentTime + 0.2);
          break;

        case 'notification':
          // Single gentle tone
          oscillator.frequency.value = 880; // A5
          oscillator.type = 'sine';
          gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
          oscillator.start(ctx.currentTime);
          oscillator.stop(ctx.currentTime + 0.15);
          break;
      }
    }

    function playTone(ctx, frequency, startTime, duration, gain) {
      const osc = ctx.createOscillator();
      const g = ctx.createGain();

      osc.connect(g);
      g.connect(ctx.destination);

      osc.frequency.value = frequency;
      osc.type = 'sine';
      g.gain.setValueAtTime(gain, ctx.currentTime + startTime);
      g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + startTime + duration);

      osc.start(ctx.currentTime + startTime);
      osc.stop(ctx.currentTime + startTime + duration);
    }

    function toggleSoundEffects() {
      soundEffectsEnabled = !soundEffectsEnabled;
      showToast('info', 'Sound Effects', soundEffectsEnabled ? 'Sound effects enabled' : 'Sound effects disabled', 2000);
    }

    // === Keyboard Shortcuts System ===
    var keyboardShortcutsEnabled = true;

    function initializeKeyboardShortcuts() {
      document.addEventListener('keydown', function (e) {
        if (!keyboardShortcutsEnabled) return;

        // Don't trigger if user is typing in an input
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        // Check if in live view
        const liveView = document.getElementById('live-view');
        if (!liveView || liveView.style.display === 'none') return;

        switch (e.key) {
          case 'ArrowRight':
            e.preventDefault();
            const nextBtn = document.getElementById('header-next-btn');
            if (nextBtn && !nextBtn.disabled) nextBtn.click();
            break;

          case 'ArrowLeft':
            e.preventDefault();
            const backBtn = document.getElementById('header-back-btn');
            if (backBtn && !backBtn.disabled) backBtn.click();
            break;

          case ' ': // Space
            // Only for timer control
            if (e.target.id === 'timer-display') return; // Allow editing timer
            e.preventDefault();
            const timerState = timerActive;
            if (timerState) {
              pauseTimer();
            } else {
              startTimer();
            }
            break;

          case 'r':
          case 'R':
            e.preventDefault();
            const resetBtn = document.getElementById('header-reset-question-btn');
            if (resetBtn && !resetBtn.disabled) resetBtn.click();
            break;

          case 'a':
          case 'A':
            e.preventDefault();
            toggleActivityFeed();
            break;

          case 'Escape':
            e.preventDefault();
            if (activityFeedOpen) closeActivityFeed();
            if (fabMenuOpen) closeFABMenu();
            break;
        }
      });
    }

    // === Combobox Component (Headless UI Style) ===
    function VeritasCombobox(config) {
      this.inputId = config.inputId;
      this.containerId = config.containerId;
      this.data = config.data || []; // Array of {id, label, subLabel?, value?, onSelect?}
      this.onSelect = config.onSelect;
      this.filterFn = config.filterFn || function (item, query) {
        return (item.label || '').toLowerCase().includes(query.toLowerCase());
      };
      this.renderItem = config.renderItem || function (item, selected, active) {
        var checkIcon = selected ? '<span class="absolute inset-y-0 right-0 flex items-center pr-4 text-veritas-navy"><span class="material-symbols-outlined text-sm">check</span></span>' : '';
        var activeClass = active ? 'bg-veritas-navy text-white' : 'text-gray-900';
        var subLabel = item.subLabel ? '<span class="block truncate text-xs opacity-70">' + escapeHtml(item.subLabel) + '</span>' : '';
        return '<li class="relative cursor-default select-none py-2 pl-3 pr-9 ' + activeClass + '" role="option" aria-selected="' + selected + '" data-index="' + item.index + '">' +
          '<div class="flex flex-col">' +
          '<span class="block truncate font-medium">' + escapeHtml(item.label) + '</span>' +
          subLabel +
          '</div>' +
          checkIcon +
          '</li>';
      };

      this.input = document.getElementById(this.inputId);
      this.container = document.getElementById(this.containerId) || (this.input ? this.input.parentElement : null);

      if (!this.input || !this.container) {
        console.warn('Combobox init failed: missing input or container', this.inputId);
        return;
      }

      this.button = this.container.querySelector('button[data-combobox-toggle]');
      this.optionsList = document.createElement('ul');
      this.optionsList.className = 'absolute z-[100] mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black/5 focus:outline-none sm:text-sm hidden';
      this.container.appendChild(this.optionsList);

      this.isOpen = false;
      this.activeIndex = -1; // For keyboard navigation
      this.filteredData = [];
      this.query = '';

      this.init();
    }

    VeritasCombobox.prototype.init = function () {
      var self = this;

      // Input Events
      this.input.addEventListener('input', function (e) {
        self.query = e.target.value;
        self.isOpen = true;
        self.activeIndex = -1;
        self.renderOptions();
        // Trigger native input event if we intercepted it, but we are just listening
      });

      this.input.addEventListener('focus', function () {
        // Optional: Open on focus? The snippet implies open on change or button click.
        // Let's open if there is data
        if (self.data.length > 0) {
          // self.isOpen = true;
          // self.renderOptions();
          // Actually, let's just let the button toggle it or typing open it
        }
      });

      this.input.addEventListener('keydown', function (e) {
        if (!self.isOpen) {
          if (e.key === 'ArrowDown') {
            self.isOpen = true;
            self.renderOptions();
            e.preventDefault();
          }
          return;
        }

        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            self.activeIndex = (self.activeIndex + 1) % self.filteredData.length;
            self.updateActiveOption();
            self.scrollActiveIntoView();
            break;
          case 'ArrowUp':
            e.preventDefault();
            self.activeIndex = (self.activeIndex - 1 + self.filteredData.length) % self.filteredData.length;
            self.updateActiveOption();
            self.scrollActiveIntoView();
            break;
          case 'Enter':
            e.preventDefault();
            if (self.activeIndex >= 0 && self.filteredData[self.activeIndex]) {
              self.selectItem(self.filteredData[self.activeIndex]);
            }
            break;
          case 'Escape':
            self.close();
            break;
          case 'Tab':
            self.close();
            break;
        }
      });

      // Button Event
      if (this.button) {
        this.button.addEventListener('click', function (e) {
          e.stopPropagation(); // Prevent closing immediately
          self.toggle();
        });
      }

      // Option Click Events (Delegated)
      this.optionsList.addEventListener('click', function (e) {
        var li = e.target.closest('li');
        if (li) {
          var index = parseInt(li.dataset.index, 10);
          // Find item in filteredData based on index matching?
          // The filteredData indices might not match filtered array indices if we rely on dataset.index
          // Let's store the actual filtered index in dataset
          var item = self.filteredData[index];
          if (item) {
            self.selectItem(item);
          }
        }
      });

      // Outside Click
      document.addEventListener('click', function (e) {
        if (self.isOpen && !self.container.contains(e.target)) {
          self.close();
        }
      });
    };

    VeritasCombobox.prototype.updateData = function (newData) {
      this.data = newData;
      if (this.isOpen) {
        this.renderOptions();
      }
    };

    VeritasCombobox.prototype.toggle = function () {
      if (this.isOpen) {
        this.close();
      } else {
        this.open();
      }
    };

    VeritasCombobox.prototype.open = function () {
      this.isOpen = true;
      this.query = this.input.value; // Reset query to current input
      this.renderOptions();
    };

    VeritasCombobox.prototype.close = function () {
      this.isOpen = false;
      this.optionsList.classList.add('hidden');
      this.activeIndex = -1;
    };

    VeritasCombobox.prototype.renderOptions = function () {
      var self = this;
      // Filter data
      if (this.query === '') {
        this.filteredData = this.data;
      } else {
        this.filteredData = this.data.filter(function (item) {
          return self.filterFn(item, self.query);
        });
      }

      if (this.filteredData.length === 0) {
        this.optionsList.innerHTML = '<div class="relative cursor-default select-none py-2 px-4 text-gray-700">Nothing found.</div>';
      } else {
        this.optionsList.innerHTML = this.filteredData.map(function (item, index) {
          // Map filtered index to dataset
          var tempItem = Object.assign({}, item, { index: index });
          return self.renderItem(tempItem, false, index === self.activeIndex);
        }).join('');
      }

      this.optionsList.classList.remove('hidden');
    };

    VeritasCombobox.prototype.updateActiveOption = function () {
      var items = this.optionsList.querySelectorAll('li');
      items.forEach(function (item, idx) {
        if (idx === this.activeIndex) {
          item.classList.add('bg-veritas-navy', 'text-white');
          item.classList.remove('text-gray-900');
        } else {
          item.classList.remove('bg-veritas-navy', 'text-white');
          item.classList.add('text-gray-900');
        }
      }.bind(this));
    };

    VeritasCombobox.prototype.scrollActiveIntoView = function () {
      var activeItem = this.optionsList.children[this.activeIndex];
      if (activeItem) {
        activeItem.scrollIntoView({ block: 'nearest' });
      }
    };

    VeritasCombobox.prototype.selectItem = function (item) {
      this.input.value = item.label;
      this.query = item.label;
      this.close();
      if (this.onSelect) {
        this.onSelect(item);
      }
      // Trigger change event on input
      var event = new Event('input', { bubbles: true });
      this.input.dispatchEvent(event);
    };

    // Global Combobox Instances
    var pollCombobox = null;
    var liveStudentCombobox = null;
    var analyticsStudentCombobox = null;

    // === Initialize Enhanced UI Systems ===
    // === Initialize Enhanced UI Systems ===
    function startTeacherApp() {
      // Initialize FAB system
      initializeFAB();

      // Initialize Activity Feed
      initializeActivityFeed();

      // Initialize Keyboard Shortcuts
      initializeKeyboardShortcuts();

      // Initialize Comboboxes (logic below...)
      initializeComboboxes();

      // Load Initial Data
      loadInitialData();

      // Initialize Legacy Listeners (Zoom, etc)
      initializeLegacyListeners();
    }

    function initTeacherAuth() {
      if (!sessionStorage.getItem('veritas_session_token')) {
        console.log('[Auth] No teacher session found. Initiating Login Flow.');
        // Hide main content
        var dashboard = document.getElementById('main-dashboard-container');
        if (dashboard) dashboard.style.display = 'none';

        if (window.LoginManager) {
          LoginManager.init(function (user) {
            console.log('[Auth] Teacher Login Successful:', user.email);
            sessionStorage.setItem('veritas_teacher_email', user.email);
            setTimeout(function () { window.location.reload(); }, 500);
          });
          LoginManager.show();
        } else {
          alert('Auth System Missing');
        }
      } else {
        console.log('[Auth] Teacher Authenticated');
        startTeacherApp();
      }
    }

    // Helper to group combobox init
    function initializeComboboxes() {
      // Dashboard Poll Search
      pollCombobox = new VeritasCombobox({
        inputId: 'poll-search-input',
        containerId: 'poll-search-container',
        onSelect: function (item) {
          if (item.type === 'class') {
            var filterSelect = document.getElementById('poll-filter-select');
            if (filterSelect) {
              filterSelect.value = item.value;
              var evt = new Event('change');
              filterSelect.dispatchEvent(evt);
            }
          }
        }
      });
      // Live View Student Search
      liveStudentCombobox = new VeritasCombobox({
        inputId: 'student-search-input',
        containerId: 'student-search-container',
        onSelect: function (item) { }
      });

      // Analytics Student Search
      analyticsStudentCombobox = new VeritasCombobox({
        inputId: 'analytics-student-search',
        containerId: 'analytics-student-search-container',
        onSelect: function (item) {
          if (item.student) {
            selectStudent(item.student);
            document.getElementById('analytics-student-search').value = '';
          }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', initTeacherAuth);


    // Image zoom functionality
    window.expandImage = function (imgElement) {
      // ... logic skipped for brevity, defined globally is fine
      var imgSrc = imgElement.src;
      var modalHtml = '<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:pointer;" onclick="this.remove()">';
      modalHtml += '<img src="' + imgSrc + '" style="max-width:90%;max-height:90%;"/>';
      modalHtml += '</div>';
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    };

    // Helper to init listeners (call this from startTeacherApp)
    function initializeLegacyListeners() {
      console.log(' Enhanced UI systems initialized (Phase 3)');
      var liveQuestionImage = document.getElementById('live-question-image');
      if (liveQuestionImage) {
        liveQuestionImage.addEventListener('click', function (e) {
          e.stopPropagation();
          e.preventDefault();
          if (this.src && this.style.display !== 'none') {
            window.expandImage(this);
          }
        });
      }
    }

    function describeConfidence(value) {
      var entry = CONFIDENCE_LEVEL_STYLES[value];
      if (!entry) return null;
      return entry.emoji + ' ' + entry.label;
    }

    var selectedQuestionIndex = 0;
    var editingPollId = null;
    var isPollDirty = false;
    var pollSessionType = 'LIVE_POLL';
    var liveCalculatorEnabled = false;
    var secureAssessmentConfig = {
      timeLimitMinutes: 60,
      accessCode: '',
      availableFrom: '',
      dueBy: ''
    };
    var pollSortMode = 'updated_desc';
    var pollClassFilter = 'all';
    var rosterData = {};
    var selectedRosterClass = '';
    var rosterDirty = false;
    var archivedPolls = [];
    var archivedClassFilter = 'all';
    var selectedArchivedPollId = '';
    var BASE_CLASSES = [];
    var dashboardSummary = null;
    var analyticsRefreshInterval = null;
    var googleChartsReady = false;
    var googleChartsLoading = false;
    var googleChartsBootstrapTimer = null;

    function hasAppsScriptRuntime() {
      return !!(window.google && window.google.script && window.google.script.run && typeof window.google.script.run.withSuccessHandler === 'function');
    }

    var PREVIEW_MODE = false;
    var previewBootstrapped = false;

    function deepClone(value) {
      try {
        return JSON.parse(JSON.stringify(value));
      } catch (err) {
        console.warn('Preview clone fallback failed:', err);
        return value;
      }
    }

    var PREVIEW_PAYLOAD = {
      classes: ['AP Biology  Period 5', 'Chemistry  Period 2', 'World History  Period 7'],
      polls: [
        {
          pollId: 'demo-bio-1',
          pollName: 'Photosynthesis Pulse Check',
          className: 'AP Biology  Period 5',
          updatedAt: new Date(Date.now() - 3600 * 1000).toISOString(),
          lastRunAt: new Date(Date.now() - 7200 * 1000).toISOString(),
          createdAt: new Date(Date.now() - 86400 * 1000 * 3).toISOString(),
          questions: [
            {
              questionText: 'Which organelle performs photosynthesis in plant cells?',
              options: [
                { text: 'Mitochondrion' },
                { text: 'Chloroplast' },
                { text: 'Golgi apparatus' },
                { text: 'Nucleus' }
              ],
              correctAnswer: 'Chloroplast',
              correctAnswerLetter: 'B',
              timerSeconds: 90
            },
            {
              questionText: 'What pigment captures light energy for photosynthesis?',
              options: [
                { text: 'Hemoglobin' },
                { text: 'Chlorophyll' },
                { text: 'Keratin' },
                { text: 'Melanin' }
              ],
              correctAnswer: 'Chlorophyll',
              correctAnswerLetter: 'B',
              timerSeconds: 75
            }
          ]
        },
        {
          pollId: 'demo-chem-1',
          pollName: 'Stoichiometry Warm-Up',
          className: 'Chemistry  Period 2',
          updatedAt: new Date(Date.now() - 5400 * 1000).toISOString(),
          lastRunAt: new Date(Date.now() - 86400 * 1000).toISOString(),
          createdAt: new Date(Date.now() - 86400 * 1000 * 5).toISOString(),
          questions: [
            {
              questionText: 'How many moles are in 36 grams of water (HO)?',
              options: [
                { text: '1.0 mol' },
                { text: '2.0 mol' },
                { text: '0.5 mol' },
                { text: '4.0 mol' }
              ],
              correctAnswer: '2.0 mol',
              correctAnswerLetter: 'B',
              timerSeconds: 60
            },
            {
              questionText: 'What is the limiting reactant when 2 mol of H reacts with 1 mol of O?',
              options: [
                { text: 'Hydrogen' },
                { text: 'Oxygen' },
                { text: 'Water' },
                { text: 'None' }
              ],
              correctAnswer: 'Hydrogen',
              correctAnswerLetter: 'A',
              timerSeconds: 65
            }
          ]
        }
      ],
      dashboardSummary: {
        recentSessions: [
          { sessionName: 'Cell Energy Exit Ticket', date: new Date(Date.now() - 3600 * 1000 * 20).toISOString(), className: 'AP Biology  Period 5', participationPct: 92, masteryPct: 78, flags: 1 },
          { sessionName: 'Stoichiometry Practice', date: new Date(Date.now() - 3600 * 1000 * 42).toISOString(), className: 'Chemistry  Period 2', participationPct: 88, masteryPct: 74, flags: 0 },
          { sessionName: 'Industrial Revolution Check', date: new Date(Date.now() - 3600 * 1000 * 65).toISOString(), className: 'World History  Period 7', participationPct: 83, masteryPct: 69, flags: 0 }
        ],
        dailyActivity: [
          { dayName: 'Mon', count: 18 },
          { dayName: 'Tue', count: 22 },
          { dayName: 'Wed', count: 31 },
          { dayName: 'Thu', count: 26 },
          { dayName: 'Fri', count: 19 },
          { dayName: 'Sat', count: 9 },
          { dayName: 'Sun', count: 6 }
        ],
        weekOverWeekChange: 6,
        totalActivityThisWeek: 131
      },
      rosters: {
        'AP Biology  Period 5': [
          { name: 'Ava Martinez', email: 'ava.martinez@school.edu' },
          { name: 'Ethan Patel', email: 'ethan.patel@school.edu' },
          { name: 'Grace Lee', email: 'grace.lee@school.edu' },
          { name: 'Noah Williams', email: 'noah.williams@school.edu' }
        ],
        'Chemistry  Period 2': [
          { name: 'Liam Johnson', email: 'liam.johnson@school.edu' },
          { name: 'Sophia Chen', email: 'sophia.chen@school.edu' },
          { name: 'Mason Rivera', email: 'mason.rivera@school.edu' }
        ],
        'World History  Period 7': [
          { name: 'Olivia Brooks', email: 'olivia.brooks@school.edu' },
          { name: 'Henry Adams', email: 'henry.adams@school.edu' }
        ]
      },
      archivedPolls: [
        {
          pollId: 'arch-bio-1',
          pollName: 'Cell Processes Review',
          className: 'AP Biology  Period 5',
          lastRunAt: new Date(Date.now() - 86400 * 1000 * 9).toISOString(),
          createdAt: new Date(Date.now() - 86400 * 1000 * 20).toISOString(),
          questionCount: 4,
          totalResponses: 22,
          totalStudents: 24,
          questions: [
            {
              questionText: 'What is ATP often called within the cell?',
              options: [{ text: 'Energy currency' }, { text: 'Protein factory' }, { text: 'Genetic blueprint' }, { text: 'Cell wall' }],
              correctAnswer: 'Energy currency',
              summary: { correct: 18, incorrect: 3, noResponse: 3, violations: 0 },
              responses: [
                { name: 'Ava Martinez', answer: 'Energy currency', isCorrect: true },
                { name: 'Ethan Patel', answer: 'Energy currency', isCorrect: true },
                { name: 'Grace Lee', answer: 'Protein factory', isCorrect: false }
              ],
              nonResponders: [
                { name: 'Noah Williams' },
                { name: 'Miles Turner' }
              ]
            }
          ]
        }
      ],
      analytics: {
        kpis: [
          { label: 'Avg Participation', value: '88%', delta: 5, tooltip: 'Average participation over the last 7 days.' },
          { label: 'Mastery Trend', value: '74%', delta: 3, tooltip: 'Average mastery compared to last week.' },
          { label: 'Integrity Events', value: '2', delta: -1, tooltip: 'Academic integrity events this week.' }
        ],
        topics: [
          { topic: 'Cell Biology', masteryPct: 82, questionCount: 12 },
          { topic: 'Metabolism', masteryPct: 68, questionCount: 9 },
          { topic: 'Industrialization', masteryPct: 74, questionCount: 7 }
        ],
        items: [
          { qNum: 1, topic: 'Cell Biology', correctPct: 84, rbis: 0.38, choiceCounts: { A: 2, B: 18, C: 4, D: 1 }, correctIndex: 1, medianTimeSec: 32, total: 25, flags: [] },
          { qNum: 2, topic: 'Metabolism', correctPct: 61, rbis: 0.22, choiceCounts: { A: 5, B: 9, C: 8, D: 3 }, correctIndex: 2, medianTimeSec: 45, total: 25, flags: ['watch'] },
          { qNum: 3, topic: 'Industrialization', correctPct: 47, rbis: 0.11, choiceCounts: { A: 10, B: 6, C: 7, D: 2 }, correctIndex: 0, medianTimeSec: 38, total: 25, flags: ['low-disc'] }
        ],
        students: {
          'ava.martinez@school.edu': {
            name: 'Ava Martinez',
            email: 'ava.martinez@school.edu',
            successLast10: 92.0,
            participationPct: 100,
            integrityCount: 0,
            sessions: [
              { sessionName: 'Cell Energy Exit Ticket', scorePct: 95 },
              { sessionName: 'Metabolism Pop Quiz', scorePct: 88 },
              { sessionName: 'Photosynthesis Check', scorePct: 93 }
            ],
            topicPerformance: {
              'Cell Biology': { correct: 18, total: 20 },
              'Metabolism': { correct: 14, total: 16 },
              'Industrialization': { correct: 6, total: 8 }
            }
          },
          'ethan.patel@school.edu': {
            name: 'Ethan Patel',
            email: 'ethan.patel@school.edu',
            successLast10: 78.0,
            participationPct: 86,
            integrityCount: 1,
            sessions: [
              { sessionName: 'Cell Energy Exit Ticket', scorePct: 82 },
              { sessionName: 'Metabolism Pop Quiz', scorePct: 74 },
              { sessionName: 'Photosynthesis Check', scorePct: 78 }
            ],
            topicPerformance: {
              'Cell Biology': { correct: 15, total: 20 },
              'Metabolism': { correct: 10, total: 16 },
              'Industrialization': { correct: 5, total: 8 }
            }
          }
        }
      }
    };

    var runtimeWatchTimer = null;
    var runtimeFallbackTimer = null;
    var RUNTIME_MAX_WAIT_MS = 4000;
    var RUNTIME_POLL_INTERVAL = 200;

    function bootstrapAppsScriptRuntime() {
      if (hasAppsScriptRuntime()) {
        PREVIEW_MODE = false;
        loadInitialData();
        return;
      }

      if (runtimeWatchTimer) {
        clearInterval(runtimeWatchTimer);
      }
      runtimeWatchTimer = setInterval(function () {
        if (!hasAppsScriptRuntime()) {
          return;
        }
        clearInterval(runtimeWatchTimer);
        runtimeWatchTimer = null;
        if (runtimeFallbackTimer) {
          clearTimeout(runtimeFallbackTimer);
          runtimeFallbackTimer = null;
        }
        if (previewBootstrapped) {
          PREVIEW_MODE = false;
          previewBootstrapped = false;
          try {
            LocalCache.invalidate('dashboardData');
          } catch (err) {
            console.warn('Unable to clear cached dashboard payload after reconnect:', err);
          }
          showToast('info', 'Connected', 'Live data connection restored. Loading polls', 3500);
        }
        loadInitialData();
      }, RUNTIME_POLL_INTERVAL);

      if (runtimeFallbackTimer) {
        clearTimeout(runtimeFallbackTimer);
      }
      runtimeFallbackTimer = setTimeout(function () {
        runtimeFallbackTimer = null;
        if (hasAppsScriptRuntime()) {
          return;
        }
        console.warn('Apps Script runtime not detected after ' + RUNTIME_MAX_WAIT_MS + 'ms  showing cached preview data.');
        PREVIEW_MODE = true;
        previewBootstrapped = true;
        loadInitialData();
        showToast('warning', 'Offline preview', 'Live backend unavailable. Displaying cached sample data.', 5000);
      }, RUNTIME_MAX_WAIT_MS);
    }

    function previewOnlyNotice(actionLabel) {
      var actionText = actionLabel || 'complete this action';
      return veritasAlert('This feature is disabled in preview mode. Open the deployed Veritas dashboard to ' + actionText + '.', {
        title: 'Preview mode'
      });
    }

    // Update header datetime
    function updateHeaderDateTime() {
      var datetimeEl = document.getElementById('header-datetime');
      if (datetimeEl) {
        var now = new Date();
        var options = { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' };
        datetimeEl.textContent = now.toLocaleDateString('en-US', options);
      }
    }
    updateHeaderDateTime();
    setInterval(updateHeaderDateTime, 60000); // Update every minute

    var VeritasModal = null;
    var veritasModalReady = new Promise(function (resolve) {
      function initializeModal() {
        VeritasModal = window.VeritasModal || createVeritasModal();
        window.VeritasModal = VeritasModal;
        resolve(VeritasModal);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeModal, { once: true });
      } else {
        initializeModal();
      }
    });

    function withVeritasModal(callback) {
      return veritasModalReady.then(function (controller) {
        return callback(controller);
      });
    }

    function veritasAlert(message, options) {
      return withVeritasModal(function (modal) {
        return modal.alert(Object.assign({ message: message }, options || {}));
      });
    }

    function veritasConfirm(message, options) {
      return withVeritasModal(function (modal) {
        return modal.confirm(Object.assign({ message: message }, options || {}));
      });
    }

    function veritasPrompt(message, options) {
      return withVeritasModal(function (modal) {
        return modal.prompt(Object.assign({ message: message }, options || {}));
      });
    }

    function ensureVeritasModalRoot() {
      var existing = document.getElementById('veritas-modal-root');
      if (existing) {
        return existing;
      }

      var root = document.createElement('div');
      root.id = 'veritas-modal-root';
      root.className = 'veritas-modal-root';
      root.setAttribute('aria-hidden', 'true');
      root.innerHTML = '' +
        '<div class="veritas-modal-backdrop"></div>' +
        '<div class="veritas-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="veritas-modal-title" aria-describedby="veritas-modal-message">' +
        '<div class="veritas-modal-header">' +
        '<h2 id="veritas-modal-title">Notice</h2>' +
        '</div>' +
        '<div class="veritas-modal-body">' +
        '<p id="veritas-modal-message"></p>' +
        '<div id="veritas-modal-subtext" class="veritas-modal-subtext"></div>' +
        '<div id="veritas-modal-input" class="veritas-modal-input" style="display: none;">' +
        '<label for="veritas-modal-input-field" class="sr-only">Input</label>' +
        '<input id="veritas-modal-input-field" type="text" autocomplete="off" />' +
        '</div>' +
        '</div>' +
        '<div class="veritas-modal-actions">' +
        '<button type="button" class="veritas-modal-button secondary" data-action="cancel">Cancel</button>' +
        '<button type="button" class="veritas-modal-button primary" data-action="confirm">' +
        '<span class="veritas-modal-spinner" aria-hidden="true"></span>' +
        '<span>Confirm</span>' +
        '</button>' +
        '</div>' +
        '</div>';

      (document.body || document.documentElement).appendChild(root);
      return root;
    }

    function createVeritasModal() {
      var root = ensureVeritasModalRoot();

      var dialog = root.querySelector('.veritas-modal-dialog');
      var titleEl = root.querySelector('#veritas-modal-title');
      var messageEl = root.querySelector('#veritas-modal-message');
      var subtextEl = root.querySelector('#veritas-modal-subtext');
      var inputWrap = root.querySelector('#veritas-modal-input');
      var inputField = root.querySelector('#veritas-modal-input-field');
      var confirmBtn = root.querySelector('[data-action="confirm"]');
      var cancelBtn = root.querySelector('[data-action="cancel"]');
      var confirmLabel = confirmBtn.querySelector('span:not(.veritas-modal-spinner)');
      var active = false;
      var currentConfig = null;
      var resolveFn = null;
      var previousFocus = null;
      var allowEscape = true;
      var hiddenNodes = [];

      function toggleBackground(state) {
        var siblings = [].slice.call(document.body.children);
        if (state) {
          hiddenNodes = [];
          siblings.forEach(function (node) {
            if (node === root) return;
            hiddenNodes.push({
              node: node,
              ariaHidden: node.getAttribute('aria-hidden'),
              inert: ('inert' in node) ? node.inert : null
            });
            node.setAttribute('aria-hidden', 'true');
            if ('inert' in node) {
              node.inert = true;
            }
          });
        } else {
          hiddenNodes.forEach(function (record) {
            if (record.ariaHidden === null) {
              record.node.removeAttribute('aria-hidden');
            } else {
              record.node.setAttribute('aria-hidden', record.ariaHidden);
            }
            if ('inert' in record.node) {
              if (record.inert !== null) {
                record.node.inert = record.inert;
              } else {
                record.node.inert = false;
              }
            }
          });
          hiddenNodes = [];
        }
      }

      function setPending(state) {
        if (state) {
          confirmBtn.classList.add('loading');
          confirmBtn.setAttribute('disabled', 'disabled');
          if (cancelBtn.style.display !== 'none') {
            cancelBtn.setAttribute('disabled', 'disabled');
          }
        } else {
          confirmBtn.classList.remove('loading');
          confirmBtn.removeAttribute('disabled');
          cancelBtn.removeAttribute('disabled');
        }
      }

      function getFocusable() {
        var selectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
        var nodes = [].slice.call(dialog.querySelectorAll(selectors));
        return nodes.filter(function (node) {
          return !node.hasAttribute('disabled') && node.offsetParent !== null;
        });
      }

      function focusFirst() {
        var focusable = getFocusable();
        if (focusable.length > 0) {
          focusable[0].focus();
        } else {
          dialog.focus();
        }
      }

      function trapKey(event) {
        if (!active) return;
        if (event.key === 'Escape') {
          if (!allowEscape) return;
          event.preventDefault();
          handleCancel();
        } else if (event.key === 'Tab') {
          var focusable = getFocusable();
          if (focusable.length === 0) {
            event.preventDefault();
            return;
          }
          var index = focusable.indexOf(document.activeElement);
          if (event.shiftKey) {
            if (index <= 0) {
              focusable[focusable.length - 1].focus();
              event.preventDefault();
            }
          } else {
            if (index === focusable.length - 1) {
              focusable[0].focus();
              event.preventDefault();
            }
          }
        } else if (event.key === 'Enter' && currentConfig && currentConfig.mode === 'prompt') {
          if (document.activeElement === inputField) {
            event.preventDefault();
            handleConfirm();
          }
        }
      }

      function enforceFocus(event) {
        if (!active) return;
        if (!dialog.contains(event.target)) {
          event.stopPropagation();
          focusFirst();
        }
      }

      function closeModal(result) {
        active = false;
        root.classList.remove('is-active');
        root.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('veritas-modal-open');
        root.removeEventListener('keydown', trapKey, true);
        document.removeEventListener('focus', enforceFocus, true);
        toggleBackground(false);
        setPending(false);
        if (previousFocus && typeof previousFocus.focus === 'function') {
          setTimeout(function () { previousFocus.focus(); }, 0);
        }
        if (resolveFn) {
          resolveFn(result);
        }
        currentConfig = null;
        resolveFn = null;
      }

      function handleConfirm() {
        if (!active) return;
        setPending(true);
        var mode = currentConfig ? currentConfig.mode : 'alert';
        var result;
        if (mode === 'prompt') {
          result = inputField.value;
        } else if (mode === 'confirm') {
          result = true;
        }
        closeModal(result);
      }

      function handleCancel() {
        if (!active) return;
        var mode = currentConfig ? currentConfig.mode : 'alert';
        if (mode === 'alert') {
          closeModal(undefined);
          return;
        }
        if (mode === 'confirm') {
          closeModal(false);
        } else if (mode === 'prompt') {
          closeModal(null);
        }
      }

      function openModal(mode, options) {
        options = options || {};
        currentConfig = Object.assign({}, options, { mode: mode });
        allowEscape = options.allowEscape !== false;
        titleEl.textContent = options.title || (mode === 'confirm' ? 'Please Confirm' : (mode === 'prompt' ? 'Enter Response' : 'Notice'));
        if (options.html) {
          messageEl.innerHTML = options.html;
        } else {
          messageEl.textContent = options.message || '';
        }
        if (options.subtext) {
          subtextEl.style.display = 'block';
          subtextEl.textContent = options.subtext;
        } else {
          subtextEl.style.display = 'none';
          subtextEl.textContent = '';
        }
        if (mode === 'prompt') {
          inputWrap.style.display = 'flex';
          inputField.value = options.defaultValue || '';
          if (options.placeholder) {
            inputField.placeholder = options.placeholder;
          } else {
            inputField.removeAttribute('placeholder');
          }
        } else {
          inputWrap.style.display = 'none';
          inputField.value = '';
          inputField.removeAttribute('placeholder');
        }
        confirmLabel.textContent = options.confirmText || (mode === 'confirm' ? 'Confirm' : (mode === 'prompt' ? 'Submit' : 'OK'));
        if (options.destructive) {
          confirmBtn.classList.add('destructive');
        } else {
          confirmBtn.classList.remove('destructive');
        }
        cancelBtn.style.display = mode === 'alert' ? 'none' : 'inline-flex';
        cancelBtn.textContent = options.cancelText || 'Cancel';
        setPending(false);
        previousFocus = document.activeElement;
        root.classList.add('is-active');
        root.setAttribute('aria-hidden', 'false');
        document.body.classList.add('veritas-modal-open');
        active = true;
        root.addEventListener('keydown', trapKey, true);
        document.addEventListener('focus', enforceFocus, true);

        // Move focus to modal BEFORE setting aria-hidden on background to prevent accessibility warnings
        if (mode === 'prompt') {
          inputField.focus();
          inputField.select();
        } else if (mode === 'confirm' && options.focusCancel) {
          cancelBtn.focus();
        } else {
          confirmBtn.focus();
        }

        // Now that focus is inside the modal, it is safe to hide the background
        toggleBackground(true);

        return new Promise(function (resolve) {
          resolveFn = resolve;
        });
      }

      confirmBtn.addEventListener('click', handleConfirm);
      cancelBtn.addEventListener('click', handleCancel);
      root.addEventListener('click', function (event) {
        if (event.target === root || event.target.classList.contains('veritas-modal-backdrop')) {
          if (!currentConfig || currentConfig.allowBackdropClose === false) {
            return;
          }
          handleCancel();
        }
      });

      return {
        alert: function (options) {
          return openModal('alert', options).then(function () { return; });
        },
        confirm: function (options) {
          return openModal('confirm', options).then(function (result) { return result !== false; });
        },
        prompt: function (options) {
          return openModal('prompt', options).then(function (result) { return result; });
        }
      };
    }

    // --- DOM Utilities ---
    function bindClick(id, handler) {
      var el = document.getElementById(id);
      if (!el) {
        console.warn('Missing click target:', id);
        return null;
      }
      el.addEventListener('click', handler);
      return el;
    }

    function bindInput(id, eventName, handler) {
      var el = document.getElementById(id);
      if (!el) {
        console.warn('Missing input target:', id);
        return null;
      }
      el.addEventListener(eventName, handler);
      return el;
    }

    function bindChange(element, handler, debugId) {
      if (!element) {
        console.warn('Missing change target:', debugId);
        return;
      }
      element.addEventListener('change', handler);
    }

    function updateDashboardSidebarToggleState() {
      var iconName = dashboardSidebarVisible ? 'menu_open' : 'menu';
      var ariaLabel = dashboardSidebarVisible ? 'Hide navigation' : 'Show navigation';
      dashboardSidebarToggleButtons.forEach(function (btn) {
        if (!btn) return;
        var icon = btn.querySelector('.material-symbols-outlined');
        if (icon) {
          icon.textContent = iconName;
        }
        btn.setAttribute('aria-label', ariaLabel);
        btn.setAttribute('aria-expanded', dashboardSidebarVisible ? 'true' : 'false');
      });
    }

    function setDashboardSidebarVisibility(visible) {
      if (!dashboardSidebar) return;
      dashboardSidebarVisible = visible;
      if (visible) {
        dashboardSidebar.classList.remove('hidden');
        dashboardSidebar.classList.add('flex');
        // Restore lg:flex if it was removed
        dashboardSidebar.classList.add('lg:flex');
        dashboardSidebar.style.display = '';
      } else {
        dashboardSidebar.classList.add('hidden');
        dashboardSidebar.classList.remove('flex');
        // CRITICAL FIX: Also remove lg:flex, otherwise it overrides hidden on large screens
        dashboardSidebar.classList.remove('lg:flex');
        dashboardSidebar.style.display = '';
      }
      updateDashboardSidebarToggleState();
    }

    function toggleDashboardSidebar(event) {
      if (event) {
        event.preventDefault();
      }
      setDashboardSidebarVisibility(!dashboardSidebarVisible);
    }

    function registerDashboardSidebarToggle(id) {
      var btn = bindClick(id, toggleDashboardSidebar);
      if (btn) {
        dashboardSidebarToggleButtons.push(btn);
      }
    }

    function storeButtonDefaultHtml(button) {
      if (button && !button.dataset.defaultHtml) {
        button.dataset.defaultHtml = button.innerHTML;
      }
    }

    function buttonSpinnerMarkup(text) {
      return '<span class="flex w-full items-center justify-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"></span><span>' + escapeHtml(text || 'Loading...') + '</span></span>';
    }

    function setButtonLoading(button, isLoading, label) {
      if (!button) {
        return;
      }
      if (isLoading) {
        storeButtonDefaultHtml(button);
        button.disabled = true;
        button.setAttribute('aria-busy', 'true');
        button.setAttribute('aria-disabled', 'true');
        button.innerHTML = buttonSpinnerMarkup(label);
      } else {
        if (button.dataset.defaultHtml) {
          button.innerHTML = button.dataset.defaultHtml;
        }
        button.disabled = false;
        button.removeAttribute('aria-busy');
        button.removeAttribute('aria-disabled');
      }
    }

    function bootstrapGoogleCharts() {
      if (googleChartsReady || googleChartsLoading) {
        return;
      }
      if (!(window.google && google.charts && typeof google.charts.load === 'function')) {
        return;
      }
      googleChartsLoading = true;
      google.charts.load('current', { 'packages': ['corechart'] });
      google.charts.setOnLoadCallback(function () {
        googleChartsReady = true;
        googleChartsLoading = false;
        if (googleChartsBootstrapTimer) {
          clearInterval(googleChartsBootstrapTimer);
          googleChartsBootstrapTimer = null;
        }
        try {
          onGoogleChartsReady();
        } catch (err) {
          console.error('Post-chart bootstrap failed:', err);
        }
      });
    }

    function onGoogleChartsReady() {
      // Activity pulse feature has been removed from dashboard
      if (typeof renderAnalyticsByTab === 'function' && typeof analyticsData !== 'undefined' && analyticsData) {
        try {
          renderAnalyticsByTab();
        } catch (err) {
          console.error('Analytics redraw failed:', err);
        }
      }
    }

    // --- Element Cache ---
    var pollSelect = document.getElementById('poll-select');
    var startPollBtn = document.getElementById('start-poll-btn');
    var sendLinkBtn = document.getElementById('send-link-btn');
    var viewLinksBtn = document.getElementById('view-links-btn');
    var headerSessionControls = document.getElementById('header-session-controls');
    var dashboardSidebar = document.getElementById('dashboard-sidebar');
    var dashboardSidebarVisible = (window.innerWidth >= 1024);
    var dashboardSidebarToggleButtons = [];
    var dashboard = document.getElementById('dashboard');
    var liveView = document.getElementById('live-view');
    var liveMobileNav = document.getElementById('live-mobile-nav');
    var liveMobileActions = document.getElementById('live-mobile-actions');
    var rosterManager = document.getElementById('roster-manager');
    var archivedView = document.getElementById('archived-view');
    var analyticsView = document.getElementById('analytics-view');
    var headerDefault = document.getElementById('header-default');
    var headerLive = document.getElementById('header-live');
    var liveCalculatorToggle = document.getElementById('header-calc-toggle');
    var liveCalculatorStateText = document.getElementById('header-calc-state');
    var modal = document.getElementById('poll-creator-modal');
    var linksModal = document.getElementById('student-links-modal');
    var pollSortSelect = document.getElementById('poll-sort-select');
    var pollFilterSelect = document.getElementById('poll-filter-select');
    var pollSearchInput = document.getElementById('poll-search-input');
    var pollSearchClearBtn = document.getElementById('poll-search-clear-btn');
    var pollsCardView = document.getElementById('polls-card-view');
    var pollsTableBody = document.getElementById('polls-table-body');
    var pollsEmptyState = document.getElementById('polls-empty-state');
    var classSelect = document.getElementById('class-select');
    var sessionToggleButtons = document.querySelectorAll('.builder-session-toggle');
    var secureSettingsPanel = document.getElementById('secure-assessment-settings');
    var secureSessionMeta = document.getElementById('secure-session-meta');
    var secureTimeLimitInput = document.getElementById('secure-time-limit-input');
    var secureAccessCodeInput = document.getElementById('secure-access-code-input');
    var secureAvailableInput = document.getElementById('secure-available-input');
    var secureDueInput = document.getElementById('secure-due-input');
    var studentManagerModal = document.getElementById('student-manager-modal');
    var studentManagerName = document.getElementById('student-manager-name');
    var studentManagerStatus = document.getElementById('student-manager-status');
    var studentManagerProgress = document.getElementById('student-manager-progress');
    var studentManagerTime = document.getElementById('student-manager-time');
    var studentManagerExtra = document.getElementById('student-manager-extra');
    var studentManagerConnection = document.getElementById('student-manager-connection');
    var studentManagerConnectionDot = document.getElementById('student-manager-connection-dot');
    var studentManagerMessage = document.getElementById('student-manager-message');
    var studentManagerLoading = document.getElementById('student-manager-loading');
    var studentManagerAdd5 = document.getElementById('student-manager-add-5');
    var studentManagerAdd10 = document.getElementById('student-manager-add-10');
    var studentManagerPause = document.getElementById('student-manager-pause');
    var studentManagerUnlock = document.getElementById('student-manager-unlock');
    var studentManagerForceSubmit = document.getElementById('student-manager-force-submit');
    var studentManagerClose = document.getElementById('student-manager-close');
    var bulkTimeInput = document.getElementById('bulk-time-input');
    var bulkTimeAllBtn = document.getElementById('bulk-time-all-btn');
    var bulkTimeSelectedBtn = document.getElementById('bulk-time-selected-btn');
    var bulkSelectionCount = document.getElementById('bulk-selection-count');
    var bulkSelectionClear = document.getElementById('bulk-selection-clear');
    var bulkSelectedLabel = document.getElementById('bulk-selected-label');
    var questionSortResetBtn = document.getElementById('question-sort-reset-btn');
    var questionSortHelp = document.getElementById('question-sort-help');
    var questionNavigatorContainer = document.getElementById('question-navigator');
    var archivedClassFilterSelect = document.getElementById('archived-class-filter');
    var archivedList = document.getElementById('archived-list');
    var archivedEmptyState = document.getElementById('archived-empty-state');
    var archivedDetail = document.getElementById('archived-detail');
    var archivedPollTitle = document.getElementById('archived-poll-title');
    var archivedPollMeta = document.getElementById('archived-poll-meta');
    var archivedQuestionCount = document.getElementById('archived-question-count');
    var archivedResponseCount = document.getElementById('archived-response-count');
    var archivedQuestionsContainer = document.getElementById('archived-questions-container');
    var rosterClassList = document.getElementById('roster-class-list');
    var rosterClassTitle = document.getElementById('roster-class-title');
    var rosterEmptyState = document.getElementById('roster-empty-state');
    var rosterTableWrapper = document.getElementById('roster-table-wrapper');
    var rosterTableBody = document.getElementById('roster-table-body');
    var rosterStatus = document.getElementById('roster-status');
    var renameClassBtn = document.getElementById('rename-class-btn');
    var deleteClassBtn = document.getElementById('delete-class-btn');
    var addClassBtn = document.getElementById('add-class-btn');
    var addStudentRowBtn = document.getElementById('add-student-row-btn');
    var saveRosterBtn = document.getElementById('save-roster-btn');
    var refreshArchivedBtn = document.getElementById('refresh-archived-btn');

    // Emulator controls
    var emulatorControls = document.getElementById('emulator-controls');
    var emulatorEnabled = document.getElementById('emulator-enabled');
    var emulatorOptions = document.getElementById('emulator-options');
    var emulatorStudentCount = document.getElementById('emulator-student-count');
    var emulatorConcurrent = document.getElementById('emulator-concurrent');
    var emulatorAvailable = false;

    storeButtonDefaultHtml(startPollBtn);
    storeButtonDefaultHtml(sendLinkBtn);
    storeButtonDefaultHtml(viewLinksBtn);

    // --- Initialization ---
    bootstrapAppsScriptRuntime();

    if (window.google && google.charts && typeof google.charts.load === 'function') {
      bootstrapGoogleCharts();
    } else {
      console.warn('Google Charts unavailable  continuing initialization without charts.');
      googleChartsBootstrapTimer = setInterval(function () {
        if (window.google && google.charts && typeof google.charts.load === 'function') {
          bootstrapGoogleCharts();
        }
      }, 400);
      setTimeout(function () {
        if (googleChartsBootstrapTimer) {
          clearInterval(googleChartsBootstrapTimer);
          googleChartsBootstrapTimer = null;
        }
      }, 8000);
    }

    bindClick('nav-create-poll', function () {
      console.log('Create New Poll button clicked - opening wizard via Wizard.init()');
      Wizard.init();
    });
    bindClick('nav-polls-list', showDashboard);
    bindClick('nav-rosters', showRosterManager);
    bindClick('nav-archived', showArchivedView);
    bindClick('nav-analytics', showAnalyticsView);
    bindClick('close-modal-btn', closePollCreator);
    bindClick('close-links-modal-btn', closeLinksModal);
    bindClick('close-preview-modal-btn', closePollPreview);
    bindClick('preview-prev-question-btn', previewPrevQuestion);
    bindClick('preview-next-question-btn', previewNextQuestion);
    bindClick('preview-open-links-btn', previewOpenLinks);
    bindClick('preview-edit-question-btn', previewEditQuestion);
    bindClick('preview-delete-question-btn', previewDeleteQuestion);
    bindClick('preview-reorder-btn', togglePreviewReorder);
    bindClick('add-question-btn', addQuestion);
    bindClick('save-poll-btn', savePoll);

    // NEW FEATURE: Question Bank Import
    bindClick('import-from-bank-btn', openQuestionBank);
    bindClick('close-question-bank-btn', closeQuestionBank);
    bindClick('import-selected-btn', importSelectedQuestions);

    // NEW FEATURE: AI Suggestions
    bindClick('ai-suggest-btn', openAISuggestions);
    bindClick('close-ai-modal-btn', closeAISuggestions);
    bindClick('generate-ai-btn', generateAISuggestions);

    // NEW FEATURE: Stimulus/Passage
    bindClick('add-stimulus-btn', openStimulusModal);
    bindClick('close-stimulus-modal-btn', closeStimulusModal);
    bindClick('cancel-stimulus-btn', closeStimulusModal);
    bindClick('create-stimulus-btn', createStimulusWithQuestions);

    bindInput('new-poll-name', 'input', markPollDirty);
    bindChange(classSelect, markPollDirty, 'class-select');

    if (sessionToggleButtons && sessionToggleButtons.length) {
      sessionToggleButtons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          var targetType = this.dataset.sessionType;
          setPollSessionType(targetType);
        });
      });
    }

    if (secureTimeLimitInput) {
      secureTimeLimitInput.addEventListener('input', function () {
        readSecureSettingsFromInputs();
        markPollDirty();
      });
    }

    if (secureAccessCodeInput) {
      secureAccessCodeInput.addEventListener('input', function () {
        this.value = (this.value || '').toUpperCase();
        readSecureSettingsFromInputs();
        markPollDirty();
      });
    }

    if (secureAvailableInput) {
      secureAvailableInput.addEventListener('change', function () {
        readSecureSettingsFromInputs();
        markPollDirty();
      });
    }

    if (secureDueInput) {
      secureDueInput.addEventListener('change', function () {
        readSecureSettingsFromInputs();
        markPollDirty();
      });
    }

    syncSessionTypeToggleUI();
    updateSecureSettingsVisibility();
    populateSecureSettingsInputs();

    if (pollSearchInput) {
      pollSearchInput.addEventListener('input', function () {
        pollSearchQuery = (this.value || '').trim();
        refreshPollViews();
        updatePollSearchClear();
      });
    }

    if (pollSearchClearBtn) {
      pollSearchClearBtn.addEventListener('click', function () {
        pollSearchQuery = '';
        if (pollSearchInput) {
          pollSearchInput.value = '';
          pollSearchInput.focus();
        }
        refreshPollViews();
        updatePollSearchClear();
      });
    }

    updatePollSearchClear();
    setQuestionReorderHelp();

    if (questionSortResetBtn) {
      questionSortResetBtn.addEventListener('click', function () {
        resetQuestionOrderToInitial();
      });
    }

    if (questionNavigatorContainer) {
      questionNavigatorContainer.addEventListener('dragover', handleNavigatorDragOver);
      questionNavigatorContainer.addEventListener('drop', handleNavigatorDrop);
    }

    if (startPollBtn) {
      startPollBtn.addEventListener('click', onStartPoll);
    } else {
      console.warn('Missing click target: start-poll-btn');
    }

    // --- Emulator Controls ---
    function initEmulatorControls() {
      console.log('[Emulator] Initializing controls...', {
        emulatorControlsExists: !!emulatorControls,
        emulatorEnabledExists: !!emulatorEnabled
      });

      if (!emulatorControls || !emulatorEnabled) {
        console.warn('[Emulator] DOM elements not found - emulator controls will not be available');
        return;
      }

      // FIREBASE MIGRATION: Emulator Availability
      // Instead of GAS, check if we are in a local environment or if a specific flag is set
      emulatorAvailable = !!(typeof FIREBASE_CONFIG !== 'undefined' && FIREBASE_CONFIG.projectId && FIREBASE_CONFIG.projectId.includes('emulator'));

      // Fallback: Enable if specifically requested via URL param or similar
      if (window.location.search.includes('emulator=true')) emulatorAvailable = true;

      if (emulatorAvailable) {
        emulatorControls.classList.remove('hidden');
        console.log('[Emulator]  Available and controls shown');
      } else {
        console.log('[Emulator]  Not available (Live environment)');
      }

      // Toggle options visibility when checkbox changes
      emulatorEnabled.addEventListener('change', function () {
        if (emulatorOptions) {
          if (this.checked) {
            emulatorOptions.classList.remove('hidden');
          } else {
            emulatorOptions.classList.add('hidden');
          }
        }
      });
    }

    // Initialize emulator controls after a short delay to ensure DOM is ready
    setTimeout(initEmulatorControls, 500);

    /**
     * Trigger student emulation for a live poll
     * @param {string} pollId - Poll ID to emulate
     */
    function triggerLivePollEmulation(pollId) {
      if (!emulatorAvailable) return;
      var studentCount = emulatorStudentCount ? parseInt(emulatorStudentCount.value, 10) || 5 : 5;
      var concurrent = emulatorConcurrent ? emulatorConcurrent.checked : false;

      console.log('[Emulator] Triggering live poll emulation', { pollId: pollId, studentCount: studentCount, concurrent: concurrent });
      showToast('info', 'Emulator', 'Starting emulation with ' + studentCount + ' students...');

      // FIREBASE MIGRATION: Call Cloud Function for emulation
      firebase.functions().httpsCallable('manageProctoring')({
        action: 'EMULATE_LIVE',
        pollId: pollId,
        studentCount: studentCount,
        concurrent: concurrent
      }).then(function (result) {
        var res = result.data;
        if (res && res.success) {
          showToast('success', 'Emulator', 'Emulation complete: ' + res.successfulSubmissions + '/' + res.totalSubmissions);
        } else {
          throw new Error((res && res.error) || 'Emulation failed');
        }
      }).catch(function (error) {
        showToast('error', 'Emulator', 'Emulation error: ' + error.message);
      });
    }

    /**
     * Trigger student emulation for a secure assessment
     * @param {string} pollId - Poll ID to emulate
     * @param {string} sessionId - Session ID
     */
    function triggerSecureAssessmentEmulation(pollId, sessionId) {
      if (!emulatorAvailable) return;
      var studentCount = emulatorStudentCount ? parseInt(emulatorStudentCount.value, 10) || 5 : 5;

      console.log('[Emulator] Triggering secure assessment emulation', { pollId: pollId, sessionId: sessionId, studentCount: studentCount });
      showToast('info', 'Emulator', 'Starting secure assessment emulation...');

      firebase.functions().httpsCallable('manageProctoring')({
        action: 'EMULATE_SECURE',
        pollId: pollId,
        studentCount: studentCount
      }).then(function (result) {
        var res = result.data;
        if (res && res.success) {
          showToast('success', 'Emulator', 'Emulation complete');
        } else {
          throw new Error((res && res.error) || 'Emulation failed');
        }
      }).catch(function (error) {
        showToast('error', 'Emulator', 'Emulation error: ' + error.message);
      });
    }

    // --- Calculator Toggles ---
    // (Live Calculator is already bound via bindClick below)

    var wizardCalcToggle = document.getElementById('wizard-calculator-toggle');
    if (wizardCalcToggle) {
      wizardCalcToggle.addEventListener('change', function () {
        if (typeof wizardState !== 'undefined') {
          wizardState.calculatorEnabled = this.checked;
        }
      });
    }
    bindClick('header-start-btn', onResumePoll);
    bindClick('header-end-show-btn', onEndQuestionAndShowAnswer);
    bindClick('header-stop-btn', onEndPoll);

    // FIX TASK D: Wire calculator button to proper handler (onToggleLiveCalculator)
    // Remove duplicate handler and use the comprehensive one defined below
    var calcToggleBtn = document.getElementById('header-calc-toggle');
    if (calcToggleBtn) {
      calcToggleBtn.addEventListener('click', onToggleLiveCalculator);
    }

    // Live View More Actions Menu
    bindClick('live-more-actions-btn', function (e) {
      e.stopPropagation();
      var menu = document.getElementById('live-more-menu');
      if (menu) {
        menu.classList.toggle('hidden');
      }
    });

    bindClick('header-edit-poll-btn', function () {
      if (CURRENT_POLL_DATA && CURRENT_POLL_DATA.pollId) {
        startEditPoll(CURRENT_POLL_DATA.pollId);
      }
    });

    // Close live menu on outside click
    document.addEventListener('click', function (e) {
      var menu = document.getElementById('live-more-menu');
      var btn = document.getElementById('live-more-actions-btn');
      if (menu && !menu.classList.contains('hidden') && !menu.contains(e.target) && (!btn || !btn.contains(e.target))) {
        menu.classList.add('hidden');
      }
    });

    bindClick('header-back-btn', onPreviousQuestion);
    bindClick('header-next-btn', onNextQuestion);
    bindClick('header-reset-question-btn', onResetQuestion);
    bindClick('hide-results-btn', onHideResults);
    bindClick('strip-next-btn', onNextQuestion);
    registerDashboardSidebarToggle('dashboard-sidebar-toggle');
    registerDashboardSidebarToggle('dashboard-sidebar-toggle-live');
    updateDashboardSidebarToggleState();

    var mobileTabs = document.querySelectorAll('.live-mobile-tab');
    mobileTabs.forEach(function (tab) {
      tab.addEventListener('click', function () {
        var panel = tab.getAttribute('data-panel');
        setActiveMobilePanelForViewport(panel);
      });
    });
    updateMobileLayoutVisibility();

    function focusLockoutsSection() {
      var panel = document.getElementById('exited-students-panel');
      if (panel) {
        panel.classList.remove('hidden');
        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
    bindClick('focus-lockouts-btn', focusLockoutsSection);
    // Initialize Locked Students Popover toggle
    var hudFocusBtn = document.getElementById('hud-focus-lockouts-btn');
    if (hudFocusBtn) {
      hudFocusBtn.onclick = function (e) {
        e.stopPropagation();
        var popover = document.getElementById('locked-students-popover');
        if (popover) {
          popover.classList.toggle('hidden');
        }
      };
    }
    // Close popover on click outside
    document.addEventListener('click', function (e) {
      var popover = document.getElementById('locked-students-popover');
      if (popover && !popover.classList.contains('hidden') && !popover.contains(e.target) && e.target !== hudFocusBtn) {
        popover.classList.add('hidden');
      }
    });

    // --- Tab Navigation System ---
    // New timer button event listeners
    bindClick('start-btn', startTimer);
    bindClick('pause-btn', pauseTimer);
    bindClick('reset-btn', resetTimer);
    bindClick('add-10s-btn', function () {
      parseInputToTotalSeconds();
      editTime(10);
    });
    bindClick('subtract-10s-btn', function () {
      parseInputToTotalSeconds();
      editTime(-10);
    });
    bindClick('mobile-start-btn', startTimer);
    bindClick('mobile-pause-btn', pauseTimer);
    bindClick('mobile-reset-btn', onResetQuestion);
    bindClick('mobile-next-btn', onNextQuestion);
    bindClick('mobile-reveal-btn', onEndQuestionAndShowAnswer);
    bindClick('mobile-resume-btn', onResumePoll);
    bindClick('mobile-stop-btn', onEndPoll);
    bindClick('add-10s-btn-mobile', function () {
      parseInputToTotalSeconds();
      editTime(10);
    });
    bindClick('subtract-10s-btn-mobile', function () {
      parseInputToTotalSeconds();
      editTime(-10);
    });
    bindClick('mobile-locks-btn', function () {
      var focusBtn = document.getElementById('hud-focus-lockouts-btn');
      if (focusBtn && !focusBtn.disabled) {
        focusBtn.click();
      }
    });

    // Timer display input event listener
    var timerDisplayInput = document.getElementById('timer-display');
    if (timerDisplayInput) {
      timerDisplayInput.addEventListener('blur', function () {
        parseInputToTotalSeconds();
        updateDisplay();
      });

      // Handle Enter key to blur and apply changes
      timerDisplayInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          timerDisplayInput.blur();
        }
      });
    }

    // Keyboard shortcuts for timer (when timer is visible)
    document.addEventListener('keydown', function (e) {
      var timerDisplay = document.getElementById('timer-display');
      if (!timerDisplay || !timerDisplay.offsetParent) return; // Timer not visible

      // Prevent shortcuts when typing in the timer input field or other inputs
      if (e.target === timerDisplay || e.target.tagName === 'TEXTAREA') return;

      if (e.key === ' ') {
        e.preventDefault();
        if (isRunning) {
          pauseTimer();
        } else {
          startTimer();
        }
      } else if (e.key === 'r' || e.key === 'R') {
        e.preventDefault();
        resetTimer();
      } else if (!isRunning && (e.key === 'ArrowLeft' || e.key === 'ArrowDown')) {
        e.preventDefault();
        parseInputToTotalSeconds();
        editTime(-10);
      } else if (!isRunning && (e.key === 'ArrowRight' || e.key === 'ArrowUp')) {
        e.preventDefault();
        parseInputToTotalSeconds();
        editTime(10);
      }
    });

    // Initialize timer display
    updateDisplay();
    updateTimerStatus('Timer idle.', 'info');
    bindClick('send-link-btn', onSendLink);
    bindClick('view-links-btn', onViewLinks);
    bindClick('header-send-link-btn', onSendLink);
    bindClick('header-view-links-btn', onViewLinks);

    // Student status search
    var studentSearchInput = document.getElementById('student-search-input');
    if (studentSearchInput) {
      studentSearchInput.addEventListener('input', function () {
        studentSearchQuery = this.value;
        renderStudentStatus();
      });
    }

    function syncStatusFilterButtons() {
      var lockedBtn = document.getElementById('filter-locked-only-btn');
      var allBtn = document.getElementById('filter-all-btn');
      if (lockedBtn) {
        if (studentStatusFilter === 'locked') {
          lockedBtn.classList.add('bg-red-500/30');
          lockedBtn.classList.remove('bg-red-500/10');
        } else {
          lockedBtn.classList.remove('bg-red-500/30');
          lockedBtn.classList.add('bg-red-500/10');
        }
      }
      if (allBtn) {
        if (studentStatusFilter === 'all') {
          allBtn.classList.add('bg-primary/30');
          allBtn.classList.remove('bg-primary/10');
        } else {
          allBtn.classList.remove('bg-primary/30');
          allBtn.classList.add('bg-primary/10');
        }
      }
    }

    var statusFilterSelect = document.getElementById('student-status-filter-select');
    if (statusFilterSelect) {
      statusFilterSelect.addEventListener('change', function () {
        studentStatusFilter = this.value;
        syncStatusFilterButtons();
        renderStudentStatus();
      });
    }

    var correctnessFilterSelect = document.getElementById('student-correctness-filter-select');
    if (correctnessFilterSelect) {
      correctnessFilterSelect.addEventListener('change', function () {
        studentCorrectnessFilter = this.value;
        renderStudentStatus();
      });
    }

    var studentSortSelectEl = document.getElementById('student-sort-select');
    if (studentSortSelectEl) {
      studentSortSelectEl.addEventListener('change', function () {
        studentTableSort.column = this.value;
        if (this.value === 'recent' && studentTableSort.direction === 'asc') {
          studentTableSort.direction = 'desc';
          var dirIcon = document.querySelector('#student-sort-direction-btn span');
          if (dirIcon) {
            dirIcon.textContent = 'north';
          }
        } else {
          var icon = document.querySelector('#student-sort-direction-btn span');
          if (icon) {
            icon.textContent = studentTableSort.direction === 'asc' ? 'south' : 'north';
          }
        }
        renderStudentStatus();
      });
    }

    var sortDirectionBtn = document.getElementById('student-sort-direction-btn');
    if (sortDirectionBtn) {
      sortDirectionBtn.addEventListener('click', function () {
        studentTableSort.direction = studentTableSort.direction === 'asc' ? 'desc' : 'asc';
        var icon = this.querySelector('span');
        if (icon) {
          icon.textContent = studentTableSort.direction === 'asc' ? 'south' : 'north';
        }
        renderStudentStatus();
      });
    }

    // Student status table sorting
    document.querySelectorAll('th[data-sort]').forEach(function (th) {
      th.addEventListener('click', function () {
        var column = this.dataset.sort;
        if (studentTableSort.column === column) {
          studentTableSort.direction = studentTableSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          studentTableSort.column = column;
          studentTableSort.direction = 'asc';
        }

        // Update sort icons
        document.querySelectorAll('th[data-sort] .sort-icon').forEach(function (icon) {
          icon.textContent = 'unfold_more';
        });
        var icon = this.querySelector('.sort-icon');
        if (icon) {
          icon.textContent = studentTableSort.direction === 'asc' ? 'arrow_upward' : 'arrow_downward';
        }

        renderStudentStatus();
      });
    });

    if (pollSelect) {
      pollSelect.addEventListener('change', onPollSelectChange);
    } else {
      console.warn('Missing change target: poll-select');
    }
    if (pollSortSelect) {
      pollSortSelect.addEventListener('change', function () { pollSortMode = this.value; refreshPollViews(); });
    } else {
      console.warn('Missing change target: poll-sort-select');
    }
    if (pollFilterSelect) {
      pollFilterSelect.addEventListener('change', function () { pollClassFilter = this.value; refreshPollViews(); });
    } else {
      console.warn('Missing change target: poll-filter-select');
    }
    if (archivedClassFilterSelect) {
      archivedClassFilterSelect.addEventListener('change', function () { archivedClassFilter = this.value; renderArchivedList(); });
    } else {
      console.warn('Missing change target: archived-class-filter');
    }
    if (addClassBtn) {
      addClassBtn.addEventListener('click', onAddClass);
    } else {
      console.warn('Missing click target: add-class-btn');
    }
    if (addStudentRowBtn) {
      addStudentRowBtn.addEventListener('click', addRosterRow);
    } else {
      console.warn('Missing click target: add-student-row-btn');
    }
    bindClick('bulk-add-students-btn', openBulkAddStudentsModal);
    bindClick('cancel-bulk-add-btn', closeBulkAddStudentsModal);
    bindClick('confirm-bulk-add-btn', confirmBulkAddStudents);
    if (saveRosterBtn) {
      saveRosterBtn.addEventListener('click', saveRoster);
    } else {
      console.warn('Missing click target: save-roster-btn');
    }
    if (renameClassBtn) {
      renameClassBtn.addEventListener('click', onRenameClass);
    } else {
      console.warn('Missing click target: rename-class-btn');
    }
    if (deleteClassBtn) {
      deleteClassBtn.addEventListener('click', onDeleteClass);
    } else {
      console.warn('Missing click target: delete-class-btn');
    }
    if (refreshArchivedBtn) {
      refreshArchivedBtn.addEventListener('click', function () { loadArchivedPolls(true); });
    } else {
      console.warn('Missing click target: refresh-archived-btn');
    }

    function setMainSection(section) {
      function updateUI() {
        currentMainSection = section;
        dashboard.style.display = section === 'dashboard' ? 'block' : 'none';
        liveView.style.display = section === 'live' ? 'grid' : 'none';
        rosterManager.style.display = section === 'roster' ? 'grid' : 'none';
        archivedView.style.display = section === 'archived' ? 'grid' : 'none';
        analyticsView.style.display = section === 'analytics' ? 'flex' : 'none';
        var individualTimedView = document.getElementById('individual-timed-view');
        if (individualTimedView) {
          individualTimedView.style.display = section === 'individual-timed' ? 'block' : 'none';
        }
        var createPollView = document.getElementById('create-poll-view');
        if (createPollView) {
          createPollView.style.display = section === 'create-poll' ? 'flex' : 'none';
        }

        var navButtons = document.querySelectorAll('.sidebar-nav-btn[data-section-target]');
        navButtons.forEach(function (btn) {
          var target = btn.getAttribute('data-section-target');
          var isActive = target === section;
          btn.classList.toggle('is-active', isActive);
          btn.setAttribute('aria-current', isActive ? 'page' : 'false');
          if (isActive) {
            btn.classList.add('font-semibold');
          } else {
            btn.classList.remove('font-semibold');
          }
        });

        if (headerSessionControls) {
          if (section === 'dashboard') {
            headerSessionControls.classList.remove('hidden');
          } else {
            headerSessionControls.classList.add('hidden');
          }
        }

        if (section === 'live') {
          setActiveMobilePanelForViewport(activeMobilePanel || 'question');
        }
        updateMobileLayoutVisibility();
      }

      if (document.startViewTransition) {
        document.startViewTransition(updateUI);
      } else {
        updateUI();
      }
    }

    function updateMobileLayoutVisibility() {
      var isMobileViewport = window.innerWidth <= 1024;

      if (liveMobileNav) {
        liveMobileNav.style.display = (isMobileViewport && currentMainSection === 'live') ? 'flex' : 'none';
      }

      if (liveMobileActions) {
        liveMobileActions.style.display = (isMobileViewport && currentMainSection === 'live') ? 'flex' : 'none';
      }

      setActiveMobilePanelForViewport(activeMobilePanel || 'question');
    }

    function setActiveMobilePanelForViewport(panel) {
      activeMobilePanel = panel || 'question';
      var panels = document.querySelectorAll('[data-mobile-panel]');
      var isMobileViewport = window.innerWidth <= 1024;

      panels.forEach(function (panelEl) {
        var matches = panelEl.getAttribute('data-mobile-panel') === activeMobilePanel || !isMobileViewport;
        panelEl.classList.toggle('is-active', matches);
      });

      var tabButtons = document.querySelectorAll('.live-mobile-tab');
      tabButtons.forEach(function (btn) {
        var isActive = btn.getAttribute('data-panel') === activeMobilePanel;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
    }

    window.addEventListener('resize', function () {
      updateMobileLayoutVisibility();
    });

    function clearLiveIntervals() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
      missionControlHeartbeat.stop();
      if (analyticsRefreshInterval) {
        clearInterval(analyticsRefreshInterval);
        analyticsRefreshInterval = null;
      }
      pauseTimerCountdown();
      stopVisualTimer();
      timerRemainingSeconds = timerPresetSeconds;
      timerActive = false;
      updateTimerDisplay();
      updateTimerStatus('Timer idle.', 'info');
    }

    function showDashboard() {
      clearLiveIntervals();
      isLiveSession = false;
      CURRENT_POLL_DATA = {};

      // Clear Mission Control state to prevent polling for non-existent polls
      currentMissionControlPollId = null;
      currentSecureSessionId = null;
      missionControlPollFailures = 0;
      missionControlBackoffMs = 0;
      missionControlHeartbeat.stop();

      headerDefault.style.display = 'flex';
      headerLive.style.display = 'none';
      setMainSection('dashboard');

      // Ensure sidebar is visible on dashboard
      setDashboardSidebarVisibility(true);

      // Load dashboard summary data (non-blocking)
      setTimeout(function () {
        if (!dashboardSummary) {
          loadDashboardSummary();
        } else {
          renderDashboardSummary();
        }
      }, 100);
    }

    function loadDashboardSummary() {
      if (PREVIEW_MODE && PREVIEW_PAYLOAD) {
        dashboardSummary = deepClone(PREVIEW_PAYLOAD.dashboardSummary || null);
        renderDashboardSummary();
        return;
      }

      // FIREBASE MIGRATION: Load Polls directly from RTDB
      // This replaces google.script.run.getDashboardSummary()

      if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
      var db = firebase.database();
      var pollsRef = db.ref('polls');

      // Listen for poll updates (realtime dashboard)
      pollsRef.on('value', function (snapshot) {
        var pollsObj = snapshot.val();
        var pollsList = [];

        if (pollsObj) {
          // Convert object to array
          Object.keys(pollsObj).forEach(function (key) {
            var p = pollsObj[key];
            p.pollId = key; // Ensure ID is present
            pollsList.push(p);
          });

          // Sort by createdAt desc (newest first)
          pollsList.sort(function (a, b) {
            return (b.createdAt || 0) - (a.createdAt || 0);
          });
        }

        // Construct equivalent dashboard summary object
        dashboardSummary = {
          polls: pollsList,
          totalPolls: pollsList.length,
          // Legacy/Placeholder stats (can be enriched later)
          activeSessions: 0,
          totalResponses: 0
        };

        console.log('[Firebase] Dashboard polls loaded:', pollsList.length);
        renderDashboardSummary();

      }, function (error) {
        console.error('[Firebase] Dashboard Poll Load Error:', error);
        // Fallback or error state
      });
    }

    function renderDashboardSummary() {
      // Recent sessions and activity pulse features have been removed
      // The dashboard now only shows the poll library
      var polls = (dashboardSummary && dashboardSummary.polls) ? dashboardSummary.polls : [];
      renderPollCards(polls);
      renderPollTable(polls);
    }

    function renderRecentSessions() {
      var container = document.getElementById('recent-sessions-container');
      if (!container) {
        console.warn('Recent sessions container not found');
        return;
      }

      if (!dashboardSummary || !dashboardSummary.recentSessions || dashboardSummary.recentSessions.length === 0) {
        container.innerHTML = '<div class="text-center py-6 text-gray-500 text-sm">No recent sessions found. Create your first poll to get started!</div>';
        return;
      }

      try {
        container.innerHTML = '';
        dashboardSummary.recentSessions.forEach(function (session) {
          var item = document.createElement('div');
          item.className = 'dashboard-list-item';

          // Format date
          var date = new Date(session.date);
          var formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

          // Determine badge class and content
          var badgeClass = 'success';
          var badgeIcon = 'check_circle';
          var badgeText = Math.round(session.participationPct || 0) + '%';

          if (session.flags > 0) {
            badgeClass = 'warning';
            badgeIcon = 'warning';
            badgeText = session.flags + ' flags';
          } else if ((session.masteryPct || 0) >= 80) {
            badgeClass = 'success';
          } else if ((session.masteryPct || 0) >= 60) {
            badgeClass = 'neutral';
          }

          item.innerHTML = '<div class="flex-1 min-w-0">' +
            '<p class="font-semibold text-sm text-veritas-navy">' + escapeHtml(session.sessionName || 'Untitled') + '</p>' +
            '<p class="text-xs text-gray-500 mt-0.5">' + formattedDate + '  ' + escapeHtml(session.className || '') + '</p>' +
            '</div>' +
            '<div class="flex items-center gap-3">' +
            '<div class="dashboard-stat-badge ' + badgeClass + '">' +
            (session.flags > 0 ? '<span class="material-symbols-outlined text-sm">' + badgeIcon + '</span>' : '') +
            '<span>' + badgeText + '</span>' +
            '</div>' +
            '<span class="text-xs text-gray-500">Avg ' + Math.round(session.masteryPct || 0) + '%</span>' +
            '</div>';

          container.appendChild(item);
        });
      } catch (e) {
        console.error('Error in renderRecentSessions:', e);
        container.innerHTML = '<div class="text-center py-6 text-red-500 text-sm">Error loading recent sessions</div>';
      }
    }

    function renderActivityPulse() {
      var chartContainer = document.getElementById('activity-chart-container');
      var summaryContainer = document.getElementById('activity-summary');
      if (!chartContainer || !summaryContainer) {
        console.warn('Activity pulse containers not found');
        return;
      }

      if (!dashboardSummary || !dashboardSummary.dailyActivity || dashboardSummary.dailyActivity.length === 0) {
        chartContainer.innerHTML = '<div class="text-center py-6 text-gray-500 text-sm">No activity data available</div>';
        summaryContainer.innerHTML = '';
        return;
      }

      try {
        // Find max count for scaling
        var maxCount = Math.max.apply(Math, dashboardSummary.dailyActivity.map(function (d) { return d.count || 0; }));
        if (maxCount === 0) maxCount = 1; // Avoid division by zero

        // Render bars
        chartContainer.innerHTML = '';
        dashboardSummary.dailyActivity.forEach(function (day) {
          var bar = document.createElement('div');
          bar.className = 'activity-bar';
          var heightPct = maxCount > 0 ? ((day.count || 0) / maxCount * 100) : 0;
          bar.style.height = heightPct + '%';
          bar.title = (day.dayName || 'Day') + ': ' + (day.count || 0) + ' interactions';
          chartContainer.appendChild(bar);
        });

        // Render summary
        var change = dashboardSummary.weekOverWeekChange || 0;
        var changeSymbol = change >= 0 ? '' : '';
        var changeClass = change >= 0 ? 'text-veritas-gold' : 'text-gray-500';
        var totalActivity = dashboardSummary.totalActivityThisWeek || 0;

        summaryContainer.innerHTML = '<div class="flex items-center justify-between">' +
          '<p class="text-sm text-gray-600">' +
          '<span class="font-semibold ' + changeClass + '">' + changeSymbol + ' ' + Math.abs(change) + '%</span> compared to last week' +
          '</p>' +
          '<span class="text-xs text-gray-400 italic">' + totalActivity + ' total interactions</span>' +
          '</div>';
      } catch (e) {
        console.error('Error in renderActivityPulse:', e);
        chartContainer.innerHTML = '<div class="text-center py-6 text-red-500 text-sm">Error loading activity data</div>';
        summaryContainer.innerHTML = '';
      }
    }

    function showRosterManager() {
      clearLiveIntervals();
      headerDefault.style.display = 'flex';
      headerLive.style.display = 'none';
      setMainSection('roster');
      if (Object.keys(rosterData).length === 0) {
        loadRosterData();
      } else {
        renderRosterClassList();
        if (selectedRosterClass) {
          renderRosterTable();
        } else {
          rosterEmptyState.classList.remove('hidden');
          rosterTableWrapper.classList.add('hidden');
          renameClassBtn.classList.add('hidden');
          deleteClassBtn.classList.add('hidden');
        }
      }
    }

    function showArchivedView() {
      clearLiveIntervals();
      headerDefault.style.display = 'flex';
      headerLive.style.display = 'none';
      setMainSection('archived');
      if (archivedPolls.length === 0) {
        loadArchivedPolls();
      } else {
        renderArchivedList();
        renderArchivedDetail();
      }
    }

    // --- Initial Data Load ---
    function loadInitialData() {
      // Clear Mission Control state on initial load to prevent polling for stale polls
      currentMissionControlPollId = null;
      currentSecureSessionId = null;
      missionControlPollFailures = 0;
      missionControlBackoffMs = 0;
      missionControlHeartbeat.stop();

      if (PREVIEW_MODE && PREVIEW_PAYLOAD) {
        previewBootstrapped = true;
        console.info('Apps Script runtime not detected  rendering preview data.');
        setTimeout(function () {
          onDashboardDataLoaded({
            polls: deepClone(PREVIEW_PAYLOAD.polls || []),
            classes: deepClone(PREVIEW_PAYLOAD.classes || [])
          });
        }, 120);
        return;
      }

      // FIREBASE MIGRATION: Roster data is usually loaded via showRosterManager
      // But we can pre-fetch it here if needed, or just let the app load polls.
      // The polls are already being loaded via loadDashboardSummary() which uses the RTDB listener.

      console.log('[Firebase] loadInitialData: Relying on RTDB listeners for polls.');

      // We still need to load Classes for the dropdowns
      var db = firebase.database();
      db.ref('rosters/classes').once('value').then(function (snapshot) {
        var classes = snapshot.val() || [];
        onDashboardDataLoaded({
          polls: dashboardSummary ? dashboardSummary.polls : [],
          classes: classes
        });
      });
    }

    function onDashboardDataLoaded(data) {
      // Defensive check: ensure data object exists
      if (!data) {
        console.warn('onDashboardDataLoaded received null/undefined data');
        data = { polls: [], classes: [] };
      }

      mainLoader.style.display = 'none';
      try {
        ALL_POLLS = data.polls || [];

        try {
          refreshClassOptions(data.classes || []);
        } catch (err) {
          console.warn('refreshClassOptions error:', err);
        }

        try {
          refreshPollViews();
        } catch (err) {
          console.error('refreshPollViews CRITICAL FAILURE:', err);
          // Non-fatal, dashboard can still load empty
        }

        // Auto-route to active session to prevent state amnesia
        if (data.activePollId && data.activePoll) {
          try {
            CURRENT_POLL_DATA = data.activePoll;
            updateLiveView(data.activePoll);
            setMainSection('live');
          } catch (err) {
            console.error('Failed to auto-route to active poll', err);
            if (dashboard) dashboard.style.display = 'block';
          }
        } else {
          try {
            setMainSection('dashboard');
          } catch (err) {
            console.error('setMainSection failed:', err);
            // Last resort force show
            if (dashboard) dashboard.style.display = 'block';
          }
        }

        // Load dashboard summary after a short delay
        setTimeout(function () {
          try {
            if (!dashboardSummary) {
              loadDashboardSummary();
            }
          } catch (e) { console.warn('Summary load failed', e); }
        }, 100);
      } catch (e) {
        console.error('Error loading dashboard:', e);
        handleError(e);
        // Ensure UI is visible even if errored
        if (dashboard) dashboard.style.display = 'block';
      }
    }

    function updatePollDropdown(polls) {
      polls = polls || getFilteredSortedPolls();
      var previousValue = pollSelect.value;
      pollSelect.innerHTML = '<option value="">-- Choose a poll --</option>';
      var hasSelection = false;
      polls.forEach(function (poll) {
        var opt = document.createElement('option');
        opt.value = poll.pollId;
        var questionTotal = Array.isArray(poll.questions) ? poll.questions.length : 0;
        var label = poll.pollName + ' (' + (poll.className || 'Unassigned') + ') - ' + questionTotal + ' questions';
        if (isSecureSessionTypeClient(poll.sessionType)) {
          var minutes = getSecureTimeLimitMinutes(poll);
          var code = getSecureAccessCode(poll);
          label = ' ' + label;
          if (minutes) {
            label += '  ' + minutes + ' min';
          }
          if (code) {
            label += '  Code ' + code;
          }
        }
        opt.textContent = label;
        if (poll.pollId === previousValue) {
          opt.selected = true;
          hasSelection = true;
        }
        pollSelect.appendChild(opt);
      });
      if (!hasSelection) {
        pollSelect.value = '';
      }
      onPollSelectChange();
    }

    function refreshClassOptions(classList) {
      BASE_CLASSES = (classList || []).map(function (name) { return (name || '').toString().trim(); }).filter(function (name) { return name !== ''; });
      var classSet = new Set();
      BASE_CLASSES.forEach(function (name) { classSet.add(name); });
      Object.keys(rosterData).forEach(function (name) { if (name) classSet.add(name); });
      ALL_POLLS.forEach(function (poll) {
        if (poll.className) {
          classSet.add(poll.className);
        }
      });
      ALL_CLASSES = Array.from(classSet).sort();
      window.ALL_CLASSES = ALL_CLASSES; // Expose for Poll Wizard

      var previousSelection = classSelect.value;
      classSelect.innerHTML = '<option value="">-- Select Class --</option>';
      ALL_CLASSES.forEach(function (className) {
        var opt = document.createElement('option');
        opt.value = className;
        opt.textContent = className;
        classSelect.appendChild(opt);
      });
      if (previousSelection && ALL_CLASSES.indexOf(previousSelection) !== -1) {
        classSelect.value = previousSelection;
      } else {
        classSelect.value = '';
      }

      updateClassFilters();
    }

    function updateClassFilters() {
      var previousPollFilter = pollClassFilter;
      pollFilterSelect.innerHTML = '<option value="all">All classes</option>';
      ALL_CLASSES.forEach(function (className) {
        var opt = document.createElement('option');
        opt.value = className;
        opt.textContent = className;
        pollFilterSelect.appendChild(opt);
      });
      if (previousPollFilter && ALL_CLASSES.indexOf(previousPollFilter) !== -1) {
        pollClassFilter = previousPollFilter;
      } else {
        pollClassFilter = 'all';
      }
      pollFilterSelect.value = pollClassFilter;

      var previousArchivedFilter = archivedClassFilter;
      archivedClassFilterSelect.innerHTML = '<option value="all">All classes</option>';
      ALL_CLASSES.forEach(function (className) {
        var opt = document.createElement('option');
        opt.value = className;
        opt.textContent = className;
        archivedClassFilterSelect.appendChild(opt);
      });
      if (previousArchivedFilter && ALL_CLASSES.indexOf(previousArchivedFilter) !== -1) {
        archivedClassFilter = previousArchivedFilter;
      } else {
        archivedClassFilter = 'all';
      }
      archivedClassFilterSelect.value = archivedClassFilter;
    }

    function updatePollSearchClear() {
      if (!pollSearchClearBtn) return;
      if (pollSearchQuery) {
        pollSearchClearBtn.classList.remove('hidden');
      } else {
        pollSearchClearBtn.classList.add('hidden');
      }
    }

    function pollMatchesSearch(poll, normalizedQuery) {
      if (!normalizedQuery) return true;
      var name = (poll && poll.pollName ? poll.pollName : '').toLowerCase();
      if (name.indexOf(normalizedQuery) !== -1) return true;
      var className = (poll && poll.className ? poll.className : '').toLowerCase();
      if (className.indexOf(normalizedQuery) !== -1) return true;
      if (!poll) return false;
      if (Array.isArray(poll.questions)) {
        for (var i = 0; i < poll.questions.length; i++) {
          var question = poll.questions[i] || {};
          var text = (question.questionText || '').toLowerCase();
          if (text.indexOf(normalizedQuery) !== -1) return true;
          var topic = (question.topicTag || question.topic || '').toLowerCase();
          if (topic.indexOf(normalizedQuery) !== -1) return true;
          var correctText = (question.correctAnswer || '').toLowerCase();
          if (correctText && correctText.indexOf(normalizedQuery) !== -1) return true;
          var options = Array.isArray(question.options) ? question.options : (Array.isArray(question.answers) ? question.answers : []);
          for (var j = 0; j < options.length; j++) {
            var option = options[j] || {};
            var optionText = (option.text || option.label || '').toLowerCase();
            if (optionText.indexOf(normalizedQuery) !== -1) return true;
          }
        }
      }
      var sessionCollections = [];
      if (poll && Array.isArray(poll.liveSessions)) sessionCollections.push(poll.liveSessions);
      if (poll && Array.isArray(poll.recentSessions)) sessionCollections.push(poll.recentSessions);
      if (poll && Array.isArray(poll.sessions)) sessionCollections.push(poll.sessions);
      for (var c = 0; c < sessionCollections.length; c++) {
        var collection = sessionCollections[c];
        for (var s = 0; s < collection.length; s++) {
          var session = collection[s] || {};
          var sessionNameRaw = session.sessionName || session.title || '';
          var sessionName = (typeof sessionNameRaw === 'string' ? sessionNameRaw : String(sessionNameRaw || '')).toLowerCase();
          if (sessionName.indexOf(normalizedQuery) !== -1) return true;
          var sessionNotesRaw = session.notes || session.summary || '';
          var sessionNotes = (typeof sessionNotesRaw === 'string' ? sessionNotesRaw : String(sessionNotesRaw || '')).toLowerCase();
          if (sessionNotes.indexOf(normalizedQuery) !== -1) return true;
          var sessionQuestions = Array.isArray(session.questions) ? session.questions : [];
          for (var q = 0; q < sessionQuestions.length; q++) {
            var sessionQuestion = sessionQuestions[q] || {};
            var sessionTextRaw = sessionQuestion.questionText || sessionQuestion.text || '';
            var sessionText = (typeof sessionTextRaw === 'string' ? sessionTextRaw : String(sessionTextRaw || '')).toLowerCase();
            if (sessionText.indexOf(normalizedQuery) !== -1) return true;
            var sessionOptions = Array.isArray(sessionQuestion.options) ? sessionQuestion.options : [];
            for (var so = 0; so < sessionOptions.length; so++) {
              var sessionOption = sessionOptions[so] || {};
              var sessionOptionRaw = sessionOption.text || sessionOption.label || '';
              var sessionOptionText = (typeof sessionOptionRaw === 'string' ? sessionOptionRaw : String(sessionOptionRaw || '')).toLowerCase();
              if (sessionOptionText.indexOf(normalizedQuery) !== -1) return true;
            }
          }
        }
      }
      return false;
    }

    function getFilteredSortedPolls() {
      var list = ALL_POLLS.slice();
      if (pollClassFilter !== 'all') {
        list = list.filter(function (poll) { return poll.className === pollClassFilter; });
      }

      if (pollSearchQuery) {
        var normalizedQuery = pollSearchQuery.toLowerCase();
        list = list.filter(function (poll) {
          return pollMatchesSearch(poll, normalizedQuery);
        });
      }

      list.sort(function (a, b) {
        switch (pollSortMode) {
          case 'updated_asc':
            return getPollTimestamp(a) - getPollTimestamp(b);
          case 'name_asc':
            return (a.pollName || '').localeCompare(b.pollName || '');
          case 'class_asc':
            var classCompare = (a.className || '').localeCompare(b.className || '');
            if (classCompare !== 0) return classCompare;
            return (a.pollName || '').localeCompare(b.pollName || '');
          case 'updated_desc':
          default:
            return getPollTimestamp(b) - getPollTimestamp(a);
        }
      });
      return list;
    }

    function getPollTimestamp(poll) {
      var value = poll && (poll.updatedAt || poll.lastRunAt || poll.createdAt || '');
      var time = value ? Date.parse(value) : NaN;
      return isNaN(time) ? 0 : time;
    }

    function refreshPollViews() {
      var polls = getFilteredSortedPolls();

      // Update Combobox Data
      if (pollCombobox) {
        var comboData = [];
        // Add Classes
        ALL_CLASSES.forEach(function (cls) {
          comboData.push({ label: cls, type: 'class', subLabel: 'Class' });
        });
        // Add Polls
        ALL_POLLS.forEach(function (poll) {
          comboData.push({ label: poll.pollName, type: 'poll', subLabel: poll.className });
        });
        pollCombobox.updateData(comboData);
      }

      try {
        renderPollCards(polls);
      } catch (e) {
        console.error("Error rendering poll cards:", e);
        if (pollsCardView) {
          pollsCardView.innerHTML = '<div class="col-span-full text-center p-8 text-red-500 bg-red-50 rounded-lg border border-red-200">System Error: Unable to render polls. Please refresh or contact support.</div>';
        }
      }
      try {
        renderPollTable(polls);
      } catch (e) {
        console.error("Error rendering poll table:", e);
      }
      updatePollDropdown(polls);
      if (pollsEmptyState) {
        if (polls.length === 0) {
          pollsEmptyState.classList.remove('hidden');
          var message = 'No polls found. Create your first poll to get started.';
          if (pollSearchQuery) {
            var safeQuery = escapeHtml(pollSearchQuery);
            message = 'No polls match ' + safeQuery + '. Try a different title or question keyword.';
          }
          // Use the new enhanced empty state structure
          var emptyStateTitle = pollsEmptyState.querySelector('h3');
          var emptyStateParagraph = pollsEmptyState.querySelector('p');
          if (pollSearchQuery) {
            if (emptyStateTitle) emptyStateTitle.textContent = 'No Polls Found';
            if (emptyStateParagraph) emptyStateParagraph.textContent = 'Your search for "' + safeQuery + '" did not return any results. Try different keywords.';
          } else {
            if (emptyStateTitle) emptyStateTitle.textContent = 'Welcome to Your Poll Library';
            if (emptyStateParagraph) emptyStateParagraph.textContent = 'This is where your polls will live. Create your first interactive poll to engage your students and gather real-time feedback.';
          }
        } else {
          pollsEmptyState.classList.add('hidden');
        }
      }
    }

    function startEditPoll(pollId, triggerButton) {
      if (!pollId) return;
      var button = triggerButton || null;
      var originalLabel = button ? button.innerHTML : '';
      if (button) {
        button.disabled = true;
        button.textContent = 'Loading...';
      }

      if (PREVIEW_MODE) {
        var previewPoll = ALL_POLLS.find(function (p) { return p.pollId === pollId; });
        if (button) {
          button.disabled = false;
          button.innerHTML = originalLabel;
        }
        if (previewPoll) {
          // Use unified wizard for editing
          openPollWizard(deepClone(previewPoll));
        } else {
          veritasAlert('Unable to locate this poll in preview mode.', { title: 'Edit poll' });
        }
        return;
      }

      // FIREBASE MIGRATION: Load Poll for Editing from RTDB
      // Ensures we get the latest version (Source of Truth)

      var db = firebase.database();
      db.ref('polls/' + pollId).once('value')
        .then(function (snapshot) {
          var poll = snapshot.val();
          if (button) {
            button.disabled = false;
            button.innerHTML = originalLabel;
          }
          if (poll) {
            // Determine if this is a legacy poll structure or migrated one.
            // Our unified wizard expects specific fields.
            // The GAS version likely did some transformation. 
            // Since we write the 'clean' structure in createNewPoll, we can use it directly.
            // Ensure pollId is present
            poll.pollId = pollId;
            openPollWizard(poll);
          } else {
            veritasAlert('Failed to load poll data (Not found).', { title: 'Error' });
          }
        })
        .catch(function (error) {
          if (button) {
            button.disabled = false;
            button.innerHTML = originalLabel;
          }
          handleError(error);
        });

      /* LEGACY GAS LOAD REMOVED
      google.script.run
        .withSuccessHandler(...)
        .getPollForEditing(pollId);
      */
    }

    function renderPollCards(polls) {
      if (!pollsCardView) {
        return;
      }

      pollsCardView.innerHTML = '';

      if (!polls || polls.length === 0) {
        return;
      }

      var renderErrors = 0;

      polls.forEach(function (poll) {
        try {
          if (!poll) return;
          var card = document.createElement('article');
          card.className = 'poll-card';
          if (poll && poll.pollId) {
            card.dataset.pollId = poll.pollId;
          }
          card.setAttribute('tabindex', '0');
          card.setAttribute('role', 'group');
          var safeName = escapeHtml(poll && poll.pollName ? poll.pollName : 'Untitled Poll');
          card.setAttribute('aria-label', 'Poll: ' + safeName);

          var className = escapeHtml(poll && poll.className ? poll.className : 'Unassigned');
          var questionCount = Array.isArray(poll && poll.questions) ? poll.questions.length : 0;
          var lastEdited = formatDateTime(poll.updatedAt || poll.lastRunAt || poll.createdAt);
          var sessionType = normalizeSessionTypeClient(poll.sessionType);

          var htmlParts = [];

          // Header with Title
          htmlParts.push('<div class="mb-4">');
          htmlParts.push('<h3 class="text-lg font-bold text-veritas-navy dark:text-white">' + safeName + '</h3>');
          htmlParts.push('</div>');

          // Meta Badges
          htmlParts.push('<div class="flex flex-wrap gap-2 mb-4">');
          // Session Type Badge
          var sessionTypeInfo = getSessionTypeInfo(sessionType);
          htmlParts.push('<span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full ' + sessionTypeInfo.badgeClass + '">');
          htmlParts.push('<span class="material-symbols-outlined text-sm">' + sessionTypeInfo.icon + '</span>');
          htmlParts.push(sessionTypeInfo.label);
          htmlParts.push('</span>');

          // Question Count Badge
          htmlParts.push('<span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">');
          htmlParts.push('<span class="material-symbols-outlined text-sm">quiz</span>');
          htmlParts.push(questionCount + ' Questions');
          htmlParts.push('</span>');

          htmlParts.push('</div>');

          if (sessionType === 'SECURE_ASSESSMENT') {
            var secureTimeLabel = describeSecureTimeLimit(poll);
            var secureAccessCode = getSecureAccessCode(poll);
            var secureWindowLabel = describeSecureAvailability(poll);
            htmlParts.push('<div class="rounded-xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-900 dark:border-rose-500/40 dark:bg-rose-500/10 dark:text-rose-100 mb-4">');
            if (secureTimeLabel) {
              htmlParts.push('<div class="flex items-center gap-2 mb-2"><span class="material-symbols-outlined text-base">timer</span><span>' + escapeHtml(secureTimeLabel) + '</span></div>');
            }
            htmlParts.push('<div class="flex items-center gap-2 mb-2"><span class="material-symbols-outlined text-base">key</span><span>Access Code: ');
            if (secureAccessCode) {
              htmlParts.push('<span class="font-semibold tracking-widest">' + escapeHtml(secureAccessCode) + '</span>');
            } else {
              htmlParts.push('<span class="opacity-80">Not required</span>');
            }
            htmlParts.push('</span></div>');
            if (secureWindowLabel) {
              htmlParts.push('<div class="flex items-center gap-2"><span class="material-symbols-outlined text-base">calendar_month</span><span>' + escapeHtml(secureWindowLabel) + '</span></div>');
            }
            htmlParts.push('</div>');
          }


          // Stats
          htmlParts.push('<div class="text-xs text-gray-500 dark:text-gray-400 mb-4">Last updated: ' + lastEdited + '</div>');

          // Actions
          htmlParts.push('<div class="flex gap-2 mt-auto">');
          htmlParts.push('<button type="button" class="flex-1 poll-card-btn primary poll-preview-btn" data-poll-id="' + (poll && poll.pollId ? poll.pollId : '') + '" aria-label="Preview ' + safeName + '"><span class="material-symbols-outlined text-base">visibility</span>Preview</button>');
          htmlParts.push('<button type="button" class="poll-card-btn secondary poll-edit-btn" data-poll-id="' + (poll && poll.pollId ? poll.pollId : '') + '" aria-label="Edit ' + safeName + '"><span class="material-symbols-outlined text-base">edit</span></button>');
          htmlParts.push('<button type="button" class="poll-card-btn info poll-copy-btn" data-poll-id="' + (poll && poll.pollId ? poll.pollId : '') + '" aria-label="Duplicate ' + safeName + '"><span class="material-symbols-outlined text-base">content_copy</span></button>');
          htmlParts.push('<button type="button" class="poll-card-btn danger poll-delete-btn" data-poll-id="' + (poll && poll.pollId ? poll.pollId : '') + '" aria-label="Delete ' + safeName + '"><span class="material-symbols-outlined text-base">delete</span></button>');
          htmlParts.push('</div>');

          card.innerHTML = htmlParts.join('');

          card.addEventListener('click', function (event) {
            if (event.target.closest('.poll-card-btn')) {
              return;
            }
            var pollId = this.dataset.pollId;
            if (!pollId) return;
            pollSelect.value = pollId;
            onPollSelectChange();
            showDashboard();
          });

          card.addEventListener('keydown', function (event) {
            if (event.target.closest('.poll-card-btn')) {
              return;
            }
            if (event.key === 'Enter' || event.key === ' ' || event.key === 'Spacebar') {
              event.preventDefault();
              var pollId = this.dataset.pollId;
              if (!pollId) return;
              pollSelect.value = pollId;
              onPollSelectChange();
              showDashboard();
            }
          });

          pollsCardView.appendChild(card);
        } catch (cardError) {
          console.error("Error rendering individual poll card:", cardError, poll);
          renderErrors++;
        }
      });

      if (renderErrors > 0 && pollsCardView.children.length === 0) {
        // If all failed, show a friendly error
        pollsCardView.innerHTML = '<div class="col-span-full text-center p-8 text-red-500 bg-red-50 rounded-lg border border-red-200">Unable to load polls due to a data error. Please contact support.</div>';
      }

      attachPollActionHandlers(pollsCardView);
    }

    function getSessionTypeInfo(sessionType) {
      var normalized = normalizeSessionTypeClient(sessionType);
      if (normalized === 'SECURE_ASSESSMENT') {
        return {
          label: 'Secure Assessment',
          icon: 'lock',
          badgeClass: 'bg-rose-100 text-rose-800 dark:bg-rose-900 dark:text-rose-200'
        };
      }
      return {
        label: 'Live Poll',
        icon: 'groups',
        badgeClass: 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200'
      };
    }

    function getSecureTimeLimitMinutes(poll) {
      if (!poll) return null;
      var direct = poll.timeLimitMinutes;
      if (typeof direct === 'number' && direct > 0) {
        return direct;
      }
      if (typeof direct === 'string' && direct.trim() !== '') {
        var parsed = parseInt(direct, 10);
        if (!isNaN(parsed) && parsed > 0) {
          return parsed;
        }
      }
      if (poll.secureSettings) {
        var fallback = poll.secureSettings.timeLimitMinutes;
        if (typeof fallback === 'number' && fallback > 0) {
          return fallback;
        }
        if (typeof fallback === 'string' && fallback.trim() !== '') {
          var parsedFallback = parseInt(fallback, 10);
          if (!isNaN(parsedFallback) && parsedFallback > 0) {
            return parsedFallback;
          }
        }
      }
      return null;
    }

    function describeSecureTimeLimit(poll) {
      var minutes = getSecureTimeLimitMinutes(poll);
      if (!minutes) {
        return '';
      }
      var unit = minutes === 1 ? 'minute' : 'minutes';
      return 'Time limit: ' + minutes + ' ' + unit;
    }

    function getSecureAccessCode(poll) {
      if (!poll) return '';
      if (poll.accessCode && poll.accessCode.toString().trim() !== '') {
        return poll.accessCode.toString().trim().toUpperCase();
      }
      if (poll.secureSettings && poll.secureSettings.accessCode) {
        return poll.secureSettings.accessCode.toString().trim().toUpperCase();
      }
      return '';
    }

    function getSecureAvailabilityWindow(poll) {
      if (!poll) return { availableFrom: '', dueBy: '' };
      var available = poll.availableFrom || '';
      var due = poll.dueBy || '';
      if (!available && poll.secureSettings) {
        available = poll.secureSettings.availableFrom || '';
      }
      if (!due && poll.secureSettings) {
        due = poll.secureSettings.dueBy || '';
      }
      return { availableFrom: available || '', dueBy: due || '' };
    }

    function describeSecureAvailability(poll) {
      var window = getSecureAvailabilityWindow(poll);
      var available = window.availableFrom;
      var due = window.dueBy;
      if (available && due) {
        return 'Window: ' + formatDateTime(available) + '  ' + formatDateTime(due);
      }
      if (available) {
        return 'Opens ' + formatDateTime(available);
      }
      if (due) {
        return 'Due ' + formatDateTime(due);
      }
      return '';
    }

    function buildSessionModeCellHtml(poll) {
      var sessionType = normalizeSessionTypeClient(poll.sessionType);
      var info = getSessionTypeInfo(sessionType);
      var html = '<div class="flex flex-col gap-1">';
      html += '<span class="inline-flex items-center gap-1.5 px-2 py-0.5 text-xs font-semibold rounded-full ' + info.badgeClass + '">';
      html += '<span class="material-symbols-outlined text-sm">' + info.icon + '</span>' + info.label + '</span>';
      if (sessionType === 'SECURE_ASSESSMENT') {
        var timeLabel = describeSecureTimeLimit(poll);
        var code = getSecureAccessCode(poll);
        if (timeLabel) {
          html += '<span class="text-xs text-rose-700 dark:text-rose-200">' + escapeHtml(timeLabel) + '</span>';
        }
        if (code) {
          html += '<span class="text-xs text-rose-700 dark:text-rose-200">Code: <span class="font-semibold tracking-widest">' + escapeHtml(code) + '</span></span>';
        } else {
          html += '<span class="text-xs text-rose-700/80 dark:text-rose-200/80">No access code</span>';
        }
      }
      html += '</div>';
      return html;
    }

    // Dropdown Management
    var activeDropdown = null;

    function closeActiveDropdown() {
      if (activeDropdown) {
        activeDropdown.remove();
        activeDropdown = null;
        document.removeEventListener('click', handleGlobalDropdownClick);
      }
    }

    function handleGlobalDropdownClick(e) {
      // If clicking inside the active dropdown, do nothing (let event bubble to button handlers)
      if (activeDropdown && activeDropdown.contains(e.target)) {
        return;
      }
      // If clicking the trigger button again, it's handled by the toggle logic, but we need to ensure we don't double-close/open
      // Actually, the trigger button click handler stops propagation, so this global listener only catches clicks *outside* or on *other* elements.
      closeActiveDropdown();
    }

    function togglePollDropdown(btn, pollId) {
      var existing = activeDropdown;
      closeActiveDropdown(); // Close any open one

      // If we clicked the same button that opened the current dropdown, we just close it (done above) and return
      if (existing && existing.dataset.triggerId === pollId) {
        return;
      }

      var rect = btn.getBoundingClientRect();
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      var scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

      var menu = document.createElement('div');
      menu.className = 'fixed z-[9999] w-52 rounded-xl border border-white/5 bg-gray-800 p-1 text-sm text-white shadow-lg transition duration-100 ease-out origin-top-right';
      menu.style.top = (rect.bottom + 5) + 'px';

      // Align right edge of menu with right edge of button
      var menuWidth = 208; // w-52 is 13rem = 208px
      var leftPos = rect.right - menuWidth;

      // Check if it goes off screen to the left
      if (leftPos < 10) {
        leftPos = rect.left; // Align left if no space on right
      }

      menu.style.left = leftPos + 'px';
      menu.dataset.triggerId = pollId;

      // Menu Items
      var items = [
        { label: 'Edit', icon: 'edit', action: 'edit', kbd: 'E' },
        { label: 'Duplicate', icon: 'content_copy', action: 'duplicate', kbd: 'D' },
        { label: 'Preview', icon: 'visibility', action: 'preview', kbd: 'P' },
        // Divider
        { type: 'divider' },
        // Delete
        { label: 'Delete', icon: 'delete', action: 'delete', kbd: 'Del', danger: true }
      ];

      items.forEach(function (item) {
        if (item.type === 'divider') {
          var div = document.createElement('div');
          div.className = 'my-1 h-px bg-white/5';
          menu.appendChild(div);
          return;
        }

        var btnItem = document.createElement('button');
        btnItem.className = 'group flex w-full items-center gap-2 rounded-lg px-3 py-1.5 hover:bg-white/10 text-left transition-colors ' + (item.danger ? 'text-red-400 hover:text-red-300' : 'text-white');

        var iconColorClass = item.danger ? 'text-red-400 group-hover:text-red-300' : 'text-white/60 group-hover:text-white';

        btnItem.innerHTML = `
        <span class="material-symbols-outlined text-base ${iconColorClass}">${item.icon}</span>
        <span>${item.label}</span>
        ${item.kbd ? `<kbd class="ml-auto hidden font-sans text-xs text-white/50 group-hover:inline">${item.kbd}</kbd>` : ''}
      `;

        btnItem.onclick = function (e) {
          e.stopPropagation(); // Prevent bubbling to global listener immediately
          handleDropdownAction(item.action, pollId);
          closeActiveDropdown();
        };
        menu.appendChild(btnItem);
      });

      document.body.appendChild(menu);
      activeDropdown = menu;

      // Delay adding the click listener to avoid immediate close from the trigger click bubbling
      requestAnimationFrame(function () {
        document.addEventListener('click', handleGlobalDropdownClick);
      });
    }

    function handleDropdownAction(action, pollId) {
      if (action === 'edit') startEditPoll(pollId);
      else if (action === 'duplicate') handleCopyPoll(pollId);
      else if (action === 'preview') openPollPreview(pollId);
      else if (action === 'delete') handleDeletePoll(pollId);
    }

    function renderPollTable(polls) {
      polls = polls || getFilteredSortedPolls();
      pollsTableBody.innerHTML = '';

      if (polls.length === 0) {
        return;
      }

      polls.forEach(function (poll) {
        try {
          if (!poll) return;
          var row = document.createElement('tr');
          row.className = 'hover:bg-brand-light-gray/40 dark:hover:bg-brand-dark-gray/40 transition-colors';
          var lastEdited = formatDateTime(poll.updatedAt || poll.lastRunAt || poll.createdAt);
          var createdLabel = poll.createdAt ? formatDateTime(poll.createdAt) : '';
          var htmlParts = [];
          htmlParts.push('<td class="px-4 py-3 align-top">');
          htmlParts.push('<div class="font-semibold text-brand-dark-gray dark:text-brand-white"><span class="poll-name-link cursor-pointer hover:text-primary dark:hover:text-primary transition-colors" data-poll-id="' + poll.pollId + '">' + escapeHtml(poll.pollName || 'Untitled Poll') + '</span></div>');
          htmlParts.push('<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/50">Created ' + createdLabel + '</div>');
          htmlParts.push('</td>');
          htmlParts.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">' + escapeHtml(poll.className || '') + '</td>');
          htmlParts.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">' + (poll.questions ? poll.questions.length : 0) + '</td>');
          htmlParts.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">' + buildSessionModeCellHtml(poll) + '</td>');
          htmlParts.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">' + lastEdited + '</td>');

          // Actions Column
          htmlParts.push('<td class="px-4 py-3 align-top text-right">');
          htmlParts.push('<div class="flex justify-end items-center gap-2">');

          // Primary Action: Select
          htmlParts.push('<button class="poll-select-btn h-8 px-3 rounded-md bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-xs font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors" data-poll-id="' + poll.pollId + '">Select</button>');

          // Options Dropdown Trigger
          htmlParts.push('<div class="relative inline-block text-left">');
          htmlParts.push('<button type="button" class="poll-options-btn inline-flex items-center gap-2 rounded-md bg-gray-800 px-3 py-1.5 text-xs font-semibold text-white shadow-inner shadow-white/10 hover:bg-gray-700 focus:outline-none transition-colors" data-poll-id="' + poll.pollId + '" aria-expanded="false" aria-haspopup="true">');
          htmlParts.push('Options');
          htmlParts.push('<span class="material-symbols-outlined text-base text-white/60">keyboard_arrow_down</span>');
          htmlParts.push('</button>');
          htmlParts.push('</div>');

          htmlParts.push('</div>');
          htmlParts.push('</td>');
          row.innerHTML = htmlParts.join('');
          pollsTableBody.appendChild(row);
        } catch (rowError) {
          console.error("Error rendering poll table row:", rowError, poll);
        }
      });

      attachPollActionHandlers(pollsTableBody);
    }

    async function handleCopyPoll(pollId) {
      var poll = ALL_POLLS.find(function (p) { return p.pollId === pollId; });
      if (!poll) return;

      var newName = await veritasPrompt('Enter a name for the copied poll:', {
        defaultValue: poll.pollName + ' (Copy)',
        title: 'Copy poll'
      });
      if (newName === null) return;

      newName = newName.trim();
      if (newName === '') {
        await veritasAlert('Poll name cannot be empty', { title: 'Copy poll' });
        return;
      }

      // Show loading state on UI if triggered from button, but here we might be from dropdown
      // We can show a global toast or similar, but for now rely on the modal handling

      if (PREVIEW_MODE) {
        setTimeout(async function () {
          var clone = deepClone(poll);
          clone.pollId = poll.pollId + '-copy-' + Date.now();
          clone.pollName = newName;
          clone.createdAt = new Date().toISOString();
          clone.updatedAt = clone.createdAt;
          ALL_POLLS.push(clone);
          refreshPollViews();
          await veritasAlert('Poll copied (preview data only).', { title: 'Poll copied' });
        }, 140);
        return;
      }

      // Since we don't have a button reference to disable easily (detached dropdown), use global loader or modal
      // Or just let it run. The user sees the modal close.

      // FIREBASE MIGRATION: Duplicate Poll in RTDB
      var clone = deepClone(poll);
      clone.pollName = newName;
      clone.createdAt = Date.now();
      clone.updatedAt = clone.createdAt;

      firebase.functions().httpsCallable('createPoll')({
        pollName: clone.pollName,
        className: clone.className,
        questions: clone.questions,
        sessionType: clone.sessionType || 'LIVE_POLL',
        timeLimitMinutes: clone.timeLimitMinutes || null,
        accessCode: clone.accessCode || '',
        availableFrom: clone.availableFrom || '',
        dueBy: clone.dueBy || '',
        secureSettings: clone.secureSettings || {}
      }).then(function (result) {
        if (result.data && result.data.success) {
          veritasAlert('Poll copied successfully.', { title: 'Success' });
        } else {
          throw new Error('Failed to copy poll');
        }
      }).catch(function (error) {
        handleError(error);
      });
    }

    async function handleDeletePoll(pollId) {
      var confirmed = await veritasConfirm('Delete this poll permanently? This will also remove all responses.', {
        title: 'Delete poll',
        confirmText: 'Delete',
        destructive: true
      });
      if (!confirmed) return;

      if (PREVIEW_MODE) {
        setTimeout(function () {
          ALL_POLLS = ALL_POLLS.filter(function (p) { return p.pollId !== pollId; });
          refreshPollViews();
          veritasAlert('Poll deleted (preview data only).', { title: 'Delete poll' });
        }, 120);
        return;
      }

      var db = firebase.database();
      var updates = {};
      updates['polls/' + pollId] = null;
      updates['answers/' + pollId] = null;
      updates['history/' + pollId] = null;
      updates['sessions/' + pollId] = null;

      db.ref().update(updates)
        .then(function () {
          veritasAlert('Poll deleted successfully.', { title: 'Success' });
        })
        .catch(function (error) {
          handleError(error);
        });
    }

    function attachPollActionHandlers(root) {
      if (!root) {
        return;
      }

      // 1. Select Button
      root.querySelectorAll('.poll-select-btn').forEach(function (btn) {
        btn.onclick = function (e) {
          e.stopPropagation();
          var id = this.dataset.pollId;
          if (id) {
            pollSelect.value = id;
            onPollSelectChange();
            showDashboard();
          }
        };
      });

      // 2. Options Dropdown Trigger
      root.querySelectorAll('.poll-options-btn').forEach(function (btn) {
        btn.onclick = function (e) {
          e.stopPropagation();
          var id = this.dataset.pollId;
          if (id) {
            togglePollDropdown(this, id);
          }
        };
      });

      // 3. Name Link (Clicks to Edit)
      root.querySelectorAll('.poll-name-link').forEach(function (link) {
        link.onclick = function (e) {
          e.preventDefault();
          e.stopPropagation();
          var id = this.dataset.pollId;
          if (id) {
            startEditPoll(id);
          }
        };
      });

      // 4. Card-specific action buttons
      root.querySelectorAll('.poll-copy-btn').forEach(function (btn) {
        btn.onclick = function (e) {
          e.stopPropagation();
          handleCopyPoll(this.dataset.pollId);
        };
      });

      root.querySelectorAll('.poll-edit-btn').forEach(function (btn) {
        btn.onclick = function (e) {
          e.stopPropagation();
          startEditPoll(this.dataset.pollId);
        };
      });

      root.querySelectorAll('.poll-preview-btn').forEach(function (btn) {
        btn.onclick = function (e) {
          e.stopPropagation();
          openPollPreview(this.dataset.pollId);
        };
      });

      root.querySelectorAll('.poll-delete-btn').forEach(function (btn) {
        btn.onclick = function (e) {
          e.stopPropagation();
          handleDeletePoll(this.dataset.pollId);
        };
      });
    }

    function refreshPollData(polls) {
      ALL_POLLS = polls || [];
      refreshClassOptions(BASE_CLASSES);
      refreshPollViews();
    }

    function onPollSelectChange() {
      var pollId = pollSelect.value;
      var selectedPoll = pollId ? ALL_POLLS.find(function (p) { return p.pollId === pollId; }) : null;
      var className = selectedPoll && selectedPoll.className ? selectedPoll.className : '';
      var hasSelection = !!selectedPoll;

      updateSessionLaunchControls(selectedPoll);
      updateSecureSessionMeta(selectedPoll);

      if (sendLinkBtn) {
        if (hasSelection && className) {
          sendLinkBtn.disabled = false;
          sendLinkBtn.removeAttribute('aria-disabled');
          sendLinkBtn.dataset.className = className;
        } else {
          setButtonLoading(sendLinkBtn, false);
          sendLinkBtn.disabled = true;
          sendLinkBtn.setAttribute('aria-disabled', 'true');
          delete sendLinkBtn.dataset.className;
        }
      }

      if (viewLinksBtn) {
        if (hasSelection && className) {
          viewLinksBtn.disabled = false;
          viewLinksBtn.removeAttribute('aria-disabled');
          viewLinksBtn.dataset.className = className;
        } else {
          setButtonLoading(viewLinksBtn, false);
          viewLinksBtn.disabled = true;
          viewLinksBtn.setAttribute('aria-disabled', 'true');
          delete viewLinksBtn.dataset.className;
        }
      }

      if (startPollBtn) {
        setButtonLoading(startPollBtn, false);
        startPollBtn.disabled = !hasSelection;
        if (startPollBtn.disabled) {
          startPollBtn.setAttribute('aria-disabled', 'true');
        } else {
          startPollBtn.removeAttribute('aria-disabled');
        }
      }
    }

    function updateSessionLaunchControls(selectedPoll) {
      if (!startPollBtn) {
        return;
      }
      var isSecure = selectedPoll ? isSecureSessionTypeClient(selectedPoll.sessionType) : false;
      var icon = isSecure ? 'rocket_launch' : 'play_circle';
      var label = isSecure ? 'Launch Exam Room' : 'Start Session';
      var defaultHtml = '<span class="material-symbols-outlined text-lg">' + icon + '</span><span>' + label + '</span>';
      startPollBtn.dataset.defaultHtml = defaultHtml;
      startPollBtn.dataset.sessionMode = isSecure ? 'secure' : 'live';
      startPollBtn.setAttribute('aria-label', label);
      startPollBtn.classList.remove('bg-veritas-gold', 'hover:bg-veritas-gold/90', 'bg-rose-600', 'hover:bg-rose-700');
      if (isSecure) {
        startPollBtn.classList.add('bg-rose-600', 'hover:bg-rose-700');
      } else {
        startPollBtn.classList.add('bg-veritas-gold', 'hover:bg-veritas-gold/90');
      }
      if (startPollBtn.getAttribute('aria-busy') === 'true') {
        return;
      }
      startPollBtn.innerHTML = defaultHtml;
    }

    function updateSecureSessionMeta(selectedPoll) {
      if (!secureSessionMeta) {
        return;
      }
      if (!selectedPoll || !isSecureSessionTypeClient(selectedPoll.sessionType)) {
        secureSessionMeta.classList.add('hidden');
        secureSessionMeta.setAttribute('aria-hidden', 'true');
        return;
      }

      secureSessionMeta.classList.remove('hidden');
      secureSessionMeta.setAttribute('aria-hidden', 'false');

      // Build inline metadata elements
      var metaItems = [];

      // Time limit
      var timeLabel = describeSecureTimeLimit(selectedPoll);
      if (timeLabel) {
        metaItems.push('<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm opacity-80">timer</span><span>' + escapeHtml(timeLabel) + '</span></span>');
      }

      // Access code
      var accessCode = getSecureAccessCode(selectedPoll);
      if (accessCode) {
        metaItems.push('<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm opacity-80">key</span><span>Code: <span class="font-semibold tracking-widest">' + escapeHtml(accessCode) + '</span></span></span>');
      } else {
        metaItems.push('<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm opacity-80">key</span><span class="opacity-70">No access code</span></span>');
      }

      var calculatorEnabled = selectedPoll.calculatorEnabled === true ||
        (selectedPoll.secureSettings && selectedPoll.secureSettings.calculatorEnabled === true);
      metaItems.push('<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm opacity-80">calculate</span><span>' + (calculatorEnabled ? 'Calculator enabled' : 'Calculator off') + '</span></span>');

      // Availability window
      var windowLabel = describeSecureAvailability(selectedPoll);
      if (windowLabel) {
        metaItems.push('<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm opacity-80">calendar_month</span><span>' + escapeHtml(windowLabel) + '</span></span>');
      }

      // Join with separators
      secureSessionMeta.innerHTML = metaItems.join('<span class="opacity-50">|</span>');
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // --- Roster Management ---
    function loadRosterData() {
      rosterStatus.textContent = 'Loading roster...';
      if (PREVIEW_MODE && PREVIEW_PAYLOAD) {
        setTimeout(function () {
          rosterStatus.textContent = '';
          onRosterDataLoaded({
            classes: deepClone(PREVIEW_PAYLOAD.classes || []),
            rosters: deepClone(PREVIEW_PAYLOAD.rosters || {})
          }, selectedRosterClass);
        }, 150);
        return;
      }

      // FIREBASE MIGRATION: Roster Management
      // We use the manageRoster Cloud Function to fetch all class and student data.

      firebase.functions().httpsCallable('manageRoster')({
        action: 'GET_DATA'
      }).then(function (result) {
        var data = result.data;
        rosterStatus.textContent = '';
        if (data && data.success) {
          console.log('[Firebase] Rosters loaded via Cloud Function');
          onRosterDataLoaded(data, selectedRosterClass);
        } else {
          throw new Error('Could not load roster data');
        }
      }).catch(function (error) {
        rosterStatus.textContent = '';
        console.error('[Firebase] Roster fetch error:', error);
        handleError(error);
      });
    }

    function onRosterDataLoaded(data, focusClass) {
      rosterDirty = false;
      rosterData = data && data.rosters ? data.rosters : {};
      refreshClassOptions((data && data.classes) || BASE_CLASSES);

      if (focusClass) {
        selectedRosterClass = focusClass;
      }

      if (selectedRosterClass && !rosterData[selectedRosterClass]) {
        selectedRosterClass = '';
      }

      renderRosterClassList();

      if (selectedRosterClass) {
        renderRosterTable();
      } else {
        rosterClassTitle.textContent = 'Select a class';
        rosterEmptyState.classList.remove('hidden');
        rosterTableWrapper.classList.add('hidden');
        renameClassBtn.classList.add('hidden');
        deleteClassBtn.classList.add('hidden');
        rosterStatus.textContent = '';
      }
    }

    function renderRosterClassList() {
      rosterClassList.innerHTML = '';
      if (ALL_CLASSES.length === 0) {
        rosterClassList.innerHTML = '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No classes yet. Click the + button to add one.</p>';
        return;
      }

      ALL_CLASSES.forEach(function (className) {
        var button = document.createElement('button');
        button.type = 'button';
        var isActive = className === selectedRosterClass;
        button.className = 'w-full text-left px-3 py-2 rounded-lg transition-colors ' + (isActive ? 'bg-primary text-brand-white shadow-sm' : 'bg-brand-light-gray/40 dark:bg-brand-dark-gray/30 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/60 dark:hover:bg-brand-dark-gray/50');
        button.textContent = className;
        button.onclick = function () {
          selectRosterClass(className);
        };
        rosterClassList.appendChild(button);
      });
    }

    function selectRosterClass(className) {
      selectedRosterClass = className;
      rosterDirty = false;
      rosterStatus.textContent = '';
      renderRosterClassList();
      renderRosterTable();
    }

    function renderRosterTable() {
      if (!selectedRosterClass) {
        return;
      }

      var entries = rosterData[selectedRosterClass] || [];
      rosterData[selectedRosterClass] = entries;

      if (entries.length === 0) {
        entries.push({ name: '', email: '' });
      }

      rosterClassTitle.textContent = selectedRosterClass;
      rosterEmptyState.classList.add('hidden');
      rosterTableWrapper.classList.remove('hidden');
      renameClassBtn.classList.remove('hidden');
      deleteClassBtn.classList.remove('hidden');

      rosterTableBody.innerHTML = '';
      entries.forEach(function (entry, index) {
        var row = document.createElement('tr');
        row.innerHTML =
          '<td class="px-4 py-2 align-top">' +
          '<input type="text" class="roster-name-input w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" data-index="' + index + '" placeholder="Student Name" value="' + escapeHtml(entry.name || '') + '" />' +
          '</td>' +
          '<td class="px-4 py-2 align-top">' +
          '<input type="email" class="roster-email-input w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" data-index="' + index + '" placeholder="email@example.com" value="' + escapeHtml(entry.email || '') + '" />' +
          '</td>' +
          '<td class="px-4 py-2 align-top text-center">' +
          '<button class="remove-roster-row-btn h-8 w-8 rounded-full bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors" data-index="' + index + '" title="Remove">' +
          '<span class="material-symbols-outlined text-base">close</span>' +
          '</button>' +
          '</td>';
        rosterTableBody.appendChild(row);
      });

      rosterTableBody.querySelectorAll('.roster-name-input').forEach(function (input) {
        input.oninput = function () {
          var idx = parseInt(this.dataset.index, 10);
          rosterData[selectedRosterClass][idx].name = this.value;
          markRosterDirty();
        };
      });

      rosterTableBody.querySelectorAll('.roster-email-input').forEach(function (input) {
        input.oninput = function () {
          var idx = parseInt(this.dataset.index, 10);
          rosterData[selectedRosterClass][idx].email = this.value;
          markRosterDirty();
        };
      });

      rosterTableBody.querySelectorAll('.remove-roster-row-btn').forEach(function (btn) {
        btn.onclick = function () {
          var idx = parseInt(this.dataset.index, 10);
          removeRosterRow(idx);
        };
      });
    }

    function markRosterDirty() {
      rosterDirty = true;
      rosterStatus.textContent = 'Unsaved changes';
    }

    async function addRosterRow() {
      if (!selectedRosterClass) {
        await veritasAlert('Select a class first.', { title: 'Roster' });
        return;
      }
      if (!rosterData[selectedRosterClass]) {
        rosterData[selectedRosterClass] = [];
      }
      rosterData[selectedRosterClass].push({ name: '', email: '' });
      markRosterDirty();
      renderRosterTable();
    }

    function removeRosterRow(index) {
      if (!selectedRosterClass) return;
      var entries = rosterData[selectedRosterClass] || [];
      if (entries.length > index) {
        entries.splice(index, 1);
        markRosterDirty();
        if (entries.length === 0) {
          entries.push({ name: '', email: '' });
        }
        renderRosterTable();
      }
    }

    async function saveRoster() {
      if (!selectedRosterClass) {
        await veritasAlert('Select a class to save.', { title: 'Roster' });
        return;
      }

      var entries = (rosterData[selectedRosterClass] || []).map(function (entry) {
        return {
          name: (entry.name || '').trim(),
          email: (entry.email || '').trim()
        };
      }).filter(function (entry) {
        return entry.name !== '' && entry.email !== '';
      });

      saveRosterBtn.disabled = true;
      rosterStatus.textContent = 'Saving roster...';

      if (PREVIEW_MODE) {
        setTimeout(function () {
          rosterData[selectedRosterClass] = entries;
          saveRosterBtn.disabled = false;
          rosterStatus.textContent = 'Roster saved (preview)';
          rosterDirty = false;
        }, 140);
        return;
      }

      // FIREBASE MIGRATION: Save Roster Class

      var db = firebase.database();

      // Update specific class path
      var updates = {};
      updates['rosters/rosters/' + selectedRosterClass] = entries;
      updates['rosters/updatedAt'] = firebase.database.ServerValue.TIMESTAMP;

      db.ref().update(updates)
        .then(function () {
          // Also ensure class is in the classes list
          db.ref('rosters/classes').transaction(function (classes) {
            if (!classes) return [selectedRosterClass];
            if (!classes.includes(selectedRosterClass)) {
              classes.push(selectedRosterClass);
            }
            return classes;
          });

          // Success response
          saveRosterBtn.disabled = false;
          rosterStatus.textContent = 'Roster saved.';
          rosterDirty = false;

          // Update local data cache
          if (!rosterData) rosterData = {};
          rosterData[selectedRosterClass] = entries;

          // Re-render (pass current data)
          onRosterDataLoaded({
            rosters: rosterData,
            classes: (window.currentClasses && window.currentClasses.includes(selectedRosterClass))
              ? window.currentClasses
              : (window.currentClasses || []).concat([selectedRosterClass])
          }, selectedRosterClass);
        })
        .catch(function (error) {
          saveRosterBtn.disabled = false;
          handleError(error);
        });
    }

    async function openBulkAddStudentsModal() {
      if (!selectedRosterClass) {
        await veritasAlert('Select a class first.', { title: 'Roster' });
        return;
      }
      document.getElementById('bulk-student-input').value = '';
      document.getElementById('bulk-add-students-modal').style.display = 'flex';
    }

    function closeBulkAddStudentsModal() {
      document.getElementById('bulk-add-students-modal').style.display = 'none';
    }

    async function confirmBulkAddStudents() {
      if (!selectedRosterClass) {
        await veritasAlert('Select a class first.', { title: 'Roster' });
        closeBulkAddStudentsModal();
        return;
      }

      var input = document.getElementById('bulk-student-input').value;
      var lines = input.split('\n');
      var entries = [];

      lines.forEach(function (line) {
        line = line.trim();
        if (line === '') return;

        // Parse format: Name, Email
        var parts = line.split(',');
        if (parts.length >= 2) {
          var name = parts[0].trim();
          var email = parts.slice(1).join(',').trim();
          if (name && email) {
            entries.push({ name: name, email: email });
          }
        }
      });

      if (entries.length === 0) {
        await veritasAlert('No valid student entries found. Use format: Name, Email', { title: 'Bulk add students' });
        return;
      }

      var confirmBtn = document.getElementById('confirm-bulk-add-btn');
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Adding...';

      if (PREVIEW_MODE) {
        setTimeout(async function () {
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Add Students';
          closeBulkAddStudentsModal();
          rosterData[selectedRosterClass] = (rosterData[selectedRosterClass] || []).concat(entries);
          rosterDirty = false;
          renderRosterTable();
          await veritasAlert('Students added (preview data only).', { title: 'Bulk add students' });
        }, 160);
        return;
      }

      var db = firebase.database();
      var rostersRef = db.ref('rosters');

      rostersRef.once('value').then(function (snapshot) {
        var data = snapshot.val() || { classes: [], rosters: {} };
        if (!data.rosters) data.rosters = {};

        var currentRoster = data.rosters[selectedRosterClass] || [];
        data.rosters[selectedRosterClass] = currentRoster.concat(entries);

        return rostersRef.set(data);
      }).then(function () {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Add Students';
        closeBulkAddStudentsModal();
        rosterDirty = false;

        // Re-load to sync UI
        loadRosterData();
        showToast('success', 'Students added', 'Successfully added ' + entries.length + ' students.');
      }).catch(function (error) {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Add Students';
        handleError(error);
      });
    }

    async function onAddClass() {
      var className = await veritasPrompt('Class name', { title: 'Add class', confirmText: 'Create' });
      if (!className) return;
      className = className.trim();
      if (className === '') return;
      rosterStatus.textContent = 'Creating class...';
      if (PREVIEW_MODE) {
        setTimeout(function () {
          rosterStatus.textContent = 'Class created (preview).';
          rosterData[className] = rosterData[className] || [];
          selectedRosterClass = className;
          onRosterDataLoaded({
            classes: deepClone(Object.keys(rosterData)),
            rosters: deepClone(rosterData)
          }, className);
        }, 120);
        return;
      }

      var db = firebase.database();
      var rostersRef = db.ref('rosters');

      rostersRef.once('value').then(function (snapshot) {
        var data = snapshot.val() || { classes: [], rosters: {} };
        if (!data.classes) data.classes = [];
        if (!data.rosters) data.rosters = {};

        if (!data.classes.includes(className)) {
          data.classes.push(className);
        }
        data.rosters[className] = data.rosters[className] || [];

        return rostersRef.set(data);
      }).then(function () {
        rosterStatus.textContent = 'Class created.';
        selectedRosterClass = className;
        loadRosterData();
      }).catch(function (error) {
        rosterStatus.textContent = '';
        handleError(error);
      });
    }

    async function onRenameClass() {
      if (!selectedRosterClass) {
        await veritasAlert('Select a class first.', { title: 'Roster' });
        return;
      }
      var newName = await veritasPrompt('Rename class', { title: 'Rename class', defaultValue: selectedRosterClass, confirmText: 'Rename' });
      if (!newName) return;
      newName = newName.trim();
      if (newName === '') { return; }
      if (newName === selectedRosterClass) return;
      rosterStatus.textContent = 'Renaming class...';
      if (PREVIEW_MODE) {
        setTimeout(function () {
          var existing = rosterData[selectedRosterClass] || [];
          delete rosterData[selectedRosterClass];
          rosterData[newName] = existing;
          rosterStatus.textContent = 'Class renamed (preview).';
          selectedRosterClass = newName;
          onRosterDataLoaded({
            classes: deepClone(Object.keys(rosterData)),
            rosters: deepClone(rosterData)
          }, newName);
        }, 140);
        return;
      }

      // Use manageRoster Cloud Function
      var manageRosterFn = firebase.functions().httpsCallable('manageRoster');
      manageRosterFn({
        action: 'RENAME',
        className: selectedRosterClass,
        newClassName: newName
      }).then(function (result) {
        if (result.data && result.data.success) {
          rosterStatus.textContent = 'Class renamed.';
          if (result.data.pollsUpdated > 0) {
            rosterStatus.textContent += ' (' + result.data.pollsUpdated + ' poll' + (result.data.pollsUpdated === 1 ? '' : 's') + ' updated)';
          }
          selectedRosterClass = newName;
          loadRosterData();
        } else {
          throw new Error(result.data?.error || 'Failed to rename class');
        }
      }).catch(function (error) {
        rosterStatus.textContent = '';
        if (typeof showUserFriendlyError === 'function') {
          showUserFriendlyError(error);
        } else {
          handleError(error);
        }
      });
    }

    async function onDeleteClass() {
      if (!selectedRosterClass) {
        await veritasAlert('Select a class first.', { title: 'Roster' });
        return;
      }
      var confirmed = await veritasConfirm('Delete class "' + selectedRosterClass + '" and remove all students?', {
        title: 'Delete class',
        confirmText: 'Delete',
        destructive: true
      });
      if (!confirmed) return;
      rosterStatus.textContent = 'Deleting class...';
      var classToDelete = selectedRosterClass;
      if (PREVIEW_MODE) {
        setTimeout(function () {
          delete rosterData[classToDelete];
          selectedRosterClass = '';
          rosterStatus.textContent = 'Class deleted (preview).';
          onRosterDataLoaded({
            classes: deepClone(Object.keys(rosterData)),
            rosters: deepClone(rosterData)
          }, '');
        }, 140);
        return;
      }

      // Use manageRoster Cloud Function
      var manageRosterFn = firebase.functions().httpsCallable('manageRoster');
      manageRosterFn({
        action: 'DELETE',
        className: classToDelete
      }).then(function (result) {
        if (result.data && result.data.success) {
          rosterStatus.textContent = 'Class deleted.';
          selectedRosterClass = '';
          loadRosterData();
        } else {
          throw new Error(result.data?.error || 'Failed to delete class');
        }
      }).catch(function (error) {
        rosterStatus.textContent = '';
        if (typeof showUserFriendlyError === 'function') {
          showUserFriendlyError(error);
        } else {
          handleError(error);
        }
      });
    }

    // --- Archived Polls ---
    function loadArchivedPolls(force) {
      if (archivedPolls.length > 0 && !force) {
        renderArchivedList();
        renderArchivedDetail();
        return;
      }

      archivedList.innerHTML = '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">Loading archived polls...</p>';
      archivedEmptyState.classList.remove('hidden');
      archivedDetail.classList.add('hidden');

      if (PREVIEW_MODE && PREVIEW_PAYLOAD) {
        setTimeout(function () {
          archivedPolls = deepClone(PREVIEW_PAYLOAD.archivedPolls || []);
          if (archivedPolls.length > 0) {
            selectedArchivedPollId = archivedPolls[0].pollId;
          } else {
            selectedArchivedPollId = '';
          }
          renderArchivedList();
          renderArchivedDetail();
        }, 150);
        return;
      }

      var db = firebase.database();
      var historyRef = db.ref('history');

      historyRef.once('value').then(function (snapshot) {
        var fbHistory = snapshot.val() || {};
        var flattened = [];

        // Flatten { pollId: { sessionId: payload } } to array [ payload ]
        Object.keys(fbHistory).forEach(function (pollId) {
          var sessions = fbHistory[pollId];
          Object.keys(sessions).forEach(function (sessionId) {
            var sessionData = sessions[sessionId];
            // Ensure it has required UI fields if missing from legacy entries
            sessionData.pollId = sessionData.pollId || pollId;
            sessionData.lastRunAt = sessionData.timestamp;
            flattened.push(sessionData);
          });
        });

        // Sort by timestamp descending
        flattened.sort(function (a, b) { return (b.timestamp || 0) - (a.timestamp || 0); });

        archivedPolls = flattened;
        if (archivedPolls.length > 0) {
          if (!archivedPolls.some(function (p) { return p.pollId === selectedArchivedPollId; })) {
            selectedArchivedPollId = archivedPolls[0].pollId;
          }
        } else {
          selectedArchivedPollId = '';
        }
        renderArchivedList();
        renderArchivedDetail();
      }).catch(handleError);
    }

    function renderArchivedList() {
      archivedList.innerHTML = '';
      var filtered = archivedClassFilter === 'all' ? archivedPolls : archivedPolls.filter(function (poll) { return poll.className === archivedClassFilter; });

      if (filtered.length === 0) {
        archivedList.innerHTML = '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No archived polls for this filter.</p>';
        archivedEmptyState.classList.remove('hidden');
        archivedDetail.classList.add('hidden');
        return;
      }

      filtered.forEach(function (poll) {
        var button = document.createElement('button');
        button.type = 'button';
        var isActive = poll.pollId === selectedArchivedPollId;
        button.className = 'w-full text-left px-3 py-2 rounded-lg transition-colors ' + (isActive ? 'bg-primary text-brand-white shadow-sm' : 'bg-brand-light-gray/40 dark:bg-brand-dark-gray/30 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/60 dark:hover:bg-brand-dark-gray/50');
        var metaText = (poll.className || 'Unassigned') + '  ' + formatDateTime(poll.lastRunAt || poll.updatedAt || poll.createdAt);
        button.innerHTML = '<div class="font-semibold">' + escapeHtml(poll.pollName || 'Untitled Poll') + '</div><div class="text-xs opacity-80">' + escapeHtml(metaText) + '</div>';
        button.onclick = function () {
          selectedArchivedPollId = poll.pollId;
          renderArchivedList();
          renderArchivedDetail();
        };
        archivedList.appendChild(button);
      });
    }

    function renderArchivedDetail() {
      var poll = archivedPolls.find(function (p) { return p.pollId === selectedArchivedPollId; });
      if (!poll) {
        archivedEmptyState.classList.remove('hidden');
        archivedDetail.classList.add('hidden');
        return;
      }

      archivedEmptyState.classList.add('hidden');
      archivedDetail.classList.remove('hidden');

      archivedPollTitle.textContent = poll.pollName || 'Untitled Poll';
      archivedPollMeta.textContent = (poll.className || 'Unassigned') + '  Last run ' + formatDateTime(poll.lastRunAt || poll.updatedAt || poll.createdAt);
      archivedQuestionCount.textContent = poll.questionCount || 0;
      archivedResponseCount.textContent = (poll.totalResponses || 0) + ' of ' + (poll.totalStudents || 0);

      archivedQuestionsContainer.innerHTML = '';
      poll.questions.forEach(function (question, index) {
        var card = document.createElement('div');
        card.className = 'border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-4 bg-brand-white dark:bg-brand-dark-gray/40';
        var summary = question.summary || { correct: 0, incorrect: 0, noResponse: 0, violations: 0 };
        var responses = Array.isArray(question.responses) ? question.responses : [];
        var nonResponders = Array.isArray(question.nonResponders) ? question.nonResponders : [];
        summary.correct = summary.correct || 0;
        summary.incorrect = summary.incorrect || 0;
        summary.noResponse = summary.noResponse || 0;
        summary.violations = summary.violations || 0;

        var responsesHtml = '';
        if (responses.length === 0) {
          responsesHtml = '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No responses recorded.</p>';
        } else {
          responsesHtml = '<table class="min-w-full text-sm divide-y divide-brand-light-gray dark:divide-brand-dark-gray/40"><thead class="text-xs uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/50"><tr><th class="py-2 text-left">Student</th><th class="py-2 text-left">Answer</th><th class="py-2 text-left">Status</th></tr></thead><tbody class="divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/40">';
          responses.forEach(function (response) {
            var status = response.violation ? 'Violation' : (response.isCorrect ? 'Correct' : 'Incorrect');
            var statusClass = response.violation ? 'text-orange-600 dark:text-orange-300' : (response.isCorrect ? 'text-green-600 dark:text-green-300' : 'text-red-600 dark:text-red-300');
            responsesHtml += '<tr><td class="py-2 pr-3">' + escapeHtml(response.name || response.email) + '</td><td class="py-2 pr-3">' + escapeHtml(response.answer || '') + '</td><td class="py-2 pr-3 ' + statusClass + '">' + status + '</td></tr>';
          });
          responsesHtml += '</tbody></table>';
        }

        var nonResponderHtml = '';
        if (nonResponders.length > 0) {
          nonResponderHtml = '<div class="mt-3"><h4 class="text-xs font-semibold uppercase text-brand-dark-gray/60 dark:text-brand-white/60">No Response</h4><div class="flex flex-wrap gap-2 mt-1">';
          nonResponders.forEach(function (student) {
            var chipClass = student.violation ? 'bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-200' : 'bg-brand-light-gray text-brand-dark-gray dark:bg-brand-dark-gray/50 dark:text-brand-white/80';
            var displayName = student.name ? formatStudentName(student) : student.email;
            nonResponderHtml += '<span class="px-2 py-1 rounded-full text-xs ' + chipClass + '">' + escapeHtml(displayName) + '</span>';
          });
          nonResponderHtml += '</div></div>';
        }

        var imageHtml = question.questionImageURL ? '<div class="mt-3"><img src="' + escapeHtml(question.questionImageURL) + '" class="max-h-48 rounded-lg object-contain" alt="Question image" /></div>' : '';
        var questionHtml = '<div><h3 class="font-serif text-lg text-brand-dark-gray dark:text-brand-white">Question ' + (index + 1) + '</h3><p class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 mt-1">' + escapeHtml(question.questionText || '') + '</p></div>';
        var summaryHtml = '<div class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 text-right">' +
          '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Correct:</span> ' + summary.correct + '</p>' +
          '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Incorrect:</span> ' + summary.incorrect + '</p>' +
          '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">No Response:</span> ' + summary.noResponse + '</p>' +
          '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Violations:</span> ' + summary.violations + '</p>' +
          '</div>';
        card.innerHTML = '<div class="flex flex-wrap items-start justify-between gap-3">' + questionHtml + summaryHtml + '</div>' + imageHtml + '<div class="mt-4">' + responsesHtml + '</div>' + nonResponderHtml;

        archivedQuestionsContainer.appendChild(card);
      });
    }

    // =============================================================================
    // POST-POLL ANALYTICS - PSYCHOMETRIC ANALYSIS
    // =============================================================================

    function openPostPollAnalytics(pollId) {
      var modal = document.getElementById('post-poll-analytics-modal');
      var loadingEl = document.getElementById('analytics-loading');
      var reportEl = document.getElementById('analytics-report');

      modal.style.display = 'flex';
      loadingEl.classList.remove('hidden');
      reportEl.classList.add('hidden');

      // google.script.run
      //   .withSuccessHandler(function (data) { ... })
      //   .getEnhancedPostPollAnalytics(pollId);

      const getAnalytics = firebase.functions().httpsCallable('getAnalytics');
      getAnalytics({ pollId: pollId })
        .then(function (result) {
          var data = result.data;
          if (data.success) {
            renderPostPollAnalytics(data);
          } else {
            loadingEl.innerHTML = '<div class="text-center py-12"><p class="text-red-600">Error: ' + escapeHtml(data.error || 'Failed to load analytics') + '</p></div>';
          }
        })
        .catch(function (error) {
          loadingEl.innerHTML = '<div class="text-center py-12"><p class="text-red-600">Error: ' + escapeHtml(error.message || 'Unknown error') + '</p></div>';
        });
    }

    function renderPostPollAnalytics(data) {
      var loadingEl = document.getElementById('analytics-loading');
      var reportEl = document.getElementById('analytics-report');

      // Update header
      document.getElementById('analytics-poll-name').textContent = data.pollName || 'Poll Analysis';
      document.getElementById('analytics-poll-meta').textContent = data.className + '  ' + data.questionCount + ' Questions';

      // Render Action Items
      if (data.teacherActionItems) {
        renderTeacherActionItems(data.teacherActionItems);
      }

      // Render Class Overview
      renderAnalyticsClassOverview(data.classOverview, data.distribution);

      // Render Metacognition (if enabled)
      if (data.metacognition && data.metacognition.enabled) {
        renderMetacognitionAnalysis(data.metacognition);
        document.getElementById('metacognition-section').classList.remove('hidden');
      } else {
        document.getElementById('metacognition-section').classList.add('hidden');
      }

      // Render Item Analysis
      renderItemAnalysis(data.itemAnalysis);

      loadingEl.classList.add('hidden');
      reportEl.classList.remove('hidden');
    }

    function renderTeacherActionItems(items) {
      var container = document.getElementById('analytics-actions-container');
      if (!container) return;

      if (!items || items.length === 0) {
        container.innerHTML = '';
        return;
      }

      var html = '<h4 class="text-lg font-bold text-brand-dark-gray dark:text-white mb-3 flex items-center gap-2">' +
        '<span class="material-symbols-outlined text-amber-500">lightbulb</span> Insights & Recommendations</h4>' +
        '<div class="grid grid-cols-1 gap-3">';

      items.forEach(function (item) {
        var borderClass = item.priority === 'urgent' ? 'border-red-200 bg-red-50 text-red-900' : 'border-amber-200 bg-amber-50 text-amber-900';
        var icon = item.priority === 'urgent' ? 'warning' : 'info';

        html += '<div class="flex items-start gap-3 p-4 rounded-lg border ' + borderClass + '">' +
          '<span class="material-symbols-outlined mt-0.5">' + icon + '</span>' +
          '<div><p class="font-semibold">' + escapeHtml(item.message) + '</p>';

        if (item.items && item.items.length > 0) {
          html += '<ul class="mt-2 text-sm list-disc list-inside opacity-90">';
          item.items.forEach(function (detail) {
            html += '<li>Q' + (detail.index + 1) + ': ' + escapeHtml(detail.text) + '</li>';
          });
          html += '</ul>';
        }

        html += '</div></div>';
      });

      html += '</div>';
      container.innerHTML = html;
    }

    function renderAnalyticsClassOverview(overview, distribution) {
      var container = document.getElementById('class-overview-content');
      var interp = overview.interpretation || {};

      var html = '<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">';

      // Mean
      html += '<div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700/30 rounded-lg p-4">';
      html += '<div class="text-sm text-blue-700 dark:text-blue-300 font-semibold mb-1">Mean Score</div>';
      html += '<div class="text-3xl font-bold text-blue-900 dark:text-blue-100">' + overview.mean + '</div>';
      if (interp.meanScore) {
        html += '<div class="mt-2 text-xs font-medium text-blue-800 dark:text-blue-200">' + escapeHtml(interp.meanScore.message) + '</div>';
      }
      html += '</div>';

      // Median
      html += '<div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700/30 rounded-lg p-4">';
      html += '<div class="text-sm text-green-700 dark:text-green-300 font-semibold mb-1">Median Score</div>';
      html += '<div class="text-3xl font-bold text-green-900 dark:text-green-100">' + overview.median + '</div>';
      html += '</div>';

      // Std Dev
      html += '<div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-700/30 rounded-lg p-4">';
      html += '<div class="text-sm text-purple-700 dark:text-purple-300 font-semibold mb-1">Std. Deviation</div>';
      html += '<div class="text-3xl font-bold text-purple-900 dark:text-purple-100">' + overview.stdDev + '</div>';
      if (interp.stdDev) {
        html += '<div class="mt-2 text-xs font-medium text-purple-800 dark:text-purple-200">' + escapeHtml(interp.stdDev.message) + '</div>';
      }
      html += '</div>';

      // Participation
      html += '<div class="bg-gray-50 dark:bg-gray-900/20 border border-gray-200 dark:border-gray-700/30 rounded-lg p-4">';
      html += '<div class="text-sm text-gray-700 dark:text-gray-300 font-semibold mb-1">Participants</div>';
      html += '<div class="text-3xl font-bold text-gray-900 dark:text-gray-100">' + overview.participantCount + '</div>';
      if (interp.participation) {
        html += '<div class="mt-2 text-xs font-medium text-gray-800 dark:text-gray-200">' + escapeHtml(interp.participation.message) + '</div>';
      }
      html += '</div>';
      html += '</div>';

      // Score distribution histogram
      if (distribution && distribution.histogram && distribution.histogram.length > 0) {
        html += '<div class="bg-white dark:bg-brand-dark-gray/40 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-4">';
        html += '<h4 class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white mb-3">Score Distribution</h4>';
        html += '<div class="flex items-end gap-2 h-48">';

        var maxCount = Math.max.apply(null, distribution.histogram.map(function (d) { return d.count; }));
        distribution.histogram.forEach(function (item) {
          var heightPct = maxCount > 0 ? (item.count / maxCount) * 100 : 0;
          html += '<div class="flex-1 flex flex-col items-center gap-1">';
          html += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">' + item.count + '</div>';
          html += '<div class="w-full bg-primary rounded-t" style="height: ' + heightPct + '%;"></div>';
          html += '<div class="text-xs font-semibold text-brand-dark-gray dark:text-brand-white">' + item.score + '</div>';
          html += '</div>';
        });
        html += '</div>';
        html += '</div>';
      }

      container.innerHTML = html;
    }

    function renderMetacognitionAnalysis(metacognition) {
      var container = document.getElementById('metacognition-content');

      if (!metacognition.overall) {
        container.innerHTML = '<p class="text-brand-dark-gray/60 dark:text-brand-white/60">No metacognition data available yet.</p>';
        return;
      }

      var html = '<div class="bg-white dark:bg-brand-dark-gray/40 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-6 mb-4">';
      html += '<h4 class="text-lg font-semibold text-brand-dark-gray dark:text-brand-white mb-4">Confidence vs. Correctness Matrix</h4>';
      html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';

      // Confident & Correct (Mastery)
      html += '<div class="bg-green-50 dark:bg-green-900/20 border-2 border-green-500 rounded-lg p-4">';
      html += '<div class="flex items-center gap-2 mb-2">';
      html += '<span class="text-2xl"></span>';
      html += '<div class="text-sm font-semibold text-green-700 dark:text-green-300">Conscious Competence</div>';
      html += '</div>';
      html += '<div class="text-3xl font-bold text-green-900 dark:text-green-100">' + metacognition.overall.confidentCorrect + '%</div>';
      html += '<div class="text-xs text-green-700 dark:text-green-300 mt-1">Confident & Correct (Mastery!)</div>';
      html += '</div>';

      // Confident & Incorrect (RED ALERT)
      html += '<div class="bg-red-50 dark:bg-red-900/20 border-2 border-red-500 rounded-lg p-4">';
      html += '<div class="flex items-center gap-2 mb-2">';
      html += '<span class="text-2xl"></span>';
      html += '<div class="text-sm font-semibold text-red-700 dark:text-red-300">Confidently Incorrect</div>';
      html += '</div>';
      html += '<div class="text-3xl font-bold text-red-900 dark:text-red-100">' + metacognition.overall.confidentIncorrect + '%</div>';
      html += '<div class="text-xs text-red-700 dark:text-red-300 mt-1">RED ALERT: Deep misconception!</div>';
      html += '</div>';

      // Uncertain & Correct (Lucky guess)
      html += '<div class="bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-500 rounded-lg p-4">';
      html += '<div class="flex items-center gap-2 mb-2">';
      html += '<span class="text-2xl"></span>';
      html += '<div class="text-sm font-semibold text-yellow-700 dark:text-yellow-300">Imposter Syndrome</div>';
      html += '</div>';
      html += '<div class="text-3xl font-bold text-yellow-900 dark:text-yellow-100">' + metacognition.overall.uncertainCorrect + '%</div>';
      html += '<div class="text-xs text-yellow-700 dark:text-yellow-300 mt-1">Uncertain but Correct (Lucky?)</div>';
      html += '</div>';

      // Uncertain & Incorrect (Conscious incompetence)
      html += '<div class="bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-500 rounded-lg p-4">';
      html += '<div class="flex items-center gap-2 mb-2">';
      html += '<span class="text-2xl"></span>';
      html += '<div class="text-sm font-semibold text-blue-700 dark:text-blue-300">Conscious Incompetence</div>';
      html += '</div>';
      html += '<div class="text-3xl font-bold text-blue-900 dark:text-blue-100">' + metacognition.overall.uncertainIncorrect + '%</div>';
      html += '<div class="text-xs text-blue-700 dark:text-blue-300 mt-1">Know they don\'t know (Good!)</div>';
      html += '</div>';

      html += '</div>';
      html += '</div>';

      container.innerHTML = html;
    }

    function renderItemAnalysis(items) {
      var container = document.getElementById('item-analysis-content');

      var html = '';
      items.forEach(function (item, index) {
        var difficultyColor = item.difficultyPct > 90 ? 'green' : item.difficultyPct < 30 ? 'red' : 'blue';
        var discColor = item.discrimination > 0.3 ? 'green' : item.discrimination < 0 ? 'red' : 'yellow';
        var interp = item.interpretation || {};

        html += '<div class="bg-white dark:bg-brand-dark-gray/40 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-5 mb-4">';
        html += '<div class="flex items-start justify-between gap-4 mb-4">';
        html += '<div class="flex-1">';
        html += '<div class="flex items-center gap-2">';
        html += '<h4 class="font-semibold text-brand-dark-gray dark:text-brand-white">Question ' + (index + 1) + '</h4>';

        // Quality Badge
        if (interp.overall) {
          var qBadgeColor = interp.overall.quality === 'excellent' ? 'bg-green-100 text-green-800' :
            interp.overall.quality === 'flawed' ? 'bg-red-100 text-red-800' :
              interp.overall.quality === 'needs-adjustment' ? 'bg-orange-100 text-orange-800' :
                'bg-gray-100 text-gray-800';
          html += '<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ' + qBadgeColor + '">' + escapeHtml(interp.overall.quality) + '</span>';
        }
        html += '</div>';

        html += '<p class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 mt-1">' + escapeHtml(item.questionText) + '</p>';
        html += '</div>';

        // Metrics
        html += '<div class="flex gap-3">';
        html += '<div class="text-center">';
        html += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mb-1">Difficulty</div>';
        html += '<div class="text-2xl font-bold text-' + difficultyColor + '-600 dark:text-' + difficultyColor + '-400">' + item.difficultyPct + '%</div>';
        if (interp.difficulty) {
          html += '<div class="text-[10px] text-gray-500">' + escapeHtml(interp.difficulty.level) + '</div>';
        }
        html += '</div>';
        html += '<div class="text-center">';
        html += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mb-1">Discrimination</div>';
        html += '<div class="text-2xl font-bold text-' + discColor + '-600 dark:text-' + discColor + '-400">' + item.discrimination + '</div>';
        if (interp.discrimination) {
          html += '<div class="text-[10px] text-gray-500">' + escapeHtml(interp.discrimination.level) + '</div>';
        }
        html += '</div>';
        html += '</div>';
        html += '</div>';

        // Flags
        if (item.flags && item.flags.length > 0) {
          html += '<div class="flex flex-wrap gap-2 mb-3">';
          item.flags.forEach(function (flag) {
            var flagClass = flag === 'negative-discrimination' ? 'bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300' :
              flag === 'too-hard' ? 'bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-300' :
                'bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-300';
            html += '<span class="px-2 py-1 rounded-full text-xs font-semibold ' + flagClass + '">' + flag.replace(/-/g, ' ') + '</span>';
          });
          html += '</div>';
        }

        // Actionable Insights
        if (interp.actionable && interp.actionable.length > 0) {
          html += '<div class="mt-3 p-3 bg-amber-50 dark:bg-amber-900/10 border border-amber-100 dark:border-amber-800/30 rounded text-sm text-amber-800 dark:text-amber-200">';
          html += '<p class="font-semibold text-xs uppercase tracking-wide mb-1">Recommendation:</p>';
          html += '<ul class="list-disc list-inside space-y-1">';
          interp.actionable.forEach(function (insight) {
            html += '<li>' + escapeHtml(insight) + '</li>';
          });
          html += '</ul></div>';
        }

        // Distractor Analysis
        if (item.distractorAnalysis && item.distractorAnalysis.length > 0) {
          html += '<div class="bg-gray-50 dark:bg-brand-dark-gray/20 rounded-lg p-3">';
          html += '<h5 class="text-xs font-semibold uppercase text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">Distractor Analysis</h5>';
          html += '<div class="space-y-2">';

          item.distractorAnalysis.forEach(function (dist) {
            var qualityColor = dist.quality === 'excellent' || dist.quality === 'good' ? 'green' :
              dist.quality === 'problematic' ? 'red' : 'gray';

            html += '<div class="flex items-center justify-between text-sm">';
            html += '<div class="flex items-center gap-2">';
            html += '<span class="font-semibold text-brand-dark-gray dark:text-brand-white">' + dist.optionLetter + '</span>';
            html += '<span class="text-brand-dark-gray/70 dark:text-brand-white/70">' + escapeHtml(dist.option.substring(0, 50)) + (dist.option.length > 50 ? '...' : '') + '</span>';
            if (dist.isCorrect) {
              html += '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300">Correct</span>';
            }
            html += '</div>';
            html += '<div class="flex items-center gap-3">';
            html += '<span class="text-brand-dark-gray/60 dark:text-brand-white/60">' + dist.totalPct + '%</span>';
            html += '<span class="text-xs text-' + qualityColor + '-600 dark:text-' + qualityColor + '-400">' + dist.quality + '</span>';
            html += '</div>';
            html += '</div>';
          });

          html += '</div>';
          html += '</div>';
        }

        html += '</div>';
      });

      container.innerHTML = html;
    }

    // =============================================================================
    // ANALYTICS HUB - CLIENT-SIDE CODE
    // =============================================================================

    var analyticsData = null;
    var analyticsCurrentTab = 'overview';
    var analyticsFilters = { className: 'all' };
    var analyticsItemsSort = { field: 'qNum', direction: 'asc' };
    var analyticsSelectedStudent = null;

    function showAnalyticsView() {
      clearLiveIntervals();
      headerDefault.style.display = 'flex';
      headerLive.style.display = 'none';
      setMainSection('analytics');

      // Populate class filter
      var analyticsClassFilter = document.getElementById('analytics-class-filter');
      analyticsClassFilter.innerHTML = '<option value="all">All Classes</option>';
      var classes = Array.from(new Set(ALL_POLLS.map(function (p) { return p.className; })));
      classes.forEach(function (className) {
        var opt = document.createElement('option');
        opt.value = className;
        opt.textContent = className;
        analyticsClassFilter.appendChild(opt);
      });

      if (!analyticsData) {
        loadAnalytics();
      } else {
        renderAnalyticsByTab();
      }

      // Start auto-refresh every 30 seconds
      if (analyticsRefreshInterval) {
        clearInterval(analyticsRefreshInterval);
      }
      analyticsRefreshInterval = setInterval(function () {
        // Silently refresh in the background
        analyticsData = null; // Clear cache
        loadAnalytics(analyticsFilters);
      }, 30000); // 30 seconds
    }

    function loadAnalytics(filters) {
      analyticsFilters = filters || analyticsFilters;

      // Show loading states
      document.getElementById('analytics-overview-loading').classList.remove('hidden');
      document.getElementById('analytics-overview-content').classList.add('hidden');
      document.getElementById('analytics-items-loading').classList.remove('hidden');
      document.getElementById('analytics-items-content').classList.add('hidden');
      document.getElementById('analytics-students-loading').classList.remove('hidden');
      document.getElementById('analytics-students-content').classList.add('hidden');

      if (PREVIEW_MODE && PREVIEW_PAYLOAD) {
        setTimeout(function () {
          analyticsData = deepClone(PREVIEW_PAYLOAD.analytics || {});
          document.getElementById('analytics-overview-loading').classList.add('hidden');
          document.getElementById('analytics-items-loading').classList.add('hidden');
          document.getElementById('analytics-students-loading').classList.add('hidden');
          renderAnalyticsByTab();
        }, 160);
        return;
      }

      const getAnalytics = firebase.functions().httpsCallable('getAnalytics');
      getAnalytics(analyticsFilters)
        .then(function (result) {
          analyticsData = result.data;
          // Clear loading states
          document.getElementById('analytics-overview-loading').classList.add('hidden');
          document.getElementById('analytics-items-loading').classList.add('hidden');
          document.getElementById('analytics-students-loading').classList.add('hidden');
          renderAnalyticsByTab();
        })
        .catch(function (error) {
          console.error('Analytics loading error:', error);
          // Show error states
          document.getElementById('analytics-overview-loading').innerHTML = '<p class="text-red-600">Error loading analytics: ' + escapeHtml(error.message || 'Unknown error') + '</p>';
          document.getElementById('analytics-items-loading').innerHTML = '<p class="text-red-600">Error loading analytics: ' + escapeHtml(error.message || 'Unknown error') + '</p>';
          document.getElementById('analytics-students-loading').innerHTML = '<p class="text-red-600">Error loading analytics: ' + escapeHtml(error.message || 'Unknown error') + '</p>';
        });
    }

    function renderAnalyticsByTab() {
      if (analyticsCurrentTab === 'overview') {
        renderAnalyticsOverview();
      } else if (analyticsCurrentTab === 'items') {
        renderAnalyticsItems();
      } else if (analyticsCurrentTab === 'students') {
        renderAnalyticsStudents();
      }
    }

    // --- Overview Tab ---
    function renderAnalyticsOverview() {
      document.getElementById('analytics-overview-loading').classList.add('hidden');
      document.getElementById('analytics-overview-content').classList.remove('hidden');

      if (!analyticsData) return;

      // Render KPIs
      var kpiContainer = document.getElementById('analytics-kpi-container');
      kpiContainer.innerHTML = '';

      (analyticsData.kpis || []).forEach(function (kpi) {
        var card = document.createElement('div');
        card.className = 'bg-brand-white dark:bg-brand-dark-gray/40 rounded-xl p-5 border border-brand-light-gray dark:border-brand-dark-gray/40 shadow-sm hover:shadow-md transition-shadow cursor-pointer';
        card.title = kpi.tooltip;

        var deltaHtml = '';
        if (kpi.delta !== undefined && kpi.delta !== null) {
          var deltaColor = kpi.delta >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
          var deltaIcon = kpi.delta >= 0 ? '' : '';
          deltaHtml = '<div class="text-xs font-semibold ' + deltaColor + ' mt-1">' + deltaIcon + ' ' + Math.abs(kpi.delta) + '</div>';
        }

        card.innerHTML = '<div class="text-xs font-semibold uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">' +
          escapeHtml(kpi.label) + '</div>' +
          '<div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">' +
          escapeHtml(kpi.value) + '</div>' + deltaHtml;

        kpiContainer.appendChild(card);
      });

      // Render Topic Heat (simplified version)
      var topicHeat = document.getElementById('analytics-topic-heat');
      if (!topicHeat) {
        return;
      }
      if (analyticsData.topics && analyticsData.topics.length > 0) {
        var topicHtml = '<div class="space-y-2">';
        analyticsData.topics.forEach(function (topic) {
          var color = topic.masteryPct >= 70 ? 'bg-green-500' : topic.masteryPct >= 50 ? 'bg-yellow-500' : 'bg-red-500';
          topicHtml += '<div class="flex items-center gap-3">';
          topicHtml += '<div class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white min-w-[120px]">' + escapeHtml(topic.topic) + '</div>';
          topicHtml += '<div class="flex-1 bg-brand-light-gray dark:bg-brand-dark-gray/30 rounded-full h-6 overflow-hidden">';
          topicHtml += '<div class="' + color + ' h-full flex items-center justify-end px-2 text-xs text-white font-semibold" style="width: ' + topic.masteryPct + '%">';
          if (topic.masteryPct > 15) topicHtml += topic.masteryPct + '%';
          topicHtml += '</div></div>';
          topicHtml += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 min-w-[60px] text-right">' + topic.questionCount + ' items</div>';
          topicHtml += '</div>';
        });
        topicHtml += '</div>';
        topicHeat.innerHTML = topicHtml;
      } else {
        topicHeat.innerHTML = '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No topic data available. Add topic tags to your questions.</p>';
      }

      // Render Item Scatter (simplified - using Google Charts)
      var scatterHost = document.getElementById('analytics-item-scatter');
      if (!scatterHost) {
        return;
      }
      if (!analyticsData.items || analyticsData.items.length === 0) {
        scatterHost.innerHTML = '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No item data available</p>';
      } else if (googleChartsReady && window.google && google.visualization && typeof google.visualization.ScatterChart === 'function') {
        var scatterData = [['Difficulty (% Correct)', 'Discrimination', 'Question']];
        analyticsData.items.forEach(function (item) {
          scatterData.push([item.correctPct, item.rbis, 'Q' + item.qNum]);
        });

        var data = google.visualization.arrayToDataTable(scatterData);
        var options = {
          title: 'Item Difficulty vs Discrimination',
          hAxis: { title: 'Difficulty (% Correct)', minValue: 0, maxValue: 100 },
          vAxis: { title: 'Discrimination (r_bis)', minValue: -0.5, maxValue: 1.0 },
          legend: 'none',
          pointSize: 5,
          backgroundColor: 'transparent',
          chartArea: { width: '85%', height: '75%' }
        };

        var chart = new google.visualization.ScatterChart(scatterHost);
        chart.draw(data, options);
      } else {
        scatterHost.innerHTML = '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">Preparing analytics visuals</p>';
      }
    }

    // --- Items Tab ---
    function renderAnalyticsItems() {
      document.getElementById('analytics-items-loading').classList.add('hidden');
      document.getElementById('analytics-items-content').classList.remove('hidden');

      if (!analyticsData || !analyticsData.items) return;

      var items = analyticsData.items.slice();

      // Sort items
      items.sort(function (a, b) {
        var aVal = a[analyticsItemsSort.field];
        var bVal = b[analyticsItemsSort.field];
        if (typeof aVal === 'number' && typeof bVal === 'number') {
          return analyticsItemsSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
        }
        var aStr = String(aVal || '');
        var bStr = String(bVal || '');
        return analyticsItemsSort.direction === 'asc'
          ? aStr.localeCompare(bStr)
          : bStr.localeCompare(aStr);
      });

      var tbody = document.getElementById('analytics-items-tbody');
      tbody.innerHTML = '';

      items.forEach(function (item) {
        var row = document.createElement('tr');
        row.className = 'hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30 cursor-pointer';

        // Q#
        var qNumCell = document.createElement('td');
        qNumCell.className = 'py-3 px-4 font-semibold';
        qNumCell.textContent = item.qNum;
        row.appendChild(qNumCell);

        // Topic
        var topicCell = document.createElement('td');
        topicCell.className = 'py-3 px-4 text-xs';
        topicCell.textContent = item.topic || 'Untagged';
        row.appendChild(topicCell);

        // Correct%
        var correctCell = document.createElement('td');
        correctCell.className = 'py-3 px-4 font-semibold';
        var correctColor = item.correctPct >= 70 ? 'text-green-600 dark:text-green-400' :
          item.correctPct >= 50 ? 'text-yellow-600 dark:text-yellow-400' :
            'text-red-600 dark:text-red-400';
        correctCell.innerHTML = '<span class="' + correctColor + '">' + item.correctPct + '%</span>';
        row.appendChild(correctCell);

        // Discrimination
        var discCell = document.createElement('td');
        discCell.className = 'py-3 px-4 font-semibold';
        var discColor = item.rbis >= 0.3 ? 'text-green-600 dark:text-green-400' :
          item.rbis >= 0.15 ? 'text-yellow-600 dark:text-yellow-400' :
            'text-red-600 dark:text-red-400';
        discCell.innerHTML = '<span class="' + discColor + '">' + item.rbis.toFixed(2) + '</span>';
        row.appendChild(discCell);

        // Choices (inline bar)
        var choicesCell = document.createElement('td');
        choicesCell.className = 'py-3 px-4';
        choicesCell.innerHTML = renderChoiceBar(item);
        row.appendChild(choicesCell);

        // Time
        var timeCell = document.createElement('td');
        timeCell.className = 'py-3 px-4';
        timeCell.textContent = item.medianTimeSec + 's';
        row.appendChild(timeCell);

        // Flags
        var flagsCell = document.createElement('td');
        flagsCell.className = 'py-3 px-4';
        if (item.flags && item.flags.length > 0) {
          var flagsHtml = '';
          item.flags.forEach(function (flag) {
            var flagColor = 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300';
            if (flag === 'low-disc') flagColor = 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300';
            flagsHtml += '<span class="inline-block px-2 py-0.5 rounded text-xs font-semibold ' + flagColor + ' mr-1">' + escapeHtml(flag) + '</span>';
          });
          flagsCell.innerHTML = flagsHtml;
        }
        row.appendChild(flagsCell);

        tbody.appendChild(row);
      });
    }

    function renderChoiceBar(item) {
      var total = item.total || 1;
      var choices = ['A', 'B', 'C', 'D'];
      var colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
      var html = '<div class="flex items-center gap-1 text-xs">';

      choices.forEach(function (choice, idx) {
        var count = item.choiceCounts[choice] || 0;
        var pct = (count / total * 100).toFixed(0);
        var isCorrect = idx === item.correctIndex;
        var borderStyle = isCorrect ? 'border-2 border-brand-dark-gray dark:border-brand-white' : '';

        if (count > 0) {
          html += '<div class="flex items-center gap-0.5">';
          html += '<span class="font-semibold">' + choice + '</span>';
          html += '<div class="h-4 rounded ' + borderStyle + '" style="width: ' + (pct * 0.8) + 'px; background-color: ' + colors[idx] + '; opacity: 0.7;"></div>';
          html += '<span class="text-brand-dark-gray/60 dark:text-brand-white/60">' + pct + '%</span>';
          html += '</div>';
        }
      });

      html += '</div>';
      return html;
    }

    // --- Students Tab ---
    // --- Student Insights (2025 Enhancement) ---
    var currentStudentInsights = null;
    var filteredStudentInsights = [];
    var studentInsightsFilter = null;
    var studentInsightsSortBy = 'name';
    var studentInsightsSortAsc = true;

    function showStudentInsightsError(message) {
      // Display error message in the student insights container
      var container = document.getElementById('student-insights-content');
      if (container) {
        container.innerHTML = '<div class="flex items-center justify-center p-12 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700/30 rounded-lg">' +
          '<div class="text-center">' +
          '<span class="material-symbols-outlined text-5xl text-red-600 dark:text-red-400 mb-4">error</span>' +
          '<p class="text-red-800 dark:text-red-200 text-lg font-semibold mb-2">Failed to Load Student Insights</p>' +
          '<p class="text-red-600 dark:text-red-300 text-sm">' + escapeHtml(message) + '</p>' +
          '<button onclick="loadStudentInsights()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Retry</button>' +
          '</div>' +
          '</div>';
      }
      // Also show a toast notification
      showToast('error', 'Error', message, 5000);
    }

    function loadStudentInsights() {
      // Get current class filter
      var className = analyticsFilters && analyticsFilters.className ? analyticsFilters.className : 'all';
      var dateFrom = analyticsFilters && analyticsFilters.dateFrom ? analyticsFilters.dateFrom : null;
      var dateTo = analyticsFilters && analyticsFilters.dateTo ? analyticsFilters.dateTo : null;

      const getAnalytics = firebase.functions().httpsCallable('getAnalytics');
      getAnalytics({ className: className }) // Simplified for now
        .then(function (result) {
          var data = result.data;
          if (data && data.success) {
            currentStudentInsights = data;
            filteredStudentInsights = data.students || [];
            renderStudentInsights();
          } else {
            var errorMsg = data && data.error ? data.error : 'Failed to load insights';
            showStudentInsightsError(errorMsg);
          }
        })
        .catch(function (error) {
          showStudentInsightsError(error.message || 'Unknown error');
        });
    }

    function renderStudentInsights() {
      if (!currentStudentInsights) return;

      var stats = currentStudentInsights.classStats;

      // Update insight counts
      document.getElementById('struggling-count').textContent = stats.strugglingCount || 0;
      document.getElementById('non-responder-count').textContent = stats.nonResponderCount || 0;
      document.getElementById('rule-violator-count').textContent = stats.ruleViolatorCount || 0;
      document.getElementById('high-performer-count').textContent = stats.highPerformerCount || 0;

      // Render student table
      renderStudentInsightsTable();
    }

    function renderStudentInsightsTable() {
      var tbody = document.getElementById('student-insights-table-body');
      if (!tbody) return;

      // Apply current filter
      var displayStudents = filteredStudentInsights;

      // Sort students
      displayStudents.sort(function (a, b) {
        var aVal, bVal;
        switch (studentInsightsSortBy) {
          case 'name':
            aVal = a.name || a.email;
            bVal = b.name || b.email;
            break;
          case 'accuracy':
            aVal = a.accuracy;
            bVal = b.accuracy;
            break;
          case 'participation':
            aVal = a.participationRate;
            bVal = b.participationRate;
            break;
          case 'violations':
            aVal = a.violations.length;
            bVal = b.violations.length;
            break;
          default:
            return 0;
        }

        if (aVal < bVal) return studentInsightsSortAsc ? -1 : 1;
        if (aVal > bVal) return studentInsightsSortAsc ? 1 : -1;
        return 0;
      });

      // Render rows
      var html = '';
      displayStudents.forEach(function (student) {
        var accuracyColor = student.accuracy >= 85 ? 'text-green-600 dark:text-green-400' :
          student.accuracy >= 70 ? 'text-blue-600 dark:text-blue-400' :
            student.accuracy >= 50 ? 'text-yellow-600 dark:text-yellow-400' :
              'text-red-600 dark:text-red-400';

        var participationColor = student.participationRate >= 90 ? 'text-green-600 dark:text-green-400' :
          student.participationRate >= 75 ? 'text-blue-600 dark:text-blue-400' :
            student.participationRate >= 50 ? 'text-yellow-600 dark:text-yellow-400' :
              'text-red-600 dark:text-red-400';

        var violationsColor = student.violations.length === 0 ? 'text-green-600 dark:text-green-400' :
          student.violations.length === 1 ? 'text-yellow-600 dark:text-yellow-400' :
            'text-red-600 dark:text-red-400';

        var flagsHtml = '';
        student.flags.forEach(function (flag) {
          var flagClass = '';
          var flagText = '';
          switch (flag) {
            case 'struggling':
              flagClass = 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300';
              flagText = 'Struggling';
              break;
            case 'non-responder':
              flagClass = 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300';
              flagText = 'Non-Responder';
              break;
            case 'rule-violator':
              flagClass = 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300';
              flagText = 'Rule Violator';
              break;
            case 'high-performer':
              flagClass = 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300';
              flagText = 'High Performer';
              break;
            case 'consistent':
              flagClass = 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300';
              flagText = 'Consistent';
              break;
          }
          flagsHtml += '<span class="' + flagClass + ' px-2 py-0.5 rounded text-xs font-semibold mr-1">' + flagText + '</span>';
        });

        html += '<tr class="border-t border-brand-light-gray dark:border-brand-dark-gray/40 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30 transition-colors">';
        html += '<td class="px-4 py-3 text-sm font-medium text-brand-dark-gray dark:text-brand-white">' + escapeHtml(formatStudentName(student)) + '</td>';
        html += '<td class="px-4 py-3 text-center"><span class="text-sm font-semibold ' + accuracyColor + '">' + Math.round(student.accuracy) + '%</span><br><span class="text-xs text-brand-dark-gray/50 dark:text-brand-white/50">' + student.correctAnswers + '/' + (student.correctAnswers + student.incorrectAnswers) + '</span></td>';
        html += '<td class="px-4 py-3 text-center"><span class="text-sm font-semibold ' + participationColor + '">' + Math.round(student.participationRate) + '%</span><br><span class="text-xs text-brand-dark-gray/50 dark:text-brand-white/50">' + student.questionsAnswered + '/' + student.totalQuestions + '</span></td>';
        html += '<td class="px-4 py-3 text-center text-sm font-semibold ' + violationsColor + '">' + student.violations.length + '</td>';
        html += '<td class="px-4 py-3 text-sm">' + flagsHtml + '</td>';
        html += '</tr>';
      });

      tbody.innerHTML = html || '<tr><td colspan="5" class="px-4 py-8 text-center text-brand-dark-gray/60 dark:text-brand-white/60">No students found</td></tr>';
    }

    function filterStudentsByFlag(flag) {
      if (!currentStudentInsights) return;

      studentInsightsFilter = flag;
      filteredStudentInsights = currentStudentInsights.students.filter(function (s) {
        return s.flags.includes(flag);
      });

      // Show filter badge and clear button
      var badge = document.getElementById('student-insights-filter-badge');
      var clearBtn = document.getElementById('clear-student-filter-btn');
      badge.textContent = flag.replace('-', ' ').toUpperCase();
      badge.classList.remove('hidden');
      clearBtn.classList.remove('hidden');

      renderStudentInsightsTable();
    }

    function clearStudentFilter() {
      if (!currentStudentInsights) return;

      studentInsightsFilter = null;
      filteredStudentInsights = currentStudentInsights.students || [];

      // Hide filter badge and clear button
      document.getElementById('student-insights-filter-badge').classList.add('hidden');
      document.getElementById('clear-student-filter-btn').classList.add('hidden');

      renderStudentInsightsTable();
    }

    function sortStudentsBy(column) {
      if (studentInsightsSortBy === column) {
        studentInsightsSortAsc = !studentInsightsSortAsc;
      } else {
        studentInsightsSortBy = column;
        studentInsightsSortAsc = true;
      }
      renderStudentInsightsTable();
    }

    // --- End Student Insights ---

    function renderAnalyticsStudents() {
      document.getElementById('analytics-students-loading').classList.add('hidden');
      document.getElementById('analytics-students-content').classList.remove('hidden');

      // Load student insights (2025)
      loadStudentInsights();

      if (!analyticsData || !analyticsData.students) return;

      var studentsArray = Object.values(analyticsData.students);

      // Update Analytics Combobox Data
      if (analyticsStudentCombobox) {
        var analyticsComboData = studentsArray.map(function (s) {
          return {
            label: formatStudentName(s),
            subLabel: s.email,
            student: s
          };
        });
        analyticsStudentCombobox.updateData(analyticsComboData);
      }
    }

    function selectStudent(student) {
      analyticsSelectedStudent = student;
      document.getElementById('analytics-student-empty').classList.add('hidden');
      document.getElementById('analytics-student-detail').classList.remove('hidden');

      // Render student summary
      var summary = document.getElementById('analytics-student-summary');
      summary.innerHTML = '<div class="flex flex-wrap items-center justify-between gap-4">' +
        '<div><h3 class="text-xl font-bold text-brand-dark-gray dark:text-brand-white">' + escapeHtml(formatStudentName(student)) + '</h3>' +
        '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">' + escapeHtml(student.email) + '</p></div>' +
        '<div class="grid grid-cols-3 gap-4 text-center">' +
        '<div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">' + student.successLast10.toFixed(1) + '%</div>' +
        '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Success Rate</div></div>' +
        '<div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">' + student.participationPct.toFixed(0) + '%</div>' +
        '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Participation</div></div>' +
        '<div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">' + student.integrityCount + '</div>' +
        '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Integrity Events</div></div>' +
        '</div></div>';

      // Render sparkline (last 10 sessions)
      var sparkline = document.getElementById('analytics-student-sparkline');
      var sessions = student.sessions || [];
      if (sessions.length > 0) {
        var sparkHtml = '<div class="flex gap-2">';
        sessions.slice(0, 10).reverse().forEach(function (session) {
          var color = session.scorePct >= 70 ? 'bg-green-500' : session.scorePct >= 50 ? 'bg-yellow-500' : 'bg-red-500';
          sparkHtml += '<div class="flex-1 flex flex-col items-center gap-1" title="' + escapeHtml(session.sessionName) + ': ' + session.scorePct + '%">';
          sparkHtml += '<div class="w-full rounded ' + color + '" style="height: ' + (session.scorePct * 0.8) + 'px; min-height: 20px;"></div>';
          sparkHtml += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">' + session.scorePct.toFixed(0) + '%</div>';
          sparkHtml += '</div>';
        });
        sparkHtml += '</div>';
        sparkline.innerHTML = sparkHtml;
      } else {
        sparkline.innerHTML = '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No session data</p>';
      }

      // Render topic bands
      var topicsDiv = document.getElementById('analytics-student-topics');
      var topics = Object.keys(student.topicPerformance || {});
      if (topics.length > 0) {
        var topicsHtml = '<div class="space-y-2">';
        topics.forEach(function (topic) {
          var perf = student.topicPerformance[topic];
          var pct = perf.total > 0 ? (perf.correct / perf.total * 100).toFixed(0) : 0;
          var color = pct >= 70 ? 'bg-green-500' : pct >= 50 ? 'bg-yellow-500' : 'bg-red-500';
          topicsHtml += '<div class="flex items-center gap-2">';
          topicsHtml += '<div class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white min-w-[100px]">' + escapeHtml(topic) + '</div>';
          topicsHtml += '<div class="flex-1 bg-brand-light-gray dark:bg-brand-dark-gray/30 rounded-full h-5 overflow-hidden">';
          topicsHtml += '<div class="' + color + ' h-full flex items-center justify-end px-2 text-xs text-white font-semibold" style="width: ' + pct + '%">';
          if (pct > 15) topicsHtml += pct + '%';
          topicsHtml += '</div></div>';
          topicsHtml += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">' + perf.correct + '/' + perf.total + '</div>';
          topicsHtml += '</div>';
        });
        topicsHtml += '</div>';
        topicsDiv.innerHTML = topicsHtml;
      } else {
        topicsDiv.innerHTML = '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No topic data</p>';
      }
    }

    // --- Analytics Event Listeners ---
    document.getElementById('analytics-apply-filters-btn').onclick = function () {
      var className = document.getElementById('analytics-class-filter').value;
      var dateFrom = document.getElementById('analytics-date-from').value;
      var dateTo = document.getElementById('analytics-date-to').value;
      loadAnalytics({ className: className, dateFrom: dateFrom, dateTo: dateTo });
    };

    document.getElementById('analytics-clear-filters-btn').onclick = function () {
      document.getElementById('analytics-class-filter').value = 'all';
      document.getElementById('analytics-date-from').value = '';
      document.getElementById('analytics-date-to').value = '';
      loadAnalytics({ className: 'all' });
    };

    document.getElementById('analytics-refresh-btn').onclick = function () {
      loadAnalytics(analyticsFilters);
    };

    // Date preset handlers
    document.querySelectorAll('.analytics-date-preset').forEach(function (btn) {
      btn.onclick = function () {
        var days = btn.getAttribute('data-days');
        var preset = btn.getAttribute('data-preset');
        var today = new Date();
        var dateFrom = '';
        var dateTo = today.toISOString().split('T')[0];

        if (days) {
          var pastDate = new Date();
          pastDate.setDate(pastDate.getDate() - parseInt(days));
          dateFrom = pastDate.toISOString().split('T')[0];
        } else if (preset === 'thisMonth') {
          var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
          dateFrom = firstDay.toISOString().split('T')[0];
        } else if (preset === 'lastMonth') {
          var lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          var lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
          dateFrom = lastMonthStart.toISOString().split('T')[0];
          dateTo = lastMonthEnd.toISOString().split('T')[0];
        } else if (preset === 'all') {
          dateFrom = '';
          dateTo = '';
        }

        document.getElementById('analytics-date-from').value = dateFrom;
        document.getElementById('analytics-date-to').value = dateTo;

        var className = document.getElementById('analytics-class-filter').value;
        loadAnalytics({ className: className, dateFrom: dateFrom, dateTo: dateTo });
      };
    });

    // Export analytics data
    document.getElementById('analytics-export-btn').onclick = function () {
      if (!analyticsData) {
        alert('No data to export. Please load analytics first.');
        return;
      }

      var exportData = {
        exportDate: new Date().toISOString(),
        filters: analyticsFilters,
        kpis: analyticsData.kpis || [],
        sessions: analyticsData.sessions || [],
        items: analyticsData.items || [],
        students: Object.values(analyticsData.students || {}),
        topics: analyticsData.topics || []
      };

      // Convert to CSV format (sessions only for now)
      var csv = 'Session Name,Class,Date,Questions,Participants,Total Students,Mastery %,Participation %,Median Time (s),Integrity Rate\n';
      (exportData.sessions || []).forEach(function (session) {
        csv += '"' + (session.sessionName || '').replace(/"/g, '""') + '",';
        csv += '"' + (session.className || '').replace(/"/g, '""') + '",';
        csv += '"' + (session.date || '') + '",';
        csv += session.questionCount + ',';
        csv += session.participants + ',';
        csv += session.totalStudents + ',';
        csv += session.masteryPct + ',';
        csv += session.participationPct + ',';
        csv += session.medianTimeSec + ',';
        csv += session.integrityRate + '\n';
      });

      // Download CSV
      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'veritas-analytics-' + new Date().toISOString().split('T')[0] + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    // Tab switching
    document.querySelectorAll('.analytics-tab').forEach(function (tab) {
      tab.onclick = function () {
        var tabId = tab.id.replace('analytics-tab-', '');
        analyticsCurrentTab = tabId;

        // Update tab styles
        document.querySelectorAll('.analytics-tab').forEach(function (t) {
          t.classList.remove('bg-primary', 'text-brand-white');
          t.classList.add('text-brand-dark-gray/70', 'dark:text-brand-white/70', 'hover:bg-brand-light-gray/20', 'dark:hover:bg-brand-dark-gray/30');
        });
        tab.classList.add('bg-primary', 'text-brand-white');
        tab.classList.remove('text-brand-dark-gray/70', 'dark:text-brand-white/70', 'hover:bg-brand-light-gray/20', 'dark:hover:bg-brand-dark-gray/30');

        // Update content
        document.querySelectorAll('.analytics-tab-content').forEach(function (content) {
          content.classList.add('hidden');
        });
        document.getElementById('analytics-content-' + tabId).classList.remove('hidden');

        renderAnalyticsByTab();
      };
    });

    // Item table sorting
    document.querySelectorAll('#analytics-items-table th[data-sort]').forEach(function (th) {
      th.onclick = function () {
        var field = th.getAttribute('data-sort');
        if (analyticsItemsSort.field === field) {
          analyticsItemsSort.direction = analyticsItemsSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          analyticsItemsSort.field = field;
          analyticsItemsSort.direction = 'asc';
        }
        renderAnalyticsItems();
      };
    });

    // --- Poll Lifecycle Controls ---
    async function onStartPoll() {
      var pollId = pollSelect.value;
      if (!pollId) {
        await veritasAlert('Please select a poll first.', { title: 'Live poll' });
        return;
      }

      var selectedPoll = ALL_POLLS.find(function (p) { return p.pollId === pollId; });
      if (!selectedPoll) {
        await veritasAlert('Could not find the selected poll data.', { title: 'Error' });
        setButtonLoading(startPollBtn, false);
        return;
      }

      // Check session type and call appropriate function
      if (isSecureSessionTypeClient(selectedPoll.sessionType)) {
        setButtonLoading(startPollBtn, true, 'Launching...');

        if (PREVIEW_MODE) {
          setButtonLoading(startPollBtn, false);
          await previewOnlyNotice('start a session');
          return;
        }

        // FIREBASE MIGRATION: Start Secure Assessment via Cloud Function
        firebase.functions().httpsCallable('setLiveSessionState')({
          pollId: pollId,
          status: 'OPEN',
          questionIndex: 0,
          metadata: {
            sessionPhase: 'ASSESSMENT_START',
            resultsVisibility: 'HIDDEN'
          }
        }).then(function (result) {
          var data = result.data;
          setButtonLoading(startPollBtn, false);
          if (data && data.success) {
            // result here should contain the new sessionId
            showIndividualTimedDashboard(data);

            // Trigger emulation if enabled
            if (emulatorAvailable && emulatorEnabled && emulatorEnabled.checked) {
              triggerSecureAssessmentEmulation(pollId, data.sessionId);
            }
          } else {
            throw new Error((data && data.error) || 'Failed to start secure session');
          }
        }).catch(function (error) {
          setButtonLoading(startPollBtn, false);
          handleError(error);
        });
        return;
      }

      setButtonLoading(startPollBtn, true, 'Starting...');
      clearLiveIntervals();
      isPaused = false;
      isLiveSession = true;

      if (PREVIEW_MODE) {
        setButtonLoading(startPollBtn, false);
        await previewOnlyNotice('start a session');
        return;
      }

      // FIREBASE MIGRATION: Start Live Poll via Cloud Function
      firebase.functions().httpsCallable('setLiveSessionState')({
        pollId: pollId,
        status: 'OPEN',
        questionIndex: 0,
        metadata: {
          sessionPhase: 'LIVE',
          resultsVisibility: 'HIDDEN'
        }
      }).then(function (result) {
        setButtonLoading(startPollBtn, false);
        var res = result.data;
        if (res && res.success) {
          // RTDB listener will handle the UI update via onQuestionStateChange
          if (emulatorAvailable && emulatorEnabled && emulatorEnabled.checked) {
            triggerLivePollEmulation(pollId);
          }
        } else {
          throw new Error(res.error || 'Failed to start poll');
        }
      }).catch(function (error) {
        setButtonLoading(startPollBtn, false);
        handleError(error);
      });
    }

    function onResumePoll() {
      if (pollInterval) clearInterval(pollInterval);
      pauseTimerCountdown();
      stopVisualTimer();
      timerExpiredHandled = false;
      timerActive = false;
      timerRemainingSeconds = timerPresetSeconds;
      updateTimerDisplay();
      updateTimerStatus('Timer idle.', 'info');
      isPaused = false;
      isLiveSession = true;

      if (PREVIEW_MODE) {
        previewOnlyNotice('resume a live poll');
        return;
      }

      var pollId = (CURRENT_POLL_DATA && CURRENT_POLL_DATA.pollId) || '';
      var qIndex = (typeof CURRENT_POLL_DATA.questionIndex === 'number') ? CURRENT_POLL_DATA.questionIndex : 0;

      firebase.functions().httpsCallable('setLiveSessionState')({
        pollId: pollId,
        status: 'OPEN',
        questionIndex: qIndex
      }).then(function (result) {
        var data = result.data;
        if (data && (data.success === false || data.error)) {
          throw new Error(data.error || 'Failed to resume poll');
        }
        console.log('[Firebase] Poll Resumed:', data);
      }).catch(handleError);
    }

    function onStopPoll() {
      pauseTimerCountdown();
      stopVisualTimer();
      timerActive = false;
      timerRemainingSeconds = timerPresetSeconds;
      updateTimerDisplay();
      updateTimerStatus('Timer idle.', 'info');
      if (PREVIEW_MODE) {
        previewOnlyNotice('pause the live poll');
        return;
      }
      google.script.run = null; // Removed GAS call

      var setSessionFn = firebase.functions().httpsCallable('setLiveSessionState');
      var pollId = CURRENT_POLL_DATA.pollId;
      var qIndex = CURRENT_POLL_DATA.questionIndex || 0;

      setSessionFn({
        pollId: pollId,
        status: 'PAUSED', // Stop = Pause in this context
        questionIndex: qIndex
      })
        .then(function (result) {
          isPaused = true;
          console.log('Poll Stopped (Paused):', result.data);
        })
        .catch(handleError);
    }

    function onEndQuestionAndShowAnswer() {
      pauseTimerCountdown();
      stopVisualTimer();
      timerActive = false;
      timerRemainingSeconds = timerPresetSeconds;
      updateTimerDisplay();
      updateTimerStatus('Timer idle.', 'info');
      var endShowBtn = document.getElementById('header-end-show-btn');
      if (endShowBtn) { endShowBtn.disabled = true; }
      if (PREVIEW_MODE) {
        if (endShowBtn) { endShowBtn.disabled = false; }
        previewOnlyNotice('reveal answers');
        return;
      }
      // FIREBASE MIGRATION: Call finalizeSession Cloud Function
      // Replaces google.script.run.endQuestionAndRevealResults()

      var finalizeFn = firebase.functions().httpsCallable('finalizeSession');
      var pollId = CURRENT_POLL_DATA.pollId;

      finalizeFn({ pollId: pollId })
        .then(function (result) {
          console.log('Session Finalized via Cloud Function:', result.data);
          if (endShowBtn) { endShowBtn.disabled = false; }
          isPaused = true;

          // Synthesize success data for updateLiveView
          var syntheticData = {
            pollId: pollId,
            questionIndex: CURRENT_POLL_DATA.questionIndex,
            status: 'ENDED',
            sessionPhase: 'RESULTS_REVEALED',
            resultsVisibility: 'REVEALED'
          };

          updateLiveView(syntheticData);

          broadcastSessionState(pollId, {
            status: 'ENDED',
            sessionPhase: 'RESULTS_REVEALED',
            resultsVisibility: 'REVEALED',
            questionIndex: CURRENT_POLL_DATA.questionIndex
          });
        })
        .catch(function (error) {
          console.error('Finalize Session Error:', error);
          if (endShowBtn) { endShowBtn.disabled = false; }
          handleError(error);
        });
    }

    function onPreviousQuestion() {
      if (pollInterval) clearInterval(pollInterval);
      pauseTimerCountdown();
      stopVisualTimer();
      timerExpiredHandled = false;
      timerActive = false;
      timerRemainingSeconds = timerPresetSeconds;
      updateTimerDisplay();
      updateTimerStatus('Timer ready for previous question.', 'info');
      isPaused = false;
      isNavigating = true; // Set flag to prevent polling during navigation
      if (PREVIEW_MODE) {
        isNavigating = false;
        previewOnlyNotice('navigate to a previous question');
        return;
      }
      var nextIndex = (CURRENT_POLL_DATA.questionIndex || 0) - 1;
      if (nextIndex < 0) nextIndex = 0; // Boundary check

      var setSessionFn = firebase.functions().httpsCallable('setLiveSessionState');
      var pollId = CURRENT_POLL_DATA.pollId;

      // Fetch qDef for payload
      var qDef = (CURRENT_POLL_DATA.questions && CURRENT_POLL_DATA.questions[nextIndex]) ? CURRENT_POLL_DATA.questions[nextIndex] : null;

      setSessionFn({
        pollId: pollId,
        questionIndex: nextIndex,
        status: 'OPEN',
        questionText: qDef ? qDef.questionText : '',
        options: qDef ? qDef.options : []
      })
        .then(function (result) {
          // UI updates handled by listeners, but we unblock navigation
          setTimeout(function () {
            isNavigating = false;
          }, 500);
        })
        .catch(function (error) {
          isNavigating = false;
          handleError(error);
        });
    }

    function onNextQuestion() {
      if (navigationRequestInFlight) {
        console.warn('Navigation already in progress; ignoring extra Next click');
        return;
      }
      navigationRequestInFlight = true;
      if (pollInterval) clearInterval(pollInterval);
      pauseTimerCountdown();
      stopVisualTimer();
      timerExpiredHandled = false;
      timerActive = false;
      timerRemainingSeconds = timerPresetSeconds;
      updateTimerDisplay();
      updateTimerStatus('Timer ready for next question.', 'info');
      isPaused = false;
      violationsAlertDismissed = false; // Reset violations alert for new question
      isNavigating = true; // Set flag to prevent polling during navigation
      if (PREVIEW_MODE) {
        isNavigating = false;
        navigationRequestInFlight = false;
        previewOnlyNotice('advance to the next question');
        return;
      }

      // OPTIMISTIC UPDATE: Update UI immediately using local data
      // This eliminates the visual lag for the teacher while the server processes the request
      if (CURRENT_POLL_DATA && CURRENT_POLL_DATA.questions) {
        var nextIndex = (CURRENT_POLL_DATA.questionIndex || 0) + 1;
        if (nextIndex < CURRENT_POLL_DATA.questions.length) {
          console.log('[Optimistic] Advancing UI to question index:', nextIndex);

          var optimisticData = {
            mode: 'lightweight',
            pollId: CURRENT_POLL_DATA.pollId,
            questionIndex: nextIndex,
            status: 'OPEN',
            metadata: {
              sessionPhase: 'LIVE',
              resultsVisibility: 'HIDDEN',
              startedAt: new Date().toISOString()
            }
          };

          // 1. Update UI instantly
          handleLightweightSessionUpdate(optimisticData);

          // 2. Broadcast to Firebase instantly (Fast Path for students)
          // handleLightweightSessionUpdate already calls broadcastSessionState,
          // but we want to ensure the optimistic payload is what's sent.
        }
      }

      var nextIndex = (CURRENT_POLL_DATA.questionIndex || 0) + 1;
      // Optimistic update logic preserved above...

      var setSessionFn = firebase.functions().httpsCallable('setLiveSessionState');
      var pollId = CURRENT_POLL_DATA.pollId;

      // Fetch qDef for payload - CRITICAL for fast path
      var qDef = (CURRENT_POLL_DATA.questions && CURRENT_POLL_DATA.questions[nextIndex]) ? CURRENT_POLL_DATA.questions[nextIndex] : null;

      setSessionFn({
        pollId: pollId,
        questionIndex: nextIndex,
        status: 'OPEN',
        questionText: qDef ? qDef.questionText : '',
        options: qDef ? qDef.options : []
      })
        .then(function (result) {
          // UI updates handled by listeners, but we unblock navigation
          setTimeout(function () {
            isNavigating = false;
            navigationRequestInFlight = false;
          }, 500);
        })
        .catch(function (error) {
          isNavigating = false;
          navigationRequestInFlight = false;
          handleError(error);
        });
    }

    async function onResetQuestion() {
      var pollId = CURRENT_POLL_DATA.pollId;
      var questionIndex = CURRENT_POLL_DATA.questionIndex;
      if (!pollId || typeof questionIndex === 'undefined') {
        await veritasAlert('No active question to reset.', { title: 'Reset question' });
        return;
      }
      var proceed = await veritasConfirm('Reset the current question for all students?', {
        title: 'Reset question',
        confirmText: 'Reset question',
        destructive: true
      });
      if (!proceed) {
        return;
      }
      var clearResponses = await veritasConfirm('Select OK to reset and clear responses, or Cancel to reset while keeping submissions.', {
        title: 'Responses',
        confirmText: 'Reset & clear',
        cancelText: 'Keep submissions',
        destructive: true
      });
      // Pause and reset timer
      pauseTimer();
      stopVisualTimer();
      timerExpiredHandled = false;
      timerActive = false;
      isRunning = false;
      timerRemainingSeconds = timerPresetSeconds;
      totalSeconds = timerPresetSeconds;
      toggleButtons(false);
      updateDisplay();
      updateTimerStatus('Timer idle.', 'info');

      if (PREVIEW_MODE) {
        await previewOnlyNotice('reset the live question');
        return;
      }

      var setSessionFn = firebase.functions().httpsCallable('setLiveSessionState');

      // If clearResponses is true, we ideally need a separate function or flag
      // But for now we just reset state. Handling clearResponses requires DB delete.

      if (clearResponses) {
        firebase.database().ref('answers/' + pollId).remove()
          .then(function () {
            console.log('Responses cleared for poll reset.');
          })
          .catch(console.error);
      }

      setSessionFn({
        pollId: pollId,
        questionIndex: questionIndex,
        status: 'OPEN',
        // Resend question data to ensure consistency
        questionText: (CURRENT_POLL_DATA.questions && CURRENT_POLL_DATA.questions[questionIndex]) ? CURRENT_POLL_DATA.questions[questionIndex].questionText : '',
        options: (CURRENT_POLL_DATA.questions && CURRENT_POLL_DATA.questions[questionIndex]) ? CURRENT_POLL_DATA.questions[questionIndex].options : []
      })
        .then(function (result) {
          isPaused = false;
          showToast('success', 'Question Reset', clearResponses ? 'Timer restarted and responses cleared.' : 'Timer restarted (responses kept).');
        })
        .catch(handleError);
    }

    function setLiveCalculatorToggleState(isEnabled, isSecureSession) {
      liveCalculatorEnabled = !!isEnabled;
      if (!liveCalculatorToggle) return;

      // Allow calculator for live poll and secure sessions; only disable when no active poll
      var disabled = !CURRENT_POLL_DATA.pollId;
      liveCalculatorToggle.disabled = disabled;
      liveCalculatorToggle.setAttribute('aria-disabled', disabled ? 'true' : 'false');
      liveCalculatorToggle.setAttribute('aria-pressed', liveCalculatorEnabled ? 'true' : 'false');
      liveCalculatorToggle.dataset.state = liveCalculatorEnabled ? 'on' : 'off';

      liveCalculatorToggle.classList.toggle('bg-amber-500', liveCalculatorEnabled && !disabled);
      liveCalculatorToggle.classList.toggle('text-veritas-navy', liveCalculatorEnabled && !disabled);
      liveCalculatorToggle.classList.toggle('bg-white/10', !(liveCalculatorEnabled && !disabled));

      if (liveCalculatorStateText) {
        liveCalculatorStateText.textContent = liveCalculatorEnabled ? 'On' : 'Off';
        liveCalculatorStateText.classList.toggle('text-veritas-gold', liveCalculatorEnabled);
        liveCalculatorStateText.classList.toggle('opacity-80', !liveCalculatorEnabled);
      }
    }

    async function onToggleLiveCalculator() {
      if (!liveCalculatorToggle || PREVIEW_MODE) {
        if (PREVIEW_MODE) { previewOnlyNotice('toggle the calculator'); }
        return;
      }

      var pollId = CURRENT_POLL_DATA && CURRENT_POLL_DATA.pollId;
      if (!pollId) {
        handleError('No active session to update.');
        return;
      }

      var targetState = !liveCalculatorEnabled;
      liveCalculatorToggle.setAttribute('aria-busy', 'true');
      liveCalculatorToggle.disabled = true;

      try {
        var setLiveSessionState = firebase.functions().httpsCallable('setLiveSessionState');
        var result = await setLiveSessionState({
          pollId: pollId,
          metadata: {
            calculatorEnabled: targetState
          }
        });

        liveCalculatorToggle.removeAttribute('aria-busy');
        liveCalculatorToggle.disabled = false;

        // Update local state and UI
        setLiveCalculatorToggleState(targetState, true);

        // Show toast feedback
        showToast('success', targetState ? 'Calculator enabled' : 'Calculator disabled',
          targetState ? 'Students can now access the calculator.' : 'Calculator has been disabled for students.');
      } catch (error) {
        liveCalculatorToggle.removeAttribute('aria-busy');
        liveCalculatorToggle.disabled = false;
        handleError(error);
      }
    }

    function onRevealResults() {
      var revealBtn = document.getElementById('reveal-results-btn');
      if (revealBtn) { revealBtn.disabled = true; }
      if (PREVIEW_MODE) {
        if (revealBtn) { revealBtn.disabled = false; }
        previewOnlyNotice('reveal results to students');
        return;
      }
      const setLiveSessionState = firebase.functions().httpsCallable('setLiveSessionState');
      setLiveSessionState({
        pollId: CURRENT_POLL_DATA.pollId,
        status: 'PAUSED',
        questionIndex: CURRENT_QUESTION_INDEX,
        sessionPhase: 'RESULTS_REVEALED',
        resultsVisibility: 'REVEALED'
      })
        .then(function (result) {
          if (revealBtn) { revealBtn.disabled = false; }
          // The UI will update via the RTDB listener (liveSessionRef)
        })
        .catch(function (error) {
          if (revealBtn) { revealBtn.disabled = false; }
          handleError(error);
        });
    }

    function onHideResults() {
      var hideBtn = document.getElementById('hide-results-btn');
      if (hideBtn) { hideBtn.disabled = true; }
      if (PREVIEW_MODE) {
        if (hideBtn) { hideBtn.disabled = false; }
        previewOnlyNotice('hide results from students');
        return;
      }
      const setLiveSessionState = firebase.functions().httpsCallable('setLiveSessionState');
      setLiveSessionState({
        pollId: CURRENT_POLL_DATA.pollId,
        status: 'PAUSED',
        questionIndex: CURRENT_QUESTION_INDEX,
        sessionPhase: 'RESULTS_HOLD',
        resultsVisibility: 'HIDDEN'
      })
        .then(function (result) {
          if (hideBtn) { hideBtn.disabled = false; }
          // UI updates via listener
        })
        .catch(function (error) {
          if (hideBtn) { hideBtn.disabled = false; }
          handleError(error);
        });
    }

    async function onEndPoll() {
      var confirmed = await veritasConfirm('Are you sure you want to end this poll completely?', {
        title: 'End poll',
        confirmText: 'End poll',
        destructive: true
      });
      if (!confirmed) return;
      showDashboard();
      if (PREVIEW_MODE) {
        previewOnlyNotice('end the live poll');
        return;
      }
      const finalizeSession = firebase.functions().httpsCallable('finalizeSession');
      finalizeSession({
        pollId: (CURRENT_POLL_DATA && CURRENT_POLL_DATA.pollId) || ''
      })
        .then(function (result) {
          showDashboard();
        })
        .catch(handleError);
    }

    // --- Live View & Data Polling ---
    function updateLiveOverviewFromData(data) {
      var totalResponses = (data && typeof data.totalResponses === 'number') ? data.totalResponses : 0;
      var totalStudents = (data && typeof data.totalStudents === 'number') ? data.totalStudents : 0;
      var responsesEl = document.getElementById('live-overview-responses');
      var progressEl = document.getElementById('live-overview-response-progress');
      var responseCaption = document.getElementById('live-overview-response-caption');
      var hudResponseCount = document.getElementById('hud-response-count');
      var hudResponseCaption = document.getElementById('hud-response-caption');
      var hudResponseTrend = document.getElementById('hud-response-trend');
      var mobileResponseChip = document.getElementById('mobile-response-chip');

      if (responsesEl) {
        responsesEl.textContent = totalResponses + ' / ' + totalStudents;
      }

      var completionPct = totalStudents > 0 ? Math.round((totalResponses / totalStudents) * 100) : 0;
      if (progressEl) {
        var safeWidth = Math.max(0, Math.min(100, completionPct));
        progressEl.style.width = safeWidth + '%';
      }
      if (responseCaption) {
        responseCaption.textContent = totalStudents > 0 ? completionPct + '% complete' : 'Awaiting roster data';
      }

      if (hudResponseCount) {
        hudResponseCount.textContent = (totalStudents > 0 ? totalResponses : '0') + ' / ' + (totalStudents || 0);
      }
      if (mobileResponseChip) {
        mobileResponseChip.textContent = (totalStudents > 0 ? totalResponses : 0) + ' / ' + (totalStudents || 0);
      }
      if (hudResponseCaption) {
        hudResponseCaption.textContent = totalStudents > 0 ? completionPct + '% complete' : 'Awaiting roster data';
      }
      if (hudResponseTrend) {
        hudResponseTrend.classList.remove('hud-trend-up', 'hud-trend-down', 'hud-trend-steady');
        var previousPct = sessionHudState.lastCompletionPct;
        if (previousPct === null || totalStudents === 0) {
          hudResponseTrend.textContent = ' steady';
          hudResponseTrend.classList.add('hud-trend-steady');
        } else {
          var delta = completionPct - previousPct;
          if (delta > 0) {
            hudResponseTrend.textContent = ' +' + delta + '%';
            hudResponseTrend.classList.add('hud-trend-up');
          } else if (delta < 0) {
            hudResponseTrend.textContent = ' ' + delta + '%';
            hudResponseTrend.classList.add('hud-trend-down');
          } else {
            hudResponseTrend.textContent = ' steady';
            hudResponseTrend.classList.add('hud-trend-steady');
          }
        }
      }
      sessionHudState.lastCompletionPct = totalStudents > 0 ? completionPct : null;

      // Update progress ring for responses
      updateProgressRing('hud-response-ring', completionPct);
      var hudResponsePercent = document.getElementById('hud-response-percent');
      if (hudResponsePercent) {
        hudResponsePercent.textContent = completionPct + '%';
      }

      // Track sparkline data for responses
      addSparklineDataPoint('responses', completionPct);

      var allResponded = totalStudents > 0 && totalResponses === totalStudents;
      var allRespondedBanner = document.getElementById('all-responded-banner');

      if (allResponded) {
        if (!sessionHudState.allRespondedCelebrated) {
          // Trigger toast with action instead of intrusive banner
          showToast('success', 'All Students Responded!', 'Everyone has submitted their answer.', null, {
            label: 'Reveal Answer',
            onClick: function () {
              var endShowBtn = document.getElementById('header-end-show-btn');
              if (endShowBtn) endShowBtn.click();
            }
          });

          // Ensure banner stays hidden (legacy cleanup)
          if (allRespondedBanner) {
            allRespondedBanner.classList.add('hidden');
            allRespondedBanner.setAttribute('aria-hidden', 'true');
          }

          sessionHudState.allRespondedCelebrated = true;
        }
      } else {
        // Ensure banner stays hidden
        if (allRespondedBanner) {
          allRespondedBanner.classList.add('hidden');
          allRespondedBanner.setAttribute('aria-hidden', 'true');
        }
        sessionHudState.allRespondedCelebrated = false;
      }

      if (typeof window.checkAllRespondedState === 'function') {
        window.checkAllRespondedState(allResponded);
      }

      var rawResults = data && data.results;
      var resultsArray;
      if (Array.isArray(rawResults)) {
        resultsArray = rawResults;
      } else if (rawResults && typeof rawResults === 'object') {
        resultsArray = Object.keys(rawResults).map(function (answerText) {
          var value = rawResults[answerText];
          if (value && typeof value === 'object' && !Array.isArray(value)) {
            var mapped = {};
            Object.keys(value).forEach(function (key) {
              mapped[key] = value[key];
            });
            mapped.answerText = answerText;
            mapped.count = typeof value.count === 'number' ? value.count : 0;
            return mapped;
          }
          return {
            answerText: answerText,
            count: typeof value === 'number' ? value : 0
          };
        });
      } else {
        resultsArray = [];
      }

      var correctAnswer = data && data.correctAnswer;
      var countedResponses = 0;
      var correctCount = 0;

      resultsArray.forEach(function (result) {
        if (!result) return;
        var count = typeof result.count === 'number' ? result.count : 0;
        countedResponses += count;
        var answerText = result.answerText || result.text || result.optionText || '';
        var isCorrect = result.isCorrect === true || (!!correctAnswer && answerText === correctAnswer);
        if (isCorrect) {
          correctCount += count;
        }
      });

      var accuracyEl = document.getElementById('live-overview-accuracy');
      var accuracyCaption = document.getElementById('live-overview-accuracy-caption');
      var hudAccuracyValue = document.getElementById('hud-accuracy-value');
      var hudAccuracyCaption = document.getElementById('hud-accuracy-caption');
      var hudAccuracyTrend = document.getElementById('hud-accuracy-trend');
      var mobileAccuracyChip = document.getElementById('mobile-accuracy-chip');
      var accuracyPct = countedResponses > 0 ? Math.round((correctCount / countedResponses) * 100) : 0;
      if (accuracyEl) {
        accuracyEl.textContent = accuracyPct + '%';
      }
      if (accuracyCaption) {
        if (countedResponses === 0) {
          accuracyCaption.textContent = 'No responses yet';
        } else {
          accuracyCaption.textContent = correctCount + ' of ' + countedResponses + ' correct';
        }
      }

      if (hudAccuracyValue) {
        hudAccuracyValue.textContent = countedResponses > 0 ? accuracyPct + '%' : '--%';
      }
      if (mobileAccuracyChip) {
        mobileAccuracyChip.textContent = countedResponses > 0 ? accuracyPct + '%' : '--%';
      }

      // Update progress ring for accuracy
      if (countedResponses > 0) {
        updateProgressRing('hud-accuracy-ring', accuracyPct);
        var hudAccuracyPercent = document.getElementById('hud-accuracy-percent');
        if (hudAccuracyPercent) {
          hudAccuracyPercent.textContent = accuracyPct + '%';
        }

        // Track sparkline data for accuracy
        addSparklineDataPoint('accuracy', accuracyPct);

        // Celebrate perfect accuracy
        if (accuracyPct === 100 && countedResponses >= 3) {
          var accuracyCard = document.getElementById('hud-accuracy-card');
          if (accuracyCard && !accuracyCard.classList.contains('celebrate')) {
            triggerCelebration(accuracyCard, 'perfect-accuracy');
          }
        }
      }

      if (hudAccuracyCaption) {
        if (countedResponses === 0) {
          hudAccuracyCaption.textContent = 'Waiting for responses';
        } else {
          hudAccuracyCaption.textContent = correctCount + ' of ' + countedResponses + ' correct';
        }
      }
      if (hudAccuracyTrend) {
        hudAccuracyTrend.classList.remove('hud-trend-up', 'hud-trend-down', 'hud-trend-steady');
        if (countedResponses === 0) {
          hudAccuracyTrend.textContent = ' steady';
          hudAccuracyTrend.classList.add('hud-trend-steady');
        } else {
          var previousAccuracy = sessionHudState.lastAccuracyPct;
          if (previousAccuracy === null) {
            hudAccuracyTrend.textContent = ' steady';
            hudAccuracyTrend.classList.add('hud-trend-steady');
          } else {
            var accuracyDelta = accuracyPct - previousAccuracy;
            if (accuracyDelta > 0) {
              hudAccuracyTrend.textContent = ' +' + accuracyDelta + '%';
              hudAccuracyTrend.classList.add('hud-trend-up');
            } else if (accuracyDelta < 0) {
              hudAccuracyTrend.textContent = ' ' + accuracyDelta + '%';
              hudAccuracyTrend.classList.add('hud-trend-down');
            } else {
              hudAccuracyTrend.textContent = ' steady';
              hudAccuracyTrend.classList.add('hud-trend-steady');
            }
          }
        }
      }
      sessionHudState.lastAccuracyPct = countedResponses > 0 ? accuracyPct : null;
    }

    function updateLiveOverviewCounts(lockedCount, blockedCount, waitingCount) {
      var lockoutsEl = document.getElementById('live-overview-lockouts');
      if (lockoutsEl) {
        lockoutsEl.textContent = lockedCount || 0;
      }

      var lockoutsCaption = document.getElementById('live-overview-lockouts-caption');
      var hudLockoutsValue = document.getElementById('hud-lockouts-value');
      var hudLockoutsCaption = document.getElementById('hud-lockouts-caption');
      var hudLockoutsCard = document.getElementById('hud-lockouts-card');
      var hudFocusBtn = document.getElementById('hud-focus-lockouts-btn');
      var mobileLockChip = document.getElementById('mobile-lock-chip');
      var mobileLocksBtn = document.getElementById('mobile-locks-btn');
      var mobileLocksLabel = document.getElementById('mobile-locks-label');
      if (lockoutsCaption) {
        var pendingTotal = (lockedCount || 0) + (blockedCount || 0);
        if (pendingTotal === 0) {
          lockoutsCaption.textContent = 'No approvals pending';
        } else {
          var parts = [];
          if (lockedCount) { parts.push(lockedCount + ' locked'); }
          if (blockedCount) { parts.push(blockedCount + ' blocked'); }
          lockoutsCaption.textContent = parts.join('  ');
        }
      }

      var pendingTotalForHud = (lockedCount || 0) + (blockedCount || 0);
      if (hudLockoutsValue) {
        hudLockoutsValue.textContent = pendingTotalForHud;
      }
      if (mobileLockChip) {
        mobileLockChip.textContent = pendingTotalForHud;
      }
      if (mobileLocksLabel) {
        mobileLocksLabel.textContent = pendingTotalForHud === 1 ? '1 Locked' : pendingTotalForHud + ' Locked';
      }
      if (hudLockoutsCaption) {
        if (pendingTotalForHud === 0) {
          hudLockoutsCaption.textContent = 'No approvals pending';
        } else {
          hudLockoutsCaption.textContent = 'Requires quick approval';
        }
      }
      if (hudFocusBtn) {
        if (pendingTotalForHud > 0) {
          hudFocusBtn.disabled = false;
          hudFocusBtn.classList.remove('opacity-50', 'pointer-events-none');
        } else {
          hudFocusBtn.disabled = true;
          hudFocusBtn.classList.add('opacity-50', 'pointer-events-none');
          // Hide popover if it was open but now empty
          var popover = document.getElementById('locked-students-popover');
          if (popover) popover.classList.add('hidden');
        }
      }
      if (mobileLocksBtn) {
        mobileLocksBtn.disabled = pendingTotalForHud === 0;
      }
      sessionHudState.lastLockoutTotal = pendingTotalForHud;

      var focusBtn = document.getElementById('focus-lockouts-btn');
      if (focusBtn) {
        focusBtn.disabled = (lockedCount || 0) === 0;
      }

      var waitingEl = document.getElementById('live-overview-waiting');
      if (waitingEl) {
        waitingEl.textContent = waitingCount || 0;
      }

      var waitingCaption = document.getElementById('live-overview-waiting-caption');
      if (waitingCaption) {
        if (!waitingCount) {
          waitingCaption.textContent = 'Everyone has responded';
        } else if (waitingCount === 1) {
          waitingCaption.textContent = '1 student still working';
        } else {
          waitingCaption.textContent = waitingCount + ' students still working';
        }
      }
    }

    // --- Individual Timed Session Monitoring ---
    function showIndividualTimedDashboard(result) {
      showIndividualTimedView(result);
    }

    async function onEndIndividualSession() {
      var confirmed = await veritasConfirm('Are you sure you want to end this session for all students?', {
        title: 'End Session',
        confirmText: 'End Session',
        cancelText: 'Cancel'
      });

      if (!confirmed) return;

      missionControlHeartbeat.stop();

      var pollId = currentMissionControlPollId || (CURRENT_POLL_DATA && CURRENT_POLL_DATA.pollId);
      if (!pollId) {
        return;
      }

      const finalizeSession = firebase.functions().httpsCallable('finalizeSession');
      finalizeSession({
        pollId: pollId
      })
        .then(function () {
          showDashboard();
        })
        .catch(handleError);
    }

    function updateLiveView(data) {
      mainLoader.style.display = 'none';
      setButtonLoading(startPollBtn, false);

      if (!data) { return; }

      // Initialize Firebase for Realtime Updates (Fast Path)
      if (data.pollId) {
        initFirebaseMissionControl(data.pollId);
      }

      var status = data.status || 'PRE_LIVE';
      var metadata = data.metadata || {};
      var isCollecting = typeof metadata.isCollecting === 'boolean' ? metadata.isCollecting : (status === 'LIVE');
      var resultsVisibility = metadata.resultsVisibility || 'HIDDEN';
      var isResultsRevealed = resultsVisibility === 'REVEALED';
      var isPreLive = status === 'PRE_LIVE';
      var isEnded = status === 'ENDED';
      var calculatorEnabled = metadata.calculatorEnabled === true ||
        data.calculatorEnabled === true ||
        (data.secureSettings && data.secureSettings.calculatorEnabled === true);

      if (!isLiveSession && !isPreLive) {
        if (status === 'LIVE') {
          isLiveSession = true;
        } else {
          return;
        }
      }

      if (isPreLive || isEnded) {
        showDashboard();
        return;
      }

      if (data.error) { handleError(data.error); return; }

      var previousQuestionIndex = typeof CURRENT_POLL_DATA.questionIndex === 'number' ? CURRENT_POLL_DATA.questionIndex : null;
      isPaused = !isCollecting;

      CURRENT_POLL_DATA.pollId = data.pollId || pollSelect.value;
      CURRENT_POLL_DATA.questionIndex = data.questionIndex;
      CURRENT_POLL_DATA.correctAnswer = data.correctAnswer;

      // FIX: Update pollSessionType from server data to ensure calculator toggle works correctly
      // This fixes the bug where calculator button does nothing because pollSessionType was not updated
      if (data.sessionType) {
        pollSessionType = normalizeSessionTypeClient(data.sessionType);
        CURRENT_POLL_DATA.sessionType = data.sessionType;
      }

      // ENRICHMENT: Ensure CURRENT_POLL_DATA.questions is populated from local cache if missing
      // This is critical for enriched Firebase broadcasts (Fast Path)
      if (!CURRENT_POLL_DATA.questions && ALL_POLLS) {
        var sourcePoll = ALL_POLLS.find(function (p) { return p.pollId === (data.pollId || CURRENT_POLL_DATA.pollId); });
        if (sourcePoll && sourcePoll.questions) {
          console.log('[Enrichment] Restored questions from ALL_POLLS cache');
          CURRENT_POLL_DATA.questions = sourcePoll.questions;
        }
      }

      // FIX TASK A: Initialize Firebase for ALL proctored sessions (Live Polls + Secure Assessment)
      // This enables real-time proctoring status on the teacher dashboard
      // DO NOT set currentMissionControlPollId here - let initFirebaseMissionControl handle it
      if (CURRENT_POLL_DATA.pollId) {
        initFirebaseMissionControl(CURRENT_POLL_DATA.pollId);
      }
      CURRENT_POLL_DATA.totalQuestions = data.totalQuestions;
      CURRENT_POLL_DATA.timerSeconds = data.timerSeconds || null;
      CURRENT_POLL_DATA.options = data.options || [];
      CURRENT_POLL_DATA.metacognition = data.metacognition || null;
      CURRENT_POLL_DATA.calculatorEnabled = calculatorEnabled;

      // FIX: Use the actual session type from server data for calculator toggle
      var isSecureSession = isSecureSessionTypeClient(data.sessionType || pollSessionType);
      setLiveCalculatorToggleState(calculatorEnabled, isSecureSession);

      var questionChanged = previousQuestionIndex === null || data.questionIndex !== previousQuestionIndex;

      // Show live view and hide sidebar
      setMainSection('live');
      headerDefault.style.display = 'none';
      headerLive.style.display = 'flex';
      setDashboardSidebarVisibility(false);

      // Update header
      document.getElementById('header-poll-name').textContent = data.pollName;

      // Update question dots
      updateQuestionDots(data.questionIndex, data.totalQuestions);

      // Enable/disable navigation buttons
      var backBtn = document.getElementById('header-back-btn');
      var nextBtn = document.getElementById('header-next-btn');
      var mobileNextBtn = document.getElementById('mobile-next-btn');
      if (backBtn) {
        backBtn.disabled = data.questionIndex <= 0;
        if (data.questionIndex <= 0) {
          backBtn.style.opacity = '0.5';
          backBtn.style.cursor = 'not-allowed';
        } else {
          backBtn.style.opacity = '1';
          backBtn.style.cursor = 'pointer';
        }
      }
      if (nextBtn) {
        var isLastQuestion = data.questionIndex >= data.totalQuestions - 1;
        nextBtn.disabled = isLastQuestion;
        if (isLastQuestion) {
          nextBtn.style.opacity = '0.5';
          nextBtn.style.cursor = 'not-allowed';
        } else {
          nextBtn.style.opacity = '1';
          nextBtn.style.cursor = 'pointer';
        }
      }
      if (mobileNextBtn) {
        mobileNextBtn.disabled = data.questionIndex >= data.totalQuestions - 1;
      }

      // Show/hide end-show/start buttons based on state
      var isResultsRevealed = resultsVisibility === 'REVEALED';

      var mobileResumeBtn = document.getElementById('mobile-resume-btn');
      var mobileRevealBtn = document.getElementById('mobile-reveal-btn');

      if (isResultsRevealed) {
        // Results already revealed - hide both action buttons
        document.getElementById('header-start-btn').style.display = 'none';
        document.getElementById('header-end-show-btn').style.display = 'none';
        if (mobileResumeBtn) mobileResumeBtn.classList.add('hidden');
        if (mobileRevealBtn) mobileRevealBtn.classList.add('hidden');
      } else if (isPaused) {
        // Paused (responses closed) but not revealed - show resume and reveal buttons
        document.getElementById('header-start-btn').style.display = 'flex';
        document.getElementById('header-end-show-btn').style.display = 'flex';
        if (mobileResumeBtn) mobileResumeBtn.classList.remove('hidden');
        if (mobileRevealBtn) mobileRevealBtn.classList.remove('hidden');
      } else {
        // Active (collecting responses) - show only reveal button (teacher can end early)
        document.getElementById('header-start-btn').style.display = 'none';
        document.getElementById('header-end-show-btn').style.display = 'flex';
        if (mobileResumeBtn) mobileResumeBtn.classList.add('hidden');
        if (mobileRevealBtn) mobileRevealBtn.classList.remove('hidden');
      }

      if (questionChanged) {
        // Reset timer to default or custom duration for the new question
        var defaultSeconds = data.timerSeconds ? Math.min(600, Math.max(15, parseInt(data.timerSeconds, 10))) : 90;
        timerPresetSeconds = defaultSeconds;
        timerRemainingSeconds = defaultSeconds;
        totalSeconds = defaultSeconds; // Update new timer variable
        timerExpiredHandled = false;
        timerActive = false;
        isRunning = false; // Update new timer variable

        // Stop any running timer
        teacherCountdown.stop();
        isRunning = false;
        timerActive = false;

        // Update UI
        toggleButtons(false);
        updateDisplay();
        updateTimerStatus('Timer idle.', 'info');
      }

      if (data.metadata) {
        if (data.metadata.reason === 'TIMER_EXPIRED') {
          timerRemainingSeconds = 0;
          totalSeconds = 0; // Update new timer variable
          var previousState = timerActive;
          timerActive = true;
          updateDisplay();
          timerActive = previousState;
          timerExpiredHandled = true;
          updateTimerStatus('Time expired  poll paused.', 'danger');
        } else if (data.metadata.reason === 'MANUAL_PAUSE') {
          updateTimerStatus('Poll paused.', 'info');
        } else if (data.metadata.reason === 'RESPONSES_CLOSED') {
          updateTimerStatus('Responses closed. Ready to reveal.', 'info');
        } else if (data.metadata.reason === 'RESULTS_REVEALED') {
          updateTimerStatus('Results shared with students.', 'success');
        } else if (data.metadata.reason === 'RESULTS_HIDDEN') {
          updateTimerStatus('Results hidden from students.', 'info');
        } else {
          updateTimerStatus('Timer idle.', 'info');
        }
      }

      // DEBUG: Log what teacher received
      console.log('=== TEACHER RECEIVED DATA ===');
      console.log('questionImageURL:', data.questionImageURL);
      console.log('options:', data.options);
      if (data.options && data.options.length > 0) {
        data.options.forEach(function (opt, idx) {
          console.log('  Option ' + idx + ':', 'text="' + opt.text + '", imageURL=' + opt.imageURL);
        });
      }

      // Update question display
      var isNewQuestion = lastQuestionIndex !== data.questionIndex;
      if (isNewQuestion) {
        lastQuestionIndex = data.questionIndex;
        var qCard = document.querySelector('.live-question-card');
        if (qCard) {
          qCard.classList.remove('motion-slide-in-right');
          void qCard.offsetWidth; // Force reflow
          qCard.classList.add('motion-slide-in-right');
        }
      }

      document.getElementById('live-question-info').textContent = 'Q' + (data.questionIndex + 1) + '/' + data.totalQuestions;
      document.getElementById('live-question-text').textContent = data.questionText;
      document.getElementById('live-question-text-compact').textContent = data.questionText;

      // Handle question image with cache-busting
      var questionImageContainer = document.getElementById('question-image-container');
      var questionImageEl = document.getElementById('live-question-image');
      var questionLayoutContainer = document.getElementById('question-layout-container');
      if (data.questionImageURL) {
        questionImageContainer.style.display = 'flex';

        // Remove no-image class from grid
        if (questionLayoutContainer) {
          questionLayoutContainer.classList.remove('no-image');
        }

        // Add cache-busting query parameter based on question index
        // This ensures the browser re-fetches when switching questions
        var imageUrl = data.questionImageURL;
        var cacheBuster = 'q=' + data.questionIndex;
        var separator = imageUrl.includes('?') ? '&' : '?';
        questionImageEl.src = imageUrl + separator + cacheBuster;
        questionImageEl.style.display = 'block';

        // Also set referrerpolicy for cross-origin images
        questionImageEl.setAttribute('referrerpolicy', 'no-referrer');
      } else {
        questionImageContainer.style.display = 'none';
        questionImageEl.src = '';

        // Add no-image class to grid when no image present
        if (questionLayoutContainer) {
          questionLayoutContainer.classList.add('no-image');
        }
      }

      // Update response count
      document.getElementById('response-count').textContent = data.totalResponses + ' / ' + data.totalStudents + ' answered';
      var responseCountHeader = document.getElementById('response-count-header');
      if (responseCountHeader) {
        responseCountHeader.textContent = data.totalResponses + ' / ' + data.totalStudents + ' answered';
      }

      updateLiveOverviewFromData(data);

      // Update results bars
      renderResultsBars(data.results, data.correctAnswer, data.studentStatusList);
      renderLiveMetacognition(data.metacognition || null);

      var resultsStrip = document.getElementById('results-reveal-strip');
      if (resultsStrip) {
        var hasQuestion = typeof data.questionIndex === 'number' && data.questionIndex >= 0;
        // Only show the strip when results are revealed
        if (isCollecting || !hasQuestion || !isResultsRevealed) {
          resultsStrip.classList.add('hidden');
        } else {
          resultsStrip.classList.remove('hidden');
          var hideBtn = document.getElementById('hide-results-btn');
          var stripNextBtn = document.getElementById('strip-next-btn');
          var stripStatus = document.getElementById('results-strip-status');
          if (hideBtn) {
            hideBtn.disabled = !hasQuestion;
          }
          if (stripNextBtn) {
            stripNextBtn.disabled = !hasQuestion;
          }
          if (stripStatus) {
            var suffix = data.totalResponses === 0 ? ' No responses were recorded.' : '';
            stripStatus.textContent = 'Students can now see the correct answer and results.' + suffix;
          }
        }
      }

      // Update student status
      currentStudentStatusData = data.studentStatusList;

      // FIX TASK A: Re-apply Firebase realtime overrides immediately after server update
      // This ensures that "LOCKED" status from Firebase (which is faster) is not overwritten by "ACTIVE" from stale server poll
      if (typeof updateRealtimeUI === 'function') {
        updateRealtimeUI();
      }

      // Update Live View Combobox Data
      if (liveStudentCombobox && Array.isArray(currentStudentStatusData)) {
        var studentData = currentStudentStatusData.map(function (s) {
          return {
            label: formatStudentName(s),
            subLabel: s.status,
            value: s.email
          };
        });
        liveStudentCombobox.updateData(studentData);
      }

      renderStudentStatus();

      if (pollInterval) clearInterval(pollInterval);
      if (!isPaused) {
        // OPTIMIZATION: Use adaptive interval instead of hardcoded 2500ms
        pollInterval = setInterval(pollForResults, currentPollInterval);
      }
    }

    function updateQuestionDots(current, total) {
      var dotsContainer = document.getElementById('question-dots');
      dotsContainer.innerHTML = '';
      for (var i = 0; i < total; i++) {
        var dot = document.createElement('span');
        dot.className = 'h-2 w-2 rounded-full ' + (i === current ? 'bg-primary' : 'bg-primary/50');
        dotsContainer.appendChild(dot);
      }
    }

    function renderResultsBars(results, correctAnswer, studentsList) {
      var container = document.getElementById('results-bars');
      container.innerHTML = '';

      var optionDefs = Array.isArray(CURRENT_POLL_DATA.options) ? CURRENT_POLL_DATA.options.slice() : [];
      var knownKeys = {};
      optionDefs.forEach(function (option) {
        knownKeys[(option && option.text) || ''] = true;
      });

      if (results) {
        Object.keys(results).forEach(function (answerText) {
          if (!knownKeys[answerText || '']) {
            optionDefs.push({ text: answerText || '', imageURL: '' });
            knownKeys[answerText || ''] = true;
          }
        });
      }

      if (optionDefs.length === 0) {
        optionDefs = (results && Object.keys(results).length > 0) ? Object.keys(results).map(function (key) { return { text: key, imageURL: '' }; }) : [];
      }

      if (optionDefs.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-4">Waiting for responses...</p>';
        return;
      }

      var total = optionDefs.reduce(function (sum, opt) {
        var key = (opt && opt.text) || '';
        var value = (results && typeof results[key] === 'number') ? results[key] : 0;
        return sum + value;
      }, 0);

      var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

      optionDefs.forEach(function (option, index) {
        var answerText = (option && option.text) || '';
        var count = (results && typeof results[answerText] === 'number') ? results[answerText] : 0;
        var percentage = total > 0 ? Math.round((count / total) * 100) : 0;
        var isCorrect = answerText === correctAnswer;
        var letter = letters[index] || String(index + 1);
        var imageURL = option && option.imageURL;

        var card = document.createElement('div');

        // Student-view-style answer card with percentage overlay
        var borderColor = isCorrect ? 'border-green-500 dark:border-green-400' : 'border-gray-200 dark:border-gray-700';
        var bgColor = isCorrect ? 'bg-green-50/50 dark:bg-green-900/20' : 'bg-white dark:bg-brand-dark-gray/30';

        card.className = 'relative rounded-xl border ' + borderColor + ' ' + bgColor + ' overflow-hidden transition-all hover:shadow-sm';

        var cardHtml = '<div class="flex items-start gap-2.5 p-3">';

        // Letter badge (student view style - smaller 32px)
        var badgeBg = isCorrect ? 'bg-green-500 dark:bg-green-600' : 'bg-gray-600 dark:bg-gray-500';
        cardHtml += '<div class="flex-shrink-0 w-8 h-8 ' + badgeBg + ' rounded-lg flex items-center justify-center">';
        cardHtml += '<span class="text-white text-base font-bold">' + letter + '</span>';
        cardHtml += '</div>';

        // Answer content
        cardHtml += '<div class="flex-1 min-w-0">';

        if (answerText) {
          cardHtml += '<p class="text-[1.125rem] font-medium text-brand-dark-gray dark:text-brand-white break-words leading-relaxed">' + escapeHtml(answerText) + '</p>';
        } else if (!imageURL) {
          cardHtml += '<p class="text-sm font-medium text-gray-400 dark:text-gray-500">(No content)</p>';
        }

        if (imageURL) {
          cardHtml += '<div class="mt-1.5"><img src="' + escapeHtml(imageURL) + '" class="max-w-full max-h-24 rounded-lg border border-gray-200 dark:border-gray-700" alt="Answer ' + letter + ' image" referrerpolicy="no-referrer"/></div>';
        }

        // Student names with confidence (compact, below answer text)
        var studentsWithAnswer = Array.isArray(studentsList) ? studentsList.filter(function (s) { return s.answer === answerText; }) : [];
        if (studentsWithAnswer.length > 0) {
          cardHtml += '<div class="mt-1.5 flex flex-wrap gap-1">';
          studentsWithAnswer.forEach(function (student) {
            var confidenceText = describeConfidence(student.confidence);
            var style = CONFIDENCE_LEVEL_STYLES[student.confidence] || {};
            var badgeClass = style.badgeClass || 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300';
            var displayText = formatStudentName(student);
            if (confidenceText) {
              var emoji = style.emoji || '';
              displayText = emoji + ' ' + displayText;
            }
            cardHtml += '<span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[11px] font-medium ' + badgeClass + '">' + escapeHtml(displayText) + '</span>';
          });
          cardHtml += '</div>';
        }

        cardHtml += '</div>';

        // Percentage badge (top right corner - smaller)
        var percentageBg = isCorrect ? 'bg-green-500 dark:bg-green-600' : 'bg-gray-700 dark:bg-gray-600';
        cardHtml += '<div class="flex-shrink-0 ' + percentageBg + ' text-white rounded-lg px-2 py-1 flex flex-col items-center">';
        cardHtml += '<span class="text-lg font-bold leading-none">' + percentage + '%</span>';
        cardHtml += '<span class="text-[10px] opacity-90 mt-0.5">' + count + '</span>';
        cardHtml += '</div>';

        cardHtml += '</div>';

        card.innerHTML = cardHtml;
        container.appendChild(card);
      });
    }

    function renderLiveMetacognition(metacognition) {
      var container = document.getElementById('confidence-pulse-container');
      if (!container) return;

      // Clear the container
      container.innerHTML = '';

      if (!metacognition || !metacognition.enabled) {
        return;
      }

      var card = document.createElement('div');
      card.id = 'live-metacognition-card';
      card.className = 'bg-white dark:bg-brand-dark-gray/30 p-3 rounded-xl border border-purple-200 dark:border-purple-700 shadow-sm';

      var totalResponses = metacognition.totalResponses || 0;
      var participation = metacognition.responseRate || 0;
      var flagged = Array.isArray(metacognition.flaggedStudents) ? metacognition.flaggedStudents : [];

      var statusLabel = totalResponses > 0
        ? totalResponses + ' responses  ' + participation + '% participation'
        : 'Waiting for responses';

      var matrixDefs = [
        { key: 'confidentCorrect', emoji: '', label: 'Sure & Right', barClass: 'bg-emerald-500', textClass: 'text-emerald-700 dark:text-emerald-200' },
        { key: 'confidentIncorrect', emoji: '', label: 'Sure & Wrong', barClass: 'bg-rose-500', textClass: 'text-rose-700 dark:text-rose-200' },
        { key: 'uncertainCorrect', emoji: '', label: 'Unsure & Right', barClass: 'bg-amber-500', textClass: 'text-amber-700 dark:text-amber-200' },
        { key: 'uncertainIncorrect', emoji: '', label: 'Unsure & Wrong', barClass: 'bg-blue-500', textClass: 'text-blue-700 dark:text-blue-200' }
      ];

      var html = '<div class="flex items-start justify-between gap-3 mb-2">';
      html += '<div class="flex items-start gap-2">';
      html += '<span class="material-symbols-outlined text-purple-600 dark:text-purple-300 text-xl">psychology</span>';
      html += '<div><h4 class="text-brand-dark-gray dark:text-brand-white font-semibold text-sm leading-tight">Confidence Pulse</h4>';
      html += '<p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Certainty vs. accuracy snapshot</p></div>';
      html += '</div>';
      html += '<div class="text-xs px-2 py-1 rounded-md bg-purple-50 text-purple-700 dark:bg-purple-900/30 dark:text-purple-200 font-semibold">' + escapeHtml(statusLabel) + '</div>';
      html += '</div>';

      // Quick stats chips
      html += '<div class="flex flex-wrap gap-2 mb-3 text-xs font-semibold">';
      html += '<span class="px-2 py-1 rounded-md bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-200"> Correct: ' + (metacognition.correctCount || 0) + '</span>';
      html += '<span class="px-2 py-1 rounded-md bg-rose-50 text-rose-700 dark:bg-rose-900/30 dark:text-rose-200"> Incorrect: ' + (metacognition.incorrectCount || 0) + '</span>';
      html += '<span class="px-2 py-1 rounded-md bg-slate-100 text-slate-700 dark:bg-slate-800/50 dark:text-slate-200"> Unanswered: ' + (metacognition.unansweredCount || 0) + '</span>';
      html += '</div>';

      html += '<div class="grid grid-cols-1 sm:grid-cols-2 gap-2">';
      matrixDefs.forEach(function (def) {
        var pct = metacognition.matrixPercentages && typeof metacognition.matrixPercentages[def.key] === 'number' ? metacognition.matrixPercentages[def.key] : 0;
        var count = metacognition.matrixCounts && typeof metacognition.matrixCounts[def.key] === 'number' ? metacognition.matrixCounts[def.key] : 0;

        // Find students in this category
        var categoryStudents = [];
        if (Array.isArray(currentStudentStatusData)) {
          categoryStudents = currentStudentStatusData.filter(function (s) {
            if (s.status !== 'Submitted' || !s.confidence) return false;
            var isRight = s.isCorrect === true;
            var isSure = s.confidence >= 0.75; // Logic used in Model_Analytics.gs for matrix

            // Simplified matching based on matrix keys
            if (def.key === 'confidentCorrect') return isSure && isRight;
            if (def.key === 'confidentIncorrect') return isSure && !isRight;
            if (def.key === 'uncertainCorrect') return !isSure && isRight;
            if (def.key === 'uncertainIncorrect') return !isSure && !isRight;
            return false;
          });
        }

        html += '<div class="confidence-row flex flex-col">';
        html += '<div class="flex items-center justify-between gap-2">';
        html += '<div class="flex items-center gap-1.5"><span class="text-sm">' + def.emoji + '</span><span class="text-xs font-semibold ' + def.textClass + '">' + def.label + '</span></div>';
        html += '<span class="text-sm font-bold ' + def.textClass + '">' + pct + '%</span>';
        html += '</div>';
        html += '<div class="confidence-bar-track my-1"><div class="confidence-bar-fill ' + def.barClass + '" style="width:' + pct + '%"></div></div>';

        // Students List in this quadrant
        if (categoryStudents.length > 0) {
          html += '<div class="flex flex-wrap gap-1 mt-1 mb-2">';
          categoryStudents.forEach(function (s) {
            html += '<span class="px-1.5 py-0.5 rounded bg-white/50 dark:bg-black/20 text-[10px] font-medium border border-black/5 truncate max-w-full">' + escapeHtml(formatStudentName(s)) + '</span>';
          });
          html += '</div>';
        }

        html += '<div class="flex items-center justify-between text-[11px] text-brand-dark-gray/60 dark:text-brand-white/60 mt-auto">';
        html += '<span>' + count + ' students</span>';
        html += '<span>live</span>';
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';

      if (flagged.length > 0) {
        html += '<div class="rounded-lg border border-rose-500/40 bg-rose-500/10 p-2 mt-2">';
        html += '<div class="flex items-center gap-1 mb-1">';
        html += '<span class="material-symbols-outlined text-sm text-rose-700 dark:text-rose-200">report</span>';
        html += '<span class="text-xs font-semibold text-rose-700 dark:text-rose-200">' + flagged.length + ' confidently wrong</span>';
        html += '</div>';
        html += '<div class="flex flex-wrap gap-1">';
        flagged.forEach(function (student) {
          var display = escapeHtml(student.name || student.email || 'Student');
          html += '<span class="px-1.5 py-0.5 rounded bg-white/70 text-xs font-medium text-rose-700 dark:bg-rose-900/40 dark:text-rose-100">' + display + '</span>';
        });
        html += '</div>';
        html += '</div>';
      }

      card.innerHTML = html;
      container.appendChild(card);
    }

    // Global filters for student status panel
    var studentStatusFilter = 'all';
    var studentCorrectnessFilter = 'all';
    var violationsAlertDismissed = false;

    function normalizeProctorStatus(status) {
      if (status === null || status === undefined) { return null; }
      var normalized = status.toString().trim().toLowerCase();
      var collapsed = normalized.replace(/\s+/g, '_');
      if (collapsed.indexOf('blocked') === 0) { return 'BLOCKED'; }
      if (collapsed.indexOf('awaiting_fullscreen') === 0 || collapsed.indexOf('awaitingfullscreen') === 0 || collapsed.indexOf('awaiting_full_screen') === 0) {
        return 'AWAITING_FULLSCREEN';
      }
      if ((collapsed.indexOf('locked') === 0 || (collapsed.indexOf('locked') > 0 && collapsed.indexOf('unlocked') === -1)) ||
        (collapsed.indexOf('approval') !== -1 && collapsed.indexOf('unlocked') === -1)) {
        return 'LOCKED';
      }
      return null;
    }

    function deriveProctorStatus(student) {
      if (!student) { return null; }
      return normalizeProctorStatus(student.status || student.proctorStatus || null);
    }

    function isLockedStatus(student) {
      return deriveProctorStatus(student) === 'LOCKED';
    }

    function isAwaitingFullscreenStatus(student) {
      return deriveProctorStatus(student) === 'AWAITING_FULLSCREEN';
    }

    function isBlockedStatus(student) {
      return deriveProctorStatus(student) === 'BLOCKED';
    }

    function needsUnlockAttention(student) {
      var normalized = deriveProctorStatus(student);
      return normalized === 'LOCKED' || normalized === 'AWAITING_FULLSCREEN';
    }

    function updateViolationsAlert(flaggedStudents) {
      // REDESIGN: Populate the top-bar popover instead of the sidebar alert
      var popoverList = document.getElementById('locked-popover-list');
      if (!popoverList) return;

      if (!flaggedStudents || flaggedStudents.length === 0) {
        popoverList.innerHTML = '<div class="text-xs text-center text-gray-500 py-4 italic">No students need attention</div>';
        return;
      }

      var html = '';
      flaggedStudents.forEach(function (student) {
        var isLocked = needsUnlockAttention(student);
        var isBlocked = isBlockedStatus(student);

        html += '<div class="flex items-center justify-between gap-3 p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-100 dark:border-gray-700">';
        html += '<div class="flex flex-col min-w-0">';
        html += '<span class="text-xs font-bold truncate text-gray-900 dark:text-white">' + escapeHtml(formatStudentName(student)) + '</span>';
        html += '<span class="text-[10px] text-gray-500 dark:text-gray-400">' + (isLocked ? 'Locked' : 'Blocked') + '</span>';
        html += '</div>';

        if (isLocked) {
          html += '<button class="quick-approve-btn flex items-center justify-center h-8 w-8 rounded-full bg-amber-100 hover:bg-amber-200 text-amber-900 transition-colors" data-email="' + student.email + '" data-poll-id="' + CURRENT_POLL_DATA.pollId + '" data-lock-version="' + (student.lockVersion || 0) + '" title="Approve re-entry">';
          html += '<span class="material-symbols-outlined text-base">lock_open</span>';
          html += '</button>';
        } else if (isBlocked) {
          html += '<button class="quick-unblock-btn flex items-center justify-center h-8 w-8 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-900 transition-colors" data-email="' + student.email + '" title="Unblock Student">';
          html += '<span class="material-symbols-outlined text-base">person_check</span>';
          html += '</button>';
        }

        html += '</div>';
      });

      popoverList.innerHTML = html;

      // Event Listeners
      popoverList.querySelectorAll('.quick-approve-btn').forEach(function (btn) {
        btn.onclick = async function (e) {
          e.stopPropagation();
          var email = this.dataset.email;
          var pollId = this.dataset.pollId;
          var lockVersion = parseInt(this.dataset.lockVersion, 10);
          await approveStudentUnlock(email, pollId, lockVersion, this, { skipConfirm: true });
        };
      });

      popoverList.querySelectorAll('.quick-unblock-btn').forEach(function (btn) {
        btn.onclick = async function (e) {
          e.stopPropagation();
          var email = this.dataset.email;
          await requestTeacherUnblock(email, this);
        };
      });
    }

    function notifyLockoutToasts(flaggedStudents) {
      if (!Array.isArray(flaggedStudents) || flaggedStudents.length === 0) {
        lockToastState = {};
        return;
      }

      // FIX: Only show toasts for LOCKED students (new violations), not AWAITING_FULLSCREEN
      // AWAITING_FULLSCREEN means the teacher already approved re-entry - no need for more toasts
      var actionable = flaggedStudents.filter(function (student) {
        if (!student) { return false; }
        var normalized = deriveProctorStatus(student);
        return normalized === 'LOCKED';
      });

      var activeEmails = new Set();

      actionable.forEach(function (student) {
        var email = student.email || '';
        if (!email) return;

        var lockVersion = parseInt(student.lockVersion, 10);
        if (isNaN(lockVersion)) {
          lockVersion = 0;
        }

        activeEmails.add(email);

        if (lockToastState[email] === lockVersion) {
          return;
        }

        lockToastState[email] = lockVersion;

        // var studentName = formatStudentName(student);

        // Disabled redundant toast per user request - status is visible on tile
        // showToast('warning', 'Approve re-entry', studentName + ' exited fullscreen or switched tabs.', 6000, {
        //   label: 'Approve',
        //   onClick: function () {
        //     if (!CURRENT_POLL_DATA || !CURRENT_POLL_DATA.pollId) return;
        //     approveStudentUnlock(email, CURRENT_POLL_DATA.pollId, lockVersion, null, { skipConfirm: true });
        //   }
        // });
      });

      Object.keys(lockToastState).forEach(function (email) {
        if (!activeEmails.has(email)) {
          delete lockToastState[email];
        }
      });
    }

    function updateLockoutBanner() {
      var banner = document.getElementById('lockout-alert-banner');
      if (banner) {
        banner.classList.add('hidden');
        banner.setAttribute('aria-hidden', 'true');
      }
    }

    /**
     * Update the persistent locked students alert panel
     * Shows prominent unlock buttons for all locked students
     */
    function updateLockedStudentsAlert(lockedStudents) {
      var alertPanel = document.getElementById('locked-students-alert');
      var buttonsContainer = document.getElementById('locked-students-buttons');
      var titleEl = document.getElementById('locked-alert-title');

      if (!alertPanel || !buttonsContainer) return;

      if (!lockedStudents || lockedStudents.length === 0) {
        alertPanel.classList.add('hidden');
        return;
      }

      alertPanel.classList.remove('hidden');

      if (titleEl) {
        titleEl.textContent = lockedStudents.length + ' Student' + (lockedStudents.length > 1 ? 's' : '') + ' Locked Out';
      }

      var html = '';
      lockedStudents.forEach(function (student) {
        var name = formatStudentName(student);
        var lockVersion = student.lockVersion || 0;
        html += '<button class="locked-student-unlock-btn flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-bold rounded-lg shadow-sm transition-colors" ';
        html += 'data-email="' + escapeHtml(student.email) + '" ';
        html += 'data-lock-version="' + lockVersion + '">';
        html += '<span class="material-symbols-outlined text-base">lock_open</span>';
        html += '<span>Unlock ' + escapeHtml(name) + '</span>';
        html += '</button>';
      });

      buttonsContainer.innerHTML = html;

      // Attach click handlers
      buttonsContainer.querySelectorAll('.locked-student-unlock-btn').forEach(function (btn) {
        btn.onclick = async function () {
          var email = this.dataset.email;
          var lockVersion = parseInt(this.dataset.lockVersion, 10);
          if (!CURRENT_POLL_DATA || !CURRENT_POLL_DATA.pollId) {
            await veritasAlert('No active poll found.', { title: 'Error', destructive: true });
            return;
          }
          this.disabled = true;
          this.innerHTML = '<span class="material-symbols-outlined text-base animate-spin">progress_activity</span><span>Unlocking...</span>';
          await approveStudentUnlock(email, CURRENT_POLL_DATA.pollId, lockVersion, this, { skipConfirm: true });
        };
      });
    }

    /**
     * ENHANCED: Update exited students panel (2025)
     * More visible and functional than the violations alert
     */
    function updateExitedStudentsPanel(lockedStudents) {
      var panel = document.getElementById('exited-students-panel');
      if (panel) {
        panel.classList.add('hidden');
      }
    }

    /**
     * Approve all locked students at once
     */
    async function approveAllUnlocks() {
      if (!CURRENT_POLL_DATA || !CURRENT_POLL_DATA.pollId) return;

      var lockedStudents = currentStudentStatusData.filter(function (s) {
        return isLockedStatus(s);
      });

      if (lockedStudents.length === 0) {
        await veritasAlert('No students are currently locked.', { title: 'No students to approve' });
        return;
      }

      var confirmed = await veritasConfirm(
        'Approve re-entry for all ' + lockedStudents.length + ' locked student(s)?',
        {
          title: 'Approve All',
          confirmText: 'Approve All (' + lockedStudents.length + ')'
        }
      );

      if (!confirmed) return;

      // Disable the approve all button
      var approveAllBtn = document.getElementById('approve-all-unlocks-btn');
      if (approveAllBtn) {
        approveAllBtn.disabled = true;
        approveAllBtn.querySelector('span:last-child').textContent = 'Approving...';
      }

      // Approve each student
      var successCount = 0;
      var failCount = 0;

      for (var i = 0; i < lockedStudents.length; i++) {
        var student = lockedStudents[i];
        try {
          var manageProctoring = firebase.functions().httpsCallable('manageProctoring');
          var safeLockVersion = parseInt(student.lockVersion, 10);
          if (isNaN(safeLockVersion)) safeLockVersion = 0;

          var response = await manageProctoring({
            action: 'UNLOCK',
            studentEmail: student.email,
            pollId: CURRENT_POLL_DATA.pollId,
            lockVersion: safeLockVersion
          });

          if (response.data && response.data.success) {
            successCount++;
            // Update local status
            currentStudentStatusData = currentStudentStatusData.map(function (s) {
              if (s.email === student.email) {
                return {
                  name: s.name,
                  email: s.email,
                  status: 'AWAITING_FULLSCREEN',
                  lockVersion: response.data.lockVersion || student.lockVersion,
                  lockReason: s.lockReason,
                  lockedAt: s.lockedAt,
                  answer: s.answer,
                  isCorrect: s.isCorrect,
                  timestamp: s.timestamp
                };
              }
              return s;
            });
          } else {
            failCount++;
          }
        } catch (error) {
          failCount++;
        }
      }

      // Re-render status
      renderStudentStatus();

      // Re-enable button
      if (approveAllBtn) {
        approveAllBtn.disabled = false;
        approveAllBtn.querySelector('span:last-child').textContent = 'Approve All';
      }

      // Show result - simple toast notification
      if (successCount > 0) {
        var toastMsg = 'Approved ' + successCount + ' student(s)';
        if (failCount > 0) {
          toastMsg += ', ' + failCount + ' failed';
        }
        showToast('success', 'Batch Approval Complete', toastMsg, 4000);
      } else {
        showToast('error', 'Approval Failed', 'Failed to approve students. Please try again.', 4000);
      }
    }

    /**
     * Helper: Get time ago string
     */
    function getTimeAgo(date) {
      var seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'just now';
      if (seconds < 120) return '1 minute ago';
      if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
      if (seconds < 7200) return '1 hour ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
      return Math.floor(seconds / 86400) + ' days ago';
    }

    async function approveStudentUnlock(email, pollId, lockVersion, buttonElement, options) {
      if (!email || !pollId) return;

      options = options || {};

      // Ensure lockVersion is a valid number to prevent server errors
      lockVersion = parseInt(lockVersion, 10);
      if (isNaN(lockVersion)) {
        lockVersion = 0;
      }

      if (!options.skipConfirm) {
        var approved = await veritasConfirm('Approve unlock for ' + email + '?', {
          title: 'Approve unlock',
          confirmText: 'Approve'
        });
        if (!approved) {
          return;
        }
      }

      if (buttonElement) {
        buttonElement.disabled = true;
        buttonElement.querySelector('span:last-child').textContent = 'Unlocking...';
      }

      if (PREVIEW_MODE) {
        await previewOnlyNotice('approve unlock requests');
        if (buttonElement) {
          buttonElement.disabled = false;
          buttonElement.querySelector('span:last-child').textContent = formatStudentName(email);
        }
        return;
      }

      recordTeacherAction('Unlock ' + email);

      // FIREBASE MIGRATION: Approve unlock via Cloud Function
      firebase.functions().httpsCallable('manageRoster')({
        action: 'APPROVE_UNLOCK',
        pollId: pollId,
        studentEmail: email,
        lockVersion: lockVersion
      }).then(function (result) {
        var response = result.data;
        if (response && response.success) {
          // Success: Instant UI feedback is good, but RTDB listener handles the source of truth
          if (buttonElement) {
            buttonElement.disabled = false;
            var lastSpan = buttonElement.querySelector('span:last-child');
            if (lastSpan) lastSpan.textContent = 'Unlocked';

            setTimeout(function () {
              if (currentManagedStudent && currentManagedStudent.email === email) {
                populateStudentModal(currentManagedStudent);
              }
            }, 1000);
          }
          showToast('success', 'Unlocked', email + ' has been approved to rejoin.');
        } else {
          throw new Error((response && response.error) || 'Failed to approve unlock');
        }
      }).catch(function (error) {
        if (buttonElement) {
          buttonElement.disabled = false;
          var lastSpan = buttonElement.querySelector('span:last-child');
          if (lastSpan) lastSpan.textContent = 'Approve Unlock';
        }
        handleError(error);
      });
    }

    /**
     * Force unlock a student when server has no lock record but student is locked client-side.
     * This handles the edge case where Firebase reported a violation but the server call failed.
     */
    async function teacherForceUnlock(email, pollId, buttonElement) {
      try {
        var manageProctoring = firebase.functions().httpsCallable('manageProctoring');
        var response = await manageProctoring({
          action: 'RESET',
          studentEmail: email,
          pollId: pollId
        });

        if (response.data && response.data.success) {
          // SUCCESS: Now write to Firebase for instant student feedback
          setFirebaseStatus(email, 'ACTIVE');
          currentStudentStatusData = currentStudentStatusData.map(function (s) {
            if (s.email === email) {
              return {
                name: s.name,
                email: s.email,
                status: 'AWAITING_FULLSCREEN',
                lockVersion: response.data.lockVersion || 0,
                lockReason: s.lockReason,
                lockedAt: s.lockedAt,
                answer: s.answer,
                isCorrect: s.isCorrect,
                timestamp: s.timestamp
              };
            }
            return s;
          });
          renderStudentStatus();
          // Simple toast notification instead of blocking alert dialog
          showToast('success', 'Approval Successful', 'Student can now re-enter fullscreen.', 3000);
        } else {
          await veritasAlert(response.data?.reason || 'Failed to force unlock student.', {
            title: 'Unlock failed',
            destructive: true
          });
          if (buttonElement) {
            buttonElement.disabled = false;
            var lastSpan = buttonElement.querySelector('span:last-child');
            if (lastSpan) lastSpan.textContent = formatStudentName(email);
          }
        }
      } catch (error) {
        await veritasAlert('Error: ' + (error.message || error), {
          title: 'Force unlock failed',
          destructive: true
        });
        if (buttonElement) {
          buttonElement.disabled = false;
          buttonElement.querySelector('span:last-child').textContent = formatStudentName(email);
        }
      }
    }

    function createResetButton(student) {
      var button = document.createElement('button');
      button.className = 'reset-btn flex-shrink-0 flex items-center justify-center gap-1 h-7 px-2.5 rounded-md bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-xs font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors';
      button.dataset.email = student.email || '';
      var icon = document.createElement('span');
      icon.className = 'material-symbols-outlined text-sm';
      icon.textContent = 'refresh';
      var label = document.createElement('span');
      label.textContent = 'Reset';
      button.appendChild(icon);
      button.appendChild(label);
      return button;
    }

    function createUnlockButton(student) {
      var button = document.createElement('button');
      button.className = 'unlock-btn flex-shrink-0 flex items-center justify-center gap-1 h-8 px-3 rounded-md bg-red-600 text-white text-xs font-bold hover:bg-red-700 transition-colors shadow-sm';
      button.dataset.email = student.email || '';
      if (CURRENT_POLL_DATA && CURRENT_POLL_DATA.pollId !== undefined) {
        button.dataset.pollId = CURRENT_POLL_DATA.pollId;
      }
      button.dataset.lockVersion = student.lockVersion != null ? student.lockVersion : 0;
      var icon = document.createElement('span');
      icon.className = 'material-symbols-outlined text-sm';
      icon.textContent = 'lock_open';
      var label = document.createElement('span');
      label.textContent = 'Approve';
      button.appendChild(icon);
      button.appendChild(label);
      return button;
    }

    function createBlockButton(student) {
      var button = document.createElement('button');
      button.className = 'block-btn flex-shrink-0 flex items-center justify-center gap-1 h-8 px-3 rounded-md bg-amber-500/10 text-amber-700 dark:text-amber-300 dark:bg-amber-500/20 text-xs font-semibold hover:bg-amber-500/20 dark:hover:bg-amber-500/30 transition-colors';
      button.dataset.email = student.email || '';
      var icon = document.createElement('span');
      icon.className = 'material-symbols-outlined text-sm';
      icon.textContent = 'block';
      var label = document.createElement('span');
      label.textContent = 'Block';
      button.appendChild(icon);
      button.appendChild(label);
      return button;
    }

    function createUnblockButton(student) {
      var button = document.createElement('button');
      button.className = 'unblock-btn flex-shrink-0 flex items-center justify-center gap-1 h-8 px-3 rounded-md bg-green-500/10 text-green-700 dark:text-green-300 dark:bg-green-500/20 text-xs font-semibold hover:bg-green-500/20 dark:hover:bg-green-500/30 transition-colors';
      button.dataset.email = student.email || '';
      var icon = document.createElement('span');
      icon.className = 'material-symbols-outlined text-sm';
      icon.textContent = 'lock_open';
      var label = document.createElement('span');
      label.textContent = 'Unblock';
      button.appendChild(icon);
      button.appendChild(label);
      return button;
    }

    function setButtonLoadingState(button, label) {
      if (!button) {
        return function () { };
      }
      var originalHtml = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<span class="material-symbols-outlined text-sm animate-spin">progress_activity</span><span>' + label + '</span>';
      return function () {
        button.disabled = false;
        button.innerHTML = originalHtml;
      };
    }

    function runTeacherBlock(email, pollId, reason) {
      return new Promise(function (resolve, reject) {
        var manageProctoring = firebase.functions().httpsCallable('manageProctoring');
        manageProctoring({
          action: 'BLOCK',
          studentEmail: email,
          pollId: pollId,
          reason: reason || ''
        })
          .then(function (result) {
            resolve(result.data);
          })
          .catch(reject);
      });
    }

    function runTeacherUnblock(email, pollId) {
      return new Promise(function (resolve, reject) {
        var manageProctoring = firebase.functions().httpsCallable('manageProctoring');
        manageProctoring({
          action: 'UNBLOCK',
          studentEmail: email,
          pollId: pollId
        })
          .then(function (result) {
            resolve(result.data);
          })
          .catch(reject);
      });
    }

    async function requestTeacherBlock(student, buttonElement) {
      if (!student || !student.email) return;
      var pollId = CURRENT_POLL_DATA && CURRENT_POLL_DATA.pollId;
      if (pollId === undefined) {
        await veritasAlert('Start a poll before blocking students.', { title: 'No active poll' });
        return;
      }

      var displayName = formatStudentName(student);
      var confirmed = await veritasConfirm('Temporarily block ' + displayName + ' from responding? This will be recorded for proctoring.', {
        title: 'Block Student',
        confirmText: 'Block',
        destructive: true
      });
      if (!confirmed) return;

      var restore = setButtonLoadingState(buttonElement, 'Blocking...');
      try {
        // 1. FIREBASE WRITE (Instant)
        // 'BLOCKED' or 'LOCKED' depending on implementation. The user asked for "Lock/Unlock buttons that write to RTDB".
        // The contract says: ACTIVE | LOCKED | DISCONNECTED | FINISHED
        // So we write 'LOCKED'.
        setFirebaseStatus(student.email, 'LOCKED');

        // 2. SERVER WRITE (Canonical)
        await runTeacherBlock(student.email, pollId, '');
        pollForResults();
      } catch (error) {
        restore();
        handleError(error);
      }
    }

    async function requestTeacherUnblock(email, buttonElement) {
      if (!email) return;
      var pollId = CURRENT_POLL_DATA && CURRENT_POLL_DATA.pollId;
      if (pollId === undefined) {
        await veritasAlert('Start a poll before unblocking students.', { title: 'No active poll' });
        return;
      }

      var student = currentStudentStatusData.find(function (s) { return s.email === email; });
      var displayName = formatStudentName(student || email);
      var confirmed = await veritasConfirm('Unblock ' + displayName + '?', {
        title: 'Unblock Student',
        confirmText: 'Unblock'
      });
      if (!confirmed) return;

      var restore = setButtonLoadingState(buttonElement, 'Unblocking...');
      try {
        await runTeacherUnblock(email, pollId);
        pollForResults();
      } catch (error) {
        restore();
        handleError(error);
      }
    }

    function buildStudentStatusTile(student) {
      var tile = document.createElement('div');

      var status = student.status || 'Unknown';
      var normalizedStatus = deriveProctorStatus(student) || status;
      var isLocked = normalizedStatus === 'LOCKED';
      var isAwaitingFullscreen = normalizedStatus === 'AWAITING_FULLSCREEN';
      var isBlocked = normalizedStatus === 'BLOCKED';
      var isCorrect = student.isCorrect === true;
      var isIncorrect = student.isCorrect === false;
      var name = formatStudentName(student);

      var tileClass = 'student-tile';
      if (isLocked || isAwaitingFullscreen) tileClass += ' locked animate-pulse-gentle';
      else if (isBlocked) tileClass += ' blocked';
      else if (student.status === 'Submitted') {
        tileClass += isCorrect ? ' submitted correct' : ' submitted incorrect';
      }

      tile.className = tileClass;

      var emoji = '';
      if (student.confidence) {
        emoji = (CONFIDENCE_LEVEL_STYLES[student.confidence] || {}).emoji || '';
      } else if (isLocked || isAwaitingFullscreen) {
        emoji = '';
      }

      var html = '<span class="text-lg shrink-0">' + emoji + '</span>';
      html += '<div class="flex-1 min-w-0 font-bold text-xs truncate">' + escapeHtml(name) + '</div>';

      if (isLocked || isAwaitingFullscreen) {
        // We'll still keep the icon but the main management is now top-bar
        html += '<span class="material-symbols-outlined text-rose-600 text-sm">warning</span>';
      }

      tile.innerHTML = html;
      return tile;
    }

    function buildStudentStatusRow(student) {
      var row = document.createElement('tr');
      row.className = 'border-b border-brand-light-gray/30 dark:border-brand-dark-gray/20 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/20';

      var nameCell = document.createElement('td');
      nameCell.className = 'px-3 py-2 text-sm font-semibold text-brand-dark-gray dark:text-brand-white truncate';
      nameCell.textContent = formatStudentName(student);
      row.appendChild(nameCell);

      var statusCell = document.createElement('td');
      statusCell.className = 'px-3 py-2 text-sm text-brand-dark-gray/80 dark:text-brand-white/80';
      var telemetryIndicators = buildTelemetryIndicators(student.telemetry);
      if (telemetryIndicators) {
        statusCell.appendChild(telemetryIndicators);
      }
      var statusLabel = document.createElement('span');
      statusLabel.textContent = student.status || 'Unknown';
      statusCell.appendChild(statusLabel);
      row.appendChild(statusCell);

      var answerCell = document.createElement('td');
      answerCell.className = 'px-3 py-2 text-sm text-brand-dark-gray/70 dark:text-brand-white/70 truncate';
      answerCell.textContent = student.answer || '';
      row.appendChild(answerCell);

      var confidenceCell = document.createElement('td');
      confidenceCell.className = 'px-3 py-2 text-sm text-brand-dark-gray/60 dark:text-brand-white/60 truncate';
      var confidenceText = describeConfidence(student.confidence);
      confidenceCell.textContent = confidenceText || '';
      row.appendChild(confidenceCell);

      var correctCell = document.createElement('td');
      correctCell.className = 'px-3 py-2 text-sm text-brand-dark-gray/70 dark:text-brand-white/70 text-center';
      if (student.isCorrect === true) {
        correctCell.textContent = '';
      } else if (student.isCorrect === false) {
        correctCell.textContent = '';
      } else {
        correctCell.textContent = '';
      }
      row.appendChild(correctCell);

      var violations = (student.sessionViolations || 0) + (student.sessionExits || 0);
      var violationsCell = document.createElement('td');
      violationsCell.className = 'px-3 py-2 text-sm text-brand-dark-gray/70 dark:text-brand-white/70 text-center';
      violationsCell.textContent = violations > 0 ? violations : '';
      row.appendChild(violationsCell);

      var actionsCell = document.createElement('td');
      actionsCell.className = 'px-3 py-2 text-sm text-right space-x-2';
      var actionElements = [];
      var normalizedStatus = deriveProctorStatus(student) || student.status;
      if (student.status === 'Submitted') {
        actionElements.push(createResetButton(student));
        actionElements.push(createBlockButton(student));
      } else if (student.status === 'Waiting...') {
        actionElements.push(createBlockButton(student));
      } else if (normalizedStatus === 'LOCKED') {
        actionElements.push(createUnlockButton(student));
      } else if (normalizedStatus === 'AWAITING_FULLSCREEN') {
        actionElements.push(createBlockButton(student));
      } else if (normalizedStatus === 'BLOCKED') {
        actionElements.push(createUnblockButton(student));
      }
      actionElements.forEach(function (el) { actionsCell.appendChild(el); });
      row.appendChild(actionsCell);

      return row;
    }

    function renderStudentStatus() {
      var grid = document.getElementById('student-status-grid');
      var tbody = document.getElementById('student-status-tbody');
      var container = grid || tbody;
      if (!container) return;

      syncStatusFilterButtons();

      var students = Array.isArray(currentStudentStatusData) ? currentStudentStatusData.slice() : [];

      if (studentSearchQuery) {
        var query = studentSearchQuery.toLowerCase();
        students = students.filter(function (student) {
          var fields = [
            (student.displayName || student.name || '').toLowerCase(),
            (student.firstName || '').toLowerCase(),
            (student.lastName || '').toLowerCase(),
            (student.email || '').toLowerCase(),
            (student.status || '').toLowerCase(),
            (student.answer || '').toLowerCase(),
            (describeConfidence(student.confidence) || '').toLowerCase()
          ];
          return fields.some(function (value) { return value && value.indexOf(query) !== -1; });
        });
      }

      // CRITICAL: Always include LOCKED/BLOCKED students regardless of filter for visibility
      var isLockedOrBlocked = function (s) {
        var normalized = deriveProctorStatus(s);
        return normalized === 'LOCKED' || normalized === 'AWAITING_FULLSCREEN' || normalized === 'BLOCKED';
      };

      if (studentStatusFilter === 'waiting') {
        students = students.filter(function (s) { return (s.status || '').toLowerCase() === 'waiting...' || isLockedOrBlocked(s); });
      } else if (studentStatusFilter === 'submitted') {
        students = students.filter(function (s) { return s.status === 'Submitted' || isLockedOrBlocked(s); });
      } else if (studentStatusFilter === 'locked') {
        students = students.filter(function (s) {
          var normalized = deriveProctorStatus(s);
          return normalized === 'LOCKED' || normalized === 'AWAITING_FULLSCREEN';
        });
      } else if (studentStatusFilter === 'blocked') {
        students = students.filter(function (s) { return deriveProctorStatus(s) === 'BLOCKED'; });
      }

      if (studentCorrectnessFilter === 'correct') {
        students = students.filter(function (s) { return s.isCorrect === true; });
      } else if (studentCorrectnessFilter === 'incorrect') {
        students = students.filter(function (s) { return s.isCorrect === false; });
      } else if (studentCorrectnessFilter === 'unanswered') {
        students = students.filter(function (s) { return s.status !== 'Submitted'; });
      }

      if (!studentTableSort || !studentTableSort.column) {
        studentTableSort = { column: 'lastName', direction: 'asc' };
      }

      var dirMultiplier = studentTableSort.direction === 'desc' ? -1 : 1;

      function compareStrings(a, b) {
        var aVal = (a || '').toString().toLowerCase();
        var bVal = (b || '').toString().toLowerCase();
        if (aVal < bVal) return -1;
        if (aVal > bVal) return 1;
        return 0;
      }

      function compareNumbers(a, b) {
        return (a || 0) - (b || 0);
      }

      var statusOrder = {
        'BLOCKED': 0,
        'LOCKED': 1,
        'AWAITING_FULLSCREEN': 2,
        'Submitted': 3,
        'Waiting...': 4
      };

      function statusRank(status) {
        var normalized = normalizeProctorStatus(status);
        var key = normalized || status;
        return statusOrder[key] !== undefined ? statusOrder[key] : 5;
      }

      function correctnessRank(student) {
        if (student.isCorrect === true) return 2;
        if (student.isCorrect === false) return 1;
        return 0;
      }

      students.sort(function (a, b) {
        var result = 0;
        switch (studentTableSort.column) {
          case 'firstName':
            result = compareStrings(a.firstName || a.displayName || a.name, b.firstName || b.displayName || b.name);
            break;
          case 'lastName':
            result = compareStrings(a.lastName || '', b.lastName || '');
            if (result === 0) {
              result = compareStrings(a.firstName || '', b.firstName || '');
            }
            break;
          case 'status':
            result = compareNumbers(statusRank(a.status), statusRank(b.status));
            break;
          case 'correct':
            result = compareNumbers(correctnessRank(a), correctnessRank(b));
            break;
          case 'violations':
            result = compareNumbers((a.sessionViolations || 0) + (a.sessionExits || 0), (b.sessionViolations || 0) + (b.sessionExits || 0));
            break;
          case 'recent':
            result = compareNumbers(a.timestamp || 0, b.timestamp || 0);
            break;
          case 'email':
            result = compareStrings(a.email || '', b.email || '');
            break;
          default:
            result = compareStrings(a.displayName || a.name || '', b.displayName || b.name || '');
        }
        if (result === 0) {
          result = compareStrings(a.email || '', b.email || '');
        }
        return result * dirMultiplier;
      });

      var correctCount = 0;
      var lockedCount = 0;
      var waitingCount = 0;
      var blockedCount = 0;
      var flaggedStudents = [];
      var lockedStudents = [];

      currentStudentStatusData.forEach(function (student) {
        if (student.status === 'Submitted' && student.isCorrect === true) {
          correctCount++;
        }
        var normalized = deriveProctorStatus(student);
        if (normalized === 'LOCKED' || normalized === 'AWAITING_FULLSCREEN') {
          lockedCount++;
          flaggedStudents.push(student);
          if (normalized === 'LOCKED') {
            lockedStudents.push(student);
          }
        } else if (normalized === 'BLOCKED') {
          blockedCount++;
          flaggedStudents.push(student);
        }
        if ((student.status || '').toLowerCase() === 'waiting...') {
          waitingCount++;
        }
      });

      var correctCountEl = document.getElementById('correct-count');
      if (correctCountEl) correctCountEl.textContent = correctCount;
      var lockedCountEl = document.getElementById('locked-count');
      if (lockedCountEl) lockedCountEl.textContent = lockedCount;
      var blockedCountEl = document.getElementById('blocked-count');
      if (blockedCountEl) blockedCountEl.textContent = blockedCount;
      var waitingCountEl = document.getElementById('waiting-count');
      if (waitingCountEl) waitingCountEl.textContent = waitingCount;

      updateLiveOverviewCounts(lockedCount, blockedCount, waitingCount);
      updateViolationsAlert(flaggedStudents);
      notifyLockoutToasts(flaggedStudents);
      updateLockedStudentsAlert(lockedStudents);

      if (tbody) tbody.innerHTML = '';
      if (grid) grid.innerHTML = '';

      var fragment = document.createDocumentFragment();
      students.forEach(function (student) {
        // REDESIGN: Only show students who HAVEN'T submitted in the grid
        // Students who submitted are moved to the Confidence Pulse
        if (student.status !== 'Submitted' || isLockedOrBlocked(student)) {
          if (grid) {
            fragment.appendChild(buildStudentStatusTile(student));
          } else if (tbody) {
            fragment.appendChild(buildStudentStatusRow(student));
          }
        }
      });

      container.appendChild(fragment);

      container.querySelectorAll('.unlock-btn').forEach(function (btn) {
        btn.onclick = async function () {
          var email = this.dataset.email;
          var pollId = this.dataset.pollId;
          var lockVersion = parseInt(this.dataset.lockVersion, 10);
          await approveStudentUnlock(email, pollId, lockVersion, this);
        };
      });

      container.querySelectorAll('.reset-btn').forEach(function (btn) {
        btn.onclick = function () {
          var email = this.dataset.email;
          var pollId = CURRENT_POLL_DATA.pollId;
          var questionIndex = CURRENT_POLL_DATA.questionIndex;
          if (!email || pollId === undefined || questionIndex === undefined) return;
          var button = this;
          var originalHtml = button.innerHTML;
          button.disabled = true;
          var label = button.querySelector('span:last-child');
          if (label) label.textContent = 'Resetting...';
          // FIREBASE MIGRATION: Reset Student Response via RTDB
          var emailKey = generateStudentKey(email);
          firebase.database().ref('answers/' + pollId + '/' + questionIndex + '/' + emailKey).set(null)
            .then(function () {
              button.disabled = false;
              button.innerHTML = originalHtml;
              pollForResults(); // Trigger UI check
            })
            .catch(function (error) {
              handleError(error);
              button.disabled = false;
              button.innerHTML = originalHtml;
            });
        };
      });

      container.querySelectorAll('.block-btn').forEach(function (btn) {
        btn.onclick = async function () {
          var email = this.dataset.email;
          var student = currentStudentStatusData.find(function (s) { return s.email === email; });
          await requestTeacherBlock(student, this);
        };
      });

      container.querySelectorAll('.unblock-btn').forEach(function (btn) {
        btn.onclick = async function () {
          var email = this.dataset.email;
          await requestTeacherUnblock(email, this);
        };
      });
    }

    function buildTelemetryIndicators(telemetry) {
      if (!telemetry) return null;
      var container = document.createElement('span');
      container.className = 'inline-flex items-center gap-1 mr-2';

      var statusDot = document.createElement('span');
      statusDot.className = 'inline-flex h-2.5 w-2.5 rounded-full';
      var isIdle = telemetry.isIdle === true;
      statusDot.style.backgroundColor = isIdle ? '#f59e0b' : '#22c55e';
      statusDot.title = isIdle ? 'Idle' : 'Active';
      container.appendChild(statusDot);

      if (telemetry.usingCalculator) {
        var calcIcon = document.createElement('span');
        calcIcon.className = 'material-symbols-outlined text-base text-blue-500';
        calcIcon.textContent = 'calculate';
        calcIcon.title = 'Using calculator';
        container.appendChild(calcIcon);
      }

      if (typeof telemetry.timeOnQuestion === 'number') {
        var badge = document.createElement('span');
        badge.className = 'px-2 py-0.5 rounded-full text-xs bg-slate-100 text-slate-700';
        badge.textContent = formatTimeOnQuestion(telemetry.timeOnQuestion);
        badge.title = 'Time on current question';
        container.appendChild(badge);
      }

      return container;
    }

    function formatTimeOnQuestion(ms) {
      if (typeof ms !== 'number' || isNaN(ms)) return '--';
      var totalSeconds = Math.max(0, Math.floor(ms / 1000));
      var minutes = Math.floor(totalSeconds / 60);
      var seconds = totalSeconds % 60;
      return minutes + 'm ' + (seconds < 10 ? '0' + seconds : seconds) + 's';
    }

    function renderTelemetryPill(telemetry) {
      if (!telemetry) return '';
      var dotClass = telemetry.isIdle ? 'bg-amber-400' : 'bg-emerald-400';
      var timeLabel = typeof telemetry.timeOnQuestion === 'number'
        ? formatTimeOnQuestion(telemetry.timeOnQuestion)
        : '';
      var calcIcon = telemetry.usingCalculator ? '<span class="material-symbols-outlined text-sm text-blue-500">calculate</span>' : '';
      var timePart = timeLabel ? '<span>' + timeLabel + '</span>' : '';
      return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] bg-slate-100 text-slate-700 mr-2">
        <span class="h-2.5 w-2.5 rounded-full ${dotClass}"></span>
        <span>${telemetry.isIdle ? 'Idle' : 'Active'}</span>
        ${calcIcon}
        ${timePart}
      </span>`;
    }

    function pollForResults() {
      if (isPaused || !isLiveSession || isNavigating) return;
      var pollId = CURRENT_POLL_DATA.pollId;
      var questionIndex = CURRENT_POLL_DATA.questionIndex;
      if (!pollId || questionIndex === undefined) return;

      // FIREBASE MIGRATION: Polling is deprecated in favor of Realtime Listeners
      // `initFirebaseMissionControl` handles updates via `child_changed` / `child_added`.
      // We keep this function only as a connection heartbeat / fallback check.

      if (!realtimeConnected) {
        console.warn('[Firebase] Connection lost, attempting reconnect...');
        if (firebaseRef) {
          firebaseRef.once('value').then(function (snap) {
            // Force a full refresh if we reconnect
            if (snap.exists()) {
              console.log('[Firebase] Reconnected, refreshing data...');
              // Construct synthetic data object for updateLiveView
              // This requires a bit of mapping from FB format to App format
              // For now, we rely on the specific listeners to handle updates.
            }
          });
        }
      }
      return;

      /* LEGACY POLLING REMOVED
      
      google.script.run
        .withSuccessHandler(function (data) {
          // ...
          updateLiveView(data);
        })
        .getLivePollData(pollId, questionIndex);
      */
    }


    function restartPollingWithNewInterval() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
      if (!isPaused && isLiveSession) {
        pollInterval = setInterval(pollForResults, currentPollInterval);
      }
    }

    // --- Timer Controls ---
    // State variables
    var timerPresetSeconds = 90;        // Default timer duration (for compatibility)
    var timerRemainingSeconds = 90;     // Current countdown value (for compatibility)
    var timerExpiredHandled = false;    // Tracks if expiry event was processed
    var timerActive = false;            // Current running state

    // New timer implementation variables
    var totalSeconds = 90;              // Total seconds for new timer
    var isRunning = false;              // Is timer currently running
    var teacherCountdown = window.SecureAssessmentShared.createCountdown({
      onTick: function (seconds) {
        totalSeconds = seconds;
        timerRemainingSeconds = seconds;
        updateDisplay();
      },
      onExpire: function () {
        finishTimer();
      }
    });

    // Sidebar toggle state
    var sidebarVisible = true;

    /**
     * Toggles the sidebar visibility in live view
     */
    function toggleSidebar() {
      var sidebar = document.getElementById('live-sidebar');
      var icon = document.getElementById('sidebar-toggle-icon');
      var label = document.getElementById('sidebar-toggle-label');
      var toggleBtn = document.getElementById('toggle-sidebar-btn');

      if (!sidebar || !icon || !label) return;

      sidebarVisible = !sidebarVisible;

      if (sidebarVisible) {
        sidebar.classList.remove('w-0', 'hidden', 'lg:w-0');
        sidebar.classList.add('w-80', 'lg:w-96');
        icon.textContent = 'chevron_right';
        label.textContent = 'Hide Sidebar';
      } else {
        sidebar.classList.remove('w-80', 'lg:w-96');
        sidebar.classList.add('w-0', 'hidden', 'lg:w-0');
        icon.textContent = 'chevron_left';
        label.textContent = 'Show Sidebar';
      }

      if (toggleBtn) {
        toggleBtn.setAttribute('aria-expanded', sidebarVisible ? 'true' : 'false');
        toggleBtn.setAttribute('aria-label', sidebarVisible ? 'Hide student sidebar' : 'Show student sidebar');
      }
    }

    /**
     * Formats total seconds into MM:SS format
     * @param {number} seconds - The total seconds to format
     */
    function formatTime(seconds) {
      var safeSeconds = Math.max(0, Math.round(seconds || 0));
      var minutes = Math.floor(safeSeconds / 60);
      var remainingSeconds = safeSeconds % 60;

      // Use padStart equivalent to always show two digits
      var formattedMinutes = ('0' + minutes).slice(-2);
      var formattedSeconds = ('0' + remainingSeconds).slice(-2);

      return formattedMinutes + ':' + formattedSeconds;
    }

    // Legacy function for compatibility
    function formatSeconds(seconds) {
      return formatTime(seconds);
    }

    function updateHudTimer() {
      var paceValue = document.getElementById('hud-pace-value');
      if (!paceValue) return;

      var paceCaption = document.getElementById('hud-pace-caption');
      var paceChip = document.getElementById('hud-pace-chip');
      var paceChipIcon = document.getElementById('hud-pace-chip-icon');
      var paceChipLabel = document.getElementById('hud-pace-chip-label');

      paceValue.textContent = formatTime(totalSeconds);

      var variant = 'ready';
      var caption = 'Timer ready';
      var icon = 'pause_circle';
      var label = 'Ready';

      if (totalSeconds <= 0) {
        variant = 'complete';
        caption = 'All time used';
        icon = 'task_alt';
        label = 'Complete';
      } else if (isRunning) {
        if (totalSeconds <= 15) {
          variant = 'critical';
          caption = 'Wrap up now';
          icon = 'emergency';
          label = 'Critical';
        } else {
          variant = 'running';
          caption = 'Timer running';
          icon = 'play_arrow';
          label = 'Running';
        }
      } else if (totalSeconds < timerPresetSeconds) {
        variant = 'paused';
        caption = 'Paused  extend or resume';
        icon = 'pause_circle';
        label = 'Paused';
      }

      if (paceCaption) {
        paceCaption.textContent = caption;
      }
      if (paceChip) {
        paceChip.setAttribute('data-variant', variant);
      }
      if (paceChipIcon) {
        paceChipIcon.textContent = icon;
      }
      if (paceChipLabel) {
        paceChipLabel.textContent = label;
      }
    }

    /**
     * Updates the timer display on the screen
     */
    function updateDisplay() {
      var timerDisplay = document.getElementById('timer-display');
      if (!timerDisplay) return;

      timerDisplay.value = formatTime(totalSeconds);
      document.title = formatTime(totalSeconds) + ' - Veritas Live Poll';

      // Update legacy variables for compatibility
      timerRemainingSeconds = totalSeconds;

      // ENHANCED: Visual feedback based on time remaining
      var timerMainContainer = document.getElementById('timer-main-container');
      var timerCompactContainer = document.getElementById('timer-compact-container');
      var timerDisplayCompact = document.getElementById('timer-display-compact');

      // Sync compact timer display
      if (timerDisplayCompact) {
        timerDisplayCompact.value = formatTime(totalSeconds);
      }

      // Apply color feedback classes
      if (timerMainContainer) {
        // Remove all timer state classes
        timerMainContainer.classList.remove('timer-safe', 'timer-warning', 'timer-critical');

        // Apply new state class
        if (isRunning && totalSeconds > 0) {
          if (totalSeconds < 15) {
            timerMainContainer.classList.add('timer-critical');
          } else if (totalSeconds <= 30) {
            timerMainContainer.classList.add('timer-warning');
          } else {
            timerMainContainer.classList.add('timer-safe');
          }
        }
      }

      updateHudTimer();
    }

    /**
     * Toggles the UI state between running and paused
     */
    function toggleButtons(running) {
      isRunning = running;
      timerActive = running; // Update legacy variable

      var startBtn = document.getElementById('start-btn');
      var pauseBtn = document.getElementById('pause-btn');
      var add10sBtn = document.getElementById('add-10s-btn');
      var subtract10sBtn = document.getElementById('subtract-10s-btn');
      var timerDisplay = document.getElementById('timer-display');
      var add30sPresetBtn = document.getElementById('add-30s-btn-preset');
      var add60sPresetBtn = document.getElementById('add-60s-btn-preset');
      var mobileStartBtn = document.getElementById('mobile-start-btn');
      var mobilePauseBtn = document.getElementById('mobile-pause-btn');
      var mobileTimerLabel = document.getElementById('mobile-timer-label');
      var timerDisplayCompact = document.getElementById('timer-display-compact');
      var mobileAdd10sBtn = document.getElementById('add-10s-btn-mobile');
      var mobileSubtract10sBtn = document.getElementById('subtract-10s-btn-mobile');

      // Toggle Start/Pause buttons
      if (startBtn) startBtn.classList.toggle('hidden', running);
      if (pauseBtn) pauseBtn.classList.toggle('hidden', !running);
      if (mobileStartBtn) mobileStartBtn.classList.toggle('hidden', running);
      if (mobilePauseBtn) mobilePauseBtn.classList.toggle('hidden', !running);
      if (mobileTimerLabel) {
        if (running) {
          mobileTimerLabel.textContent = 'Running';
        } else if (totalSeconds < timerPresetSeconds) {
          mobileTimerLabel.textContent = 'Resume';
        } else {
          mobileTimerLabel.textContent = 'Start';
        }
      }

      // Disable editing buttons AND the input field while timer is running
      if (add10sBtn) add10sBtn.disabled = running;
      if (subtract10sBtn) subtract10sBtn.disabled = running;
      if (timerDisplay) timerDisplay.disabled = running;
      if (add30sPresetBtn) add30sPresetBtn.disabled = running;
      if (add60sPresetBtn) add60sPresetBtn.disabled = running;
      if (mobileAdd10sBtn) mobileAdd10sBtn.disabled = running;
      if (mobileSubtract10sBtn) mobileSubtract10sBtn.disabled = running;
      if (timerDisplayCompact) timerDisplayCompact.disabled = running;

      updateHudTimer();
    }

    /**
     * Starts the countdown
     */
    function startTimer() {
      if (isRunning || totalSeconds <= 0) return; // Do not start if already running or at 0

      toggleButtons(true);
      updateTimerStatus('Timer running', 'info');

      teacherCountdown.start(totalSeconds);
    }

    /**
     * Pauses the countdown
     */
    function pauseTimer() {
      if (!isRunning) return;

      teacherCountdown.pause();
      toggleButtons(false);
      updateTimerStatus('Timer paused at ' + formatTime(totalSeconds) + '.', 'info');
    }

    /**
     * Resets the timer to the default value
     */
    function resetTimer() {
      teacherCountdown.stop();
      totalSeconds = timerPresetSeconds;
      timerRemainingSeconds = totalSeconds;
      timerExpiredHandled = false;
      teacherCountdown.set(totalSeconds);
      toggleButtons(false);

      var timerDisplay = document.getElementById('timer-display');
      if (timerDisplay) {
        timerDisplay.classList.remove('timer-finished'); // Remove flash effect if present
      }

      updateTimerStatus('Timer reset to ' + formatTime(timerPresetSeconds) + '.', 'info');
      document.title = 'Veritas Live Poll';
    }

    /**
     * Called when the timer reaches 0
     */
    function finishTimer() {
      teacherCountdown.stop();
      toggleButtons(false);

      var timerDisplay = document.getElementById('timer-display');

      // Add flash animation
      if (timerDisplay) {
        timerDisplay.classList.add('timer-finished');

        // Remove class after animation finishes (1s)
        setTimeout(function () {
          timerDisplay.classList.remove('timer-finished');
        }, 1000);
      }

      // Handle timer expiry - pause the poll
      if (!timerExpiredHandled) {
        timerExpiredHandled = true;
        timerRemainingSeconds = 0;
        totalSeconds = 0;
        updateDisplay();
        updateTimerStatus('Time expired  poll paused.', 'danger');

        if (PREVIEW_MODE) {
          previewOnlyNotice('auto-pause the poll when the timer expires');
        } else {
          firebase.functions().httpsCallable('setLiveSessionState')({
            pollId: CURRENT_POLL_DATA.pollId,
            status: 'PAUSED',
            questionIndex: CURRENT_POLL_DATA.questionIndex || 0,
            metadata: {
              reason: 'TIMER_EXPIRED'
            }
          }).then(function (result) {
            var data = result.data;
            if (data && data.success) {
              isPaused = true;
              updateLiveView(data);
            } else {
              handleError(data.error || 'Failed to pause poll on timer expiry');
            }
          }).catch(handleError);
        }
      }
    }

    /**
     * Adds or subtracts time from the countdown
     * @param {number} secondsToAdd - The number of seconds to add (can be negative)
     */
    function editTime(secondsToAdd) {
      if (isRunning) return; // Do not edit while running

      totalSeconds += secondsToAdd;

      if (totalSeconds < 0) {
        totalSeconds = 0; // Do not allow time to go below zero
      }

      // Update legacy variables
      timerRemainingSeconds = totalSeconds;
      timerPresetSeconds = totalSeconds;

      teacherCountdown.set(totalSeconds);
    }

    /**
     * Parses the text from the input field and updates totalSeconds
     */
    function parseInputToTotalSeconds() {
      if (isRunning) return;

      var timerDisplay = document.getElementById('timer-display');
      if (!timerDisplay) return;

      var text = timerDisplay.value;
      var minutes = 0;
      var seconds = 0;

      if (text.includes(':')) {
        // Handle "MM:SS" format
        var parts = text.split(':');
        minutes = parseInt(parts[0], 10) || 0;
        seconds = parseInt(parts[1], 10) || 0;
        totalSeconds = (minutes * 60) + seconds;
      } else if (text.trim() !== '') {
        // Handle raw seconds format (e.g., "90")
        var parsedSeconds = parseInt(text, 10) || 0;
        totalSeconds = parsedSeconds;
      }

      // Update legacy variables
      timerRemainingSeconds = totalSeconds;
      timerPresetSeconds = totalSeconds;
      teacherCountdown.set(totalSeconds);
      updateHudTimer();
    }

    function updateTimerStatus(message, tone) {
      var statusEl = document.getElementById('timer-status-message');
      if (!statusEl) return;
      statusEl.textContent = message;
      if (tone === 'danger') {
        statusEl.className = 'text-xs text-red-600 dark:text-red-400 text-center font-medium';
      } else if (tone === 'success') {
        statusEl.className = 'text-xs text-green-600 dark:text-green-400 text-center font-medium';
      } else {
        statusEl.className = 'text-xs text-brand-dark-gray/60 dark:text-brand-white/60 text-center';
      }
    }

    // Legacy functions for compatibility
    function startTimerCountdown() {
      startTimer();
    }

    function pauseTimerCountdown() {
      pauseTimer();
    }

    function resetTimerCountdown() {
      resetTimer();
    }

    function stopVisualTimer() {
      teacherCountdown.stop();
      isRunning = false;
      timerActive = false;
    }

    function updateTimerInputs() {
      updateDisplay();
    }

    function updateTimerDisplay() {
      // Sync totalSeconds from timerRemainingSeconds for legacy code compatibility
      // Legacy code may set timerRemainingSeconds and expect the display to update
      if (timerRemainingSeconds !== totalSeconds) {
        totalSeconds = timerRemainingSeconds;
      }
      updateDisplay();
    }

    function adjustTimerPreset(delta) {
      editTime(delta);
    }

    // --- Student Link Controls ---
    async function onSendLink() {
      var btn = sendLinkBtn;
      if (!btn) {
        console.warn('Missing send link button');
        return;
      }
      var className = btn && btn.dataset.className;
      if (!className) {
        await veritasAlert('Please select a poll first.', { title: 'Send poll links' });
        return;
      }
      var confirmed = await veritasConfirm('This will email a new, unique poll link to all students in ' + className + '. Are you sure?', {
        title: 'Send poll links',
        confirmText: 'Send links'
      });
      if (!confirmed) return;

      var restoreViewLinks = viewLinksBtn && !viewLinksBtn.disabled;
      if (viewLinksBtn) {
        setButtonLoading(viewLinksBtn, false);
        viewLinksBtn.disabled = true;
        viewLinksBtn.setAttribute('aria-disabled', 'true');
      }

      setButtonLoading(btn, true, 'Sending...');

      if (PREVIEW_MODE) {
        await previewOnlyNotice('email poll links');
        setButtonLoading(btn, false);
        return;
      }

      var baseUrl = window.location.href.split('?')[0];

      firebase.functions().httpsCallable('manageRoster')({
        action: 'SEND_EMAILS',
        className: className,
        pollId: CURRENT_POLL_DATA.pollId
      }).then(function (result) {
        var payload = result.data;
        if (!payload.success) throw new Error('Could not prepare email data');

        // Add the base URL for the bridge to build full links
        payload.baseUrl = baseUrl;

        // FIREBASE MIGRATION: Send emails via Cloud Function (Simulated)
        return firebase.functions().httpsCallable('sendEmail')(payload)
          .then(function (result) {
            var response = result.data;
            setButtonLoading(btn, false);
            if (viewLinksBtn) {
              if (restoreViewLinks) {
                viewLinksBtn.disabled = false;
                viewLinksBtn.removeAttribute('aria-disabled');
              }
            }

            if (response.success) {
              veritasAlert('Emails processed (SIMULATED) for ' + response.sentCount + ' students.\n(Note: See Cloud Logging for details)', { title: 'Emails Processed' });
            } else {
              var msg = 'Sent: ' + (response.sentCount || 0) + ', Failed: ' + (response.failedCount || 0) + '.';
              if (response.failures && response.failures.length > 0) {
                msg += '\n\nFailures:\n' + response.failures.map(function (f) { return f.name + ': ' + f.error; }).join('\n');
              }
              if (response.error) {
                msg = 'Error: ' + response.error;
              }

              veritasAlert(msg, {
                title: 'Email Delivery Report',
                destructive: true
              });

              // Show fallback instructions
              if (viewLinksBtn) {
                viewLinksBtn.click(); // Auto-open links view as fallback
                showToast('info', 'Fallback', 'Opening link list for manual distribution.', 4000);
              }
            }
          });
      }).catch(function (error) {
        setButtonLoading(btn, false);
        handleError(error);
      });
    }

    async function onViewLinks() {
      var btn = viewLinksBtn;
      if (!btn) {
        console.warn('Missing view links button');
        return;
      }
      var className = btn && btn.dataset.className;
      if (!className) {
        await veritasAlert('Please select a poll first.', { title: 'View links' });
        return;
      }
      setButtonLoading(btn, true, 'Loading...');

      if (PREVIEW_MODE) {
        var container = document.getElementById('links-container');
        var roster = (PREVIEW_PAYLOAD && PREVIEW_PAYLOAD.rosters && PREVIEW_PAYLOAD.rosters[className]) || [];
        var html = '<div class="overflow-x-auto"><table class="w-full border-collapse">';
        html += '<thead><tr class="bg-brand-light-gray dark:bg-brand-dark-gray/50 border-b-2 border-brand-light-gray dark:border-brand-dark-gray/40">';
        html += '<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Student Name</th>';
        html += '<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Email</th>';
        html += '<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Link</th>';
        html += '<th class="px-4 py-3 text-center text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Actions</th>';
        html += '</tr></thead><tbody>';
        roster.forEach(function (student) {
          html += '<tr class="border-b border-brand-light-gray/50 dark:border-brand-dark-gray/20">';
          html += '<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">' + escapeHtml(student.name || 'Student') + '</td>';
          html += '<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">' + escapeHtml(student.email || 'student@example.com') + '</td>';
          html += '<td class="px-4 py-3 text-xs text-brand-dark-gray/70 dark:text-brand-white/70 italic">Preview links unavailable</td>';
          html += '<td class="px-4 py-3 text-center text-xs text-brand-dark-gray/60 dark:text-brand-white/60"></td>';
          html += '</tr>';
        });
        if (roster.length === 0) {
          html += '<tr><td colspan="4" class="px-4 py-6 text-center text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No roster data available in preview.</td></tr>';
        }
        html += '</tbody></table></div>';
        container.innerHTML = html;

        // Apply comprehensive modal visibility fix
        if (linksModal.parentElement !== document.body) {
          document.body.appendChild(linksModal);
        }
        linksModal.classList.remove('hidden');
        linksModal.style.cssText = 'display: flex !important; visibility: visible !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: 99999 !important; background-color: rgba(0,0,0,0.6) !important;';
        linksModal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        setButtonLoading(btn, false);
        return;
      }

      var baseUrl = window.location.href.split('?')[0];

      firebase.functions().httpsCallable('manageRoster')({
        action: 'GET_LINKS',
        className: className
      }).then(function (result) {
        var response = result.data;
        if (!response.success) return handleError(new Error('Could not load links'));

        var container = document.getElementById('links-container');
        var html = '<div class="overflow-x-auto"><table class="w-full border-collapse">';
        html += '<thead><tr class="bg-brand-light-gray dark:bg-brand-dark-gray/50 border-b-2 border-brand-light-gray dark:border-brand-dark-gray/40">';
        html += '<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Student Name</th>';
        html += '<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Email</th>';
        html += '<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Link</th>';
        html += '<th class="px-4 py-3 text-center text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Actions</th>';
        html += '</tr></thead><tbody>';

        response.links.forEach(function (link) {
          var fullUrl = baseUrl + '?token=' + link.token;
          html += '<tr class="border-b border-brand-light-gray/50 dark:border-brand-dark-gray/20 hover:bg-brand-light-gray/30 dark:hover:bg-brand-dark-gray/10">';
          html += '<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">' + escapeHtml(link.name) + '</td>';
          html += '<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">' + escapeHtml(link.email) + '</td>';
          html += '<td class="px-4 py-3 text-xs font-mono text-brand-dark-gray/70 dark:text-brand-white/70 max-w-[200px] truncate" title="' + escapeHtml(fullUrl) + '">' + escapeHtml(fullUrl) + '</td>';
          html += '<td class="px-4 py-3 text-center">';
          html += '<button class="copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors" data-url="' + escapeHtml(fullUrl) + '">Copy</button>';
          html += '</td></tr>';
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;

        container.querySelectorAll('.copy-link-btn').forEach(function (btn) {
          btn.onclick = async function () {
            var url = this.dataset.url;
            try {
              if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                await navigator.clipboard.writeText(url);
              } else {
                await veritasAlert('Automatic copy is not supported in this browser. Please copy the link manually.', { title: 'Copy link' });
                return;
              }

              btn.textContent = ' Copied!';
              btn.className = 'copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-green-600 text-brand-white';
              setTimeout(function () {
                btn.textContent = 'Copy';
                btn.className = 'copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors';
              }, 2000);
            } catch (err) {
              await veritasAlert('Could not copy link. Please copy it manually.', { title: 'Copy link', destructive: true });
            }
          };
        });

        // Apply comprehensive modal visibility fix
        if (linksModal.parentElement !== document.body) {
          document.body.appendChild(linksModal);
        }
        linksModal.classList.remove('hidden');
        linksModal.style.cssText = 'display: flex !important; visibility: visible !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: 99999 !important; background-color: rgba(0,0,0,0.6) !important;';
        linksModal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';

        setButtonLoading(btn, false);
      }).catch(function (error) {
        handleError(error);
        setButtonLoading(btn, false);
      });
    }

    function closeLinksModal() {
      linksModal.classList.add('hidden');
      linksModal.style.display = 'none';
      linksModal.style.cssText = ''; // Reset inline styles
      // Restore body scroll
      document.body.style.overflow = '';
    }

    // --- Poll Preview Modal Functions ---
    var previewModal = document.getElementById('poll-preview-modal');
    var previewPollName = document.getElementById('preview-poll-name');
    var previewPollMeta = document.getElementById('preview-poll-meta');
    var previewQuestionsNav = document.getElementById('preview-questions-nav');
    var previewQuestionDisplay = document.getElementById('preview-question-display');
    var previewQuestionCounter = document.getElementById('preview-question-counter');
    var currentPreviewPoll = null;
    var currentPreviewQuestionIndex = 0;
    var isPreviewReorderMode = false;
    var originalQuestionOrder = null;

    function openPollPreview(pollId) {
      var poll = ALL_POLLS.find(function (p) { return p.pollId === pollId; });
      if (!poll || !poll.questions || poll.questions.length === 0) {
        veritasAlert('This poll has no questions.', { title: 'Cannot preview', destructive: true });
        return;
      }

      currentPreviewPoll = poll;
      currentPreviewQuestionIndex = 0;
      isPreviewReorderMode = false;
      originalQuestionOrder = null;

      previewPollName.textContent = poll.pollName || 'Untitled Poll';
      var questionsCount = poll.questions.length;
      var classText = poll.className || 'No class';
      previewPollMeta.textContent = classText + '  ' + questionsCount + ' Question' + (questionsCount !== 1 ? 's' : '');

      renderPreviewNav();
      renderPreviewQuestion();

      // Ensure modal is appended to document.body to escape any container clipping
      if (previewModal.parentElement !== document.body) {
        document.body.appendChild(previewModal);
      }

      previewModal.classList.remove('hidden');
      previewModal.style.cssText = 'display: flex !important; visibility: visible !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: 99999 !important; background-color: rgba(0,0,0,0.6) !important;';
      previewModal.setAttribute('aria-hidden', 'false');

      // Prevent background scrolling
      document.body.style.overflow = 'hidden';
    }

    function closePollPreview() {
      previewModal.classList.add('hidden');
      previewModal.style.display = 'none';
      previewModal.style.cssText = ''; // Reset inline styles
      // Restore body scroll
      document.body.style.overflow = '';
      currentPreviewPoll = null;
      currentPreviewQuestionIndex = 0;
      isPreviewReorderMode = false;
      originalQuestionOrder = null;
    }

    function renderPreviewNav() {
      if (!currentPreviewPoll || !currentPreviewPoll.questions) return;

      previewQuestionsNav.innerHTML = '';
      currentPreviewPoll.questions.forEach(function (q, index) {
        var div = document.createElement('div');
        div.className = 'preview-nav-item cursor-pointer rounded-lg p-3 transition-colors ' + (index === currentPreviewQuestionIndex ? 'bg-primary/20 dark:bg-primary/30 border-l-4 border-primary' : 'bg-brand-white dark:bg-brand-dark-gray/30 hover:bg-brand-light-gray/40 dark:hover:bg-brand-dark-gray/40');
        div.dataset.questionIndex = index;

        var html = '<div class="flex items-start gap-2">';
        if (isPreviewReorderMode) {
          html += '<span class="material-symbols-outlined text-sm text-brand-dark-gray/40 dark:text-brand-white/40 cursor-move">drag_indicator</span>';
        }
        html += '<div class="flex-1 min-w-0">';
        html += '<div class="text-xs font-semibold text-brand-dark-gray/80 dark:text-brand-white/80">Q' + (index + 1) + '</div>';
        html += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 truncate mt-1">' + escapeHtml(q.questionText || 'No text') + '</div>';
        html += '</div></div>';

        div.innerHTML = html;
        div.onclick = function () {
          if (!isPreviewReorderMode) {
            currentPreviewQuestionIndex = index;
            renderPreviewNav();
            renderPreviewQuestion();
          }
        };

        if (isPreviewReorderMode) {
          div.setAttribute('draggable', 'true');
          setupDragHandlers(div, index);
        }

        previewQuestionsNav.appendChild(div);
      });
    }

    function renderPreviewQuestion() {
      if (!currentPreviewPoll || !currentPreviewPoll.questions || currentPreviewQuestionIndex >= currentPreviewPoll.questions.length) {
        previewQuestionDisplay.innerHTML = '<p class="text-brand-dark-gray/60 dark:text-brand-white/60">No question selected</p>';
        return;
      }

      var q = currentPreviewPoll.questions[currentPreviewQuestionIndex];
      var html = '';

      // Question header
      html += '<div class="mb-6">';
      html += '<div class="flex items-center gap-2 mb-2">';
      html += '<span class="text-sm font-semibold text-brand-dark-gray/60 dark:text-brand-white/60">Question ' + (currentPreviewQuestionIndex + 1) + ' of ' + currentPreviewPoll.questions.length + '</span>';
      if (q.timerSeconds) {
        html += '<span class="text-sm text-brand-dark-gray/50 dark:text-brand-white/50"> Timer: ' + q.timerSeconds + 's</span>';
      }
      html += '</div>';
      html += '<h3 class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">' + escapeHtml(q.questionText || 'No question text') + '</h3>';
      html += '</div>';

      // Question image
      if (q.questionImageURL) {
        html += '<div class="mb-6">';
        html += '<img src="' + escapeHtml(q.questionImageURL) + '" alt="Question image" class="max-w-full max-h-96 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40" referrerpolicy="no-referrer" onerror="this.style.display=\'none\';">';
        html += '</div>';
      }

      // Answer options
      if (q.options && q.options.length > 0) {
        html += '<div class="space-y-3">';
        html += '<h4 class="text-lg font-semibold text-brand-dark-gray dark:text-brand-white mb-3">Answer Options</h4>';
        q.options.forEach(function (opt, optIndex) {
          var letter = String.fromCharCode(65 + optIndex);
          var isCorrect = q.correctAnswer === letter;
          var optClass = 'flex items-start gap-3 p-4 rounded-lg border-2 transition-colors ' + (isCorrect ? 'bg-green-50 dark:bg-green-900/20 border-green-500 dark:border-green-600' : 'bg-brand-light-gray/30 dark:bg-brand-dark-gray/20 border-brand-light-gray dark:border-brand-dark-gray/40');

          html += '<div class="' + optClass + '">';
          html += '<div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold ' + (isCorrect ? 'bg-green-500 text-white' : 'bg-brand-dark-gray/10 dark:bg-brand-white/10 text-brand-dark-gray dark:text-brand-white') + '">' + letter + '</div>';
          html += '<div class="flex-1">';
          if (opt.text) {
            html += '<p class="text-brand-dark-gray dark:text-brand-white">' + escapeHtml(opt.text) + '</p>';
          }
          if (opt.imageURL) {
            html += '<img src="' + escapeHtml(opt.imageURL) + '" alt="Option image" class="mt-2 max-w-[200px] max-h-[150px] rounded border border-brand-light-gray dark:border-brand-dark-gray/40" referrerpolicy="no-referrer" onerror="this.style.display=\'none\';">';
          }
          html += '</div>';
          if (isCorrect) {
            html += '<span class="material-symbols-outlined text-green-600 dark:text-green-400">check_circle</span>';
          }
          html += '</div>';
        });
        html += '</div>';
      } else {
        html += '<p class="text-brand-dark-gray/60 dark:text-brand-white/60">No answer options</p>';
      }

      previewQuestionDisplay.innerHTML = html;
      previewQuestionCounter.textContent = (currentPreviewQuestionIndex + 1) + ' / ' + currentPreviewPoll.questions.length;

      // Update navigation button states
      document.getElementById('preview-prev-question-btn').disabled = currentPreviewQuestionIndex === 0;
      document.getElementById('preview-next-question-btn').disabled = currentPreviewQuestionIndex === currentPreviewPoll.questions.length - 1;
    }

    function previewPrevQuestion() {
      if (currentPreviewQuestionIndex > 0) {
        currentPreviewQuestionIndex--;
        renderPreviewNav();
        renderPreviewQuestion();
      }
    }

    function previewNextQuestion() {
      if (currentPreviewPoll && currentPreviewQuestionIndex < currentPreviewPoll.questions.length - 1) {
        currentPreviewQuestionIndex++;
        renderPreviewNav();
        renderPreviewQuestion();
      }
    }

    function previewOpenLinks() {
      if (!currentPreviewPoll) return;
      var className = currentPreviewPoll.className;
      if (!className) {
        veritasAlert('This poll has no class assigned.', { title: 'No class', destructive: true });
        return;
      }
      openLinksModal(className);
    }

    function previewEditQuestion() {
      if (!currentPreviewPoll) return;
      closePollPreview();
      startEditPoll(currentPreviewPoll.pollId);
    }

    async function previewDeleteQuestion() {
      if (!currentPreviewPoll || !currentPreviewPoll.questions || currentPreviewPoll.questions.length === 0) return;

      var confirmed = await veritasConfirm('Delete this question from the poll?', {
        title: 'Delete question',
        confirmText: 'Delete',
        destructive: true
      });
      if (!confirmed) return;

      currentPreviewPoll.questions.splice(currentPreviewQuestionIndex, 1);

      if (currentPreviewPoll.questions.length === 0) {
        await veritasAlert('Cannot delete the last question. A poll must have at least one question.', {
          title: 'Cannot delete',
          destructive: true
        });
        currentPreviewPoll.questions.splice(currentPreviewQuestionIndex, 0, { questionText: '', options: [], correctAnswer: 'A', timerSeconds: 90 });
        return;
      }

      if (currentPreviewQuestionIndex >= currentPreviewPoll.questions.length) {
        currentPreviewQuestionIndex = currentPreviewPoll.questions.length - 1;
      }

      // Save to backend
      if (PREVIEW_MODE) {
        renderPreviewNav();
        renderPreviewQuestion();
        await veritasAlert('Question deleted (preview mode).', { title: 'Question deleted' });
        return;
      }

      var previewMetadata = {
        sessionType: normalizeSessionTypeClient(currentPreviewPoll.sessionType),
        timeLimitMinutes: currentPreviewPoll.timeLimitMinutes || null,
        accessCode: currentPreviewPoll.accessCode || '',
        availableFrom: currentPreviewPoll.availableFrom || '',
        dueBy: currentPreviewPoll.dueBy || '',
        secureSettings: currentPreviewPoll.secureSettings || {}
      };

      // FIREBASE MIGRATION: Update Poll via Cloud Function
      firebase.functions().httpsCallable('updatePoll')({
        pollId: currentPreviewPoll.pollId,
        pollName: currentPreviewPoll.pollName,
        className: currentPreviewPoll.className,
        questions: currentPreviewPoll.questions,
        metadata: previewMetadata
      }).then(function (result) {
        if (result.data && result.data.success) {
          // RTDB listener will update ALL_POLLS and UI
          renderPreviewNav();
          renderPreviewQuestion();
          veritasAlert('Question deleted successfully.', { title: 'Question deleted' });
        } else {
          throw new Error('Failed to update poll');
        }
      }).catch(function (error) {
        handleError(error);
      });
    }

    function togglePreviewReorder() {
      isPreviewReorderMode = !isPreviewReorderMode;
      var btn = document.getElementById('preview-reorder-btn');

      if (isPreviewReorderMode) {
        originalQuestionOrder = JSON.parse(JSON.stringify(currentPreviewPoll.questions));
        btn.innerHTML = '<span class="material-symbols-outlined text-sm align-middle">check</span>';
        btn.classList.add('bg-primary', 'text-white');
        btn.classList.remove('bg-brand-dark-gray/10', 'dark:bg-brand-white/10', 'text-brand-dark-gray', 'dark:text-brand-white');
      } else {
        // Save the reordered questions
        if (JSON.stringify(originalQuestionOrder) !== JSON.stringify(currentPreviewPoll.questions)) {
          saveReorderedQuestions();
        }
        originalQuestionOrder = null;
        btn.innerHTML = '<span class="material-symbols-outlined text-sm align-middle">swap_vert</span>';
        btn.classList.remove('bg-primary', 'text-white');
        btn.classList.add('bg-brand-dark-gray/10', 'dark:bg-brand-white/10', 'text-brand-dark-gray', 'dark:text-brand-white');
      }

      renderPreviewNav();
    }

    function saveReorderedQuestions() {
      if (!currentPreviewPoll) return;

      if (PREVIEW_MODE) {
        veritasAlert('Question order updated (preview mode).', { title: 'Questions reordered' });
        return;
      }

      var reorderMetadata = {
        sessionType: normalizeSessionTypeClient(currentPreviewPoll.sessionType),
        timeLimitMinutes: currentPreviewPoll.timeLimitMinutes || null,
        accessCode: currentPreviewPoll.accessCode || '',
        availableFrom: currentPreviewPoll.availableFrom || '',
        dueBy: currentPreviewPoll.dueBy || '',
        secureSettings: currentPreviewPoll.secureSettings || {}
      };

      // FIREBASE MIGRATION: Update Poll via Cloud Function
      firebase.functions().httpsCallable('updatePoll')({
        pollId: currentPreviewPoll.pollId,
        pollName: currentPreviewPoll.pollName,
        className: currentPreviewPoll.className,
        questions: currentPreviewPoll.questions,
        metadata: reorderMetadata
      }).then(function (result) {
        if (result.data && result.data.success) {
          veritasAlert('Question order updated successfully.', { title: 'Questions reordered' });
        } else {
          throw new Error('Failed to update poll');
        }
      }).catch(function (error) {
        handleError(error);
      });
    }

    var draggedItemIndex = null;

    function setupDragHandlers(div, index) {
      div.addEventListener('dragstart', function (e) {
        draggedItemIndex = index;
        this.style.opacity = '0.4';
        e.dataTransfer.effectAllowed = 'move';
      });

      div.addEventListener('dragend', function (e) {
        this.style.opacity = '1';
        draggedItemIndex = null;
      });

      div.addEventListener('dragover', function (e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';

        if (draggedItemIndex !== null && draggedItemIndex !== index) {
          var draggedQuestion = currentPreviewPoll.questions[draggedItemIndex];
          currentPreviewPoll.questions.splice(draggedItemIndex, 1);
          currentPreviewPoll.questions.splice(index, 0, draggedQuestion);

          if (currentPreviewQuestionIndex === draggedItemIndex) {
            currentPreviewQuestionIndex = index;
          } else if (draggedItemIndex < currentPreviewQuestionIndex && index >= currentPreviewQuestionIndex) {
            currentPreviewQuestionIndex--;
          } else if (draggedItemIndex > currentPreviewQuestionIndex && index <= currentPreviewQuestionIndex) {
            currentPreviewQuestionIndex++;
          }

          draggedItemIndex = index;
          renderPreviewNav();
        }
      });
    }

    function generateQuestionId() {
      questionIdCounter += 1;
      return 'q-' + questionIdCounter;
    }

    function assignQuestionId(question) {
      if (!question) return question;
      if (!question._id) {
        question._id = generateQuestionId();
      } else {
        var match = String(question._id).match(/q-(\d+)/);
        if (match) {
          var numeric = parseInt(match[1], 10);
          if (!isNaN(numeric) && numeric > questionIdCounter) {
            questionIdCounter = numeric;
          }
        }
      }
      if (typeof question._createdOrder !== 'number') {
        question._createdOrder = Date.now();
      }
      return question;
    }

    function ensureCustomOrderIncludes(questionId, insertIndex) {
      if (!questionId) return;
      var existingIndex = customQuestionOrder.indexOf(questionId);
      if (existingIndex !== -1) {
        if (typeof insertIndex === 'number' && insertIndex !== existingIndex) {
          customQuestionOrder.splice(existingIndex, 1);
          if (insertIndex > customQuestionOrder.length) {
            insertIndex = customQuestionOrder.length;
          }
          customQuestionOrder.splice(insertIndex, 0, questionId);
        }
        return;
      }
      if (typeof insertIndex === 'number' && insertIndex >= 0 && insertIndex <= customQuestionOrder.length) {
        customQuestionOrder.splice(insertIndex, 0, questionId);
      } else {
        customQuestionOrder.push(questionId);
      }
    }

    function removeFromCustomOrder(questionId) {
      if (!questionId) return;
      var index = customQuestionOrder.indexOf(questionId);
      if (index !== -1) {
        customQuestionOrder.splice(index, 1);
      }
    }

    function buildOrderFromIds(orderIds) {
      var idMap = new Map();
      questions.forEach(function (question) {
        if (question && question._id) {
          idMap.set(question._id, question);
        }
      });
      var ordered = [];
      (orderIds || []).forEach(function (id) {
        if (idMap.has(id)) {
          ordered.push(idMap.get(id));
          idMap.delete(id);
        }
      });
      idMap.forEach(function (question) {
        ordered.push(question);
      });
      return ordered;
    }

    function enforceQuestionOrder(preserveQuestionId) {
      var selectionId = preserveQuestionId || (questions[selectedQuestionIndex] && questions[selectedQuestionIndex]._id) || null;
      var ordered = buildOrderFromIds(customQuestionOrder);
      questions = ordered;
      customQuestionOrder = ordered.map(function (question) { return question._id; });

      if (questions.length === 0) {
        selectedQuestionIndex = 0;
        return;
      }

      if (selectionId) {
        var newIndex = questions.findIndex(function (question) { return question && question._id === selectionId; });
        if (newIndex !== -1) {
          selectedQuestionIndex = newIndex;
        } else if (selectedQuestionIndex >= questions.length) {
          selectedQuestionIndex = Math.max(0, questions.length - 1);
        }
      } else if (selectedQuestionIndex >= questions.length) {
        selectedQuestionIndex = Math.max(0, questions.length - 1);
      }
    }

    function setQuestionReorderHelp() {
      if (questionSortHelp) {
        questionSortHelp.textContent = 'Drag questions to reorder them manually.';
      }
    }

    function resetQuestionOrderToInitial() {
      if (!initialQuestionOrder || initialQuestionOrder.length === 0) return;
      var selectionId = questions[selectedQuestionIndex] && questions[selectedQuestionIndex]._id;
      var ordered = buildOrderFromIds(initialQuestionOrder);
      questions = ordered;
      customQuestionOrder = ordered.map(function (question) { return question._id; });
      enforceQuestionOrder(selectionId);
      renderQuestionNavigator();
      renderQuestionWorkspace();
      markPollDirty();
      setQuestionReorderHelp();
    }

    function clearDropIndicators() {
      if (!questionNavigatorContainer) return;
      questionNavigatorContainer.querySelectorAll('.question-nav-item').forEach(function (item) {
        item.classList.remove('drop-before', 'drop-after');
      });
    }

    function clearDragVisuals() {
      if (!questionNavigatorContainer) return;
      questionNavigatorContainer.querySelectorAll('.question-nav-item').forEach(function (item) {
        item.classList.remove('drop-before', 'drop-after', 'dragging');
      });
    }

    function moveQuestionToIndex(questionId, insertIndex) {
      if (!questionId) return;
      var fromIndex = customQuestionOrder.indexOf(questionId);
      if (fromIndex === -1) return;
      if (insertIndex > customQuestionOrder.length) {
        insertIndex = customQuestionOrder.length;
      }
      if (insertIndex > fromIndex) {
        insertIndex--;
      }
      if (insertIndex === fromIndex) return;
      customQuestionOrder.splice(fromIndex, 1);
      customQuestionOrder.splice(insertIndex, 0, questionId);
      enforceQuestionOrder(questionId);
      renderQuestionNavigator();
      renderQuestionWorkspace();
      markPollDirty();
    }

    function handleQuestionDragStart(e) {
      draggedQuestionId = this.dataset.questionId || null;
      if (!draggedQuestionId) return;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      try { e.dataTransfer.setData('text/plain', draggedQuestionId); } catch (err) { }
    }

    function handleQuestionDragOver(e) {
      if (!draggedQuestionId) return;
      var questionId = this.dataset.questionId;
      if (!questionId || questionId === draggedQuestionId) return;
      e.preventDefault();
      clearDropIndicators();
      var rect = this.getBoundingClientRect();
      var before = (e.clientY - rect.top) < rect.height / 2;
      if (before) {
        this.classList.add('drop-before');
        this.classList.remove('drop-after');
      } else {
        this.classList.add('drop-after');
        this.classList.remove('drop-before');
      }
    }

    function handleQuestionDragLeave() {
      if (!this.classList.contains('question-nav-item')) return;
      this.classList.remove('drop-before', 'drop-after');
    }

    function handleQuestionDrop(e) {
      if (!draggedQuestionId) return;
      var questionId = this.dataset.questionId;
      if (!questionId || questionId === draggedQuestionId) return;
      e.preventDefault();
      e.stopPropagation();
      var rect = this.getBoundingClientRect();
      var before = (e.clientY - rect.top) < rect.height / 2;
      clearDropIndicators();
      var targetIndex = customQuestionOrder.indexOf(questionId);
      if (targetIndex === -1) return;
      var insertIndex = before ? targetIndex : targetIndex + 1;
      moveQuestionToIndex(draggedQuestionId, insertIndex);
      draggedQuestionId = null;
    }

    function handleQuestionDragEnd() {
      clearDragVisuals();
      draggedQuestionId = null;
    }

    function handleNavigatorDragOver(e) {
      if (!draggedQuestionId) return;
      e.preventDefault();
      clearDropIndicators();
    }

    function handleNavigatorDrop(e) {
      if (!draggedQuestionId) return;
      if (e.target !== questionNavigatorContainer) return;
      e.preventDefault();
      clearDropIndicators();
      moveQuestionToIndex(draggedQuestionId, customQuestionOrder.length);
      draggedQuestionId = null;
    }

    function setSaveStatus(message) {
      var saveStatus = document.getElementById('save-status');
      if (saveStatus) {
        saveStatus.textContent = message;
      }
    }

    function markPollDirty() {
      if (!isPollDirty) {
        isPollDirty = true;
      }
      setSaveStatus('Unsaved changes');
    }

    function resetPollDirty(message) {
      isPollDirty = false;
      setSaveStatus(message || 'All changes saved');
    }

    function normalizeSessionTypeClient(value) {
      if (!value) return 'LIVE_POLL';
      var normalized = value.toString().toUpperCase();
      if (normalized === 'LIVE' || normalized === 'LIVE_POLL') return 'LIVE_POLL';
      if (normalized === 'SECURE_ASSESSMENT' || normalized === 'SECURE' || normalized === 'INDIVIDUAL_TIMED') return 'SECURE_ASSESSMENT';
      return 'LIVE_POLL';
    }

    function isSecureSessionTypeClient(value) {
      return normalizeSessionTypeClient(value) === 'SECURE_ASSESSMENT';
    }

    function syncSessionTypeToggleUI() {
      if (!sessionToggleButtons) return;
      sessionToggleButtons.forEach(function (btn) {
        var isActive = normalizeSessionTypeClient(btn.dataset.sessionType) === normalizeSessionTypeClient(pollSessionType);
        if (isActive) {
          btn.classList.add('bg-primary', 'text-brand-white');
          btn.classList.remove('text-brand-dark-gray', 'dark:text-brand-white/70');
        } else {
          btn.classList.remove('bg-primary', 'text-brand-white');
          btn.classList.add('text-brand-dark-gray', 'dark:text-brand-white/70');
        }
      });
    }

    function updateSecureSettingsVisibility() {
      if (!secureSettingsPanel) return;
      if (isSecureSessionTypeClient(pollSessionType)) {
        secureSettingsPanel.classList.remove('hidden');
      } else {
        secureSettingsPanel.classList.add('hidden');
      }
    }

    function isoToLocalInput(isoValue) {
      if (!isoValue) return '';
      var date = new Date(isoValue);
      if (isNaN(date.getTime())) return '';
      var year = date.getFullYear();
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      var hours = String(date.getHours()).padStart(2, '0');
      var minutes = String(date.getMinutes()).padStart(2, '0');
      return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
    }

    function localInputToIso(localValue) {
      if (!localValue) return '';
      var date = new Date(localValue);
      if (isNaN(date.getTime())) return '';
      return date.toISOString();
    }

    function populateSecureSettingsInputs() {
      if (secureTimeLimitInput) {
        secureTimeLimitInput.value = typeof secureAssessmentConfig.timeLimitMinutes === 'number' ? secureAssessmentConfig.timeLimitMinutes : '';
      }
      if (secureAccessCodeInput) {
        secureAccessCodeInput.value = secureAssessmentConfig.accessCode || '';
      }
      if (secureAvailableInput) {
        secureAvailableInput.value = isoToLocalInput(secureAssessmentConfig.availableFrom);
      }
      if (secureDueInput) {
        secureDueInput.value = isoToLocalInput(secureAssessmentConfig.dueBy);
      }
    }

    function readSecureSettingsFromInputs() {
      if (secureTimeLimitInput) {
        var parsed = parseInt(secureTimeLimitInput.value, 10);
        secureAssessmentConfig.timeLimitMinutes = isNaN(parsed) ? '' : parsed;
      }
      if (secureAccessCodeInput) {
        secureAssessmentConfig.accessCode = (secureAccessCodeInput.value || '').trim().toUpperCase();
      }
      if (secureAvailableInput) {
        secureAssessmentConfig.availableFrom = localInputToIso(secureAvailableInput.value);
      }
      if (secureDueInput) {
        secureAssessmentConfig.dueBy = localInputToIso(secureDueInput.value);
      }
      return {
        timeLimitMinutes: typeof secureAssessmentConfig.timeLimitMinutes === 'number' ? secureAssessmentConfig.timeLimitMinutes : null,
        accessCode: secureAssessmentConfig.accessCode || '',
        availableFrom: secureAssessmentConfig.availableFrom || '',
        dueBy: secureAssessmentConfig.dueBy || ''
      };
    }

    function resetSecureAssessmentState() {
      secureAssessmentConfig = {
        timeLimitMinutes: 60,
        accessCode: '',
        availableFrom: '',
        dueBy: ''
      };
      populateSecureSettingsInputs();
    }

    function setPollSessionType(newType, suppressDirty) {
      pollSessionType = normalizeSessionTypeClient(newType);
      syncSessionTypeToggleUI();
      updateSecureSettingsVisibility();
      if (!suppressDirty) {
        markPollDirty();
      }
    }

    function buildSecureAssessmentPayload() {
      var current = readSecureSettingsFromInputs();
      return {
        sessionType: pollSessionType,
        timeLimitMinutes: current.timeLimitMinutes,
        accessCode: current.accessCode,
        availableFrom: current.availableFrom,
        dueBy: current.dueBy,
        secureSettings: {
          timeLimitMinutes: current.timeLimitMinutes,
          accessCode: current.accessCode,
          availableFrom: current.availableFrom,
          dueBy: current.dueBy,
          fullscreenRequired: isSecureSessionTypeClient(pollSessionType),
          proctoringRules: ['Fullscreen required', 'No tab switching', 'Mission Control monitoring']
        }
      };
    }

    // --- Poll Creator Modal ---
    function openPollCreator(existingPoll) {
      console.log('openPollCreator called', existingPoll ? 'with existing poll' : 'for new poll');
      try {
        // Defensive check: ensure modal exists
        if (!modal) {
          console.log('Modal variable is null, fetching from DOM...');
          modal = document.getElementById('poll-creator-modal');
          if (!modal) {
            console.error('Poll creator modal not found in DOM');
            veritasAlert('Unable to open poll creator. Please refresh the page and try again.', { title: 'Error' });
            return;
          }
        }
        var saveButton = document.getElementById('save-poll-btn');

        questionCounter = 0;
        questions = [];
        selectedQuestionIndex = 0;
        questionIdCounter = 0;
        customQuestionOrder = [];
        initialQuestionOrder = [];
        draggedQuestionId = null;
        setQuestionReorderHelp();

        if (existingPoll) {
          editingPollId = existingPoll.pollId;
          document.getElementById('new-poll-name').value = existingPoll.pollName || '';
          if (existingPoll.className) {
            refreshClassOptions(BASE_CLASSES.concat([existingPoll.className]));
          }
          classSelect.value = existingPoll.className || '';

          var existingSessionType = normalizeSessionTypeClient(existingPoll.sessionType);
          secureAssessmentConfig = {
            timeLimitMinutes: typeof existingPoll.timeLimitMinutes === 'number' ? existingPoll.timeLimitMinutes :
              (existingPoll.secureSettings && typeof existingPoll.secureSettings.timeLimitMinutes === 'number'
                ? existingPoll.secureSettings.timeLimitMinutes : ''),
            accessCode: (existingPoll.accessCode || (existingPoll.secureSettings && existingPoll.secureSettings.accessCode) || '').toString().toUpperCase(),
            availableFrom: existingPoll.availableFrom || (existingPoll.secureSettings && existingPoll.secureSettings.availableFrom) || '',
            dueBy: existingPoll.dueBy || (existingPoll.secureSettings && existingPoll.secureSettings.dueBy) || ''
          };
          if (secureAssessmentConfig.timeLimitMinutes === '') {
            secureAssessmentConfig.timeLimitMinutes = 60;
          }
          populateSecureSettingsInputs();
          setPollSessionType(existingSessionType, true);
          updateSecureSettingsVisibility();

          questions = existingPoll.questions.map(function (question) {
            var answers = (question.options || []).map(function (opt) {
              return {
                text: opt.text || '',
                image: opt.imageURL || null,
                imageURL: opt.imageURL || null,
                imageFileId: opt.imageFileId || null
              };
            });
            while (answers.length < 2) {
              answers.push({ text: '', image: null, imageURL: null, imageFileId: null });
            }
            var correctIndex = 0;
            answers.forEach(function (answer, idx) {
              if (answer.text === question.correctAnswer) {
                correctIndex = idx;
              }
            });
            return assignQuestionId({
              questionText: question.questionText || '',
              questionImage: null,
              questionImageURL: question.questionImageURL || null,
              questionImageFileId: question.questionImageFileId || null,
              answers: answers,
              correctAnswerIndex: correctIndex,
              timerSeconds: question.timerSeconds || null,
              metacognitionEnabled: !!question.metacognitionEnabled
            });
          });
          if (questions.length === 0) {
            addQuestion(true);
          }
          questionCounter = questions.length;
          selectedQuestionIndex = 0;
          saveButton.innerHTML = '<span class="truncate">Save Changes</span>';
          resetPollDirty('Editing existing poll');
        } else {
          editingPollId = null;
          document.getElementById('new-poll-name').value = '';
          classSelect.value = '';
          resetSecureAssessmentState();
          setPollSessionType('LIVE_POLL', true);
          updateSecureSettingsVisibility();

          addQuestion(true);
          saveButton.innerHTML = '<span class="truncate">Publish Poll</span>';
          resetPollDirty('All changes saved');
        }

        customQuestionOrder = questions.map(function (question) { return question._id; });
        initialQuestionOrder = customQuestionOrder.slice();
        enforceQuestionOrder();
        renderQuestionNavigator();
        renderQuestionWorkspace();
        console.log('About to show modal. Modal element:', modal);
        console.log('Modal current classes:', modal ? modal.className : 'N/A');
        console.log('Modal current display style:', modal ? modal.style.display : 'N/A');

        // Ensure modal is appended to document.body to escape any container clipping
        if (modal.parentElement !== document.body) {
          document.body.appendChild(modal);
        }

        // Remove hidden class first
        modal.classList.remove('hidden');

        // Force visibility with maximum z-index and all required properties
        modal.style.cssText = 'display: flex !important; visibility: visible !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: 99999 !important; background-color: rgba(0,0,0,0.6) !important;';
        modal.setAttribute('aria-hidden', 'false');

        // Prevent background scrolling
        document.body.style.overflow = 'hidden';

        console.log('Modal should now be visible. Display:', modal.style.display, 'Classes:', modal.className, 'Parent:', modal.parentElement.tagName);
      } catch (e) {
        console.error("Error opening poll creator:", e);
        console.error("Error stack:", e.stack);
        veritasAlert("Error opening poll creator: " + e.message, { title: "Error" });
      }
    }

    function closePollCreator() {
      if (modal) {
        modal.style.display = 'none';
        modal.classList.add('hidden');
        modal.style.cssText = ''; // Reset inline styles
      }
      // Restore body scroll
      document.body.style.overflow = '';
      questions = [];
      questionCounter = 0;
      selectedQuestionIndex = 0;
      editingPollId = null;
      document.getElementById('save-poll-btn').innerHTML = '<span class="truncate">Publish Poll</span>';
      resetPollDirty('All changes saved');
      customQuestionOrder = [];
      initialQuestionOrder = [];
      questionIdCounter = 0;
      draggedQuestionId = null;
      setQuestionReorderHelp();
      resetSecureAssessmentState();
      setPollSessionType('LIVE_POLL', true);
      updateSecureSettingsVisibility();
    }

    // ============= NEW FEATURE: QUESTION BANK IMPORT =============
    var questionBankData = [];
    var selectedBankQuestions = new Set();

    function openQuestionBank() {
      var bankModal = document.getElementById('question-bank-modal');
      if (bankModal) {
        bankModal.style.display = 'flex';
        loadQuestionBank();
      }
    }

    function closeQuestionBank() {
      var bankModal = document.getElementById('question-bank-modal');
      if (bankModal) {
        bankModal.style.display = 'none';
      }
      selectedBankQuestions.clear();
      updateBankSelectionCount();
    }

    function loadQuestionBank() {
      var container = document.getElementById('bank-questions-container');
      var pollFilter = document.getElementById('bank-poll-filter');
      if (!container) return;

      container.innerHTML = '<p class="text-center text-brand-dark-gray/60 py-8">Loading questions from your polls...</p>';

      if (PREVIEW_MODE) {
        // Preview mode - use sample data
        questionBankData = ALL_POLLS.flatMap(function (poll) {
          return (poll.questions || []).map(function (q, idx) {
            return {
              pollId: poll.pollId,
              pollName: poll.pollName,
              questionIndex: idx,
              questionText: q.questionText || '',
              answers: q.answers || q.options || [],
              topicTag: q.topicTag || q.topic || '',
              difficultyLevel: q.difficultyLevel || ''
            };
          });
        });
        renderQuestionBank();
        populatePollFilter();
        return;
      }

      // FIREBASE MIGRATION: Synthesize Question Bank from ALL_POLLS
      (function () {
        try {
          var questions = [];
          (ALL_POLLS || []).forEach(function (poll) {
            if (!poll || !poll.questions) return;
            poll.questions.forEach(function (q, idx) {
              questions.push({
                pollId: poll.pollId,
                pollName: poll.pollName,
                questionIndex: idx,
                questionText: q.questionText || '',
                answers: q.answers || q.options || [],
                topicTag: q.topicTag || q.topic || '',
                difficultyLevel: q.difficultyLevel || ''
              });
            });
          });

          questionBankData = questions;
          renderQuestionBank();
          populatePollFilter();
        } catch (error) {
          console.error('Question Bank synthesis failed:', error);
          container.innerHTML = '<p class="text-center text-red-600 py-8">Failed to synthesize question bank: ' + error.message + '</p>';
        }
      })();
    }

    function populatePollFilter() {
      var pollFilter = document.getElementById('bank-poll-filter');
      if (!pollFilter) return;

      var pollNames = [...new Set(questionBankData.map(function (q) { return q.pollName; }))];
      pollFilter.innerHTML = '<option value="">All Polls (' + questionBankData.length + ' questions)</option>';
      pollNames.forEach(function (name) {
        var count = questionBankData.filter(function (q) { return q.pollName === name; }).length;
        pollFilter.innerHTML += '<option value="' + escapeHtml(name) + '">' + escapeHtml(name) + ' (' + count + ')</option>';
      });

      pollFilter.onchange = function () {
        renderQuestionBank(this.value);
      };
    }

    function renderQuestionBank(filterByPoll) {
      var container = document.getElementById('bank-questions-container');
      if (!container) return;

      var filteredQuestions = filterByPoll
        ? questionBankData.filter(function (q) { return q.pollName === filterByPoll; })
        : questionBankData;

      if (filteredQuestions.length === 0) {
        container.innerHTML = '<p class="text-center text-brand-dark-gray/60 py-8">No questions found in your question bank.</p>';
        return;
      }

      container.innerHTML = filteredQuestions.map(function (q, idx) {
        var isSelected = selectedBankQuestions.has(q.pollId + ':' + q.questionIndex);
        var diffBadge = q.difficultyLevel ? ('<span class="text-xs px-2 py-0.5 rounded-full ' +
          (q.difficultyLevel === 'easy' ? 'bg-green-100 text-green-700' :
            q.difficultyLevel === 'medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700') +
          '">' + q.difficultyLevel + '</span>') : '';

        return '<div class="bank-question-item p-4 rounded-lg border cursor-pointer transition-colors ' +
          (isSelected ? 'border-amber-500 bg-amber-50 dark:bg-amber-900/20' : 'border-brand-light-gray dark:border-brand-dark-gray/40 hover:bg-brand-light-gray/30') +
          '" data-bank-key="' + q.pollId + ':' + q.questionIndex + '">' +
          '<div class="flex items-start justify-between gap-3">' +
          '<div class="flex-1">' +
          '<p class="text-sm font-medium text-brand-dark-gray dark:text-brand-white line-clamp-2">' + escapeHtml(q.questionText || 'No question text') + '</p>' +
          '<div class="flex flex-wrap items-center gap-2 mt-2">' +
          '<span class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">' + escapeHtml(q.pollName) + '</span>' +
          (q.topicTag ? '<span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300">' + escapeHtml(q.topicTag) + '</span>' : '') +
          diffBadge +
          '</div>' +
          '</div>' +
          '<div class="flex-shrink-0">' +
          '<span class="material-symbols-outlined text-xl ' + (isSelected ? 'text-amber-600' : 'text-brand-light-gray') + '">' +
          (isSelected ? 'check_circle' : 'radio_button_unchecked') + '</span>' +
          '</div>' +
          '</div>' +
          '</div>';
      }).join('');

      container.querySelectorAll('.bank-question-item').forEach(function (item) {
        item.onclick = function () {
          var key = this.dataset.bankKey;
          if (selectedBankQuestions.has(key)) {
            selectedBankQuestions.delete(key);
          } else {
            selectedBankQuestions.add(key);
          }
          renderQuestionBank(document.getElementById('bank-poll-filter')?.value);
          updateBankSelectionCount();
        };
      });
    }

    function updateBankSelectionCount() {
      var countEl = document.getElementById('bank-selected-count');
      var importBtn = document.getElementById('import-selected-btn');
      var count = selectedBankQuestions.size;

      if (countEl) countEl.textContent = count + ' question' + (count !== 1 ? 's' : '') + ' selected';
      if (importBtn) importBtn.disabled = count === 0;
    }

    function importSelectedQuestions() {
      if (selectedBankQuestions.size === 0) return;

      selectedBankQuestions.forEach(function (key) {
        var parts = key.split(':');
        var pollId = parts[0];
        var qIdx = parseInt(parts[1], 10);
        var sourceQ = questionBankData.find(function (q) {
          return q.pollId === pollId && q.questionIndex === qIdx;
        });

        if (sourceQ) {
          var newQuestion = {
            questionText: sourceQ.questionText || '',
            answers: (sourceQ.answers || []).map(function (a) {
              return typeof a === 'string' ? { text: a } : { text: a.text || '', imageURL: a.imageURL || null };
            }),
            correctAnswerIndex: 0,
            metacognitionEnabled: false,
            topicTag: sourceQ.topicTag || '',
            difficultyLevel: sourceQ.difficultyLevel || ''
          };
          if (newQuestion.answers.length < 2) {
            newQuestion.answers = [{ text: '' }, { text: '' }];
          }
          assignQuestionId(newQuestion);
          questions.push(newQuestion);
          ensureCustomOrderIncludes(newQuestion._id);
        }
      });

      enforceQuestionOrder();
      renderQuestionNavigator();
      renderQuestionWorkspace();
      markPollDirty();
      closeQuestionBank();
      veritasAlert(selectedBankQuestions.size + ' question(s) imported successfully!', { title: 'Question Bank' });
    }

    // ============= AP BIOLOGY 2025 TOPIC TAGGER =============

    // AP Biology 2025 CED Curriculum Data
    var AP_BIO_CURRICULUM = {
      'Unit 1': {
        name: 'Chemistry of Life',
        weight: '8-11%',
        topics: [
          '1.1 Structure of Water and Hydrogen Bonding',
          '1.2 Elements of Life',
          '1.3 Introduction to Biological Macromolecules',
          '1.4 Properties of Biological Macromolecules',
          '1.5 Structure and Function of Biological Macromolecules',
          '1.6 Nucleic Acids'
        ]
      },
      'Unit 2': {
        name: 'Cell Structure and Function',
        weight: '10-13%',
        topics: [
          '2.1 Cell Structure: Subcellular Components',
          '2.2 Cell Structure and Function',
          '2.3 Cell Size',
          '2.4 Plasma Membranes',
          '2.5 Membrane Permeability',
          '2.6 Membrane Transport',
          '2.7 Facilitated Diffusion',
          '2.8 Tonicity and Osmoregulation',
          '2.9 Mechanisms of Transport',
          '2.10 Cell Compartmentalization',
          '2.11 Origins of Cell Compartmentalization'
        ]
      },
      'Unit 3': {
        name: 'Cellular Energetics',
        weight: '12-16%',
        topics: [
          '3.1 Enzyme Structure',
          '3.2 Enzyme Catalysis',
          '3.3 Environmental Impacts on Enzyme Function',
          '3.4 Cellular Energy',
          '3.5 Photosynthesis',
          '3.6 Cellular Respiration',
          '3.7 Fitness'
        ]
      },
      'Unit 4': {
        name: 'Cell Communication and Cell Cycle',
        weight: '10-15%',
        topics: [
          '4.1 Cell Communication',
          '4.2 Introduction to Signal Transduction',
          '4.3 Signal Transduction',
          '4.4 Changes in Signal Transduction Pathways',
          '4.5 Feedback',
          '4.6 Cell Cycle',
          '4.7 Regulation of Cell Cycle'
        ]
      },
      'Unit 5': {
        name: 'Heredity',
        weight: '8-11%',
        topics: [
          '5.1 Meiosis',
          '5.2 Meiosis and Genetic Diversity',
          '5.3 Mendelian Genetics',
          '5.4 Non-Mendelian Genetics',
          '5.5 Environmental Effects on Phenotype',
          '5.6 Chromosomal Inheritance'
        ]
      },
      'Unit 6': {
        name: 'Gene Expression and Regulation',
        weight: '12-16%',
        topics: [
          '6.1 DNA and RNA Structure',
          '6.2 Replication',
          '6.3 Transcription and RNA Processing',
          '6.4 Translation',
          '6.5 Regulation of Gene Expression',
          '6.6 Gene Expression and Cell Specialization',
          '6.7 Mutations'
        ]
      },
      'Unit 7': {
        name: 'Natural Selection',
        weight: '13-20%',
        topics: [
          '7.1 Introduction to Natural Selection',
          '7.2 Natural Selection',
          '7.3 Artificial Selection',
          '7.4 Population Genetics',
          '7.5 Hardy-Weinberg Equilibrium',
          '7.6 Evidence of Evolution',
          '7.7 Common Ancestry',
          '7.8 Continuing Evolution',
          '7.9 Phylogeny',
          '7.10 Speciation',
          '7.11 Extinction',
          '7.12 Variations in Populations',
          '7.13 Origin of Life on Earth'
        ]
      },
      'Unit 8': {
        name: 'Ecology',
        weight: '10-15%',
        topics: [
          '8.1 Responses to the Environment',
          '8.2 Energy Flow Through Ecosystems',
          '8.3 Population Ecology',
          '8.4 Effect of Density of Populations',
          '8.5 Community Ecology',
          '8.6 Biodiversity',
          '8.7 Disruptions to Ecosystems'
        ]
      }
    };

    function openAISuggestions() {
      var aiModal = document.getElementById('ai-suggestions-modal');
      if (aiModal) {
        aiModal.style.display = 'flex';
        updateAICurrentQuestion();
        initAPBioTagger();
      }
    }

    function closeAISuggestions() {
      var aiModal = document.getElementById('ai-suggestions-modal');
      if (aiModal) {
        aiModal.style.display = 'none';
      }
    }

    function updateAICurrentQuestion() {
      var currentQEl = document.getElementById('ai-current-question');
      if (!currentQEl) return;

      var currentQ = questions[selectedQuestionIndex];
      if (currentQ && currentQ.questionText) {
        currentQEl.textContent = '"' + currentQ.questionText.substring(0, 150) + (currentQ.questionText.length > 150 ? '...' : '') + '"';
      } else {
        currentQEl.textContent = '"No question text entered"';
      }
    }

    function initAPBioTagger() {
      var unitSelect = document.getElementById('apbio-unit-select');
      var topicSelect = document.getElementById('apbio-topic-select');
      var preview = document.getElementById('apbio-preview');
      var previewText = document.getElementById('apbio-tag-preview');

      // Reset state
      unitSelect.value = '';
      topicSelect.innerHTML = '<option value="">-- Select Unit First --</option>';
      topicSelect.disabled = true;
      document.getElementById('bigidea-evo').checked = false;
      document.getElementById('bigidea-ene').checked = false;
      document.getElementById('bigidea-ist').checked = false;
      document.getElementById('bigidea-syi').checked = false;
      preview.classList.add('hidden');

      // Pre-fill from current question if it has AP Bio tags
      var currentQ = questions[selectedQuestionIndex];
      if (currentQ && currentQ.topicTag) {
        var tag = currentQ.topicTag;
        // Try to extract unit from existing tag
        var unitMatch = tag.match(/Unit \d/);
        if (unitMatch) {
          unitSelect.value = unitMatch[0];
          populateTopicsForUnit(unitMatch[0]);
        }
      }

      // Unit change handler
      unitSelect.onchange = function () {
        populateTopicsForUnit(this.value);
        updateTagPreview();
      };

      // Topic change handler
      topicSelect.onchange = updateTagPreview;

      // Big idea change handlers
      ['bigidea-evo', 'bigidea-ene', 'bigidea-ist', 'bigidea-syi'].forEach(function (id) {
        document.getElementById(id).onchange = updateTagPreview;
      });
    }

    function populateTopicsForUnit(unitKey) {
      var topicSelect = document.getElementById('apbio-topic-select');

      if (!unitKey || !AP_BIO_CURRICULUM[unitKey]) {
        topicSelect.innerHTML = '<option value="">-- Select Unit First --</option>';
        topicSelect.disabled = true;
        return;
      }

      var unit = AP_BIO_CURRICULUM[unitKey];
      topicSelect.innerHTML = '<option value="">-- Select Topic --</option>';
      unit.topics.forEach(function (topic) {
        var option = document.createElement('option');
        option.value = topic;
        option.textContent = topic;
        topicSelect.appendChild(option);
      });
      topicSelect.disabled = false;
    }

    function updateTagPreview() {
      var preview = document.getElementById('apbio-preview');
      var previewText = document.getElementById('apbio-tag-preview');
      var unitSelect = document.getElementById('apbio-unit-select');
      var topicSelect = document.getElementById('apbio-topic-select');

      var parts = [];

      // Unit
      if (unitSelect.value && AP_BIO_CURRICULUM[unitSelect.value]) {
        parts.push(unitSelect.value + ': ' + AP_BIO_CURRICULUM[unitSelect.value].name);
      }

      // Topic
      if (topicSelect.value) {
        parts.push(topicSelect.value);
      }

      // Big Ideas
      var bigIdeas = [];
      if (document.getElementById('bigidea-evo').checked) bigIdeas.push('EVO');
      if (document.getElementById('bigidea-ene').checked) bigIdeas.push('ENE');
      if (document.getElementById('bigidea-ist').checked) bigIdeas.push('IST');
      if (document.getElementById('bigidea-syi').checked) bigIdeas.push('SYI');

      if (bigIdeas.length > 0) {
        parts.push('Big Ideas: ' + bigIdeas.join(', '));
      }

      if (parts.length > 0) {
        previewText.textContent = parts.join(' | ');
        preview.classList.remove('hidden');
      } else {
        preview.classList.add('hidden');
      }
    }

    function generateAISuggestions() {
      // This now applies the AP Bio topic tag
      var unitSelect = document.getElementById('apbio-unit-select');
      var topicSelect = document.getElementById('apbio-topic-select');

      if (!unitSelect.value) {
        veritasAlert('Please select a unit before applying the tag.', { title: 'AP Bio Topic Tagger' });
        return;
      }

      var tagParts = [];

      // Build the tag
      if (unitSelect.value && AP_BIO_CURRICULUM[unitSelect.value]) {
        tagParts.push(unitSelect.value);
      }

      if (topicSelect.value) {
        tagParts.push(topicSelect.value);
      }

      var bigIdeas = [];
      if (document.getElementById('bigidea-evo').checked) bigIdeas.push('EVO');
      if (document.getElementById('bigidea-ene').checked) bigIdeas.push('ENE');
      if (document.getElementById('bigidea-ist').checked) bigIdeas.push('IST');
      if (document.getElementById('bigidea-syi').checked) bigIdeas.push('SYI');

      if (bigIdeas.length > 0) {
        tagParts.push('[' + bigIdeas.join(', ') + ']');
      }

      var finalTag = tagParts.join(' | ');

      // Apply to current question
      questions[selectedQuestionIndex].topicTag = finalTag;
      questions[selectedQuestionIndex].topic = finalTag; // Backward compatibility

      // Also store structured data for analytics
      questions[selectedQuestionIndex].apBioUnit = unitSelect.value;
      questions[selectedQuestionIndex].apBioTopic = topicSelect.value;
      questions[selectedQuestionIndex].apBioBigIdeas = bigIdeas;

      markPollDirty();
      renderQuestionWorkspace();
      closeAISuggestions();
      veritasAlert('AP Bio topic tag applied: ' + finalTag, { title: 'Topic Tagged!' });
    }



    // ============= NEW FEATURE: STIMULUS/PASSAGE =============
    function openStimulusModal() {
      var stimulusModal = document.getElementById('stimulus-modal');
      if (stimulusModal) {
        stimulusModal.style.display = 'flex';
        // Clear inputs
        document.getElementById('stimulus-title-input').value = '';
        document.getElementById('stimulus-content-input').value = '';
        document.getElementById('stimulus-question-count').value = '2';
      }
    }

    function closeStimulusModal() {
      var stimulusModal = document.getElementById('stimulus-modal');
      if (stimulusModal) {
        stimulusModal.style.display = 'none';
      }
    }

    function createStimulusWithQuestions() {
      var title = (document.getElementById('stimulus-title-input').value || '').trim();
      var content = (document.getElementById('stimulus-content-input').value || '').trim();
      var questionCount = parseInt(document.getElementById('stimulus-question-count').value, 10) || 2;

      if (!title && !content) {
        veritasAlert('Please enter a stimulus title or content.', { title: 'Stimulus Required' });
        return;
      }

      // Create a unique stimulus ID
      var stimulusId = 'stimulus-' + Date.now();

      // Create the specified number of questions linked to this stimulus
      for (var i = 0; i < questionCount; i++) {
        var newQuestion = {
          questionText: '',
          answers: [{ text: '' }, { text: '' }],
          correctAnswerIndex: 0,
          metacognitionEnabled: false,
          topicTag: '',
          difficultyLevel: '',
          // Stimulus reference
          stimulusId: stimulusId,
          stimulusTitle: title,
          stimulusContent: content,
          isStimulus: i === 0 // First question shows the stimulus
        };
        assignQuestionId(newQuestion);
        questions.push(newQuestion);
        ensureCustomOrderIncludes(newQuestion._id);
      }

      closeStimulusModal();
      enforceQuestionOrder();
      renderQuestionNavigator();
      renderQuestionWorkspace();
      markPollDirty();
      veritasAlert(questionCount + ' question(s) created with stimulus "' + (title || 'Untitled') + '"', { title: 'Stimulus Created' });
    }

    function addQuestion(suppressDirty) {
      var skipDirty = suppressDirty === true;
      var currentSelection = questions[selectedQuestionIndex];
      var insertIndex = customQuestionOrder.length;
      if (currentSelection && currentSelection._id) {
        var manualIndex = customQuestionOrder.indexOf(currentSelection._id);
        if (manualIndex !== -1) {
          insertIndex = manualIndex + 1;
        }
      }
      var newQuestion = {
        questionText: '',
        questionImage: null,
        questionImageURL: null,
        questionImageFileId: null,
        answers: [
          { text: '', image: null, imageURL: null, imageFileId: null },
          { text: '', image: null, imageURL: null, imageFileId: null }
        ],
        correctAnswerIndex: 0,
        timerSeconds: null,
        metacognitionEnabled: false
      };
      assignQuestionId(newQuestion);
      questions.push(newQuestion);
      ensureCustomOrderIncludes(newQuestion._id, insertIndex);
      enforceQuestionOrder(newQuestion._id);
      if (!skipDirty) {
        markPollDirty();
      }
      renderQuestionNavigator();
      renderQuestionWorkspace();
    }

    async function deleteQuestion(index) {
      if (questions.length <= 1) {
        await veritasAlert('A poll must have at least one question.', { title: 'Edit poll' });
        return;
      }
      var removedQuestion = questions[index];
      var removedId = removedQuestion && removedQuestion._id;
      questions.splice(index, 1);
      if (removedId) {
        removeFromCustomOrder(removedId);
      }
      if (selectedQuestionIndex >= questions.length) {
        selectedQuestionIndex = Math.max(0, questions.length - 1);
      }
      enforceQuestionOrder();
      renderQuestionNavigator();
      renderQuestionWorkspace();
      markPollDirty();
    }

    async function duplicateQuestionLocal(index) {
      if (questions.length >= 50) {
        await veritasAlert('Maximum 50 questions per poll. Cannot duplicate.', { title: 'Edit poll' });
        return;
      }
      // Deep copy the question
      var questionToDuplicate = questions[index];
      if (!questionToDuplicate) return;
      var duplicatedQuestion = JSON.parse(JSON.stringify(questionToDuplicate));
      delete duplicatedQuestion._id;
      delete duplicatedQuestion._createdOrder;
      assignQuestionId(duplicatedQuestion);
      duplicatedQuestion._createdOrder = Date.now();

      // Insert the duplicated question right after the original
      questions.splice(index + 1, 0, duplicatedQuestion);
      var manualIndex = questionToDuplicate._id ? customQuestionOrder.indexOf(questionToDuplicate._id) : -1;
      var insertIndex = manualIndex === -1 ? customQuestionOrder.length : manualIndex + 1;
      ensureCustomOrderIncludes(duplicatedQuestion._id, insertIndex);
      questionCounter++;

      enforceQuestionOrder(duplicatedQuestion._id);
      renderQuestionNavigator();
      renderQuestionWorkspace();
      markPollDirty();
    }

    function renderQuestionNavigator() {
      var nav = document.getElementById('question-navigator');
      nav.innerHTML = '';
      draggedQuestionId = null;
      clearDragVisuals();

      questions.forEach(function (q, index) {
        var isSelected = index === selectedQuestionIndex;
        var div = document.createElement('div');
        div.className = 'question-nav-item group relative flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer ' + (isSelected ? 'bg-primary/20 dark:bg-primary/30' : 'hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10');

        var html = '<span class="material-symbols-outlined ' + (isSelected ? 'text-brand-dark-gray dark:text-brand-white' : 'text-brand-dark-gray/50 dark:text-brand-white/50') + '">drag_indicator</span>';
        html += '<p class="' + (isSelected ? 'text-primary dark:text-brand-white' : 'text-brand-dark-gray dark:text-brand-white') + ' text-sm font-medium leading-normal">Question ' + (index + 1) + '</p>';

        html += '<div class="absolute right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">';
        html += '<button class="duplicate-question-btn p-1 rounded-full hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10" data-index="' + index + '" title="Duplicate question">';
        html += '<span class="material-symbols-outlined text-brand-dark-gray dark:text-brand-white text-base">content_copy</span>';
        html += '</button>';
        if (questions.length > 1) {
          html += '<button class="delete-question-btn p-1 rounded-full hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10" data-index="' + index + '" title="Delete question">';
          html += '<span class="material-symbols-outlined text-brand-dark-gray dark:text-brand-white text-base">close</span>';
          html += '</button>';
        }
        html += '</div>';

        div.innerHTML = html;
        div.dataset.questionId = q && q._id ? q._id : ('question-' + index);
        div.dataset.index = index;
        div.setAttribute('draggable', 'true');
        div.addEventListener('dragstart', handleQuestionDragStart);
        div.addEventListener('dragover', handleQuestionDragOver);
        div.addEventListener('dragleave', handleQuestionDragLeave);
        div.addEventListener('drop', handleQuestionDrop);
        div.addEventListener('dragend', handleQuestionDragEnd);

        div.onclick = function (e) {
          if (e.target.classList.contains('material-symbols-outlined') && (e.target.textContent === 'close' || e.target.textContent === 'content_copy')) return;
          selectedQuestionIndex = index;
          renderQuestionNavigator();
          renderQuestionWorkspace();
        };

        var duplicateBtn = div.querySelector('.duplicate-question-btn');
        if (duplicateBtn) {
          duplicateBtn.onclick = function (e) {
            e.stopPropagation();
            duplicateQuestionLocal(parseInt(this.dataset.index));
          };
        }

        var closeBtn = div.querySelector('.delete-question-btn');
        if (closeBtn) {
          closeBtn.onclick = function (e) {
            e.stopPropagation();
            deleteQuestion(parseInt(this.dataset.index));
          };
        }

        nav.appendChild(div);
      });
    }

    function renderQuestionWorkspace() {
      var workspace = document.getElementById('question-builder-workspace');
      var question = questions[selectedQuestionIndex];

      var html = '<div class="max-w-4xl mx-auto">';
      html += '<div class="flex flex-wrap justify-between gap-3 mb-6">';
      html += '<div class="flex min-w-72 flex-col gap-1">';
      html += '<p class="text-brand-dark-gray dark:text-brand-white tracking-light text-[32px] font-bold leading-tight">Question ' + (selectedQuestionIndex + 1) + '</p>';
      html += '<p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm font-normal leading-normal">Edit the question and answer choices below.</p>';
      html += '</div></div>';

      html += '<div class="bg-brand-white dark:bg-brand-dark-gray/20 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/30 p-6 shadow-sm mb-6">';
      html += '<label class="flex flex-col w-full">';
      html += '<p class="text-brand-dark-gray dark:text-brand-white text-base font-medium leading-normal pb-2">Question Text</p>';
      html += '<textarea id="question-text-input" class="form-input flex w-full min-w-0 flex-1 resize-y overflow-hidden rounded-lg text-brand-dark-gray dark:text-brand-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 focus:border-primary min-h-36 placeholder:text-brand-dark-gray/50 dark:placeholder:text-brand-white/50 p-[15px] text-base font-normal leading-normal" placeholder="Type your question here...">' + escapeHtml(question.questionText || '') + '</textarea>';
      html += '</label>';
      html += '<div class="grid w-full max-w-xs items-center gap-1.5 mt-4">';
      html += '<label for="question-image-input" class="text-sm text-gray-400 font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Question Image</label>';
      html += '<input id="question-image-input" type="file" accept="image/*" class="flex h-10 w-full rounded-md border border-brand-light-gray dark:border-brand-dark-gray/50 bg-white dark:bg-brand-dark-gray/30 px-3 py-2 text-sm text-gray-400 file:border-0 file:bg-transparent file:text-gray-600 dark:file:text-gray-300 file:text-sm file:font-medium focus:outline-none focus:ring-2 focus:ring-primary/50">';
      html += '</div>';

      // Show image preview or uploading state
      var questionImagePreview = getImagePreviewUrl(question.questionImage || question.questionImageURL, question.questionImageFileId);
      var isUploading = question.questionImage === 'UPLOADING';

      if (questionImagePreview || isUploading) {
        html += '<div class="mt-4 flex flex-wrap items-center gap-3 bg-primary/5 dark:bg-primary/10 p-3 rounded-lg">';
        if (isUploading) {
          html += '<div class="flex items-center gap-2 text-primary dark:text-brand-white">';
          html += '<div class="h-5 w-5 animate-spin rounded-full border-2 border-primary border-t-transparent"></div>';
          html += '<span class="text-sm font-medium">Uploading image...</span>';
          html += '</div>';
        } else if (questionImagePreview) {
          html += '<img src="' + questionImagePreview + '" class="rounded-lg max-w-xs h-auto" referrerpolicy="no-referrer">';
          html += '<button type="button" class="remove-question-image-btn h-9 px-4 rounded-lg bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-sm font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors">Remove Image</button>';
        }
        html += '</div>';
      }

      html += '<div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">';
      html += '<div>';
      html += '<label class="text-brand-dark-gray dark:text-brand-white text-sm font-medium leading-normal block pb-2" for="question-topic-input">Topic/Standard Tag</label>';
      html += '<input id="question-topic-input" type="text" class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="e.g., Cell Division, Algebra, etc." value="' + escapeHtml(question.topicTag || question.topic || '') + '">';
      html += '<p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-1">Used for topic-level analytics.</p>';
      html += '</div>';

      // NEW FEATURE: Difficulty Level Selector
      html += '<div>';
      html += '<label class="text-brand-dark-gray dark:text-brand-white text-sm font-medium leading-normal block pb-2" for="question-difficulty-select">Difficulty Level</label>';
      html += '<select id="question-difficulty-select" class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">';
      var difficultyValue = question.difficultyLevel || '';
      html += '<option value=""' + (difficultyValue === '' ? ' selected' : '') + '>-- Select --</option>';
      html += '<option value="easy"' + (difficultyValue === 'easy' ? ' selected' : '') + '> Easy</option>';
      html += '<option value="medium"' + (difficultyValue === 'medium' ? ' selected' : '') + '> Medium</option>';
      html += '<option value="hard"' + (difficultyValue === 'hard' ? ' selected' : '') + '> Hard</option>';
      html += '</select>';
      html += '<p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-1">Compare predicted vs actual difficulty.</p>';
      html += '</div>';

      html += '<div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700/30 rounded-lg p-3">';
      html += '<div class="flex items-start gap-2">';
      html += '<input type="checkbox" id="question-metacognition-input" class="mt-0.5 h-4 w-4 rounded border-blue-300 dark:border-blue-600 text-blue-600 focus:ring-blue-500 cursor-pointer" ' + (question.metacognitionEnabled ? 'checked' : '') + ' />';
      html += '<div class="flex-1">';
      html += '<label for="question-metacognition-input" class="text-brand-dark-gray dark:text-brand-white text-xs font-semibold leading-normal cursor-pointer block">Enable Metacognition Assessment</label>';
      html += '<p class="text-xs text-brand-dark-gray/70 dark:text-brand-white/70 mt-1">Ask students how confident they are in their answer.</p>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
      html += '</div>';

      html += '</div>';

      html += '<div class="bg-brand-white dark:bg-brand-dark-gray/20 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/30 p-6 shadow-sm">';
      html += '<p class="text-brand-dark-gray dark:text-brand-white text-base font-medium leading-normal pb-4">Answer Choices</p>';
      html += '<div class="flex flex-col gap-4">';

      question.answers.forEach(function (answer, aIndex) {
        html += renderAnswerChoice(answer, aIndex, question.correctAnswerIndex === aIndex);
      });

      html += '</div>';
      html += '<div class="mt-4">';
      html += '<button id="add-answer-btn" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-light-gray dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/60 transition-colors">';
      html += '<span class="truncate">+ Add Answer Choice</span>';
      html += '</button></div></div></div>';

      workspace.innerHTML = html;

      document.getElementById('question-text-input').oninput = function () {
        questions[selectedQuestionIndex].questionText = this.value;
        markPollDirty();
      };

      var qImgInput = document.getElementById('question-image-input');
      if (qImgInput) {
        qImgInput.onchange = function () {
          if (this.files && this.files[0]) {
            var file = this.files[0];

            // Show loading state
            var currentQuestion = questions[selectedQuestionIndex];
            currentQuestion.questionImage = 'UPLOADING';
            currentQuestion.questionImageURL = null;
            renderQuestionWorkspace();

            // Upload immediately to Drive
            uploadFile(file).then(function (fileId) {
              // Store the fileId (not URL) - URLs generated at render time via proxy
              questions[selectedQuestionIndex].questionImageFileId = fileId;
              questions[selectedQuestionIndex].questionImage = null;
              questions[selectedQuestionIndex].questionImageURL = null;
              markPollDirty();
              renderQuestionWorkspace();
            }).catch(async function (error) {
              await veritasAlert('Image upload failed: ' + (error.message || error), { title: 'Upload image', destructive: true });
              questions[selectedQuestionIndex].questionImage = null;
              questions[selectedQuestionIndex].questionImageFileId = null;
              questions[selectedQuestionIndex].questionImageURL = null;
              renderQuestionWorkspace();
            });
          }
        };
      }

      var removeQImgBtn = workspace.querySelector('.remove-question-image-btn');
      if (removeQImgBtn) {
        removeQImgBtn.onclick = function () {
          questions[selectedQuestionIndex].questionImage = null;
          questions[selectedQuestionIndex].questionImageURL = null;
          questions[selectedQuestionIndex].questionImageFileId = null;
          markPollDirty();
          renderQuestionWorkspace();
        };
      }

      var topicInput = document.getElementById('question-topic-input');
      if (topicInput) {
        topicInput.oninput = function () {
          questions[selectedQuestionIndex].topicTag = this.value.trim();
          questions[selectedQuestionIndex].topic = this.value.trim(); // Backward compatibility
          markPollDirty();
        };
      }

      var metacognitionInput = document.getElementById('question-metacognition-input');
      if (metacognitionInput) {
        metacognitionInput.onchange = function () {
          questions[selectedQuestionIndex].metacognitionEnabled = this.checked;
          markPollDirty();
        };
      }

      // NEW FEATURE: Difficulty Level handler
      var difficultySelect = document.getElementById('question-difficulty-select');
      if (difficultySelect) {
        difficultySelect.onchange = function () {
          questions[selectedQuestionIndex].difficultyLevel = this.value;
          markPollDirty();
        };
      }

      document.getElementById('add-answer-btn').onclick = function () {
        questions[selectedQuestionIndex].answers.push({ text: '', image: null, imageURL: null, imageFileId: null });
        markPollDirty();
        renderQuestionWorkspace();
      };

      workspace.querySelectorAll('.answer-text-input').forEach(function (input, index) {
        input.oninput = function () {
          questions[selectedQuestionIndex].answers[index].text = this.value;
          markPollDirty();
        };
      });

      workspace.querySelectorAll('.correct-radio').forEach(function (radio, index) {
        radio.onchange = function () {
          if (this.checked) {
            questions[selectedQuestionIndex].correctAnswerIndex = index;
            markPollDirty();
          }
        };
      });

      workspace.querySelectorAll('.delete-answer-btn').forEach(function (btn, index) {
        btn.onclick = function () {
          deleteAnswer(index);
        };
      });

      workspace.querySelectorAll('.answer-image-input').forEach(function (input, index) {
        input.onchange = function () {
          if (this.files && this.files[0]) {
            var file = this.files[0];

            // Show loading state
            var currentAnswer = questions[selectedQuestionIndex].answers[index];
            currentAnswer.image = 'UPLOADING';
            currentAnswer.imageURL = null;
            renderQuestionWorkspace();

            // Upload immediately to Drive
            uploadFile(file).then(function (fileId) {
              // Store the fileId (not URL) - URLs generated at render time via proxy
              questions[selectedQuestionIndex].answers[index].imageFileId = fileId;
              questions[selectedQuestionIndex].answers[index].image = null;
              questions[selectedQuestionIndex].answers[index].imageURL = null;
              markPollDirty();
              renderQuestionWorkspace();
            }).catch(async function (error) {
              await veritasAlert('Image upload failed: ' + (error.message || error), { title: 'Upload image', destructive: true });
              questions[selectedQuestionIndex].answers[index].image = null;
              questions[selectedQuestionIndex].answers[index].imageFileId = null;
              questions[selectedQuestionIndex].answers[index].imageURL = null;
              renderQuestionWorkspace();
            });
          }
        };
      });

      workspace.querySelectorAll('.remove-answer-image-btn').forEach(function (btn) {
        btn.onclick = function () {
          var idx = parseInt(this.dataset.index, 10);
          questions[selectedQuestionIndex].answers[idx].image = null;
          questions[selectedQuestionIndex].answers[idx].imageURL = null;
          questions[selectedQuestionIndex].answers[idx].imageFileId = null;
          markPollDirty();
          renderQuestionWorkspace();
        };
      });
    }

    function renderAnswerChoice(answer, index, isCorrect) {
      var html = '<div class="flex items-center gap-3">';
      html += '<label class="relative flex items-center justify-center cursor-pointer" title="Set as correct answer">';
      html += '<input class="correct-radio peer h-5 w-5 cursor-pointer appearance-none rounded-full border border-brand-light-gray dark:border-brand-white/30 checked:border-primary checked:bg-primary transition-all" name="correct_answer" type="radio" ' + (isCorrect ? 'checked' : '') + '/>';
      html += '<span class="material-symbols-outlined absolute text-brand-white transition-opacity opacity-0 peer-checked:opacity-100 text-sm">check</span>';
      html += '</label>';
      html += '<input class="answer-text-input form-input flex-1 rounded-lg text-brand-dark-gray dark:text-brand-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 focus:border-primary placeholder:text-brand-dark-gray/50 dark:placeholder:text-brand-white/50 p-3 text-base" placeholder="Answer ' + String.fromCharCode(65 + index) + '" type="text" value="' + escapeHtml(answer.text || '') + '"/>';
      html += '<label class="p-2 rounded-lg hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10 transition-colors cursor-pointer" title="Upload image for this answer">';
      html += '<span class="material-symbols-outlined text-brand-dark-gray/60 dark:text-brand-white/60">image</span>';
      html += '<input type="file" class="answer-image-input hidden" accept="image/*">';
      html += '</label>';

      if (questions[selectedQuestionIndex].answers.length > 2) {
        html += '<button class="delete-answer-btn p-2 rounded-lg hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10 transition-colors" title="Remove this answer">';
        html += '<span class="material-symbols-outlined text-brand-dark-gray/60 dark:text-brand-white/60">delete</span>';
        html += '</button>';
      } else {
        html += '<div class="w-10"></div>';
      }

      html += '</div>';

      // Show image preview or uploading state for answer choices
      var answerPreview = getImagePreviewUrl(answer.image || answer.imageURL, answer.imageFileId);
      var isAnswerUploading = answer.image === 'UPLOADING';

      if (answerPreview || isAnswerUploading) {
        html += '<div class="mt-2 flex items-center gap-3 bg-primary/5 dark:bg-primary/10 p-2 rounded-lg">';
        if (isAnswerUploading) {
          html += '<div class="flex items-center gap-2 text-primary dark:text-brand-white">';
          html += '<div class="h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent"></div>';
          html += '<span class="text-xs font-medium">Uploading...</span>';
          html += '</div>';
        } else if (answerPreview) {
          html += '<img src="' + answerPreview + '" class="rounded-md max-w-[160px] h-auto" referrerpolicy="no-referrer">';
          html += '<button type="button" class="remove-answer-image-btn h-8 px-3 rounded-md bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-xs font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors" data-index="' + index + '">Remove</button>';
        }
        html += '</div>';
      }

      return html;
    }

    async function deleteAnswer(index) {
      if (questions[selectedQuestionIndex].answers.length <= 2) {
        await veritasAlert('A question must have at least two answer choices.', { title: 'Edit poll' });
        return;
      }
      questions[selectedQuestionIndex].answers.splice(index, 1);
      if (questions[selectedQuestionIndex].correctAnswerIndex >= index) {
        questions[selectedQuestionIndex].correctAnswerIndex = Math.max(0, questions[selectedQuestionIndex].correctAnswerIndex - 1);
      }
      markPollDirty();
      renderQuestionWorkspace();
    }

    // Helper to get web app base URL for generating proxy URLs
    function getWebAppUrl() {
      // Use current page URL (web app deployment URL)
      var url = window.location.href;
      // Remove query parameters
      var baseUrl = url.split('?')[0];
      return baseUrl;
    }

    // Helper to generate Google Drive thumbnail URL from fileId
    function generateProxyUrl(fileId) {
      if (!fileId || typeof fileId !== 'string') {
        return '';
      }
      // Use Google Drive thumbnail API for direct image display
      // sz=w1000 specifies max width of 1000px (adjustable)
      return 'https://drive.google.com/thumbnail?id=' + encodeURIComponent(fileId) + '&sz=w1000';
    }

    function getImagePreviewUrl(imageData, fileId) {
      // If fileId is provided, generate proxy URL
      if (fileId && typeof fileId === 'string') {
        return generateProxyUrl(fileId);
      }

      // Otherwise handle legacy data
      if (imageData instanceof File) {
        return URL.createObjectURL(imageData);
      }
      if (typeof imageData === 'string' && imageData) {
        // Return the URL, unless it is the special UPLOADING marker
        if (imageData === 'UPLOADING') {
          return '';
        }
        return imageData;
      }
      return '';
    }

    // --- Poll & Image Uploader ---
    async function savePoll() {
      var savePollBtn = document.getElementById('save-poll-btn');
      var defaultLabel = editingPollId ? '<span class="truncate">Save Changes</span>' : '<span class="truncate">Publish Poll</span>';

      savePollBtn.disabled = true;
      savePollBtn.innerHTML = '<div class="h-5 w-5 animate-spin rounded-full border-2 border-primary border-t-transparent"></div><span>Saving...</span>';

      var pollName = document.getElementById('new-poll-name').value.trim();
      var className = (classSelect.value || '').trim();
      var currentSessionType = normalizeSessionTypeClient(pollSessionType);
      var securePayload = buildSecureAssessmentPayload();
      securePayload.sessionType = currentSessionType;

      if (!pollName || !className) {
        await veritasAlert('Please enter a poll name and select a class.', { title: 'Save poll' });
        savePollBtn.disabled = false;
        savePollBtn.innerHTML = defaultLabel;
        return;
      }

      if (isSecureSessionTypeClient(currentSessionType)) {
        if (!securePayload.timeLimitMinutes || securePayload.timeLimitMinutes <= 0) {
          await veritasAlert('Secure Assessments require a positive time limit.', { title: 'Save poll' });
          savePollBtn.disabled = false;
          savePollBtn.innerHTML = defaultLabel;
          return;
        }
      }

      if (questions.length === 0) {
        await veritasAlert('Please add at least one question.', { title: 'Save poll' });
        savePollBtn.disabled = false;
        savePollBtn.innerHTML = defaultLabel;
        return;
      }

      var validationError = '';
      questions.forEach(function (question, index) {
        if (validationError) return;
        var questionText = (question.questionText || '').trim();
        if (questionText === '') {
          validationError = 'Question ' + (index + 1) + ' needs question text.';
          return;
        }
        var answerTexts = question.answers.map(function (answer) { return (answer.text || '').trim(); });
        var filledAnswers = answerTexts.filter(function (text) { return text !== ''; });
        if (filledAnswers.length < 2) {
          validationError = 'Question ' + (index + 1) + ' must include at least two answer choices with text.';
          return;
        }
        var correctIndex = typeof question.correctAnswerIndex === 'number' ? question.correctAnswerIndex : 0;
        if (correctIndex < 0 || correctIndex >= answerTexts.length) {
          validationError = 'Question ' + (index + 1) + ' has an invalid correct answer selection.';
          return;
        }
        if (answerTexts[correctIndex] === '') {
          validationError = 'Question ' + (index + 1) + ' must mark a correct answer with text.';
        }
      });

      if (validationError) {
        await veritasAlert(validationError, { title: 'Save poll' });
        savePollBtn.disabled = false;
        savePollBtn.innerHTML = defaultLabel;
        return;
      }

      // Check for any images still uploading
      var uploadsInProgress = false;
      var uploadMessages = [];
      questions.forEach(function (question, index) {
        if (question.questionImage === 'UPLOADING') {
          uploadsInProgress = true;
          uploadMessages.push('Question ' + (index + 1) + ' image is still uploading. Please wait for upload to complete.');
        }
        question.answers.forEach(function (answer, aIndex) {
          if (answer.image === 'UPLOADING') {
            uploadsInProgress = true;
            uploadMessages.push('Question ' + (index + 1) + ', answer ' + (aIndex + 1) + ' image is still uploading. Please wait for upload to complete.');
          }
        });
      });

      if (uploadsInProgress) {
        await veritasAlert(uploadMessages.join('\n'), { title: 'Save poll' });
        savePollBtn.disabled = false;
        savePollBtn.innerHTML = defaultLabel;
        return;
      }

      // Build sanitized questions - all images should already be uploaded
      var sanitizedQuestions = questions.map(function (question) {
        var answers = question.answers.map(function (answer) {
          var text = (answer.text || '').trim();
          // Use imageFileId as canonical field (not URL)
          return {
            text: text,
            imageFileId: answer.imageFileId || null,
            imageURL: answer.imageURL || null  // Keep for backward compatibility
          };
        });

        var correctIndex = typeof question.correctAnswerIndex === 'number' ? question.correctAnswerIndex : 0;
        if (correctIndex < 0) { correctIndex = 0; }
        if (correctIndex >= answers.length) {
          correctIndex = Math.max(0, answers.length - 1);
        }

        var timerValue = null;
        if (typeof question.timerSeconds === 'number') {
          timerValue = question.timerSeconds;
        } else if (typeof question.timerSeconds === 'string' && question.timerSeconds.trim() !== '') {
          timerValue = parseInt(question.timerSeconds, 10);
        }
        if (timerValue && (!isFinite(timerValue) || timerValue <= 0)) {
          timerValue = null;
        }
        if (timerValue) {
          timerValue = Math.min(Math.round(timerValue), 600);
        }

        // Use questionImageFileId as canonical field (not URL)
        return {
          questionText: (question.questionText || '').trim(),
          questionImageFileId: question.questionImageFileId || null,
          questionImageURL: question.questionImageURL || null,  // Keep for backward compatibility
          answers: answers,
          correctAnswerIndex: correctIndex,
          timerSeconds: timerValue && timerValue > 0 ? timerValue : null,
          metacognitionEnabled: !!question.metacognitionEnabled
        };
      });

      try {
        var payloadQuestions = sanitizedQuestions.map(function (question) {
          var options = question.answers.map(function (answer) {
            var imageUrl = answer.imageURL || null;
            var imageFileId = answer.imageFileId || null;
            return {
              text: answer.text,
              image: imageUrl,
              imageURL: imageUrl,
              imageFileId: imageFileId
            };
          });
          var correctIndex = question.correctAnswerIndex;
          if (correctIndex < 0 || correctIndex >= options.length) {
            correctIndex = Math.max(0, options.length - 1);
          }
          var correctAnswerText = options[correctIndex] ? options[correctIndex].text : null;
          var imageUrl = question.questionImageURL || null;
          var imageFileId = question.questionImageFileId || null;
          return {
            questionText: question.questionText,
            questionImage: imageUrl,
            questionImageURL: imageUrl,
            questionImageFileId: imageFileId,
            options: options,
            correctAnswer: correctAnswerText,
            timerSeconds: question.timerSeconds || null,
            metacognitionEnabled: !!question.metacognitionEnabled
          };
        });

        // Validate payload before sending
        if (!payloadQuestions || payloadQuestions.length === 0) {
          await veritasAlert(' Error: No valid questions to save. Please check your poll data.', { title: 'Save poll', destructive: true });
          savePollBtn.disabled = false;
          savePollBtn.innerHTML = defaultLabel;
          return;
        }

        // Capture question count immediately for success message
        var questionCount = payloadQuestions.length;
        console.log('Saving poll with ' + questionCount + ' questions');

        if (PREVIEW_MODE) {
          var newPollRecord = {
            pollId: editingPollId || ('preview-poll-' + Date.now()),
            pollName: pollName,
            className: className,
            questions: payloadQuestions.map(function (q) {
              return {
                questionText: q.questionText,
                options: q.options,
                correctAnswer: q.correctAnswer,
                timerSeconds: q.timerSeconds || null,
                metacognitionEnabled: !!q.metacognitionEnabled
              };
            }),
            updatedAt: new Date().toISOString(),
            lastRunAt: null,
            createdAt: new Date().toISOString(),
            sessionType: currentSessionType,
            timeLimitMinutes: securePayload.timeLimitMinutes,
            accessCode: securePayload.accessCode,
            availableFrom: securePayload.availableFrom,
            dueBy: securePayload.dueBy,
            secureSettings: securePayload.secureSettings
          };
          if (editingPollId) {
            var existingIndex = ALL_POLLS.findIndex(function (p) { return p.pollId === editingPollId; });
            if (existingIndex !== -1) {
              newPollRecord.createdAt = ALL_POLLS[existingIndex].createdAt || newPollRecord.createdAt;
              ALL_POLLS[existingIndex] = newPollRecord;
            }
          } else {
            ALL_POLLS.push(newPollRecord);
          }
          refreshPollData(ALL_POLLS);
          resetPollDirty('Preview changes saved');
          savePollBtn.disabled = false;
          savePollBtn.innerHTML = defaultLabel;
          closePollCreator();
          await veritasAlert('Poll saved locally for preview. Use the live dashboard to publish changes.', { title: 'Save poll' });
          return;
        }

        // Firebase Cloud Functions for poll creation/editing
        try {
          var pollMetadata = {
            sessionType: currentSessionType,
            timeLimitMinutes: securePayload.timeLimitMinutes,
            accessCode: securePayload.accessCode,
            availableFrom: securePayload.availableFrom,
            dueBy: securePayload.dueBy,
            secureSettings: securePayload.secureSettings
          };

          var result;
          if (editingPollId) {
            // Update existing poll
            var updatePollFn = firebase.functions().httpsCallable('updatePoll');
            result = await updatePollFn({
              pollId: editingPollId,
              pollName: pollName,
              className: className,
              questions: payloadQuestions,
              metadata: pollMetadata
            });
          } else {
            // Create new poll
            var createPollFn = firebase.functions().httpsCallable('createPoll');
            result = await createPollFn({
              pollName: pollName,
              className: className,
              questions: payloadQuestions,
              metadata: pollMetadata
            });
          }

          if (result.data && result.data.success) {
            // OPTIMIZATION: Invalidate cache when data changes
            LocalCache.invalidate('dashboardData');

            // Reload polls from Firebase
            await loadInitialData();

            resetPollDirty('All changes saved');
            savePollBtn.disabled = false;
            savePollBtn.innerHTML = defaultLabel;

            // Generate success message
            var successMessage = editingPollId
              ? ' Poll updated successfully with ' + questionCount + ' question' + (questionCount === 1 ? '' : 's') + '!'
              : ' Poll created successfully with ' + questionCount + ' question' + (questionCount === 1 ? '' : 's') + '!';

            console.log(successMessage);

            var shouldSelectNew = !editingPollId;
            closePollCreator();
            if (shouldSelectNew) {
              pollSelect.value = '';
              onPollSelectChange();
            }
            await veritasAlert(successMessage, { title: 'Save poll' });
          } else {
            throw new Error(result.data?.error || 'Failed to save poll');
          }
        } catch (firebaseError) {
          console.error('Firebase poll save error:', firebaseError);
          if (typeof showUserFriendlyError === 'function') {
            showUserFriendlyError(firebaseError);
          } else {
            await veritasAlert(' Error saving poll: ' + (firebaseError.message || firebaseError), {
              title: 'Save poll',
              destructive: true
            });
          }
          savePollBtn.disabled = false;
          savePollBtn.innerHTML = defaultLabel;
        }
      } catch (err) {
        console.error('Upload/save error:', err);
        await veritasAlert(' Upload error: ' + (err.message || err), { title: 'Save poll', destructive: true });
        savePollBtn.disabled = false;
        savePollBtn.innerHTML = defaultLabel;
      }
    }

    function fileToBase64(file) {
      return new Promise(function (resolve, reject) {
        // Validate file input
        if (!file) {
          reject(new Error('No file provided'));
          return;
        }
        if (!(file instanceof File)) {
          reject(new Error('Invalid file object'));
          return;
        }
        if (!file.type.startsWith('image/')) {
          reject(new Error('File must be an image'));
          return;
        }
        if (file.size === 0) {
          reject(new Error('File is empty'));
          return;
        }
        if (file.size > 5 * 1024 * 1024) {
          reject(new Error('File exceeds 5MB limit'));
          return;
        }

        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function () {
          if (reader.result && typeof reader.result === 'string') {
            resolve(reader.result);
          } else {
            reject(new Error('Failed to read file data'));
          }
        };
        reader.onerror = function (error) {
          reject(new Error('File read error: ' + (error.message || 'Unknown error')));
        };
      });
    }

    function uploadFile(file) {
      return new Promise(function (resolve, reject) {
        // Validate file before processing
        if (!file) {
          reject(new Error('No file provided for upload'));
          return;
        }
        if (!file.name) {
          reject(new Error('File has no name'));
          return;
        }

        fileToBase64(file).then(function (dataUrl) {
          // Double-check dataUrl before sending
          if (!dataUrl || typeof dataUrl !== 'string') {
            reject(new Error('Invalid data URL generated from file'));
            return;
          }

          if (PREVIEW_MODE) {
            setTimeout(function () {
              resolve('preview-file-' + Date.now());
            }, 120);
            return;
          }

          var attempts = 0;
          var maxAttempts = 3;

          function doUpload() {
            attempts++;
            // FIREBASE MIGRATION: Upload to Firebase Storage
            var storageRef = firebase.storage().ref();
            var timestamp = Date.now();
            var safeName = (file.name || 'image').replace(/[^a-zA-Z0-9.-]/g, '_');
            var path = 'poll-images/uploads/' + timestamp + '-' + safeName;
            var imageRef = storageRef.child(path);

            imageRef.putString(dataUrl, 'data_url')
              .then(function (snapshot) {
                return snapshot.ref.getDownloadURL();
              })
              .then(function (url) {
                console.log('[Firebase Storage] Upload success:', url);
                resolve(url);
              })
              .catch(function (error) {
                console.error('[Firebase Storage] Upload failed:', error);
                // Check for retryable errors
                var msg = (error.message || '').toString();
                var isRetryable = msg.includes('retry') || msg.includes('network');

                if (isRetryable && attempts < maxAttempts) {
                  console.warn('Upload attempt ' + attempts + ' failed. Retrying...', error);
                  setTimeout(doUpload, attempts * 2000);
                } else {
                  reject(new Error(error.message || 'Image upload failed'));
                }
              });
          }

          doUpload();

        }).catch(function (error) {
          reject(new Error('File conversion error: ' + (error.message || error)));
        });
      });
    }

    // --- Utilities ---
    function formatDateTime(value) {
      if (!value) return '';
      var date = new Date(value);
      if (isNaN(date.getTime())) {
        return value;
      }
      return date.toLocaleString();
    }

    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * Formats student names for roster/status displays.
     * Accepts either a student object (with first/last/display fields) or a raw string.
     * Prefers "First Last" when both are available, otherwise falls back to the most
     * descriptive identifier (display name, original string, or email).
     * @param {Object|string} student - Student object or name string
     * @returns {string} Formatted name
     */
    function formatStudentName(student) {
      if (!student) return '';

      if (typeof student === 'string') {
        var raw = student.trim();
        if (!raw) return '';
        var pieces = raw.split(/\s+/).filter(Boolean);
        if (pieces.length >= 2) {
          return pieces[0] + ' ' + pieces[pieces.length - 1];
        }
        return pieces[0] || '';
      }

      var first = (student.firstName || '').trim();
      var last = (student.lastName || '').trim();
      if (first || last) {
        return (first + ' ' + last).trim();
      }

      if (student.displayName) {
        return formatStudentName(student.displayName);
      }

      if (student.name) {
        return formatStudentName(student.name);
      }

      if (student.email) {
        return student.email;
      }

      return '';
    }

    async function handleError(error) {
      mainLoader.style.display = 'none';
      console.error('Error:', error);

      // Extract error message and avoid "Error: Error:" duplication
      var errorMsg = (error && error.message ? error.message : error) || 'Unknown error';
      var errorString = String(errorMsg);

      // Remove "Error: " prefix if it exists since title already indicates error
      if (typeof errorMsg === 'string' && errorMsg.indexOf('Error: ') === 0) {
        errorMsg = errorMsg.substring(7); // Remove "Error: " prefix
      }

      // Handle generic network errors
      if (errorString.includes('NetworkError') || errorString.includes('HTTP 0') || errorString.includes('Connection failure')) {
        errorMsg = 'Network connection interrupted. Please check your internet connection and try again.';
      }

      await veritasAlert(errorMsg, {
        title: 'Something went wrong',
        destructive: true
      });
    }

    // Expand question image in modal
    window.expandQuestionImage = function () {
      var imgSrc = document.getElementById('live-question-image').src;
      var modalHtml = '<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;" onclick="this.remove()">';
      modalHtml += '<img src="' + imgSrc + '" style="max-width:90%;max-height:90%;"/>';
      modalHtml += '</div>';
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    };

    // Post-Poll Analytics Modal Event Handlers
    var viewAnalyticsBtn = document.getElementById('view-analytics-btn');
    if (viewAnalyticsBtn) {
      viewAnalyticsBtn.addEventListener('click', function () {
        if (selectedArchivedPollId) {
          openPostPollAnalytics(selectedArchivedPollId);
        }
      });
    }

    var closeAnalyticsBtn = document.getElementById('close-analytics-modal-btn');
    if (closeAnalyticsBtn) {
      closeAnalyticsBtn.addEventListener('click', function () {
        document.getElementById('post-poll-analytics-modal').style.display = 'none';
      });
    }

    // Close modal on backdrop click
    document.getElementById('post-poll-analytics-modal').addEventListener('click', function (e) {
      if (e.target === this) {
        this.style.display = 'none';
      }
    });

    // Student Status Filter Buttons
    var filterLockedBtn = document.getElementById('filter-locked-only-btn');
    if (filterLockedBtn) {
      filterLockedBtn.addEventListener('click', function () {
        studentStatusFilter = 'locked';
        var statusSelect = document.getElementById('student-status-filter-select');
        if (statusSelect) {
          statusSelect.value = 'locked';
        }
        syncStatusFilterButtons();
        renderStudentStatus();
      });
    }

    var filterAllBtn = document.getElementById('filter-all-btn');
    if (filterAllBtn) {
      filterAllBtn.addEventListener('click', function () {
        studentStatusFilter = 'all';
        var statusSelect = document.getElementById('student-status-filter-select');
        if (statusSelect) {
          statusSelect.value = 'all';
        }
        syncStatusFilterButtons();
        renderStudentStatus();
      });
    }

    syncStatusFilterButtons();

    // Violations Alert Dismiss Button
    var dismissViolationsBtn = document.getElementById('dismiss-violations-alert');
    if (dismissViolationsBtn) {
      dismissViolationsBtn.addEventListener('click', function () {
        violationsAlertDismissed = true;
        document.getElementById('violations-alert-panel').classList.add('hidden');
      });
    }

    // Enhanced exited students panel event listeners (2025)
    var approveAllBtn = document.getElementById('approve-all-unlocks-btn');
    if (approveAllBtn) {
      approveAllBtn.addEventListener('click', approveAllUnlocks);
    }

    var toggleExitedPanelBtn = document.getElementById('toggle-exited-panel-btn');
    if (toggleExitedPanelBtn) {
      toggleExitedPanelBtn.addEventListener('click', function () {
        var list = document.getElementById('exited-students-list-inline');
        if (!list) return;

        var icon = this.querySelector('.material-symbols-outlined');
        if (list.style.display === 'none') {
          list.style.display = '';
          if (icon) {
            icon.textContent = 'expand_more';
          }
        } else {
          list.style.display = 'none';
          if (icon) {
            icon.textContent = 'expand_less';
          }
        }
      });
    }

    // ==========================================================================
    // ENHANCED UI FEATURES (2025 Redesign)
    // ==========================================================================

    // Quick Time Preset Buttons (+30s, +1m)
    var add30sPresetBtn = document.getElementById('add-30s-btn-preset');
    if (add30sPresetBtn) {
      add30sPresetBtn.addEventListener('click', function () {
        if (!isRunning) {
          editTime(30);
        }
      });
    }

    var add60sPresetBtn = document.getElementById('add-60s-btn-preset');
    if (add60sPresetBtn) {
      add60sPresetBtn.addEventListener('click', function () {
        if (!isRunning) {
          editTime(60);
        }
      });
    }

    // Card/Table View Toggle for Dashboard
    var viewCardsBtn = document.getElementById('view-cards-btn');
    var viewTableBtn = document.getElementById('view-table-btn');
    // pollsCardView and pollsTableView moved to top of scope

    if (viewCardsBtn && viewTableBtn && pollsCardView && pollsTableView) {
      // Default to card view
      viewCardsBtn.classList.add('active');

      viewCardsBtn.addEventListener('click', function () {
        pollsCardView.classList.remove('hidden');
        pollsTableView.classList.add('hidden');
        viewCardsBtn.classList.add('active');
        viewTableBtn.classList.remove('active');
        localStorage.setItem('vlp_poll_view', 'cards');
      });

      viewTableBtn.addEventListener('click', function () {
        pollsCardView.classList.add('hidden');
        pollsTableView.classList.remove('hidden');
        viewTableBtn.classList.add('active');
        viewCardsBtn.classList.remove('active');
        localStorage.setItem('vlp_poll_view', 'table');
      });

      // Restore saved view preference
      var savedView = localStorage.getItem('vlp_poll_view');
      if (savedView === 'table') {
        viewTableBtn.click();
      }
    }

    // Keyboard Shortcuts for Live Poll Session
    document.addEventListener('keydown', function (e) {
      // Only activate shortcuts when NOT typing in an input/textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
        return;
      }

      // Only during live session
      if (!isLiveSession) return;

      switch (e.key) {
        case 'ArrowRight':
        case 'n':
        case 'N':
          // Next Question
          e.preventDefault();
          var nextBtn = document.getElementById('header-next-btn');
          if (nextBtn && !nextBtn.disabled && nextBtn.offsetParent !== null) {
            nextBtn.click();
          }
          break;

        case 'ArrowLeft':
        case 'b':
        case 'B':
          // Back/Previous Question
          e.preventDefault();
          var backBtn = document.getElementById('header-back-btn');
          if (backBtn && !backBtn.disabled && backBtn.offsetParent !== null) {
            backBtn.click();
          }
          break;

        case ' ':
        case 'Spacebar':
          // Toggle Timer (Start/Pause)
          e.preventDefault();
          if (isRunning) {
            pauseTimer();
          } else if (totalSeconds > 0) {
            startTimer();
          }
          break;

        case 'r':
        case 'R':
          // Reset Timer
          e.preventDefault();
          if (!isRunning) {
            resetTimer();
          }
          break;

        case 'e':
        case 'E':
          // End & Reveal
          e.preventDefault();
          var endShowBtn = document.getElementById('header-end-show-btn');
          if (endShowBtn && !endShowBtn.disabled && endShowBtn.offsetParent !== null) {
            endShowBtn.click();
          }
          break;
      }
    });

    // Auto-Pulse "Next Question" Button When All Responded
    // This is called from updateLiveOverviewFromData
    window.checkAllRespondedState = function (allHaveResponded) {
      if (!isLiveSession) return;
      var nextBtn = document.getElementById('header-next-btn');
      if (!nextBtn) return;

      // Only pulse if it is not the last question
      var isLastQuestion = CURRENT_POLL_DATA.questionIndex >= CURRENT_POLL_DATA.totalQuestions - 1;

      if (allHaveResponded && !isLastQuestion) {
        nextBtn.classList.add('pulse-ready');
      } else {
        nextBtn.classList.remove('pulse-ready');
      }
    };

    // Quick Time Preset Buttons (+30s, +1m)
    var add30sPresetBtn = document.getElementById('add-30s-btn-preset');
    if (add30sPresetBtn) {
      add30sPresetBtn.addEventListener('click', function () {
        if (!isRunning) {
          editTime(30);
        }
      });
    }

    var add60sPresetBtn = document.getElementById('add-60s-btn-preset');
    if (add60sPresetBtn) {
      add60sPresetBtn.addEventListener('click', function () {
        if (!isRunning) {
          editTime(60);
        }
      });
    }

    console.log(' Teacher Panel Ready (Enhanced UI)');

    // --- FIREBASE MISSION CONTROL ---

    // CRITICAL FIX: Initialize Firebase app eagerly at page load
    // This ensures firebase.apps.length === 1 immediately, not just when a poll is active.
    // The user reported firebase.apps.length === 0 on teacher panel - this fixes it.
    (function initFirebaseEagerly() {
      var debugInfo = {
        firebasePresent: typeof firebase !== 'undefined',
        configPresent: typeof FIREBASE_CONFIG !== 'undefined' && !!FIREBASE_CONFIG,
        databaseURL: (typeof FIREBASE_CONFIG !== 'undefined' && FIREBASE_CONFIG) ? FIREBASE_CONFIG.databaseURL : null,
        appsLengthBefore: (typeof firebase !== 'undefined' && firebase.apps) ? firebase.apps.length : 'n/a',
        initCalled: false,
        success: false
      };

      if (typeof firebase !== 'undefined' && FIREBASE_CONFIG) {
        if (!firebase.apps.length) {
          try {
            firebase.initializeApp(FIREBASE_CONFIG);
            debugInfo.initCalled = true;
            debugInfo.success = true;
          } catch (e) {
            console.error('[Firebase] Failed to initialize app:', e);
            debugInfo.error = e.message;
          }
        } else {
          debugInfo.success = true; // Already initialized
        }
        // Store firebaseDb reference for later use
        if (!firebaseDb && firebase.apps.length > 0) {
          firebaseDb = firebase.database();
        }
        debugInfo.appsLengthAfter = firebase.apps.length;
      } else {
        if (typeof firebase === 'undefined') {
          console.error('[Firebase] SDK not loaded! Check script tags in Teacher_View.html');
        }
        if (!FIREBASE_CONFIG) {
          console.error('[Firebase] FIREBASE_CONFIG not available!');
        }
      }

      // Single clean debug log line as requested
      console.log('[Firebase Init] databaseURL=' + debugInfo.databaseURL +
        ', firebasePresent=' + debugInfo.firebasePresent +
        ', appsLength=' + debugInfo.appsLengthAfter +
        ', initCalled=' + debugInfo.initCalled +
        ', success=' + debugInfo.success);
    })();

    async function broadcastSessionState(pollId, state) {
      if (!pollId || !state) return;

      var questionDef = (CURRENT_POLL_DATA && CURRENT_POLL_DATA.questions && typeof state.questionIndex === 'number') ?
        CURRENT_POLL_DATA.questions[state.questionIndex] : null;

      var finalQuestionText = state.questionText || (questionDef ? questionDef.questionText : '') || 'Question ' + ((state.questionIndex || 0) + 1);
      var finalOptions = state.options || (questionDef ? questionDef.options : []);

      // PHASE 2 MIGRATION: Try Cloud Function First
      // This is the "Gold Standard" - single authority, fast, logged.
      if (firebase && firebase.functions) {
        try {
          if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);

          var setLiveSessionState = firebase.functions().httpsCallable('setLiveSessionState');
          console.log('[Firebase] Calling Cloud Function: setLiveSessionState...');

          var correctAns = state.correctAnswer || (questionDef ? questionDef.correctAnswer : null);

          var result = await setLiveSessionState({
            pollId: pollId,
            status: state.status || 'OPEN',
            questionIndex: state.questionIndex,
            questionText: finalQuestionText,
            correctAnswer: correctAns, // Secure transmission to CF
            options: finalOptions
          });
          console.log('[Firebase] Cloud Function Success:', result.data);
          return;
        } catch (e) {
          console.warn('[Firebase] Cloud Function failed userspace, falling back to legacy RTDB write:', e);
          // Fall through to legacy write
        }
      }

      // FALLBACK (Legacy Mode) -> Direct RTDB Write
      if (!firebaseDb) return;

      var signalPath = 'sessions/' + pollId + '/live_session';
      var signalRef = firebaseDb.ref(signalPath);

      var payload = {
        pollId: pollId,
        questionIndex: state.questionIndex,
        status: state.status || 'OPEN',
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        sessionPhase: state.sessionPhase || 'LIVE',
        resultsVisibility: state.resultsVisibility || 'HIDDEN',
        questionText: finalQuestionText,
        questionImageURL: state.questionImageURL || (questionDef ? questionDef.questionImageURL : ''),
        options: finalOptions,
        metadata: {
          sessionPhase: state.sessionPhase || 'LIVE',
          resultsVisibility: state.resultsVisibility || 'HIDDEN',
          isCollecting: (state.status === 'OPEN')
        }
      };

      signalRef.set(payload).catch(function (e) {
        console.warn('[Firebase] Broadcast to live_session failed:', e);
      });
    }

    // Module-level tracking for cleanup
    var currentConnectedRef = null;

    function initFirebaseMissionControl(pollId) {
      if (!FIREBASE_CONFIG || !pollId) return;

      // FIX TASK A: Cleanup previous listeners when pollId changes to prevent leaks
      if (firebaseRef && currentMissionControlPollId !== pollId) {
        console.log('[Firebase] Cleaning up listeners for previous pollId:', currentMissionControlPollId);
        firebaseRef.off();
        firebaseRef = null;

        // Cleanup violations listener
        if (violationsRef) {
          violationsRef.off();
          violationsRef = null;
        }

        // Cleanup connected listener
        if (currentConnectedRef) {
          currentConnectedRef.off();
          currentConnectedRef = null;
        }
      }

      // Prevent double init for same pollId
      if (firebaseRef && currentMissionControlPollId === pollId) {
        console.log('[Firebase] Already subscribed to pollId:', pollId);
        return;
      }

      // Firebase app should already be initialized by initFirebaseEagerly()
      // But check again just in case
      if (typeof firebase !== 'undefined' && !firebase.apps.length) {
        firebase.initializeApp(FIREBASE_CONFIG);
        console.log('[Firebase] Late init in initFirebaseMissionControl');
      }

      if (typeof firebase !== 'undefined') {
        firebaseDb = firebase.database();

        var path = 'sessions/' + pollId + '/students';
        firebaseRef = firebaseDb.ref(path);
        currentMissionControlPollId = pollId;

        // P0-2 FIX: Store actual subscribed path
        actualSubscribedPath = firebaseRef.toString();

        // Connection State
        currentConnectedRef = firebaseDb.ref('.info/connected');
        currentConnectedRef.on('value', function (snap) {
          realtimeConnected = snap.val() === true;
          console.log('[Firebase] Connection status changed:', realtimeConnected ? 'CONNECTED' : 'DISCONNECTED', 'pollId:', pollId);

          // ADAPTIVE POLLING: Reduce server load when Firebase is active
          // Periodic polling is now primarily for metrics (progress/score)
          // Realtime status (ACTIVE/LOCKED) is handled via Firebase events
          var newInterval = realtimeConnected ? 30000 : 2500;

          if (missionControlHeartbeat && missionControlHeartbeat.isRunning()) {
            console.log('[Adaptive Polling] Updating Mission Control heartbeat to ' + newInterval + 'ms');
            missionControlHeartbeat.updateInterval(newInterval);
          }

          if (pollInterval) {
            console.log('[Adaptive Polling] Updating Live Poll interval to ' + newInterval + 'ms');
            clearInterval(pollInterval);
            currentPollInterval = newInterval;
            pollInterval = setInterval(pollForResults, currentPollInterval);
          } else {
            currentPollInterval = newInterval; // Set for next start
          }

          // P0-2 FIX: Record event
          lastRTDBEvent = { timestamp: Date.now(), type: 'connection' };
          updateRealtimeIndicator();
          updateDebugHud();
        });

        // Listen for student status changes
        firebaseRef.on('child_changed', async function (snapshot) {
          // P0-2 FIX: Record status change
          var studentKey = snapshot.key;
          var newStatus = snapshot.val();
          var previousStatus = realtimeStatuses[studentKey];

          lastStatusChange = { studentKey: studentKey, status: newStatus, timestamp: Date.now() };
          lastRTDBEvent = { timestamp: Date.now(), type: 'child_changed' };
          console.log('[Firebase] Student status changed:', studentKey.substring(0, 8) + '...', previousStatus, '', newStatus);

          // Show toast when student resumes (LOCKED or not-ACTIVE -> ACTIVE)
          if (newStatus === 'ACTIVE' && previousStatus && previousStatus !== 'ACTIVE') {
            // Find student name from current data
            var studentName = null;

            // Check mission control students first
            if (missionControlStudents && currentMissionControlPollId) {
              for (var i = 0; i < missionControlStudents.length; i++) {
                var s = missionControlStudents[i];
                var key = await window.VeritasShared.generateStudentKey(s.email, currentMissionControlPollId);
                if (key === studentKey) {
                  studentName = s.name || s.email;
                  break;
                }
              }
            }

            // Check live poll students if not found
            if (!studentName && currentStudentStatusData && CURRENT_POLL_DATA && CURRENT_POLL_DATA.pollId) {
              for (var j = 0; j < currentStudentStatusData.length; j++) {
                var student = currentStudentStatusData[j];
                var sKey = await window.VeritasShared.generateStudentKey(student.email, CURRENT_POLL_DATA.pollId);
                if (sKey === studentKey) {
                  studentName = student.name || student.email;
                  break;
                }
              }
            }

            // Show toast notification
            showToast('info', 'Student Resumed', (studentName || 'A student') + ' has re-entered the session.', 3000);
          }
        });

        firebaseRef.on('child_added', function (snapshot) {
          lastRTDBEvent = { timestamp: Date.now(), type: 'child_added' };

          // TASK: Instant Render on Join (Latency Fix)
          var studentKey = snapshot.key;
          var status = snapshot.val();
          var studentEmail = studentKey.replace(/,/g, '.'); // Restore email

          if (!missionControlStudents) missionControlStudents = [];

          // Check for duplication
          var exists = missionControlStudents.some(function (s) { return s.email === studentEmail; });

          if (!exists) {
            console.log('[Firebase] New student detected via Fast Path:', studentEmail);
            // Add temp student object (Name will be Email until full sync)
            var newStudent = {
              name: studentEmail, // Temporary display name
              email: studentEmail,
              status: status,
              proctorStatus: status === 'ACTIVE' ? 'ACTIVE' : 'LOCKED', // Infer from status
              progress: 0,
              score: 0
            };

            missionControlStudents.push(newStudent);

            // Sort by name (email) to keep list tidy
            missionControlStudents.sort(function (a, b) {
              return (a.name || '').localeCompare(b.name || '');
            });

            // Update UI immediately
            // We pass a synthetic view object
            renderIndividualStudentCards({ students: missionControlStudents });

            // Also update realtime UI to apply any locks/status
            updateRealtimeUI();
          }
        });

        // Listen for changes
        firebaseRef.on('value', function (snapshot) {
          realtimeStatuses = snapshot.val() || {};
          console.log('[Firebase] Status update received for pollId:', pollId, 'Students:', Object.keys(realtimeStatuses).length);
          lastRTDBEvent = { timestamp: Date.now(), type: 'value' };
          updateRealtimeUI();
          updateDebugHud();
        });

        // P0-3 FIX: Listen to violations node
        violationsRef = firebaseDb.ref('sessions/' + pollId + '/violations');
        violationsRef.on('child_added', function (snapshot) {
          var studentKey = snapshot.key;
          var violation = snapshot.val();
          if (violation && violation.reason) {
            lastViolation = { studentKey: studentKey, reason: violation.reason, timestamp: Date.now() };
            console.log('[Firebase] Violation detected:', studentKey.substring(0, 8) + '...', '-', violation.reason);
            updateDebugHud();
          }
        });

        violationsRef.on('child_changed', function (snapshot) {
          var studentKey = snapshot.key;
          var violation = snapshot.val();
          if (violation && violation.reason) {
            lastViolation = { studentKey: studentKey, reason: violation.reason, timestamp: Date.now() };
            console.log('[Firebase] Violation updated:', studentKey.substring(0, 8) + '...', '-', violation.reason);
            updateDebugHud();
          }
        });

        // FAST PATH: Listen for answers (Live Results)
        var answersRef = firebaseDb.ref('answers/' + pollId);
        answersRef.on('child_added', function (snapshot) {
          var answer = snapshot.val();
          if (answer && answer.questionIndex !== undefined) {
            // Update live results UI instantly
            handleRealtimeAnswer(answer);
          }
        });

        console.log('[Firebase] Mission Control initialized for', path, 'Connected:', realtimeConnected);
        console.log('[Firebase] Actual subscription:', actualSubscribedPath);
      }
    }

    /**
     * Handle incoming realtime answer from Firebase
     */
    function handleRealtimeAnswer(payload) {
      // Ensure we are in a live session state where results matter
      if (!CURRENT_POLL_DATA || CURRENT_POLL_DATA.pollId !== payload.pollId) return;

      // Find student in current list
      var student = currentStudentStatusData.find(function (s) { return s.email === payload.studentEmail; });
      if (student) {
        // Update progress locally
        var newProgress = Math.max(student.progress || 0, (payload.questionIndex || 0) + 1);
        student.progress = newProgress;
        student.status = 'In Progress'; // Ensure status is active

        // UI UPDATE: Find the card and update the progress bar/text immediately
        var card = document.querySelector('.student-status-card[data-email="' + CSS.escape(student.email) + '"]');
        if (card) {
          var progressBar = card.querySelector('.progress-bar-fill');
          var progressText = card.querySelector('.progress-text');
          var statusBadge = card.querySelector('.status-badge');

          if (progressBar && student.totalQuestions > 0) {
            var pct = Math.min(100, Math.round((newProgress / student.totalQuestions) * 100));
            progressBar.style.width = pct + '%';

            // Add pulse animation
            progressBar.classList.remove('pulse-once');
            void progressBar.offsetWidth; // force reflow
            progressBar.classList.add('pulse-once');
          }

          if (progressText) {
            progressText.textContent = newProgress + '/' + student.totalQuestions;
          }

          if (statusBadge) {
            statusBadge.textContent = 'In Progress';
            statusBadge.className = 'status-badge bg-emerald-100 text-emerald-800';
          }
        }

        console.log('[Firebase] Realtime Answer processed for:', payload.studentEmail);
      }
    }

    function updateRealtimeIndicator() {
      var indicator = document.getElementById('realtime-indicator');
      if (!indicator) {
        var headerMeta = document.getElementById('individual-session-meta');
        if (headerMeta) {
          var badge = document.createElement('span');
          badge.id = 'realtime-indicator';
          badge.className = 'ml-4 inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-bold';
          headerMeta.appendChild(badge);
        }
      }

      var badgeEl = document.getElementById('realtime-indicator');
      if (badgeEl) {
        if (realtimeConnected) {
          badgeEl.className = 'ml-4 inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700 border border-green-200';
          badgeEl.innerHTML = '<span class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></span> Realtime Active';
        } else {
          if (typeof window.USING_FALLBACK_CONFIG !== 'undefined' && window.USING_FALLBACK_CONFIG) {
            badgeEl.className = 'ml-4 inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700 border border-red-200 cursor-pointer hover:bg-red-200';
            badgeEl.innerHTML = '<span class="material-symbols-outlined text-sm">warning</span> Setup Required';
            badgeEl.title = 'Firebase Config Missing. Click for instructions.';
            badgeEl.onclick = function () { alert('ACTION REQUIRED:\n\nThe app is not connected to a backend because FIREBASE_CONFIG is missing.\n\nPlease refer to the SETUP_GUIDE.md to configure your Script Properties.'); };
          } else {
            badgeEl.className = 'ml-4 inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700 border border-red-200';
            badgeEl.innerHTML = '<span class="h-2 w-2 rounded-full bg-red-500"></span> Realtime OFF (Polling mode)';
          }
        }
      }
    }

    async function updateRealtimeUI() {
      var updatesFound = false;

      // FIX TASK A: Update BOTH Mission Control (Individual Timed) AND Live Poll student lists
      // This ensures realtime updates work for ALL proctored sessions, not just Individual Timed

      // 1. Update Mission Control students (Individual Timed / Secure Assessment)
      if (missionControlStudents && currentMissionControlPollId) {
        await Promise.all(missionControlStudents.map(async function (student) {
          var key = await window.VeritasShared.generateStudentKey(student.email, currentMissionControlPollId);
          var rtStatus = realtimeStatuses[key];

          if (rtStatus) {
            var newStatus = student.status;
            var newConnection = student.connection ? student.connection.status : 'GRAY';

            if (rtStatus === 'ACTIVE') {
              if (student.status !== 'Submitted') {
                newStatus = 'In Progress';
              }
              newConnection = 'GREEN';
            } else if (rtStatus === 'LOCKED') {
              newStatus = 'LOCKED';
              student.proctorStatus = 'LOCKED';
              newConnection = 'GREEN';
            } else if (rtStatus === 'DISCONNECTED') {
              newConnection = 'RED';
            } else if (rtStatus === 'FINISHED') {
              newStatus = 'Submitted';
              newConnection = 'GREEN';
            }

            if (student.status !== newStatus || (student.connection && student.connection.status !== newConnection)) {
              student.status = newStatus;
              if (!student.connection) student.connection = {};
              student.connection.status = newConnection;
              updatesFound = true;
            }
          }
        }));

        if (updatesFound) {
          renderIndividualStudentCards({ students: missionControlStudents });
        }
      }

      // 2. Update Live Poll students (currentStudentStatusData)
      if (currentStudentStatusData && currentStudentStatusData.length > 0 && CURRENT_POLL_DATA && CURRENT_POLL_DATA.pollId) {
        var livePollUpdatesFound = false;
        await Promise.all(currentStudentStatusData.map(async function (student) {
          var key = await window.VeritasShared.generateStudentKey(student.email, CURRENT_POLL_DATA.pollId);
          var rtStatus = realtimeStatuses[key];

          if (rtStatus) {
            var newStatus = student.status;

            // Map Firebase status to Live Poll status strings
            if (rtStatus === 'ACTIVE') {
              if (student.status !== 'Submitted') {
                newStatus = 'In Progress';
              }
            } else if (rtStatus === 'LOCKED') {
              newStatus = 'LOCKED';
              student.proctorStatus = 'LOCKED';
            } else if (rtStatus === 'DISCONNECTED') {
              // Keep current status but could add offline indicator
            } else if (rtStatus === 'FINISHED') {
              newStatus = 'Submitted';
            }

            if (student.status !== newStatus) {
              student.status = newStatus;
              livePollUpdatesFound = true;
            }
          }
        }));

        if (livePollUpdatesFound) {
          renderStudentStatus();
        }
      }


    }

    async function setFirebaseStatus(email, status) {
      // FIX TASK A: Support both Mission Control and Live Poll pollIds
      var activePollId = currentMissionControlPollId || (CURRENT_POLL_DATA && CURRENT_POLL_DATA.pollId);
      if (!firebaseRef || !email || !activePollId) return;
      var key = await window.VeritasShared.generateStudentKey(email, activePollId);
      firebaseRef.child(key).set(status);
    }

    // DEBUG HUD - Enhanced for verification
    var lastTeacherAction = { action: 'None', timestamp: null };
    var lastRTDBEvent = { timestamp: null, type: 'None' };
    var lastStatusChange = { studentKey: null, status: null, timestamp: null };
    var lastViolation = { studentKey: null, reason: null, timestamp: null };
    var actualSubscribedPath = null;
    var violationsRef = null;

    function updateDebugHud() {
      if (!Veritas.Config.DEBUG_FIREBASE) return;

      var hud = document.getElementById('firebase-debug-hud');
      if (!hud) {
        hud = document.createElement('div');
        hud.id = 'firebase-debug-hud';
        hud.style.cssText = 'position:fixed;bottom:10px;right:10px;background:rgba(0,0,0,0.95);color:#4ade80;font-family:monospace;font-size:11px;padding:12px;z-index:9999;pointer-events:none;max-width:380px;border:2px solid #4ade80;border-radius:8px;line-height:1.4;';
        document.body.appendChild(hud);
      }

      var connDot = realtimeConnected ? '<span style="color:#4ade80"></span>' : '<span style="color:#f87171"></span>';
      var html = '<strong style="color:#fff"> FIREBASE DEBUG (TEACHER)</strong><br>';
      html += connDot + ' <strong>.info/connected:</strong> ' + realtimeConnected + '<br>';
      html += '<strong>PollId (sessionKey):</strong> ' + (currentMissionControlPollId || 'None') + '<br>';

      // P0-2 FIX: Show ACTUAL subscribed path (not string-built)
      html += '<strong>Actual RTDB Path:</strong> ' + (actualSubscribedPath || 'Not subscribed') + '<br>';
      html += '<strong>Students observed:</strong> ' + Object.keys(realtimeStatuses).length + '<br>';

      // Show sample statuses with violation reasons
      var keys = Object.keys(realtimeStatuses);
      if (keys.length > 0) {
        html += '<strong>Sample statuses:</strong><br>';
        keys.slice(0, 2).forEach(function (key) {
          var statusColor = realtimeStatuses[key] === 'LOCKED' ? '#f87171' :
            realtimeStatuses[key] === 'ACTIVE' ? '#4ade80' : '#facc15';
          html += '   ' + key.substring(0, 8) + '...: <span style="color:' + statusColor + '">' + realtimeStatuses[key] + '</span><br>';
        });
      }

      // P0-2 FIX: Show last RTDB event timestamp
      if (lastRTDBEvent.timestamp) {
        var eventElapsed = Math.round((Date.now() - lastRTDBEvent.timestamp) / 1000);
        html += '<strong>Last RTDB event:</strong> ' + lastRTDBEvent.type + ' (' + eventElapsed + 's ago)<br>';
      }

      // P0-2 FIX: Show last status change
      if (lastStatusChange.timestamp && lastStatusChange.studentKey) {
        var changeElapsed = Math.round((Date.now() - lastStatusChange.timestamp) / 1000);
        html += '<strong>Last change:</strong> ' + lastStatusChange.studentKey.substring(0, 8) + '...  ' + lastStatusChange.status + ' (' + changeElapsed + 's ago)<br>';
      }

      // P0-3 FIX: Show last violation reason
      if (lastViolation.timestamp && lastViolation.studentKey) {
        var violationElapsed = Math.round((Date.now() - lastViolation.timestamp) / 1000);
        html += '<strong style="color:#f87171">Last violation:</strong> ' + lastViolation.studentKey.substring(0, 8) + '... - ' + lastViolation.reason + ' (' + violationElapsed + 's ago)<br>';
      }

      // Last teacher action
      if (lastTeacherAction.timestamp) {
        var elapsed = Math.round((Date.now() - lastTeacherAction.timestamp) / 1000);
        html += '<strong>Last action:</strong> ' + lastTeacherAction.action + ' (' + elapsed + 's ago)<br>';
      }

      hud.innerHTML = html;
    }

    function recordTeacherAction(action) {
      lastTeacherAction = { action: action, timestamp: Date.now() };
      updateDebugHud();
    }

    // --- Individual Timed Session ---
    function onStartIndividualTimed() {
      var pollId = pollSelect.value;
      if (!pollId) {
        veritasAlert('Please select a poll first.', { title: 'Individual Timed Session' });
        return;
      }
      setButtonLoading(startPollBtn, true, 'Starting...');

      // FIREBASE MIGRATION: Start session via Cloud Function
      var setLiveSessionState = firebase.functions().httpsCallable('setLiveSessionState');
      var sessionId = pollId + '::' + Date.now(); // Generate client-side session ID

      // Fetch poll details to get time limit (optional but good for metadata)
      var poll = pollsData.find(p => p.pollId === pollId) || {};
      var timeLimit = poll.timeLimitMinutes || 60;

      setLiveSessionState({
        pollId: pollId,
        status: 'OPEN',
        metadata: {
          reason: 'SECURE_ASSESSMENT_RUNNING',
          sessionPhase: 'SECURE_ASSESSMENT_RUNNING', // Use explicit string or import config
          startedAt: new Date().toISOString(),
          sessionId: sessionId,
          timeLimitMinutes: timeLimit,
          isCollecting: true,
          resultsVisibility: 'HIDDEN'
        }
      }).then(function (result) {
        setButtonLoading(startPollBtn, false);
        // Construct view object needed for showIndividualTimedView
        var view = {
          success: true,
          pollId: pollId,
          sessionId: sessionId,
          pollName: poll.pollName || 'Secure Assessment',
          className: poll.className || '',
          timeLimitMinutes: timeLimit,
          questionCount: poll.questions ? poll.questions.length : 0
        };
        showIndividualTimedView(view);
      }).catch(function (error) {
        setButtonLoading(startPollBtn, false);
        // Simple error handling
        var msg = error.message || 'Unknown error starting session';
        veritasAlert(msg, { title: 'Unable to Start Session', destructive: true });
      });
    }

    function showIndividualTimedView(view) {
      if (!view) return;
      setMainSection('individual-timed');
      currentMissionControlPollId = view.pollId;
      currentSecureSessionId = view.sessionId;
      CURRENT_POLL_DATA.pollId = view.pollId;
      CURRENT_POLL_DATA.sessionId = view.sessionId;
      CURRENT_POLL_DATA.pollName = view.pollName;
      CURRENT_POLL_DATA.className = view.className;
      CURRENT_POLL_DATA.timeLimitMinutes = view.timeLimitMinutes || 0;
      CURRENT_POLL_DATA.questionCount = view.totalQuestions || view.questionCount || 0;
      var pollNameEl = document.getElementById('individual-session-poll-name');
      if (pollNameEl) {
        pollNameEl.textContent = view.pollName + '  ' + (view.className || '');
      }
      var metaEl = document.getElementById('individual-session-meta');
      if (metaEl) {
        var limitLabel = view.timeLimitMinutes ? view.timeLimitMinutes + ' min limit' : 'Untimed';
        metaEl.textContent = limitLabel + '  ' + (view.students ? view.students.length : 0) + ' learners';
      }

      // INIT FIREBASE (or re-assert UI if already init)
      initFirebaseMissionControl(view.pollId);
      // Force UI update if already connected (because metaEl might have been wiped)
      if (realtimeConnected) {
        updateRealtimeIndicator();
      }

      renderIndividualStudentCards(view);
      pollIndividualSessionState();

      missionControlHeartbeat.stop();
      missionControlHeartbeat.start(true);
    }
    window.showIndividualTimedView = showIndividualTimedView; // Expose for testing

    function renderIndividualStudentCards(view) {
      var grid = document.getElementById('individual-session-students-grid');
      if (!grid) return;
      var students = (view && view.students) ? view.students : [];
      missionControlStudents = students.slice();
      grid.innerHTML = '';

      // Check for new violations
      students.forEach(function (student) {
        var isLocked = student.proctorStatus === 'LOCKED' || student.status === 'Locked' || (student.status && student.status.indexOf('Locked') === 0);
        if (isLocked) {
          if (!previouslyLockedEmails.has(student.email)) {
            showToast('error', 'Security Violation', student.name + ' has been locked.');
            previouslyLockedEmails.add(student.email);
          }
        } else {
          if (previouslyLockedEmails.has(student.email)) {
            previouslyLockedEmails.delete(student.email);
          }
        }
      });

      if (students.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'col-span-full text-center py-10 text-slate-500';
        empty.textContent = 'Students will appear here as they join the assessment.';
        grid.appendChild(empty);
      } else {
        pruneMissionSelection(students);
        students.forEach(function (student) {
          var statusClass = 'bg-slate-100 text-slate-700';
          var statusLower = (student.status || '').toString().toLowerCase();
          if (statusLower.indexOf('in progress') === 0) {
            statusClass = 'bg-emerald-50 text-emerald-700';
          } else if (statusLower.indexOf('locked') === 0) {
            statusClass = 'bg-red-50 text-red-700';
          } else if (statusLower.indexOf('blocked') === 0) {
            statusClass = 'bg-red-50 text-red-700';
          } else if (student.status === 'Awaiting Fullscreen') {
            statusClass = 'bg-blue-50 text-blue-700';
          } else if (student.status === 'Paused') {
            statusClass = 'bg-amber-50 text-amber-700';
          } else if (student.status === 'Submitted') {
            statusClass = 'bg-slate-200 text-slate-700';
          }

          var connectionClass = 'bg-slate-300';
          var connectionLabel = 'No data';
          var connectionStatus = student.connection ? student.connection.status : 'GRAY';
          if (connectionStatus === 'GREEN') {
            connectionClass = 'bg-emerald-400';
            connectionLabel = 'Synced';
          } else if (connectionStatus === 'YELLOW') {
            connectionClass = 'bg-amber-400';
            connectionLabel = 'Reconnecting';
          } else if (connectionStatus === 'RED') {
            connectionClass = 'bg-red-500';
            connectionLabel = 'Offline';
          }

          var timeLabel = student.timeRemainingSeconds != null
            ? formatTime(student.timeRemainingSeconds)
            : '--:--';
          var progressPct = student.progressPct != null ? student.progressPct : 0;
          var progressDisplay = `Q ${student.progress || 0} / ${student.totalQuestions || 0}`;
          var manageDisabled = student.status === 'Not Started';
          var selected = missionControlSelectedEmails.has(student.email);
          var answeredCount = student.progress || 0;
          var correctCount = typeof student.correctCount === 'number' ? student.correctCount : null;
          var totalQuestions = student.totalQuestions || 0;
          var scoreSummary = (answeredCount > 0 && correctCount !== null)
            ? `${correctCount} correct`
            : (answeredCount > 0 ? 'Responses recorded' : 'Awaiting responses');
          var scorePctSummary = (typeof student.scorePct === 'number' && totalQuestions > 0 && answeredCount > 0)
            ? `${Math.round(student.scorePct)}% of exam`
            : '';
          var progressFillClass = 'bg-emerald-500';
          if (statusLower.indexOf('locked') === 0) {
            progressFillClass = 'bg-red-500';
          } else if (statusLower.indexOf('blocked') === 0) {
            progressFillClass = 'bg-red-500';
          } else if (student.status === 'Paused') {
            progressFillClass = 'bg-amber-500';
          }
          var requiresUnlock = student.proctorStatus === 'LOCKED' || student.proctorStatus === 'BLOCKED' || statusLower.indexOf('locked') === 0 || statusLower.indexOf('blocked') === 0;

          var card = document.createElement('div');
          var baseCardClass = 'mission-student-card rounded-2xl border border-slate-200 dark:border-brand-dark-gray/60 bg-white dark:bg-brand-dark-gray/30 p-4 shadow-sm flex flex-col gap-3 transition-all';
          if (selected) {
            baseCardClass += ' ring-2 ring-amber-400 ring-opacity-70 shadow-lg';
          }
          card.className = baseCardClass;
          card.dataset.email = student.email;
          card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-base font-semibold text-brand-dark-gray dark:text-white">${escapeHtml(student.name)}</p>
              <div class="flex items-center gap-2 flex-wrap mt-1">
                <span class="inline-flex px-2.5 py-1 text-xs font-semibold rounded-full ${statusClass}">${student.status}</span>
                ${renderTelemetryPill(student.telemetry)}
              </div>
            </div>
            <div class="flex items-center gap-3 text-xs text-slate-500">
              <button type="button" class="mission-select-btn rounded-full border border-slate-300 dark:border-slate-600 p-1.5 text-slate-500 hover:text-veritas-navy" data-action="toggle-select" data-email="${student.email}" aria-pressed="${selected ? 'true' : 'false'}" title="Select student">
                <span class="material-symbols-outlined text-base" data-role="selection-icon">${selected ? 'check_circle' : 'radio_button_unchecked'}</span>
              </button>
              <div class="flex items-center gap-1.5">
                <span class="h-2.5 w-2.5 rounded-full ${connectionClass}"></span>
                <span>${connectionLabel}</span>
              </div>
            </div>
          </div>
          <div>
            <div class="flex items-center justify-between text-xs text-slate-500 mb-1">
              <span>${progressDisplay}</span>
              <span>Remaining ${timeLabel}</span>
            </div>
            <div class="w-full h-2 rounded-full bg-slate-100 dark:bg-slate-800">
              <div class="h-2 rounded-full ${progressFillClass}" style="width: ${progressPct}%"></div>
            </div>
            <div class="flex items-center justify-between text-xs text-slate-600 mt-2">
              <span class="font-semibold">${scoreSummary}</span>
              <span>${scorePctSummary}</span>
            </div>
          </div>
          <div class="flex flex-col gap-2 pt-1">
            <button class="mission-manage-btn inline-flex items-center justify-center gap-2 rounded-full border border-slate-300 dark:border-slate-600 px-4 py-2 text-sm font-semibold text-brand-dark-gray dark:text-white hover:bg-slate-50 disabled:opacity-60" data-action="manage-student" data-email="${student.email}" ${manageDisabled ? 'disabled' : ''}>
              <span class="material-symbols-outlined text-base">tune</span>
              Manage
            </button>
            ${requiresUnlock ? `<button type="button" class="inline-flex items-center justify-center gap-2 rounded-full border border-blue-200 text-blue-700 bg-blue-50 px-4 py-2 text-xs font-semibold hover:bg-blue-100" data-action="unlock-student" data-email="${student.email}" data-lock-version="${student.lockVersion || 0}">
              <span class="material-symbols-outlined text-base">lock_open_right</span>
              <span>Approve re-entry</span>
            </button>` : ''}
          </div>
        `;
          grid.appendChild(card);
        });
      }

      updateMissionControlSummary(view && view.summary ? view.summary : {});
      attachManageHandlers();
      attachSelectionHandlers();
      attachUnlockHandlers();
      syncManagedStudentState();
      syncMissionSelectionIndicators();
      updateBulkControlsState();
    }

    function pruneMissionSelection(students) {
      if (!missionControlSelectedEmails.size) { return; }
      var existing = new Set(students.map(function (student) { return student.email; }));
      Array.from(missionControlSelectedEmails).forEach(function (email) {
        if (!existing.has(email)) {
          missionControlSelectedEmails.delete(email);
        }
      });
    }

    function attachSelectionHandlers() {
      var toggles = document.querySelectorAll('#individual-session-students-grid [data-action="toggle-select"]');
      toggles.forEach(function (toggle) {
        toggle.addEventListener('click', function (event) {
          event.preventDefault();
          event.stopPropagation();
          toggleStudentSelection(toggle.dataset.email);
        });
      });
    }

    function attachUnlockHandlers() {
      var buttons = document.querySelectorAll('#individual-session-students-grid [data-action="unlock-student"]');
      buttons.forEach(function (btn) {
        btn.addEventListener('click', function (event) {
          event.preventDefault();
          event.stopPropagation();
          if (!currentMissionControlPollId) { return; }
          var email = btn.dataset.email;
          var lockVersion = Number(btn.dataset.lockVersion || 0);
          approveStudentUnlock(email, currentMissionControlPollId, lockVersion, btn);
        });
      });
    }

    function toggleStudentSelection(email) {
      if (!email) { return; }
      if (missionControlSelectedEmails.has(email)) {
        missionControlSelectedEmails.delete(email);
      } else {
        missionControlSelectedEmails.add(email);
      }
      syncMissionSelectionIndicators();
      updateBulkControlsState();
    }

    function clearMissionSelection() {
      if (!missionControlSelectedEmails.size) { return; }
      missionControlSelectedEmails.clear();
      syncMissionSelectionIndicators();
      updateBulkControlsState();
    }

    function syncMissionSelectionIndicators() {
      var cards = document.querySelectorAll('#individual-session-students-grid .mission-student-card');
      cards.forEach(function (card) {
        var email = card.dataset.email;
        var selected = email && missionControlSelectedEmails.has(email);
        card.classList.toggle('ring-2', !!selected);
        card.classList.toggle('ring-amber-400', !!selected);
        card.classList.toggle('ring-opacity-70', !!selected);
        card.classList.toggle('shadow-lg', !!selected);
        var icon = card.querySelector('[data-role="selection-icon"]');
        if (icon) {
          icon.textContent = selected ? 'check_circle' : 'radio_button_unchecked';
        }
        var toggle = card.querySelector('[data-action="toggle-select"]');
        if (toggle) {
          toggle.setAttribute('aria-pressed', selected ? 'true' : 'false');
        }
      });
    }

    function updateBulkControlsState() {
      if (bulkSelectionCount) {
        bulkSelectionCount.textContent = missionControlSelectedEmails.size;
      }
      if (bulkSelectionClear) {
        bulkSelectionClear.classList.toggle('hidden', missionControlSelectedEmails.size === 0);
      }
      if (!bulkControlsLoading && bulkSelectedLabel) {
        bulkSelectedLabel.textContent = missionControlSelectedEmails.size > 0
          ? 'Add to selected (' + missionControlSelectedEmails.size + ')'
          : 'Add to selected';
      }
      if (!bulkControlsLoading && bulkTimeSelectedBtn) {
        var disabled = missionControlSelectedEmails.size === 0 || !currentMissionControlPollId || !currentSecureSessionId;
        bulkTimeSelectedBtn.disabled = disabled;
        bulkTimeSelectedBtn.classList.toggle('opacity-60', disabled);
      }
    }

    function setBulkControlsLoading(isLoading, scope) {
      bulkControlsLoading = !!isLoading;
      if (bulkTimeAllBtn) {
        bulkTimeAllBtn.disabled = !!isLoading;
        bulkTimeAllBtn.classList.toggle('opacity-60', !!isLoading);
        var allLabel = bulkTimeAllBtn.querySelector('span:last-child');
        if (allLabel) {
          allLabel.textContent = isLoading && scope === 'ALL' ? 'Adding...' : 'Add to entire class';
        }
      }
      if (bulkTimeSelectedBtn) {
        var disableSelected = isLoading || missionControlSelectedEmails.size === 0 || !currentMissionControlPollId || !currentSecureSessionId;
        bulkTimeSelectedBtn.disabled = disableSelected;
        bulkTimeSelectedBtn.classList.toggle('opacity-60', disableSelected);
        if (bulkSelectedLabel) {
          if (isLoading && scope === 'SELECTED') {
            bulkSelectedLabel.textContent = 'Adding...';
          } else if (!isLoading) {
            bulkSelectedLabel.textContent = missionControlSelectedEmails.size > 0
              ? 'Add to selected (' + missionControlSelectedEmails.size + ')'
              : 'Add to selected';
          }
        }
      }
      if (!isLoading) {
        updateBulkControlsState();
      }
    }

    async function handleBulkTimeAdjust(scope) {
      if (!currentMissionControlPollId || !currentSecureSessionId) {
        await veritasAlert('Launch a secure assessment before extending time.', { title: 'Extend time' });
        return;
      }
      if (scope === 'SELECTED' && missionControlSelectedEmails.size === 0) {
        await veritasAlert('Select at least one student first.', { title: 'Extend time' });
        return;
      }
      if (!bulkTimeInput) { return; }
      var minutes = parseFloat(bulkTimeInput.value);
      if (isNaN(minutes) || minutes <= 0) {
        await veritasAlert('Enter a positive number of minutes to add.', { title: 'Extend time' });
        bulkTimeInput.focus();
        return;
      }
      if (PREVIEW_MODE) {
        await previewOnlyNotice('adjust secure assessment time');
        return;
      }
      setBulkControlsLoading(true, scope);

      // FIXED: Use runMissionControlAction (client-side loop) instead of GAS Bulk
      var targets = [];
      if (scope === 'ALL') {
        // Fetch all students active in this session
        firebase.database().ref('sessions/' + currentMissionControlPollId + '/students').once('value')
          .then(function (snapshot) {
            var sMap = snapshot.val() || {};
            targets = Object.keys(sMap).map(function (k) { return sMap[k].email; });
            performBulkTimeAdjustment(targets, minutes);
          });
      } else {
        targets = Array.from(missionControlSelectedEmails);
        performBulkTimeAdjustment(targets, minutes);
      }

      function performBulkTimeAdjustment(targetEmails, deltaMinutes) {
        if (!targetEmails || targetEmails.length === 0) {
          setBulkControlsLoading(false, scope);
          return;
        }

        var promises = targetEmails.map(function (email) {
          // We reuse runMissionControlAction which now handles direct DB updates
          // args: [pollId, sessionId, studentEmail, delta]
          // But runMissionControlAction expects to be called from a button click usually?
          // No, it's a generic helper.
          // Line 13073: if (fnName === 'adjustSecureAssessmentTime') ...
          // Wait, runMissionControlAction is tied to `currentManagedStudent` in some checks?
          // Let's check line 13062: "if (!currentMissionControlPollId || !currentSecureSessionId || !currentManagedStudent) { return; }"
          // AH! It REQUIRES currentManagedStudent.
          // So I CANNOT reuse runMissionControlAction for bulk operations easily without faking currentManagedStudent.
          // I should simply duplicate the logic here:

          var emailKey = (typeof generateStudentKey === 'function') ? generateStudentKey(email) : email.replace(/[.$#[\]]/g, '_');
          return firebase.database().ref('sessions/' + currentMissionControlPollId + '/students/' + emailKey + '/timeAdjustment').transaction(function (current) {
            return (current || 0) + deltaMinutes;
          });
        });

        Promise.all(promises).then(function () {
          setBulkControlsLoading(false, scope);
          var audience = scope === 'ALL' ? 'the entire class' : targetEmails.length + ' student(s)';
          showToast('success', 'Time extended', 'Added ' + deltaMinutes + ' minute(s) for ' + audience + '.', 4000);
          pollIndividualSessionState();
        }).catch(function (err) {
          setBulkControlsLoading(false, scope);
          handleError(err);
        });
      }

    }

    function pollIndividualSessionState() {
      if (!currentMissionControlPollId || !currentSecureSessionId) {
        return;
      }

      // Skip this poll if we are in backoff period
      if (missionControlBackoffMs > 0) {
        var remaining = missionControlBackoffMs - 1000;
        if (remaining <= 0) {
          missionControlBackoffMs = 0;
        } else {
          missionControlBackoffMs = remaining;
          console.log('Mission control polling backing off:', remaining + 'ms remaining');
          return;
        }
      }

      function pollIndividualSessionState() {
        if (!currentMissionControlPollId || !currentSecureSessionId) {
          return;
        }

        // FETCH FROM FIREBASE DIRECTLY (Client-Side Aggregation)
        var pId = currentMissionControlPollId;
        var sId = currentSecureSessionId;

        firebase.database().ref('sessions/' + pId + '/students').once('value')
          .then(function (snapshot) {
            var studentsMap = snapshot.val() || {};
            var studentsList = [];
            Object.keys(studentsMap).forEach(function (key) {
              var s = studentsMap[key];
              studentsList.push({
                email: s.email,
                name: s.name || s.email,
                status: s.status,
                isLocked: s.status === 'LOCKED',
                lockVersion: s.lockVersion || 0,
                violations: s.violations || 0,
                timeAdjustment: s.timeAdjustment || 0,
                lastActiveAt: s.lastActiveAt ? new Date(s.lastActiveAt) : null,
                lastViolationReason: s.lastViolationReason,
                unlockApproved: s.unlockApproved
              });
            });

            var view = {
              success: true,
              pollId: pId,
              sessionId: sId,
              students: studentsList
            };

            // Reuse existing success handler logic
            missionControlPollFailures = 0;
            missionControlBackoffMs = 0;
            renderIndividualStudentCards(view);
            updateRealtimeUI();
          })
          .catch(function (error) {
            console.error('Mission Control Fetch Error:', error);
            // Reuse existing error logic if needed, or simple log
          });
      }
    }

    function updateMissionControlSummary(summary) {
      var readyEl = document.getElementById('summary-not-started');
      var inProgressEl = document.getElementById('summary-in-progress');
      var lockedEl = document.getElementById('summary-locked');
      var completedEl = document.getElementById('summary-completed');
      if (readyEl) { readyEl.textContent = summary.notStarted || 0; }
      if (inProgressEl) { inProgressEl.textContent = summary.inProgress || 0; }
      var flagged = (summary.locked || 0) + (summary.paused || 0);
      if (lockedEl) { lockedEl.textContent = flagged; }
      if (completedEl) { completedEl.textContent = summary.completed || 0; }
    }

    function attachManageHandlers() {
      var buttons = document.querySelectorAll('#individual-session-students-grid [data-action="manage-student"]');
      buttons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          var email = btn.dataset.email;
          var target = missionControlStudents.find(function (student) { return student.email === email; });
          if (target) {
            openStudentManager(target);
          }
        });
      });
    }

    function openStudentManager(student) {
      if (!studentManagerModal || !student) { return; }
      currentManagedStudent = student;
      updateStudentManagerUi(student);
      studentManagerModal.classList.remove('hidden');
    }

    function closeStudentManager() {
      if (!studentManagerModal) { return; }
      studentManagerModal.classList.add('hidden');
      currentManagedStudent = null;
      setStudentManagerLoading(false);
    }

    function syncManagedStudentState() {
      if (!currentManagedStudent || !missionControlStudents.length || !studentManagerModal || studentManagerModal.classList.contains('hidden')) {
        return;
      }
      var updated = missionControlStudents.find(function (student) { return student.email === currentManagedStudent.email; });
      if (updated) {
        currentManagedStudent = updated;
        updateStudentManagerUi(updated);
      }
    }

    function updateStudentManagerUi(student) {
      if (!student) { return; }
      if (studentManagerName) { studentManagerName.textContent = student.name; }
      if (studentManagerStatus) { studentManagerStatus.textContent = student.status; }
      if (studentManagerProgress) {
        var answeredQuestions = student.progress || 0;
        var progressText = 'Q ' + answeredQuestions + ' / ' + (student.totalQuestions || 0);
        if (typeof student.correctCount === 'number' && answeredQuestions > 0) {
          progressText += '  ' + student.correctCount + ' correct';
        }
        studentManagerProgress.textContent = progressText;
      }
      if (studentManagerTime) { studentManagerTime.textContent = student.timeRemainingSeconds != null ? formatTime(student.timeRemainingSeconds) : '--:--'; }
      if (studentManagerExtra) {
        var extraMinutes = student.timeAdjustmentMinutes || 0;
        studentManagerExtra.textContent = (extraMinutes >= 0 ? '+' : '') + extraMinutes + 'm';
      }
      if (studentManagerConnection) {
        var label = 'No signal';
        var status = student.connection ? student.connection.status : '';
        if (status === 'GREEN') { label = 'Synced'; }
        else if (status === 'YELLOW') { label = 'Reconnecting'; }
        else if (status === 'RED') { label = 'Offline'; }
        studentManagerConnection.textContent = label;
      }
      if (studentManagerConnectionDot) {
        studentManagerConnectionDot.classList.remove('bg-emerald-400', 'bg-amber-400', 'bg-red-500', 'bg-slate-300');
        var dotClass = 'bg-slate-300';
        var statusColor = student.connection ? student.connection.status : '';
        if (statusColor === 'GREEN') { dotClass = 'bg-emerald-400'; }
        else if (statusColor === 'YELLOW') { dotClass = 'bg-amber-400'; }
        else if (statusColor === 'RED') { dotClass = 'bg-red-500'; }
        studentManagerConnectionDot.classList.add(dotClass);
      }
      if (studentManagerMessage) {
        if (student.lastHeartbeatMs) {
          studentManagerMessage.textContent = 'Last heartbeat ' + getTimeAgo(new Date(student.lastHeartbeatMs)) + '.';
        } else {
          studentManagerMessage.textContent = '';
        }
      }
      if (studentManagerPause) {
        studentManagerPause.innerHTML = '<span class="material-symbols-outlined text-base">' + (student.pauseActive ? 'play_arrow' : 'pause_circle') + '</span><span>' + (student.pauseActive ? ' Resume Timer' : ' Pause Timer') + '</span>';
      }
      if (studentManagerUnlock) {
        var lockedState = student.proctorStatus === 'LOCKED' || student.isLocked;
        studentManagerUnlock.disabled = !lockedState;
        studentManagerUnlock.classList.toggle('opacity-60', !lockedState);
      }
    }

    function setStudentManagerLoading(isLoading) {
      if (studentManagerLoading) {
        studentManagerLoading.classList.toggle('hidden', !isLoading);
      }
      [studentManagerAdd5, studentManagerAdd10, studentManagerPause, studentManagerUnlock, studentManagerForceSubmit].forEach(function (btn) {
        if (btn) { btn.disabled = !!isLoading; }
      });
    }

    // ============= BOOK VIEW FUNCTIONS =============
    var currentBookViewData = null;
    var currentStudentDetail = null;

    function openBookView() {
      var modal = document.getElementById('book-view-modal');
      var loading = document.getElementById('book-view-loading');
      var content = document.getElementById('book-view-content');
      var error = document.getElementById('book-view-error');

      if (!modal || !currentMissionControlPollId) return;

      // Show modal with loading state
      modal.classList.remove('hidden');
      loading.classList.remove('hidden');
      content.classList.add('hidden');
      error.classList.add('hidden');

      // Fetch book view data
      // FIREBASE MIGRATION: Use Cloud Function getAnalytics
      var getAnalytics = firebaseFunctions.httpsCallable('getAnalytics');

      getAnalytics({ pollId: currentMissionControlPollId })
        .then(function (result) {
          var data = result.data || result;

          // Adapt getAnalytics structure to Book View structure
          // Book View expects: { success: true, summary: {}, students: [], questions: [] }
          // getAnalytics returns: { itemAnalysis: {}, ... }

          var adaptedResult = {
            success: true,
            summary: {
              className: data.className || 'Unknown Class',
              pollName: data.pollName || 'Unknown Poll',
              date: new Date().toLocaleDateString(),
              averageScore: 0 // Placeholder
            },
            students: [], // Detailed student rows not yet available in getAnalytics
            questions: []
          };

          // Map itemAnalysis to questions array if possible
          if (data.itemAnalysis) {
            Object.keys(data.itemAnalysis).forEach(function (qIdx) {
              var item = data.itemAnalysis[qIdx];
              adaptedResult.questions.push({
                index: qIdx,
                text: "Question " + (parseInt(qIdx) + 1), // Text might be missing in analysis
                difficulty: item.difficultyIndex,
                discrimination: item.discriminationIndex,
                correctCount: item.correctCount,
                totalCount: item.totalResponseCount
              });
            });
          }

          currentBookViewData = adaptedResult;
          renderBookView(adaptedResult);
          loading.classList.add('hidden');
          content.classList.remove('hidden');
        })
        .catch(function (error) {
          showBookViewError('Error loading analytics: ' + (error.message || 'Unknown error'));
        });

    }

    function closeBookView() {
      var modal = document.getElementById('book-view-modal');
      if (modal) modal.classList.add('hidden');
      currentBookViewData = null;
    }

    window.closeBookView = closeBookView;

    function showBookViewError(message) {
      var loading = document.getElementById('book-view-loading');
      var content = document.getElementById('book-view-content');
      var error = document.getElementById('book-view-error');
      var errorMessage = document.getElementById('book-view-error-message');

      loading.classList.add('hidden');
      content.classList.add('hidden');
      error.classList.remove('hidden');
      if (errorMessage) errorMessage.textContent = message;
    }

    function renderBookView(data) {
      // Update header
      var title = document.getElementById('book-view-title');
      var subtitle = document.getElementById('book-view-subtitle');
      if (title) title.textContent = data.pollName + ' - Book View';
      if (subtitle) subtitle.textContent = data.className + '  ' + data.questionCount + ' questions  ' + data.studentDetails.length + ' students';

      // Render class overview
      renderClassOverview(data.classOverview, data.questionCount);

      // Render student roster
      renderStudentRoster(data.studentDetails);

      // Render question analysis
      renderQuestionAnalysis(data.itemAnalysis, data.studentDetails);

      // Render response matrix
      renderResponseMatrix(data.studentDetails, data.questionCount);
    }

    function renderClassOverview(overview, questionCount) {
      var totalStudents = document.getElementById('book-class-total-students');
      var average = document.getElementById('book-class-average');
      var median = document.getElementById('book-class-median');
      var stddev = document.getElementById('book-class-stddev');
      var interpretation = document.getElementById('book-class-interpretation');

      if (totalStudents) totalStudents.textContent = overview.participantCount;
      if (average) {
        var avgPct = questionCount > 0 ? Math.round((overview.mean / questionCount) * 100) : 0;
        average.textContent = avgPct + '%';
      }
      if (median) median.textContent = overview.median + '/' + questionCount;
      if (stddev) stddev.textContent = overview.stdDev.toFixed(2);

      if (interpretation && overview.interpretation) {
        var html = '';
        if (overview.interpretation.participation) {
          html += '<div class="mb-2"><strong>Participation:</strong> ' + overview.interpretation.participation.message + '</div>';
        }
        if (overview.interpretation.meanScore) {
          html += '<div class="mb-2"><strong>Class Performance:</strong> ' + overview.interpretation.meanScore.message + '</div>';
        }
        if (overview.interpretation.stdDev) {
          html += '<div><strong>Score Distribution:</strong> ' + overview.interpretation.stdDev.message + '</div>';
        }
        interpretation.innerHTML = html;
      }
    }

    function renderStudentRoster(students) {
      var tbody = document.getElementById('book-students-table-body');
      if (!tbody) return;

      tbody.innerHTML = '';
      students.forEach(function (student) {
        var row = document.createElement('tr');
        row.className = 'hover:bg-slate-50 dark:hover:bg-brand-dark-gray/20 transition-colors cursor-pointer';
        row.onclick = function () { openStudentDetail(student); };

        var rankBadge = '';
        if (student.rank === 1) rankBadge = '<span class="ml-2 text-yellow-500"></span>';
        else if (student.rank === 2) rankBadge = '<span class="ml-2 text-gray-400"></span>';
        else if (student.rank === 3) rankBadge = '<span class="ml-2 text-orange-600"></span>';

        var percentageClass = 'text-slate-700 dark:text-slate-300';
        if (student.percentage >= 90) percentageClass = 'text-green-600 dark:text-green-400 font-bold';
        else if (student.percentage >= 80) percentageClass = 'text-green-600 dark:text-green-400';
        else if (student.percentage >= 70) percentageClass = 'text-blue-600 dark:text-blue-400';
        else if (student.percentage >= 60) percentageClass = 'text-yellow-600 dark:text-yellow-400';
        else percentageClass = 'text-red-600 dark:text-red-400';

        row.innerHTML = '<td class="px-4 py-3 text-sm font-semibold">' + student.rank + rankBadge + '</td>' +
          '<td class="px-4 py-3 text-sm font-medium text-brand-dark-gray dark:text-white">' + escapeHtml(student.name) + '</td>' +
          '<td class="px-4 py-3 text-sm text-center">' + student.totalScore + '/' + student.maxScore + '</td>' +
          '<td class="px-4 py-3 text-sm text-center ' + percentageClass + '">' + student.percentage + '%</td>' +
          '<td class="px-4 py-3 text-sm text-center">' + student.percentileRank + 'th</td>' +
          '<td class="px-4 py-3 text-center"><button class="px-3 py-1 text-xs font-semibold rounded-lg bg-veritas-gold/10 text-veritas-gold hover:bg-veritas-gold/20 transition-colors">View Details</button></td>';

        tbody.appendChild(row);
      });
    }

    function renderQuestionAnalysis(items, students) {
      var container = document.getElementById('book-questions-container');
      if (!container) return;

      container.innerHTML = '';
      items.forEach(function (item, idx) {
        var card = document.createElement('div');
        card.className = 'bg-white dark:bg-brand-dark-gray/30 rounded-xl border border-slate-200 dark:border-brand-dark-gray/40 p-6 shadow-sm';

        var difficultyColor = item.interpretation.difficulty.color;
        var discriminationColor = item.interpretation.discrimination.color;
        var overallColor = item.interpretation.overall.color;

        var html = '<div class="flex items-start justify-between gap-4 mb-4">' +
          '<div class="flex-1"><h4 class="text-lg font-bold text-brand-dark-gray dark:text-white mb-2">Question ' + (idx + 1) + '</h4>' +
          '<p class="text-sm text-slate-600 dark:text-slate-400">' + escapeHtml(item.questionText) + '</p></div>' +
          '<div class="flex gap-2">';

        item.flags.forEach(function (flag) {
          var flagLabel = flag.replace(/-/g, ' ').toUpperCase();
          html += '<span class="px-2 py-1 text-xs font-semibold rounded bg-red-100 text-red-800"> ' + flagLabel + '</span>';
        });

        html += '</div></div>';

        // Psychometric metrics
        html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">' +
          '<div class="bg-slate-50 dark:bg-brand-dark-gray/40 rounded-lg p-3"><p class="text-xs text-slate-500 mb-1">Difficulty (P-Value)</p><p class="text-2xl font-bold" style="color:' + difficultyColor + '">' + (item.difficultyPct || 0) + '%</p><p class="text-xs text-slate-600 dark:text-slate-400">' + item.interpretation.difficulty.message + '</p></div>' +
          '<div class="bg-slate-50 dark:bg-brand-dark-gray/40 rounded-lg p-3"><p class="text-xs text-slate-500 mb-1">Discrimination</p><p class="text-2xl font-bold" style="color:' + discriminationColor + '">' + item.discrimination.toFixed(2) + '</p><p class="text-xs text-slate-600 dark:text-slate-400">' + item.interpretation.discrimination.message + '</p></div>' +
          '<div class="bg-slate-50 dark:bg-brand-dark-gray/40 rounded-lg p-3"><p class="text-xs text-slate-500 mb-1">Responses</p><p class="text-2xl font-bold text-slate-700 dark:text-slate-300">' + item.responseCount + '</p><p class="text-xs text-slate-600 dark:text-slate-400">students answered</p></div>' +
          '<div class="bg-slate-50 dark:bg-brand-dark-gray/40 rounded-lg p-3"><p class="text-xs text-slate-500 mb-1">Overall Quality</p><p class="text-sm font-bold" style="color:' + overallColor + '">' + item.interpretation.overall.quality.toUpperCase() + '</p><p class="text-xs text-slate-600 dark:text-slate-400">' + item.interpretation.overall.message + '</p></div>' +
          '</div>';

        // Distractor analysis
        if (item.distractorAnalysis && item.distractorAnalysis.length > 0) {
          html += '<div class="border-t border-slate-200 dark:border-brand-dark-gray/40 pt-4"><h5 class="text-sm font-semibold text-brand-dark-gray dark:text-white mb-3">Answer Choice Analysis</h5>' +
            '<div class="space-y-2">';

          item.distractorAnalysis.forEach(function (dist) {
            var isCorrect = dist.isCorrect;
            var bgClass = isCorrect ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800' : 'bg-slate-50 dark:bg-brand-dark-gray/40 border-slate-200 dark:border-brand-dark-gray/60';
            var icon = isCorrect ? '' : '';

            html += '<div class="flex items-center gap-3 p-3 rounded-lg border ' + bgClass + '">' +
              '<div class="flex-shrink-0 w-8 h-8 rounded-full bg-white dark:bg-brand-dark-gray flex items-center justify-center font-bold text-sm">' + dist.optionLetter + '</div>' +
              '<div class="flex-1"><p class="text-sm font-medium text-brand-dark-gray dark:text-white">' + icon + ' ' + escapeHtml(dist.option) + (isCorrect ? ' <span class="text-green-600 dark:text-green-400">(Correct Answer)</span>' : '') + '</p></div>' +
              '<div class="text-right"><p class="text-sm font-bold text-brand-dark-gray dark:text-white">' + dist.totalPct.toFixed(1) + '%</p><p class="text-xs text-slate-500">selected</p></div>' +
              '<div class="text-right"><p class="text-xs text-slate-500">High: ' + dist.highGroupPct.toFixed(1) + '%</p><p class="text-xs text-slate-500">Low: ' + dist.lowGroupPct.toFixed(1) + '%</p></div>' +
              '</div>';
          });

          html += '</div></div>';
        }

        card.innerHTML = html;
        container.appendChild(card);
      });
    }

    function renderResponseMatrix(students, questionCount) {
      var headerRow = document.getElementById('book-matrix-header-row');
      var tbody = document.getElementById('book-matrix-table-body');
      if (!headerRow || !tbody) return;

      // Rebuild header row: Student | Q1..Qn | Total
      headerRow.innerHTML = '';
      var studentHeader = document.createElement('th');
      studentHeader.className = 'sticky left-0 bg-slate-100 dark:bg-brand-dark-gray/50 px-3 py-2 text-left font-semibold border-r border-slate-300 dark:border-brand-dark-gray/60';
      studentHeader.textContent = 'Student';
      headerRow.appendChild(studentHeader);

      for (var i = 0; i < questionCount; i++) {
        var th = document.createElement('th');
        th.className = 'bg-slate-100 dark:bg-brand-dark-gray/50 px-3 py-2 text-center font-semibold border-l border-slate-300 dark:border-brand-dark-gray/60';
        th.textContent = 'Q' + (i + 1);
        headerRow.appendChild(th);
      }

      var totalHeader = document.createElement('th');
      totalHeader.className = 'bg-slate-100 dark:bg-brand-dark-gray/50 px-3 py-2 text-center font-semibold';
      totalHeader.textContent = 'Total';
      headerRow.appendChild(totalHeader);

      // Create student rows
      tbody.innerHTML = '';
      students.forEach(function (student) {
        var row = document.createElement('tr');
        row.className = 'hover:bg-slate-50 dark:hover:bg-brand-dark-gray/20';

        var nameCell = document.createElement('td');
        nameCell.className = 'sticky left-0 bg-white dark:bg-brand-dark-gray px-3 py-2 text-sm font-medium border-r border-slate-300 dark:border-brand-dark-gray/60';
        nameCell.textContent = student.name;
        row.appendChild(nameCell);

        student.questionResponses.forEach(function (qResp) {
          var cell = document.createElement('td');
          cell.className = 'px-3 py-2 text-center text-xs border-l border-slate-200 dark:border-brand-dark-gray/60';

          if (qResp.answered) {
            if (qResp.isCorrect) {
              cell.className += ' bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 font-semibold';
              cell.innerHTML = '<br><span class="text-[10px]">' + escapeHtml(qResp.studentAnswer) + '</span>';
            } else {
              cell.className += ' bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 font-semibold';
              cell.innerHTML = '<br><span class="text-[10px]">' + escapeHtml(qResp.studentAnswer) + '</span>';
            }
          } else {
            cell.className += ' bg-slate-100 dark:bg-brand-dark-gray/40 text-slate-400';
            cell.textContent = '';
          }

          row.appendChild(cell);
        });

        var totalCell = document.createElement('td');
        totalCell.className = 'px-3 py-2 text-center font-bold text-sm bg-slate-100 dark:bg-brand-dark-gray/50';
        totalCell.textContent = student.totalScore + '/' + student.maxScore;
        row.appendChild(totalCell);

        tbody.appendChild(row);
      });
    }

    function openStudentDetail(student) {
      currentStudentDetail = student;
      var detailView = document.getElementById('book-student-detail');
      if (!detailView) return;

      // Update header
      var name = document.getElementById('student-detail-name');
      var score = document.getElementById('student-detail-score');
      var percentage = document.getElementById('student-detail-percentage');
      var rank = document.getElementById('student-detail-rank');
      var percentile = document.getElementById('student-detail-percentile');

      if (name) name.textContent = student.name;
      if (score) score.textContent = student.totalScore + '/' + student.maxScore;
      if (percentage) percentage.textContent = student.percentage + '%';
      if (rank) rank.textContent = '#' + student.rank;
      if (percentile) percentile.textContent = student.percentileRank + 'th percentile';

      // Render responses
      var responsesContainer = document.getElementById('student-detail-responses');
      if (responsesContainer) {
        responsesContainer.innerHTML = '';
        student.questionResponses.forEach(function (qResp, idx) {
          var card = document.createElement('div');
          card.className = 'bg-white dark:bg-brand-dark-gray/30 rounded-lg border border-slate-200 dark:border-brand-dark-gray/40 p-4';

          var statusClass = qResp.isCorrect ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300';
          var statusIcon = qResp.isCorrect ? '' : '';
          var statusText = qResp.isCorrect ? 'Correct' : 'Incorrect';

          if (!qResp.answered) {
            statusClass = 'bg-slate-100 text-slate-600 dark:bg-brand-dark-gray/40 dark:text-slate-400';
            statusIcon = '';
            statusText = 'Not Answered';
          }

          var html = '<div class="flex items-start justify-between gap-4 mb-3">' +
            '<h5 class="text-sm font-bold text-brand-dark-gray dark:text-white">Question ' + (idx + 1) + '</h5>' +
            '<span class="px-3 py-1 text-xs font-semibold rounded-full ' + statusClass + '">' + statusIcon + ' ' + statusText + '</span>' +
            '</div>' +
            '<p class="text-sm text-slate-700 dark:text-slate-300 mb-3">' + escapeHtml(qResp.questionText) + '</p>';

          if (qResp.answered) {
            html += '<div class="space-y-2">' +
              '<div><span class="text-xs font-semibold text-slate-500">Student Answer:</span> <span class="text-sm font-medium text-brand-dark-gray dark:text-white">' + escapeHtml(qResp.studentAnswer) + '</span></div>' +
              '<div><span class="text-xs font-semibold text-slate-500">Correct Answer:</span> <span class="text-sm font-medium text-green-700 dark:text-green-400">' + escapeHtml(qResp.correctAnswer) + '</span></div>' +
              '</div>';
          }

          card.innerHTML = html;
          responsesContainer.appendChild(card);
        });
      }

      detailView.classList.remove('hidden');
    }

    function closeStudentDetail() {
      var detailView = document.getElementById('book-student-detail');
      if (detailView) detailView.classList.add('hidden');
      currentStudentDetail = null;
    }

    window.closeStudentDetail = closeStudentDetail;

    // Add ESC key support to close student detail view
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' || e.keyCode === 27) {
        var detailView = document.getElementById('book-student-detail');
        if (detailView && !detailView.classList.contains('hidden')) {
          closeStudentDetail();
        }
      }
    });

    function switchBookTab(tabName) {
      // Update tab buttons
      var tabs = ['students', 'questions', 'matrix'];
      tabs.forEach(function (tab) {
        var btn = document.getElementById('book-tab-' + tab);
        var content = document.getElementById('book-content-' + tab);

        if (btn) {
          if (tab === tabName) {
            btn.className = 'px-6 py-3 font-semibold text-sm transition-colors border-b-2 border-veritas-gold text-veritas-gold';
          } else {
            btn.className = 'px-6 py-3 font-semibold text-sm transition-colors border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-veritas-gold hover:border-veritas-gold/30';
          }
        }

        if (content) {
          if (tab === tabName) {
            content.classList.remove('hidden');
          } else {
            content.classList.add('hidden');
          }
        }
      });
    }

    function escapeHtml(text) {
      if (!text) return '';
      var map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&amp;#039;'
      };
      return String(text).replace(/[&<>"']/g, function (m) { return map[m]; });
    }

    // Bind book view events
    bindClick('view-book-report-btn', openBookView);

    // FIX Bug #6: Add secure view links button handler
    bindClick('secure-view-links-btn', function () {
      // Use the current poll data's className if available
      var className = CURRENT_POLL_DATA && CURRENT_POLL_DATA.className;
      if (!className) {
        veritasAlert('No class assigned to this assessment.', { title: 'View Links', destructive: true });
        return;
      }
      // Set viewLinksBtn dataset so onViewLinks can use it
      if (viewLinksBtn) {
        viewLinksBtn.dataset.className = className;
        onViewLinks();
      } else {
        // Fallback: manually trigger the links modal
        // FIREBASE MIGRATION: Load links from Firebase rosters
        firebase.database().ref('rosters/rosters/' + className).once('value')
          .then(function (snapshot) {
            var roster = snapshot.val();
            if (roster && roster.length > 0) {
              // Transform roster to links format
              var links = roster.map(function (s) {
                return {
                  name: s.name,
                  email: s.email,
                  link: WEB_APP_URL + '?role=student&pollId=' + (CURRENT_POLL_DATA ? CURRENT_POLL_DATA.pollId : '') + '&email=' + encodeURIComponent(s.email)
                };
              });
              openLinksModalWithData(className, links);
            } else {
              veritasAlert('No students found in this class roster.', { title: 'View Links', destructive: true });
            }
          })
          .catch(function (error) {
            handleError(error);
          });
      }
    });

    var bookTabStudents = document.getElementById('book-tab-students');
    var bookTabQuestions = document.getElementById('book-tab-questions');
    var bookTabMatrix = document.getElementById('book-tab-matrix');

    if (bookTabStudents) bookTabStudents.addEventListener('click', function () { switchBookTab('students'); });
    if (bookTabQuestions) bookTabQuestions.addEventListener('click', function () { switchBookTab('questions'); });
    if (bookTabMatrix) bookTabMatrix.addEventListener('click', function () { switchBookTab('matrix'); });

    // ============= END BOOK VIEW FUNCTIONS =============

    function runMissionControlAction(fnName, args) {
      if (PREVIEW_MODE) {
        previewOnlyNotice('manage secure assessments');
        return;
      }
      if (!currentMissionControlPollId || !currentSecureSessionId || !currentManagedStudent) { return; }

      setStudentManagerLoading(true);

      var pollId = currentMissionControlPollId;
      var studentEmail = args[2] || currentManagedStudent.email;
      var emailKey = (typeof generateStudentKey === 'function') ? generateStudentKey(studentEmail) : studentEmail.replace(/[.$#[\]]/g, '_');

      var studentRef = firebase.database().ref('sessions/' + pollId + '/students/' + emailKey);
      var dbUpdate = null;

      if (fnName === 'adjustSecureAssessmentTime') {
        var delta = args[3];
        dbUpdate = studentRef.child('timeAdjustment').transaction(function (current) {
          return (current || 0) + delta;
        });
      } else if (fnName === 'pauseSecureAssessmentStudent') {
        dbUpdate = studentRef.update({
          status: 'PAUSED',
          pauseActive: true
        });
      } else if (fnName === 'resumeSecureAssessmentStudent') {
        dbUpdate = studentRef.update({
          status: 'ACTIVE',
          pauseActive: false
        });
      } else if (fnName === 'forceSubmitSecureAssessmentStudent') {
        dbUpdate = studentRef.update({
          status: 'FINISHED'
        });
      }

      if (dbUpdate) {
        dbUpdate.then(function () {
          setStudentManagerLoading(false);
          pollIndividualSessionState();
        }).catch(function (error) {
          setStudentManagerLoading(false);
          handleError(error);
        });
      } else {
        setStudentManagerLoading(false);
      }
    }




    // FIXED: Use Cloud Function for Roster Save
    var manageRoster = firebaseFunctions.httpsCallable('manageRoster');
    manageRoster({
      action: 'SAVE',
      className: currentClasses,
      roster: rosterData
    }).then(function (result) {
      setButtonLoading(saveRosterBtn, false);
      onRosterSaved(result.data || result);
    }).catch(function (error) {
      setButtonLoading(saveRosterBtn, false);
      handleError(error);
    });

    function handleAdjustStudentTime(deltaMinutes) {
      if (!currentManagedStudent) { return; }
      runMissionControlAction('adjustSecureAssessmentTime', [currentMissionControlPollId, currentSecureSessionId, currentManagedStudent.email, deltaMinutes]);
    }

    function handlePauseToggle() {
      if (!currentManagedStudent) { return; }
      var fn = currentManagedStudent.pauseActive ? 'resumeSecureAssessmentStudent' : 'pauseSecureAssessmentStudent';
      runMissionControlAction(fn, [currentMissionControlPollId, currentSecureSessionId, currentManagedStudent.email]);
    }

    async function handleForceSubmitAction() {
      if (!currentManagedStudent) { return; }
      var confirmed = await veritasConfirm('Force submit and lock ' + currentManagedStudent.name + '?', { title: 'Force submit', destructive: true, confirmText: 'Force Submit' });
      if (!confirmed) { return; }
      runMissionControlAction('forceSubmitSecureAssessmentStudent', [currentMissionControlPollId, currentSecureSessionId, currentManagedStudent.email]);
    }

    bindClick('end-individual-session-btn', onEndIndividualSession);

    if (studentManagerClose) {
      studentManagerClose.addEventListener('click', closeStudentManager);
    }
    document.querySelectorAll('[data-student-manager-close="true"]').forEach(function (el) {
      el.addEventListener('click', closeStudentManager);
    });
    if (studentManagerAdd5) {
      studentManagerAdd5.addEventListener('click', function () { handleAdjustStudentTime(5); });
    }
    if (studentManagerAdd10) {
      studentManagerAdd10.addEventListener('click', function () { handleAdjustStudentTime(10); });
    }
    if (studentManagerPause) {
      studentManagerPause.addEventListener('click', handlePauseToggle);
    }
    if (studentManagerForceSubmit) {
      studentManagerForceSubmit.addEventListener('click', function () { handleForceSubmitAction(); });
    }
    if (studentManagerUnlock) {
      studentManagerUnlock.addEventListener('click', function () {
        if (!currentManagedStudent || !currentMissionControlPollId) { return; }
        // 1. FIREBASE (Instant)
        setFirebaseStatus(currentManagedStudent.email, 'ACTIVE');
        // 2. SERVER (Sync)
        approveStudentUnlock(currentManagedStudent.email, currentMissionControlPollId, currentManagedStudent.lockVersion || 0, studentManagerUnlock);
      });
    }

    if (bulkTimeAllBtn) {
      bulkTimeAllBtn.addEventListener('click', function () { handleBulkTimeAdjust('ALL'); });
    }
    if (bulkTimeSelectedBtn) {
      bulkTimeSelectedBtn.addEventListener('click', function () { handleBulkTimeAdjust('SELECTED'); });
    }
    if (bulkSelectionClear) {
      bulkSelectionClear.addEventListener('click', function () { clearMissionSelection(); });
    }

    updateBulkControlsState();

    // ===========================
    // POLL WIZARD - GLOBAL STATE
    // ===========================

    var wizardState = {
      currentStep: 1,
      mode: null,
      pollName: '',
      className: '',
      timeLimitMinutes: null,
      accessCode: '',
      availabilityStart: null,
      availabilityEnd: null,
      calculatorEnabled: false,
      proctoringRules: [],
      questions: [],
      showResultsImmediately: false,
      pollId: null, // For edit mode
      isEditMode: false // Track if we're editing
    };

    var wizardQuestionIdCounter = 0;
    var wizardDraggedIndex = null; // For drag-and-drop
    var wizardEditingQuestionIndex = null; // Track which question is being edited

    // ===========================
    // WIZARD LIFECYCLE
    // ===========================

    function openPollWizard(pollData) {
      var isEdit = !!pollData;

      wizardState = {
        currentStep: 1,
        mode: null,
        pollName: '',
        className: '',
        timeLimitMinutes: null,
        accessCode: '',
        availabilityStart: null,
        availabilityEnd: null,
        calculatorEnabled: false,
        proctoringRules: ['FULLSCREEN_REQUIRED', 'DETECT_TAB_SWITCH'],
        questions: [],
        showResultsImmediately: false,
        pollId: isEdit ? pollData.pollId : null,
        isEditMode: isEdit
      };
      wizardQuestionIdCounter = 0;
      wizardEditingQuestionIndex = null;

      // If editing, populate wizard with existing poll data
      if (isEdit && pollData) {
        wizardState.pollName = pollData.pollName || '';
        wizardState.className = pollData.className || '';

        // Determine mode from session type
        var sessionType = normalizeSessionTypeClient(pollData.sessionType);
        wizardState.mode = (sessionType === 'SECURE_ASSESSMENT') ? 'secure' : 'live';

        // Load secure settings if applicable
        if (wizardState.mode === 'secure') {
          wizardState.timeLimitMinutes = typeof pollData.timeLimitMinutes === 'number'
            ? pollData.timeLimitMinutes
            : (pollData.secureSettings && typeof pollData.secureSettings.timeLimitMinutes === 'number'
              ? pollData.secureSettings.timeLimitMinutes : 60);
          wizardState.accessCode = (pollData.accessCode ||
            (pollData.secureSettings && pollData.secureSettings.accessCode) || '').toString().toUpperCase();
          wizardState.availabilityStart = pollData.availableFrom ||
            (pollData.secureSettings && pollData.secureSettings.availableFrom) || null;
          wizardState.availabilityEnd = pollData.dueBy ||
            (pollData.secureSettings && pollData.secureSettings.dueBy) || null;
          wizardState.calculatorEnabled = pollData.calculatorEnabled === true ||
            (pollData.secureSettings && pollData.secureSettings.calculatorEnabled === true);
        }

        // Load questions
        if (pollData.questions && pollData.questions.length > 0) {
          wizardState.questions = pollData.questions.map(function (q) {
            var options = (q.options || []).map(function (opt) {
              return {
                text: opt.text || '',
                imageURL: opt.imageURL || '',
                imageFileId: opt.imageFileId || null
              };
            });

            // Ensure at least 4 options
            while (options.length < 4) {
              options.push({ text: '', imageURL: '', imageFileId: null });
            }

            // Find correct answer index
            var correctIndex = 0;
            options.forEach(function (opt, idx) {
              if (opt.text === q.correctAnswer) {
                correctIndex = idx;
              }
            });

            return {
              questionText: q.questionText || '',
              questionImageURL: q.questionImageURL || '',
              questionImageFileId: q.questionImageFileId || null,
              options: options,
              correctAnswerIndex: correctIndex,
              metacognitionEnabled: !!q.metacognitionEnabled,
              timerSeconds: q.timerSeconds || null
            };
          });
        }

        // Update wizard title
        var wizardTitle = document.getElementById('wizard-title');
        if (wizardTitle) {
          wizardTitle.textContent = 'Edit Poll';
        }
      } else {
        // New poll - update title
        var wizardTitle = document.getElementById('wizard-title');
        if (wizardTitle) {
          wizardTitle.textContent = 'Create Poll';
        }
      }
      wizardQuestionIdCounter = wizardState.questions.length;

      // Populate class dropdown from ALL_CLASSES or BASE_CLASSES
      var classSelect = document.getElementById('wizard-class-select');
      if (classSelect) {
        classSelect.innerHTML = '<option value="">-- Select a class --</option>';

        var classesList = (window.ALL_CLASSES && window.ALL_CLASSES.length > 0)
          ? window.ALL_CLASSES
          : (typeof BASE_CLASSES !== 'undefined' ? BASE_CLASSES : []);

        if (classesList.length === 0) {
          // Attempt one-time retry in case of timing issue, or show placeholder
          var loadingOpt = document.createElement('option');
          loadingOpt.textContent = "Loading classes...";
          loadingOpt.disabled = true;
          classSelect.appendChild(loadingOpt);

          // Async check
          setTimeout(function () {
            var retryList = (window.ALL_CLASSES && window.ALL_CLASSES.length > 0) ? window.ALL_CLASSES : [];
            if (retryList.length > 0) {
              classSelect.innerHTML = '<option value="">-- Select a class --</option>';
              retryList.forEach(function (cls) {
                var option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                classSelect.appendChild(option);
              });
            } else {
              loadingOpt.textContent = "No classes found (Create one in Dashboard)";
            }
          }, 1500);
        } else {
          classesList.forEach(function (cls) {
            var option = document.createElement('option');
            option.value = cls;
            option.textContent = cls;
            classSelect.appendChild(option);
          });
        }

        // Set selected value in edit mode
        if (isEdit && wizardState.className) {
          // If the class isn't in the list, add it
          if (classesList.indexOf(wizardState.className) === -1) {
            var opt = document.createElement('option');
            opt.value = wizardState.className;
            opt.textContent = wizardState.className;
            classSelect.appendChild(opt);
          }
          classSelect.value = wizardState.className;
        }
      }

      // Switch to create-poll-view (hide other views)
      setMainSection('create-poll');

      // Show wizard progress in main header and hide session controls
      var headerWizardProgress = document.getElementById('header-wizard-progress');
      var headerSessionControls = document.getElementById('header-session-controls');
      if (headerWizardProgress) {
        headerWizardProgress.classList.remove('hidden');
        headerWizardProgress.classList.add('flex');
      }
      if (headerSessionControls) {
        headerSessionControls.classList.add('hidden');
      }

      // In edit mode, skip step 1 (mode selection) and go directly to step 2
      if (isEdit) {
        goToWizardStep(2);

        // CRITICAL: Reveal secure config section if editing a secure assessment
        // Step 1 validation normally handles this toggle, but we skip step 1 in edit mode
        // Replicate the validateWizardStep(1) logic for mode-specific sections
        var liveSection = document.getElementById('live-config-section');
        var secureSection = document.getElementById('secure-config-section');
        var modeLabel = document.getElementById('config-mode-label');

        if (wizardState.mode === 'secure') {
          if (liveSection) liveSection.classList.add('hidden');
          if (secureSection) secureSection.classList.remove('hidden');
          if (modeLabel) modeLabel.textContent = 'Secure Assessment';
        } else if (wizardState.mode === 'live') {
          if (liveSection) liveSection.classList.remove('hidden');
          if (secureSection) secureSection.classList.add('hidden');
          if (modeLabel) modeLabel.textContent = 'Live Poll';
        }
      } else {
        goToWizardStep(1);
      }
    }

    function closePollWizard() {
      if (wizardState.pollName || wizardState.questions.length > 0) {
        if (!confirm('You have unsaved changes. Are you sure you want to close?')) {
          return;
        }
      }

      // Hide wizard progress in main header and restore session controls
      var headerWizardProgress = document.getElementById('header-wizard-progress');
      var headerSessionControls = document.getElementById('header-session-controls');
      if (headerWizardProgress) {
        headerWizardProgress.classList.add('hidden');
        headerWizardProgress.classList.remove('flex');
      }
      if (headerSessionControls) {
        headerSessionControls.classList.remove('hidden');
      }

      // Return to dashboard
      setMainSection('dashboard');
    }

    /**
     * Complete the wizard after successful publish/update.
     * Updates poll data, resets wizard state, and navigates to dashboard.
     * @param {Array} polls - Updated array of all polls from the server
     */
    function completeWizardPublish(polls) {
      // Update poll data with the response (array of all polls)
      if (Array.isArray(polls)) {
        refreshPollData(polls);
      }

      // Reset wizard state
      wizardState = {
        currentStep: 1,
        mode: null,
        pollName: '',
        className: '',
        timeLimitMinutes: null,
        accessCode: '',
        availabilityStart: null,
        availabilityEnd: null,
        calculatorEnabled: false,
        proctoringRules: [],
        questions: [],
        showResultsImmediately: false,
        pollId: null,
        isEditMode: false
      };
      wizardQuestionIdCounter = 0;
      wizardEditingQuestionIndex = null;

      // Hide wizard progress in main header and restore session controls
      var headerWizardProgress = document.getElementById('header-wizard-progress');
      var headerSessionControls = document.getElementById('header-session-controls');
      if (headerWizardProgress) {
        headerWizardProgress.classList.add('hidden');
        headerWizardProgress.classList.remove('flex');
      }
      if (headerSessionControls) {
        headerSessionControls.classList.remove('hidden');
      }

      // Navigate to dashboard
      setMainSection('dashboard');
    }

    // Load wizard with existing poll data for editing
    function loadWizardWithData(pollId) {
      if (!pollId) return;

      if (PREVIEW_MODE) {
        var previewPoll = ALL_POLLS.find(function (p) { return p.pollId === pollId; });
        if (previewPoll) {
          openPollWizard(deepClone(previewPoll));
        } else {
          veritasAlert('Unable to locate this poll in preview mode.', { title: 'Edit poll' });
        }
        return;
      }

      // FIREBASE MIGRATION: Get from synced ALL_POLLS
      var poll = ALL_POLLS.find(function (p) { return p.pollId === pollId; });
      if (poll) {
        openPollWizard(poll);
      } else {
        veritasAlert('Failed to load poll data for editing.', { title: 'Error' });
      }
    }

    // Global Wizard API
    window.Wizard = {
      init: openPollWizard,
      close: closePollWizard,
      loadWithData: loadWizardWithData
    };

    // ===========================
    // STEP NAVIGATION
    // ===========================

    function goToWizardStep(stepNumber) {
      if (stepNumber < 1 || stepNumber > 4) return;

      // Update progress steps in BOTH the wizard header and the main header
      var progressContainers = ['#header-wizard-progress', '.wizard-progress'];
      progressContainers.forEach(function (containerSelector) {
        var container = document.querySelector(containerSelector);
        if (!container) return;

        for (var i = 1; i <= 4; i++) {
          var progressStep = container.querySelector('.progress-step[data-step="' + i + '"]');
          if (progressStep) {
            progressStep.classList.remove('active', 'completed');
            if (i < stepNumber) {
              progressStep.classList.add('completed');
              // Visual feedback for completed steps
              var circle = progressStep.querySelector('.progress-circle');
              if (circle) {
                circle.classList.add('bg-green-500');
                circle.classList.remove('bg-white/20');
              }
            } else if (i === stepNumber) {
              progressStep.classList.add('active');
              var circle = progressStep.querySelector('.progress-circle');
              if (circle) {
                circle.classList.remove('bg-green-500', 'bg-white/20');
                circle.classList.add('bg-veritas-gold');
              }
            } else {
              var circle = progressStep.querySelector('.progress-circle');
              if (circle) {
                circle.classList.remove('bg-green-500', 'bg-veritas-gold');
                circle.classList.add('bg-white/20');
              }
            }
          }
        }
      });

      // Update wizard content steps
      for (var i = 1; i <= 4; i++) {
        var step = document.getElementById('wizard-step-' + i);
        if (step) step.classList.remove('active');
      }

      var targetStep = document.getElementById('wizard-step-' + stepNumber);
      if (targetStep) targetStep.classList.add('active');

      wizardState.currentStep = stepNumber;
      updateWizardFooter();

      // Pre-fill configuration fields when navigating to step 2
      if (stepNumber === 2) {
        var pollNameInput = document.getElementById('wizard-poll-name');
        var classSelect = document.getElementById('wizard-class-select');
        var timeLimitInput = document.getElementById('wizard-time-limit');
        var accessCodeInput = document.getElementById('wizard-access-code');
        var calculatorToggle = document.getElementById('wizard-calculator-toggle');

        if (pollNameInput && wizardState.pollName) {
          pollNameInput.value = wizardState.pollName;
        }
        if (classSelect && wizardState.className) {
          classSelect.value = wizardState.className;
        }
        if (timeLimitInput && wizardState.timeLimitMinutes) {
          timeLimitInput.value = wizardState.timeLimitMinutes;
        }
        if (accessCodeInput && wizardState.accessCode) {
          accessCodeInput.value = wizardState.accessCode;
        }
        if (calculatorToggle) {
          calculatorToggle.checked = wizardState.calculatorEnabled === true;
        }

        // Update mode-specific content if in edit mode
        if (wizardState.isEditMode && wizardState.mode) {
          var modeLabel = document.getElementById('wizard-step-2')?.querySelector('span.mode-label');
          if (modeLabel) {
            modeLabel.textContent = wizardState.mode === 'secure' ? 'Secure Assessment' : 'Live Poll';
          }
        }
      }

      // Render questions when navigating to step 3
      if (stepNumber === 3) {
        renderWizardQuestions();
      }

      if (stepNumber === 4) {
        renderReviewSummary();
      }
    }

    function wizardGoNext() {
      if (!validateWizardStep(wizardState.currentStep)) {
        return;
      }

      saveWizardStepData(wizardState.currentStep);

      if (wizardState.currentStep < 4) {
        goToWizardStep(wizardState.currentStep + 1);
      }
    }

    function wizardGoBack() {
      if (wizardState.currentStep > 1) {
        goToWizardStep(wizardState.currentStep - 1);
      }
    }

    function updateWizardFooter() {
      var backBtn = document.getElementById('wizard-back-btn');
      var nextBtn = document.getElementById('wizard-next-btn');
      var publishBtn = document.getElementById('wizard-publish-btn');

      if (!backBtn || !nextBtn || !publishBtn) return;

      // In edit mode, allow going back to step 2 (but not step 1)
      if (wizardState.isEditMode) {
        backBtn.disabled = wizardState.currentStep <= 2;
      } else {
        backBtn.disabled = wizardState.currentStep === 1;
      }

      if (wizardState.currentStep === 4) {
        nextBtn.classList.add('hidden');
        publishBtn.classList.remove('hidden');

        // Update publish button text based on mode
        var publishBtnIcon = publishBtn.querySelector('.material-symbols-outlined');
        var publishBtnText = publishBtn.querySelector('.publish-btn-text') || publishBtn;

        if (wizardState.isEditMode) {
          if (publishBtnIcon) publishBtnIcon.textContent = 'save';
          publishBtnText.innerHTML = '<span class="material-symbols-outlined">save</span>Update Poll';
        } else {
          if (publishBtnIcon) publishBtnIcon.textContent = 'rocket_launch';
          publishBtnText.innerHTML = '<span class="material-symbols-outlined">rocket_launch</span>Publish Poll';
        }
      } else {
        nextBtn.classList.remove('hidden');
        publishBtn.classList.add('hidden');
      }
    }

    // ===========================
    // STEP 1: MODE SELECTION
    // ===========================

    function selectPollMode(mode) {
      wizardState.mode = mode;

      var cards = document.querySelectorAll('.mode-card');
      cards.forEach(function (card) {
        if (card.getAttribute('data-mode') === mode) {
          card.classList.add('selected');
        } else {
          card.classList.remove('selected');
        }
      });

      var nextBtn = document.getElementById('wizard-next-btn');
      if (nextBtn) nextBtn.disabled = false;
    }

    // ===========================
    // VALIDATION & DATA SAVE
    // ===========================

    function saveWizardStepData(stepNumber) {
      if (stepNumber === 2) {
        wizardState.pollName = document.getElementById('wizard-poll-name')?.value || '';
        wizardState.className = document.getElementById('wizard-class-select')?.value || '';

        if (wizardState.mode === 'secure') {
          wizardState.timeLimitMinutes = parseInt(document.getElementById('wizard-time-limit')?.value) || null;
          wizardState.accessCode = document.getElementById('wizard-access-code')?.value || '';
          wizardState.calculatorEnabled = document.getElementById('wizard-calculator-toggle')?.checked || false;
        }
      }
    }

    function validateWizardStep(stepNumber) {
      if (stepNumber === 1) {
        if (!wizardState.mode) {
          alert('Please select a poll mode.');
          return false;
        }

        var liveSection = document.getElementById('live-config-section');
        var secureSection = document.getElementById('secure-config-section');
        var modeLabel = document.getElementById('config-mode-label');

        if (wizardState.mode === 'live') {
          if (liveSection) liveSection.classList.remove('hidden');
          if (secureSection) secureSection.classList.add('hidden');
          if (modeLabel) modeLabel.textContent = 'Live Poll';
        } else {
          if (liveSection) liveSection.classList.add('hidden');
          if (secureSection) secureSection.classList.remove('hidden');
          if (modeLabel) modeLabel.textContent = 'Secure Assessment';
        }

        return true;
      }

      if (stepNumber === 2) {
        var pollName = document.getElementById('wizard-poll-name')?.value.trim();
        var className = document.getElementById('wizard-class-select')?.value;

        if (!pollName) {
          alert('Please enter a poll name.');
          return false;
        }

        if (!className) {
          alert('Please select a class.');
          return false;
        }

        if (wizardState.mode === 'secure') {
          var timeLimit = parseInt(document.getElementById('wizard-time-limit')?.value);
          if (!timeLimit || timeLimit <= 0) {
            alert('Time limit is required for Secure Assessments.');
            return false;
          }
        }

        return true;
      }

      if (stepNumber === 3) {
        if (wizardState.questions.length === 0) {
          alert('Please add at least one question.');
          return false;
        }
        return true;
      }

      return true;
    }

    // ===========================
    // STEP 3: QUESTIONS - Full Editor
    // ===========================

    function addWizardQuestion() {
      var container = document.getElementById('wizard-questions-list');
      if (!container) return;

      wizardState.questions.push({
        questionText: '',
        questionImageURL: '',
        options: [
          { text: '', imageURL: '' },
          { text: '', imageURL: '' },
          { text: '', imageURL: '' },
          { text: '', imageURL: '' }
        ],
        correctAnswerIndex: 0,
        metacognitionEnabled: false,
        timerSeconds: null
      });

      renderWizardQuestions();

      // Scroll to the new question
      setTimeout(function () {
        var newQuestion = container.lastElementChild;
        if (newQuestion) {
          newQuestion.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 100);
    }

    function removeWizardQuestion(index) {
      if (wizardState.questions.length <= 1) {
        alert('You must have at least one question.');
        return;
      }
      if (confirm('Are you sure you want to remove this question?')) {
        wizardState.questions.splice(index, 1);
        renderWizardQuestions();
      }
    }

    function addWizardOption(qIndex) {
      var q = wizardState.questions[qIndex];
      if (q.options.length >= 6) {
        alert('Maximum 6 answer choices allowed.');
        return;
      }
      q.options.push({ text: '', imageURL: '' });
      renderWizardQuestions();
    }

    function removeWizardOption(qIndex, optIndex) {
      var q = wizardState.questions[qIndex];
      if (q.options.length <= 2) {
        alert('Minimum 2 answer choices required.');
        return;
      }
      q.options.splice(optIndex, 1);
      // Adjust correct answer index if needed
      if (q.correctAnswerIndex >= q.options.length) {
        q.correctAnswerIndex = 0;
      }
      renderWizardQuestions();
    }

    function setCorrectAnswer(qIndex, optIndex) {
      wizardState.questions[qIndex].correctAnswerIndex = optIndex;
      renderWizardQuestions();
    }

    function renderWizardQuestions() {
      var container = document.getElementById('wizard-questions-list');
      if (!container) return;

      container.innerHTML = '';

      wizardState.questions.forEach(function (q, qIndex) {
        var optionLabels = ['A', 'B', 'C', 'D', 'E', 'F'];

        var questionDiv = document.createElement('div');
        questionDiv.className = 'question-card bg-white border border-brand-light-gray rounded-xl overflow-hidden shadow-sm transition-all duration-200';
        questionDiv.draggable = true;
        questionDiv.dataset.qIndex = qIndex;

        // Compact Question Header with drag handle
        var headerHtml = '<div class="question-card-header flex justify-between items-center px-4 py-2.5 bg-gradient-to-r from-slate-50 to-slate-100 border-b border-brand-light-gray cursor-move" data-drag-handle>' +
          '<div class="flex items-center gap-2">' +
          '<span class="material-symbols-outlined text-slate-400 text-lg" title="Drag to reorder">drag_indicator</span>' +
          '<div class="h-7 w-7 rounded-lg bg-primary text-white flex items-center justify-center font-bold text-xs">' + (qIndex + 1) + '</div>' +
          '<span class="font-bold text-brand-dark-gray">Q' + (qIndex + 1) + '</span>' +
          '</div>' +
          '<div class="flex items-center gap-1">' +
          '<label class="flex items-center gap-1 px-2 py-1 rounded hover:bg-slate-200 cursor-pointer text-xs text-slate-500" title="Enable confidence tracking">' +
          '<input type="checkbox" class="wizard-meta-cb h-3.5 w-3.5 rounded" data-q-index="' + qIndex + '" ' + (q.metacognitionEnabled ? 'checked' : '') + '>' +
          '<span>Confidence</span></label>' +
          '<button type="button" class="p-1.5 rounded text-red-500 hover:bg-red-50 transition-colors" onclick="removeWizardQuestion(' + qIndex + ')" title="Remove">' +
          '<span class="material-symbols-outlined text-lg">delete</span></button>' +
          '</div></div>';

        // Compact Question Body
        var bodyHtml = '<div class="question-card-body p-4 space-y-3">' +
          // Question Row: Text + Image Upload
          '<div class="flex gap-3">' +
          '<div class="flex-1">' +
          '<textarea class="wizard-q-text w-full rounded-lg border border-brand-light-gray px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary overflow-hidden min-h-[60px]" style="resize:none;height:auto;" placeholder="Enter question text..." data-q-index="' + qIndex + '">' + escapeHtml(q.questionText || '') + '</textarea>' +
          '</div>' +
          '<div class="shrink-0 flex flex-col items-center gap-1">';

        // Question Image Upload/Preview
        var qImagePreview = getImagePreviewUrl(q.questionImageURL, q.questionImageFileId);
        var qIsUploading = q.questionImageURL === 'UPLOADING';

        if (qIsUploading) {
          bodyHtml += '<div class="h-16 w-20 rounded-lg bg-primary/10 flex items-center justify-center">' +
            '<div class="h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent"></div></div>';
        } else if (qImagePreview) {
          bodyHtml += '<div class="relative">' +
            '<img src="' + qImagePreview + '" class="h-16 w-20 object-cover rounded-lg border border-brand-light-gray" referrerpolicy="no-referrer">' +
            '<button type="button" class="wizard-remove-q-img absolute -top-1.5 -right-1.5 h-5 w-5 bg-red-500 text-white rounded-full flex items-center justify-center text-xs" data-q-index="' + qIndex + '" title="Remove">&times;</button>' +
            '</div>';
        } else {
          bodyHtml += '<label class="h-16 w-20 rounded-lg border-2 border-dashed border-brand-light-gray flex flex-col items-center justify-center cursor-pointer hover:border-primary hover:bg-primary/5 transition-all">' +
            '<span class="material-symbols-outlined text-brand-dark-gray/40 text-lg">image</span>' +
            '<span class="text-[10px] text-brand-dark-gray/40">Upload</span>' +
            '<input type="file" class="wizard-q-img-input hidden" accept="image/*" data-q-index="' + qIndex + '">' +
            '</label>';
        }

        bodyHtml += '</div></div>';

        // Answer Choices - Compact
        bodyHtml += '<div class="space-y-2">';
        q.options.forEach(function (opt, optIndex) {
          var isCorrect = q.correctAnswerIndex === optIndex;
          var correctBorder = isCorrect ? 'border-green-400 bg-green-50/30' : 'border-brand-light-gray/80';
          var optImagePreview = getImagePreviewUrl(opt.imageURL, opt.imageFileId);
          var optIsUploading = opt.imageURL === 'UPLOADING';

          bodyHtml += '<div class="answer-option flex items-center gap-2 p-2 rounded-lg border ' + correctBorder + ' transition-all">' +
            // Correct answer radio
            '<label class="cursor-pointer">' +
            '<input type="radio" name="correct-' + qIndex + '" class="hidden wizard-correct-radio" data-q-index="' + qIndex + '" data-opt-index="' + optIndex + '" ' + (isCorrect ? 'checked' : '') + '>' +
            '<div class="h-7 w-7 rounded flex items-center justify-center font-bold text-xs transition-all ' +
            (isCorrect ? 'bg-green-500 text-white' : 'bg-slate-100 text-slate-500 hover:bg-primary/10') + '">' + optionLabels[optIndex] + '</div>' +
            '</label>' +
            // Option text
            '<input type="text" class="wizard-opt-text flex-1 rounded border border-brand-light-gray/70 px-2.5 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-primary/30" placeholder="Answer ' + optionLabels[optIndex] + '..." data-q-index="' + qIndex + '" data-opt-index="' + optIndex + '" value="' + escapeHtml(opt.text || '') + '">';

          // Option image upload/preview
          if (optIsUploading) {
            bodyHtml += '<div class="h-8 w-10 rounded bg-primary/10 flex items-center justify-center shrink-0">' +
              '<div class="h-3 w-3 animate-spin rounded-full border border-primary border-t-transparent"></div></div>';
          } else if (optImagePreview) {
            bodyHtml += '<div class="relative shrink-0">' +
              '<img src="' + optImagePreview + '" class="h-8 w-10 object-cover rounded border" referrerpolicy="no-referrer">' +
              '<button type="button" class="wizard-remove-opt-img absolute -top-1 -right-1 h-4 w-4 bg-red-500 text-white rounded-full flex items-center justify-center text-[10px]" data-q-index="' + qIndex + '" data-opt-index="' + optIndex + '">&times;</button>' +
              '</div>';
          } else {
            bodyHtml += '<label class="h-8 w-10 rounded border border-dashed border-brand-light-gray/70 flex items-center justify-center cursor-pointer hover:border-primary shrink-0">' +
              '<span class="material-symbols-outlined text-sm text-slate-400">add_photo_alternate</span>' +
              '<input type="file" class="wizard-opt-img-input hidden" accept="image/*" data-q-index="' + qIndex + '" data-opt-index="' + optIndex + '">' +
              '</label>';
          }

          // Remove option
          bodyHtml += '<button type="button" class="p-1 rounded text-slate-300 hover:text-red-500 transition-colors" onclick="removeWizardOption(' + qIndex + ',' + optIndex + ')">' +
            '<span class="material-symbols-outlined text-base">close</span></button>' +
            '</div>';
        });
        bodyHtml += '</div>';

        // Add option + timer row
        bodyHtml += '<div class="flex items-center justify-between pt-1">';
        if (q.options.length < 6) {
          bodyHtml += '<button type="button" class="flex items-center gap-1 text-xs font-medium text-primary hover:text-primary/80" onclick="addWizardOption(' + qIndex + ')">' +
            '<span class="material-symbols-outlined text-sm">add</span>Add choice</button>';
        } else {
          bodyHtml += '<span></span>';
        }
        bodyHtml += '<div class="flex items-center gap-1.5">' +
          '<span class="text-xs text-slate-400">Timer:</span>' +
          '<input type="number" class="wizard-timer w-14 rounded border border-brand-light-gray/70 px-1.5 py-0.5 text-xs text-center" placeholder="sec" min="5" max="600" data-q-index="' + qIndex + '" value="' + (q.timerSeconds || '') + '">' +
          '</div></div>';

        bodyHtml += '</div>'; // Close question-card-body

        questionDiv.innerHTML = headerHtml + bodyHtml;
        container.appendChild(questionDiv);

        // Bind event listeners
        var qTextarea = questionDiv.querySelector('.wizard-q-text');
        if (qTextarea) {
          // Auto-resize textarea on load
          qTextarea.style.height = 'auto';
          qTextarea.style.height = qTextarea.scrollHeight + 'px';

          qTextarea.addEventListener('input', function () {
            wizardState.questions[qIndex].questionText = this.value;
            // Auto-resize as user types
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
          });
        }

        // Question image file input
        var qImgInput = questionDiv.querySelector('.wizard-q-img-input');
        if (qImgInput) {
          qImgInput.addEventListener('change', function (e) {
            handleWizardImageUpload(e.target.files[0], qIndex, null);
          });
        }

        // Question image remove button
        var qImgRemoveBtn = questionDiv.querySelector('.wizard-remove-q-img');
        if (qImgRemoveBtn) {
          qImgRemoveBtn.addEventListener('click', function () {
            wizardState.questions[qIndex].questionImageURL = null;
            wizardState.questions[qIndex].questionImageFileId = null;
            renderWizardQuestions();
          });
        }

        // Option text inputs
        questionDiv.querySelectorAll('.wizard-opt-text').forEach(function (input) {
          input.addEventListener('input', function () {
            var qi = parseInt(this.getAttribute('data-q-index'));
            var oi = parseInt(this.getAttribute('data-opt-index'));
            wizardState.questions[qi].options[oi].text = this.value;
          });
        });

        // Option image file inputs
        questionDiv.querySelectorAll('.wizard-opt-img-input').forEach(function (input) {
          input.addEventListener('change', function (e) {
            var qi = parseInt(this.getAttribute('data-q-index'));
            var oi = parseInt(this.getAttribute('data-opt-index'));
            handleWizardImageUpload(e.target.files[0], qi, oi);
          });
        });

        // Option image remove buttons
        questionDiv.querySelectorAll('.wizard-remove-opt-img').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var qi = parseInt(this.getAttribute('data-q-index'));
            var oi = parseInt(this.getAttribute('data-opt-index'));
            wizardState.questions[qi].options[oi].imageURL = null;
            wizardState.questions[qi].options[oi].imageFileId = null;
            renderWizardQuestions();
          });
        });

        // Correct answer radios
        questionDiv.querySelectorAll('.wizard-correct-radio').forEach(function (radio) {
          radio.parentElement.addEventListener('click', function (e) {
            e.preventDefault();
            var qi = parseInt(radio.getAttribute('data-q-index'));
            var oi = parseInt(radio.getAttribute('data-opt-index'));
            setCorrectAnswer(qi, oi);
          });
        });

        // Metacognition checkbox
        var metaCb = questionDiv.querySelector('.wizard-meta-cb');
        if (metaCb) {
          metaCb.addEventListener('change', function () {
            wizardState.questions[qIndex].metacognitionEnabled = this.checked;
          });
        }

        // Timer input
        var timerInput = questionDiv.querySelector('.wizard-timer');
        if (timerInput) {
          timerInput.addEventListener('input', function () {
            var val = parseInt(this.value);
            wizardState.questions[qIndex].timerSeconds = isNaN(val) ? null : val;
          });
        }

        // Drag and Drop Event Listeners
        questionDiv.addEventListener('dragstart', function (e) {
          wizardDraggedIndex = qIndex;
          this.classList.add('opacity-50');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', this.innerHTML);
        });

        questionDiv.addEventListener('dragend', function (e) {
          this.classList.remove('opacity-50');
          // Remove all drag-over indicators
          container.querySelectorAll('.question-card').forEach(function (card) {
            card.classList.remove('border-blue-500', 'border-dashed', 'border-2');
          });
        });

        questionDiv.addEventListener('dragover', function (e) {
          if (e.preventDefault) {
            e.preventDefault();
          }
          e.dataTransfer.dropEffect = 'move';

          // Add visual feedback
          this.classList.add('border-blue-500', 'border-dashed', 'border-2');

          return false;
        });

        questionDiv.addEventListener('dragleave', function (e) {
          this.classList.remove('border-blue-500', 'border-dashed', 'border-2');
        });

        questionDiv.addEventListener('drop', function (e) {
          if (e.stopPropagation) {
            e.stopPropagation();
          }

          var dropIndex = parseInt(this.dataset.qIndex);

          if (wizardDraggedIndex !== null && wizardDraggedIndex !== dropIndex) {
            // Reorder questions in the array
            var draggedQuestion = wizardState.questions[wizardDraggedIndex];
            wizardState.questions.splice(wizardDraggedIndex, 1);
            wizardState.questions.splice(dropIndex, 0, draggedQuestion);

            // Re-render questions to show new order
            renderWizardQuestions();
          }

          return false;
        });
      });
    }

    // Image upload handler for wizard
    function handleWizardImageUpload(file, qIndex, optIndex) {
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file.');
        return;
      }

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Image must be less than 5MB.');
        return;
      }

      // Set uploading state
      if (optIndex === null) {
        wizardState.questions[qIndex].questionImageURL = 'UPLOADING';
      } else {
        wizardState.questions[qIndex].options[optIndex].imageURL = 'UPLOADING';
      }
      renderWizardQuestions();

      // Convert to data URL and upload
      var reader = new FileReader();
      reader.onload = function (e) {
        var dataUrl = e.target.result;


        // IMAGE UPLOAD DISABLED FOR MIGRATION
        veritasAlert('Image upload is temporarily unavailable while we migrate to the new cloud backend.', { title: 'Feature Unavailable' });

        // Reset uploading state
        if (optIndex === null) {
          wizardState.questions[qIndex].questionImageURL = null;
        } else {
          wizardState.questions[qIndex].options[optIndex].imageURL = null;
        }
        renderWizardQuestions();


      };
      reader.readAsDataURL(file);
    }

    // Expose new functions globally
    window.addWizardOption = addWizardOption;
    window.removeWizardOption = removeWizardOption;
    window.setCorrectAnswer = setCorrectAnswer;
    window.handleWizardImageUpload = handleWizardImageUpload;

    // ===========================
    // STEP 4: REVIEW
    // ===========================

    function renderReviewSummary() {
      var modeText = wizardState.mode === 'live' ? 'Live Poll' : 'Secure Assessment';
      document.getElementById('review-mode').textContent = modeText;
      document.getElementById('review-name').textContent = wizardState.pollName || '(Untitled)';
      document.getElementById('review-class').textContent = wizardState.className || '(No class selected)';

      var qSummary = document.getElementById('review-questions-summary');
      if (qSummary) {
        if (wizardState.questions.length === 0) {
          qSummary.innerHTML = '<p class="text-red-500 font-medium">No questions added. Please go back and add at least one question.</p>';
        } else {
          var optionLabels = ['A', 'B', 'C', 'D', 'E', 'F'];
          var html = '<div class="space-y-4">';
          html += '<p class="text-sm text-brand-dark-gray/60 mb-3">' + wizardState.questions.length + ' question(s) ready to publish</p>';

          wizardState.questions.forEach(function (q, i) {
            var text = q.questionText || '(Empty question)';
            if (text.length > 80) text = text.substring(0, 80) + '...';

            html += '<div class="bg-slate-50 rounded-lg p-3 border border-brand-light-gray hover:border-primary hover:bg-primary/5 cursor-pointer transition-all group" data-edit-question="' + i + '" title="Click to edit this question">';
            html += '<div class="flex items-start gap-2 mb-2">';
            html += '<span class="h-6 w-6 rounded bg-primary text-white text-xs font-bold flex items-center justify-center shrink-0">' + (i + 1) + '</span>';
            html += '<span class="font-medium text-brand-dark-gray text-sm group-hover:text-primary">' + escapeHtml(text) + '</span>';
            html += '<span class="material-symbols-outlined text-xs text-slate-400 ml-auto opacity-0 group-hover:opacity-100 transition-opacity">edit</span>';
            html += '</div>';

            // Show answer choices
            if (q.options && q.options.length > 0) {
              html += '<div class="ml-8 flex flex-wrap gap-2">';
              q.options.forEach(function (opt, j) {
                if (opt.text && opt.text.trim() !== '') {
                  var isCorrect = q.correctAnswerIndex === j;
                  var optClass = isCorrect ? 'bg-green-100 text-green-700 border-green-300' : 'bg-white text-brand-dark-gray/70 border-brand-light-gray';
                  var optText = opt.text.length > 20 ? opt.text.substring(0, 20) + '...' : opt.text;
                  html += '<span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded border ' + optClass + '">';
                  html += '<strong>' + optionLabels[j] + '</strong> ' + escapeHtml(optText);
                  if (isCorrect) html += ' <span class="material-symbols-outlined text-xs">check</span>';
                  html += '</span>';
                }
              });
              html += '</div>';
            }
            html += '</div>';
          });

          html += '</div>';

          // Show secure settings if applicable
          if (wizardState.mode === 'secure') {
            html += '<div class="mt-4 p-3 rounded-lg bg-amber-50 border border-amber-200">';
            html += '<h5 class="text-sm font-bold text-amber-800 mb-2 flex items-center gap-2"><span class="material-symbols-outlined text-base">lock</span>Secure Assessment Settings</h5>';
            html += '<div class="text-sm text-amber-700 space-y-1">';
            html += '<p><strong>Time Limit:</strong> ' + (wizardState.timeLimitMinutes || 'Not set') + ' minutes</p>';
            if (wizardState.accessCode) {
              html += '<p><strong>Access Code:</strong> ' + escapeHtml(wizardState.accessCode) + '</p>';
            }
            html += '<p><strong>Calculator:</strong> ' + (wizardState.calculatorEnabled ? 'Enabled' : 'Disabled') + '</p>';
            html += '</div></div>';
          }

          qSummary.innerHTML = html;

          // Add click handlers for editing questions from review
          qSummary.querySelectorAll('[data-edit-question]').forEach(function (card) {
            card.addEventListener('click', function () {
              var questionIndex = parseInt(this.getAttribute('data-edit-question'));
              // Navigate back to step 3 (questions editor)
              goToWizardStep(3);
              // Scroll to the question after a brief delay to allow rendering
              setTimeout(function () {
                var questionCards = document.querySelectorAll('.question-card');
                if (questionCards[questionIndex]) {
                  questionCards[questionIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                  // Briefly highlight the card
                  questionCards[questionIndex].classList.add('ring-2', 'ring-primary', 'ring-offset-2');
                  setTimeout(function () {
                    questionCards[questionIndex].classList.remove('ring-2', 'ring-primary', 'ring-offset-2');
                  }, 2000);
                }
              }, 100);
            });
          });
        }
      }
    }

    function publishWizardPoll() {
      // Client-side validation
      if (!wizardState.pollName || wizardState.pollName.trim() === '') {
        alert('Please enter a poll name.');
        goToWizardStep(2);
        return;
      }

      if (!wizardState.className || wizardState.className.trim() === '') {
        alert('Please select a class.');
        goToWizardStep(2);
        return;
      }

      if (wizardState.questions.length === 0) {
        alert('Please add at least one question.');
        goToWizardStep(3);
        return;
      }

      // Validate each question has text and at least one non-empty answer
      for (var i = 0; i < wizardState.questions.length; i++) {
        var q = wizardState.questions[i];
        if (!q.questionText || q.questionText.trim() === '') {
          alert('Question ' + (i + 1) + ' is missing the question text.');
          goToWizardStep(3);
          return;
        }

        var hasValidOption = false;
        for (var j = 0; j < q.options.length; j++) {
          if (q.options[j].text && q.options[j].text.trim() !== '') {
            hasValidOption = true;
            break;
          }
        }

        if (!hasValidOption) {
          alert('Question ' + (i + 1) + ' needs at least one answer choice.');
          goToWizardStep(3);
          return;
        }
      }

      // Validate secure assessment settings
      if (wizardState.mode === 'secure') {
        if (!wizardState.timeLimitMinutes || wizardState.timeLimitMinutes <= 0) {
          alert('Please set a time limit for secure assessments.');
          goToWizardStep(2);
          return;
        }
      }

      // Transform questions to match API format
      // API expects: { questionText, questionImageURL, questionImageFileId, options: [{text, imageURL, imageFileId}], correctAnswer, timerSeconds, metacognitionEnabled }
      var apiQuestions = wizardState.questions.map(function (q) {
        // Filter out empty options
        var validOptions = q.options.filter(function (opt) {
          return opt.text && opt.text.trim() !== '';
        });

        // If no valid options, use at least 2 placeholder options
        if (validOptions.length < 2) {
          validOptions = [
            { text: 'Option A', imageURL: null, imageFileId: null },
            { text: 'Option B', imageURL: null, imageFileId: null }
          ];
        }

        // Get the correct answer text
        var correctAnswerText = null;
        if (q.correctAnswerIndex !== undefined && q.correctAnswerIndex !== null) {
          var correctOpt = q.options[q.correctAnswerIndex];
          if (correctOpt && correctOpt.text && correctOpt.text.trim() !== '') {
            correctAnswerText = correctOpt.text.trim();
          }
        }

        // If correct answer wasn't set or was invalid, default to first option
        if (!correctAnswerText && validOptions.length > 0) {
          correctAnswerText = validOptions[0].text;
        }

        return {
          questionText: q.questionText.trim(),
          questionImageURL: q.questionImageURL && q.questionImageURL !== 'UPLOADING' ? q.questionImageURL : null,
          questionImageFileId: q.questionImageFileId || null,
          options: validOptions.map(function (opt) {
            return {
              text: opt.text.trim(),
              imageURL: opt.imageURL && opt.imageURL !== 'UPLOADING' ? opt.imageURL : null,
              imageFileId: opt.imageFileId || null
            };
          }),
          correctAnswer: correctAnswerText,
          timerSeconds: q.timerSeconds || null,
          metacognitionEnabled: !!q.metacognitionEnabled
        };
      });

      // Build metadata object
      var metadata = {
        sessionType: wizardState.mode === 'secure' ? 'SECURE_ASSESSMENT' : 'LIVE_POLL'
      };

      if (wizardState.mode === 'secure') {
        metadata.timeLimitMinutes = parseInt(wizardState.timeLimitMinutes) || 60;
        metadata.accessCode = wizardState.accessCode || '';
        metadata.calculatorEnabled = wizardState.calculatorEnabled === true;
      }

      var publishBtn = document.getElementById('wizard-publish-btn');
      var actionText = wizardState.isEditMode ? 'Updating' : 'Publishing';
      var actionIcon = wizardState.isEditMode ? 'save' : 'rocket_launch';

      if (publishBtn) {
        publishBtn.disabled = true;
        publishBtn.innerHTML = '<span class="material-symbols-outlined animate-spin">hourglass_empty</span> ' + actionText + '...';
      }

      console.log(actionText + ' poll:', wizardState.pollName, wizardState.className, apiQuestions, metadata);

      // FIREBASE MIGRATION: Use Cloud Functions for secure writes
      var functions = firebase.functions();

      if (wizardState.isEditMode && wizardState.pollId) {
        // UPDATE EXISTING POLL
        var pollId = wizardState.pollId;
        var updatePayload = {
          pollId: pollId,
          pollName: wizardState.pollName.trim(),
          className: wizardState.className.trim(),
          questions: apiQuestions,
          metadata: metadata
        };

        var updatePoll = functions.httpsCallable('updatePoll');

        updatePoll(updatePayload)
          .then(async function (result) {
            console.log('Poll updated via Cloud Function:', result.data);
            await veritasAlert('Poll updated successfully!', { title: 'Success' });

            // Synthesize a response object compatible with legacy dashboard expectations
            var response = {
              pollId: pollId,
              pollName: updatePayload.pollName,
              className: updatePayload.className,
              questions: updatePayload.questions,
              metadata: updatePayload.metadata,
              success: true
            };
            completeWizardPublish(response);
          })
          .catch(async function (error) {
            console.error('Cloud Function Update Error:', error);
            await veritasAlert('Failed to update: ' + (error.message || 'Unknown error'), { title: 'Error', destructive: true });
            if (publishBtn) {
              publishBtn.disabled = false;
              publishBtn.innerHTML = '<span class="material-symbols-outlined">' + actionIcon + '</span> Update Poll';
            }
          });

      } else {
        // CREATE NEW POLL
        var createPayload = {
          pollName: wizardState.pollName.trim(),
          className: wizardState.className.trim(),
          questions: apiQuestions,
          metadata: metadata
        };

        var createPoll = functions.httpsCallable('createPoll');

        createPoll(createPayload)
          .then(async function (result) {
            console.log('Poll created via Cloud Function:', result.data);
            await veritasAlert('Poll published successfully!', { title: 'Success' });

            var response = {
              pollId: result.data.pollId,
              pollName: createPayload.pollName,
              className: createPayload.className,
              questions: createPayload.questions,
              metadata: createPayload.metadata,
              success: true
            };
            completeWizardPublish(response);
          })
          .catch(async function (error) {
            console.error('Cloud Function Create Error:', error);
            await veritasAlert('Failed to publish: ' + (error.message || 'Unknown error'), { title: 'Error', destructive: true });
            if (publishBtn) {
              publishBtn.disabled = false;
              publishBtn.innerHTML = '<span class="material-symbols-outlined">' + actionIcon + '</span> Publish Poll';
            }
          });
      }
    }

    // Expose functions used by inline HTML handlers
    window.showDashboard = showDashboard;
    window.openPollCreator = openPollCreator;
    window.openPollWizard = openPollWizard;
    window.closePollWizard = closePollWizard;
    window.selectPollMode = selectPollMode;
    window.wizardGoNext = wizardGoNext;
    window.wizardGoBack = wizardGoBack;
    window.goToWizardStep = goToWizardStep;
    window.goToWizardStep = goToWizardStep;
    window.addWizardQuestion = addWizardQuestion;
    window.removeWizardQuestion = removeWizardQuestion;
    window.endSession = endSession; // Expose endSession globally
    window.publishWizardPoll = publishWizardPoll;
    window.filterStudentsByFlag = filterStudentsByFlag;
    window.clearStudentFilter = clearStudentFilter;
    window.sortStudentsBy = sortStudentsBy;
    window.updateLiveView = updateLiveView;
    window.endSession = endSession;

    // Bind Stop Buttons
    bindClick('header-stop-btn', function () {
      if (CURRENT_POLL_DATA && CURRENT_POLL_DATA.pollId) {
        endSession(CURRENT_POLL_DATA.pollId);
      }
    });

    bindClick('fab-stop-btn', function () {
      if (CURRENT_POLL_DATA && CURRENT_POLL_DATA.pollId) {
        endSession(CURRENT_POLL_DATA.pollId);
      }
    });

    bindClick('mobile-stop-btn', function () {
      if (CURRENT_POLL_DATA && CURRENT_POLL_DATA.pollId) {
        endSession(CURRENT_POLL_DATA.pollId);
      }
    });

    // ========== SESSION MANAGEMENT ========== //

    /**
     * End the current live session securely via Cloud Function.
     * @param {string} pollId - The ID of the poll/session to end.
     */
    async function endSession(pollId) {
      if (!pollId) {
        console.error('endSession called without pollId');
        return;
      }

      if (!confirm('Are you sure you want to end this session? This will stop all student activity and finalize the results.')) {
        return;
      }

      var btn = document.getElementById('header-stop-btn');
      var fabBtn = document.getElementById('fab-stop-btn');
      var mobileBtn = document.getElementById('mobile-stop-btn');

      var btns = [btn, fabBtn, mobileBtn].filter(Boolean);

      btns.forEach(function (b) {
        b.disabled = true;
        b.innerHTML = '<span class="material-symbols-outlined animate-spin">hourglass_empty</span> Ending...';
      });

      try {
        var finalizeSession = firebase.functions().httpsCallable('finalizeSession');
        var result = await finalizeSession({ pollId: pollId });

        console.log('Session finalized:', result.data);

        await veritasAlert('Session ended successfully. Results have been saved to history.', { title: 'Session Ended' });

        // Reset UI state
        var liveView = document.getElementById('live-view');
        var liveHeader = document.getElementById('header-live');
        var defaultHeader = document.getElementById('header-default');

        if (liveView) liveView.style.display = 'none';
        if (liveHeader) liveHeader.style.display = 'none';
        if (defaultHeader) defaultHeader.style.display = 'flex';

        // Hide FAB container if visible
        var fabContainer = document.getElementById('fab-container');
        if (fabContainer) fabContainer.style.display = 'none';

        // Refresh dashboard
        if (typeof showDashboard === 'function') {
          showDashboard();
        } else {
          window.location.reload();
        }

      } catch (error) {
        console.error('Failed to end session:', error);
        await veritasAlert('Failed to end session: ' + (error.message || 'Unknown error'), { title: 'Error', destructive: true });

        // Re-enable buttons
        btns.forEach(function (b) {
          b.disabled = false;
          // Restore original content
          if (b.id === 'fab-stop-btn') {
            b.innerHTML = '<span class="material-symbols-outlined">stop</span>';
          } else if (b.id === 'mobile-stop-btn') {
            b.innerHTML = '<span class="material-symbols-outlined text-base">stop_circle</span><span>End</span>';
          } else {
            b.innerHTML = '<span class="material-symbols-outlined text-base">stop_circle</span> End Session';
          }
        });
      }
    }

    // OPTIMIZATION: Handle lightweight updates from server (2025)
    // Synthesizes a "full" view update from cached poll definitions
    // to provide instant UI feedback while waiting for real data.
    function handleLightweightSessionUpdate(data) {
      console.log('[Optimization] Handling lightweight update:', data);

      // 1. Broadcast immediately to Firebase (unblock students)
      // ENRICHED: Include the question data from CURRENT_POLL_DATA to allow Fast Path rendering
      var qIndex = data.questionIndex;
      var questionDef = (CURRENT_POLL_DATA && CURRENT_POLL_DATA.questions) ? CURRENT_POLL_DATA.questions[qIndex] : null;

      broadcastSessionState(data.pollId, {
        questionIndex: qIndex,
        status: data.status,
        sessionPhase: data.metadata ? data.metadata.sessionPhase : 'LIVE',
        resultsVisibility: data.metadata ? data.metadata.resultsVisibility : 'HIDDEN',
        // Pass content from local cache for instant student rendering
        questionText: questionDef ? questionDef.questionText : '',
        questionImageURL: questionDef ? questionDef.questionImageURL : '',
        options: questionDef ? questionDef.options : []
      });

      // 2. Synthesize a full view object from CURRENT_POLL_DATA
      if (!CURRENT_POLL_DATA || !CURRENT_POLL_DATA.questions) {
        console.warn('[Optimization] CURRENT_POLL_DATA missing, falling back to full refresh');
        // If we don't have poll definition, we must fetch full data explicitly
        // pollForResults() fails here because it relies on CURRENT_POLL_DATA being populated
        // FIREBASE MIGRATION: Synthesize from synced ALL_POLLS
        var poll = ALL_POLLS.find(function (p) { return p.pollId === data.pollId; });
        if (poll && poll.questions) {
          CURRENT_POLL_DATA = poll;
          var questionDef = poll.questions[data.questionIndex];
          if (questionDef) {
            // Re-trigger the synthesis with CURRENT_POLL_DATA populated
            onQuestionStateChange(data);
            return;
          }
        }
        console.error('[Firebase] Failed to locate poll definition for sync:', data.pollId);
        return;
      }

      var qIndex = data.questionIndex;
      var questionDef = CURRENT_POLL_DATA.questions[qIndex];

      if (!questionDef) {
        console.error('[Optimization] Question definition not found for index:', qIndex);
        return;
      }

      var syntheticData = {
        pollId: data.pollId,
        status: data.status, // OPEN
        questionIndex: qIndex,
        pollName: CURRENT_POLL_DATA.pollName,
        questionText: questionDef.questionText,
        questionImageURL: questionDef.questionImageURL,
        options: questionDef.options || [],
        totalQuestions: CURRENT_POLL_DATA.questions.length,
        correctAnswer: questionDef.correctAnswer,
        timerSeconds: questionDef.timerSeconds,
        metadata: data.metadata,
        authoritativeStatus: 'LIVE', // Assumed for start/next
        // Reset results
        results: {}, // Empty counts
        totalResponses: 0,
        totalStudents: currentStudentStatusData.length, // Keep previous count
        studentStatusList: currentStudentStatusData.map(function (s) {
          // Reset student statuses to waiting
          return Object.assign({}, s, {
            status: 'Waiting...',
            statusNote: 'waiting',
            answer: '---',
            isCorrect: null,
            confidence: null,
            timestamp: 9999999999999
          });
        })
      };

      // 3. Update UI instantly
      updateLiveView(syntheticData);

      // 4. Trigger background fetch to ensure consistency
      setTimeout(function () {
        console.log('[Optimization] Triggering background fetch for consistency');
        // Force reset navigation flag to ensure pollForResults runs
        isNavigating = false;
        pollForResults();
      }, 500);
    }


  })();
</script>
  <script>
    /**
     * Veritas Theme Manager
     * Handles Dark Mode persistence, system preference detection, and UI toggling.
     */
    (function () {
        var ThemeManager = {
            LOCAL_STORAGE_KEY: 'veritas_theme',

            init: function () {
                this.applyTheme(this.getPreferredTheme());
                this.injectToggle();

                // Listen for system changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    if (!localStorage.getItem(this.LOCAL_STORAGE_KEY)) {
                        this.applyTheme(e.matches ? 'dark' : 'light');
                    }
                });
            },

            getPreferredTheme: function () {
                var stored = localStorage.getItem(this.LOCAL_STORAGE_KEY);
                if (stored) return stored;
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            },

            applyTheme: function (theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                localStorage.setItem(this.LOCAL_STORAGE_KEY, theme);
                this.updateButtonState(theme);
            },

            toggle: function () {
                var current = this.getPreferredTheme();
                var next = current === 'dark' ? 'light' : 'dark';
                this.applyTheme(next);
            },

            updateButtonState: function (theme) {
                var btn = document.getElementById('theme-toggle-btn');
                if (!btn) return;

                var icon = btn.querySelector('.material-symbols-outlined');
                if (icon) {
                    icon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode';
                }
                btn.setAttribute('aria-label', 'Switch to ' + (theme === 'dark' ? 'light' : 'dark') + ' mode');
            },

            injectToggle: function () {
                if (document.getElementById('theme-toggle-btn')) return;

                var btn = document.createElement('button');
                btn.id = 'theme-toggle-btn';
                btn.className = 'theme-toggle fixed bottom-6 right-6 z-50 p-3 rounded-full shadow-lg transition-all duration-300 hover:scale-110 focus:outline-none';

                // Styles are inline or tailwind, but we need dynamic logic for colors
                // We'll use classes that adapt to dark mode via Tailwind
                btn.classList.add('bg-white', 'dark:bg-slate-800', 'text-slate-800', 'dark:text-yellow-400');

                btn.innerHTML = '<span class="material-symbols-outlined text-xl">dark_mode</span>';
                btn.onclick = this.toggle.bind(this);

                document.body.appendChild(btn);
                this.updateButtonState(this.getPreferredTheme());
            }
        };

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => ThemeManager.init());
        } else {
            ThemeManager.init();
        }

        // Expose global
        window.ThemeManager = ThemeManager;
    })();
</script>

<style>
    /* Extra transition for smooth theme switching */
    html.dark body {
        background-color: #0f172a;
        /* slate-900 */
        color: #f8fafc;
        /* slate-50 */
    }

    html.dark .glass-card {
        background: rgba(15, 23, 42, 0.6);
        border-color: rgba(255, 255, 255, 0.1);
    }

    /* Transition properties */
    body,
    .glass-card,
    .btn,
    .card {
        transition-property: background-color, border-color, color, fill, stroke;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 300ms;
    }
</style>
</body>

</html>