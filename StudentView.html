<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veritas Live Poll - Student</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#002d6b",
            "brand-blue": "#002d6b",
            "brand-accent": "#0066cc",
            "brand-white": "#ffffff",
            "brand-light-gray": "#d9e0e7",
            "brand-dark-gray": "#242424",
            "background-light": "#f5f7f8",
            "background-dark": "#0f1723"
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
            serif: ["Noto Serif", "serif"]
          },
          borderRadius: {
            DEFAULT: "0.25rem",
            lg: "0.5rem",
            xl: "0.75rem",
            full: "9999px"
          },
          animation: {
            'fade-in': 'fade-in 0.6s ease-out forwards',
            'spin-slow': 'spin 3s linear infinite',
            'pulse-dot': 'pulse-dot 1.2s ease-in-out infinite'
          },
          keyframes: {
            'fade-in': {
              'from': { opacity: '0', transform: 'translateY(10px)' },
              'to': { opacity: '1', transform: 'translateY(0)' }
            },
            'pulse-dot': {
              '0%, 80%, 100%': { opacity: '0.25', transform: 'scale(0.85)' },
              '40%': { opacity: '1', transform: 'scale(1)' }
            }
          }
        }
      }
    };
  </script>
  <script>window.SESSION_TOKEN = '<?= sessionToken ?>';</script>
  <style>
    .student-card {
      width: min(75vw, 900px);
      margin: 32px auto;
      background: #ffffff;
      color: #111111;
      border-radius: 12px;
      border-top: 4px solid #c5a05a;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .student-card.results-stage,
    .student-card.showing-results {
      background: #ffffff;
    }

    .student-card-header {
      padding: 16px 28px 12px;
      border-bottom: 1px solid rgba(18, 56, 93, 0.12);
      background: linear-gradient(135deg, rgba(18, 56, 93, 0.06), rgba(197, 160, 90, 0.08));
    }

    .student-question-number {
      font-size: 0.85rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #12385d;
      font-weight: 600;
    }

    .student-card-body {
      padding: 28px 28px 12px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .student-card-options {
      padding: 12px 28px 28px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .student-pre-live-card {
      max-width: 720px;
      text-align: center;
    }

    .student-pre-live-body {
      align-items: center;
      gap: 18px;
    }

    .student-pre-live-icon {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: rgba(18, 56, 93, 0.1);
      color: #12385d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.4rem;
      margin: 0 auto;
    }

    .student-pre-live-footer {
      align-items: center;
      gap: 16px;
    }

    .student-pre-live-status {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      letter-spacing: 0.28em;
      color: #12385d;
      font-size: 0.75rem;
    }

    .student-pre-live-label {
      font-weight: 700;
    }

    .student-pre-live-pips {
      display: inline-flex;
      gap: 6px;
    }

    .student-pre-live-pips .pip {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(18, 56, 93, 0.35);
      animation: pulse-dot 1.2s ease-in-out infinite;
    }

    .student-pre-live-reconnect {
      font-size: 0.9rem;
      color: #c62828;
      margin: 0;
    }

    .student-stem {
      font-size: 1.2rem;
      line-height: 1.6;
      font-weight: 400;
      color: #111111;
      margin: 0;
      text-align: left;
    }

    .student-subline {
      font-size: 0.95rem;
      color: rgba(17, 17, 17, 0.72);
      margin: 0;
    }

    .student-no-responses {
      font-size: 0.95rem;
      font-style: italic;
      color: #12385d;
      text-align: left;
      margin: 0;
    }

    .student-choices {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .student-choices li {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .student-card img {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      border: 1px solid rgba(18, 56, 93, 0.12);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    }

    .answer-option {
      position: relative;
      width: 100%;
      text-align: left;
      display: flex;
      align-items: flex-start;
      gap: 18px;
      background: #ffffff;
      color: #111111;
      border-radius: 12px;
      border: 1px solid rgba(18, 56, 93, 0.18);
      padding: 20px 22px;
      box-shadow: 0 2px 8px rgba(18, 56, 93, 0.08);
      transition: border-color 200ms ease, box-shadow 200ms ease, transform 200ms ease, background-color 200ms ease;
      cursor: pointer;
      appearance: none;
    }

    .answer-option:hover {
      border-color: #12385d;
      box-shadow: 0 6px 18px rgba(18, 56, 93, 0.16);
      transform: translateY(-1px);
    }

    .answer-option:focus-visible {
      outline: 3px solid rgba(18, 56, 93, 0.4);
      outline-offset: 2px;
    }

    .answer-option.result-readonly {
      pointer-events: none;
      cursor: default !important;
      box-shadow: 0 2px 6px rgba(18, 56, 93, 0.05);
    }

    .answer-option.answer-option-disabled {
      opacity: 0.55;
      pointer-events: none;
      cursor: default;
      box-shadow: 0 2px 6px rgba(18, 56, 93, 0.05);
    }

    .answer-option .result-indicator {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 9999px;
      font-size: 0.95rem;
      font-weight: 700;
      background-color: rgba(18, 56, 93, 0.08);
      color: #12385d;
      opacity: 0;
      transform: scale(0.85);
      transition: opacity 220ms ease, transform 220ms ease, background-color 220ms ease, color 220ms ease;
    }

    #question-container.showing-results .answer-option .result-indicator {
      opacity: 1;
      transform: scale(1);
    }

    .answer-option .letter-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background-color: rgba(18, 56, 93, 0.08);
      border: 1px solid rgba(18, 56, 93, 0.22);
      color: #12385d;
      font-weight: 600;
      font-size: 1.05rem;
      transition: background-color 220ms ease, border-color 220ms ease, color 220ms ease, transform 220ms ease;
    }

    .answer-option .option-leading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding-top: 4px;
    }

    .answer-option .option-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 14px;
      min-width: 0;
    }

    .answer-option .option-text {
      color: #1c1c1c;
      font-size: 1.05rem;
      line-height: 1.6;
      font-family: "Inter", sans-serif;
    }

    .answer-option .option-image {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      border: 1px solid rgba(18, 56, 93, 0.16);
      box-shadow: 0 3px 10px rgba(18, 56, 93, 0.12);
    }

    .answer-option .result-ribbon {
      font-size: 0.9rem;
      font-weight: 600;
      align-self: flex-end;
      margin-top: auto;
      color: #12385d;
      opacity: 0;
      visibility: hidden;
      transition: opacity 220ms ease;
    }

    #question-container.showing-results .result-ribbon {
      opacity: 1;
      visibility: visible;
    }

    .answer-option.result-correct .result-ribbon {
      color: #1b5e20;
    }

    .answer-option.result-incorrect .result-ribbon {
      color: #4b5563;
    }

    #question-container.results-stage .answer-option {
      pointer-events: none;
      cursor: default !important;
    }

    #question-container.showing-results .answer-option {
      transition: background-color 240ms ease, border-color 240ms ease, color 240ms ease, box-shadow 240ms ease;
    }

    .answer-option.answer-option-selected {
      border-color: #12385d;
      box-shadow: 0 0 0 3px rgba(18, 56, 93, 0.2);
    }

    .answer-option.answer-option-selected .letter-badge {
      background-color: #12385d;
      border-color: #12385d;
      color: #ffffff;
      transform: scale(1.02);
    }

    .answer-option.answer-option-selected .option-text {
      color: #12385d;
    }

    .answer-option.result-correct {
      background-color: #e8f5ec !important;
      border-color: #2e7d32 !important;
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.2);
    }

    .answer-option.result-correct .letter-badge {
      background-color: rgba(46, 125, 50, 0.18) !important;
      border-color: rgba(46, 125, 50, 0.4) !important;
      color: #1b5e20 !important;
    }

    .answer-option.result-correct .option-text {
      color: #1b5e20 !important;
    }

    .answer-option.result-correct .result-indicator {
      background-color: rgba(46, 125, 50, 0.2);
      color: #1b5e20;
    }

    .answer-option.result-incorrect {
      background-color: #f5f6f8 !important;
      border-color: rgba(17, 24, 39, 0.12) !important;
      color: #1c1c1c !important;
      box-shadow: none;
    }

    .answer-option.result-incorrect .letter-badge {
      background-color: rgba(18, 56, 93, 0.06) !important;
      border-color: rgba(18, 56, 93, 0.16) !important;
      color: #12385d !important;
    }

    .answer-option.result-incorrect .result-indicator {
      background-color: rgba(244, 67, 54, 0.12);
      color: #c62828;
    }

    .answer-option.result-incorrect.result-your-choice {
      border-color: rgba(198, 40, 40, 0.45) !important;
      box-shadow: 0 0 0 2px rgba(198, 40, 40, 0.15);
    }

    .answer-option.result-your-choice .option-text {
      color: #c62828 !important;
    }

    .prevent-select {
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    .prevent-select button,
    .prevent-select .material-symbols-outlined {
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .student-card img,
    .student-card video,
    .student-card figure {
      max-width: 100%;
      height: auto;
    }

    .veritas-modal-root {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .veritas-modal-root.is-active {
      display: flex;
    }

    .veritas-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(9, 17, 34, 0.55);
      backdrop-filter: blur(3px);
    }

    .veritas-modal-dialog {
      position: relative;
      z-index: 1;
      width: min(520px, 92vw);
      border-radius: 16px;
      background: #ffffff;
      border-top: 4px solid #c5a05a;
      box-shadow: 0 24px 48px rgba(9, 17, 34, 0.25);
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      animation: veritas-modal-in 220ms ease;
    }

    .veritas-modal-header h2 {
      margin: 0;
      font-size: 1.25rem;
      color: #12385d;
      font-weight: 700;
    }

    .veritas-modal-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
      color: #1c1c1c;
      font-size: 0.98rem;
      line-height: 1.55;
    }

    .veritas-modal-subtext {
      color: #4b5563;
      font-size: 0.85rem;
    }

    .veritas-modal-input {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .veritas-modal-input input {
      border-radius: 10px;
      border: 1px solid rgba(18, 56, 93, 0.28);
      padding: 10px 12px;
      font-size: 0.95rem;
      transition: border-color 160ms ease, box-shadow 160ms ease;
    }

    .veritas-modal-input input:focus-visible {
      outline: none;
      border-color: #12385d;
      box-shadow: 0 0 0 3px rgba(18, 56, 93, 0.2);
    }

    .veritas-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }

    .veritas-modal-button {
      border: none;
      border-radius: 999px;
      padding: 10px 22px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 140ms ease, box-shadow 140ms ease, background-color 140ms ease, color 140ms ease;
    }

    .veritas-modal-button.primary {
      background: #12385d;
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(18, 56, 93, 0.25);
    }

    .veritas-modal-button.primary:hover:not([disabled]) {
      background: #0f2d4a;
      transform: translateY(-1px);
    }

    .veritas-modal-button.secondary {
      background: transparent;
      color: #12385d;
      border: 1px solid rgba(18, 56, 93, 0.3);
    }

    .veritas-modal-button.secondary:hover:not([disabled]) {
      background: rgba(18, 56, 93, 0.08);
    }

    .veritas-modal-button.destructive {
      background: #c62828;
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(198, 40, 40, 0.25);
    }

    .veritas-modal-button.destructive:hover:not([disabled]) {
      background: #a61b1b;
    }

    .veritas-modal-button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .veritas-modal-spinner {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.6);
      border-top-color: transparent;
      animation: veritas-spin 0.7s linear infinite;
      display: none;
      margin-left: 10px;
    }

    .veritas-modal-button.loading .veritas-modal-spinner {
      display: inline-block;
    }

    .veritas-modal-button.loading span {
      opacity: 0.75;
    }

    .dark .veritas-modal-dialog {
      background: rgba(15, 23, 35, 0.96);
      color: #e2e8f0;
      border-top-color: #c5a05a;
      box-shadow: 0 24px 48px rgba(2, 6, 23, 0.55);
    }

    .dark .veritas-modal-header h2 {
      color: #f8fafc;
    }

    .dark .veritas-modal-body {
      color: #f1f5f9;
    }

    .dark .veritas-modal-subtext {
      color: #cbd5f5;
    }

    .dark .veritas-modal-input input {
      background: rgba(15, 23, 42, 0.7);
      border-color: rgba(148, 163, 184, 0.4);
      color: #f8fafc;
    }

    .dark .veritas-modal-input input:focus-visible {
      border-color: #93c5fd;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35);
    }

    .dark .veritas-modal-button.secondary {
      color: #e2e8f0;
      border-color: rgba(148, 163, 184, 0.4);
    }

    .dark .veritas-modal-button.secondary:hover:not([disabled]) {
      background: rgba(148, 163, 184, 0.16);
    }

    .dark .veritas-modal-button.primary {
      background: #234776;
    }

    .dark .veritas-modal-button.primary:hover:not([disabled]) {
      background: #1a3456;
    }

    .dark .veritas-modal-backdrop {
      background: rgba(2, 6, 23, 0.7);
      backdrop-filter: blur(4px);
    }

    body.veritas-modal-open {
      overflow: hidden;
    }

    @keyframes veritas-modal-in {
      from {
        opacity: 0;
        transform: translateY(16px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes veritas-spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 480px) {
      .student-card {
        width: min(92vw, 360px);
        margin: 24px auto;
      }

      .student-card-header {
        padding: 14px 20px 10px;
      }

      .student-card-body {
        padding: 22px 20px 8px;
      }

      .student-card-options {
        padding: 8px 20px 22px;
        gap: 16px;
      }

      .answer-option {
        flex-direction: column;
        align-items: stretch;
      }

      .answer-option .letter-badge {
        width: 40px;
        height: 40px;
      }

      .veritas-modal-dialog {
        width: min(92vw, 360px);
        padding: 22px;
        gap: 16px;
      }

      .veritas-modal-actions {
        width: 100%;
        justify-content: stretch;
      }

      .veritas-modal-button {
        flex: 1;
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Student Landing Page Animations */
    @keyframes drawLine {
      from {
        transform: scaleX(0);
      }
      to {
        transform: scaleX(1);
      }
    }

    @keyframes shimmerBg {
      0% {
        background-position: -1000px 0;
      }
      100% {
        background-position: 1000px 0;
      }
    }

    @keyframes floatParticle {
      0%, 100% {
        transform: translateY(0) translateX(0);
        opacity: 0.4;
      }
      50% {
        transform: translateY(-20px) translateX(10px);
        opacity: 0.8;
      }
    }

    @keyframes pulseDot {
      0%, 80%, 100% {
        opacity: 0.3;
        transform: scale(1);
      }
      40% {
        opacity: 1;
        transform: scale(1.2);
      }
    }

    .shimmer-particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: radial-gradient(circle, #c5a05a, transparent);
      border-radius: 50%;
      animation: floatParticle 6s ease-in-out infinite;
      pointer-events: none;
    }

    .waiting-dots .dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      margin: 0 4px;
      background: #12385d;
      border-radius: 50%;
      animation: pulseDot 1.4s ease-in-out infinite;
    }

    .waiting-dots .dot:nth-child(1) { animation-delay: 0s; }
    .waiting-dots .dot:nth-child(2) { animation-delay: 0.2s; }
    .waiting-dots .dot:nth-child(3) { animation-delay: 0.4s; }
  </style>
</head>
<body class="font-display bg-gradient-to-br from-brand-blue to-brand-accent text-white min-h-screen">
  <!-- Header - Subtle overlay style -->
  <header class="absolute top-0 left-0 right-0 z-10 flex items-center justify-between px-6 py-4">
    <div class="flex items-center gap-3">
      <img alt="Malvern Prep Logo" class="h-12 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/main/Malvern%20Logo.png"/>
      <div class="flex flex-col">
        <h1 class="text-white text-xl font-extrabold tracking-[0.15em] uppercase">Veritas</h1>
        <p class="text-white/70 text-xs tracking-wide">Live Poll</p>
      </div>
    </div>
    <div id="loader" class="loader" style="display: none;">
      <div class="h-6 w-6 animate-spin rounded-full border-2 border-white/80 border-t-transparent"></div>
    </div>
  </header>

  <main class="flex flex-col items-center justify-center min-h-screen p-6 pt-24 space-y-4">
    <div id="connectivity-banner" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-lg flex items-center gap-3 rounded-xl border border-amber-300 bg-amber-50 px-4 py-3 text-amber-800 shadow-lg transition-all duration-200 backdrop-blur-sm">
      <span id="connectivity-icon" class="material-symbols-outlined text-2xl">sync</span>
      <div class="flex flex-col text-left flex-1">
        <span id="connectivity-message" class="text-sm font-semibold">Reconnecting... your poll data is catching up.</span>
        <span id="connectivity-submessage" class="text-xs text-amber-700/80 opacity-0"></span>
      </div>
    </div>
    <!-- Entry Screen - Redesigned Landing Panel -->
    <div id="entry-screen" class="w-full max-w-4xl mx-auto text-center animate-fade-in px-6">
      <!-- Main Welcome Card -->
      <div class="bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/20 p-10 sm:p-16 relative overflow-hidden">
        <!-- Subtle shimmer background -->
        <div class="absolute inset-0 bg-gradient-to-br from-white via-gray-50 to-blue-50 opacity-60"></div>

        <div class="relative z-10">
          <!-- Welcome Message with Animated Gold Line -->
          <div class="mb-12">
            <h1 class="text-5xl sm:text-6xl font-bold mb-4" style="color: #12385d;">
              Welcome to <span style="color: #c5a05a; position: relative; display: inline-block;">
                VERITAS
                <span class="gold-underline" style="position: absolute; bottom: -8px; left: 0; right: 0; height: 3px; background: #c5a05a; transform-origin: left; animation: drawLine 0.6s ease-out forwards;"></span>
              </span>
            </h1>
            <p class="text-xl text-gray-700 mt-8 leading-relaxed max-w-2xl mx-auto">
              Get ready to respond in real time — focus up, it's your turn.
            </p>
          </div>

          <!-- Begin Button -->
          <button id="start-session-btn" class="inline-flex items-center justify-center gap-3 px-14 py-5 rounded-full text-white text-xl font-bold transition-all duration-300 shadow-xl hover:shadow-2xl hover:scale-105" style="background: #12385d; border: 2px solid #c5a05a;">
            <span class="material-symbols-outlined text-2xl">play_circle</span>
            <span>Begin Session</span>
          </button>

          <!-- Subtle Hint -->
          <p class="mt-8 text-sm text-gray-500 italic">
            Prepare to enter fullscreen mode for your session
          </p>
        </div>

        <!-- Decorative element -->
        <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-blue-100/30 to-gold-100/20 rounded-full blur-3xl -z-0"></div>
        <div class="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-tr from-gold-100/20 to-transparent rounded-full blur-2xl -z-0"></div>
      </div>
    </div>

    <!-- Student App Container -->
    <div class="w-full max-w-6xl mx-auto" id="student-container" style="display: none;">
      <div id="student-loader" class="text-center py-12 animate-fade-in" style="display: block;">
        <div class="h-16 w-16 animate-spin rounded-full border-4 border-white/30 border-t-white mx-auto mb-4"></div>
        <p class="text-white/90 text-lg">Preparing your secure session...</p>
      </div>

      <!-- Pre-Live Card - Redesigned Waiting Screen -->
      <section id="pre-live-card" class="student-card student-pre-live-card text-center animate-fade-in" style="display: none; max-width: 900px; background: white; color: #111;">
        <div class="student-card-body student-pre-live-body" style="padding: 48px 32px;">
          <!-- Animated Icon -->
          <div class="student-pre-live-icon mb-6" aria-hidden="true" style="width: 96px; height: 96px; margin: 0 auto; background: rgba(18, 56, 93, 0.08); color: #12385d; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;">
            <span class="material-symbols-outlined" style="font-size: 3.5rem;">hourglass_top</span>
          </div>

          <!-- Main Message -->
          <h2 id="pre-live-primary" class="student-stem text-4xl sm:text-5xl font-bold mb-4" style="color: #12385d;">
            Waiting for your teacher to start the poll
            <span class="waiting-dots ml-2">
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
            </span>
          </h2>

          <!-- Subtext -->
          <p id="pre-live-subline" class="student-subline text-lg max-w-2xl mx-auto mb-6" style="color: #6b7280;">
            Keep this tab open — the question will appear automatically.
          </p>

          <!-- Humorous Footer -->
          <p class="text-sm italic mt-8" style="color: #9ca3af;">
            Patience is a virtue (and a graded skill).
          </p>

          <!-- Optional Shimmer Particles -->
          <div class="shimmer-particle" style="top: 20%; left: 15%; animation-delay: 0s;"></div>
          <div class="shimmer-particle" style="top: 60%; right: 20%; animation-delay: 2s;"></div>
          <div class="shimmer-particle" style="bottom: 30%; left: 25%; animation-delay: 4s;"></div>
        </div>

        <!-- Status Footer -->
        <div class="student-card-options student-pre-live-footer" style="background: rgba(18, 56, 93, 0.04); padding: 20px 32px; border-top: 1px solid rgba(18, 56, 93, 0.1);">
          <div class="student-pre-live-status" style="color: #12385d;">
            <span class="student-pre-live-label font-bold">PRE-LIVE</span>
            <span class="student-pre-live-pips" aria-hidden="true">
              <span class="pip" style="animation-delay: 0s; background: #12385d;"></span>
              <span class="pip" style="animation-delay: 0.2s; background: #12385d;"></span>
              <span class="pip" style="animation-delay: 0.4s; background: #12385d;"></span>
            </span>
          </div>
          <p id="pre-live-reconnect-line" class="student-pre-live-reconnect hidden" style="color: #12385d;">
            Reconnecting… syncing you back into place.
          </p>
        </div>
      </section>

      <!-- Status Container -->
      <div id="status-container" class="text-center py-12 animate-fade-in" style="display: none;">
        <div class="bg-black/20 backdrop-blur-lg rounded-xl border border-white/10 p-8 sm:p-12 shadow-2xl max-w-3xl mx-auto">
          <span class="material-symbols-outlined text-6xl text-white mb-4 inline-block">schedule</span>
          <h2 id="status-message" class="text-white text-2xl font-semibold">Connecting to poll...</h2>
          <p id="status-submessage" class="text-white/70 text-lg mt-4" style="display: none;"></p>
          <div id="resume-controls" class="mt-8 space-y-3" style="display: none;">
            <p class="text-white/90 text-base leading-relaxed">
              Click below to return to fullscreen and resume the poll.
            </p>
            <button id="resume-session-btn" class="mx-auto flex items-center justify-center gap-2 px-8 py-4 rounded-lg bg-green-500 text-white text-lg font-bold hover:bg-green-600 transition-transform duration-300 hover:scale-105 shadow-lg">
              <span class="material-symbols-outlined text-xl">fullscreen</span>
              <span>Resume Poll</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Question Container -->
      <section id="question-container" class="student-card prevent-select animate-fade-in" aria-live="polite" style="display: none;">
        <div class="student-card-header">
          <p id="question-number" class="student-question-number"></p>
        </div>
        <div id="question-content" class="student-card-body">
          <img id="question-image" src="" alt="Question" class="student-question-image" referrerpolicy="no-referrer" onerror="this.style.display='none';" style="display: none;" />
          <h2 id="question-text" class="student-stem"></h2>
          <p id="question-subline" class="student-subline hidden"></p>
        </div>
        <div class="student-card-options">
          <p id="no-responses-message" class="student-no-responses hidden"></p>
          <ul id="options-list" class="student-choices"></ul>
        </div>
      </section>
    </div>
  </main>

  <script>
    (function() {
        console.log('Student poll script initializing...');
        var studentLoader = document.getElementById('student-loader');
        var preLiveCard = document.getElementById('pre-live-card');
        var statusContainer = document.getElementById('status-container');
        var statusMessage = document.getElementById('status-message');
        var questionContainer = document.getElementById('question-container');
        var optionsList = document.getElementById('options-list');
        var questionNumberEl = document.getElementById('question-number');
        var questionTextEl = document.getElementById('question-text');
        var questionImageEl = document.getElementById('question-image');
        var questionSublineEl = document.getElementById('question-subline');
        var noResponsesMessageEl = document.getElementById('no-responses-message');
        var entryScreen = document.getElementById('entry-screen');
        var startSessionBtn = document.getElementById('start-session-btn');
        var studentContainer = document.getElementById('student-container');
        var preLivePrimary = document.getElementById('pre-live-primary');
        var preLiveSubline = document.getElementById('pre-live-subline');
        var preLiveReconnectLine = document.getElementById('pre-live-reconnect-line');

        console.log('Start session button found:', startSessionBtn ? 'YES' : 'NO');
        console.log('Entry screen found:', entryScreen ? 'YES' : 'NO');
        var resumeControls = document.getElementById('resume-controls');
        var resumeSessionBtn = document.getElementById('resume-session-btn');
        var statusSubMessage = document.getElementById('status-submessage');
        var connectivityBanner = document.getElementById('connectivity-banner');
        var connectivityIcon = document.getElementById('connectivity-icon');
        var connectivityMessage = document.getElementById('connectivity-message');
        var connectivitySubMessage = document.getElementById('connectivity-submessage');

        var currentPollState = {};
        var lastUnlockedState = null;
        var pollTimerId = null;
        var defaultPollInterval = 2500;
        var maxPollInterval = 12000;
        var pollFailureCount = 0;
        var proctorPollInterval = null;
        var isInteractionBlocked = false;
        var currentLockVersion = 0;
        var hasAnsweredCurrent = false;
        var violationLogged = false;
        var violationDebounceTimer = null;
        var pendingSubmission = false;
        var currentQuestionKey = null;
        var lastStateVersion = null;
        var lastSuccessfulPollAt = 0;
        var pollInFlight = false;
        var recoveringFromOutage = false;
        var connectivityHideTimer = null;
        var lastAdvisedInterval = defaultPollInterval;
        var optionBaseClass = 'answer-option relative w-full text-left';
        var optionSelectedClass = optionBaseClass + ' answer-option-selected';
        var optionDisabledClass = optionBaseClass + ' answer-option-disabled';

        var VeritasModal = null;
        var veritasModalReady = new Promise(function(resolve) {
            function initializeModal() {
                VeritasModal = window.VeritasModal || createVeritasModal();
                window.VeritasModal = VeritasModal;
                resolve(VeritasModal);
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeModal, { once: true });
            } else {
                initializeModal();
            }
        });

        function withVeritasModal(callback) {
            return veritasModalReady.then(function(controller) {
                return callback(controller);
            });
        }

        function veritasAlert(message, options) {
            return withVeritasModal(function(modal) {
                return modal.alert(Object.assign({ message: message }, options || {}));
            });
        }

        function veritasConfirm(message, options) {
            return withVeritasModal(function(modal) {
                return modal.confirm(Object.assign({ message: message }, options || {}));
            });
        }

        function veritasPrompt(message, options) {
            return withVeritasModal(function(modal) {
                return modal.prompt(Object.assign({ message: message }, options || {}));
            });
        }

        function ensureVeritasModalRoot() {
            var existing = document.getElementById('veritas-modal-root');
            if (existing) {
                return existing;
            }

            var root = document.createElement('div');
            root.id = 'veritas-modal-root';
            root.className = 'veritas-modal-root';
            root.setAttribute('aria-hidden', 'true');
            root.innerHTML = '' +
                '<div class="veritas-modal-backdrop"></div>' +
                '<div class="veritas-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="veritas-modal-title" aria-describedby="veritas-modal-message">' +
                    '<div class="veritas-modal-header">' +
                        '<h2 id="veritas-modal-title">Notice</h2>' +
                    '</div>' +
                    '<div class="veritas-modal-body">' +
                        '<p id="veritas-modal-message"></p>' +
                        '<div id="veritas-modal-subtext" class="veritas-modal-subtext"></div>' +
                        '<div id="veritas-modal-input" class="veritas-modal-input" style="display: none;">' +
                            '<label for="veritas-modal-input-field" class="sr-only">Input</label>' +
                            '<input id="veritas-modal-input-field" type="text" autocomplete="off" />' +
                        '</div>' +
                    '</div>' +
                    '<div class="veritas-modal-actions">' +
                        '<button type="button" class="veritas-modal-button secondary" data-action="cancel">Cancel</button>' +
                        '<button type="button" class="veritas-modal-button primary" data-action="confirm">' +
                            '<span class="veritas-modal-spinner" aria-hidden="true"></span>' +
                            '<span>Confirm</span>' +
                        '</button>' +
                    '</div>' +
                '</div>';

            (document.body || document.documentElement).appendChild(root);
            return root;
        }

        function createVeritasModal() {
            var root = ensureVeritasModalRoot();

            var dialog = root.querySelector('.veritas-modal-dialog');
            var titleEl = root.querySelector('#veritas-modal-title');
            var messageEl = root.querySelector('#veritas-modal-message');
            var subtextEl = root.querySelector('#veritas-modal-subtext');
            var inputWrap = root.querySelector('#veritas-modal-input');
            var inputField = root.querySelector('#veritas-modal-input-field');
            var confirmBtn = root.querySelector('[data-action="confirm"]');
            var cancelBtn = root.querySelector('[data-action="cancel"]');
            var confirmLabel = confirmBtn.querySelector('span:not(.veritas-modal-spinner)');
            var active = false;
            var currentConfig = null;
            var resolveFn = null;
            var previousFocus = null;
            var allowEscape = true;
            var hiddenNodes = [];

            function toggleBackground(state) {
                var siblings = [].slice.call(document.body.children);
                if (state) {
                    hiddenNodes = [];
                    siblings.forEach(function(node) {
                        if (node === root) return;
                        hiddenNodes.push({
                            node: node,
                            ariaHidden: node.getAttribute('aria-hidden'),
                            inert: ('inert' in node) ? node.inert : null
                        });
                        node.setAttribute('aria-hidden', 'true');
                        if ('inert' in node) {
                            node.inert = true;
                        }
                    });
                } else {
                    hiddenNodes.forEach(function(record) {
                        if (record.ariaHidden === null) {
                            record.node.removeAttribute('aria-hidden');
                        } else {
                            record.node.setAttribute('aria-hidden', record.ariaHidden);
                        }
                        if ('inert' in record.node) {
                            if (record.inert !== null) {
                                record.node.inert = record.inert;
                            } else {
                                record.node.inert = false;
                            }
                        }
                    });
                    hiddenNodes = [];
                }
            }

            function setPending(state) {
                if (state) {
                    confirmBtn.classList.add('loading');
                    confirmBtn.setAttribute('disabled', 'disabled');
                    if (cancelBtn.style.display !== 'none') {
                        cancelBtn.setAttribute('disabled', 'disabled');
                    }
                } else {
                    confirmBtn.classList.remove('loading');
                    confirmBtn.removeAttribute('disabled');
                    cancelBtn.removeAttribute('disabled');
                }
            }

            function getFocusable() {
                var selectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
                var nodes = [].slice.call(dialog.querySelectorAll(selectors));
                return nodes.filter(function(node) {
                    return !node.hasAttribute('disabled') && node.offsetParent !== null;
                });
            }

            function focusFirst() {
                var focusable = getFocusable();
                if (focusable.length > 0) {
                    focusable[0].focus();
                } else {
                    dialog.focus();
                }
            }

            function trapKey(event) {
                if (!active) return;
                if (event.key === 'Escape') {
                    if (!allowEscape) return;
                    event.preventDefault();
                    handleCancel();
                } else if (event.key === 'Tab') {
                    var focusable = getFocusable();
                    if (focusable.length === 0) {
                        event.preventDefault();
                        return;
                    }
                    var index = focusable.indexOf(document.activeElement);
                    if (event.shiftKey) {
                        if (index <= 0) {
                            focusable[focusable.length - 1].focus();
                            event.preventDefault();
                        }
                    } else {
                        if (index === focusable.length - 1) {
                            focusable[0].focus();
                            event.preventDefault();
                        }
                    }
                } else if (event.key === 'Enter' && currentConfig && currentConfig.mode === 'prompt') {
                    if (document.activeElement === inputField) {
                        event.preventDefault();
                        handleConfirm();
                    }
                }
            }

            function enforceFocus(event) {
                if (!active) return;
                if (!dialog.contains(event.target)) {
                    event.stopPropagation();
                    focusFirst();
                }
            }

            function closeModal(result) {
                active = false;
                root.classList.remove('is-active');
                root.setAttribute('aria-hidden', 'true');
                document.body.classList.remove('veritas-modal-open');
                root.removeEventListener('keydown', trapKey, true);
                document.removeEventListener('focus', enforceFocus, true);
                toggleBackground(false);
                setPending(false);
                if (previousFocus && typeof previousFocus.focus === 'function') {
                    setTimeout(function() { previousFocus.focus(); }, 0);
                }
                if (resolveFn) {
                    resolveFn(result);
                }
                currentConfig = null;
                resolveFn = null;
            }

            function handleConfirm() {
                if (!active) return;
                setPending(true);
                var mode = currentConfig ? currentConfig.mode : 'alert';
                var result;
                if (mode === 'prompt') {
                    result = inputField.value;
                } else if (mode === 'confirm') {
                    result = true;
                }
                closeModal(result);
            }

            function handleCancel() {
                if (!active) return;
                var mode = currentConfig ? currentConfig.mode : 'alert';
                if (mode === 'alert') {
                    closeModal(undefined);
                    return;
                }
                if (mode === 'confirm') {
                    closeModal(false);
                } else if (mode === 'prompt') {
                    closeModal(null);
                }
            }

            function openModal(mode, options) {
                options = options || {};
                currentConfig = Object.assign({}, options, { mode: mode });
                allowEscape = options.allowEscape !== false;
                titleEl.textContent = options.title || (mode === 'confirm' ? 'Please Confirm' : (mode === 'prompt' ? 'Enter Response' : 'Notice'));
                if (options.html) {
                    messageEl.innerHTML = options.html;
                } else {
                    messageEl.textContent = options.message || '';
                }
                if (options.subtext) {
                    subtextEl.style.display = 'block';
                    subtextEl.textContent = options.subtext;
                } else {
                    subtextEl.style.display = 'none';
                    subtextEl.textContent = '';
                }
                if (mode === 'prompt') {
                    inputWrap.style.display = 'flex';
                    inputField.value = options.defaultValue || '';
                    if (options.placeholder) {
                        inputField.placeholder = options.placeholder;
                    } else {
                        inputField.removeAttribute('placeholder');
                    }
                } else {
                    inputWrap.style.display = 'none';
                    inputField.value = '';
                    inputField.removeAttribute('placeholder');
                }
                confirmLabel.textContent = options.confirmText || (mode === 'confirm' ? 'Confirm' : (mode === 'prompt' ? 'Submit' : 'OK'));
                if (options.destructive) {
                    confirmBtn.classList.add('destructive');
                } else {
                    confirmBtn.classList.remove('destructive');
                }
                cancelBtn.style.display = mode === 'alert' ? 'none' : 'inline-flex';
                cancelBtn.textContent = options.cancelText || 'Cancel';
                setPending(false);
                previousFocus = document.activeElement;
                root.classList.add('is-active');
                root.setAttribute('aria-hidden', 'false');
                document.body.classList.add('veritas-modal-open');
                toggleBackground(true);
                active = true;
                root.addEventListener('keydown', trapKey, true);
                document.addEventListener('focus', enforceFocus, true);

                return new Promise(function(resolve) {
                    resolveFn = resolve;
                    setTimeout(function() {
                        if (mode === 'prompt') {
                            inputField.focus();
                            inputField.select();
                        } else if (mode === 'confirm' && options.focusCancel) {
                            cancelBtn.focus();
                        } else {
                            confirmBtn.focus();
                        }
                    }, 0);
                });
            }

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
            root.addEventListener('click', function(event) {
                if (event.target === root || event.target.classList.contains('veritas-modal-backdrop')) {
                    if (!currentConfig || currentConfig.allowBackdropClose === false) {
                        return;
                    }
                    handleCancel();
                }
            });

            return {
                alert: function(options) {
                    return openModal('alert', options).then(function() { return; });
                },
                confirm: function(options) {
                    return openModal('confirm', options).then(function(result) { return result !== false; });
                },
                prompt: function(options) {
                    return openModal('prompt', options).then(function(result) { return result; });
                }
            };
        }
        var currentOptionLayout = [];

        var connectivityThemes = {
            connecting: ['border-amber-300', 'bg-amber-50', 'text-amber-800', 'dark:border-amber-500', 'dark:bg-amber-900/20', 'dark:text-amber-100'],
            offline: ['border-red-300', 'bg-red-50', 'text-red-800', 'dark:border-red-600', 'dark:bg-red-900/20', 'dark:text-red-200'],
            recovered: ['border-green-300', 'bg-green-50', 'text-green-800', 'dark:border-green-600', 'dark:bg-green-900/20', 'dark:text-green-100']
        };
        var allConnectivityClasses = connectivityThemes.connecting.concat(connectivityThemes.offline, connectivityThemes.recovered);

        function isPreLiveVisible() {
            return preLiveCard && preLiveCard.style.display !== 'none';
        }

        function setPreLiveReconnectMessage(text) {
            // Disabled for student view - students don't need to see sync notifications
            return;
        }

        function applyConnectivityTheme(theme) {
            if (!connectivityBanner) return;
            for (var i = 0; i < allConnectivityClasses.length; i++) {
                connectivityBanner.classList.remove(allConnectivityClasses[i]);
            }
            var themeClasses = connectivityThemes[theme] || connectivityThemes.connecting;
            for (var j = 0; j < themeClasses.length; j++) {
                connectivityBanner.classList.add(themeClasses[j]);
            }
        }

        function showConnectivityState(state, options) {
            // Disabled for student view - students don't need to see sync notifications
            // Background sync continues to work normally
            return;
        }

        function hideConnectivityBanner() {
            if (!connectivityBanner) return;
            clearTimeout(connectivityHideTimer);
            connectivityBanner.classList.add('hidden');
            if (connectivitySubMessage) {
                connectivitySubMessage.textContent = '';
                connectivitySubMessage.classList.remove('opacity-0');
            }
            setPreLiveReconnectMessage('');
        }

        function stopPolling() {
            if (pollTimerId) {
                clearTimeout(pollTimerId);
                pollTimerId = null;
            }
            pollInFlight = false;
        }

        function scheduleNextPoll(delay) {
            if (isInteractionBlocked) return;
            stopPolling();
            var boundedDelay = Math.min(maxPollInterval, Math.max(1000, delay));
            var jitter = Math.random() * 0.15 * boundedDelay;
            pollTimerId = setTimeout(function() {
                pollTimerId = null;
                pollForStatus();
            }, boundedDelay + jitter);
        }

        function startPolling(immediate) {
            pollFailureCount = 0;
            recoveringFromOutage = false;
            if (immediate) {
                stopPolling();
                pollForStatus(true);
            } else {
                scheduleNextPoll(defaultPollInterval);
            }
        }

        function handlePostPollSuccess(data, hadFailures) {
            if (typeof data.stateVersion === 'number') {
                lastStateVersion = data.stateVersion;
            }
            if (typeof data.advisedPollIntervalMs === 'number') {
                lastAdvisedInterval = data.advisedPollIntervalMs;
            } else {
                lastAdvisedInterval = defaultPollInterval;
            }

            if (hadFailures || data.connectionHealth === 'RECOVERED_AFTER_OUTAGE') {
                showConnectivityState('recovered', {
                    message: 'Back on track - synced with your teacher.',
                    icon: 'cloud_done',
                    autoHide: 2400
                });
            } else if (data.connectionHealth === 'RECOVERING') {
                hideConnectivityBanner();
                if (isPreLiveVisible()) {
                    setPreLiveReconnectMessage('Syncing back up — we will take off in a moment.');
                }
            } else if (!recoveringFromOutage && !hadFailures) {
                hideConnectivityBanner();
            }

            updateStudentView(data);
            var delay = Math.max(1200, Math.min(maxPollInterval, lastAdvisedInterval));
            scheduleNextPoll(delay);
        }

        function handlePollingFailure(error) {
            var messageText = (error && error.message) ? error.message : (typeof error === 'string' ? error : '');
            if (messageText && /Authentication|not enrolled|Invalid link/i.test(messageText)) {
                stopPolling();
                handleError(error);
                return;
            }

            recoveringFromOutage = true;
            var backoffMultiplier = Math.pow(1.6, Math.max(1, pollFailureCount));
            var retryDelay = Math.min(maxPollInterval, Math.round((lastAdvisedInterval || defaultPollInterval) * backoffMultiplier));
            var seconds = Math.max(1, Math.round(retryDelay / 1000));

            var online = typeof navigator !== 'undefined' ? navigator.onLine : true;
            showConnectivityState(online ? 'connecting' : 'offline', {
                message: online ? 'Reconnecting... your poll data is catching up.' : 'Offline detected - we will hold your spot and resync when you are back.',
                icon: online ? 'sync_problem' : 'signal_wifi_off',
                submessage: online ? ('Retrying in ' + seconds + 's...') : '',
                preLiveMessage: online ? 'Reconnecting… syncing you back into place.' : 'Offline detected — we will hold your spot and sync when you are back.'
            });

            scheduleNextPoll(retryDelay);
        }

        function pollForStatus() {
            if (isInteractionBlocked || pollInFlight) return;
            pollInFlight = true;
            var context = {
                lastStateVersion: lastStateVersion,
                lastSuccessAt: lastSuccessfulPollAt,
                failureCount: pollFailureCount,
                advisedInterval: lastAdvisedInterval
            };

            google.script.run
                .withSuccessHandler(function(data) {
                    pollInFlight = false;
                    var hadFailures = pollFailureCount > 0 || recoveringFromOutage;
                    pollFailureCount = 0;
                    recoveringFromOutage = false;
                    lastSuccessfulPollAt = Date.now();
                    handlePostPollSuccess(data || {}, hadFailures);
                })
                .withFailureHandler(function(error) {
                    pollInFlight = false;
                    pollFailureCount += 1;
                    console.error('Polling error', error);
                    handlePollingFailure(error);
                })
                .getStudentPollStatus(SESSION_TOKEN, context);
        }

        function isSessionActive() {
            return studentContainer && studentContainer.style.display !== 'none' && entryScreen && entryScreen.style.display === 'none';
        }

        window.addEventListener('offline', function() {
            if (!isSessionActive()) return;
            recoveringFromOutage = true;
            showConnectivityState('offline', {
                message: 'Offline detected - we will hold your spot and resync when you are back.',
                icon: 'signal_wifi_off'
            });
        });

        window.addEventListener('online', function() {
            if (!isSessionActive()) return;
            showConnectivityState('connecting', {
                message: 'Reconnecting... your poll data is catching up.',
                icon: 'sync',
                submessage: 'Syncing now...'
            });
            startPolling(true);
        });

        if (resumeSessionBtn) {
            resumeSessionBtn.onclick = function() {
                console.log('Resume button clicked - attempting fullscreen');
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen()
                        .then(function() {
                            console.log('Fullscreen entered - confirming with server');
                            // Call studentConfirmFullscreen with the current lockVersion
                            google.script.run
                                .withSuccessHandler(function(response) {
                                    if (response.success && response.status === 'OK') {
                                        console.log('Server confirmed unlock - resuming poll');
                                        isInteractionBlocked = false;
                                        violationLogged = false;
                                        if (proctorPollInterval) {
                                            clearInterval(proctorPollInterval);
                                            proctorPollInterval = null;
                                        }
                                        if (resumeControls) {
                                            resumeControls.style.display = 'none';
                                        }
                                        hideConnectivityBanner();
                                        startPolling(true);
                                        if (lastUnlockedState && lastUnlockedState.status && lastUnlockedState.status !== 'LOCKED' && lastUnlockedState.status !== 'AWAITING_FULLSCREEN') {
                                            updateStudentView(lastUnlockedState);
                                        }
                                    } else {
                                        console.error('Failed to confirm fullscreen:', response);
                                        statusMessage.textContent = 'Failed to resume. Please try again.';
                                    }
                                })
                                .withFailureHandler(function(error) {
                                    console.error('Error confirming fullscreen:', error);
                                    statusMessage.textContent = 'Error resuming session.';
                                })
                                .studentConfirmFullscreen(currentLockVersion, SESSION_TOKEN);
                        })
                        .catch(function(e) {
                            console.warn('Fullscreen denied on resume:', e);
                            statusMessage.textContent = 'Fullscreen is required. Please allow fullscreen and try again.';
                        });
                }
            };
        }

        if (startSessionBtn) {
            console.log('Attaching onclick handler to start session button');
            startSessionBtn.onclick = function() {
                console.log('!!! BEGIN SESSION BUTTON CLICKED !!!');
                console.log('Hiding entry screen, showing student container');
                entryScreen.style.display = 'none';
                studentContainer.style.display = 'block';
                isInteractionBlocked = false;
                violationLogged = false;
                if (resumeControls) {
                    resumeControls.style.display = 'none';
                }

                try {
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen().catch(function(e) {
                            console.warn('Fullscreen denied:', e);
                        });
                    }
                } catch (e) {
                    console.error('Fullscreen error:', e);
                }

                function reportViolationDebounced(reason) {
                    // Clear any existing timer
                    if (violationDebounceTimer) {
                        clearTimeout(violationDebounceTimer);
                    }

                    // Set a new timer for 300ms
                    violationDebounceTimer = setTimeout(function() {
                        // Check if already reported to prevent duplicates
                        if (violationLogged || isInteractionBlocked) {
                            console.log('Violation already reported, skipping');
                            return;
                        }

                        console.log('VIOLATION: ' + reason);
                        // Set flags BEFORE RPC to prevent retry-based double-bump
                        violationLogged = true;
                        isInteractionBlocked = true;

                        google.script.run
                            .withSuccessHandler(function(response) {
                                if (response.success) {
                                    currentLockVersion = response.lockVersion;
                                    showLockedMessage();
                                    startProctorPolling();
                                }
                            })
                            .withFailureHandler(function(error) {
                                console.error('Violation report failed:', error);
                                // Keep flags set - student stays locked locally even if server unreachable
                                showLockedMessage();
                            })
                            .reportStudentViolation(reason, SESSION_TOKEN);
                    }, 300);
                }

                document.addEventListener('visibilitychange', function() {
                    if (document.hidden && !isInteractionBlocked && !violationLogged) {
                        reportViolationDebounced('tab-blur');
                    }
                });

                document.addEventListener('fullscreenchange', function() {
                    if (!document.fullscreenElement && !isInteractionBlocked && !violationLogged) {
                        reportViolationDebounced('exit-fullscreen');
                    }
                });

                hideConnectivityBanner();
                startPolling(true);
            };
        } else {
            console.error('Start session button not found!');
        }

        function startProctorPolling() {
            stopPolling();
            if (proctorPollInterval) {
                clearInterval(proctorPollInterval);
            }
            proctorPollInterval = setInterval(checkProctorState, 2500);
            checkProctorState();
        }

        function checkProctorState() {
            google.script.run
                .withSuccessHandler(function(response) {
                    if (!response.success) {
                        console.error('Proctor state check failed:', response.error);
                        return;
                    }

                    // Check if status is AWAITING_FULLSCREEN and lockVersion matches
                    if (response.status === 'AWAITING_FULLSCREEN' && response.lockVersion === currentLockVersion) {
                        if (proctorPollInterval) {
                            clearInterval(proctorPollInterval);
                            proctorPollInterval = null;
                        }
                        showResumePrompt();
                    } else if (response.status === 'LOCKED' && response.lockVersion !== currentLockVersion) {
                        // New violation or version mismatch - update lockVersion
                        currentLockVersion = response.lockVersion;
                        showLockedMessage();
                    } else if (response.status === 'OK') {
                        // Unlocked - resume normal polling
                        if (proctorPollInterval) {
                            clearInterval(proctorPollInterval);
                            proctorPollInterval = null;
                        }
                        isInteractionBlocked = false;
                        violationLogged = false;
                        hideConnectivityBanner();
                        startPolling(true);
                        if (lastUnlockedState && lastUnlockedState.status && lastUnlockedState.status !== 'LOCKED' && lastUnlockedState.status !== 'AWAITING_FULLSCREEN') {
                            updateStudentView(lastUnlockedState);
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Proctor state check error:', error);
                })
                .getStudentProctorState(SESSION_TOKEN);
        }

        function updateStudentView(data) {
            data = data || {};
            console.log('Status update:', data.status);
            if (studentLoader) studentLoader.style.display = 'none';

            if (statusSubMessage) {
                statusSubMessage.style.display = 'none';
                statusSubMessage.textContent = '';
            }
            setPreLiveReconnectMessage('');

            currentPollState = data || {};

            if (data.status === 'LOCKED' || data.status === 'AWAITING_FULLSCREEN') {
                console.log('Server confirmed lock status on page load:', data.status);
                isInteractionBlocked = true;
                google.script.run
                    .withSuccessHandler(function(proctorResponse) {
                        if (proctorResponse.success) {
                            currentLockVersion = proctorResponse.lockVersion;
                            if (proctorResponse.status === 'AWAITING_FULLSCREEN') {
                                showResumePrompt();
                            } else if (proctorResponse.status === 'LOCKED') {
                                showLockedMessage();
                                startProctorPolling();
                            }
                        }
                    })
                    .withFailureHandler(handleError)
                    .getStudentProctorState(SESSION_TOKEN);
                return;
            }

            if (preLiveCard) {
                preLiveCard.style.display = 'none';
            }

            if (data.status !== 'LOCKED' && data.status !== 'AWAITING_FULLSCREEN') {
                lastUnlockedState = data;
            }

            if (resumeControls) {
                resumeControls.style.display = 'none';
            }

            if (data.status === 'PRE_LIVE') {
                hasAnsweredCurrent = false;
                pendingSubmission = false;
                currentQuestionKey = null;
                questionContainer.style.display = 'none';
                if (statusContainer) {
                    statusContainer.style.display = 'none';
                }
                if (preLiveCard) {
                    preLiveCard.style.display = 'block';
                    if (preLivePrimary) {
                        preLivePrimary.textContent = data.message || 'Waiting for your teacher to begin the poll...';
                    }
                    if (preLiveSubline) {
                        preLiveSubline.textContent = 'This page will update automatically.';
                        preLiveSubline.style.display = 'block';
                        preLiveSubline.classList.remove('hidden');
                    }
                } else {
                    statusContainer.style.display = 'block';
                    statusMessage.textContent = data.message || 'Waiting for your teacher to begin the poll...';
                    statusMessage.className = 'text-white text-2xl font-semibold';
                    if (statusSubMessage) {
                        statusSubMessage.textContent = 'This page will update automatically.';
                        statusSubMessage.style.display = 'block';
                        statusSubMessage.className = 'text-white/60 text-base mt-4';
                    }
                }
                return;
            }

            if (data.status === 'LIVE' && typeof data.questionIndex === 'number' && data.questionIndex >= 0) {
                resetResultDecorations();
                lastUnlockedState = data;
                var resetTimestamp = (data.metadata && data.metadata.resetAt) ? data.metadata.resetAt : '';
                var questionKey = data.pollId + ':' + data.questionIndex + ':' + resetTimestamp;
                var isNewQuestion = questionKey !== currentQuestionKey;

                if (isNewQuestion) {
                    currentQuestionKey = questionKey;
                    hasAnsweredCurrent = !!data.hasSubmitted;
                    pendingSubmission = false;
                    currentPollState = data;
                    statusContainer.style.display = hasAnsweredCurrent ? 'block' : 'none';
                    questionContainer.style.display = hasAnsweredCurrent ? 'none' : 'block';

                    var qNum = (data.questionIndex || 0) + 1;
                    var qTotal = data.totalQuestions || '?';
                    if (questionNumberEl) {
                        questionNumberEl.textContent = 'Question ' + qNum + ' of ' + qTotal;
                    }

                    if (questionTextEl) {
                        questionTextEl.textContent = data.questionText || '';
                    }

                    if (questionSublineEl) {
                        questionSublineEl.classList.add('hidden');
                        questionSublineEl.textContent = '';
                    }

                    if (questionImageEl) {
                        if (data.questionImageURL) {
                            questionImageEl.src = data.questionImageURL;
                            questionImageEl.style.display = 'block';
                        } else {
                            questionImageEl.style.display = 'none';
                        }
                    }

                    if (noResponsesMessageEl) {
                        noResponsesMessageEl.classList.add('hidden');
                        noResponsesMessageEl.textContent = '';
                    }

                    optionsList.innerHTML = "";
                    var shuffled = shuffle(data.options || []);
                    var letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

                    // DEBUG: Log what we received
                    console.log('=== STUDENT RECEIVED DATA ===');
                    console.log('questionImageURL:', data.questionImageURL);
                    console.log('options:', data.options);
                    if (data.options && data.options.length > 0) {
                        data.options.forEach(function(opt, idx) {
                            console.log('  Option ' + idx + ':', 'text="' + opt.text + '", imageURL=' + opt.imageURL);
                        });
                    }

                    currentOptionLayout = [];
                    shuffled.forEach(function(option, index) {
                        var letter = letters[index] || (index + 1).toString();
                        var btn = createOptionButton(option, letter, data.pollId, data.questionIndex);
                        var listItem = document.createElement('li');
                        listItem.appendChild(btn);
                        optionsList.appendChild(listItem);
                        currentOptionLayout.push({
                            text: option.text || '',
                            imageURL: option.imageURL || ''
                        });
                    });
                }

                if (pendingSubmission && !data.hasSubmitted) {
                    return;
                }

                if (data.hasSubmitted) {
                    hasAnsweredCurrent = true;
                    pendingSubmission = false;
                }

                if (hasAnsweredCurrent) {
                    questionContainer.style.display = 'none';
                    statusContainer.style.display = 'block';
                    statusMessage.textContent = data.hasSubmitted ? (data.message || 'Answer received - nice work.') : 'Answer received - nice work.';
                    statusMessage.className = 'text-green-300 text-2xl font-semibold';
                    if (statusSubMessage) {
                        statusSubMessage.textContent = 'Your teacher will reveal the answer shortly...';
                        statusSubMessage.style.display = 'block';
                        statusSubMessage.className = 'text-white/70 text-lg mt-4';
                    }
                    var iconEl = statusContainer.querySelector('.material-symbols-outlined');
                    if (iconEl) {
                        iconEl.textContent = 'check_circle';
                        iconEl.className = 'material-symbols-outlined text-6xl text-green-300 mb-4 inline-block';
                    }
                } else {
                    questionContainer.style.display = 'block';
                    statusContainer.style.display = 'none';
                }
                return;
            }

            if (data.status === 'RESULTS_HOLD' || data.status === 'RESULTS_REVEALED') {
                renderResultsStage(data);
                return;
            }

            // Non-live states
            resetResultDecorations();
            questionContainer.style.display = 'none';
            pendingSubmission = false;
            if (data.status !== 'PRE_LIVE') {
                hasAnsweredCurrent = !!data.hasSubmitted;
            } else {
                currentPollState = {};
                questionContainer.style.display = 'none';
                if (preLiveCard) {
                    preLiveCard.style.display = 'none';
                }
                statusContainer.style.display = 'block';
                var statusIcon = 'schedule';
                var statusClass = 'text-white';
                var statusTextClass = 'text-white text-2xl font-semibold';

                if (data.status === 'PRE_LIVE') {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || 'Waiting for your teacher to begin the poll...';
                    statusIcon = 'schedule';
                    statusClass = 'text-white';
                    if (statusSubMessage) {
                        statusSubMessage.textContent = 'This page will update automatically.';
                        statusSubMessage.style.display = 'block';
                        statusSubMessage.className = 'text-white/60 text-base mt-4';
                    }
                } else if (data.status === 'PAUSED') {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || 'Intermission! Your teacher’s cooking up the next one.';
                    statusIcon = 'hourglass_top';
                    statusClass = 'text-white';
                    if (statusSubMessage) {
                        statusSubMessage.style.display = 'none';
                        statusSubMessage.textContent = '';
                    }
                } else if (data.status === 'ENDED') {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || 'That’s a wrap! You just finished the poll — nicely done.';
                    statusIcon = 'emoji_events';
                    statusClass = 'text-yellow-300';
                    if (statusSubMessage) {
                        statusSubMessage.style.display = 'none';
                        statusSubMessage.textContent = '';
                    }
                } else if (data.status === 'NOT_ENROLLED') {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || "You are not enrolled.";
                    statusTextClass = 'text-red-300 text-2xl font-bold';
                    statusIcon = 'error';
                    statusClass = 'text-red-300';
                    if (statusSubMessage) {
                        statusSubMessage.style.display = 'none';
                        statusSubMessage.textContent = '';
                    }
                    stopPolling();
                } else if (data.status === 'ERROR') {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || "We hit a snag. Try again soon.";
                    statusTextClass = 'text-red-300 text-2xl font-bold';
                    statusIcon = 'error';
                    statusClass = 'text-red-300';
                    if (statusSubMessage) {
                        statusSubMessage.style.display = 'none';
                        statusSubMessage.textContent = '';
                    }
                } else {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || 'Hang tight — your teacher’s loading the next challenge.';
                    statusIcon = 'hourglass_top';
                    statusClass = 'text-white';
                    if (statusSubMessage) {
                        statusSubMessage.style.display = 'none';
                        statusSubMessage.textContent = '';
                    }
                }
                if (preLivePrimary) {
                    preLivePrimary.textContent = data.message || 'Showtime is moments away.';
                }
                if (preLiveSubline) {
                    preLiveSubline.textContent = data.submessage || 'Your teacher is lining up the first challenge now — stay focused and we’ll launch together.';
                }
                return;
            }

            if (preLiveCard) {
                preLiveCard.style.display = 'none';
            }

            statusContainer.style.display = 'block';
            var statusIcon = 'schedule';
            var statusClass = 'text-white';
            var statusTextClass = 'text-white text-2xl font-semibold';

            if (data.status === 'PAUSED') {
                statusMessage.textContent = data.message || 'Poll is paused for a quick breather.';
                statusIcon = 'pause_circle';
                statusClass = 'text-white';
                if (statusSubMessage) {
                    statusSubMessage.textContent = data.submessage || 'Stay ready — we will resume as soon as your teacher unlocks the next prompt.';
                    statusSubMessage.style.display = 'block';
                    statusSubMessage.className = 'text-white/70 text-lg mt-4';
                }
            } else if (data.status === 'ENDED') {
                statusMessage.textContent = data.message || 'That is a wrap! You just finished the poll - nicely done.';
                statusIcon = 'emoji_events';
                statusClass = 'text-yellow-300';
                if (statusSubMessage) {
                    statusSubMessage.style.display = 'none';
                }
            } else if (data.status === 'NOT_ENROLLED') {
                statusMessage.textContent = data.message || 'You are not enrolled.';
                statusTextClass = 'text-red-300 text-2xl font-bold';
                statusIcon = 'error';
                statusClass = 'text-red-300';
                stopPolling();
            } else if (data.status === 'ERROR') {
                statusMessage.textContent = data.message || 'We hit a snag. Try again soon.';
                statusTextClass = 'text-red-300 text-2xl font-bold';
                statusIcon = 'error';
                statusClass = 'text-red-300';
            } else {
                statusMessage.textContent = data.message || 'Hang tight - your teacher is loading the next challenge.';
                statusIcon = 'hourglass_top';
                statusClass = 'text-white';
            }

            statusMessage.className = statusTextClass;
            var iconEl = statusContainer.querySelector('.material-symbols-outlined');
            if (iconEl) {
                iconEl.textContent = statusIcon;
                iconEl.className = 'material-symbols-outlined text-6xl mb-4 inline-block ' + statusClass;
            }
        }

        function submitAnswer(pollId, questionIndex, answerText) {
            if (isInteractionBlocked) {
                return;
            }
            if (hasAnsweredCurrent) {
                return;
            }

            var buttons = optionsList.querySelectorAll('button');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].disabled = true;
                if (buttons[i].dataset.answerText === answerText) {
                    buttons[i].className = optionSelectedClass;
                } else {
                    buttons[i].className = optionDisabledClass;
                }
            }
            hasAnsweredCurrent = true;
            pendingSubmission = true;
            statusContainer.style.display = 'block';
            questionContainer.style.display = 'none';
            statusMessage.textContent = 'Transmitting your genius response...';
            statusMessage.className = 'text-white text-2xl font-semibold';
            google.script.run
                .withSuccessHandler(function(response) {
                    if (!response.success) {
                        hasAnsweredCurrent = false;
                        pendingSubmission = false;
                        statusMessage.textContent = response.error || 'We hit a hiccup. Try again?';
                        statusMessage.className = 'text-red-300 text-2xl font-semibold';
                        if (statusSubMessage) {
                            statusSubMessage.style.display = 'none';
                            statusSubMessage.textContent = '';
                        }
                        setTimeout(function() {
                            if (!isInteractionBlocked) {
                                questionContainer.style.display = 'block';
                                statusContainer.style.display = 'none';
                                var buttons = optionsList.querySelectorAll('button');
                                for (var i = 0; i < buttons.length; i++) {
                                    buttons[i].disabled = false;
                                    buttons[i].className = optionBaseClass;
                                }
                            }
                        }, 2000);
                    } else {
                        statusMessage.textContent = 'Answer received - nice work.';
                        statusMessage.className = 'text-green-300 text-2xl font-semibold';
                        if (statusSubMessage) {
                            statusSubMessage.textContent = 'Your teacher will reveal the answer shortly...';
                            statusSubMessage.style.display = 'block';
                            statusSubMessage.className = 'text-white/70 text-lg mt-4';
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    hasAnsweredCurrent = false;
                    pendingSubmission = false;
                    handleError(error);
                })
                .submitStudentAnswer(pollId, questionIndex, answerText, SESSION_TOKEN);
        }

        function shuffle(array) {
            var arr = array.slice();
            for (var i = arr.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = arr[i];
                arr[i] = arr[j];
                arr[j] = temp;
            }
            return arr;
        }

        function createOptionButton(option, letter, pollId, questionIndex) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = optionBaseClass;
            btn.dataset.answerText = option.text || '';

            var content = '<div class="option-leading">';
            content += '<span class="result-indicator" aria-hidden="true"></span>';
            content += '<div class="letter-badge" aria-hidden="true">' + letter + '</div>';
            content += '</div>';
            content += '<div class="option-body">';
            if (option.imageURL) {
                content += '<img src="' + escapeHtml(option.imageURL) + '" alt="Answer ' + letter + '" class="option-image" referrerpolicy="no-referrer">';
            }
            if (option.text) {
                content += '<p class="option-text">' + escapeHtml(option.text) + '</p>';
            }
            content += '<span class="result-ribbon"></span>';
            content += '<span class="sr-only result-announcement"></span>';
            content += '</div>';

            btn.innerHTML = content;
            btn.onclick = function() {
                submitAnswer(pollId, questionIndex, option.text);
            };

            return btn;
        }

        function resetResultDecorations() {
            if (questionContainer) {
                questionContainer.classList.remove('results-stage');
                questionContainer.classList.remove('showing-results');
            }
            if (questionSublineEl) {
                questionSublineEl.classList.add('hidden');
                questionSublineEl.textContent = '';
            }
            if (noResponsesMessageEl) {
                noResponsesMessageEl.classList.add('hidden');
                noResponsesMessageEl.textContent = '';
            }
            if (!optionsList) return;
            var buttons = optionsList.querySelectorAll('button');
            buttons.forEach(function(btn) {
                btn.disabled = false;
                btn.className = optionBaseClass;
                btn.classList.remove('result-readonly', 'result-correct', 'result-incorrect', 'result-your-choice');
                var ribbon = btn.querySelector('.result-ribbon');
                if (ribbon) {
                    ribbon.textContent = '';
                    ribbon.style.visibility = 'hidden';
                }
                var indicator = btn.querySelector('.result-indicator');
                if (indicator) {
                    indicator.textContent = '';
                }
                var srOnly = btn.querySelector('.result-announcement');
                if (srOnly) {
                    srOnly.textContent = '';
                }
            });
        }

        function ensureOptionsRenderedForResults(data) {
            if (!optionsList) return;
            if (optionsList.children.length > 0) {
                return;
            }

            var baseOptions = currentOptionLayout.length > 0 ? currentOptionLayout : (data.options || []);
            var letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            optionsList.innerHTML = '';
            currentOptionLayout = [];

            baseOptions.forEach(function(option, index) {
                var normalized = {
                    text: option.text || option,
                    imageURL: option.imageURL || option.imageUrl || ''
                };
                var letter = letters[index] || (index + 1).toString();
                var btn = createOptionButton(normalized, letter, data.pollId, data.questionIndex);
                btn.disabled = true;
                btn.classList.add('result-readonly');
                var listItem = document.createElement('li');
                listItem.appendChild(btn);
                optionsList.appendChild(listItem);
                currentOptionLayout.push({
                    text: normalized.text || '',
                    imageURL: normalized.imageURL || ''
                });
            });
        }

        function decorateOptionsForResults(data) {
            if (!optionsList) return;
            var totalResponses = typeof data.totalResponses === 'number' ? data.totalResponses : 0;
            var percentages = data.resultPercentages || {};
            var buttons = optionsList.querySelectorAll('button');

            buttons.forEach(function(btn) {
                var answerText = btn.dataset.answerText || '';
                btn.disabled = true;
                btn.className = optionBaseClass + ' result-readonly';
                btn.classList.remove('result-correct', 'result-incorrect', 'result-your-choice');

                var ribbon = btn.querySelector('.result-ribbon');
                if (ribbon) {
                    ribbon.textContent = '';
                    ribbon.style.visibility = 'hidden';
                }

                var indicator = btn.querySelector('.result-indicator');
                if (indicator) {
                    indicator.textContent = '';
                }

                var srOnly = btn.querySelector('.result-announcement');
                if (srOnly) {
                    srOnly.textContent = '';
                }

                if (data.status !== 'RESULTS_REVEALED') {
                    return;
                }

                var percentage = typeof percentages[answerText] === 'number' ? percentages[answerText] : 0;
                if (ribbon) {
                    if (totalResponses > 0) {
                        ribbon.textContent = percentage + '%';
                        ribbon.style.visibility = 'visible';
                    } else {
                        ribbon.textContent = '';
                        ribbon.style.visibility = 'hidden';
                    }
                }

                var isCorrect = data.correctAnswer && answerText === data.correctAnswer;
                var hasStudentAnswer = data.studentAnswer !== undefined && data.studentAnswer !== null && data.studentAnswer !== '';
                var isStudentChoice = hasStudentAnswer && answerText === data.studentAnswer;
                var studentIsCorrect = (data.studentIsCorrect === null || data.studentIsCorrect === undefined)
                    ? null
                    : !!data.studentIsCorrect;

                if (isCorrect) {
                    btn.classList.add('result-correct');
                } else {
                    btn.classList.add('result-incorrect');
                }

                if (isStudentChoice && (studentIsCorrect === false || !isCorrect)) {
                    btn.classList.add('result-your-choice');
                }

                if (indicator) {
                    if (isCorrect) {
                        indicator.textContent = '✓';
                    } else if (isStudentChoice && studentIsCorrect === false) {
                        indicator.textContent = '✕';
                    } else {
                        indicator.textContent = '';
                    }
                }

                if (srOnly) {
                    var srParts = [];
                    if (isCorrect) {
                        srParts.push('Correct answer');
                    }
                    if (isStudentChoice) {
                        srParts.push('Your selection');
                    }
                    if (totalResponses > 0) {
                        srParts.push(percentage + '% of class selected this choice');
                    } else {
                        srParts.push('No responses recorded');
                    }
                    srOnly.textContent = srParts.join('. ') + '.';
                }
            });
        }

        function renderResultsStage(data) {
            currentPollState = data;
            var resetTimestamp = (data.metadata && data.metadata.resetAt) ? data.metadata.resetAt : '';
            currentQuestionKey = data.pollId + ':' + data.questionIndex + ':' + resetTimestamp;
            hasAnsweredCurrent = !!data.hasSubmitted;
            questionContainer.style.display = 'block';
            statusContainer.style.display = 'none';

            var qNum = (data.questionIndex || 0) + 1;
            var qTotal = data.totalQuestions || '?';
            if (questionNumberEl) {
                questionNumberEl.textContent = 'Question ' + qNum + ' of ' + qTotal;
            }
            if (questionTextEl) {
                questionTextEl.textContent = data.questionText || '';
            }
            if (questionImageEl) {
                if (data.questionImageURL) {
                    questionImageEl.src = data.questionImageURL;
                    questionImageEl.style.display = 'block';
                } else {
                    questionImageEl.style.display = 'none';
                }
            }

            if (questionSublineEl) {
                questionSublineEl.textContent = 'Shown after responses closed.';
                questionSublineEl.classList.remove('hidden');
            }

            if (data.status === 'RESULTS_REVEALED' && noResponsesMessageEl) {
                if ((data.totalResponses || 0) === 0) {
                    noResponsesMessageEl.textContent = 'No responses recorded for this question.';
                    noResponsesMessageEl.classList.remove('hidden');
                } else {
                    noResponsesMessageEl.classList.add('hidden');
                    noResponsesMessageEl.textContent = '';
                }
            } else if (noResponsesMessageEl) {
                noResponsesMessageEl.classList.add('hidden');
                noResponsesMessageEl.textContent = '';
            }

            ensureOptionsRenderedForResults(data);

            questionContainer.classList.add('results-stage');
            questionContainer.classList.remove('showing-results');
            if (data.status === 'RESULTS_REVEALED') {
                requestAnimationFrame(function() {
                    questionContainer.classList.add('showing-results');
                });
            }

            decorateOptionsForResults(data);
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showLockedMessage() {
            console.log('Showing locked message');
            stopPolling();
            recoveringFromOutage = false;
            hideConnectivityBanner();
            studentContainer.style.display = 'block';
            entryScreen.style.display = 'none';
            questionContainer.style.display = 'none';
            statusContainer.style.display = 'block';
            if (studentLoader) studentLoader.style.display = 'none';

            if (statusSubMessage) {
                statusSubMessage.style.display = 'none';
                statusSubMessage.textContent = '';
            }

            statusMessage.textContent = 'Oops - you left fullscreen. Your poll has been paused until your teacher lets you back in.';
            statusMessage.className = 'text-red-300 text-xl font-semibold';

            var iconEl = statusContainer.querySelector('.material-symbols-outlined');
            if (iconEl) {
                iconEl.textContent = 'lock';
                iconEl.className = 'material-symbols-outlined text-6xl text-red-300 mb-4 inline-block';
            }
            if (resumeControls) {
                resumeControls.style.display = 'none';
            }
        }

        function showResumePrompt() {
            console.log('Showing resume prompt');
            stopPolling();
            hideConnectivityBanner();
            studentContainer.style.display = 'block';
            entryScreen.style.display = 'none';
            questionContainer.style.display = 'none';
            statusContainer.style.display = 'block';
            if (studentLoader) studentLoader.style.display = 'none';

            if (statusSubMessage) {
                statusSubMessage.style.display = 'none';
                statusSubMessage.textContent = '';
            }

            // Use exact text from requirements
            statusMessage.textContent = 'You are cleared for re-entry. Go fullscreen to get back in the game.';
            statusMessage.className = 'text-white text-xl font-semibold';

            var iconEl = statusContainer.querySelector('.material-symbols-outlined');
            if (iconEl) {
                iconEl.textContent = 'fullscreen';
                iconEl.className = 'material-symbols-outlined text-6xl text-green-300 mb-4 inline-block';
            }

            if (resumeControls) {
                resumeControls.style.display = 'block';
            }
        }

        function handleError(error) {
            console.error('Error:', error);
            hideConnectivityBanner();
            statusContainer.style.display = 'block';
            questionContainer.style.display = 'none';
            if (studentLoader) studentLoader.style.display = 'none';
            if (resumeControls) resumeControls.style.display = 'none';

            if (statusSubMessage) {
                statusSubMessage.style.display = 'none';
                statusSubMessage.textContent = '';
            }

            statusMessage.textContent = 'An error occurred: ' + (error.message || error);
            statusMessage.className = 'text-yellow-300 text-2xl font-bold';

            var iconEl = statusContainer.querySelector('.material-symbols-outlined');
            if (iconEl) {
                iconEl.textContent = 'error';
                iconEl.className = 'material-symbols-outlined text-6xl text-yellow-300 mb-4 inline-block';
            }
        }
    })();
    </script>
</body>
</html>
