<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet" />

  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <!-- Quill.js -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

  <!-- MathLive -->
  <script src="https://unpkg.com/mathlive"></script>

  <!-- DOMPurify -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>

  <link href="/src/css/main.css" rel="stylesheet">

  <!-- Firebase SDKs (compat) -->
  <script type="module" src="/src/js/firebase.js"></script>

  <title>Veritas - Exam Monitor</title>
</head>

<body class="bg-gray-100 min-h-screen text-gray-900 font-sans">

  <!-- Config Data -->
  <script>
    var EXAM_CONFIG = null;
    var FIREBASE_CONFIG = JSON.stringify({});
    if (!FIREBASE_CONFIG) {
      console.warn('FIREBASE_CONFIG missing, using default fallback.');
      FIREBASE_CONFIG = {
        apiKey: "AIzaSyAv0bCe5KIuQx_sou8toBy5DG2PYaB_pBM",
        authDomain: "classroomproctor.firebaseapp.com",
        databaseURL: "https://classroomproctor-default-rtdb.firebaseio.com",
        projectId: "classroomproctor",
        storageBucket: "classroomproctor.firebasestorage.app",
        messagingSenderId: "600627073908",
        appId: "1:600627073908:web:935970f5849b28f6ad5221"
      };
      window.USING_FALLBACK_CONFIG = true;
    }
    var ROSTER_MAP = {}; // studentKey -> {name, email}
  </script>

  <!-- Navbar -->
  <nav class="bg-veritas-navy text-white shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center space-x-4">
          <div class="flex-shrink-0 flex items-center">
            <span class="material-symbols-outlined text-gold mr-2 text-3xl">school</span>
            <span class="font-serif text-xl font-bold tracking-wide">Veritas Monitor</span>
          </div>
          <div class="ml-4 text-sm bg-blue-900/50 px-3 py-1 rounded">
            <span id="exam-name-header">Loading...</span>
          </div>
        </div>
        <div class="flex items-center space-x-3">
          <button onclick="window.close()" class="text-gray-300 hover:text-white">Exit</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Stats Bar -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
        <div class="text-sm font-bold text-gray-500 uppercase">Active</div>
        <div class="text-3xl font-bold text-green-600" id="statActive">0</div>
      </div>
      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
        <div class="text-sm font-bold text-gray-500 uppercase">Locked</div>
        <div class="text-3xl font-bold text-red-600" id="statLocked">0</div>
      </div>
      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
        <div class="text-sm font-bold text-gray-500 uppercase">Finished</div>
        <div class="text-3xl font-bold text-blue-600" id="statFinished">0</div>
      </div>
      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
        <div class="text-sm font-bold text-gray-500 uppercase">Disconnected</div>
        <div class="text-3xl font-bold text-gray-400" id="statDisconnected">0</div>
      </div>
    </div>

    <!-- Student Grid -->
    <div id="studentGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
      <!-- Tiles populated via JS -->
    </div>

  </div>

  <script>
    // State
    const students = {}; // key -> status
    let dbRef = null;

    // --- FIREBASE INIT ---
    var functions;
    (function () {
      if (FIREBASE_CONFIG) {
        firebase.initializeApp(FIREBASE_CONFIG);
        window.VERITAS_FIREBASE_DB = firebase.database();
        functions = firebase.functions();
      }
    })();

    window.onload = function () {
      import('/src/js/exam-loader.js').then(module => {
        module.loadExamData('teacher').then(data => {
          module.updateDomWithConfig(data, 'teacher');
          initFirebaseSession(); // Original Init
        }).catch(err => {
          alert('Failed to load exam: ' + err.message);
          console.error(err);
        });
      });
    };

    function initFirebaseSession() {
      const db = window.VERITAS_FIREBASE_DB;
      if (!db) return;

      dbRef = db.ref(`sessions/${EXAM_CONFIG.examId}/students`);

      // Initial Load & Listen
      dbRef.on('value', snap => {
        const data = snap.val() || {};
        updateGrid(data);
      });
    }

    function updateGrid(data) {
      const grid = document.getElementById('studentGrid');

      // Update stats
      let active = 0, locked = 0, finished = 0, discon = 0;

      // Ensure we have tiles for all rostered students, even if not in Firebase yet
      // Combine Roster Keys + Firebase Keys
      const allKeys = new Set([...Object.keys(ROSTER_MAP), ...Object.keys(data)]);

      allKeys.forEach(key => {
        const status = data[key] || 'OFFLINE';
        const info = ROSTER_MAP[key] || { name: 'Unknown (' + key + ')' };

        let tile = document.getElementById(`tile-${key}`);
        if (!tile) {
          tile = createTile(key, info);
          grid.appendChild(tile);
        }

        updateTile(tile, status);

        if (status === 'ACTIVE') active++;
        if (status === 'LOCKED') locked++;
        if (status === 'FINISHED') finished++;
        if (status === 'DISCONNECTED') discon++;
      });

      document.getElementById('statActive').textContent = active;
      document.getElementById('statLocked').textContent = locked;
      document.getElementById('statFinished').textContent = finished;
      document.getElementById('statDisconnected').textContent = discon;
    }

    function createTile(key, info) {
      const div = document.createElement('div');
      div.id = `tile-${key}`;
      div.className = 'bg-white rounded-lg shadow border-l-4 p-4 transition-all relative overflow-hidden group';

      div.innerHTML = `
        <div class="flex justify-between items-start mb-2">
           <div class="font-bold text-gray-900 truncate" title="${info.name}">${info.name}</div>
           <span class="status-badge px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wider">OFFLINE</span>
        </div>
        <div class="text-xs text-gray-500 mb-4">${info.email}</div>

        <div class="action-overlay absolute inset-0 bg-white/90 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity p-2 gap-2">
           <!-- Dynamic Buttons -->
        </div>
      `;
      return div;
    }

    function updateTile(tile, status) {
      const badge = tile.querySelector('.status-badge');
      const overlay = tile.querySelector('.action-overlay');
      const studentKey = tile.id.replace('tile-', '');
      const studentName = ROSTER_MAP[studentKey] ? ROSTER_MAP[studentKey].name : 'Unknown Student';

      // Reset classes
      tile.className = 'bg-white rounded-lg shadow border-l-4 p-4 transition-all relative overflow-hidden group';

      let badgeClass = 'bg-gray-100 text-gray-800';
      let borderClass = 'border-gray-200';
      let buttons = '';

      switch (status) {
        case 'ACTIVE':
          badgeClass = 'bg-green-100 text-green-800';
          borderClass = 'border-green-500';
          buttons = `<button onclick="setStatus('${studentKey}', 'LOCKED')" class="btn-secondary w-full text-red-600 border-red-200 hover:bg-red-50">Lock Student</button>`;
          break;
        case 'LOCKED':
          badgeClass = 'bg-red-100 text-red-800 animate-pulse';
          borderClass = 'border-red-600 bg-red-50';
          buttons = `<button onclick="setStatus('${studentKey}', 'ACTIVE')" class="btn-primary w-full bg-green-600 hover:bg-green-700">Unlock</button>`;
          break;
        case 'FINISHED':
          badgeClass = 'bg-blue-100 text-blue-800';
          borderClass = 'border-blue-500';
          buttons = `<span class="text-sm font-bold text-blue-600">Exam Submitted</span>`;
          break;
        case 'DISCONNECTED':
          badgeClass = 'bg-gray-200 text-gray-600';
          borderClass = 'border-gray-400';
          // buttons = `<button onclick="setStatus('${tile.id.replace('tile-','')}', 'ACTIVE')" class="btn-secondary w-full">Force Active</button>`;
          break;
        case 'OFFLINE':
          borderClass = 'border-gray-200 opacity-60';
          break;
      }

      tile.classList.add(borderClass);
      badge.className = `status-badge px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wider ${badgeClass}`;
      badge.textContent = status;
      overlay.innerHTML = buttons;
    }

    function setStatus(studentKey, newStatus) {
      if (!dbRef) return;

      // 1. Firebase (Fast)
      dbRef.child(studentKey).set(newStatus);

      // 2. Server (Canonical)
      const studentName = ROSTER_MAP[studentKey].name;

      if (newStatus === 'ACTIVE') {
        unlockStudent(studentKey, studentName);
      } else if (newStatus === 'LOCKED') {
        markViolation(studentKey, studentName);
      }
    }

    function unlockStudent(studentKey, studentName) {
      if (!confirm(`Unlock exam for ${studentName}?`)) return;

      var manageExamSession = functions.httpsCallable('manageExamSession');
      manageExamSession({
        action: 'UNLOCK',
        examId: EXAM_CONFIG.examId,
        studentId: studentKey // Assuming Key is ID here, or need map.
        // The key in Students map is usually safe-key. studentId needs to be reconstructed or passed.
        // Wait, studentKey in map is email replaced.
        // manageExamSession expects 'studentId'.
        // If I pass the key as studentId, logic: const studentKey = studentId.replace...
        // If it's already a key (dots replaced), safe to pass as ID?
        // replace(/[.$#[\]]/g, "_") is idempotent if no dots.
        // So passing key is fine.
      }).then(() => {
        // Success handled by RTDB listener
      }).catch(err => alert('Unlock failed: ' + err.message));
    }

    function markViolation(studentKey, studentName) {
      const reason = prompt(`Report violation for ${studentName}:`);
      if (!reason) return;

      var manageExamSession = functions.httpsCallable('manageExamSession');
      manageExamSession({
        action: 'VIOLATION',
        examId: EXAM_CONFIG.examId,
        studentId: studentKey,
        studentName: studentName,
        reason: reason
      }).catch(err => alert('Action failed: ' + err.message));
    }

  </script>
</body>

</html>