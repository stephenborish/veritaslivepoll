<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <!-- =============================================================================
     VERITAS LIVE POLL - SHARED HEAD ELEMENTS
     =============================================================================
     Purpose: Common <head> elements for all pages
     Used by: TeacherView.html, StudentView.html
     Phase: 3A - Shared Components
     ============================================================================= -->

<base target="_top">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com" rel="preconnect" />
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap"
     rel="stylesheet" />

<!-- Material Symbols -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

<!-- Quill.js (Rich Text Editor) -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<!-- Image Resize Module -->
<script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>

<!-- KaTeX (Formula Rendering) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<!-- MathLive (Visual Formula Editor) -->
<script src="https://unpkg.com/mathlive"></script>

<!-- DOMPurify (Security) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>

<!-- Clarity Tracking -->
<script type="text/javascript">
     (function (c, l, a, r, i, t, y) {
          c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
          t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
          y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
     })(window, document, "clarity", "script", "unrh0cofey");
</script>
  <!-- =============================================================================
     VERITAS LIVE POLL - SHARED CSS CUSTOM PROPERTIES
     =============================================================================
     Purpose: Centralized CSS variables for design system consistency
     Used by: TeacherView.html, StudentView.html
     Phase: 3A - Shared Components
     ============================================================================= -->

<style>
  /* Veritas Design System - CSS Custom Properties */
  :root {
    /* Brand Colors */
    --veritas-navy: #12385d;
    --veritas-gold: #c5a05a;
    --brand-white: #ffffff;
    --brand-light-gray: #d9e0e7;
    --brand-dark-gray: #242424;

    /* Background Colors */
    --bg-light: #f7f8fa;
    --bg-dark: #0f1723;
    --bg-card: #ffffff;
    --bg-elevated: #f8fafc;
    --bg-glass: rgba(255, 255, 255, 0.7);
    --bg-glass-dark: rgba(15, 23, 42, 0.7);

    /* Text Colors */
    --text-primary: #111111;
    --text-secondary: #4b5563;
    --text-muted: #6b7280;
    --text-on-navy: #ffffff;

    /* Semantic Colors */
    --success-green: #1b5e20;
    --success-light: #2e7d32;
    --success-bg: #e8f5ec;
    --success-bg-light: #ecfdf5;
    --error-red: #c62828;

    /* Opacity Modifiers */
    --navy-06: rgba(18, 56, 93, 0.06);
    --navy-10: rgba(18, 56, 93, 0.1);
    --navy-12: rgba(18, 56, 93, 0.12);
    --navy-14: rgba(18, 56, 93, 0.14);
    --gold-08: rgba(197, 160, 90, 0.08);

    /* Spacing Scale (following 8px baseline) */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 32px;
    --space-2xl: 48px;

    /* Border Radius */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 14px;
    --radius-xl: 16px;
    --radius-2xl: 24px;
    --radius-full: 9999px;

    /* Depth & Glassmorphism */
    --glass-blur: blur(12px);
    --glass-border: rgba(255, 255, 255, 0.2);
    --glass-border-dark: rgba(255, 255, 255, 0.1);
    --shadow-glass: 0 8px 32px 0 rgba(18, 56, 93, 0.1);
    --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

    /* Interactive Glows */
    --glow-navy: 0 0 15px rgba(18, 56, 93, 0.3);
    --glow-gold: 0 0 15px rgba(197, 160, 90, 0.3);

    /* Enhanced Semantic Colors (WCAG AA Compliant) */
    --primary: #12385d;
    --primary-hover: #0f2d4a;
    --primary-light: #1a4a7a;
    --secondary: #c5a05a;
    --secondary-hover: #b08f4d;

    /* Status Colors with Better Contrast */
    --success: #16a34a;
    --success-bg: #dcfce7;
    --success-border: #86efac;
    --warning: #f59e0b;
    --warning-bg: #fef3c7;
    --warning-border: #fcd34d;
    --error: #dc2626;
    --error-bg: #fee2e2;
    --error-border: #fca5a5;
    --info: #3b82f6;
    --info-bg: #dbeafe;
    --info-border: #93c5fd;

    /* Interactive States */
    --focus-ring: 0 0 0 3px rgba(18, 56, 93, 0.2);
    --hover-lift: 0 4px 12px rgba(0, 0, 0, 0.1);
    --active-press: 0 2px 4px rgba(0, 0, 0, 0.1);

    /* Typography Scale */
    --text-xs: 0.75rem;
    /* 12px */
    --text-sm: 0.875rem;
    /* 14px */
    --text-base: 1rem;
    /* 16px */
    --text-lg: 1.125rem;
    /* 18px */
    --text-xl: 1.25rem;
    /* 20px */
    --text-2xl: 1.5rem;
    /* 24px */
    --text-3xl: 1.875rem;
    /* 30px */
    --text-4xl: 2.25rem;
    /* 36px */

    /* Line Heights */
    --leading-tight: 1.25;
    --leading-normal: 1.5;
    --leading-relaxed: 1.75;

    /* Animation Timings */
    --duration-fast: 150ms;
    --duration-normal: 200ms;
    --duration-slow: 300ms;
    --ease-out: cubic-bezier(0.4, 0, 0.2, 1);
    --ease-in-out: cubic-bezier(0.4, 0, 0.6, 1);
  }
</style>
  <!-- =============================================================================
     VERITAS LIVE POLL - SHARED TAILWIND CONFIGURATION
     =============================================================================
     Purpose: Centralized Tailwind CSS configuration for design system consistency
     Used by: TeacherView.html, StudentView.html
     Phase: 3A - Shared Components
     ============================================================================= -->

<!-- Tailwind CSS CDN with Plugins -->
<script src="https://cdn.tailwindcss.com/3.3.5"></script>

<!-- Tailwind Configuration -->
<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          // Veritas Brand Colors (Primary Design System)
          "veritas-navy": "#12385d",
          "veritas-gold": "#c5a05a",
          primary: "#12385d",

          // Supporting Brand Colors
          "brand-white": "#ffffff",
          "brand-light-gray": "#d9e0e7",
          "brand-dark-gray": "#242424",
          "background-light": "#f7f8fa",
          "background-dark": "#0f1723",

          // Semantic Colors
          "success-green": "#1b5e20",
          "success-bg": "#e8f5ec",
          "error-red": "#c62828",
          "text-primary": "#111111",
          "text-secondary": "#4b5563",
          "text-muted": "#6b7280"
        },
        fontFamily: {
          display: ["Inter", "sans-serif"],
          serif: ["Noto Serif", "serif"]
        },
        borderRadius: {
          DEFAULT: "0.25rem",
          lg: "0.5rem",
          xl: "0.75rem",
          "2xl": "1rem",
          full: "9999px"
        },
        spacing: {
          '18': '4.5rem',
          '88': '22rem',
          '128': '32rem'
        },
        animation: {
          // Teacher animations
          'fade-up': 'fadeUp 0.4s ease-out forwards',
          'pulse-glow': 'pulseGlow 3s ease-in-out infinite',

          // Student animations
          'fade-in': 'fadeIn 0.6s ease-out forwards',
          'spin-slow': 'spin 3s linear infinite',
          'pulse-dot': 'pulseDot 1.2s ease-in-out infinite'
        },
        keyframes: {
          fadeUp: {
            '0%': { opacity: '0', transform: 'translateY(20px)' },
            '100%': { opacity: '1', transform: 'translateY(0)' }
          },
          pulseGlow: {
            '0%, 100%': { boxShadow: '0 0 0 0 rgba(197, 160, 90, 0.4)' },
            '50%': { boxShadow: '0 0 20px 4px rgba(197, 160, 90, 0.4)' }
          },
          fadeIn: {
            'from': { opacity: '0', transform: 'translateY(10px)' },
            'to': { opacity: '1', transform: 'translateY(0)' }
          },
          'pulseDot': {
            '0%, 80%, 100%': { opacity: '0.25', transform: 'scale(0.85)' },
            '40%': { opacity: '1', transform: 'scale(1)' }
          }
        }
      }
    }
  };
</script>
  <title>Veritas - Question Bank</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-functions-compat.js"></script>

  <script>
    var FIREBASE_CONFIG = {"apiKey":"AIzaSyAv0bCe5KIuQx_sou8toBy5DG2PYaB_pBM","authDomain":"classroomproctor.firebaseapp.com","databaseURL":"https://classroomproctor-default-rtdb.firebaseio.com","projectId":"classroomproctor","storageBucket":"classroomproctor.firebasestorage.app","messagingSenderId":"600627073908","appId":"1:600627073908:web:935970f5849b28f6ad5221"};
    if (!FIREBASE_CONFIG) {
      console.warn('FIREBASE_CONFIG missing, using default fallback.');
      FIREBASE_CONFIG = {
        apiKey: "AIzaSyAv0bCe5KIuQx_sou8toBy5DG2PYaB_pBM",
        authDomain: "classroomproctor.firebaseapp.com",
        databaseURL: "https://classroomproctor-default-rtdb.firebaseio.com",
        projectId: "classroomproctor",
        storageBucket: "classroomproctor.firebasestorage.app",
        messagingSenderId: "600627073908",
        appId: "1:600627073908:web:935970f5849b28f6ad5221"
      };
    }
    firebase.initializeApp(FIREBASE_CONFIG);
  </script>
</head>

<body class="bg-gray-50 min-h-screen text-gray-900 font-sans">

  <!-- Navbar -->
  <nav class="bg-veritas-navy text-white shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center space-x-4">
          <div class="flex-shrink-0 flex items-center">
            <span class="material-symbols-outlined text-gold mr-2 text-3xl">school</span>
            <span class="font-serif text-xl font-bold tracking-wide">Veritas</span>
          </div>
          <div class="hidden md:flex space-x-4 ml-8">
            <a href="/teacher/index.html"
              class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-white/10 transition-colors">Polls</a>
            <a href="/teacher/question_bank.html"
              class="px-3 py-2 rounded-md text-sm font-medium bg-white/20 text-white">Question Bank</a>
            <a href="/teacher/exams.html"
              class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-white/10 transition-colors">Exams</a>
          </div>
        </div>
        <div class="flex items-center space-x-3">
          <span id="user-email-display" class="text-sm text-gray-300 hidden sm:block"></span>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header & Actions -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Question Bank</h1>
        <p class="text-gray-500 mt-1">Manage and organize your assessment items</p>
      </div>
      <button onclick="openQuestionModal()"
        class="btn-primary flex items-center gap-2 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all">
        <span class="material-symbols-outlined">add_circle</span>
        <span>New Question</span>
      </button>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Class</label>
          <select id="filterClass"
            class="w-full form-select rounded-lg border-gray-300 text-sm focus:ring-veritas-navy focus:border-veritas-navy"
            onchange="loadQuestions()">
            <option value="">All Classes</option>
            <!-- Populated via JS -->
          </select>
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Unit</label>
          <input type="text" id="filterUnit"
            class="w-full form-input rounded-lg border-gray-300 text-sm focus:ring-veritas-navy focus:border-veritas-navy"
            placeholder="e.g. Unit 1" oninput="debounceLoad()">
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Topic</label>
          <input type="text" id="filterTopic"
            class="w-full form-input rounded-lg border-gray-300 text-sm focus:ring-veritas-navy focus:border-veritas-navy"
            placeholder="e.g. Enzymes" oninput="debounceLoad()">
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Difficulty</label>
          <select id="filterDifficulty"
            class="w-full form-select rounded-lg border-gray-300 text-sm focus:ring-veritas-navy focus:border-veritas-navy"
            onchange="loadQuestions()">
            <option value="">Any</option>
            <option value="Easy">Easy</option>
            <option value="Medium">Medium</option>
            <option value="Hard">Hard</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Questions Table -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Question Stem
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Tags</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Diff</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Type</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Actions
              </th>
            </tr>
          </thead>
          <tbody id="questionsTableBody" class="bg-white divide-y divide-gray-200">
            <tr>
              <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                <div class="flex flex-col items-center justify-center">
                  <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-veritas-navy mb-3"></div>
                  <p>Loading questions...</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Question Modal -->
  <div id="questionModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
        onclick="closeQuestionModal()"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div
        class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
        <form id="questionForm" onsubmit="handleSave(event)">
          <input type="hidden" name="questionId">
          <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" id="modalTitle">Edit Question</h3>
            <!-- Grid Layout -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Class</label>
                <select name="classId"
                  class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-veritas-navy focus:border-veritas-navy sm:text-sm">
                  <option value="">-- Global --</option>
                  <!-- Populated via JS -->
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Type</label>
                <select name="questionType"
                  class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-veritas-navy focus:border-veritas-navy sm:text-sm"
                  onchange="toggleTypeFields()">
                  <option value="MC">Multiple Choice</option>
                  <option value="SA">Short Answer</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Unit Tag</label>
                <input type="text" name="unitTag"
                  class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-veritas-navy focus:border-veritas-navy sm:text-sm">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Topic Tag</label>
                <input type="text" name="topicTag"
                  class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-veritas-navy focus:border-veritas-navy sm:text-sm">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Difficulty</label>
                <select name="difficulty"
                  class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-veritas-navy focus:border-veritas-navy sm:text-sm">
                  <option value="Easy">Easy</option>
                  <option value="Medium" selected>Medium</option>
                  <option value="Hard">Hard</option>
                </select>
              </div>
            </div>

            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700">Question Stem</label>
              <textarea name="stemHtml" rows="3"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-veritas-navy focus:border-veritas-navy sm:text-sm"
                required></textarea>
            </div>

            <!-- MC Fields -->
            <div id="mcFields">
              <div class="mb-2 font-medium text-sm text-gray-700">Choices</div>
              <div class="space-y-3">
                <div class="flex gap-2 items-center">
                  <span class="w-6 font-bold text-gray-500">A</span>
                  <input type="text" name="choiceA_Text" class="flex-1 border-gray-300 rounded-md shadow-sm text-sm"
                    placeholder="Option A text">
                  <input type="radio" name="correctOption" value="A" class="text-veritas-navy focus:ring-veritas-navy">
                </div>
                <div class="flex gap-2 items-center">
                  <span class="w-6 font-bold text-gray-500">B</span>
                  <input type="text" name="choiceB_Text" class="flex-1 border-gray-300 rounded-md shadow-sm text-sm"
                    placeholder="Option B text">
                  <input type="radio" name="correctOption" value="B" class="text-veritas-navy focus:ring-veritas-navy">
                </div>
                <div class="flex gap-2 items-center">
                  <span class="w-6 font-bold text-gray-500">C</span>
                  <input type="text" name="choiceC_Text" class="flex-1 border-gray-300 rounded-md shadow-sm text-sm"
                    placeholder="Option C text">
                  <input type="radio" name="correctOption" value="C" class="text-veritas-navy focus:ring-veritas-navy">
                </div>
                <div class="flex gap-2 items-center">
                  <span class="w-6 font-bold text-gray-500">D</span>
                  <input type="text" name="choiceD_Text" class="flex-1 border-gray-300 rounded-md shadow-sm text-sm"
                    placeholder="Option D text">
                  <input type="radio" name="correctOption" value="D" class="text-veritas-navy focus:ring-veritas-navy">
                </div>
              </div>
            </div>

            <!-- SA Fields -->
            <div id="saFields" class="hidden">
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Correct Answer (Exact Match)</label>
                <input type="text" name="correctShortAnswer"
                  class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-veritas-navy focus:border-veritas-navy sm:text-sm"
                  placeholder="e.g. Mitochondria">
                <p class="mt-1 text-xs text-gray-500">Leave blank for manual grading.</p>
              </div>
            </div>

            <div class="mt-4 flex gap-4">
              <div class="w-24">
                <label class="block text-sm font-medium text-gray-700">Points</label>
                <input type="number" name="points" value="1" min="0"
                  class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-veritas-navy focus:border-veritas-navy sm:text-sm">
              </div>
              <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700">Tags (CSV)</label>
                <input type="text" name="tagsCsv"
                  class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-veritas-navy focus:border-veritas-navy sm:text-sm"
                  placeholder="Bio, Chapter1, Review">
              </div>
            </div>

          </div>
          <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
            <button type="submit"
              class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-veritas-navy text-base font-medium text-white hover:bg-blue-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-veritas-navy sm:ml-3 sm:w-auto sm:text-sm">Save</button>
            <button type="button"
              class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
              onclick="closeQuestionModal()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // State
    let allQuestions = [];
    let loadTimer = null;
    let currentUser = null;

    // Init
    window.addEventListener('load', function () {
      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          currentUser = user;
          document.getElementById('user-email-display').textContent = user.email;
          loadClasses();
          loadQuestions();
        } else {
          window.location.href = '/teacher/index.html'; // Redirect to login via main app
        }
      });
    });

    function loadClasses() {
      // Stub for Phase 2: Roster Management
      console.log('Fetching classes...');
    }

    function loadQuestions() {
      const filters = {
        classId: document.getElementById('filterClass').value,
        unitTag: document.getElementById('filterUnit').value,
        topicTag: document.getElementById('filterTopic').value,
        difficulty: document.getElementById('filterDifficulty').value
      };

      // Handle tags array for backend
      const tags = [];
      if (filters.unitTag) tags.push(filters.unitTag);
      if (filters.topicTag) tags.push(filters.topicTag);

      const tbody = document.getElementById('questionsTableBody');
      tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500"><div class="animate-spin inline-block rounded-full h-6 w-6 border-b-2 border-veritas-navy mr-2"></div>Loading...</td></tr>';

      const manageQuestionBank = firebase.functions().httpsCallable('manageQuestionBank');
      manageQuestionBank({
        action: 'SEARCH',
        filters: {
          difficulty: filters.difficulty || undefined,
          tags: tags.length > 0 ? tags : undefined
        }
      }).then(result => {
        const data = result.data;
        if (data.success) {
          allQuestions = data.questions;
          renderQuestions(allQuestions);
        } else {
          console.error(data);
        }
      }).catch(err => {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading questions.</td></tr>';
      });
    }

    function debounceLoad() {
      clearTimeout(loadTimer);
      loadTimer = setTimeout(loadQuestions, 500);
    }

    function renderQuestions(questions) {
      const tbody = document.getElementById('questionsTableBody');
      tbody.innerHTML = '';

      if (!questions || questions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No questions found.</td></tr>';
        return;
      }

      questions.forEach(q => {
        // Map backend 'text' to 'stemHtml'
        q.stemHtml = q.text || '';
        // Map backend 'options' to choice fields if needed for editing

        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 transition-colors';
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-xs font-mono text-gray-500">${q.id.substring(0, 8)}...</td>
          <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${q.text}</td>
          <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">
            ${(q.tags || []).map(t => `<span class="px-2 py-0.5 rounded bg-gray-100 mr-1">${t}</span>`).join('')}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-xs">
            <span class="px-2 py-1 rounded-full ${getDiffColor(q.difficulty)}">${q.difficulty || 'Medium'}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">MC</td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick='editQuestion(${JSON.stringify(q).replace(/'/g, "&apos;")})' class="text-veritas-navy hover:text-blue-900 mr-3">Edit</button>
            <button onclick="deleteQuestion('${q.id}')" class="text-red-600 hover:text-red-900">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function getDiffColor(diff) {
      switch ((diff || '').toLowerCase()) {
        case 'easy': return 'bg-green-100 text-green-800';
        case 'hard': return 'bg-red-100 text-red-800';
        default: return 'bg-yellow-100 text-yellow-800';
      }
    }

    // Modal Logic
    function openQuestionModal(q) {
      const modal = document.getElementById('questionModal');
      const form = document.getElementById('questionForm');
      form.reset();

      if (q) {
        document.getElementById('modalTitle').textContent = 'Edit Question';
        form.questionId.value = q.id;
        form.stemHtml.value = q.text || '';
        form.difficulty.value = q.difficulty || 'Medium';
        form.tagsCsv.value = (q.tags || []).join(', ');

        // Handle Options
        if (q.options && q.options.length >= 4) {
          form.choiceA_Text.value = q.options[0].text;
          form.choiceB_Text.value = q.options[1].text;
          form.choiceC_Text.value = q.options[2].text;
          form.choiceD_Text.value = q.options[3].text;
        }

        if (q.correctAnswer) {
          // Map index to A,B,C,D
          const index = parseInt(q.correctAnswer);
          const val = ['A', 'B', 'C', 'D'][index];
          if (val) {
            const radio = form.querySelector(`input[value="${val}"]`);
            if (radio) radio.checked = true;
          }
        }

      } else {
        document.getElementById('modalTitle').textContent = 'New Question';
        form.questionId.value = '';
      }

      toggleTypeFields();
      modal.classList.remove('hidden');
    }

    function editQuestion(q) {
      openQuestionModal(q);
    }

    function closeQuestionModal() {
      document.getElementById('questionModal').classList.add('hidden');
    }

    function toggleTypeFields() {
      const type = document.querySelector('select[name="questionType"]').value;
      const mcFields = document.getElementById('mcFields');
      const saFields = document.getElementById('saFields');

      if (type === 'MC') {
        mcFields.classList.remove('hidden');
        saFields.classList.add('hidden');
      } else {
        mcFields.classList.add('hidden');
        saFields.classList.remove('hidden');
      }
    }

    function handleSave(e) {
      e.preventDefault();
      const form = e.target;
      const qId = form.questionId.value || null;

      // Construct Backend Object
      const options = [
        { text: form.choiceA_Text.value, imageURL: '' },
        { text: form.choiceB_Text.value, imageURL: '' },
        { text: form.choiceC_Text.value, imageURL: '' },
        { text: form.choiceD_Text.value, imageURL: '' }
      ];

      const correctVal = form.querySelector('input[name="correctOption"]:checked')?.value || '';
      const correctIndex = ['A', 'B', 'C', 'D'].indexOf(correctVal);

      // Tags
      const tags = form.tagsCsv.value.split(',').map(t => t.trim()).filter(Boolean);
      if (form.unitTag.value) tags.push(form.unitTag.value);
      if (form.topicTag.value) tags.push(form.topicTag.value);

      const qData = {
        id: qId,
        text: form.stemHtml.value,
        options: options,
        correctAnswer: correctIndex >= 0 ? correctIndex : 0,
        tags: tags,
        difficulty: form.difficulty.value
      };

      const btn = form.querySelector('button[type="submit"]');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Saving...';

      const manageQuestionBank = firebase.functions().httpsCallable('manageQuestionBank');
      manageQuestionBank({ action: 'SAVE', questionData: qData })
        .then(result => {
          closeQuestionModal();
          loadQuestions();
          btn.disabled = false;
          btn.textContent = originalText;
        }).catch(err => {
          alert('Error: ' + err.message);
          btn.disabled = false;
          btn.textContent = originalText;
        });
    }

    function deleteQuestion(id) {
      if (confirm('Are you sure?')) {
        const manageQuestionBank = firebase.functions().httpsCallable('manageQuestionBank');
        manageQuestionBank({ action: 'DELETE', questionData: { id: id } })
          .then(res => {
            loadQuestions();
          }).catch(err => {
            alert(err.message);
          });
      }
    }
  </script>
</body>

</html>