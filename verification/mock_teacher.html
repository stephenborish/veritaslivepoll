<!DOCTYPE html>
<html>
<head>
    <title>Mock Teacher Dashboard</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #loader { display: none; background: #eee; padding: 10px; }
        #live-poll-view { margin-top: 20px; padding: 20px; border: 2px solid green; background: #e0ffe0; }
        .hidden { display: none; }
        .flex { display: flex; }
        /* Mock tailwind lg:flex behavior */
        @media (min-width: 1024px) {
            .lg\:flex { display: flex !important; }
        }
    </style>
</head>
<body>
    <h1>Frontend Verification</h1>
    <div id="loader">Loading...</div>

    <!-- UI Elements -->
    <!-- Sidebar with lg:flex class -->
    <aside id="dashboard-sidebar" class="hidden lg:flex w-64 bg-gray-800 text-white p-4">
        Sidebar Content
    </aside>

    <div id="dashboard"></div>
    <div id="live-view"></div>
    <div id="roster-manager"></div>
    <div id="archived-view"></div>
    <div id="analytics-view"></div>

    <select id="poll-select"><option value="poll_test_123">Poll 1</option></select>
    <select id="class-filter"></select>
    <div id="student-table-body"></div>
    <div id="poll-details-card"></div>
    <button id="start-poll-btn">Start Session</button>

    <button id="dashboard-sidebar-toggle-live">Toggle Sidebar</button>
    <button id="header-start-btn" class="hidden"></button>

    <div id="header-default"></div>
    <div id="header-live"></div>

    <!-- Mocks -->
    <script>
        window.SecureAssessmentShared = {
            createHeartbeat: function() { return { start: function(){}, stop: function(){} }; }
        };

        var firebase = {
            apps: [],
            initializeApp: function() {},
            database: function() {
                return { ref: function() { return { on: function(){}, off: function(){} } } }
            },
            ServerValue: { TIMESTAMP: 12345 }
        };
        firebase.database.ServerValue = { TIMESTAMP: 12345 };

        var FIREBASE_CONFIG = {};

        var google = {
            script: {
                run: {
                    withSuccessHandler: function(success) {
                        return {
                            withFailureHandler: function(failure) {
                                return {
                                    getLivePollData: function(pollId, qIndex) {
                                        console.log('Mock: getLivePollData called');
                                        setTimeout(function() {
                                            console.log('Mock: Server returning full data');
                                            try {
                                                success({
                                                    pollId: pollId,
                                                    questionIndex: qIndex,
                                                    status: 'LIVE',
                                                    metadata: { sessionPhase: 'LIVE', resultsVisibility: 'HIDDEN' },
                                                    calculatorEnabled: false,
                                                    questions: [{text: 'Q1'}],
                                                    correctAnswer: 'A'
                                                });
                                            } catch (e) {
                                                console.error('Mock: Success handler CRASHED:', e);
                                            }
                                        }, 100);
                                    },
                                    startPoll: function(pollId) { console.log('Mock: startPoll'); },
                                    withUserObject: function() { return this; }
                                }
                            }
                        }
                    }
                }
            }
        };

        function veritasAlert(msg) { console.log('Alert:', msg); }
        function previewOnlyNotice() {}
        function showDashboard() {}
        function setButtonLoading(btn, loading) {
            if(btn) btn.innerText = loading ? 'Loading...' : 'Start Session';
        }
        function initFirebaseMissionControl() {}
        function handleError(e) { console.error("handleError:", e); }

    </script>

    <!-- Load the extracted script -->
    <script src="Teacher_Scripts_Content.js"></script>

    <script>
        window.onload = function() {
            setTimeout(function() {
                console.log('--- TEST 1: Fallback Logic ---');

                // Ensure CURRENT_POLL_DATA is in "bad" state
                if (typeof CURRENT_POLL_DATA !== 'undefined') {
                    CURRENT_POLL_DATA = {};
                }

                var data = {
                    mode: 'lightweight',
                    pollId: 'poll_test_123',
                    questionIndex: 0,
                    status: 'OPEN',
                    metadata: { sessionPhase: 'LIVE' }
                };

                try {
                    handleLightweightSessionUpdate(data);
                } catch (e) {
                    console.error('Error running handleLightweightSessionUpdate:', e);
                }

                // Check sidebar after updateLiveView (triggered by fallback)
                setTimeout(function() {
                    console.log('--- TEST 2: Sidebar Visibility ---');
                    var sidebar = document.getElementById('dashboard-sidebar');
                    console.log('Sidebar classes:', sidebar.className);

                    // We expect lg:flex to be REMOVED
                    if (!sidebar.classList.contains('lg:flex') && sidebar.classList.contains('hidden')) {
                        console.log('SUCCESS: Sidebar is correctly hidden (lg:flex removed)');
                    } else {
                        console.error('FAILURE: Sidebar still has lg:flex or is not hidden');
                    }
                }, 1000);

            }, 500);
        };
    </script>
</body>
</html>
