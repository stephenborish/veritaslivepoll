<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veritas Live Poll - Teacher Dashboard</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            // Veritas Brand Colors (Primary Design System)
            "veritas-navy": "#12385d",
            "veritas-gold": "#c5a05a",
            primary: "#12385d",
            // Supporting Brand Colors
            "brand-white": "#ffffff",
            "brand-light-gray": "#d9e0e7",
            "brand-dark-gray": "#242424",
            "background-light": "#f7f8fa",
            "background-dark": "#0f1723",
            // Semantic Colors
            "success-green": "#1b5e20",
            "success-bg": "#e8f5ec",
            "error-red": "#c62828",
            "text-primary": "#111111",
            "text-secondary": "#4b5563",
            "text-muted": "#6b7280"
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
            serif: ["Noto Serif", "serif"]
          },
          borderRadius: {
            DEFAULT: "0.25rem",
            lg: "0.5rem",
            xl: "0.75rem",
            "2xl": "1rem",
            full: "9999px"
          },
          spacing: {
            '18': '4.5rem',
            '88': '22rem',
            '128': '32rem'
          },
          animation: {
            'fade-up': 'fadeUp 0.4s ease-out forwards',
            'pulse-glow': 'pulseGlow 3s ease-in-out infinite'
          },
          keyframes: {
            fadeUp: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            },
            pulseGlow: {
              '0%, 100%': { boxShadow: '0 0 0 0 rgba(197, 160, 90, 0.4)' },
              '50%': { boxShadow: '0 0 20px 4px rgba(197, 160, 90, 0.4)' }
            }
          }
        }
      }
    };
  </script>

  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style type="text/tailwindcss">
    @layer utilities {
      .correct-answer-bg {
        background-image: repeating-linear-gradient(
          45deg,
          rgba(217, 224, 231, 0.7),
          rgba(217, 224, 231, 0.7) 10px,
          rgba(217, 224, 231, 1) 10px,
          rgba(217, 224, 231, 1) 20px
        );
      }
      .dark .correct-answer-bg {
        background-image: repeating-linear-gradient(
          45deg,
          rgba(0, 46, 109, 0.2),
          rgba(0, 46, 109, 0.2) 10px,
          rgba(0, 46, 109, 0.3) 10px,
          rgba(0, 46, 109, 0.3) 20px
        );
      }
    }
  </style>
  <style>
    /* Veritas Design System - CSS Custom Properties */
    :root {
      /* Brand Colors */
      --veritas-navy: #12385d;
      --veritas-gold: #c5a05a;
      --brand-white: #ffffff;
      --brand-light-gray: #d9e0e7;
      --brand-dark-gray: #242424;

      /* Background Colors */
      --bg-light: #f7f8fa;
      --bg-dark: #0f1723;
      --bg-card: #ffffff;
      --bg-elevated: #f8fafc;

      /* Text Colors */
      --text-primary: #111111;
      --text-secondary: #4b5563;
      --text-muted: #6b7280;
      --text-on-navy: #ffffff;

      /* Semantic Colors */
      --success-green: #1b5e20;
      --success-light: #2e7d32;
      --success-bg: #e8f5ec;
      --success-bg-light: #ecfdf5;
      --error-red: #c62828;

      /* Opacity Modifiers */
      --navy-06: rgba(18, 56, 93, 0.06);
      --navy-10: rgba(18, 56, 93, 0.1);
      --navy-12: rgba(18, 56, 93, 0.12);
      --navy-14: rgba(18, 56, 93, 0.14);
      --gold-08: rgba(197, 160, 90, 0.08);

      /* Spacing Scale (following 8px baseline) */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --space-2xl: 48px;

      /* Border Radius */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 14px;
      --radius-xl: 16px;
      --radius-full: 9999px;
    }

    .teacher-question-image {
      position: relative;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: var(--navy-06);
      border: 1px solid var(--navy-12);
    }

    .teacher-question-image-el {
      width: 100%;
      max-height: 360px;
      object-fit: contain;
      display: block;
      background: var(--bg-card);
    }

    .teacher-question-image-zoom {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(18, 24, 40, 0.45);
      color: var(--brand-white);
      opacity: 0;
      transition: opacity 180ms ease;
      border: none;
      cursor: pointer;
    }

    .teacher-question-image:hover .teacher-question-image-zoom,
    .teacher-question-image-zoom:focus-visible {
      opacity: 1;
    }

    .teacher-question-image-zoom:focus-visible {
      outline: 3px solid rgba(18, 56, 93, 0.45);
      outline-offset: 2px;
    }

    .teacher-result-card {
      position: relative;
      overflow: hidden;
      border-radius: var(--radius-md);
      border: 1px solid var(--navy-14);
      background: var(--bg-card);
      box-shadow: 0 1px 4px rgba(18, 56, 93, 0.06);
      margin-bottom: 10px;
    }

    .teacher-result-card:last-child {
      margin-bottom: 0;
    }

    .teacher-result-progress {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0%;
      background: rgba(18, 56, 93, 0.12);
      transition: width 220ms ease;
    }

    .teacher-result-progress.is-correct {
      background: rgba(46, 125, 50, 0.2);
    }

    .teacher-result-content-row {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: stretch;
      gap: 12px;
      padding: 12px 16px;
    }

    .teacher-result-leading {
      display: flex;
      align-items: center;
    }

    .teacher-result-letter {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--navy-12);
      color: var(--veritas-navy);
      font-weight: 700;
      font-size: 0.95rem;
    }

    .teacher-result-body {
      flex: 1;
      display: flex;
      gap: 10px;
      align-items: flex-start;
      min-width: 0;
    }

    .teacher-result-image-wrap {
      width: 80px;
      max-width: 80px;
      flex-shrink: 0;
    }

    .teacher-result-image {
      width: 100%;
      max-height: 80px;
      object-fit: contain;
      border-radius: 6px;
      border: 1px solid rgba(18, 56, 93, 0.18);
      background: var(--bg-elevated);
    }

    .teacher-result-text {
      color: var(--veritas-navy);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .teacher-result-text--empty {
      font-style: italic;
      color: var(--text-muted);
    }

    .teacher-result-percentage {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
      gap: 2px;
      min-width: 70px;
      color: var(--veritas-navy);
      font-weight: 700;
    }

    .teacher-result-percentage span:first-child {
      font-size: 0.95rem;
    }

    .teacher-result-count {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .teacher-result-students {
      position: relative;
      z-index: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px 16px 10px;
      border-top: 1px solid var(--navy-12);
      background: var(--navy-06);
    }

    .teacher-result-student {
      font-size: 0.7rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: var(--radius-full);
      background: rgba(18, 56, 93, 0.15);
      color: var(--veritas-navy);
    }

    .teacher-result-card.is-correct {
      border-color: rgba(46, 125, 50, 0.4);
      background: var(--success-bg);
    }

    .teacher-result-card.is-correct .teacher-result-letter {
      background: rgba(46, 125, 50, 0.22);
      color: var(--success-green);
    }

    .teacher-result-card.is-correct .teacher-result-text {
      color: var(--success-green);
    }

    .teacher-result-card.is-correct .teacher-result-count {
      color: var(--success-light);
    }

    .teacher-result-card.is-correct .teacher-result-students {
      border-color: rgba(46, 125, 50, 0.28);
      background: rgba(46, 125, 50, 0.16);
    }

    .teacher-result-card.is-correct .teacher-result-student {
      background: rgba(46, 125, 50, 0.2);
      color: var(--success-green);
    }

    .dark .teacher-question-image {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.18);
    }

    .dark .teacher-question-image-el {
      background: transparent;
    }

    .dark .teacher-question-image-zoom {
      background: rgba(15, 23, 42, 0.65);
    }

    .dark .teacher-result-card {
      background: rgba(15, 23, 35, 0.78);
      border-color: rgba(148, 163, 184, 0.28);
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.4);
    }

    .dark .teacher-result-progress {
      background: rgba(59, 130, 246, 0.28);
    }

    .dark .teacher-result-letter {
      background: rgba(148, 163, 184, 0.25);
      color: #e2e8f0;
    }

    .dark .teacher-result-text {
      color: #f8fafc;
    }

    .dark .teacher-result-count {
      color: #cbd5f5;
    }

    .dark .teacher-result-students {
      border-color: rgba(148, 163, 184, 0.25);
      background: rgba(148, 163, 184, 0.16);
    }

    .dark .teacher-result-student {
      background: rgba(148, 163, 184, 0.3);
      color: #f8fafc;
    }

    .dark .teacher-result-card.is-correct {
      background: rgba(34, 197, 94, 0.22);
      border-color: rgba(34, 197, 94, 0.45);
    }

    .dark .teacher-result-card.is-correct .teacher-result-letter {
      background: rgba(34, 197, 94, 0.32);
      color: #ecfdf5;
    }

    .dark .teacher-result-card.is-correct .teacher-result-text {
      color: #ecfdf5;
    }

    .dark .teacher-result-card.is-correct .teacher-result-count {
      color: #bbf7d0;
    }

    .dark .teacher-result-card.is-correct .teacher-result-students {
      border-color: rgba(34, 197, 94, 0.45);
      background: rgba(34, 197, 94, 0.3);
    }

    .dark .teacher-result-card.is-correct .teacher-result-student {
      background: rgba(34, 197, 94, 0.4);
      color: #052e16;
    }

    @media (max-width: 768px) {
      .teacher-result-content-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .teacher-result-percentage {
        flex-direction: row;
        align-items: center;
        gap: 8px;
      }

      .teacher-result-image-wrap {
        width: 100%;
        max-width: 100%;
      }

      .teacher-result-image {
        max-height: 220px;
      }
    }

    .veritas-modal-root {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .veritas-modal-root.is-active {
      display: flex;
    }

    .veritas-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(9, 17, 34, 0.55);
      backdrop-filter: blur(3px);
    }

    .veritas-modal-dialog {
      position: relative;
      z-index: 1;
      width: min(520px, 92vw);
      border-radius: 16px;
      background: #ffffff;
      border-top: 4px solid #c5a05a;
      box-shadow: 0 24px 48px rgba(9, 17, 34, 0.25);
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      animation: veritas-modal-in 220ms ease;
    }

    .veritas-modal-header h2 {
      margin: 0;
      font-size: 1.25rem;
      color: #12385d;
      font-weight: 700;
    }

    .veritas-modal-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
      color: #1c1c1c;
      font-size: 0.98rem;
      line-height: 1.55;
    }

    .veritas-modal-subtext {
      color: #4b5563;
      font-size: 0.85rem;
    }

    .veritas-modal-input {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .veritas-modal-input input {
      border-radius: 10px;
      border: 1px solid rgba(18, 56, 93, 0.28);
      padding: 10px 12px;
      font-size: 0.95rem;
      transition: border-color 160ms ease, box-shadow 160ms ease;
    }

    .veritas-modal-input input:focus-visible {
      outline: none;
      border-color: #12385d;
      box-shadow: 0 0 0 3px rgba(18, 56, 93, 0.2);
    }

    .veritas-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }

    .veritas-modal-button {
      border: none;
      border-radius: 999px;
      padding: 10px 22px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 140ms ease, box-shadow 140ms ease, background-color 140ms ease, color 140ms ease;
    }

    .veritas-modal-button.primary {
      background: #12385d;
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(18, 56, 93, 0.25);
    }

    .veritas-modal-button.primary:hover:not([disabled]) {
      background: #0f2d4a;
      transform: translateY(-1px);
    }

    .veritas-modal-button.secondary {
      background: transparent;
      color: #12385d;
      border: 1px solid rgba(18, 56, 93, 0.3);
    }

    .veritas-modal-button.secondary:hover:not([disabled]) {
      background: rgba(18, 56, 93, 0.08);
    }

    .veritas-modal-button.destructive {
      background: #c62828;
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(198, 40, 40, 0.25);
    }

    .veritas-modal-button.destructive:hover:not([disabled]) {
      background: #a61b1b;
    }

    .veritas-modal-button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .veritas-modal-spinner {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.6);
      border-top-color: transparent;
      animation: veritas-spin 0.7s linear infinite;
      display: none;
      margin-left: 10px;
    }

    .veritas-modal-button.loading .veritas-modal-spinner {
      display: inline-block;
    }

    .veritas-modal-button.loading span {
      opacity: 0.75;
    }

    .dark .veritas-modal-dialog {
      background: rgba(15, 23, 35, 0.96);
      color: #e2e8f0;
      border-top-color: #c5a05a;
      box-shadow: 0 24px 48px rgba(2, 6, 23, 0.55);
    }

    .dark .veritas-modal-header h2 {
      color: #f8fafc;
    }

    .dark .veritas-modal-body {
      color: #f1f5f9;
    }

    .dark .veritas-modal-subtext {
      color: #cbd5f5;
    }

    .dark .veritas-modal-input input {
      background: rgba(15, 23, 42, 0.7);
      border-color: rgba(148, 163, 184, 0.4);
      color: #f8fafc;
    }

    .dark .veritas-modal-input input:focus-visible {
      border-color: #93c5fd;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35);
    }

    .dark .veritas-modal-button.secondary {
      color: #e2e8f0;
      border-color: rgba(148, 163, 184, 0.4);
    }

    .dark .veritas-modal-button.secondary:hover:not([disabled]) {
      background: rgba(148, 163, 184, 0.16);
    }

    .dark .veritas-modal-button.primary {
      background: #234776;
    }

    .dark .veritas-modal-button.primary:hover:not([disabled]) {
      background: #1a3456;
    }

    .dark .veritas-modal-backdrop {
      background: rgba(2, 6, 23, 0.7);
      backdrop-filter: blur(4px);
    }

    body.veritas-modal-open {
      overflow: hidden;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @keyframes veritas-modal-in {
      from {
        opacity: 0;
        transform: translateY(16px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes veritas-spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 480px) {
      .veritas-modal-dialog {
        width: min(92vw, 360px);
        padding: 22px;
        gap: 16px;
      }

      .veritas-modal-actions {
        width: 100%;
        justify-content: stretch;
      }

      .veritas-modal-button {
        flex: 1;
      }
    }

    /* New Dashboard Styles */
    .sidebar-nav-btn {
      background: transparent;
      color: rgba(255, 255, 255, 0.72);
      transition: background-color 160ms ease, color 160ms ease, box-shadow 160ms ease;
    }

    .sidebar-nav-btn .material-symbols-outlined {
      transition: transform 160ms ease, color 160ms ease;
    }

    .sidebar-nav-btn:hover {
      background: rgba(255, 255, 255, 0.12);
      color: #ffffff;
    }

    .sidebar-nav-btn:hover .material-symbols-outlined {
      transform: translateX(2px);
    }

    .sidebar-nav-btn.is-active,
    .sidebar-nav-btn[aria-current="page"] {
      background: rgba(255, 255, 255, 0.18);
      color: #ffffff;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.15);
    }

    .sidebar-nav-btn.is-active .material-symbols-outlined,
    .sidebar-nav-btn[aria-current="page"] .material-symbols-outlined {
      color: #ffffff;
      transform: translateX(2px);
    }

    .question-nav-item.dragging {
      opacity: 0.55;
    }

    .question-nav-item.drop-before::before,
    .question-nav-item.drop-after::after {
      content: '';
      position: absolute;
      left: 12px;
      right: 12px;
      height: 2px;
      background: var(--veritas-gold);
      border-radius: 9999px;
    }

    .question-nav-item.drop-before::before {
      top: -4px;
    }

    .question-nav-item.drop-after::after {
      bottom: -4px;
    }

    .dashboard-card {
      background: white;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 2px 8px rgba(18, 56, 93, 0.08);
      transition: all 200ms ease;
      animation: fadeUp 0.4s ease-out forwards;
      opacity: 0;
    }

    .dashboard-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(18, 56, 93, 0.12);
    }

    .dashboard-card.primary-cta {
      background: linear-gradient(135deg, #12385d 0%, #0f2d4a 100%);
      color: white;
      border-top: 4px solid #c5a05a;
    }

    .dashboard-card-title {
      font-size: 20px;
      font-weight: 600;
      color: #12385d;
      margin-bottom: 8px;
    }

    .dashboard-card.primary-cta .dashboard-card-title {
      color: white;
    }

    .dashboard-card-subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 20px;
    }

    .dashboard-card.primary-cta .dashboard-card-subtitle {
      color: rgba(255, 255, 255, 0.8);
    }

    .dashboard-cta-button {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      border-radius: 9999px;
      font-weight: 600;
      font-size: 15px;
      transition: all 140ms ease;
      cursor: pointer;
      border: none;
    }

    .dashboard-cta-button:hover {
      transform: translateY(-1px);
    }

    .dashboard-cta-button.primary {
      background: #c5a05a;
      color: white;
      box-shadow: 0 4px 12px rgba(197, 160, 90, 0.3);
    }

    .dashboard-cta-button.primary:hover {
      background: #b8954f;
      box-shadow: 0 6px 16px rgba(197, 160, 90, 0.4);
    }

    .dashboard-cta-button.secondary {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .dashboard-cta-button.secondary:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .dashboard-list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid rgba(18, 56, 93, 0.08);
      transition: all 140ms ease;
    }

    .dashboard-list-item:last-child {
      border-bottom: none;
    }

    .dashboard-list-item:hover {
      padding-left: 8px;
    }

    .dashboard-stat-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 9999px;
      font-size: 13px;
      font-weight: 600;
    }

    .dashboard-stat-badge.success {
      background: rgba(34, 197, 94, 0.15);
      color: #16a34a;
    }

    .dashboard-stat-badge.warning {
      background: rgba(245, 158, 11, 0.15);
      color: #d97706;
    }

    .dashboard-stat-badge.neutral {
      background: rgba(18, 56, 93, 0.1);
      color: #12385d;
    }

    .dashboard-quick-tool {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 20px;
      background: rgba(18, 56, 93, 0.04);
      border-radius: 12px;
      transition: all 180ms ease;
      cursor: pointer;
      text-decoration: none;
      color: #12385d;
    }

    .dashboard-quick-tool:hover {
      background: rgba(18, 56, 93, 0.08);
      transform: translateY(-2px);
    }

    .dashboard-quick-tool .icon {
      font-size: 32px;
      transition: transform 180ms ease;
    }

    .dashboard-quick-tool:hover .icon {
      transform: rotate(15deg);
    }

    .dashboard-icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(18, 56, 93, 0.06);
      color: #12385d;
      transition: all 160ms ease;
      cursor: pointer;
      border: none;
    }

    .dashboard-icon-btn:hover {
      background: rgba(18, 56, 93, 0.12);
      transform: scale(1.05);
    }

    .dashboard-status-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      border-radius: 9999px;
      font-size: 13px;
      font-weight: 600;
      background: rgba(148, 163, 184, 0.15);
      color: #475569;
    }

    .dashboard-status-chip.active {
      background: rgba(34, 197, 94, 0.15);
      color: #16a34a;
    }

    .dashboard-status-chip .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .dashboard-status-chip.active .dot {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .activity-chart-placeholder {
      width: 100%;
      height: 180px;
      background: linear-gradient(to top, rgba(197, 160, 90, 0.1), rgba(18, 56, 93, 0.05));
      border-radius: 8px;
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      padding: 20px;
      gap: 8px;
    }

    .activity-bar {
      flex: 1;
      background: linear-gradient(to top, #c5a05a, #12385d);
      border-radius: 4px 4px 0 0;
      min-height: 20px;
      transition: all 300ms ease;
    }

    .activity-bar:hover {
      filter: brightness(1.2);
      transform: scaleY(1.05);
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(18px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulseGlow {
      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(197, 160, 90, 0.35);
      }
      50% {
        box-shadow: 0 0 18px 3px rgba(197, 160, 90, 0.45);
      }
    }


    /* Stagger animation delays */
    .dashboard-card:nth-child(1) { animation-delay: 0ms; }
    .dashboard-card:nth-child(2) { animation-delay: 100ms; }
    .dashboard-card:nth-child(3) { animation-delay: 200ms; }
    .dashboard-card:nth-child(4) { animation-delay: 300ms; }

    @media (max-width: 768px) {
      .dashboard-card {
        padding: 20px;
      }
    }

    /* Timer animations */
    @keyframes timer-flash {
      0%, 100% { color: inherit; }
      50% { color: #0ea5e9; } /* sky-500 */
    }

    .timer-finished {
      animation: timer-flash 0.5s 2;
    }

    /* Ensure tabular numbers for timer display */
    #timer-display {
      font-feature-settings: 'tnum';
      font-variant-numeric: tabular-nums;
    }

    /* Slow pulse animation for violations */
    @keyframes pulse-slow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.95; }
    }

    .animate-pulse-slow {
      animation: pulse-slow 2s ease-in-out infinite;
    }

    /* ENHANCED TIMER VISUAL FEEDBACK SYSTEM */
    /* Timer state classes - applied dynamically based on time remaining */
    .timer-warning {
      background: rgba(245, 158, 11, 0.25) !important;
      border-color: rgba(245, 158, 11, 0.4) !important;
    }

    .timer-warning #timer-display,
    .timer-warning #timer-display-compact {
      color: #fbbf24 !important; /* amber-400 */
    }

    .timer-critical {
      background: rgba(239, 68, 68, 0.25) !important;
      border-color: rgba(239, 68, 68, 0.5) !important;
      animation: timer-pulse-critical 1s ease-in-out infinite;
    }

    .timer-critical #timer-display,
    .timer-critical #timer-display-compact {
      color: #f87171 !important; /* red-400 */
    }

    @keyframes timer-pulse-critical {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
      }
      50% {
        box-shadow: 0 0 20px 4px rgba(239, 68, 68, 0.6);
      }
    }

    /* Next Question button pulse when ready */
    .pulse-ready {
      animation: pulse-glow-gold 2s ease-in-out infinite;
    }

    @keyframes pulse-glow-gold {
      0%, 100% {
        box-shadow: 0 4px 12px rgba(197, 160, 90, 0.4);
      }
      50% {
        box-shadow: 0 8px 24px rgba(197, 160, 90, 0.7), 0 0 40px rgba(197, 160, 90, 0.3);
      }
    }

    /* Student tile animations for attention */
    .student-needs-attention {
      animation: border-pulse 2s ease-in-out infinite;
    }

    @keyframes border-pulse {
      0%, 100% {
        border-color: rgba(239, 68, 68, 0.5);
      }
      50% {
        border-color: rgba(239, 68, 68, 1);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
      }
    }

    /* Celebration animation for all-responded */
    @keyframes celebrate-bounce {
      0%, 100% {
        transform: scale(1);
      }
      25% {
        transform: scale(1.05);
      }
      50% {
        transform: scale(0.95);
      }
      75% {
        transform: scale(1.02);
      }
    }

    .celebrate {
      animation: celebrate-bounce 0.6s ease-out;
    }

    /* ========================================
       ðŸŽ¨ ENHANCED DESIGN SYSTEM v2.0
       Optimized for Live Classroom Scenarios
       ======================================== */

    /* === FLOATING ACTION BUTTON (FAB) SYSTEM === */
    .fab-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1000;
      display: flex;
      flex-direction: column-reverse;
      align-items: flex-end;
      gap: 12px;
    }

    .fab-main {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--veritas-navy), #0f2d4a);
      color: white;
      border: none;
      box-shadow: 0 8px 24px rgba(18, 56, 93, 0.35),
                  0 0 0 0 rgba(197, 160, 90, 0.4);
      cursor: pointer;
      transition: all 280ms cubic-bezier(0.34, 1.56, 0.64, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .fab-main:hover {
      transform: scale(1.08) rotate(5deg);
      box-shadow: 0 12px 32px rgba(18, 56, 93, 0.45),
                  0 0 40px rgba(197, 160, 90, 0.3);
    }

    .fab-main:active {
      transform: scale(0.95);
    }

    .fab-main .material-symbols-outlined {
      font-size: 28px;
      transition: transform 280ms ease;
    }

    .fab-main.is-open .material-symbols-outlined {
      transform: rotate(45deg);
    }

    .fab-menu {
      display: flex;
      flex-direction: column-reverse;
      gap: 12px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(20px);
      transition: all 320ms cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .fab-menu.is-open {
      opacity: 1;
      pointer-events: all;
      transform: translateY(0);
    }

    .fab-action {
      display: flex;
      align-items: center;
      gap: 12px;
      animation: fab-slide-in 320ms cubic-bezier(0.34, 1.56, 0.64, 1) both;
    }

    .fab-action:nth-child(1) { animation-delay: 50ms; }
    .fab-action:nth-child(2) { animation-delay: 100ms; }
    .fab-action:nth-child(3) { animation-delay: 150ms; }
    .fab-action:nth-child(4) { animation-delay: 200ms; }

    @keyframes fab-slide-in {
      from {
        opacity: 0;
        transform: translateX(20px) scale(0.8);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    .fab-label {
      background: rgba(18, 56, 93, 0.95);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transition: opacity 200ms ease;
    }

    .fab-action:hover .fab-label {
      opacity: 1;
    }

    .fab-button {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      transition: all 200ms ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .fab-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
    }

    .fab-button.fab-primary {
      background: linear-gradient(135deg, #c5a05a, #b8954f);
      color: white;
    }

    .fab-button.fab-success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .fab-button.fab-info {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
    }

    .fab-button.fab-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    /* === TOAST NOTIFICATION SYSTEM === */
    .toast-container {
      position: fixed;
      top: 80px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 420px;
    }

    .toast {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15),
                  0 2px 8px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      animation: toast-slide-in 320ms cubic-bezier(0.34, 1.56, 0.64, 1) both;
      border-left: 4px solid currentColor;
      position: relative;
      overflow: hidden;
    }

    @keyframes toast-slide-in {
      from {
        opacity: 0;
        transform: translateX(100%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    .toast.toast-out {
      animation: toast-slide-out 280ms ease-out both;
    }

    @keyframes toast-slide-out {
      to {
        opacity: 0;
        transform: translateX(100%) scale(0.9);
      }
    }

    .toast-success {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95));
      color: white;
    }

    .toast-error {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
      color: white;
    }

    .toast-warning {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(217, 119, 6, 0.95));
      color: white;
    }

    .toast-info {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
      color: white;
    }

    .toast-icon {
      flex-shrink: 0;
      font-size: 24px;
      animation: toast-icon-pop 400ms cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes toast-icon-pop {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .toast-content {
      flex: 1;
      min-width: 0;
    }

    .toast-title {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .toast-message {
      font-size: 0.85rem;
      opacity: 0.95;
      line-height: 1.4;
    }

    .toast-close {
      flex-shrink: 0;
      background: none;
      border: none;
      color: currentColor;
      cursor: pointer;
      padding: 4px;
      opacity: 0.7;
      transition: opacity 150ms ease;
      border-radius: 4px;
    }

    .toast-close:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.1);
    }

    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: rgba(255, 255, 255, 0.3);
      transform-origin: left;
      animation: toast-progress 5s linear;
    }

    @keyframes toast-progress {
      from { transform: scaleX(1); }
      to { transform: scaleX(0); }
    }

    /* === PROGRESS RING ANIMATIONS === */
    .progress-ring-container {
      position: relative;
      width: 52px;
      height: 52px;
    }

    .progress-ring {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }

    .progress-ring-circle-bg {
      fill: none;
      stroke: rgba(18, 56, 93, 0.1);
      stroke-width: 4;
    }

    .dark .progress-ring-circle-bg {
      stroke: rgba(255, 255, 255, 0.08);
    }

    .progress-ring-circle {
      fill: none;
      stroke: var(--veritas-navy);
      stroke-width: 4;
      stroke-linecap: round;
      transition: stroke-dashoffset 500ms cubic-bezier(0.4, 0, 0.2, 1),
                  stroke 300ms ease;
    }

    .dark .progress-ring-circle {
      stroke: rgba(59, 130, 246, 0.85);
    }

    .progress-ring-circle.ring-success {
      stroke: #10b981;
    }

    .progress-ring-circle.ring-warning {
      stroke: #f59e0b;
    }

    .progress-ring-circle.ring-danger {
      stroke: #ef4444;
    }

    .progress-ring-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--veritas-navy);
    }

    .dark .progress-ring-text {
      color: white;
    }

    /* === SPARKLINE TREND VISUALIZATION === */
    .sparkline-container {
      width: 100%;
      height: 28px;
      margin-top: 8px;
    }

    .sparkline {
      width: 100%;
      height: 100%;
    }

    .sparkline-line {
      fill: none;
      stroke: var(--veritas-gold);
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: 0.7;
    }

    .sparkline-area {
      fill: url(#sparkline-gradient);
      opacity: 0.3;
    }

    .sparkline-dot {
      fill: var(--veritas-gold);
      r: 3;
      opacity: 0;
      transition: opacity 200ms ease;
    }

    .sparkline-container:hover .sparkline-dot {
      opacity: 1;
    }

    /* === ENHANCED HUD CARDS WITH PROGRESS === */
    .hud-card-enhanced {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .hud-card-progress {
      flex-shrink: 0;
    }

    .hud-card-info {
      flex: 1;
      min-width: 0;
    }

    /* === AMBIENT STATE INDICATORS === */
    .ambient-state-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 5;
      transition: background-color 600ms ease;
    }

    .ambient-state-overlay.state-normal {
      background: transparent;
    }

    .ambient-state-overlay.state-all-responded {
      background: radial-gradient(circle at top,
                                  rgba(16, 185, 129, 0.08) 0%,
                                  transparent 60%);
      animation: ambient-pulse-success 3s ease-in-out infinite;
    }

    .ambient-state-overlay.state-time-critical {
      background: radial-gradient(circle at top,
                                  rgba(245, 158, 11, 0.08) 0%,
                                  transparent 60%);
      animation: ambient-pulse-warning 2s ease-in-out infinite;
    }

    .ambient-state-overlay.state-lockouts {
      background: radial-gradient(circle at top,
                                  rgba(239, 68, 68, 0.08) 0%,
                                  transparent 60%);
      animation: ambient-pulse-danger 1.5s ease-in-out infinite;
    }

    @keyframes ambient-pulse-success {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    @keyframes ambient-pulse-warning {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    @keyframes ambient-pulse-danger {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    /* === KEYBOARD SHORTCUT HINTS === */
    .kbd-hint {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(18, 56, 93, 0.1);
      border: 1px solid rgba(18, 56, 93, 0.2);
      font-size: 0.7rem;
      font-weight: 600;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      color: var(--veritas-navy);
      margin-left: 6px;
      opacity: 0;
      transition: opacity 200ms ease;
    }

    .dark .kbd-hint {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
      color: white;
    }

    button:hover .kbd-hint,
    button:focus .kbd-hint {
      opacity: 0.7;
    }

    /* === GESTURE HINT SYSTEM === */
    .gesture-hint {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: 8px;
      padding: 6px 12px;
      background: rgba(18, 56, 93, 0.95);
      color: white;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 200ms ease, transform 200ms ease;
      z-index: 1000;
    }

    .gesture-hint::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(18, 56, 93, 0.95);
    }

    *:hover > .gesture-hint,
    *:focus > .gesture-hint {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    /* === ENHANCED POLL CARDS === */
    .poll-card-enhanced {
      position: relative;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(18, 56, 93, 0.08);
      transition: all 280ms cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: pointer;
      border: 2px solid transparent;
    }

    .dark .poll-card-enhanced {
      background: rgba(15, 23, 35, 0.7);
      border-color: rgba(255, 255, 255, 0.05);
    }

    .poll-card-enhanced:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(18, 56, 93, 0.16);
      border-color: var(--veritas-gold);
    }

    .poll-card-preview {
      height: 140px;
      background: linear-gradient(135deg,
                                  rgba(18, 56, 93, 0.08),
                                  rgba(197, 160, 90, 0.08));
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    .poll-card-preview::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L30 60M0 30L60 30' stroke='rgba(18,56,93,0.04)' stroke-width='1' fill='none'/%3E%3C/svg%3E");
    }

    .poll-card-preview-text {
      font-size: 0.9rem;
      line-height: 1.5;
      color: var(--veritas-navy);
      text-align: center;
      max-height: 100%;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      position: relative;
      z-index: 1;
    }

    .poll-card-body {
      padding: 18px;
    }

    .poll-card-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(18, 56, 93, 0.08);
    }

    .poll-card-quick-stat {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    /* === RESPONSIVE ENHANCEMENTS === */
    @media (max-width: 1024px) {
      .fab-container {
        bottom: 16px;
        right: 16px;
      }

      .fab-main {
        width: 56px;
        height: 56px;
      }

      .fab-button {
        width: 48px;
        height: 48px;
      }

      .toast-container {
        right: 16px;
        left: 16px;
        max-width: none;
      }
    }

    @media (max-width: 768px) {
      .fab-container {
        bottom: 12px;
        right: 12px;
      }

      .fab-label {
        display: none;
      }

      .toast-container {
        top: 72px;
      }

      .progress-ring-container {
        width: 44px;
        height: 44px;
      }
    }

    /* === UTILITY ANIMATIONS === */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .shimmer {
      background: linear-gradient(
        90deg,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.3) 50%,
        rgba(255, 255, 255, 0) 100%
      );
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
    }

    @keyframes bounce-subtle {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }

    .bounce-subtle {
      animation: bounce-subtle 2s ease-in-out infinite;
    }

    /* ========================================
       ðŸŽ¨ PHASE 3: ACTIVITY FEED & ENHANCEMENTS
       ======================================== */

    /* === ACTIVITY FEED SYSTEM === */
    .activity-feed {
      position: fixed;
      bottom: 100px;
      right: 24px;
      width: 320px;
      max-height: 400px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(18, 56, 93, 0.2);
      border: 1px solid rgba(18, 56, 93, 0.1);
      display: flex;
      flex-direction: column;
      z-index: 999;
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
      transition: all 300ms cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .dark .activity-feed {
      background: rgba(15, 23, 35, 0.95);
      border-color: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }

    .activity-feed.is-open {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }

    .activity-feed-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(18, 56, 93, 0.1);
    }

    .dark .activity-feed-header {
      border-color: rgba(255, 255, 255, 0.1);
    }

    .activity-feed-title {
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--veritas-navy);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dark .activity-feed-title {
      color: white;
    }

    .activity-feed-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      border-radius: 10px;
      background: var(--veritas-gold);
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
    }

    .activity-feed-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      transition: all 150ms ease;
    }

    .activity-feed-close:hover {
      background: rgba(18, 56, 93, 0.1);
      color: var(--veritas-navy);
    }

    .dark .activity-feed-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .activity-feed-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px 0;
    }

    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 20px;
      border-left: 3px solid transparent;
      transition: all 150ms ease;
      animation: activity-slide-in 300ms cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes activity-slide-in {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .activity-item:hover {
      background: rgba(18, 56, 93, 0.04);
      border-left-color: var(--veritas-gold);
    }

    .dark .activity-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .activity-icon {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .activity-icon.success {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
    }

    .activity-icon.warning {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .activity-icon.error {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .activity-icon.info {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
    }

    .activity-content {
      flex: 1;
      min-width: 0;
    }

    .activity-message {
      font-size: 0.875rem;
      color: var(--text-primary);
      line-height: 1.4;
      margin-bottom: 2px;
    }

    .dark .activity-message {
      color: rgba(255, 255, 255, 0.9);
    }

    .activity-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .activity-feed-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-secondary);
    }

    .activity-feed-empty .material-symbols-outlined {
      font-size: 48px;
      opacity: 0.3;
      margin-bottom: 8px;
    }

    /* === ENHANCED STUDENT STATUS TILES === */
    .student-tile {
      position: relative;
      padding: 12px 16px;
      border-radius: 12px;
      border: 2px solid transparent;
      background: white;
      transition: all 200ms ease;
      cursor: pointer;
    }

    .dark .student-tile {
      background: rgba(15, 23, 35, 0.5);
    }

    .student-tile:hover {
      border-color: var(--veritas-gold);
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(18, 56, 93, 0.15);
    }

    .student-tile.status-correct {
      border-left: 4px solid #10b981;
      background: linear-gradient(to right, rgba(16, 185, 129, 0.08), transparent);
    }

    .student-tile.status-incorrect {
      border-left: 4px solid #ef4444;
      background: linear-gradient(to right, rgba(239, 68, 68, 0.08), transparent);
    }

    .student-tile.status-locked {
      border-left: 4px solid #f59e0b;
      background: linear-gradient(to right, rgba(245, 158, 11, 0.08), transparent);
      animation: pulse-gentle 2s ease-in-out infinite;
    }

    @keyframes pulse-gentle {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }

    .student-tile.status-waiting {
      border-left: 4px solid #94a3b8;
      background: linear-gradient(to right, rgba(148, 163, 184, 0.08), transparent);
    }

    .student-tile-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .student-name {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    .dark .student-name {
      color: rgba(255, 255, 255, 0.95);
    }

    .student-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .student-status-badge.correct {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
    }

    .student-status-badge.incorrect {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .student-status-badge.locked {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .student-status-badge.waiting {
      background: rgba(148, 163, 184, 0.15);
      color: #64748b;
    }

    .student-details {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .student-answer {
      font-weight: 600;
    }

    .student-tile-actions {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      opacity: 0;
      transition: opacity 200ms ease;
    }

    .student-tile:hover .student-tile-actions {
      opacity: 1;
    }

    .student-action-btn {
      flex: 1;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid rgba(18, 56, 93, 0.2);
      background: white;
      color: var(--veritas-navy);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 150ms ease;
    }

    .dark .student-action-btn {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .student-action-btn:hover {
      background: var(--veritas-navy);
      color: white;
      border-color: var(--veritas-navy);
    }

    .dark .student-action-btn:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    /* === ENHANCED MODAL DESIGNS === */
    .modal-section {
      margin-bottom: 24px;
    }

    .modal-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      cursor: pointer;
      user-select: none;
      transition: all 150ms ease;
    }

    .modal-section-header:hover {
      color: var(--veritas-gold);
    }

    .modal-section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .modal-section-toggle {
      transition: transform 200ms ease;
    }

    .modal-section.is-collapsed .modal-section-toggle {
      transform: rotate(-90deg);
    }

    .modal-section-content {
      max-height: 1000px;
      overflow: hidden;
      transition: max-height 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-section.is-collapsed .modal-section-content {
      max-height: 0;
    }

    /* === RESPONSIVE ADJUSTMENTS === */
    @media (max-width: 1024px) {
      .activity-feed {
        width: 280px;
        bottom: 80px;
        right: 16px;
      }
    }

    @media (max-width: 768px) {
      .activity-feed {
        width: calc(100vw - 32px);
        right: 16px;
        left: 16px;
        bottom: 70px;
      }
    }

    /* Session HUD cards for quick-glance metrics */
    .session-hud-surface {
      background: linear-gradient(135deg, rgba(18, 56, 93, 0.04), rgba(197, 160, 90, 0.08));
    }

    .dark .session-hud-surface {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.7), rgba(56, 189, 248, 0.12));
    }

    .session-hud-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .hud-card {
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 8px;
      padding: 18px;
      border-radius: 18px;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(18, 56, 93, 0.08);
      box-shadow: 0 10px 30px -18px rgba(18, 56, 93, 0.45);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .dark .hud-card {
      background: rgba(15, 23, 35, 0.85);
      border-color: rgba(255, 255, 255, 0.05);
      box-shadow: 0 10px 35px -22px rgba(15, 23, 35, 0.9);
    }

    .hud-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 40px -18px rgba(18, 56, 93, 0.4);
    }

    .hud-card-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(17, 24, 39, 0.55);
    }

    .dark .hud-card-label {
      color: rgba(255, 255, 255, 0.55);
    }

    .hud-card-value {
      font-size: 1.85rem;
      font-weight: 800;
      color: var(--veritas-navy);
      letter-spacing: -0.02em;
    }

    .dark .hud-card-value {
      color: rgba(255, 255, 255, 0.92);
    }

    .hud-card-caption {
      font-size: 0.85rem;
      color: rgba(55, 65, 81, 0.75);
    }

    .dark .hud-card-caption {
      color: rgba(226, 232, 240, 0.65);
    }

    .hud-trend {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .hud-trend-up {
      color: #15803d;
    }

    .hud-trend-down {
      color: #b91c1c;
    }

    .hud-trend-steady {
      color: rgba(55, 65, 81, 0.75);
    }

    .dark .hud-trend-steady {
      color: rgba(226, 232, 240, 0.7);
    }

    .hud-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      padding: 4px 10px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .hud-chip[data-variant="ready"] {
      background: rgba(59, 130, 246, 0.12);
      color: #2563eb;
    }

    .hud-chip[data-variant="running"] {
      background: rgba(16, 185, 129, 0.12);
      color: #059669;
    }

    .hud-chip[data-variant="critical"] {
      background: rgba(248, 113, 113, 0.18);
      color: #dc2626;
      animation: timer-pulse-critical 1s ease-in-out infinite;
    }

    .hud-chip[data-variant="paused"] {
      background: rgba(148, 163, 184, 0.16);
      color: rgba(30, 41, 59, 0.8);
    }

    .hud-chip[data-variant="complete"] {
      background: rgba(34, 197, 94, 0.18);
      color: #15803d;
    }

    @media (max-width: 768px) {
      .session-hud-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
      .hud-card {
        padding: 16px;
      }
      .hud-card-value {
        font-size: 1.55rem;
      }
    }

    /* ENHANCED POLL CARD STYLES */
    .poll-card {
      background: white;
      border-radius: 12px;
      border: 2px solid rgba(18, 56, 93, 0.12);
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .poll-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(18, 56, 93, 0.15);
      border-color: rgba(18, 56, 93, 0.25);
    }

    .poll-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #12385d, #c5a05a);
    }

    .poll-card-header {
      margin-bottom: 16px;
    }

    .poll-card-title {
      font-size: 18px;
      font-weight: 700;
      color: #12385d;
      margin-bottom: 6px;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .poll-card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .poll-card-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(18, 56, 93, 0.08);
      color: #12385d;
    }

    .poll-card-badge.class-badge {
      background: rgba(197, 160, 90, 0.15);
      color: #8b6914;
    }

    .poll-card-stats {
      display: flex;
      gap: 16px;
      padding: 12px 0;
      border-top: 1px solid rgba(18, 56, 93, 0.1);
      margin-bottom: 12px;
    }

    .poll-card-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #6b7280;
      font-size: 13px;
    }

    .poll-card-actions {
      display: flex;
      gap: 8px;
    }

    .poll-card-btn {
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }

    .poll-card-btn.primary {
      background: #12385d;
      color: white;
    }

    .poll-card-btn.primary:hover {
      background: #0f2d4a;
      transform: scale(1.02);
    }

    .poll-card-btn.secondary {
      background: rgba(18, 56, 93, 0.08);
      color: #12385d;
    }

    .poll-card-btn.secondary:hover {
      background: rgba(18, 56, 93, 0.15);
    }

    .poll-card-btn.danger {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
    }

    .poll-card-btn.danger:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    /* View Toggle Button States */
    #view-cards-btn.active {
      background: #12385d !important;
      color: white !important;
    }

    #view-table-btn.active {
      background: #12385d !important;
      color: white !important;
    }
  </style>
  </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-brand-dark-gray dark:text-brand-white">
  <!-- ðŸŽ¯ Ambient State Overlay - Provides visual feedback for system states -->
  <div id="ambient-state-overlay" class="ambient-state-overlay state-normal"></div>

  <!-- ðŸ”” Toast Notification Container - For elegant, non-intrusive alerts -->
  <div id="toast-container" class="toast-container"></div>

  <div class="flex h-screen w-full flex-col">
    <!-- Header - Default State -->
    <header id="header-default" class="flex flex-wrap items-center gap-4 border-b border-solid border-veritas-navy/80 bg-veritas-navy px-6 py-4 shadow-md">
      <div class="flex items-center gap-3">
        <button id="dashboard-sidebar-toggle" type="button" class="flex h-10 w-10 items-center justify-center rounded-full bg-brand-white/10 text-brand-white transition-colors hover:bg-brand-white/20 focus:outline-none focus:ring-2 focus:ring-brand-white/60" aria-label="Hide navigation" aria-expanded="true">
          <span class="material-symbols-outlined text-2xl">menu_open</span>
        </button>
        <div class="flex items-center gap-4 cursor-pointer hover:opacity-80 transition-opacity" onclick="showDashboard()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();showDashboard();}" role="button" tabindex="0">
          <img alt="Malvern Prep Logo" class="h-12 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png"/>
          <div class="flex flex-col">
            <h1 class="text-brand-white text-xl font-bold tracking-wide uppercase" style="letter-spacing: 0.15em;">Veritas</h1>
            <p class="text-brand-white/70 text-xs tracking-wide">Teacher Dashboard</p>
          </div>
        </div>
      </div>

      <div id="header-session-controls" class="flex flex-1 flex-wrap items-center justify-center gap-3 text-sm">
        <div class="min-w-[220px]">
          <label for="poll-select" class="sr-only">Select Poll to Start Session</label>
          <select id="poll-select" class="w-full rounded-lg border border-brand-white/30 bg-brand-white/10 px-3 py-2 text-sm text-brand-white placeholder-brand-white/70 focus:border-brand-white focus:outline-none focus:ring-2 focus:ring-veritas-gold/60">
            <option value="">-- Choose a poll --</option>
          </select>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <button id="start-poll-btn" class="flex items-center gap-2 h-10 px-5 rounded-lg bg-veritas-gold text-white text-sm font-semibold hover:bg-veritas-gold/90 transition-colors shadow-sm disabled:cursor-not-allowed disabled:opacity-60" disabled>
            <span class="material-symbols-outlined text-lg">play_circle</span>
            <span>Start Session</span>
          </button>
          <button id="send-link-btn" class="flex items-center gap-2 h-10 px-5 rounded-lg bg-green-600 text-white text-sm font-semibold hover:bg-green-700 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <span class="material-symbols-outlined text-lg">mail</span>
            <span>Send Links</span>
          </button>
          <button id="view-links-btn" class="flex items-center gap-2 h-10 px-5 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <span class="material-symbols-outlined text-lg">visibility</span>
            <span>View Links</span>
          </button>
        </div>
      </div>

      <div class="ml-auto flex items-center gap-3">
        <div id="loader" class="loader" style="display: block;">
          <div class="h-6 w-6 animate-spin rounded-full border-2 border-brand-white/80 border-t-transparent"></div>
        </div>
      </div>
    </header>

    <!-- Header - Live Poll State (REDESIGNED 3-SECTION LAYOUT) -->
    <header id="header-live" class="shrink-0 bg-veritas-navy shadow-lg border-b-2 border-veritas-gold" style="display: none;">
      <!-- Top Bar: 3-Column Grid Layout -->
      <div class="grid grid-cols-[1fr_auto_1fr] items-center gap-6 px-6 py-2">

        <!-- LEFT SECTION: Question Info -->
        <div class="flex items-center gap-4 min-w-0">
          <button id="dashboard-sidebar-toggle-live" type="button" class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-brand-white/10 text-brand-white transition-colors hover:bg-brand-white/20 focus:outline-none focus:ring-2 focus:ring-brand-white/60" aria-label="Hide navigation">
            <span class="material-symbols-outlined text-2xl">menu_open</span>
          </button>
          <div class="min-w-0">
            <h1 id="header-poll-name" class="text-brand-white text-xl font-semibold truncate">Question 1 of 4 â€” Question Title</h1>
          </div>
        </div>

        <!-- CENTER SECTION: Timer (Dominant) - ENHANCED with Larger Touch Targets (REMOVED per user request) -->
        <div class="flex flex-col items-center gap-1" style="display: none;">
          <div id="timer-main-container" class="flex items-center gap-2 rounded-lg border-2 border-brand-white/20 bg-brand-white/10 px-3 py-1.5 transition-all duration-300">
            <button id="subtract-10s-btn" class="w-7 h-7 flex items-center justify-center rounded-lg bg-brand-white/10 text-brand-white hover:bg-brand-white/20 transition-colors disabled:opacity-30 disabled:cursor-not-allowed" aria-label="-10 seconds" title="Subtract 10 seconds">
              <span class="material-symbols-outlined text-lg">remove</span>
            </button>
            <input
              type="text"
              id="timer-display"
              class="w-24 rounded bg-transparent text-center text-2xl font-bold text-brand-white transition-all placeholder-brand-white/40 focus:outline-none focus:ring-2 focus:ring-veritas-gold disabled:opacity-70 cursor-pointer"
              value="01:30"
              aria-label="Timer display"
              title="Click to edit time"
            />
            <button id="add-10s-btn" class="w-7 h-7 flex items-center justify-center rounded-lg bg-brand-white/10 text-brand-white hover:bg-brand-white/20 transition-colors disabled:opacity-30 disabled:cursor-not-allowed" aria-label="+10 seconds" title="Add 10 seconds">
              <span class="material-symbols-outlined text-lg">add</span>
            </button>
            <div class="w-px h-6 bg-brand-white/30 mx-1"></div>
            <button id="start-btn" class="bg-emerald-500 hover:bg-emerald-600 text-brand-white font-bold px-2.5 py-1.5 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-md" aria-label="Start timer" title="Start timer (Space)">
              <span class="material-symbols-outlined text-lg">play_arrow</span>
            </button>
            <button id="pause-btn" class="bg-amber-500 hover:bg-amber-600 text-brand-white font-bold px-2.5 py-1.5 rounded-lg transition-colors hidden shadow-md" aria-label="Pause timer" title="Pause timer (Space)">
              <span class="material-symbols-outlined text-lg">pause</span>
            </button>
            <button id="reset-btn" class="bg-brand-white/20 hover:bg-brand-white/30 text-brand-white font-bold px-2.5 py-1.5 rounded-lg transition-colors shadow-sm" aria-label="Reset timer" title="Reset timer">
              <span class="material-symbols-outlined text-lg">refresh</span>
            </button>
          </div>
          <div class="flex items-center gap-2">
            <p id="timer-status-message" class="text-xs text-brand-white/70 uppercase tracking-wide font-semibold">Individually Timed</p>
            <span class="text-brand-white/40">â€¢</span>
            <div class="flex gap-1">
              <button id="add-30s-btn" class="px-2 py-0.5 text-xs bg-brand-white/10 hover:bg-brand-white/20 text-brand-white/90 rounded transition-colors font-semibold" title="Add 30 seconds">+30s</button>
              <button id="add-60s-btn" class="px-2 py-0.5 text-xs bg-brand-white/10 hover:bg-brand-white/20 text-brand-white/90 rounded transition-colors font-semibold" title="Add 60 seconds">+1m</button>
            </div>
          </div>
        </div>

        <!-- RIGHT SECTION: Action Cluster -->
        <div class="flex items-center justify-end gap-2 flex-wrap">
          <!-- Primary Action - ENHANCED with Larger Size and Prominence -->
          <button id="header-next-btn" class="flex items-center gap-2 h-12 px-6 rounded-lg bg-veritas-gold text-white text-base font-bold hover:bg-veritas-gold/90 transition-all shadow-lg hover:shadow-xl transform hover:scale-105" title="Advance to next question (â†’ arrow key)">
            <span>Next Question</span>
            <span class="material-symbols-outlined text-xl">arrow_forward</span>
            <span class="kbd-hint">â†’</span>
          </button>
          <button id="header-end-show-btn" class="hidden items-center gap-2 h-12 px-6 rounded-lg bg-emerald-600 text-white text-base font-bold hover:bg-emerald-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-105" title="Close responses and reveal answer to students">
            <span class="material-symbols-outlined text-xl">check_circle</span>
            <span>End &amp; Reveal</span>
          </button>

          <!-- Secondary Actions -->
          <button id="header-reset-question-btn" class="flex items-center gap-2 h-10 px-4 rounded-lg border-2 border-brand-white/30 bg-transparent text-brand-white text-sm font-semibold hover:bg-brand-white/10 transition-colors">
            <span class="material-symbols-outlined text-base">replay</span>
            <span class="hidden xl:inline">Reset Question</span>
          </button>
          <button id="header-send-link-btn" class="flex items-center gap-1.5 h-10 px-3 rounded-lg bg-brand-white/10 text-brand-white text-sm font-semibold hover:bg-brand-white/20 transition-colors">
            <span class="material-symbols-outlined text-base">mail</span>
            <span class="hidden xl:inline">Send Links</span>
          </button>
          <button id="header-view-links-btn" class="flex items-center gap-1.5 h-10 px-3 rounded-lg bg-brand-white/10 text-brand-white text-sm font-semibold hover:bg-brand-white/20 transition-colors">
            <span class="material-symbols-outlined text-base">visibility</span>
            <span class="hidden xl:inline">View Links</span>
          </button>
          <button id="header-back-btn" class="flex items-center gap-1.5 h-10 px-3 rounded-lg bg-brand-white/10 text-brand-white text-sm font-semibold hover:bg-brand-white/20 transition-colors">
            <span class="material-symbols-outlined text-base">arrow_back</span>
            <span class="hidden xl:inline">Back</span>
          </button>

          <!-- Danger Action (Isolated) -->
          <div class="w-px h-8 bg-brand-white/30 mx-1"></div>
          <button id="header-stop-btn" class="flex items-center gap-2 h-10 px-4 rounded-lg bg-rose-600 text-brand-white text-sm font-bold hover:bg-rose-700 transition-colors shadow-sm" title="End the entire session">
            <span class="material-symbols-outlined text-base">stop</span>
            <span>Finish Session</span>
          </button>
        </div>
      </div>

      <!-- Hidden elements for compatibility -->
      <button id="header-start-btn" class="hidden"></button>
      <div id="question-dots" class="hidden"></div>
    </header>

    <div class="flex flex-grow overflow-hidden">
      <!-- Left Navigation Sidebar -->
      <aside id="dashboard-sidebar" class="flex h-full w-64 flex-shrink-0 flex-col border-r border-veritas-navy/25 bg-veritas-navy p-4 text-brand-white shadow-lg">
        <div class="mb-4 px-1">
          <p class="text-xs font-semibold uppercase tracking-[0.32em] text-brand-white/60">Navigation</p>
        </div>
        <nav class="flex flex-1 flex-col gap-2">
          <button id="nav-polls-list" data-section-target="dashboard" class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg font-semibold transition-colors text-left" aria-current="page">
            <span class="material-symbols-outlined">monitoring</span>
            <span>Live Dashboard</span>
          </button>
          <button id="nav-create-poll" class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg text-left transition-colors font-semibold">
            <span class="material-symbols-outlined">add_circle</span>
            <span>Create New Poll</span>
          </button>
          <button id="nav-rosters" data-section-target="roster" class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left">
            <span class="material-symbols-outlined">group</span>
            <span>Classes &amp; Rosters</span>
          </button>
          <button id="nav-archived" data-section-target="archived" class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left">
            <span class="material-symbols-outlined">inventory_2</span>
            <span>Archived Polls</span>
          </button>
          <button id="nav-analytics" data-section-target="analytics" class="sidebar-nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left">
            <span class="material-symbols-outlined">analytics</span>
            <span>Analytics Hub</span>
          </button>
        </nav>
        <div class="mt-6 rounded-lg border border-brand-white/10 bg-brand-white/5 px-3 py-3 text-xs text-brand-white/70">
          <p class="font-semibold uppercase tracking-[0.18em] text-brand-white/60">Tip</p>
          <p class="mt-1 leading-relaxed">Use the controls in the top bar to quickly start a live session from any poll.</p>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main class="flex-1 overflow-y-auto">
        <!-- Dashboard View (Default) - Redesigned -->
        <div id="dashboard" class="p-8 max-w-7xl mx-auto">
          <!-- Poll Library & Session Management (Combined) -->
          <div class="dashboard-card">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
              <div>
                <h2 class="text-2xl font-bold text-veritas-navy mb-1">Poll Library & Session Management</h2>
                <p class="text-gray-600 text-sm">Use the session controls in the header to start a live session, or create, edit, and manage your polls below.</p>
              </div>
            </div>

            <!-- Poll Library Controls -->
            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
              <h3 class="text-lg font-semibold text-veritas-navy">Your Polls</h3>
              <div class="flex flex-wrap items-center gap-3">
                <label class="flex items-center gap-2 text-sm text-gray-600">
                  <span class="hidden sm:inline">Sort by</span>
                  <select id="poll-sort-select" class="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-veritas-gold">
                    <option value="updated_desc">Latest activity</option>
                    <option value="updated_asc">Oldest activity</option>
                    <option value="name_asc">Name A â†’ Z</option>
                    <option value="class_asc">Class A â†’ Z</option>
                  </select>
                </label>
                <label class="flex items-center gap-2 text-sm text-gray-600">
                  <span class="hidden sm:inline">Class</span>
                  <select id="poll-filter-select" class="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-veritas-gold">
                    <option value="all">All classes</option>
                  </select>
                </label>
                <div class="relative w-full sm:w-64">
                  <span class="material-symbols-outlined pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-400">search</span>
                  <input id="poll-search-input" type="search" placeholder="Search polls, questions, or live session terms..." class="w-full rounded-lg border border-gray-300 bg-white pl-9 pr-9 py-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-veritas-gold" aria-label="Search polls" />
                  <button id="poll-search-clear-btn" type="button" class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none" aria-label="Clear search">
                    <span class="material-symbols-outlined text-base leading-none">close</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- ENHANCED: Toggle between Table and Card View -->
            <div class="mb-4 flex items-center justify-end gap-2">
              <span class="text-xs text-gray-500 font-medium">View:</span>
              <button id="view-cards-btn" class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-veritas-navy/10 text-veritas-navy transition-colors" title="Card view">
                <span class="material-symbols-outlined text-base align-middle">grid_view</span>
              </button>
              <button id="view-table-btn" class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors" title="Table view">
                <span class="material-symbols-outlined text-base align-middle">table_rows</span>
              </button>
            </div>

            <!-- Card View (Default, More Visual) -->
            <div id="polls-card-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
              <!-- Poll cards will be dynamically inserted here -->
            </div>

            <!-- Table View (Optional, More Compact) -->
            <div id="polls-table-view" class="overflow-hidden rounded-lg border border-gray-200 hidden">
              <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50 text-gray-600">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold">Poll</th>
                    <th class="px-4 py-3 text-left font-semibold">Class</th>
                    <th class="px-4 py-3 text-left font-semibold">Questions</th>
                    <th class="px-4 py-3 text-left font-semibold">Last Edited</th>
                    <th class="px-4 py-3 text-right font-semibold">Actions</th>
                  </tr>
                </thead>
                <tbody id="polls-table-body" class="divide-y divide-gray-100 bg-white"></tbody>
              </table>
            </div>

            <!-- Empty State -->
            <div id="polls-empty-state" class="p-12 text-center text-gray-500 hidden">
              <div class="max-w-md mx-auto">
                <span class="material-symbols-outlined text-6xl text-gray-300 mb-4">quiz</span>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">No Polls Yet</h3>
                <p class="text-sm mb-6">Create your first poll to get started with live polling in your classroom.</p>
                <button onclick="createNewPoll()" class="inline-flex items-center gap-2 px-5 py-2.5 bg-veritas-navy text-white rounded-lg font-semibold hover:bg-veritas-navy/90 transition-colors">
                  <span class="material-symbols-outlined text-lg">add_circle</span>
                  <span>Create New Poll</span>
                </button>
              </div>
            </div>
          </div>

        </div>

        <!-- Live Poll View (REDESIGNED FOR OPTIMAL TEACHER WORKFLOW) -->
        <div id="live-view" class="flex flex-col h-full overflow-hidden" style="display: none;">

          <!-- ðŸš¨ ATTENTION ZONE - Appears only when teacher action needed -->
          <div id="attention-banner-container" class="flex-shrink-0">
            <!-- Lockout Alert (ENHANCED - High Visibility!) -->
            <div id="lockout-alert-banner" class="hidden bg-gradient-to-r from-red-600 to-red-700 border-b-4 border-red-800 px-6 py-4 shadow-lg animate-fade-up">
              <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-4 flex-1 min-w-0">
                  <span class="material-symbols-outlined text-white text-4xl flex-shrink-0 animate-pulse">lock_person</span>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-3 mb-1">
                      <h3 class="text-white text-xl font-bold">ðŸ”’ Students Locked Out</h3>
                      <span class="px-2 py-0.5 bg-white/20 rounded-full text-white text-xs font-bold uppercase tracking-wide">Action Required</span>
                    </div>
                    <p id="lockout-student-names" class="text-white/95 text-base mb-3 font-semibold">Loading...</p>
                    <div id="lockout-actions" class="flex flex-wrap gap-2.5">
                      <!-- Individual unlock buttons will be populated here with larger touch targets -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- All Responded Alert (ENHANCED - More Celebratory!) -->
            <div id="all-responded-banner" class="hidden bg-gradient-to-r from-green-600 to-green-700 border-b-4 border-green-800 px-6 py-4 animate-fade-up">
              <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                  <span class="material-symbols-outlined text-white text-4xl animate-pulse-glow">check_circle</span>
                  <div>
                    <p id="all-responded-title" class="text-white text-xl font-bold mb-1">âœ… Everyone Responded!</p>
                    <p id="all-responded-subtitle" class="text-white/90 text-sm font-medium">All students have submitted their answers. Ready to reveal and advance.</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <span id="time-saved-badge" class="hidden px-3 py-1.5 bg-white/20 rounded-lg text-white text-sm font-bold">
                    <span class="material-symbols-outlined text-base align-middle">schedule</span>
                    Saved <span id="time-saved-amount">0</span>s
                  </span>
                </div>
              </div>
            </div>

            <!-- Exited Students Panel (moved to top for visibility) -->
            <div id="exited-students-panel" class="hidden bg-gradient-to-r from-orange-500 to-orange-600 border-b-4 border-orange-700 px-6 py-4">
              <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-4 flex-1">
                  <span class="material-symbols-outlined text-white text-3xl">exit_to_app</span>
                  <div class="flex-1">
                    <h3 class="text-white text-lg font-bold mb-1">Students Exited Poll</h3>
                    <p class="text-white/95 text-sm mb-3"><span id="exited-students-count">0</span> student(s) awaiting re-entry approval</p>
                    <div id="exited-students-list-inline" class="flex flex-wrap gap-2">
                      <!-- Inline student buttons will be populated here -->
                    </div>
                  </div>
                </div>
                <button id="approve-all-unlocks-btn" class="px-5 py-2.5 bg-white/20 hover:bg-white/30 text-white rounded-lg text-sm font-bold transition-colors flex items-center gap-2 border-2 border-white/30" title="Approve all students for re-entry">
                  <span class="material-symbols-outlined text-lg">check_circle</span>
                  <span>UNLOCK ALL</span>
                </button>
              </div>
            </div>
          </div>

          <!-- âš¡ Rapid-Glance Session HUD (REMOVED per user request) -->
          <div id="session-hud-container" class="flex-shrink-0 session-hud-surface border-b border-brand-light-gray/60 dark:border-white/10" style="display: none;">
            <div class="max-w-7xl mx-auto px-6 py-4 session-hud-grid">
              <article id="hud-responses-card" class="hud-card hud-card-enhanced" aria-live="polite">
                <div class="hud-card-progress">
                  <div class="progress-ring-container">
                    <svg class="progress-ring" viewBox="0 0 52 52">
                      <circle class="progress-ring-circle-bg" cx="26" cy="26" r="22"></circle>
                      <circle id="hud-response-ring" class="progress-ring-circle" cx="26" cy="26" r="22"
                              stroke-dasharray="138.23" stroke-dashoffset="138.23"></circle>
                    </svg>
                    <div id="hud-response-percent" class="progress-ring-text">0%</div>
                  </div>
                </div>
                <div class="hud-card-info">
                  <div class="hud-card-label text-brand-dark-gray/80 dark:text-brand-white/70">
                    <span class="material-symbols-outlined text-base">how_to_vote</span>
                    Responses
                  </div>
                  <div id="hud-response-count" class="hud-card-value">0 / 0</div>
                  <p id="hud-response-caption" class="hud-card-caption">Awaiting roster data</p>
                </div>
              </article>

              <article id="hud-accuracy-card" class="hud-card hud-card-enhanced" aria-live="polite">
                <div class="hud-card-progress">
                  <div class="progress-ring-container">
                    <svg class="progress-ring" viewBox="0 0 52 52">
                      <circle class="progress-ring-circle-bg" cx="26" cy="26" r="22"></circle>
                      <circle id="hud-accuracy-ring" class="progress-ring-circle ring-success" cx="26" cy="26" r="22"
                              stroke-dasharray="138.23" stroke-dashoffset="138.23"></circle>
                    </svg>
                    <div id="hud-accuracy-percent" class="progress-ring-text">--</div>
                  </div>
                </div>
                <div class="hud-card-info">
                  <div class="hud-card-label text-brand-dark-gray/80 dark:text-brand-white/70">
                    <span class="material-symbols-outlined text-base">verified</span>
                    Accuracy
                  </div>
                  <div id="hud-accuracy-value" class="hud-card-value">--%</div>
                  <p id="hud-accuracy-caption" class="hud-card-caption">Waiting for responses</p>
                </div>
              </article>

              <article id="hud-lockouts-card" class="hud-card" aria-live="polite">
                <div class="hud-card-label text-brand-dark-gray/80 dark:text-brand-white/70">
                  <span class="material-symbols-outlined text-base">lock_clock</span>
                  Approvals
                </div>
                <div class="flex items-center justify-between gap-3">
                  <div>
                    <div id="hud-lockouts-value" class="hud-card-value">0</div>
                    <p id="hud-lockouts-caption" class="hud-card-caption">No approvals pending</p>
                  </div>
                  <button id="hud-focus-lockouts-btn" type="button" class="inline-flex items-center gap-1.5 rounded-full bg-veritas-navy/10 text-veritas-navy dark:bg-brand-white/10 dark:text-brand-white px-3 py-2 text-[0.7rem] font-semibold tracking-[0.14em] uppercase transition-all disabled:opacity-40" disabled title="Jump to students needing unlock">
                    <span class="material-symbols-outlined text-sm">target</span>
                    Focus
                  </button>
                </div>
              </article>

              <article id="hud-pace-card" class="hud-card" aria-live="polite">
                <div class="hud-card-label text-brand-dark-gray/80 dark:text-brand-white/70">
                  <span class="material-symbols-outlined text-base">speed</span>
                  Session Pace
                </div>
                <div class="flex items-center justify-between gap-3">
                  <div>
                    <div id="hud-pace-value" class="hud-card-value">--:--</div>
                    <p id="hud-pace-caption" class="hud-card-caption">Timer ready</p>
                  </div>
                  <span id="hud-pace-chip" class="hud-chip" data-variant="ready">
                    <span id="hud-pace-chip-icon" class="material-symbols-outlined text-sm">pause_circle</span>
                    <span id="hud-pace-chip-label">Ready</span>
                  </span>
                </div>
              </article>
            </div>
          </div>

          <!-- ULTRA-COMPACT QUESTION HEADER (Single Line) -->
          <div class="flex-shrink-0 bg-veritas-navy border-b-2 border-veritas-gold px-6 py-2">
            <div class="flex items-center gap-4">
              <!-- Question Info (Left) -->
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-3">
                  <span id="live-question-info" class="text-brand-white text-sm font-bold whitespace-nowrap">Q1/10</span>
                  <h2 id="live-question-text-compact" class="text-brand-white text-base font-semibold">Question text will appear here...</h2>
                </div>
              </div>

              <!-- Timer & Status (Center) - ENHANCED with Color Feedback (REMOVED per user request) -->
              <div class="flex items-center gap-4 flex-shrink-0" style="display: none;">
                <div id="timer-compact-container" class="flex items-center gap-2 px-3 py-1.5 bg-brand-white/15 rounded-lg transition-all duration-300">
                  <span class="material-symbols-outlined text-brand-white text-lg">timer</span>
                  <input type="text" id="timer-display-compact" class="w-20 bg-transparent text-center text-xl font-bold text-brand-white focus:outline-none" value="--:--" readonly>
                </div>
                <div class="h-6 w-px bg-brand-white/30"></div>
                <div class="flex items-center gap-2 px-3 py-1.5 bg-brand-white/15 rounded-lg">
                  <span id="response-count-compact" class="text-brand-white text-base font-bold whitespace-nowrap">0/0</span>
                  <div class="w-40 h-2.5 bg-brand-white/20 rounded-full overflow-hidden">
                    <div id="live-overview-response-progress-compact" class="h-full bg-brand-white transition-all duration-500" style="width: 0%;"></div>
                  </div>
                  <span id="response-percent-compact" class="text-brand-white/90 text-base font-bold">0%</span>
                </div>
              </div>

              <!-- Quick Actions (Right) -->
              <div class="flex items-center gap-2 flex-shrink-0">
                <button id="expand-question-btn" class="p-1.5 rounded-lg bg-brand-white/10 hover:bg-brand-white/20 text-brand-white transition-colors" title="Expand question details">
                  <span class="material-symbols-outlined text-lg">unfold_more</span>
                </button>
              </div>
            </div>
          </div>

          <!-- MAIN SPLIT VIEW: Results (60%) + Students (40%) -->
          <div class="flex-1 overflow-hidden flex">

            <!-- LEFT PANEL: RESULTS (60%) -->
            <div class="w-[60%] border-r border-gray-200 dark:border-gray-700 flex flex-col">

              <!-- Results Header -->
              <div class="flex-shrink-0 bg-white dark:bg-brand-dark-gray/30 border-b border-gray-200 dark:border-gray-700 px-6 py-3.5">
                <div class="flex items-center justify-between">
                  <h3 class="text-brand-dark-gray dark:text-brand-white text-lg font-bold">Live Results</h3>
                  <div class="flex items-center gap-3">
                    <span id="response-count-header" class="text-sm font-semibold text-gray-600 dark:text-gray-400">0 / 0 answered</span>
                  </div>
                </div>
              </div>

              <!-- Results Content (Scrollable) -->
              <div class="flex-1 overflow-y-auto bg-white dark:bg-brand-dark-gray/30 px-6 py-4">
                <div id="results-bars" class="flex flex-col gap-2">
                  <!-- Results will be populated dynamically with condensed names -->
                </div>

                <!-- Metacognition Card -->
                <div id="live-metacognition-card" class="mt-3 hidden rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-brand-dark-gray/50 p-4"></div>

                <!-- Results Reveal Strip -->
                <div id="results-reveal-strip" class="mt-6 hidden">
                  <div class="flex flex-wrap items-center justify-between gap-3 rounded-lg border border-green-600/20 bg-green-600/5 px-4 py-3">
                    <div class="min-w-[200px]">
                      <p class="text-sm font-semibold text-green-700 dark:text-green-400">Answer revealed to students</p>
                      <p id="results-strip-status" class="text-xs text-green-700/70">Students can now see the correct answer.</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2">
                      <button id="hide-results-btn" class="flex items-center gap-2 rounded-lg bg-gray-200 text-gray-700 px-4 py-2 text-sm font-semibold hover:bg-gray-300 transition-colors" type="button">
                        <span class="material-symbols-outlined text-base">visibility_off</span>
                        <span>Hide</span>
                      </button>
                      <button id="strip-next-btn" class="flex items-center gap-2 rounded-lg bg-veritas-navy text-white px-4 py-2 text-sm font-semibold hover:bg-veritas-navy/90 transition-colors" type="button">
                        <span>Next</span>
                        <span class="material-symbols-outlined text-base">arrow_forward</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- RIGHT PANEL: STUDENTS (40%) -->
            <div class="w-[40%] flex flex-col bg-white dark:bg-brand-dark-gray/30">

              <!-- Student Header with Status Summary -->
              <div class="flex-shrink-0 border-b border-gray-200 dark:border-gray-700 px-5 py-3.5">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-brand-dark-gray dark:text-brand-white text-lg font-bold">Students</h3>
                  <div class="flex items-center gap-1.5">
                    <button id="filter-locked-only-btn" class="h-7 w-7 flex items-center justify-center rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 hover:bg-red-200 transition-colors" title="Show locked only">
                      <span class="material-symbols-outlined text-base">lock</span>
                    </button>
                    <button id="filter-all-btn" class="h-7 w-7 flex items-center justify-center rounded-lg bg-gray-100 dark:bg-gray-900/30 text-gray-700 dark:text-gray-400 hover:bg-gray-200 transition-colors" title="Show all">
                      <span class="material-symbols-outlined text-base">group</span>
                    </button>
                  </div>
                </div>

                <!-- Status Pills (Always Visible) -->
                <div class="flex flex-wrap gap-1.5 mb-3">
                  <div class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full bg-green-100 dark:bg-green-900/30 text-xs font-semibold text-green-700 dark:text-green-400">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-600"></div>
                    <span>âœ“ <span id="correct-count">0</span></span>
                  </div>
                  <div class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full bg-red-100 dark:bg-red-900/30 text-xs font-semibold text-red-700 dark:text-red-400">
                    <div class="w-1.5 h-1.5 rounded-full bg-red-600"></div>
                    <span>ðŸ”’ <span id="locked-count">0</span></span>
                  </div>
                  <div class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full bg-amber-100 dark:bg-amber-900/30 text-xs font-semibold text-amber-700 dark:text-amber-400">
                    <div class="w-1.5 h-1.5 rounded-full bg-amber-600"></div>
                    <span>âš  <span id="blocked-count">0</span></span>
                  </div>
                  <div class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-900/30 text-xs font-semibold text-gray-700 dark:text-gray-400">
                    <div class="w-1.5 h-1.5 rounded-full bg-gray-500"></div>
                    <span>â³ <span id="waiting-count">0</span></span>
                  </div>
                </div>

                <!-- Search & Sort -->
                <div class="flex items-center gap-2">
                  <div class="relative flex-1">
                    <span class="material-symbols-outlined absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm pointer-events-none">search</span>
                    <input type="text" id="student-search-input" placeholder="Search..." class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 pl-8 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-veritas-navy/50 focus:border-transparent">
                  </div>
                  <select id="student-sort-select" class="text-xs rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-2 py-2 focus:outline-none focus:ring-2 focus:ring-veritas-navy/50">
                    <option value="name">Name</option>
                    <option value="status">Status</option>
                    <option value="answer">Answer</option>
                  </select>
                  <button id="student-sort-direction-btn" class="h-8 w-8 flex items-center justify-center rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" title="Sort direction">
                    <span class="material-symbols-outlined text-base">south</span>
                  </button>
                </div>
              </div>

              <!-- Student List (Scrollable, Full Names) -->
              <div id="student-status-grid" class="flex-1 overflow-y-auto px-5 py-2 space-y-1">
                <!-- Students will be populated with full names, inline status, hover actions -->
              </div>
            </div>

          </div>

          <!-- Hidden elements for compatibility -->
          <div class="hidden">
            <div id="live-session-overview">
              <p id="live-overview-responses">0 / 0</p>
              <div id="live-overview-response-progress" style="width: 0%;"></div>
              <p id="live-overview-response-caption">0%</p>
              <p id="live-overview-accuracy">0%</p>
              <p id="live-overview-accuracy-caption"></p>
              <p id="live-overview-lockouts">0</p>
              <p id="live-overview-lockouts-caption"></p>
              <p id="live-overview-waiting">0</p>
              <p id="live-overview-waiting-caption"></p>
              <button id="focus-lockouts-btn" type="button" disabled></button>
            </div>
            <h2 id="live-question-text">Question text</h2>
            <div id="question-image-container" style="display: none;">
              <img id="live-question-image" alt="Question" src="">
            </div>
            <div id="response-count">0 / 0</div>
            <div id="violations-alert-panel"></div>
            <div id="violations-summary"></div>
            <div id="violations-quick-list"></div>
            <button id="dismiss-violations-alert"></button>
            <button id="toggle-exited-panel-btn"></button>
            <div id="exited-students-list"></div>
            <button id="toggle-sidebar-btn"></button>
            <span id="sidebar-toggle-icon"></span>
            <span id="sidebar-toggle-label"></span>
          </div>

        </div>

        <!-- âš¡ Floating Action Button (FAB) Cluster - Primary Actions for Live Session -->
        <div id="fab-container" class="fab-container" style="display: none;">
          <!-- FAB Menu Items -->
          <div id="fab-menu" class="fab-menu">
            <!-- Activity Feed Toggle -->
            <div class="fab-action">
              <span class="fab-label">Activity Feed</span>
              <button id="fab-activity-btn" class="fab-button fab-info" title="View recent activity" aria-label="Toggle activity feed">
                <span class="material-symbols-outlined">notifications</span>
              </button>
            </div>

            <!-- Next Question Action -->
            <div class="fab-action">
              <span class="fab-label">Next Question â†’</span>
              <button id="fab-next-btn" class="fab-button fab-primary" title="Advance to next question" aria-label="Next question">
                <span class="material-symbols-outlined">arrow_forward</span>
              </button>
            </div>

            <!-- Show Results Action -->
            <div class="fab-action">
              <span class="fab-label">Show Results</span>
              <button id="fab-show-results-btn" class="fab-button fab-success" title="Reveal answer to students" aria-label="Show results">
                <span class="material-symbols-outlined">visibility</span>
              </button>
            </div>

            <!-- Reset Question Action -->
            <div class="fab-action">
              <span class="fab-label">Reset Question</span>
              <button id="fab-reset-btn" class="fab-button fab-info" title="Reset current question" aria-label="Reset question">
                <span class="material-symbols-outlined">replay</span>
              </button>
            </div>

            <!-- Stop Session Action -->
            <div class="fab-action">
              <span class="fab-label">End Session</span>
              <button id="fab-stop-btn" class="fab-button fab-danger" title="End the entire session" aria-label="Stop session">
                <span class="material-symbols-outlined">stop</span>
              </button>
            </div>
          </div>

          <!-- FAB Main Toggle Button -->
          <button id="fab-main-toggle" class="fab-main" aria-label="Quick actions menu" aria-expanded="false">
            <span class="material-symbols-outlined">bolt</span>
          </button>
        </div>

        <!-- ðŸ“Š Real-Time Activity Feed - Shows recent student actions -->
        <div id="activity-feed" class="activity-feed">
          <div class="activity-feed-header">
            <div class="activity-feed-title">
              <span class="material-symbols-outlined">notifications</span>
              <span>Recent Activity</span>
              <span id="activity-feed-count" class="activity-feed-badge">0</span>
            </div>
            <button id="activity-feed-close" class="activity-feed-close" aria-label="Close activity feed">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
          <div id="activity-feed-list" class="activity-feed-list">
            <!-- Activity items will be dynamically inserted here -->
            <div class="activity-feed-empty">
              <span class="material-symbols-outlined">inbox</span>
              <p>No recent activity</p>
            </div>
          </div>
        </div>

        <!-- End of Live Poll View Redesign -->
        <!-- Roster Manager View -->
        <div id="roster-manager" class="p-6 grid grid-cols-1 lg:grid-cols-4 gap-6" style="display: none;">
          <div class="lg:col-span-1 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-5 shadow-sm flex flex-col">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white">Classes</h2>
              <button id="add-class-btn" class="flex items-center justify-center h-9 w-9 rounded-full bg-primary text-brand-white hover:bg-primary/90 transition-colors" title="Add class">
                <span class="material-symbols-outlined text-base">add</span>
              </button>
            </div>
            <div id="roster-class-list" class="flex-1 overflow-y-auto space-y-2">
              <!-- Classes will render here -->
            </div>
          </div>
          <div class="lg:col-span-3 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
              <div>
                <h2 id="roster-class-title" class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">Select a class</h2>
                <p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm">Manage student names and emails for rostered classes.</p>
              </div>
              <div class="flex items-center gap-2">
                <button id="rename-class-btn" class="hidden h-9 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">Rename</button>
                <button id="delete-class-btn" class="hidden h-9 px-4 rounded-lg bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-sm font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors">Delete</button>
              </div>
            </div>
            <div id="roster-empty-state" class="border border-dashed border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-10 text-center text-brand-dark-gray/60 dark:text-brand-white/60">
              <p>Choose a class on the left to view its roster.</p>
            </div>
            <div id="roster-table-wrapper" class="hidden flex flex-col gap-4">
              <div class="overflow-x-auto border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg">
                <table class="min-w-full divide-y divide-brand-light-gray dark:divide-brand-dark-gray text-sm">
                  <thead class="bg-brand-light-gray/50 dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white">
                    <tr>
                      <th class="px-4 py-2 text-left font-semibold w-1/2">Student Name</th>
                      <th class="px-4 py-2 text-left font-semibold w-1/2">Email</th>
                      <th class="px-4 py-2 text-center font-semibold w-16">Remove</th>
                    </tr>
                  </thead>
                  <tbody id="roster-table-body" class="divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/50"></tbody>
                </table>
              </div>
              <div class="flex flex-wrap items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                  <button id="add-student-row-btn" class="h-10 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">+ Add Student</button>
                  <button id="bulk-add-students-btn" class="h-10 px-4 rounded-lg bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-sm font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors">Bulk Add Students</button>
                  <span id="roster-status" class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60"></span>
                </div>
                <button id="save-roster-btn" class="h-10 px-5 rounded-lg bg-primary text-brand-white text-sm font-bold hover:bg-primary/90 transition-colors">Save Roster</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Archived Polls View -->
        <div id="archived-view" class="p-6 grid grid-cols-1 lg:grid-cols-4 gap-6" style="display: none;">
          <div class="lg:col-span-1 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-5 shadow-sm flex flex-col">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white">Archived Polls</h2>
              <button id="refresh-archived-btn" class="flex items-center justify-center h-9 w-9 rounded-full bg-primary text-brand-white hover:bg-primary/90 transition-colors" title="Refresh">
                <span class="material-symbols-outlined text-base">refresh</span>
              </button>
            </div>
            <label class="block text-xs font-semibold uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">Class Filter</label>
            <select id="archived-class-filter" class="mb-4 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
              <option value="all">All classes</option>
            </select>
            <div id="archived-list" class="flex-1 overflow-y-auto space-y-2">
              <!-- Archived polls list -->
            </div>
          </div>
          <div class="lg:col-span-3 bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-6 shadow-sm">
            <div id="archived-empty-state" class="border border-dashed border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-10 text-center text-brand-dark-gray/60 dark:text-brand-white/60">
              <p>Select an archived poll to review student performance.</p>
            </div>
            <div id="archived-detail" class="hidden flex flex-col gap-6">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <div>
                  <h2 id="archived-poll-title" class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white"></h2>
                  <p id="archived-poll-meta" class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm"></p>
                </div>
                <div class="flex items-center gap-4">
                  <div class="text-right text-sm text-brand-dark-gray/60 dark:text-brand-white/60">
                    <p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Questions:</span> <span id="archived-question-count"></span></p>
                    <p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Responses:</span> <span id="archived-response-count"></span></p>
                  </div>
                  <button id="view-analytics-btn" class="h-12 px-6 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 text-brand-white text-sm font-semibold hover:from-blue-700 hover:to-purple-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">analytics</span>
                    <span>View Analytics</span>
                  </button>
                </div>
              </div>
              <div id="archived-questions-container" class="space-y-4">
                <!-- Question breakdowns will render here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Analytics Hub View -->
        <div id="analytics-view" class="p-6 flex flex-col gap-6" style="display: none;">
          <!-- Filter Bar -->
          <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 p-4 shadow-sm">
            <div class="flex flex-wrap items-center gap-3 mb-3">
              <select id="analytics-class-filter" class="rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                <option value="all">All Classes</option>
              </select>
              <div class="flex items-center gap-2">
                <label class="text-xs font-semibold text-brand-dark-gray/60 dark:text-brand-white/60">From:</label>
                <input type="date" id="analytics-date-from" class="rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
              </div>
              <div class="flex items-center gap-2">
                <label class="text-xs font-semibold text-brand-dark-gray/60 dark:text-brand-white/60">To:</label>
                <input type="date" id="analytics-date-to" class="rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
              </div>
              <button id="analytics-apply-filters-btn" class="px-4 py-2 rounded-lg bg-primary text-brand-white hover:bg-primary/90 transition-colors text-sm font-semibold">
                Apply Filters
              </button>
              <button id="analytics-clear-filters-btn" class="px-4 py-2 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/50 transition-colors text-sm">
                Clear
              </button>
              <button id="analytics-refresh-btn" class="flex items-center justify-center h-9 w-9 rounded-full bg-primary text-brand-white hover:bg-primary/90 transition-colors" title="Refresh">
                <span class="material-symbols-outlined text-base">refresh</span>
              </button>
              <button id="analytics-export-btn" class="ml-auto flex items-center gap-2 px-4 py-2 rounded-lg bg-veritas-gold text-brand-white hover:bg-veritas-gold/90 transition-colors text-sm font-semibold" title="Export Data">
                <span class="material-symbols-outlined text-base">download</span>
                <span>Export</span>
              </button>
            </div>
            <div class="flex flex-wrap items-center gap-2">
              <span class="text-xs font-semibold text-brand-dark-gray/60 dark:text-brand-white/60">Quick Filters:</span>
              <button class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold" data-days="7">
                Last 7 Days
              </button>
              <button class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold" data-days="30">
                Last 30 Days
              </button>
              <button class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold" data-days="90">
                Last 90 Days
              </button>
              <button class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold" data-preset="thisMonth">
                This Month
              </button>
              <button class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold" data-preset="lastMonth">
                Last Month
              </button>
              <button class="analytics-date-preset px-3 py-1 rounded-md bg-brand-light-gray/30 dark:bg-brand-dark-gray/50 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray dark:hover:bg-brand-dark-gray transition-colors text-xs font-semibold" data-preset="all">
                All Time
              </button>
            </div>
          </div>

          <!-- Tab Navigation -->
          <div class="bg-brand-white dark:bg-brand-dark-gray/30 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/40 shadow-sm overflow-hidden">
            <div class="flex border-b border-brand-light-gray dark:border-brand-dark-gray/40">
              <button id="analytics-tab-overview" class="flex-1 px-6 py-3 font-semibold text-sm transition-colors analytics-tab bg-primary text-brand-white">
                Overview
              </button>
              <button id="analytics-tab-items" class="flex-1 px-6 py-3 font-semibold text-sm transition-colors analytics-tab text-brand-dark-gray/70 dark:text-brand-white/70 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30">
                Item Analysis
              </button>
              <button id="analytics-tab-students" class="flex-1 px-6 py-3 font-semibold text-sm transition-colors analytics-tab text-brand-dark-gray/70 dark:text-brand-white/70 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30">
                Student Trends
              </button>
            </div>

            <!-- Overview Tab Content -->
            <div id="analytics-content-overview" class="p-6 analytics-tab-content">
              <div id="analytics-overview-loading" class="text-center py-12">
                <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Loading analytics...</p>
              </div>
              <div id="analytics-overview-content" class="hidden">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                  <div id="analytics-kpi-container"></div>
                </div>

                <!-- Topic Heat Strip -->
                <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5 mb-6">
                  <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Topic Mastery Over Time</h3>
                  <div id="analytics-topic-heat" class="overflow-x-auto">
                    <p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No topic data available</p>
                  </div>
                </div>

                <!-- Item Quality Scatter -->
                <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5">
                  <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Item Quality Map</h3>
                  <div id="analytics-item-scatter" style="height: 300px;">
                    <p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No item data available</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Item Analysis Tab Content -->
            <div id="analytics-content-items" class="p-6 analytics-tab-content hidden">
              <div id="analytics-items-loading" class="text-center py-12">
                <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Loading item analysis...</p>
              </div>
              <div id="analytics-items-content" class="hidden">
                <!-- Item Table -->
                <div class="overflow-x-auto">
                  <table id="analytics-items-table" class="min-w-full text-sm">
                    <thead class="sticky top-0 bg-brand-light-gray dark:bg-brand-dark-gray text-xs uppercase tracking-wide text-brand-dark-gray/80 dark:text-brand-white/70">
                      <tr>
                        <th class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80" data-sort="qNum">Q#</th>
                        <th class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80" data-sort="topic">Topic</th>
                        <th class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80" data-sort="correctPct">Correct%</th>
                        <th class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80" data-sort="rbis">Disc</th>
                        <th class="py-3 px-4 text-left">Choices</th>
                        <th class="py-3 px-4 text-left cursor-pointer hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/80" data-sort="medianTimeSec">Time(s)</th>
                        <th class="py-3 px-4 text-left">Flags</th>
                      </tr>
                    </thead>
                    <tbody id="analytics-items-tbody" class="divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/40">
                      <!-- Items will be rendered here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Student Trends Tab Content -->
            <div id="analytics-content-students" class="p-6 analytics-tab-content hidden">
              <div id="analytics-students-loading" class="text-center py-12">
                <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Loading student data...</p>
              </div>
              <div id="analytics-students-content" class="hidden">
                <!-- STUDENT INSIGHTS PANEL (2025) -->
                <div id="student-insights-panel" class="mb-6">
                  <h2 class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white mb-4">Student Insights</h2>

                  <!-- Insight Cards Grid -->
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <!-- Struggling Students -->
                    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700/50 rounded-lg p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="filterStudentsByFlag('struggling')">
                      <div class="flex items-center gap-3 mb-2">
                        <span class="material-symbols-outlined text-red-600 dark:text-red-400 text-2xl">trending_down</span>
                        <h3 class="font-bold text-red-800 dark:text-red-300 text-sm">Struggling</h3>
                      </div>
                      <p class="text-3xl font-black text-red-700 dark:text-red-400" id="struggling-count">0</p>
                      <p class="text-xs text-red-600/70 dark:text-red-400/70 mt-1">Accuracy < 50%</p>
                    </div>

                    <!-- Non-Responders -->
                    <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-700/50 rounded-lg p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="filterStudentsByFlag('non-responder')">
                      <div class="flex items-center gap-3 mb-2">
                        <span class="material-symbols-outlined text-orange-600 dark:text-orange-400 text-2xl">person_off</span>
                        <h3 class="font-bold text-orange-800 dark:text-orange-300 text-sm">Non-Responders</h3>
                      </div>
                      <p class="text-3xl font-black text-orange-700 dark:text-orange-400" id="non-responder-count">0</p>
                      <p class="text-xs text-orange-600/70 dark:text-orange-400/70 mt-1">Participation < 50%</p>
                    </div>

                    <!-- Rule Violators -->
                    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/50 rounded-lg p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="filterStudentsByFlag('rule-violator')">
                      <div class="flex items-center gap-3 mb-2">
                        <span class="material-symbols-outlined text-yellow-600 dark:text-yellow-400 text-2xl">warning</span>
                        <h3 class="font-bold text-yellow-800 dark:text-yellow-300 text-sm">Rule Violators</h3>
                      </div>
                      <p class="text-3xl font-black text-yellow-700 dark:text-yellow-400" id="rule-violator-count">0</p>
                      <p class="text-xs text-yellow-600/70 dark:text-yellow-400/70 mt-1">2+ violations</p>
                    </div>

                    <!-- High Performers -->
                    <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700/50 rounded-lg p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="filterStudentsByFlag('high-performer')">
                      <div class="flex items-center gap-3 mb-2">
                        <span class="material-symbols-outlined text-green-600 dark:text-green-400 text-2xl">trending_up</span>
                        <h3 class="font-bold text-green-800 dark:text-green-300 text-sm">High Performers</h3>
                      </div>
                      <p class="text-3xl font-black text-green-700 dark:text-green-400" id="high-performer-count">0</p>
                      <p class="text-xs text-green-600/70 dark:text-green-400/70 mt-1">Accuracy â‰¥ 85%</p>
                    </div>
                  </div>

                  <!-- Student List with Filtering -->
                  <div class="bg-white dark:bg-brand-dark-gray/30 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg overflow-hidden">
                    <div class="bg-brand-light-gray/50 dark:bg-brand-dark-gray/50 px-4 py-3 flex items-center justify-between">
                      <h3 class="font-bold text-brand-dark-gray dark:text-brand-white">All Students</h3>
                      <div class="flex items-center gap-2">
                        <button id="clear-student-filter-btn" class="hidden px-3 py-1 bg-brand-dark-gray/10 hover:bg-brand-dark-gray/20 dark:bg-brand-white/10 dark:hover:bg-brand-white/20 rounded text-xs font-semibold transition-colors" onclick="clearStudentFilter()">
                          Clear Filter
                        </button>
                        <span id="student-insights-filter-badge" class="hidden px-2 py-1 bg-primary/20 text-primary text-xs font-bold rounded"></span>
                      </div>
                    </div>
                    <div id="student-insights-table-container" class="overflow-x-auto max-h-96 overflow-y-auto">
                      <table class="w-full">
                        <thead class="bg-brand-light-gray/30 dark:bg-brand-dark-gray/30 sticky top-0">
                          <tr>
                            <th class="px-4 py-2 text-left text-xs font-bold text-brand-dark-gray/70 dark:text-brand-white/70 cursor-pointer hover:bg-brand-light-gray/50 dark:hover:bg-brand-dark-gray/50" onclick="sortStudentsBy('name')">
                              Student <span class="material-symbols-outlined text-xs">unfold_more</span>
                            </th>
                            <th class="px-4 py-2 text-center text-xs font-bold text-brand-dark-gray/70 dark:text-brand-white/70 cursor-pointer hover:bg-brand-light-gray/50 dark:hover:bg-brand-dark-gray/50" onclick="sortStudentsBy('accuracy')">
                              Accuracy <span class="material-symbols-outlined text-xs">unfold_more</span>
                            </th>
                            <th class="px-4 py-2 text-center text-xs font-bold text-brand-dark-gray/70 dark:text-brand-white/70 cursor-pointer hover:bg-brand-light-gray/50 dark:hover:bg-brand-dark-gray/50" onclick="sortStudentsBy('participation')">
                              Participation <span class="material-symbols-outlined text-xs">unfold_more</span>
                            </th>
                            <th class="px-4 py-2 text-center text-xs font-bold text-brand-dark-gray/70 dark:text-brand-white/70 cursor-pointer hover:bg-brand-light-gray/50 dark:hover:bg-brand-dark-gray/50" onclick="sortStudentsBy('violations')">
                              Violations <span class="material-symbols-outlined text-xs">unfold_more</span>
                            </th>
                            <th class="px-4 py-2 text-left text-xs font-bold text-brand-dark-gray/70 dark:text-brand-white/70">
                              Flags
                            </th>
                          </tr>
                        </thead>
                        <tbody id="student-insights-table-body">
                          <!-- Populated by JS -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <!-- Student Search -->
                <div class="mb-6">
                  <input type="text" id="analytics-student-search" placeholder="Search for a student..." class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
                  <div id="analytics-student-suggestions" class="hidden mt-2 bg-brand-white dark:bg-brand-dark-gray/40 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 shadow-lg max-h-60 overflow-y-auto">
                    <!-- Search suggestions -->
                  </div>
                </div>

                <!-- Student Detail -->
                <div id="analytics-student-detail" class="hidden">
                  <div id="analytics-student-summary" class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5 mb-6">
                    <!-- Student summary card -->
                  </div>
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5">
                      <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Consistency Trend</h3>
                      <div id="analytics-student-sparkline"></div>
                    </div>
                    <div class="bg-background-light dark:bg-brand-dark-gray/40 rounded-xl p-5">
                      <h3 class="text-lg font-bold text-brand-dark-gray dark:text-brand-white mb-4">Topic Mastery</h3>
                      <div id="analytics-student-topics"></div>
                    </div>
                  </div>
                </div>

                <div id="analytics-student-empty" class="text-center py-12 text-brand-dark-gray/60 dark:text-brand-white/60">
                  <p>Search for a student to view their analytics</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

    </div>
  </div>

  <!-- Poll Creator Modal -->
  <div id="poll-creator-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/20 z-10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img alt="Malvern Prep Logo" class="h-8 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/f0a824864d7d66637a13b822bff99fa6830e6123/mplogo.png"/>
          <input type="text" id="new-poll-name" placeholder="Chapter 5 Quiz" class="bg-transparent text-brand-white text-xl font-bold border-none focus:ring-0 p-0 placeholder-brand-white/70 min-w-[300px]"/>
        </div>
        <div class="flex items-center gap-2">
          <span id="save-status" class="text-sm text-brand-white/80 mr-2">All changes saved</span>
          <button id="close-modal-btn" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-white/20 text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-white/30 transition-colors">
            <span class="truncate">Cancel</span>
          </button>
          <button id="save-poll-btn" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-white text-primary text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray transition-colors">
            <span class="truncate">Publish Poll</span>
          </button>
        </div>
      </div>

      <div class="flex flex-grow overflow-hidden">
        <!-- Question Navigator Sidebar -->
        <aside class="w-64 flex-shrink-0 border-r border-solid border-brand-light-gray dark:border-brand-dark-gray/20 bg-brand-white dark:bg-background-dark overflow-y-auto">
          <div class="flex h-full flex-col justify-between p-4">
            <div class="mb-4">
              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">Question Order</p>
              <div class="flex items-start justify-between gap-2">
                <p id="question-sort-help" class="flex-1 text-xs leading-relaxed text-brand-dark-gray/60 dark:text-brand-white/60">Drag questions to reorder them manually.</p>
                <button id="question-sort-reset-btn" type="button" class="h-9 px-3 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40 bg-brand-white dark:bg-brand-dark-gray/30 text-xs font-semibold text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/40 dark:hover:bg-brand-dark-gray/50 transition-colors">Reset order</button>
              </div>
            </div>
            <div id="question-navigator" class="flex flex-col gap-2">
              <!-- Question items will be added dynamically -->
            </div>
            <button id="add-question-btn" class="flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary/20 dark:bg-primary/30 text-primary dark:text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/30 dark:hover:bg-primary/40 transition-colors mt-4">
              <span class="truncate">+ Add Question</span>
            </button>
          </div>
        </aside>

        <!-- Editing Workspace -->
        <main class="flex-1 p-8 overflow-y-auto">
          <div class="form-group mb-6">
            <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white" for="class-select">Class</label>
            <select id="class-select" class="w-full max-w-md rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
              <option value="">-- Select Class --</option>
            </select>
          </div>

          <div class="form-group mb-6">
            <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white" for="session-type-select">Session Type</label>
            <select id="session-type-select" class="w-full max-w-md rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
              <option value="LIVE_POLL">Live Poll (Teacher-paced, class reviews each question together)</option>
              <option value="INDIVIDUAL_TIMED">Individual Timed Session (Students work independently with time limit)</option>
            </select>
          </div>

          <div id="time-limit-group" class="form-group mb-6" style="display: none;">
            <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white" for="time-limit-input">Time Limit (minutes)</label>
            <input type="number" id="time-limit-input" min="1" max="180" placeholder="30" class="w-full max-w-md rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50"/>
            <p class="text-xs text-brand-dark-gray/70 dark:text-brand-white/60 mt-1">Students will be automatically locked when time expires</p>
          </div>

          <div id="question-builder-workspace">
            <!-- Question editing workspace will be populated dynamically -->
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- Student Links Modal -->
  <div id="student-links-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/70">
        <h2 class="text-brand-white text-2xl font-bold">Student Personalized Links</h2>
        <p class="text-brand-white/80 text-sm mt-1">Each student has a unique tracking link.</p>
      </div>
      <div class="p-6">
        <div id="links-container" class="max-h-[60vh] overflow-y-auto"></div>
        <div class="mt-6 pt-4 border-t border-primary/20">
          <button id="close-links-modal-btn" class="flex items-center justify-center gap-2 rounded-lg h-10 px-6 bg-primary text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
            <span>Close</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Add Students Modal -->
  <div id="bulk-add-students-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/70">
        <h2 class="text-brand-white text-2xl font-bold">Bulk Add Students</h2>
        <p class="text-brand-white/80 text-sm mt-1">Add multiple students at once. Enter one student per line in format: Name, Email</p>
      </div>
      <div class="p-6 flex-1 overflow-y-auto">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2 text-brand-dark-gray dark:text-brand-white">Student Data</label>
          <textarea id="bulk-student-input" class="w-full h-64 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 font-mono" placeholder="John Smith, jsmith@school.edu&#10;Jane Doe, jdoe@school.edu&#10;Bob Johnson, bjohnson@school.edu"></textarea>
          <p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-2">Format: Name, Email (one per line). Duplicates will be skipped automatically.</p>
        </div>
      </div>
      <div class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-primary/20 flex justify-end gap-3">
        <button id="cancel-bulk-add-btn" class="h-10 px-5 rounded-lg bg-brand-dark-gray/10 dark:bg-brand-white/10 text-brand-dark-gray dark:text-brand-white text-sm font-semibold hover:bg-brand-dark-gray/20 dark:hover:bg-brand-white/20 transition-colors">Cancel</button>
        <button id="confirm-bulk-add-btn" class="h-10 px-5 rounded-lg bg-primary text-brand-white text-sm font-bold hover:bg-primary/90 transition-colors">Add Students</button>
      </div>
    </div>
  </div>

  <!-- Poll Preview Modal -->
  <div id="poll-preview-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header -->
      <div class="sticky top-0 bg-primary px-6 py-4 border-b border-primary/70">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <h2 id="preview-poll-name" class="text-brand-white text-2xl font-bold">Poll Preview</h2>
            <p id="preview-poll-meta" class="text-brand-white/80 text-sm mt-1">Class Name â€¢ 5 Questions</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="preview-open-links-btn" class="flex items-center justify-center gap-2 h-10 px-5 rounded-lg bg-green-600 text-white text-sm font-semibold hover:bg-green-700 transition-colors">
              <span class="material-symbols-outlined text-lg">link</span>
              <span>View Student Links</span>
            </button>
            <button id="close-preview-modal-btn" class="flex items-center justify-center h-10 w-10 rounded-lg bg-brand-white/20 text-brand-white hover:bg-brand-white/30 transition-colors">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Body -->
      <div class="flex-1 overflow-hidden flex">
        <!-- Left Sidebar - Question Navigation -->
        <div class="w-64 border-r border-brand-light-gray dark:border-brand-dark-gray/40 overflow-y-auto bg-gray-50 dark:bg-brand-dark-gray/20">
          <div class="p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Questions</h3>
              <button id="preview-reorder-btn" class="text-xs px-2 py-1 rounded bg-brand-dark-gray/10 dark:bg-brand-white/10 text-brand-dark-gray dark:text-brand-white hover:bg-brand-dark-gray/20 dark:hover:bg-brand-white/20 transition-colors">
                <span class="material-symbols-outlined text-sm align-middle">swap_vert</span>
              </button>
            </div>
            <div id="preview-questions-nav" class="space-y-2">
              <!-- Question navigation items will be added here -->
            </div>
          </div>
        </div>

        <!-- Main Content - Question Display -->
        <div class="flex-1 overflow-y-auto p-6">
          <div id="preview-question-display">
            <!-- Question content will be displayed here -->
          </div>
        </div>
      </div>

      <!-- Footer - Navigation Controls -->
      <div class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-brand-light-gray dark:border-brand-dark-gray/40 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <button id="preview-edit-question-btn" class="h-10 px-4 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors">
            <span class="material-symbols-outlined text-sm align-middle mr-1">edit</span>
            Edit Question
          </button>
          <button id="preview-delete-question-btn" class="h-10 px-4 rounded-lg bg-red-600/10 text-red-600 dark:bg-red-500/20 dark:text-red-300 text-sm font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors">
            <span class="material-symbols-outlined text-sm align-middle mr-1">delete</span>
            Delete
          </button>
        </div>
        <div class="flex items-center gap-2">
          <button id="preview-prev-question-btn" class="h-10 px-4 rounded-lg bg-brand-dark-gray/10 dark:bg-brand-white/10 text-brand-dark-gray dark:text-brand-white text-sm font-semibold hover:bg-brand-dark-gray/20 dark:hover:bg-brand-white/20 transition-colors">
            <span class="material-symbols-outlined text-sm align-middle mr-1">arrow_back</span>
            Previous
          </button>
          <span id="preview-question-counter" class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60 px-2">1 / 5</span>
          <button id="preview-next-question-btn" class="h-10 px-4 rounded-lg bg-brand-dark-gray/10 dark:bg-brand-white/10 text-brand-dark-gray dark:text-brand-white text-sm font-semibold hover:bg-brand-dark-gray/20 dark:hover:bg-brand-white/20 transition-colors">
            Next
            <span class="material-symbols-outlined text-sm align-middle ml-1">arrow_forward</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Post-Poll Analytics Modal -->
  <div id="post-poll-analytics-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="modal-content bg-brand-white dark:bg-brand-dark-gray rounded-xl shadow-2xl w-full max-w-7xl max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header -->
      <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-4 border-b border-white/20">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <h2 id="analytics-poll-name" class="text-brand-white text-2xl font-bold">Psychometric Analysis</h2>
            <p id="analytics-poll-meta" class="text-brand-white/90 text-sm mt-1">Professional Assessment Quality Report</p>
          </div>
          <button id="close-analytics-modal-btn" class="flex items-center justify-center h-10 w-10 rounded-lg bg-brand-white/20 text-brand-white hover:bg-brand-white/30 transition-colors">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
      </div>

      <!-- Body -->
      <div class="flex-1 overflow-y-auto p-6">
        <div id="analytics-content">
          <!-- Loading state -->
          <div id="analytics-loading" class="flex items-center justify-center py-12">
            <div class="flex flex-col items-center gap-3">
              <div class="h-12 w-12 animate-spin rounded-full border-4 border-primary border-t-transparent"></div>
              <p class="text-brand-dark-gray/60 dark:text-brand-white/60">Computing analytics...</p>
            </div>
          </div>

          <!-- Content will be rendered here -->
          <div id="analytics-report" class="hidden">
            <!-- Class Overview Section -->
            <div class="mb-6">
              <h3 class="text-xl font-bold text-brand-dark-gray dark:text-brand-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">bar_chart</span>
                Class Overview
              </h3>
              <div id="class-overview-content"></div>
            </div>

            <!-- Metacognition Section -->
            <div id="metacognition-section" class="mb-6 hidden">
              <h3 class="text-xl font-bold text-brand-dark-gray dark:text-brand-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-purple-600">psychology</span>
                Metacognition Analysis
              </h3>
              <div id="metacognition-content"></div>
            </div>

            <!-- Item Analysis Section -->
            <div class="mb-6">
              <h3 class="text-xl font-bold text-brand-dark-gray dark:text-brand-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-blue-600">assignment</span>
                Item-by-Item Analysis
              </h3>
              <div id="item-analysis-content"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="sticky bottom-0 bg-brand-white dark:bg-brand-dark-gray px-6 py-4 border-t border-brand-light-gray dark:border-brand-dark-gray/40 flex items-center justify-between">
        <div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">
          <p>ðŸ“Š Powered by professional psychometric analysis</p>
        </div>
        <button id="export-analytics-btn" class="h-10 px-5 rounded-lg bg-veritas-gold text-brand-white text-sm font-semibold hover:bg-veritas-gold/90 transition-colors">
          <span class="material-symbols-outlined text-sm align-middle mr-1">download</span>
          Export Report
        </button>
      </div>
    </div>
  </div>

  <script>
(function(){
  // --- Main App State ---
  var mainLoader=document.getElementById('loader');
  var ALL_POLLS=[];
  var ALL_CLASSES=[];
  var CURRENT_POLL_DATA={};
  var currentStudentStatusData=[];
  var studentSearchQuery='';
  var studentTableSort={column:'lastName',direction:'asc'};
  var pollInterval=null;
  var visualTimerInterval=null;
  var isPaused=false;
  var isLiveSession=false;
  var isNavigating=false; // Flag to prevent polling during question navigation
  var questionCounter=0;
  var questions=[];
  var questionIdCounter=0;
  var customQuestionOrder=[];
  var initialQuestionOrder=[];
  var draggedQuestionId=null;
  var pollSearchQuery='';
  var sessionHudState={
    lastCompletionPct:null,
    lastAccuracyPct:null,
    lastLockoutTotal:null,
    allRespondedCelebrated:false
  };

  // OPTIMIZATION: Adaptive polling with backoff (like student view)
  var pollFailureCount=0;
  var basePollInterval=2500;
  var currentPollInterval=2500;
  var maxPollInterval=10000;

  // OPTIMIZATION: Client-side caching with localStorage
  var LocalCache={
    get:function(key){
      try{
        var cached=localStorage.getItem('vlp_'+key);
        if(!cached)return null;
        var data=JSON.parse(cached);
        if(data.expires&&Date.now()>data.expires)return null;
        return data.value;
      }catch(e){
        console.warn('LocalCache get error:',e);
        return null;
      }
    },
    set:function(key,value,ttlMs){
      try{
        var data={
          value:value,
          expires:ttlMs?Date.now()+ttlMs:null
        };
        localStorage.setItem('vlp_'+key,JSON.stringify(data));
      }catch(e){
        console.warn('LocalCache set error:',e);
      }
    },
    invalidate:function(key){
      try{
        localStorage.removeItem('vlp_'+key);
      }catch(e){
        console.warn('LocalCache invalidate error:',e);
      }
    }
  };

  var CONFIDENCE_LEVEL_STYLES={
    'guessing':{
      label:'Guessing',
      emoji:'ðŸ¤”',
      textClass:'text-red-700 dark:text-red-200',
      badgeClass:'bg-red-500/10 text-red-700 dark:text-red-200 border border-red-500/30',
      barClass:'bg-red-500',
      accentClass:'text-red-700/80 dark:text-red-200/80'
    },
    'somewhat-sure':{
      label:'Somewhat sure',
      emoji:'ðŸ¤·',
      textClass:'text-amber-700 dark:text-amber-200',
      badgeClass:'bg-amber-500/10 text-amber-700 dark:text-amber-200 border border-amber-500/30',
      barClass:'bg-amber-500',
      accentClass:'text-amber-700/80 dark:text-amber-200/80'
    },
    'very-sure':{
      label:'Very sure',
      emoji:'ðŸ‘',
      textClass:'text-blue-700 dark:text-blue-200',
      badgeClass:'bg-blue-500/10 text-blue-700 dark:text-blue-200 border border-blue-500/30',
      barClass:'bg-blue-500',
      accentClass:'text-blue-700/80 dark:text-blue-200/80'
    },
    'certain':{
      label:'Absolutely certain',
      emoji:'ðŸ’¯',
      textClass:'text-green-700 dark:text-green-200',
      badgeClass:'bg-green-500/10 text-green-700 dark:text-green-200 border border-green-500/30',
      barClass:'bg-green-500',
      accentClass:'text-green-700/80 dark:text-green-200/80'
    }
  };

  /* ========================================
     ðŸŽ¨ ENHANCED UI SYSTEM - JAVASCRIPT
     ======================================== */

  // === Toast Notification System ===
  function showToast(type, title, message, duration = 5000) {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;

    const icons = {
      success: 'check_circle',
      error: 'error',
      warning: 'warning',
      info: 'info'
    };

    toast.innerHTML = `
      <span class="material-symbols-outlined toast-icon">${icons[type] || 'notifications'}</span>
      <div class="toast-content">
        <div class="toast-title">${title}</div>
        <div class="toast-message">${message}</div>
      </div>
      <button class="toast-close" onclick="this.closest('.toast').remove()">
        <span class="material-symbols-outlined" style="font-size: 18px">close</span>
      </button>
      <div class="toast-progress"></div>
    `;

    container.appendChild(toast);

    // Auto-remove after duration
    setTimeout(() => {
      toast.classList.add('toast-out');
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  // === Floating Action Button (FAB) System ===
  let fabMenuOpen = false;

  function initializeFAB() {
    const fabMainToggle = document.getElementById('fab-main-toggle');
    const fabMenu = document.getElementById('fab-menu');
    const fabContainer = document.getElementById('fab-container');

    if (!fabMainToggle || !fabMenu) return;

    fabMainToggle.addEventListener('click', function() {
      fabMenuOpen = !fabMenuOpen;

      if (fabMenuOpen) {
        fabMenu.classList.add('is-open');
        fabMainToggle.classList.add('is-open');
        fabMainToggle.setAttribute('aria-expanded', 'true');
      } else {
        fabMenu.classList.remove('is-open');
        fabMainToggle.classList.remove('is-open');
        fabMainToggle.setAttribute('aria-expanded', 'false');
      }
    });

    // Wire up FAB actions to existing functions
    const fabNextBtn = document.getElementById('fab-next-btn');
    const fabShowResultsBtn = document.getElementById('fab-show-results-btn');
    const fabResetBtn = document.getElementById('fab-reset-btn');
    const fabStopBtn = document.getElementById('fab-stop-btn');

    if (fabNextBtn) {
      fabNextBtn.addEventListener('click', function() {
        nextQuestion();
        closeFABMenu();
      });
    }

    if (fabShowResultsBtn) {
      fabShowResultsBtn.addEventListener('click', function() {
        const endShowBtn = document.getElementById('header-end-show-btn');
        if (endShowBtn && endShowBtn.style.display !== 'none') {
          endShowBtn.click();
        }
        closeFABMenu();
      });
    }

    if (fabResetBtn) {
      fabResetBtn.addEventListener('click', function() {
        resetLiveQuestion();
        closeFABMenu();
      });
    }

    if (fabStopBtn) {
      fabStopBtn.addEventListener('click', function() {
        stopPoll();
        closeFABMenu();
      });
    }

    // Close FAB menu when clicking outside
    document.addEventListener('click', function(e) {
      if (fabMenuOpen && !fabContainer.contains(e.target)) {
        closeFABMenu();
      }
    });
  }

  function closeFABMenu() {
    fabMenuOpen = false;
    const fabMenu = document.getElementById('fab-menu');
    const fabMainToggle = document.getElementById('fab-main-toggle');
    if (fabMenu) fabMenu.classList.remove('is-open');
    if (fabMainToggle) {
      fabMainToggle.classList.remove('is-open');
      fabMainToggle.setAttribute('aria-expanded', 'false');
    }
  }

  // === Progress Ring Updates ===
  function updateProgressRing(ringId, percentage) {
    const ring = document.getElementById(ringId);
    if (!ring) return;

    const circumference = 138.23; // 2 * Ï€ * 22 (radius)
    const offset = circumference - (percentage / 100) * circumference;
    ring.style.strokeDashoffset = offset;

    // Update ring color based on percentage
    ring.classList.remove('ring-success', 'ring-warning', 'ring-danger');
    if (percentage >= 70) {
      ring.classList.add('ring-success');
    } else if (percentage >= 40) {
      ring.classList.add('ring-warning');
    } else {
      ring.classList.add('ring-danger');
    }
  }

  // === Ambient State Management ===
  function setAmbientState(state) {
    const overlay = document.getElementById('ambient-state-overlay');
    if (!overlay) return;

    // Remove all state classes
    overlay.className = 'ambient-state-overlay';

    // Add new state class
    if (state && state !== 'normal') {
      overlay.classList.add(`state-${state}`);
    } else {
      overlay.classList.add('state-normal');
    }
  }

  // === Sparkline Visualization System ===
  // Track historical data for sparklines
  var sparklineData = {
    responses: [],
    accuracy: [],
    maxPoints: 20 // Keep last 20 data points
  };

  function addSparklineDataPoint(metric, value) {
    if (!sparklineData[metric]) {
      sparklineData[metric] = [];
    }
    sparklineData[metric].push(value);

    // Keep only maxPoints
    if (sparklineData[metric].length > sparklineData.maxPoints) {
      sparklineData[metric].shift();
    }
  }

  function renderSparkline(containerId, data, color) {
    const container = document.getElementById(containerId);
    if (!container || !data || data.length < 2) return;

    const width = 100;
    const height = 28;
    const padding = 2;

    // Calculate min/max for scaling
    const min = Math.min(...data);
    const max = Math.max(...data);
    const range = max - min || 1;

    // Create SVG if it doesn't exist
    let svg = container.querySelector('svg');
    if (!svg) {
      svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('class', 'sparkline');
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

      // Add gradient definition
      const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
      gradient.setAttribute('id', `sparkline-gradient-${containerId}`);
      gradient.setAttribute('x1', '0%');
      gradient.setAttribute('y1', '0%');
      gradient.setAttribute('x2', '0%');
      gradient.setAttribute('y2', '100%');

      const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
      stop1.setAttribute('offset', '0%');
      stop1.setAttribute('stop-color', color || '#c5a05a');
      stop1.setAttribute('stop-opacity', '0.5');

      const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
      stop2.setAttribute('offset', '100%');
      stop2.setAttribute('stop-color', color || '#c5a05a');
      stop2.setAttribute('stop-opacity', '0.1');

      gradient.appendChild(stop1);
      gradient.appendChild(stop2);
      defs.appendChild(gradient);
      svg.appendChild(defs);

      container.appendChild(svg);
    }

    // Clear previous content except defs
    const defs = svg.querySelector('defs');
    svg.innerHTML = '';
    if (defs) svg.appendChild(defs);

    // Calculate points
    const stepX = (width - 2 * padding) / (data.length - 1);
    let linePoints = '';
    let areaPoints = `${padding},${height - padding}`;

    data.forEach((value, index) => {
      const x = padding + index * stepX;
      const y = padding + (height - 2 * padding) * (1 - (value - min) / range);

      if (index === 0) {
        linePoints = `M ${x},${y}`;
      } else {
        linePoints += ` L ${x},${y}`;
      }

      areaPoints += ` ${x},${y}`;
    });

    areaPoints += ` ${padding + (data.length - 1) * stepX},${height - padding}`;

    // Create area path
    const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    area.setAttribute('d', areaPoints + ' Z');
    area.setAttribute('class', 'sparkline-area');
    area.setAttribute('fill', `url(#sparkline-gradient-${containerId})`);
    svg.appendChild(area);

    // Create line path
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    line.setAttribute('d', linePoints);
    line.setAttribute('class', 'sparkline-line');
    line.setAttribute('stroke', color || '#c5a05a');
    svg.appendChild(line);

    // Add dots
    data.forEach((value, index) => {
      const x = padding + index * stepX;
      const y = padding + (height - 2 * padding) * (1 - (value - min) / range);

      const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      dot.setAttribute('cx', x);
      dot.setAttribute('cy', y);
      dot.setAttribute('class', 'sparkline-dot');
      dot.setAttribute('fill', color || '#c5a05a');
      svg.appendChild(dot);
    });
  }

  // === Loading Skeleton System ===
  function createSkeletonLoader(type = 'card') {
    const skeleton = document.createElement('div');
    skeleton.className = 'animate-pulse';

    if (type === 'card') {
      skeleton.innerHTML = `
        <div class="bg-gray-200 dark:bg-gray-700 h-40 rounded-t-2xl"></div>
        <div class="p-4 space-y-3">
          <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
          <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
          <div class="flex gap-2 mt-4">
            <div class="h-8 bg-gray-200 dark:bg-gray-700 rounded flex-1"></div>
            <div class="h-8 bg-gray-200 dark:bg-gray-700 rounded flex-1"></div>
          </div>
        </div>
      `;
    } else if (type === 'hud') {
      skeleton.innerHTML = `
        <div class="flex gap-4">
          <div class="w-12 h-12 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
          <div class="flex-1 space-y-2">
            <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/3"></div>
            <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
          </div>
        </div>
      `;
    }

    return skeleton;
  }

  // === Enhanced Visual Timer States ===
  function updateTimerVisualState(remainingSeconds, totalSeconds) {
    const timerContainers = [
      document.getElementById('timer-main-container'),
      document.getElementById('timer-compact-container')
    ];

    timerContainers.forEach(function(container) {
      if (!container) return;

      // Remove all state classes
      container.classList.remove('timer-warning', 'timer-critical');

      // Calculate percentage remaining
      const percentage = totalSeconds > 0 ? (remainingSeconds / totalSeconds) * 100 : 100;

      // Apply appropriate state class
      if (remainingSeconds <= 10 && remainingSeconds > 0) {
        container.classList.add('timer-critical');
        setAmbientState('time-critical');
      } else if (percentage <= 25 && remainingSeconds > 10) {
        container.classList.add('timer-warning');
      } else {
        setAmbientState('normal');
      }
    });
  }

  // === Celebration Animation System ===
  function triggerCelebration(element, type = 'default') {
    if (!element) return;

    element.classList.remove('celebrate');

    // Force reflow to restart animation
    void element.offsetWidth;

    element.classList.add('celebrate');

    // Remove class after animation completes
    setTimeout(function() {
      element.classList.remove('celebrate');
    }, 600);

    // Show toast notification for major milestones
    if (type === 'all-responded') {
      showToast('success', 'ðŸŽ‰ All Students Responded!', 'Great work! Everyone has submitted their answer.');
      setAmbientState('all-responded');
      playSoundEffect('celebration');
    } else if (type === 'perfect-accuracy') {
      showToast('success', 'ðŸ’¯ Perfect Accuracy!', '100% of students got the answer correct!');
      playSoundEffect('celebration');
    }
  }

  // === Activity Feed System ===
  var activityFeedData = [];
  var activityFeedOpen = false;
  var maxActivityItems = 50; // Keep last 50 activities

  function initializeActivityFeed() {
    const activityFeed = document.getElementById('activity-feed');
    const activityFeedClose = document.getElementById('activity-feed-close');
    const fabActivityBtn = document.getElementById('fab-activity-btn');

    if (!activityFeed) return;

    // Close button handler
    if (activityFeedClose) {
      activityFeedClose.addEventListener('click', function() {
        closeActivityFeed();
      });
    }

    // FAB toggle button handler
    if (fabActivityBtn) {
      fabActivityBtn.addEventListener('click', function() {
        toggleActivityFeed();
        closeFABMenu();
      });
    }

    // Click outside to close
    document.addEventListener('click', function(e) {
      if (activityFeedOpen &&
          !activityFeed.contains(e.target) &&
          !fabActivityBtn.contains(e.target)) {
        closeActivityFeed();
      }
    });
  }

  function toggleActivityFeed() {
    if (activityFeedOpen) {
      closeActivityFeed();
    } else {
      openActivityFeed();
    }
  }

  function openActivityFeed() {
    const activityFeed = document.getElementById('activity-feed');
    if (!activityFeed) return;

    activityFeed.classList.add('is-open');
    activityFeedOpen = true;
  }

  function closeActivityFeed() {
    const activityFeed = document.getElementById('activity-feed');
    if (!activityFeed) return;

    activityFeed.classList.remove('is-open');
    activityFeedOpen = false;
  }

  function addActivityItem(type, icon, message) {
    const timestamp = new Date();
    const activity = {
      type: type, // 'success', 'warning', 'error', 'info'
      icon: icon, // Material icon name
      message: message,
      timestamp: timestamp
    };

    activityFeedData.unshift(activity); // Add to beginning

    // Keep only maxActivityItems
    if (activityFeedData.length > maxActivityItems) {
      activityFeedData = activityFeedData.slice(0, maxActivityItems);
    }

    renderActivityFeed();
  }

  function renderActivityFeed() {
    const list = document.getElementById('activity-feed-list');
    const count = document.getElementById('activity-feed-count');

    if (!list) return;

    if (activityFeedData.length === 0) {
      list.innerHTML = `
        <div class="activity-feed-empty">
          <span class="material-symbols-outlined">inbox</span>
          <p>No recent activity</p>
        </div>
      `;
      if (count) count.textContent = '0';
      return;
    }

    if (count) count.textContent = activityFeedData.length.toString();

    const items = activityFeedData.map(function(activity) {
      const timeAgo = getTimeAgo(activity.timestamp);
      return `
        <div class="activity-item">
          <div class="activity-icon ${activity.type}">
            <span class="material-symbols-outlined">${activity.icon}</span>
          </div>
          <div class="activity-content">
            <div class="activity-message">${escapeHtml(activity.message)}</div>
            <div class="activity-time">${timeAgo}</div>
          </div>
        </div>
      `;
    }).join('');

    list.innerHTML = items;
  }

  function getTimeAgo(timestamp) {
    const now = new Date();
    const seconds = Math.floor((now - timestamp) / 1000);

    if (seconds < 10) return 'just now';
    if (seconds < 60) return seconds + 's ago';

    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return minutes + 'm ago';

    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + 'h ago';

    const days = Math.floor(hours / 24);
    return days + 'd ago';
  }

  // Hook into existing events to add activities
  function trackStudentResponse(studentName, isCorrect) {
    const type = isCorrect ? 'success' : 'info';
    const icon = isCorrect ? 'check_circle' : 'radio_button_unchecked';
    const message = `${studentName} answered ${isCorrect ? 'correctly' : ''}`;
    addActivityItem(type, icon, message);
  }

  function trackStudentLockout(studentName) {
    addActivityItem('warning', 'lock_person', `${studentName} was locked out`);
  }

  function trackStudentUnlock(studentName) {
    addActivityItem('success', 'lock_open', `${studentName} was unlocked`);
  }

  function trackAllResponded() {
    addActivityItem('success', 'celebration', 'All students responded!');
  }

  function trackQuestionAdvance(questionNum) {
    addActivityItem('info', 'arrow_forward', `Advanced to Question ${questionNum}`);
  }

  // === Sound Effects System ===
  var soundEffectsEnabled = false; // Disabled by default, can be enabled via settings
  var audioContext = null;

  function initializeAudioContext() {
    if (!audioContext && typeof AudioContext !== 'undefined') {
      audioContext = new AudioContext();
    } else if (!audioContext && typeof webkitAudioContext !== 'undefined') {
      audioContext = new webkitAudioContext();
    }
    return audioContext;
  }

  function playSoundEffect(type) {
    if (!soundEffectsEnabled) return;

    const ctx = initializeAudioContext();
    if (!ctx) return;

    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);

    // Configure sound based on type
    switch(type) {
      case 'success':
        // Happy ascending chime
        oscillator.frequency.setValueAtTime(523.25, ctx.currentTime); // C5
        oscillator.frequency.exponentialRampToValueAtTime(783.99, ctx.currentTime + 0.1); // G5
        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.3);
        break;

      case 'celebration':
        // Triple ascending tones
        playTone(ctx, 523.25, 0.0, 0.1, 0.25); // C5
        playTone(ctx, 659.25, 0.1, 0.1, 0.25); // E5
        playTone(ctx, 783.99, 0.2, 0.15, 0.3); // G5
        break;

      case 'warning':
        // Descending tone
        oscillator.frequency.setValueAtTime(440, ctx.currentTime); // A4
        oscillator.frequency.exponentialRampToValueAtTime(220, ctx.currentTime + 0.15);
        gainNode.gain.setValueAtTime(0.25, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.2);
        break;

      case 'notification':
        // Single gentle tone
        oscillator.frequency.value = 880; // A5
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.15);
        break;
    }
  }

  function playTone(ctx, frequency, startTime, duration, gain) {
    const osc = ctx.createOscillator();
    const g = ctx.createGain();

    osc.connect(g);
    g.connect(ctx.destination);

    osc.frequency.value = frequency;
    osc.type = 'sine';
    g.gain.setValueAtTime(gain, ctx.currentTime + startTime);
    g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + startTime + duration);

    osc.start(ctx.currentTime + startTime);
    osc.stop(ctx.currentTime + startTime + duration);
  }

  function toggleSoundEffects() {
    soundEffectsEnabled = !soundEffectsEnabled;
    showToast('info', 'Sound Effects', soundEffectsEnabled ? 'Sound effects enabled' : 'Sound effects disabled', 2000);
  }

  // === Keyboard Shortcuts System ===
  var keyboardShortcutsEnabled = true;

  function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
      if (!keyboardShortcutsEnabled) return;

      // Don't trigger if user is typing in an input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      // Check if in live view
      const liveView = document.getElementById('live-view');
      if (!liveView || liveView.style.display === 'none') return;

      switch(e.key) {
        case 'ArrowRight':
          e.preventDefault();
          const nextBtn = document.getElementById('header-next-btn');
          if (nextBtn && !nextBtn.disabled) nextBtn.click();
          break;

        case 'ArrowLeft':
          e.preventDefault();
          const backBtn = document.getElementById('header-back-btn');
          if (backBtn && !backBtn.disabled) backBtn.click();
          break;

        case ' ': // Space
          // Only for timer control
          if (e.target.id === 'timer-display') return; // Allow editing timer
          e.preventDefault();
          const timerState = timerActive;
          if (timerState) {
            pauseTimer();
          } else {
            startTimer();
          }
          break;

        case 'r':
        case 'R':
          e.preventDefault();
          const resetBtn = document.getElementById('header-reset-question-btn');
          if (resetBtn && !resetBtn.disabled) resetBtn.click();
          break;

        case 'a':
        case 'A':
          e.preventDefault();
          toggleActivityFeed();
          break;

        case 'Escape':
          e.preventDefault();
          if (activityFeedOpen) closeActivityFeed();
          if (fabMenuOpen) closeFABMenu();
          break;
      }
    });
  }

  // === Initialize Enhanced UI Systems ===
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize FAB system
    initializeFAB();

    // Initialize Activity Feed
    initializeActivityFeed();

    // Initialize Keyboard Shortcuts
    initializeKeyboardShortcuts();

    console.log('âœ¨ Enhanced UI systems initialized (Phase 3)');
  });

  function describeConfidence(value){
    var entry=CONFIDENCE_LEVEL_STYLES[value];
    if(!entry)return null;
    return entry.emoji+' '+entry.label;
  }

  var selectedQuestionIndex=0;
  var editingPollId=null;
  var isPollDirty=false;
  var pollSortMode='updated_desc';
  var pollClassFilter='all';
  var rosterData={};
  var selectedRosterClass='';
  var rosterDirty=false;
  var archivedPolls=[];
  var archivedClassFilter='all';
  var selectedArchivedPollId='';
  var BASE_CLASSES=[];
  var dashboardSummary=null;
  var analyticsRefreshInterval=null;
  var googleChartsReady=false;
  var googleChartsLoading=false;
  var googleChartsBootstrapTimer=null;

  var appsScriptAvailable=!!(window.google&&window.google.script&&window.google.script.run);
  var PREVIEW_MODE=!appsScriptAvailable;

  function deepClone(value){
    try{
      return JSON.parse(JSON.stringify(value));
    }catch(err){
      console.warn('Preview clone fallback failed:',err);
      return value;
    }
  }

  var PREVIEW_PAYLOAD=PREVIEW_MODE?{
    classes:['AP Biology â€“ Period 5','Chemistry â€“ Period 2','World History â€“ Period 7'],
    polls:[
      {
        pollId:'demo-bio-1',
        pollName:'Photosynthesis Pulse Check',
        className:'AP Biology â€“ Period 5',
        updatedAt:new Date(Date.now()-3600*1000).toISOString(),
        lastRunAt:new Date(Date.now()-7200*1000).toISOString(),
        createdAt:new Date(Date.now()-86400*1000*3).toISOString(),
        questions:[
          {
            questionText:'Which organelle performs photosynthesis in plant cells?',
            options:[
              {text:'Mitochondrion'},
              {text:'Chloroplast'},
              {text:'Golgi apparatus'},
              {text:'Nucleus'}
            ],
            correctAnswer:'Chloroplast',
            correctAnswerLetter:'B',
            timerSeconds:90
          },
          {
            questionText:'What pigment captures light energy for photosynthesis?',
            options:[
              {text:'Hemoglobin'},
              {text:'Chlorophyll'},
              {text:'Keratin'},
              {text:'Melanin'}
            ],
            correctAnswer:'Chlorophyll',
            correctAnswerLetter:'B',
            timerSeconds:75
          }
        ]
      },
      {
        pollId:'demo-chem-1',
        pollName:'Stoichiometry Warm-Up',
        className:'Chemistry â€“ Period 2',
        updatedAt:new Date(Date.now()-5400*1000).toISOString(),
        lastRunAt:new Date(Date.now()-86400*1000).toISOString(),
        createdAt:new Date(Date.now()-86400*1000*5).toISOString(),
        questions:[
          {
            questionText:'How many moles are in 36 grams of water (Hâ‚‚O)?',
            options:[
              {text:'1.0 mol'},
              {text:'2.0 mol'},
              {text:'0.5 mol'},
              {text:'4.0 mol'}
            ],
            correctAnswer:'2.0 mol',
            correctAnswerLetter:'B',
            timerSeconds:60
          },
          {
            questionText:'What is the limiting reactant when 2 mol of Hâ‚‚ reacts with 1 mol of Oâ‚‚?',
            options:[
              {text:'Hydrogen'},
              {text:'Oxygen'},
              {text:'Water'},
              {text:'None'}
            ],
            correctAnswer:'Hydrogen',
            correctAnswerLetter:'A',
            timerSeconds:65
          }
        ]
      }
    ],
    dashboardSummary:{
      recentSessions:[
        {sessionName:'Cell Energy Exit Ticket',date:new Date(Date.now()-3600*1000*20).toISOString(),className:'AP Biology â€“ Period 5',participationPct:92,masteryPct:78,flags:1},
        {sessionName:'Stoichiometry Practice',date:new Date(Date.now()-3600*1000*42).toISOString(),className:'Chemistry â€“ Period 2',participationPct:88,masteryPct:74,flags:0},
        {sessionName:'Industrial Revolution Check',date:new Date(Date.now()-3600*1000*65).toISOString(),className:'World History â€“ Period 7',participationPct:83,masteryPct:69,flags:0}
      ],
      dailyActivity:[
        {dayName:'Mon',count:18},
        {dayName:'Tue',count:22},
        {dayName:'Wed',count:31},
        {dayName:'Thu',count:26},
        {dayName:'Fri',count:19},
        {dayName:'Sat',count:9},
        {dayName:'Sun',count:6}
      ],
      weekOverWeekChange:6,
      totalActivityThisWeek:131
    },
    rosters:{
      'AP Biology â€“ Period 5':[
        {name:'Ava Martinez',email:'ava.martinez@school.edu'},
        {name:'Ethan Patel',email:'ethan.patel@school.edu'},
        {name:'Grace Lee',email:'grace.lee@school.edu'},
        {name:'Noah Williams',email:'noah.williams@school.edu'}
      ],
      'Chemistry â€“ Period 2':[
        {name:'Liam Johnson',email:'liam.johnson@school.edu'},
        {name:'Sophia Chen',email:'sophia.chen@school.edu'},
        {name:'Mason Rivera',email:'mason.rivera@school.edu'}
      ],
      'World History â€“ Period 7':[
        {name:'Olivia Brooks',email:'olivia.brooks@school.edu'},
        {name:'Henry Adams',email:'henry.adams@school.edu'}
      ]
    },
    archivedPolls:[
      {
        pollId:'arch-bio-1',
        pollName:'Cell Processes Review',
        className:'AP Biology â€“ Period 5',
        lastRunAt:new Date(Date.now()-86400*1000*9).toISOString(),
        createdAt:new Date(Date.now()-86400*1000*20).toISOString(),
        questionCount:4,
        totalResponses:22,
        totalStudents:24,
        questions:[
          {
            questionText:'What is ATP often called within the cell?',
            options:[{text:'Energy currency'},{text:'Protein factory'},{text:'Genetic blueprint'},{text:'Cell wall'}],
            correctAnswer:'Energy currency',
            summary:{correct:18,incorrect:3,noResponse:3,violations:0},
            responses:[
              {name:'Ava Martinez',answer:'Energy currency',isCorrect:true},
              {name:'Ethan Patel',answer:'Energy currency',isCorrect:true},
              {name:'Grace Lee',answer:'Protein factory',isCorrect:false}
            ],
            nonResponders:[
              {name:'Noah Williams'},
              {name:'Miles Turner'}
            ]
          }
        ]
      }
    ],
    analytics:{
      kpis:[
        {label:'Avg Participation',value:'88%',delta:5,tooltip:'Average participation over the last 7 days.'},
        {label:'Mastery Trend',value:'74%',delta:3,tooltip:'Average mastery compared to last week.'},
        {label:'Integrity Events',value:'2',delta:-1,tooltip:'Academic integrity events this week.'}
      ],
      topics:[
        {topic:'Cell Biology',masteryPct:82,questionCount:12},
        {topic:'Metabolism',masteryPct:68,questionCount:9},
        {topic:'Industrialization',masteryPct:74,questionCount:7}
      ],
      items:[
        {qNum:1,topic:'Cell Biology',correctPct:84,rbis:0.38,choiceCounts:{A:2,B:18,C:4,D:1},correctIndex:1,medianTimeSec:32,total:25,flags:[]},
        {qNum:2,topic:'Metabolism',correctPct:61,rbis:0.22,choiceCounts:{A:5,B:9,C:8,D:3},correctIndex:2,medianTimeSec:45,total:25,flags:['watch']},
        {qNum:3,topic:'Industrialization',correctPct:47,rbis:0.11,choiceCounts:{A:10,B:6,C:7,D:2},correctIndex:0,medianTimeSec:38,total:25,flags:['low-disc']}
      ],
      students:{
        'ava.martinez@school.edu':{
          name:'Ava Martinez',
          email:'ava.martinez@school.edu',
          successLast10:92.0,
          participationPct:100,
          integrityCount:0,
          sessions:[
            {sessionName:'Cell Energy Exit Ticket',scorePct:95},
            {sessionName:'Metabolism Pop Quiz',scorePct:88},
            {sessionName:'Photosynthesis Check',scorePct:93}
          ],
          topicPerformance:{
            'Cell Biology':{correct:18,total:20},
            'Metabolism':{correct:14,total:16},
            'Industrialization':{correct:6,total:8}
          }
        },
        'ethan.patel@school.edu':{
          name:'Ethan Patel',
          email:'ethan.patel@school.edu',
          successLast10:78.0,
          participationPct:86,
          integrityCount:1,
          sessions:[
            {sessionName:'Cell Energy Exit Ticket',scorePct:82},
            {sessionName:'Metabolism Pop Quiz',scorePct:74},
            {sessionName:'Photosynthesis Check',scorePct:78}
          ],
          topicPerformance:{
            'Cell Biology':{correct:15,total:20},
            'Metabolism':{correct:10,total:16},
            'Industrialization':{correct:5,total:8}
          }
        }
      }
    }
  }:null;

  function previewOnlyNotice(actionLabel){
    var actionText=actionLabel||'complete this action';
    return veritasAlert('This feature is disabled in preview mode. Open the deployed Veritas dashboard to '+actionText+'.',{
      title:'Preview mode'
    });
  }

  // Update header datetime
  function updateHeaderDateTime() {
    var datetimeEl = document.getElementById('header-datetime');
    if (datetimeEl) {
      var now = new Date();
      var options = { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' };
      datetimeEl.textContent = now.toLocaleDateString('en-US', options);
    }
  }
  updateHeaderDateTime();
  setInterval(updateHeaderDateTime, 60000); // Update every minute

  var VeritasModal=null;
  var veritasModalReady=new Promise(function(resolve){
    function initializeModal(){
      VeritasModal=window.VeritasModal||createVeritasModal();
      window.VeritasModal=VeritasModal;
      resolve(VeritasModal);
    }

    if(document.readyState==='loading'){
      document.addEventListener('DOMContentLoaded',initializeModal,{once:true});
    }else{
      initializeModal();
    }
  });

  function withVeritasModal(callback){
    return veritasModalReady.then(function(controller){
      return callback(controller);
    });
  }

  function veritasAlert(message,options){
    return withVeritasModal(function(modal){
      return modal.alert(Object.assign({message:message},options||{}));
    });
  }

  function veritasConfirm(message,options){
    return withVeritasModal(function(modal){
      return modal.confirm(Object.assign({message:message},options||{}));
    });
  }

  function veritasPrompt(message,options){
    return withVeritasModal(function(modal){
      return modal.prompt(Object.assign({message:message},options||{}));
    });
  }

  function ensureVeritasModalRoot(){
    var existing=document.getElementById('veritas-modal-root');
    if(existing){
      return existing;
    }

    var root=document.createElement('div');
    root.id='veritas-modal-root';
    root.className='veritas-modal-root';
    root.setAttribute('aria-hidden','true');
    root.innerHTML=''+
      '<div class="veritas-modal-backdrop"></div>'+
      '<div class="veritas-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="veritas-modal-title" aria-describedby="veritas-modal-message">'+
        '<div class="veritas-modal-header">'+
          '<h2 id="veritas-modal-title">Notice</h2>'+
        '</div>'+
        '<div class="veritas-modal-body">'+
          '<p id="veritas-modal-message"></p>'+
          '<div id="veritas-modal-subtext" class="veritas-modal-subtext"></div>'+
          '<div id="veritas-modal-input" class="veritas-modal-input" style="display: none;">'+
            '<label for="veritas-modal-input-field" class="sr-only">Input</label>'+
            '<input id="veritas-modal-input-field" type="text" autocomplete="off" />'+
          '</div>'+
        '</div>'+
        '<div class="veritas-modal-actions">'+
          '<button type="button" class="veritas-modal-button secondary" data-action="cancel">Cancel</button>'+
          '<button type="button" class="veritas-modal-button primary" data-action="confirm">'+
            '<span class="veritas-modal-spinner" aria-hidden="true"></span>'+
            '<span>Confirm</span>'+
          '</button>'+
        '</div>'+
      '</div>';

    (document.body||document.documentElement).appendChild(root);
    return root;
  }

  function createVeritasModal(){
    var root=ensureVeritasModalRoot();

    var dialog=root.querySelector('.veritas-modal-dialog');
    var titleEl=root.querySelector('#veritas-modal-title');
    var messageEl=root.querySelector('#veritas-modal-message');
    var subtextEl=root.querySelector('#veritas-modal-subtext');
    var inputWrap=root.querySelector('#veritas-modal-input');
    var inputField=root.querySelector('#veritas-modal-input-field');
    var confirmBtn=root.querySelector('[data-action="confirm"]');
    var cancelBtn=root.querySelector('[data-action="cancel"]');
    var confirmLabel=confirmBtn.querySelector('span:not(.veritas-modal-spinner)');
    var active=false;
    var currentConfig=null;
    var resolveFn=null;
    var previousFocus=null;
    var allowEscape=true;
    var hiddenNodes=[];

    function toggleBackground(state){
      var siblings=[].slice.call(document.body.children);
      if(state){
        hiddenNodes=[];
        siblings.forEach(function(node){
          if(node===root)return;
          hiddenNodes.push({
            node:node,
            ariaHidden:node.getAttribute('aria-hidden'),
            inert:('inert' in node)?node.inert:null
          });
          node.setAttribute('aria-hidden','true');
          if('inert' in node){
            node.inert=true;
          }
        });
      } else {
        hiddenNodes.forEach(function(record){
          if(record.ariaHidden===null){
            record.node.removeAttribute('aria-hidden');
          } else {
            record.node.setAttribute('aria-hidden',record.ariaHidden);
          }
          if('inert' in record.node){
            if(record.inert!==null){
              record.node.inert=record.inert;
            } else {
              record.node.inert=false;
            }
          }
        });
        hiddenNodes=[];
      }
    }

    function setPending(state){
      if(state){
        confirmBtn.classList.add('loading');
        confirmBtn.setAttribute('disabled','disabled');
        if(cancelBtn.style.display!=='none'){
          cancelBtn.setAttribute('disabled','disabled');
        }
      } else {
        confirmBtn.classList.remove('loading');
        confirmBtn.removeAttribute('disabled');
        cancelBtn.removeAttribute('disabled');
      }
    }

    function getFocusable(){
      var selectors='button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
      var nodes=[].slice.call(dialog.querySelectorAll(selectors));
      return nodes.filter(function(node){
        return !node.hasAttribute('disabled')&&node.offsetParent!==null;
      });
    }

    function focusFirst(){
      var focusable=getFocusable();
      if(focusable.length>0){
        focusable[0].focus();
      } else {
        dialog.focus();
      }
    }

    function trapKey(event){
      if(!active)return;
      if(event.key==='Escape'){
        if(!allowEscape)return;
        event.preventDefault();
        handleCancel();
      } else if(event.key==='Tab'){
        var focusable=getFocusable();
        if(focusable.length===0){
          event.preventDefault();
          return;
        }
        var index=focusable.indexOf(document.activeElement);
        if(event.shiftKey){
          if(index<=0){
            focusable[focusable.length-1].focus();
            event.preventDefault();
          }
        } else {
          if(index===focusable.length-1){
            focusable[0].focus();
            event.preventDefault();
          }
        }
      } else if(event.key==='Enter'&&currentConfig&&currentConfig.mode==='prompt'){
        if(document.activeElement===inputField){
          event.preventDefault();
          handleConfirm();
        }
      }
    }

    function enforceFocus(event){
      if(!active)return;
      if(!dialog.contains(event.target)){
        event.stopPropagation();
        focusFirst();
      }
    }

    function closeModal(result){
      active=false;
      root.classList.remove('is-active');
      root.setAttribute('aria-hidden','true');
      document.body.classList.remove('veritas-modal-open');
      root.removeEventListener('keydown',trapKey,true);
      document.removeEventListener('focus',enforceFocus,true);
      toggleBackground(false);
      setPending(false);
      if(previousFocus&&typeof previousFocus.focus==='function'){
        setTimeout(function(){previousFocus.focus();},0);
      }
      if(resolveFn){
        resolveFn(result);
      }
      currentConfig=null;
      resolveFn=null;
    }

    function handleConfirm(){
      if(!active)return;
      setPending(true);
      var mode=currentConfig?currentConfig.mode:'alert';
      var result;
      if(mode==='prompt'){
        result=inputField.value;
      } else if(mode==='confirm'){
        result=true;
      }
      closeModal(result);
    }

    function handleCancel(){
      if(!active)return;
      var mode=currentConfig?currentConfig.mode:'alert';
      if(mode==='alert'){
        closeModal(undefined);
        return;
      }
      if(mode==='confirm'){
        closeModal(false);
      } else if(mode==='prompt'){
        closeModal(null);
      }
    }

    function openModal(mode,options){
      options=options||{};
      currentConfig=Object.assign({},options,{mode:mode});
      allowEscape=options.allowEscape!==false;
      titleEl.textContent=options.title||(mode==='confirm'?'Please Confirm':(mode==='prompt'?'Enter Response':'Notice'));
      if(options.html){
        messageEl.innerHTML=options.html;
      } else {
        messageEl.textContent=options.message||'';
      }
      if(options.subtext){
        subtextEl.style.display='block';
        subtextEl.textContent=options.subtext;
      } else {
        subtextEl.style.display='none';
        subtextEl.textContent='';
      }
      if(mode==='prompt'){
        inputWrap.style.display='flex';
        inputField.value=options.defaultValue||'';
        if(options.placeholder){
          inputField.placeholder=options.placeholder;
        } else {
          inputField.removeAttribute('placeholder');
        }
      } else {
        inputWrap.style.display='none';
        inputField.value='';
        inputField.removeAttribute('placeholder');
      }
      confirmLabel.textContent=options.confirmText||(mode==='confirm'?'Confirm':(mode==='prompt'?'Submit':'OK'));
      if(options.destructive){
        confirmBtn.classList.add('destructive');
      } else {
        confirmBtn.classList.remove('destructive');
      }
      cancelBtn.style.display=mode==='alert'?'none':'inline-flex';
      cancelBtn.textContent=options.cancelText||'Cancel';
      setPending(false);
      previousFocus=document.activeElement;
      root.classList.add('is-active');
      root.setAttribute('aria-hidden','false');
      document.body.classList.add('veritas-modal-open');
      toggleBackground(true);
      active=true;
      root.addEventListener('keydown',trapKey,true);
      document.addEventListener('focus',enforceFocus,true);

      return new Promise(function(resolve){
        resolveFn=resolve;
        setTimeout(function(){
          if(mode==='prompt'){
            inputField.focus();
            inputField.select();
          } else if(mode==='confirm'&&options.focusCancel){
            cancelBtn.focus();
          } else {
            confirmBtn.focus();
          }
        },0);
      });
    }

    confirmBtn.addEventListener('click',handleConfirm);
    cancelBtn.addEventListener('click',handleCancel);
    root.addEventListener('click',function(event){
      if(event.target===root||event.target.classList.contains('veritas-modal-backdrop')){
        if(!currentConfig||currentConfig.allowBackdropClose===false){
          return;
        }
        handleCancel();
      }
    });

    return {
      alert:function(options){
        return openModal('alert',options).then(function(){return;});
      },
      confirm:function(options){
        return openModal('confirm',options).then(function(result){return result!==false;});
      },
      prompt:function(options){
        return openModal('prompt',options).then(function(result){return result;});
      }
    };
  }

  // --- DOM Utilities ---
  function bindClick(id, handler){
    var el=document.getElementById(id);
    if(!el){
      console.warn('Missing click target:',id);
      return null;
    }
    el.addEventListener('click',handler);
    return el;
  }

  function bindInput(id,eventName,handler){
    var el=document.getElementById(id);
    if(!el){
      console.warn('Missing input target:',id);
      return null;
    }
    el.addEventListener(eventName,handler);
    return el;
  }

  function bindChange(element,handler,debugId){
    if(!element){
      console.warn('Missing change target:',debugId);
      return;
    }
    element.addEventListener('change',handler);
  }

  function updateDashboardSidebarToggleState(){
    var iconName=dashboardSidebarVisible?'menu_open':'menu';
    var ariaLabel=dashboardSidebarVisible?'Hide navigation':'Show navigation';
    dashboardSidebarToggleButtons.forEach(function(btn){
      if(!btn)return;
      var icon=btn.querySelector('.material-symbols-outlined');
      if(icon){
        icon.textContent=iconName;
      }
      btn.setAttribute('aria-label',ariaLabel);
      btn.setAttribute('aria-expanded',dashboardSidebarVisible?'true':'false');
    });
  }

  function setDashboardSidebarVisibility(visible){
    if(!dashboardSidebar)return;
    dashboardSidebarVisible=visible;
    dashboardSidebar.style.display=visible?'flex':'none';
    updateDashboardSidebarToggleState();
  }

  function toggleDashboardSidebar(event){
    if(event){
      event.preventDefault();
    }
    setDashboardSidebarVisibility(!dashboardSidebarVisible);
  }

  function registerDashboardSidebarToggle(id){
    var btn=bindClick(id,toggleDashboardSidebar);
    if(btn){
      dashboardSidebarToggleButtons.push(btn);
    }
  }

  function storeButtonDefaultHtml(button){
    if(button && !button.dataset.defaultHtml){
      button.dataset.defaultHtml=button.innerHTML;
    }
  }

  function buttonSpinnerMarkup(text){
    return '<span class="flex w-full items-center justify-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"></span><span>'+escapeHtml(text||'Loading...')+'</span></span>';
  }

  function setButtonLoading(button,isLoading,label){
    if(!button){
      return;
    }
    if(isLoading){
      storeButtonDefaultHtml(button);
      button.disabled=true;
      button.setAttribute('aria-busy','true');
      button.setAttribute('aria-disabled','true');
      button.innerHTML=buttonSpinnerMarkup(label);
    }else{
      if(button.dataset.defaultHtml){
        button.innerHTML=button.dataset.defaultHtml;
      }
      button.disabled=false;
      button.removeAttribute('aria-busy');
      button.removeAttribute('aria-disabled');
    }
  }

  function bootstrapGoogleCharts(){
    if(googleChartsReady||googleChartsLoading){
      return;
    }
    if(!(window.google&&google.charts&&typeof google.charts.load==='function')){
      return;
    }
    googleChartsLoading=true;
    google.charts.load('current',{'packages':['corechart']});
    google.charts.setOnLoadCallback(function(){
      googleChartsReady=true;
      googleChartsLoading=false;
      if(googleChartsBootstrapTimer){
        clearInterval(googleChartsBootstrapTimer);
        googleChartsBootstrapTimer=null;
      }
      try{
        onGoogleChartsReady();
      }catch(err){
        console.error('Post-chart bootstrap failed:',err);
      }
    });
  }

  function onGoogleChartsReady(){
    if(dashboardSummary){
      try{
        renderActivityPulse();
      }catch(err){
        console.error('Activity pulse refresh failed:',err);
      }
    }
    if(typeof renderAnalyticsByTab==='function'&&typeof analyticsData!=='undefined'&&analyticsData){
      try{
        renderAnalyticsByTab();
      }catch(err){
        console.error('Analytics redraw failed:',err);
      }
    }
  }

  // --- Element Cache ---
  var pollSelect=document.getElementById('poll-select');
  var startPollBtn=document.getElementById('start-poll-btn');
  var sendLinkBtn=document.getElementById('send-link-btn');
  var viewLinksBtn=document.getElementById('view-links-btn');
  var headerSessionControls=document.getElementById('header-session-controls');
  var dashboardSidebar=document.getElementById('dashboard-sidebar');
  var dashboardSidebarVisible=true;
  var dashboardSidebarToggleButtons=[];
  var dashboard=document.getElementById('dashboard');
  var liveView=document.getElementById('live-view');
  var rosterManager=document.getElementById('roster-manager');
  var archivedView=document.getElementById('archived-view');
  var analyticsView=document.getElementById('analytics-view');
  var headerDefault=document.getElementById('header-default');
  var headerLive=document.getElementById('header-live');
  var modal=document.getElementById('poll-creator-modal');
  var linksModal=document.getElementById('student-links-modal');
  var pollSortSelect=document.getElementById('poll-sort-select');
  var pollFilterSelect=document.getElementById('poll-filter-select');
  var pollSearchInput=document.getElementById('poll-search-input');
  var pollSearchClearBtn=document.getElementById('poll-search-clear-btn');
  var pollsCardView=document.getElementById('polls-card-view');
  var pollsTableBody=document.getElementById('polls-table-body');
  var pollsEmptyState=document.getElementById('polls-empty-state');
  var classSelect=document.getElementById('class-select');
  var questionSortResetBtn=document.getElementById('question-sort-reset-btn');
  var questionSortHelp=document.getElementById('question-sort-help');
  var questionNavigatorContainer=document.getElementById('question-navigator');
  var archivedClassFilterSelect=document.getElementById('archived-class-filter');
  var archivedList=document.getElementById('archived-list');
  var archivedEmptyState=document.getElementById('archived-empty-state');
  var archivedDetail=document.getElementById('archived-detail');
  var archivedPollTitle=document.getElementById('archived-poll-title');
  var archivedPollMeta=document.getElementById('archived-poll-meta');
  var archivedQuestionCount=document.getElementById('archived-question-count');
  var archivedResponseCount=document.getElementById('archived-response-count');
  var archivedQuestionsContainer=document.getElementById('archived-questions-container');
  var rosterClassList=document.getElementById('roster-class-list');
  var rosterClassTitle=document.getElementById('roster-class-title');
  var rosterEmptyState=document.getElementById('roster-empty-state');
  var rosterTableWrapper=document.getElementById('roster-table-wrapper');
  var rosterTableBody=document.getElementById('roster-table-body');
  var rosterStatus=document.getElementById('roster-status');
  var renameClassBtn=document.getElementById('rename-class-btn');
  var deleteClassBtn=document.getElementById('delete-class-btn');
  var addClassBtn=document.getElementById('add-class-btn');
  var addStudentRowBtn=document.getElementById('add-student-row-btn');
  var saveRosterBtn=document.getElementById('save-roster-btn');
  var refreshArchivedBtn=document.getElementById('refresh-archived-btn');

  storeButtonDefaultHtml(startPollBtn);
  storeButtonDefaultHtml(sendLinkBtn);
  storeButtonDefaultHtml(viewLinksBtn);

  // --- Initialization ---
  loadInitialData();

  if(window.google&&google.charts&&typeof google.charts.load==='function'){
    bootstrapGoogleCharts();
  }else{
    console.warn('Google Charts unavailable â€“ continuing initialization without charts.');
    googleChartsBootstrapTimer=setInterval(function(){
      if(window.google&&google.charts&&typeof google.charts.load==='function'){
        bootstrapGoogleCharts();
      }
    },400);
    setTimeout(function(){
      if(googleChartsBootstrapTimer){
        clearInterval(googleChartsBootstrapTimer);
        googleChartsBootstrapTimer=null;
      }
    },8000);
  }

  // --- Event Listeners ---
  bindClick('nav-create-poll',function(){openPollCreator();});
  bindClick('nav-polls-list',showDashboard);
  bindClick('nav-rosters',showRosterManager);
  bindClick('nav-archived',showArchivedView);
  bindClick('nav-analytics',showAnalyticsView);
  bindClick('close-modal-btn',closePollCreator);
  bindClick('close-links-modal-btn',closeLinksModal);
  bindClick('close-preview-modal-btn',closePollPreview);
  bindClick('preview-prev-question-btn',previewPrevQuestion);
  bindClick('preview-next-question-btn',previewNextQuestion);
  bindClick('preview-open-links-btn',previewOpenLinks);
  bindClick('preview-edit-question-btn',previewEditQuestion);
  bindClick('preview-delete-question-btn',previewDeleteQuestion);
  bindClick('preview-reorder-btn',togglePreviewReorder);
  bindClick('add-question-btn',addQuestion);
  bindClick('save-poll-btn',savePoll);
  bindInput('new-poll-name','input',markPollDirty);
  bindChange(classSelect,markPollDirty,'class-select');

  if(pollSearchInput){
    pollSearchInput.addEventListener('input',function(){
      pollSearchQuery=(this.value||'').trim();
      refreshPollViews();
      updatePollSearchClear();
    });
  }

  if(pollSearchClearBtn){
    pollSearchClearBtn.addEventListener('click',function(){
      pollSearchQuery='';
      if(pollSearchInput){
        pollSearchInput.value='';
        pollSearchInput.focus();
      }
      refreshPollViews();
      updatePollSearchClear();
    });
  }

  updatePollSearchClear();
  setQuestionReorderHelp();

  if(questionSortResetBtn){
    questionSortResetBtn.addEventListener('click',function(){
      resetQuestionOrderToInitial();
    });
  }

  if(questionNavigatorContainer){
    questionNavigatorContainer.addEventListener('dragover',handleNavigatorDragOver);
    questionNavigatorContainer.addEventListener('drop',handleNavigatorDrop);
  }

  // Session type change handler
  var sessionTypeSelect=document.getElementById('session-type-select');
  var timeLimitGroup=document.getElementById('time-limit-group');
  if(sessionTypeSelect&&timeLimitGroup){
    sessionTypeSelect.addEventListener('change',function(){
      if(sessionTypeSelect.value==='INDIVIDUAL_TIMED'){
        timeLimitGroup.style.display='block';
      }else{
        timeLimitGroup.style.display='none';
      }
      markPollDirty();
    });
  }

  if(startPollBtn){
    startPollBtn.addEventListener('click',onStartPoll);
  }else{
    console.warn('Missing click target: start-poll-btn');
  }
  bindClick('header-start-btn',onResumePoll);
  bindClick('header-end-show-btn',onEndQuestionAndShowAnswer);
  bindClick('header-stop-btn',onEndPoll);
  bindClick('header-back-btn',onPreviousQuestion);
  bindClick('header-next-btn',onNextQuestion);
  bindClick('header-reset-question-btn',onResetQuestion);
  bindClick('hide-results-btn',onHideResults);
  bindClick('strip-next-btn',onNextQuestion);
  registerDashboardSidebarToggle('dashboard-sidebar-toggle');
  registerDashboardSidebarToggle('dashboard-sidebar-toggle-live');
  updateDashboardSidebarToggleState();
  if(dashboardSidebar){
    dashboardSidebar.style.display='flex';
  }
  function focusLockoutsSection(){
    var panel=document.getElementById('exited-students-panel');
    if(panel){
      panel.classList.remove('hidden');
      panel.scrollIntoView({behavior:'smooth',block:'start'});
    }
  }
  bindClick('focus-lockouts-btn',focusLockoutsSection);
  bindClick('hud-focus-lockouts-btn',focusLockoutsSection);
  // New timer button event listeners
  bindClick('start-btn', startTimer);
  bindClick('pause-btn', pauseTimer);
  bindClick('reset-btn', resetTimer);
  bindClick('add-10s-btn', function() {
    parseInputToTotalSeconds();
    editTime(10);
  });
  bindClick('subtract-10s-btn', function() {
    parseInputToTotalSeconds();
    editTime(-10);
  });

  // Timer display input event listener
  var timerDisplayInput = document.getElementById('timer-display');
  if (timerDisplayInput) {
    timerDisplayInput.addEventListener('blur', function() {
      parseInputToTotalSeconds();
      updateDisplay();
    });

    // Handle Enter key to blur and apply changes
    timerDisplayInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        timerDisplayInput.blur();
      }
    });
  }

  // Keyboard shortcuts for timer (when timer is visible)
  document.addEventListener('keydown',function(e){
    var timerDisplay = document.getElementById('timer-display');
    if(!timerDisplay || !timerDisplay.offsetParent) return; // Timer not visible

    // Prevent shortcuts when typing in the timer input field or other inputs
    if(e.target === timerDisplay || e.target.tagName === 'TEXTAREA') return;

    if(e.key === ' '){
      e.preventDefault();
      if(isRunning){
        pauseTimer();
      } else {
        startTimer();
      }
    } else if(e.key === 'r' || e.key === 'R'){
      e.preventDefault();
      resetTimer();
    } else if(!isRunning && (e.key === 'ArrowLeft' || e.key === 'ArrowDown')){
      e.preventDefault();
      parseInputToTotalSeconds();
      editTime(-10);
    } else if(!isRunning && (e.key === 'ArrowRight' || e.key === 'ArrowUp')){
      e.preventDefault();
      parseInputToTotalSeconds();
      editTime(10);
    }
  });

  // Initialize timer display
  updateDisplay();
  updateTimerStatus('Timer idle.','info');
  bindClick('send-link-btn',onSendLink);
  bindClick('view-links-btn',onViewLinks);
  bindClick('header-send-link-btn',onSendLink);
  bindClick('header-view-links-btn',onViewLinks);

  // Student status search
  var studentSearchInput = document.getElementById('student-search-input');
  if(studentSearchInput){
    studentSearchInput.addEventListener('input', function(){
      studentSearchQuery = this.value;
      renderStudentStatus();
    });
  }

  function syncStatusFilterButtons(){
    var lockedBtn=document.getElementById('filter-locked-only-btn');
    var allBtn=document.getElementById('filter-all-btn');
    if(lockedBtn){
      if(studentStatusFilter==='locked'){
        lockedBtn.classList.add('bg-red-500/30');
        lockedBtn.classList.remove('bg-red-500/10');
      }else{
        lockedBtn.classList.remove('bg-red-500/30');
        lockedBtn.classList.add('bg-red-500/10');
      }
    }
    if(allBtn){
      if(studentStatusFilter==='all'){
        allBtn.classList.add('bg-primary/30');
        allBtn.classList.remove('bg-primary/10');
      }else{
        allBtn.classList.remove('bg-primary/30');
        allBtn.classList.add('bg-primary/10');
      }
    }
  }

  var statusFilterSelect=document.getElementById('student-status-filter-select');
  if(statusFilterSelect){
    statusFilterSelect.addEventListener('change',function(){
      studentStatusFilter=this.value;
      syncStatusFilterButtons();
      renderStudentStatus();
    });
  }

  var correctnessFilterSelect=document.getElementById('student-correctness-filter-select');
  if(correctnessFilterSelect){
    correctnessFilterSelect.addEventListener('change',function(){
      studentCorrectnessFilter=this.value;
      renderStudentStatus();
    });
  }

  var studentSortSelectEl=document.getElementById('student-sort-select');
  if(studentSortSelectEl){
    studentSortSelectEl.addEventListener('change',function(){
      studentTableSort.column=this.value;
      if(this.value==='recent'&&studentTableSort.direction==='asc'){
        studentTableSort.direction='desc';
        var dirIcon=document.querySelector('#student-sort-direction-btn span');
        if(dirIcon){
          dirIcon.textContent='north';
        }
      } else {
        var icon=document.querySelector('#student-sort-direction-btn span');
        if(icon){
          icon.textContent=studentTableSort.direction==='asc'?'south':'north';
        }
      }
      renderStudentStatus();
    });
  }

  var sortDirectionBtn=document.getElementById('student-sort-direction-btn');
  if(sortDirectionBtn){
    sortDirectionBtn.addEventListener('click',function(){
      studentTableSort.direction=studentTableSort.direction==='asc'?'desc':'asc';
      var icon=this.querySelector('span');
      if(icon){
        icon.textContent=studentTableSort.direction==='asc'?'south':'north';
      }
      renderStudentStatus();
    });
  }

  // Student status table sorting
  document.querySelectorAll('th[data-sort]').forEach(function(th){
    th.addEventListener('click', function(){
      var column = this.dataset.sort;
      if(studentTableSort.column === column){
        studentTableSort.direction = studentTableSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        studentTableSort.column = column;
        studentTableSort.direction = 'asc';
      }

      // Update sort icons
      document.querySelectorAll('th[data-sort] .sort-icon').forEach(function(icon){
        icon.textContent = 'unfold_more';
      });
      var icon = this.querySelector('.sort-icon');
      if(icon){
        icon.textContent = studentTableSort.direction === 'asc' ? 'arrow_upward' : 'arrow_downward';
      }

      renderStudentStatus();
    });
  });

  if(pollSelect){
    pollSelect.addEventListener('change',onPollSelectChange);
  }else{
    console.warn('Missing change target: poll-select');
  }
  if(pollSortSelect){
    pollSortSelect.addEventListener('change',function(){pollSortMode=this.value;refreshPollViews();});
  }else{
    console.warn('Missing change target: poll-sort-select');
  }
  if(pollFilterSelect){
    pollFilterSelect.addEventListener('change',function(){pollClassFilter=this.value;refreshPollViews();});
  }else{
    console.warn('Missing change target: poll-filter-select');
  }
  if(archivedClassFilterSelect){
    archivedClassFilterSelect.addEventListener('change',function(){archivedClassFilter=this.value;renderArchivedList();});
  }else{
    console.warn('Missing change target: archived-class-filter');
  }
  if(addClassBtn){
    addClassBtn.addEventListener('click',onAddClass);
  }else{
    console.warn('Missing click target: add-class-btn');
  }
  if(addStudentRowBtn){
    addStudentRowBtn.addEventListener('click',addRosterRow);
  }else{
    console.warn('Missing click target: add-student-row-btn');
  }
  bindClick('bulk-add-students-btn',openBulkAddStudentsModal);
  bindClick('cancel-bulk-add-btn',closeBulkAddStudentsModal);
  bindClick('confirm-bulk-add-btn',confirmBulkAddStudents);
  if(saveRosterBtn){
    saveRosterBtn.addEventListener('click',saveRoster);
  }else{
    console.warn('Missing click target: save-roster-btn');
  }
  if(renameClassBtn){
    renameClassBtn.addEventListener('click',onRenameClass);
  }else{
    console.warn('Missing click target: rename-class-btn');
  }
  if(deleteClassBtn){
    deleteClassBtn.addEventListener('click',onDeleteClass);
  }else{
    console.warn('Missing click target: delete-class-btn');
  }
  if(refreshArchivedBtn){
    refreshArchivedBtn.addEventListener('click',function(){loadArchivedPolls(true);});
  }else{
    console.warn('Missing click target: refresh-archived-btn');
  }

  function setMainSection(section){
    dashboard.style.display=section==='dashboard'?'block':'none';
    liveView.style.display=section==='live'?'grid':'none';
    rosterManager.style.display=section==='roster'?'grid':'none';
    archivedView.style.display=section==='archived'?'grid':'none';
    analyticsView.style.display=section==='analytics'?'flex':'none';

    var navButtons=document.querySelectorAll('.sidebar-nav-btn[data-section-target]');
    navButtons.forEach(function(btn){
      var target=btn.getAttribute('data-section-target');
      var isActive=target===section;
      btn.classList.toggle('is-active',isActive);
      btn.setAttribute('aria-current',isActive?'page':'false');
      if(isActive){
        btn.classList.add('font-semibold');
      }else{
        btn.classList.remove('font-semibold');
      }
    });

    if(headerSessionControls){
      if(section==='dashboard'){
        headerSessionControls.classList.remove('hidden');
      }else{
        headerSessionControls.classList.add('hidden');
      }
    }
  }

  function clearLiveIntervals(){
    if(pollInterval){
      clearInterval(pollInterval);
      pollInterval=null;
    }
    if(analyticsRefreshInterval){
      clearInterval(analyticsRefreshInterval);
      analyticsRefreshInterval=null;
    }
    pauseTimerCountdown();
    stopVisualTimer();
    timerRemainingSeconds=timerPresetSeconds;
    timerActive=false;
    updateTimerDisplay();
    updateTimerStatus('Timer idle.','info');
  }

  function showDashboard(){
    clearLiveIntervals();
    isLiveSession=false;
    CURRENT_POLL_DATA={};
    headerDefault.style.display='flex';
    headerLive.style.display='none';
    setMainSection('dashboard');

    // Load dashboard summary data (non-blocking)
    setTimeout(function() {
      if (!dashboardSummary) {
        loadDashboardSummary();
      } else {
        renderDashboardSummary();
      }
    }, 100);
  }

  function loadDashboardSummary() {
    if(PREVIEW_MODE&&PREVIEW_PAYLOAD){
      dashboardSummary=deepClone(PREVIEW_PAYLOAD.dashboardSummary||null);
      renderDashboardSummary();
      return;
    }

    google.script.run
      .withSuccessHandler(function(data) {
        dashboardSummary = data;
        renderDashboardSummary();
      })
      .withFailureHandler(function(error) {
        console.error('Error loading dashboard summary:', error);
        // Show empty states if loading fails - but don't break the page
        try {
          renderDashboardSummary();
        } catch(e) {
          console.error('Error rendering dashboard summary:', e);
        }
      })
      .getDashboardSummary();
  }

  function renderDashboardSummary() {
    try {
      renderRecentSessions();
    } catch(e) {
      console.error('Error rendering recent sessions:', e);
    }
    try {
      renderActivityPulse();
    } catch(e) {
      console.error('Error rendering activity pulse:', e);
    }
  }

  function renderRecentSessions() {
    var container = document.getElementById('recent-sessions-container');
    if (!container) {
      console.warn('Recent sessions container not found');
      return;
    }

    if (!dashboardSummary || !dashboardSummary.recentSessions || dashboardSummary.recentSessions.length === 0) {
      container.innerHTML = '<div class="text-center py-6 text-gray-500 text-sm">No recent sessions found. Create your first poll to get started!</div>';
      return;
    }

    try {
      container.innerHTML = '';
      dashboardSummary.recentSessions.forEach(function(session) {
        var item = document.createElement('div');
        item.className = 'dashboard-list-item';

        // Format date
        var date = new Date(session.date);
        var formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

        // Determine badge class and content
        var badgeClass = 'success';
        var badgeIcon = 'check_circle';
        var badgeText = Math.round(session.participationPct || 0) + '%';

        if (session.flags > 0) {
          badgeClass = 'warning';
          badgeIcon = 'warning';
          badgeText = session.flags + ' flags';
        } else if ((session.masteryPct || 0) >= 80) {
          badgeClass = 'success';
        } else if ((session.masteryPct || 0) >= 60) {
          badgeClass = 'neutral';
        }

        item.innerHTML = '<div class="flex-1 min-w-0">' +
          '<p class="font-semibold text-sm text-veritas-navy">' + escapeHtml(session.sessionName || 'Untitled') + '</p>' +
          '<p class="text-xs text-gray-500 mt-0.5">' + formattedDate + ' Â· ' + escapeHtml(session.className || '') + '</p>' +
          '</div>' +
          '<div class="flex items-center gap-3">' +
          '<div class="dashboard-stat-badge ' + badgeClass + '">' +
          (session.flags > 0 ? '<span class="material-symbols-outlined text-sm">' + badgeIcon + '</span>' : '') +
          '<span>' + badgeText + '</span>' +
          '</div>' +
          '<span class="text-xs text-gray-500">Avg ' + Math.round(session.masteryPct || 0) + '%</span>' +
          '</div>';

        container.appendChild(item);
      });
    } catch(e) {
      console.error('Error in renderRecentSessions:', e);
      container.innerHTML = '<div class="text-center py-6 text-red-500 text-sm">Error loading recent sessions</div>';
    }
  }

  function renderActivityPulse() {
    var chartContainer = document.getElementById('activity-chart-container');
    var summaryContainer = document.getElementById('activity-summary');
    if (!chartContainer || !summaryContainer) {
      console.warn('Activity pulse containers not found');
      return;
    }

    if (!dashboardSummary || !dashboardSummary.dailyActivity || dashboardSummary.dailyActivity.length === 0) {
      chartContainer.innerHTML = '<div class="text-center py-6 text-gray-500 text-sm">No activity data available</div>';
      summaryContainer.innerHTML = '';
      return;
    }

    try {
      // Find max count for scaling
      var maxCount = Math.max.apply(Math, dashboardSummary.dailyActivity.map(function(d) { return d.count || 0; }));
      if (maxCount === 0) maxCount = 1; // Avoid division by zero

      // Render bars
      chartContainer.innerHTML = '';
      dashboardSummary.dailyActivity.forEach(function(day) {
        var bar = document.createElement('div');
        bar.className = 'activity-bar';
        var heightPct = maxCount > 0 ? ((day.count || 0) / maxCount * 100) : 0;
        bar.style.height = heightPct + '%';
        bar.title = (day.dayName || 'Day') + ': ' + (day.count || 0) + ' interactions';
        chartContainer.appendChild(bar);
      });

      // Render summary
      var change = dashboardSummary.weekOverWeekChange || 0;
      var changeSymbol = change >= 0 ? 'â†‘' : 'â†“';
      var changeClass = change >= 0 ? 'text-veritas-gold' : 'text-gray-500';
      var totalActivity = dashboardSummary.totalActivityThisWeek || 0;

      summaryContainer.innerHTML = '<div class="flex items-center justify-between">' +
        '<p class="text-sm text-gray-600">' +
        '<span class="font-semibold ' + changeClass + '">' + changeSymbol + ' ' + Math.abs(change) + '%</span> compared to last week' +
        '</p>' +
        '<span class="text-xs text-gray-400 italic">' + totalActivity + ' total interactions</span>' +
        '</div>';
    } catch(e) {
      console.error('Error in renderActivityPulse:', e);
      chartContainer.innerHTML = '<div class="text-center py-6 text-red-500 text-sm">Error loading activity data</div>';
      summaryContainer.innerHTML = '';
    }
  }

  function showRosterManager(){
    clearLiveIntervals();
    headerDefault.style.display='flex';
    headerLive.style.display='none';
    setMainSection('roster');
    if(Object.keys(rosterData).length===0){
      loadRosterData();
    } else {
      renderRosterClassList();
      if(selectedRosterClass){
        renderRosterTable();
      } else {
        rosterEmptyState.classList.remove('hidden');
        rosterTableWrapper.classList.add('hidden');
        renameClassBtn.classList.add('hidden');
        deleteClassBtn.classList.add('hidden');
      }
    }
  }

  function showArchivedView(){
    clearLiveIntervals();
    headerDefault.style.display='flex';
    headerLive.style.display='none';
    setMainSection('archived');
    if(archivedPolls.length===0){
      loadArchivedPolls();
    } else {
      renderArchivedList();
      renderArchivedDetail();
    }
  }

  // --- Initial Data Load ---
  function loadInitialData(){
    if(PREVIEW_MODE&&PREVIEW_PAYLOAD){
      console.info('Apps Script runtime not detected â€“ rendering preview data.');
      setTimeout(function(){
        onDashboardDataLoaded({
          polls:deepClone(PREVIEW_PAYLOAD.polls||[]),
          classes:deepClone(PREVIEW_PAYLOAD.classes||[])
        });
      },120);
      return;
    }

    // OPTIMIZATION: Try localStorage cache first
    var cachedData=LocalCache.get('dashboardData');
    if(cachedData){
      console.log('Using cached dashboard data');
      onDashboardDataLoaded(cachedData);
      // Refresh in background to update cache
      google.script.run
        .withSuccessHandler(function(data){
          LocalCache.set('dashboardData',data,300000); // Cache for 5 minutes
          onDashboardDataLoaded(data);
        })
        .withFailureHandler(handleError)
        .getTeacherDashboardData();
    }else{
      google.script.run
        .withSuccessHandler(function(data){
          LocalCache.set('dashboardData',data,300000); // Cache for 5 minutes
          onDashboardDataLoaded(data);
        })
        .withFailureHandler(handleError)
        .getTeacherDashboardData();
    }
  }

  function onDashboardDataLoaded(data){
    mainLoader.style.display='none';
    ALL_POLLS=data.polls||[];
    refreshClassOptions(data.classes||[]);
    refreshPollViews();

    // Show dashboard on initial load
    setMainSection('dashboard');

    // Load dashboard summary after a short delay
    setTimeout(function() {
      if (!dashboardSummary) {
        loadDashboardSummary();
      }
    }, 100);
  }

  function updatePollDropdown(polls){
    polls=polls||getFilteredSortedPolls();
    var previousValue=pollSelect.value;
    pollSelect.innerHTML='<option value="">-- Choose a poll --</option>';
    var hasSelection=false;
    polls.forEach(function(poll){
      var opt=document.createElement('option');
      opt.value=poll.pollId;
      opt.textContent=poll.pollName+' ('+poll.className+') - '+poll.questions.length+' questions';
      if(poll.pollId===previousValue){
        opt.selected=true;
        hasSelection=true;
      }
      pollSelect.appendChild(opt);
    });
    if(!hasSelection){
      pollSelect.value='';
    }
    onPollSelectChange();
  }

  function refreshClassOptions(classList){
    BASE_CLASSES=(classList||[]).map(function(name){return (name||'').toString().trim();}).filter(function(name){return name!=='';});
    var classSet=new Set();
    BASE_CLASSES.forEach(function(name){classSet.add(name);});
    Object.keys(rosterData).forEach(function(name){if(name)classSet.add(name);});
    ALL_POLLS.forEach(function(poll){
      if(poll.className){
        classSet.add(poll.className);
      }
    });
    ALL_CLASSES=Array.from(classSet).sort();

    var previousSelection=classSelect.value;
    classSelect.innerHTML='<option value="">-- Select Class --</option>';
    ALL_CLASSES.forEach(function(className){
      var opt=document.createElement('option');
      opt.value=className;
      opt.textContent=className;
      classSelect.appendChild(opt);
    });
    if(previousSelection&&ALL_CLASSES.indexOf(previousSelection)!==-1){
      classSelect.value=previousSelection;
    } else {
      classSelect.value='';
    }

    updateClassFilters();
  }

  function updateClassFilters(){
    var previousPollFilter=pollClassFilter;
    pollFilterSelect.innerHTML='<option value="all">All classes</option>';
    ALL_CLASSES.forEach(function(className){
      var opt=document.createElement('option');
      opt.value=className;
      opt.textContent=className;
      pollFilterSelect.appendChild(opt);
    });
    if(previousPollFilter&&ALL_CLASSES.indexOf(previousPollFilter)!==-1){
      pollClassFilter=previousPollFilter;
    } else {
      pollClassFilter='all';
    }
    pollFilterSelect.value=pollClassFilter;

    var previousArchivedFilter=archivedClassFilter;
    archivedClassFilterSelect.innerHTML='<option value="all">All classes</option>';
    ALL_CLASSES.forEach(function(className){
      var opt=document.createElement('option');
      opt.value=className;
      opt.textContent=className;
      archivedClassFilterSelect.appendChild(opt);
    });
    if(previousArchivedFilter&&ALL_CLASSES.indexOf(previousArchivedFilter)!==-1){
      archivedClassFilter=previousArchivedFilter;
    } else {
      archivedClassFilter='all';
    }
    archivedClassFilterSelect.value=archivedClassFilter;
  }

  function updatePollSearchClear(){
    if(!pollSearchClearBtn)return;
    if(pollSearchQuery){
      pollSearchClearBtn.classList.remove('hidden');
    }else{
      pollSearchClearBtn.classList.add('hidden');
    }
  }

  function pollMatchesSearch(poll,normalizedQuery){
    if(!normalizedQuery)return true;
    var name=(poll&&poll.pollName?poll.pollName:'').toLowerCase();
    if(name.indexOf(normalizedQuery)!==-1)return true;
    var className=(poll&&poll.className?poll.className:'').toLowerCase();
    if(className.indexOf(normalizedQuery)!==-1)return true;
    if(!poll)return false;
    if(Array.isArray(poll.questions)){
      for(var i=0;i<poll.questions.length;i++){
        var question=poll.questions[i]||{};
        var text=(question.questionText||'').toLowerCase();
        if(text.indexOf(normalizedQuery)!==-1)return true;
        var topic=(question.topicTag||question.topic||'').toLowerCase();
        if(topic.indexOf(normalizedQuery)!==-1)return true;
        var correctText=(question.correctAnswer||'').toLowerCase();
        if(correctText&&correctText.indexOf(normalizedQuery)!==-1)return true;
        var options=Array.isArray(question.options)?question.options:(Array.isArray(question.answers)?question.answers:[]);
        for(var j=0;j<options.length;j++){
          var option=options[j]||{};
          var optionText=(option.text||option.label||'').toLowerCase();
          if(optionText.indexOf(normalizedQuery)!==-1)return true;
        }
      }
    }
    var sessionCollections=[];
    if(poll&&Array.isArray(poll.liveSessions))sessionCollections.push(poll.liveSessions);
    if(poll&&Array.isArray(poll.recentSessions))sessionCollections.push(poll.recentSessions);
    if(poll&&Array.isArray(poll.sessions))sessionCollections.push(poll.sessions);
    for(var c=0;c<sessionCollections.length;c++){
      var collection=sessionCollections[c];
      for(var s=0;s<collection.length;s++){
        var session=collection[s]||{};
        var sessionNameRaw=session.sessionName||session.title||'';
        var sessionName=(typeof sessionNameRaw==='string'?sessionNameRaw:String(sessionNameRaw||'')).toLowerCase();
        if(sessionName.indexOf(normalizedQuery)!==-1)return true;
        var sessionNotesRaw=session.notes||session.summary||'';
        var sessionNotes=(typeof sessionNotesRaw==='string'?sessionNotesRaw:String(sessionNotesRaw||'')).toLowerCase();
        if(sessionNotes.indexOf(normalizedQuery)!==-1)return true;
        var sessionQuestions=Array.isArray(session.questions)?session.questions:[];
        for(var q=0;q<sessionQuestions.length;q++){
          var sessionQuestion=sessionQuestions[q]||{};
          var sessionTextRaw=sessionQuestion.questionText||sessionQuestion.text||'';
          var sessionText=(typeof sessionTextRaw==='string'?sessionTextRaw:String(sessionTextRaw||'')).toLowerCase();
          if(sessionText.indexOf(normalizedQuery)!==-1)return true;
          var sessionOptions=Array.isArray(sessionQuestion.options)?sessionQuestion.options:[];
          for(var so=0;so<sessionOptions.length;so++){
            var sessionOption=sessionOptions[so]||{};
            var sessionOptionRaw=sessionOption.text||sessionOption.label||'';
            var sessionOptionText=(typeof sessionOptionRaw==='string'?sessionOptionRaw:String(sessionOptionRaw||'')).toLowerCase();
            if(sessionOptionText.indexOf(normalizedQuery)!==-1)return true;
          }
        }
      }
    }
    return false;
  }

  function getFilteredSortedPolls(){
    var list=ALL_POLLS.slice();
    if(pollClassFilter!=='all'){
      list=list.filter(function(poll){return poll.className===pollClassFilter;});
    }

    if(pollSearchQuery){
      var normalizedQuery=pollSearchQuery.toLowerCase();
      list=list.filter(function(poll){
        return pollMatchesSearch(poll,normalizedQuery);
      });
    }

    list.sort(function(a,b){
      switch(pollSortMode){
        case 'updated_asc':
          return getPollTimestamp(a)-getPollTimestamp(b);
        case 'name_asc':
          return (a.pollName||'').localeCompare(b.pollName||'');
        case 'class_asc':
          var classCompare=(a.className||'').localeCompare(b.className||'');
          if(classCompare!==0)return classCompare;
          return (a.pollName||'').localeCompare(b.pollName||'');
        case 'updated_desc':
        default:
          return getPollTimestamp(b)-getPollTimestamp(a);
      }
    });
    return list;
  }

  function getPollTimestamp(poll){
    var value=poll && (poll.updatedAt||poll.lastRunAt||poll.createdAt||'');
    var time=value?Date.parse(value):NaN;
    return isNaN(time)?0:time;
  }

  function refreshPollViews(){
    var polls=getFilteredSortedPolls();
    renderPollCards(polls);
    renderPollTable(polls);
    updatePollDropdown(polls);
    if(pollsEmptyState){
      if(polls.length===0){
        pollsEmptyState.classList.remove('hidden');
        var message='No polls found. Create your first poll to get started.';
        if(pollSearchQuery){
          var safeQuery=escapeHtml(pollSearchQuery);
          message='No polls match â€œ'+safeQuery+'â€. Try a different title or question keyword.';
        }
        pollsEmptyState.innerHTML='<p>'+message+'</p>';
      } else {
        pollsEmptyState.classList.add('hidden');
      }
    }
  }

  function startEditPoll(pollId,triggerButton){
    if(!pollId)return;
    var button=triggerButton||null;
    var originalLabel=button?button.innerHTML:'';
    if(button){
      button.disabled=true;
      button.textContent='Loading...';
    }

    if(PREVIEW_MODE){
      var previewPoll=ALL_POLLS.find(function(p){return p.pollId===pollId;});
      if(button){
        button.disabled=false;
        button.innerHTML=originalLabel;
      }
      if(previewPoll){
        openPollCreator(deepClone(previewPoll));
      }else{
        veritasAlert('Unable to locate this poll in preview mode.',{title:'Edit poll'});
      }
      return;
    }

    google.script.run
      .withSuccessHandler(function(poll){
        if(button){
          button.disabled=false;
          button.innerHTML=originalLabel;
        }
        openPollCreator(poll);
      })
      .withFailureHandler(function(error){
        if(button){
          button.disabled=false;
          button.innerHTML=originalLabel;
        }
        handleError(error);
      })
      .getPollForEditing(pollId);
  }

  function renderPollCards(polls){
    if(!pollsCardView){
      return;
    }

    pollsCardView.innerHTML='';

    if(!polls||polls.length===0){
      return;
    }

    polls.forEach(function(poll){
      var card=document.createElement('article');
      card.className='poll-card-enhanced';
      if(poll&&poll.pollId){
        card.dataset.pollId=poll.pollId;
      }
      card.setAttribute('tabindex','0');
      card.setAttribute('role','group');
      var safeName=escapeHtml(poll&&poll.pollName?poll.pollName:'Untitled Poll');
      card.setAttribute('aria-label','Poll '+(poll&&poll.pollName?poll.pollName:'Untitled poll'));

      var className=escapeHtml(poll&&poll.className?poll.className:'Unassigned');
      var questionCount=Array.isArray(poll&&poll.questions)?poll.questions.length:0;
      var questionLabel=questionCount===1?'Question':'Questions';
      var lastRunText=poll&&poll.lastRunAt?
        'Last run '+formatDateTime(poll.lastRunAt):
        'Not run yet';
      var lastRun=escapeHtml(lastRunText);
      var updatedDescriptor=poll&&poll.updatedAt?
        'Updated '+formatDateTime(poll.updatedAt):
        'Created '+formatDateTime(poll&&poll.createdAt);
      var updated=escapeHtml(updatedDescriptor);

      var recentSessionCount=0;
      ['liveSessions','recentSessions','sessions'].forEach(function(key){
        if(poll&&Array.isArray(poll[key])){
          recentSessionCount=Math.max(recentSessionCount,poll[key].length);
        }
      });
      var sessionBadgeText=recentSessionCount>0?
        recentSessionCount+' session'+(recentSessionCount===1?'':'s'):
        'No sessions yet';
      sessionBadgeText=escapeHtml(sessionBadgeText);

      // Get first question text for preview
      var firstQuestionText='';
      if(poll&&Array.isArray(poll.questions)&&poll.questions.length>0){
        var firstQ=poll.questions[0];
        firstQuestionText=firstQ&&firstQ.questionText?firstQ.questionText:'';
      }
      var previewText=firstQuestionText||'No questions yet';
      var safePreviewText=escapeHtml(previewText);

      var parts=[];

      // Preview section with first question
      parts.push('<div class="poll-card-preview">');
      parts.push('<div class="poll-card-preview-text">'+safePreviewText+'</div>');
      parts.push('</div>');

      // Card body
      parts.push('<div class="poll-card-body">');
      parts.push('<div class="poll-card-header">');
      parts.push('<div class="poll-card-title">'+safeName+'</div>');
      parts.push('<div class="poll-card-meta">');
      parts.push('<span class="poll-card-badge class-badge"><span class="material-symbols-outlined text-base">school</span>'+className+'</span>');
      parts.push('</div>');
      parts.push('</div>');

      // Quick stats with icons
      parts.push('<div class="poll-card-meta">');
      parts.push('<span class="poll-card-quick-stat"><span class="material-symbols-outlined" style="font-size: 14px">quiz</span>'+questionCount+' '+questionLabel+'</span>');
      parts.push('<span class="poll-card-quick-stat"><span class="material-symbols-outlined" style="font-size: 14px">history</span>'+sessionBadgeText+'</span>');
      parts.push('</div>');

      parts.push('<div class="poll-card-actions">');
      parts.push('<button type="button" class="poll-card-btn primary poll-select-btn" data-poll-id="'+(poll&&poll.pollId?poll.pollId:'')+'" aria-label="Select '+safeName+' for a session"><span class="material-symbols-outlined text-base">play_arrow</span><span>Start</span></button>');
      parts.push('<button type="button" class="poll-card-btn secondary poll-edit-btn" data-poll-id="'+(poll&&poll.pollId?poll.pollId:'')+'" aria-label="Edit '+safeName+'"><span class="material-symbols-outlined text-base">edit</span></button>');
      parts.push('<button type="button" class="poll-card-btn secondary poll-copy-btn" data-poll-id="'+(poll&&poll.pollId?poll.pollId:'')+'" aria-label="Duplicate '+safeName+'" title="Duplicate poll"><span class="material-symbols-outlined text-base">content_copy</span></button>');
      parts.push('<button type="button" class="poll-card-btn danger poll-delete-btn" data-poll-id="'+(poll&&poll.pollId?poll.pollId:'')+'" aria-label="Delete '+safeName+'" title="Delete poll"><span class="material-symbols-outlined text-base">delete</span></button>');
      parts.push('</div>');

      parts.push('</div>'); // End card body

      card.innerHTML=parts.join('');

      card.addEventListener('click',function(event){
        if(event.target.closest('.poll-card-btn')){
          return;
        }
        var pollId=this.dataset.pollId;
        if(!pollId)return;
        pollSelect.value=pollId;
        onPollSelectChange();
        showDashboard();
      });

      card.addEventListener('keydown',function(event){
        if(event.target.closest('.poll-card-btn')){
          return;
        }
        if(event.key==='Enter'||event.key===' '||event.key==='Spacebar'){
          event.preventDefault();
          var pollId=this.dataset.pollId;
          if(!pollId)return;
          pollSelect.value=pollId;
          onPollSelectChange();
          showDashboard();
        }
      });

      pollsCardView.appendChild(card);
    });

    attachPollActionHandlers(pollsCardView);
  }

  function renderPollTable(polls){
    polls=polls||getFilteredSortedPolls();
    pollsTableBody.innerHTML='';

    if(polls.length===0){
      return;
    }

    polls.forEach(function(poll){
      var row=document.createElement('tr');
      row.className='hover:bg-brand-light-gray/40 dark:hover:bg-brand-dark-gray/40 transition-colors';
      var lastEdited=formatDateTime(poll.updatedAt||poll.lastRunAt||poll.createdAt);
      var createdLabel=poll.createdAt?formatDateTime(poll.createdAt):'â€”';
      var htmlParts=[];
      htmlParts.push('<td class="px-4 py-3 align-top">');
      htmlParts.push('<div class="font-semibold text-brand-dark-gray dark:text-brand-white"><span class="poll-name-link cursor-pointer hover:text-primary dark:hover:text-primary transition-colors" data-poll-id="'+poll.pollId+'">'+escapeHtml(poll.pollName||'Untitled Poll')+'</span></div>');
      htmlParts.push('<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/50">Created '+createdLabel+'</div>');
      htmlParts.push('</td>');
      htmlParts.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+escapeHtml(poll.className||'â€”')+'</td>');
      htmlParts.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+(poll.questions?poll.questions.length:0)+'</td>');
      htmlParts.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+lastEdited+'</td>');
      htmlParts.push('<td class="px-4 py-3 align-top">');
      htmlParts.push('<div class="flex justify-end gap-2">');
      htmlParts.push('<button class="poll-select-btn h-8 px-3 rounded-md bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-xs font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors" data-poll-id="'+poll.pollId+'">Select</button>');
      htmlParts.push('<button class="poll-copy-btn h-8 px-3 rounded-md bg-green-600/10 text-green-600 dark:text-green-300 dark:bg-green-500/20 text-xs font-semibold hover:bg-green-600/20 dark:hover:bg-green-500/30 transition-colors" data-poll-id="'+poll.pollId+'" title="Copy this poll">Copy</button>');
      htmlParts.push('<button class="poll-edit-btn h-8 px-3 rounded-md bg-primary text-brand-white text-xs font-semibold hover:bg-primary/90 transition-colors" data-poll-id="'+poll.pollId+'">Edit</button>');
      htmlParts.push('<button class="poll-delete-btn h-8 px-3 rounded-md bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-xs font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors" data-poll-id="'+poll.pollId+'">Delete</button>');
      htmlParts.push('</div>');
      htmlParts.push('</td>');
      row.innerHTML=htmlParts.join('');
      pollsTableBody.appendChild(row);
    });

    attachPollActionHandlers(pollsTableBody);
  }

  function attachPollActionHandlers(root){
    if(!root){
      return;
    }

    root.querySelectorAll('.poll-select-btn').forEach(function(btn){
      btn.onclick=function(){
        var id=this.dataset.pollId;
        if(!id){
          return;
        }
        pollSelect.value=id;
        onPollSelectChange();
        showDashboard();
      };
    });

    root.querySelectorAll('.poll-copy-btn').forEach(function(btn){
      btn.onclick=async function(){
        var button=this;
        var pollId=button.dataset.pollId;
        var poll=ALL_POLLS.find(function(p){return p.pollId===pollId;});
        if(!poll)return;

        var newName=await veritasPrompt('Enter a name for the copied poll:',{
          defaultValue:poll.pollName+' (Copy)',
          title:'Copy poll'
        });
        if(newName===null)return;

        newName=newName.trim();
        if(newName===''){
          await veritasAlert('Poll name cannot be empty',{title:'Copy poll'});
          return;
        }

        var originalLabel=button.textContent;
        button.disabled=true;
        button.textContent='Copying...';

        if(PREVIEW_MODE){
          setTimeout(async function(){
            var clone=deepClone(poll);
            clone.pollId=poll.pollId+'-copy-'+Date.now();
            clone.pollName=newName;
            clone.createdAt=new Date().toISOString();
            clone.updatedAt=clone.createdAt;
            ALL_POLLS.push(clone);
            refreshPollViews();
            button.disabled=false;
            button.textContent=originalLabel;
            await veritasAlert('Poll copied (preview data only).',{title:'Poll copied'});
          },140);
          return;
        }

        google.script.run
          .withSuccessHandler(async function(result){
            if(result.success){
              refreshPollData(result.polls);
              await veritasAlert(result.message,{title:'Poll copied'});
            } else {
              await veritasAlert('Failed to copy poll: '+(result.error||'Unknown error'),{
                title:'Copy poll failed',
                destructive:true
              });
            }
            button.disabled=false;
            button.textContent=originalLabel;
          })
          .withFailureHandler(function(error){
            handleError(error);
            button.disabled=false;
            button.textContent=originalLabel;
          })
          .copyPoll(pollId,newName,poll.className);
      };
    });

    root.querySelectorAll('.poll-edit-btn').forEach(function(btn){
      btn.onclick=function(){
        startEditPoll(this.dataset.pollId,this);
      };
    });

    root.querySelectorAll('.poll-delete-btn').forEach(function(btn){
      btn.onclick=async function(){
        var button=this;
        var id=button.dataset.pollId;
        var confirmed=await veritasConfirm('Delete this poll permanently? This will also remove all responses.',{
          title:'Delete poll',
          confirmText:'Delete',
          destructive:true
        });
        if(!confirmed)return;

        if(PREVIEW_MODE){
          setTimeout(function(){
            ALL_POLLS=ALL_POLLS.filter(function(p){return p.pollId!==id;});
            refreshPollViews();
            veritasAlert('Poll deleted (preview data only).',{title:'Delete poll'});
          },120);
          return;
        }

        google.script.run
          .withSuccessHandler(function(polls){
            refreshPollData(polls);
          })
          .withFailureHandler(handleError)
          .deletePoll(id);
      };
    });

    root.querySelectorAll('.poll-name-link').forEach(function(link){
      link.onclick=function(e){
        e.preventDefault();
        e.stopPropagation();
        startEditPoll(this.dataset.pollId);
      };
    });
  }

  function refreshPollData(polls){
    ALL_POLLS=polls||[];
    refreshClassOptions(BASE_CLASSES);
    refreshPollViews();
  }

  function onPollSelectChange(){
    var pollId=pollSelect.value;
    var selectedPoll=pollId?ALL_POLLS.find(function(p){return p.pollId===pollId;}):null;
    var className=selectedPoll&&selectedPoll.className?selectedPoll.className:'';
    var hasSelection=!!selectedPoll;

    if(sendLinkBtn){
      if(hasSelection && className){
        sendLinkBtn.disabled=false;
        sendLinkBtn.removeAttribute('aria-disabled');
        sendLinkBtn.dataset.className=className;
      } else {
        setButtonLoading(sendLinkBtn,false);
        sendLinkBtn.disabled=true;
        sendLinkBtn.setAttribute('aria-disabled','true');
        delete sendLinkBtn.dataset.className;
      }
    }

    if(viewLinksBtn){
      if(hasSelection && className){
        viewLinksBtn.disabled=false;
        viewLinksBtn.removeAttribute('aria-disabled');
        viewLinksBtn.dataset.className=className;
      } else {
        setButtonLoading(viewLinksBtn,false);
        viewLinksBtn.disabled=true;
        viewLinksBtn.setAttribute('aria-disabled','true');
        delete viewLinksBtn.dataset.className;
      }
    }

    if(startPollBtn){
      setButtonLoading(startPollBtn,false);
      startPollBtn.disabled=!hasSelection;
      if(startPollBtn.disabled){
        startPollBtn.setAttribute('aria-disabled','true');
      }else{
        startPollBtn.removeAttribute('aria-disabled');
      }
    }
  }

  // --- Roster Management ---
  function loadRosterData(){
    rosterStatus.textContent='Loading roster...';
    if(PREVIEW_MODE&&PREVIEW_PAYLOAD){
      setTimeout(function(){
        rosterStatus.textContent='';
        onRosterDataLoaded({
          classes:deepClone(PREVIEW_PAYLOAD.classes||[]),
          rosters:deepClone(PREVIEW_PAYLOAD.rosters||{})
        },selectedRosterClass);
      },150);
      return;
    }

    google.script.run
      .withSuccessHandler(function(data){
        rosterStatus.textContent='';
        onRosterDataLoaded(data, selectedRosterClass);
      })
      .withFailureHandler(function(error){
        rosterStatus.textContent='';
        handleError(error);
      })
      .getRosterManagerData();
  }

  function onRosterDataLoaded(data, focusClass){
    rosterDirty=false;
    rosterData=data&&data.rosters?data.rosters:{};
    refreshClassOptions((data&&data.classes)||BASE_CLASSES);

    if(focusClass){
      selectedRosterClass=focusClass;
    }

    if(selectedRosterClass && !rosterData[selectedRosterClass]){
      selectedRosterClass='';
    }

    renderRosterClassList();

    if(selectedRosterClass){
      renderRosterTable();
    } else {
      rosterClassTitle.textContent='Select a class';
      rosterEmptyState.classList.remove('hidden');
      rosterTableWrapper.classList.add('hidden');
      renameClassBtn.classList.add('hidden');
      deleteClassBtn.classList.add('hidden');
      rosterStatus.textContent='';
    }
  }

  function renderRosterClassList(){
    rosterClassList.innerHTML='';
    if(ALL_CLASSES.length===0){
      rosterClassList.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No classes yet. Click the + button to add one.</p>';
      return;
    }

    ALL_CLASSES.forEach(function(className){
      var button=document.createElement('button');
      button.type='button';
      var isActive=className===selectedRosterClass;
      button.className='w-full text-left px-3 py-2 rounded-lg transition-colors '+(isActive?'bg-primary text-brand-white shadow-sm':'bg-brand-light-gray/40 dark:bg-brand-dark-gray/30 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/60 dark:hover:bg-brand-dark-gray/50');
      button.textContent=className;
      button.onclick=function(){
        selectRosterClass(className);
      };
      rosterClassList.appendChild(button);
    });
  }

  function selectRosterClass(className){
    selectedRosterClass=className;
    rosterDirty=false;
    rosterStatus.textContent='';
    renderRosterClassList();
    renderRosterTable();
  }

  function renderRosterTable(){
    if(!selectedRosterClass){
      return;
    }

    var entries=rosterData[selectedRosterClass]||[];
    rosterData[selectedRosterClass]=entries;

    if(entries.length===0){
      entries.push({name:'',email:''});
    }

    rosterClassTitle.textContent=selectedRosterClass;
    rosterEmptyState.classList.add('hidden');
    rosterTableWrapper.classList.remove('hidden');
    renameClassBtn.classList.remove('hidden');
    deleteClassBtn.classList.remove('hidden');

    rosterTableBody.innerHTML='';
    entries.forEach(function(entry,index){
      var row=document.createElement('tr');
      row.innerHTML=
        '<td class="px-4 py-2 align-top">'+
          '<input type="text" class="roster-name-input w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" data-index="'+index+'" placeholder="Student Name" value="'+escapeHtml(entry.name||'')+'" />'+
        '</td>'+
        '<td class="px-4 py-2 align-top">'+
          '<input type="email" class="roster-email-input w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" data-index="'+index+'" placeholder="email@example.com" value="'+escapeHtml(entry.email||'')+'" />'+
        '</td>'+
        '<td class="px-4 py-2 align-top text-center">'+
          '<button class="remove-roster-row-btn h-8 w-8 rounded-full bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors" data-index="'+index+'" title="Remove">'+
            '<span class="material-symbols-outlined text-base">close</span>'+
          '</button>'+
        '</td>';
      rosterTableBody.appendChild(row);
    });

    rosterTableBody.querySelectorAll('.roster-name-input').forEach(function(input){
      input.oninput=function(){
        var idx=parseInt(this.dataset.index,10);
        rosterData[selectedRosterClass][idx].name=this.value;
        markRosterDirty();
      };
    });

    rosterTableBody.querySelectorAll('.roster-email-input').forEach(function(input){
      input.oninput=function(){
        var idx=parseInt(this.dataset.index,10);
        rosterData[selectedRosterClass][idx].email=this.value;
        markRosterDirty();
      };
    });

    rosterTableBody.querySelectorAll('.remove-roster-row-btn').forEach(function(btn){
      btn.onclick=function(){
        var idx=parseInt(this.dataset.index,10);
        removeRosterRow(idx);
      };
    });
  }

  function markRosterDirty(){
    rosterDirty=true;
    rosterStatus.textContent='Unsaved changes';
  }

  async function addRosterRow(){
    if(!selectedRosterClass){
      await veritasAlert('Select a class first.',{title:'Roster'});
      return;
    }
    if(!rosterData[selectedRosterClass]){
      rosterData[selectedRosterClass]=[];
    }
    rosterData[selectedRosterClass].push({name:'',email:''});
    markRosterDirty();
    renderRosterTable();
  }

  function removeRosterRow(index){
    if(!selectedRosterClass)return;
    var entries=rosterData[selectedRosterClass]||[];
    if(entries.length>index){
      entries.splice(index,1);
      markRosterDirty();
      if(entries.length===0){
        entries.push({name:'',email:''});
      }
      renderRosterTable();
    }
  }

  async function saveRoster(){
    if(!selectedRosterClass){
      await veritasAlert('Select a class to save.',{title:'Roster'});
      return;
    }

    var entries=(rosterData[selectedRosterClass]||[]).map(function(entry){
      return {
        name:(entry.name||'').trim(),
        email:(entry.email||'').trim()
      };
    }).filter(function(entry){
      return entry.name!==''&&entry.email!=='';
    });

    saveRosterBtn.disabled=true;
    rosterStatus.textContent='Saving roster...';

    if(PREVIEW_MODE){
      setTimeout(function(){
        rosterData[selectedRosterClass]=entries;
        saveRosterBtn.disabled=false;
        rosterStatus.textContent='Roster saved (preview)';
        rosterDirty=false;
      },140);
      return;
    }

    google.script.run
      .withSuccessHandler(function(data){
        saveRosterBtn.disabled=false;
        rosterStatus.textContent='Roster saved.';
        rosterDirty=false;
        onRosterDataLoaded(data, selectedRosterClass);
      })
      .withFailureHandler(function(error){
        saveRosterBtn.disabled=false;
        handleError(error);
      })
      .saveRoster(selectedRosterClass, entries);
  }

  async function openBulkAddStudentsModal(){
    if(!selectedRosterClass){
      await veritasAlert('Select a class first.',{title:'Roster'});
      return;
    }
    document.getElementById('bulk-student-input').value='';
    document.getElementById('bulk-add-students-modal').style.display='flex';
  }

  function closeBulkAddStudentsModal(){
    document.getElementById('bulk-add-students-modal').style.display='none';
  }

  async function confirmBulkAddStudents(){
    if(!selectedRosterClass){
      await veritasAlert('Select a class first.',{title:'Roster'});
      closeBulkAddStudentsModal();
      return;
    }

    var input=document.getElementById('bulk-student-input').value;
    var lines=input.split('\n');
    var entries=[];

    lines.forEach(function(line){
      line=line.trim();
      if(line==='')return;

      // Parse format: Name, Email
      var parts=line.split(',');
      if(parts.length>=2){
        var name=parts[0].trim();
        var email=parts.slice(1).join(',').trim();
        if(name&&email){
          entries.push({name:name,email:email});
        }
      }
    });

    if(entries.length===0){
      await veritasAlert('No valid student entries found. Use format: Name, Email',{title:'Bulk add students'});
      return;
    }

    var confirmBtn=document.getElementById('confirm-bulk-add-btn');
    confirmBtn.disabled=true;
    confirmBtn.textContent='Adding...';

    if(PREVIEW_MODE){
      setTimeout(async function(){
        confirmBtn.disabled=false;
        confirmBtn.textContent='Add Students';
        closeBulkAddStudentsModal();
        rosterData[selectedRosterClass]=(rosterData[selectedRosterClass]||[]).concat(entries);
        rosterDirty=false;
        renderRosterTable();
        await veritasAlert('Students added (preview data only).',{title:'Bulk add students'});
      },160);
      return;
    }

    google.script.run
      .withSuccessHandler(async function(result){
        confirmBtn.disabled=false;
        confirmBtn.textContent='Add Students';
        closeBulkAddStudentsModal();

        if(result.success){
          await veritasAlert(result.message,{title:'Students added'});
          rosterDirty=false;
          onRosterDataLoaded(result.data,selectedRosterClass);
        } else {
          await veritasAlert('Failed to add students: '+(result.error||'Unknown error'),{
            title:'Bulk add students',
            destructive:true
          });
        }
      })
      .withFailureHandler(function(error){
        confirmBtn.disabled=false;
        confirmBtn.textContent='Add Students';
        handleError(error);
      })
      .bulkAddStudentsToRoster(selectedRosterClass,entries);
  }

  async function onAddClass(){
    var className=await veritasPrompt('Class name',{title:'Add class',confirmText:'Create'});
    if(!className)return;
    className=className.trim();
    if(className==='')return;
    rosterStatus.textContent='Creating class...';
    if(PREVIEW_MODE){
      setTimeout(function(){
        rosterStatus.textContent='Class created (preview).';
        rosterData[className]=rosterData[className]||[];
        selectedRosterClass=className;
        onRosterDataLoaded({
          classes:deepClone(Object.keys(rosterData)),
          rosters:deepClone(rosterData)
        },className);
      },120);
      return;
    }

    google.script.run
      .withSuccessHandler(function(data){
        rosterStatus.textContent='Class created.';
        selectedRosterClass=className;
        onRosterDataLoaded(data, className);
      })
      .withFailureHandler(function(error){
        rosterStatus.textContent='';
        handleError(error);
      })
      .createClassRecord(className,'');
  }

  async function onRenameClass(){
    if(!selectedRosterClass){
      await veritasAlert('Select a class first.',{title:'Roster'});
      return;
    }
    var newName=await veritasPrompt('Rename class',{title:'Rename class',defaultValue:selectedRosterClass,confirmText:'Rename'});
    if(!newName)return;
    newName=newName.trim();
    if(newName===''){return;}
    if(newName===selectedRosterClass)return;
    rosterStatus.textContent='Renaming class...';
    if(PREVIEW_MODE){
      setTimeout(function(){
        var existing=rosterData[selectedRosterClass]||[];
        delete rosterData[selectedRosterClass];
        rosterData[newName]=existing;
        rosterStatus.textContent='Class renamed (preview).';
        selectedRosterClass=newName;
        onRosterDataLoaded({
          classes:deepClone(Object.keys(rosterData)),
          rosters:deepClone(rosterData)
        },newName);
      },140);
      return;
    }

    google.script.run
      .withSuccessHandler(function(data){
        rosterStatus.textContent='Class renamed.';
        selectedRosterClass=newName;
        onRosterDataLoaded(data, newName);
      })
      .withFailureHandler(function(error){
        rosterStatus.textContent='';
        handleError(error);
      })
      .renameClass(selectedRosterClass,newName);
  }

  async function onDeleteClass(){
    if(!selectedRosterClass){
      await veritasAlert('Select a class first.',{title:'Roster'});
      return;
    }
    var confirmed=await veritasConfirm('Delete class "'+selectedRosterClass+'" and remove all students?',{
      title:'Delete class',
      confirmText:'Delete',
      destructive:true
    });
    if(!confirmed)return;
    rosterStatus.textContent='Deleting class...';
    var classToDelete=selectedRosterClass;
    if(PREVIEW_MODE){
      setTimeout(function(){
        delete rosterData[classToDelete];
        selectedRosterClass='';
        rosterStatus.textContent='Class deleted (preview).';
        onRosterDataLoaded({
          classes:deepClone(Object.keys(rosterData)),
          rosters:deepClone(rosterData)
        },'');
      },140);
      return;
    }

    google.script.run
      .withSuccessHandler(function(data){
        rosterStatus.textContent='Class deleted.';
        selectedRosterClass='';
        onRosterDataLoaded(data, '');
      })
      .withFailureHandler(function(error){
        rosterStatus.textContent='';
        handleError(error);
      })
      .deleteClassRecord(classToDelete);
  }

  // --- Archived Polls ---
  function loadArchivedPolls(force){
    if(archivedPolls.length>0&&!force){
      renderArchivedList();
      renderArchivedDetail();
      return;
    }

    archivedList.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">Loading archived polls...</p>';
    archivedEmptyState.classList.remove('hidden');
    archivedDetail.classList.add('hidden');

    if(PREVIEW_MODE&&PREVIEW_PAYLOAD){
      setTimeout(function(){
        archivedPolls=deepClone(PREVIEW_PAYLOAD.archivedPolls||[]);
        if(archivedPolls.length>0){
          selectedArchivedPollId=archivedPolls[0].pollId;
        }else{
          selectedArchivedPollId='';
        }
        renderArchivedList();
        renderArchivedDetail();
      },150);
      return;
    }

    google.script.run
      .withSuccessHandler(function(polls){
        archivedPolls=polls||[];
        if(archivedPolls.length>0){
          if(!archivedPolls.some(function(p){return p.pollId===selectedArchivedPollId;})){
            selectedArchivedPollId=archivedPolls[0].pollId;
          }
        } else {
          selectedArchivedPollId='';
        }
        renderArchivedList();
        renderArchivedDetail();
      })
      .withFailureHandler(handleError)
      .getArchivedPolls();
  }

  function renderArchivedList(){
    archivedList.innerHTML='';
    var filtered=archivedClassFilter==='all'?archivedPolls:archivedPolls.filter(function(poll){return poll.className===archivedClassFilter;});

    if(filtered.length===0){
      archivedList.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No archived polls for this filter.</p>';
      archivedEmptyState.classList.remove('hidden');
      archivedDetail.classList.add('hidden');
      return;
    }

    filtered.forEach(function(poll){
      var button=document.createElement('button');
      button.type='button';
      var isActive=poll.pollId===selectedArchivedPollId;
      button.className='w-full text-left px-3 py-2 rounded-lg transition-colors '+(isActive?'bg-primary text-brand-white shadow-sm':'bg-brand-light-gray/40 dark:bg-brand-dark-gray/30 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/60 dark:hover:bg-brand-dark-gray/50');
      var metaText=(poll.className||'Unassigned')+' â€¢ '+formatDateTime(poll.lastRunAt||poll.updatedAt||poll.createdAt);
      button.innerHTML='<div class="font-semibold">'+escapeHtml(poll.pollName||'Untitled Poll')+'</div><div class="text-xs opacity-80">'+escapeHtml(metaText)+'</div>';
      button.onclick=function(){
        selectedArchivedPollId=poll.pollId;
        renderArchivedList();
        renderArchivedDetail();
      };
      archivedList.appendChild(button);
    });
  }

  function renderArchivedDetail(){
    var poll=archivedPolls.find(function(p){return p.pollId===selectedArchivedPollId;});
    if(!poll){
      archivedEmptyState.classList.remove('hidden');
      archivedDetail.classList.add('hidden');
      return;
    }

    archivedEmptyState.classList.add('hidden');
    archivedDetail.classList.remove('hidden');

    archivedPollTitle.textContent=poll.pollName||'Untitled Poll';
    archivedPollMeta.textContent=(poll.className||'Unassigned')+' â€¢ Last run '+formatDateTime(poll.lastRunAt||poll.updatedAt||poll.createdAt);
    archivedQuestionCount.textContent=poll.questionCount||0;
    archivedResponseCount.textContent=(poll.totalResponses||0)+' of '+(poll.totalStudents||0);

    archivedQuestionsContainer.innerHTML='';
    poll.questions.forEach(function(question,index){
      var card=document.createElement('div');
      card.className='border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-4 bg-brand-white dark:bg-brand-dark-gray/40';
      var summary=question.summary||{correct:0,incorrect:0,noResponse:0,violations:0};
      var responses=Array.isArray(question.responses)?question.responses:[];
      var nonResponders=Array.isArray(question.nonResponders)?question.nonResponders:[];
      summary.correct=summary.correct||0;
      summary.incorrect=summary.incorrect||0;
      summary.noResponse=summary.noResponse||0;
      summary.violations=summary.violations||0;

      var responsesHtml='';
      if(responses.length===0){
        responsesHtml='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No responses recorded.</p>';
      } else {
        responsesHtml='<table class="min-w-full text-sm divide-y divide-brand-light-gray dark:divide-brand-dark-gray/40"><thead class="text-xs uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/50"><tr><th class="py-2 text-left">Student</th><th class="py-2 text-left">Answer</th><th class="py-2 text-left">Status</th></tr></thead><tbody class="divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/40">';
        responses.forEach(function(response){
          var status=response.violation?'Violation':(response.isCorrect?'Correct':'Incorrect');
          var statusClass=response.violation?'text-orange-600 dark:text-orange-300':(response.isCorrect?'text-green-600 dark:text-green-300':'text-red-600 dark:text-red-300');
          responsesHtml+='<tr><td class="py-2 pr-3">'+escapeHtml(response.name||response.email)+'</td><td class="py-2 pr-3">'+escapeHtml(response.answer||'â€”')+'</td><td class="py-2 pr-3 '+statusClass+'">'+status+'</td></tr>';
        });
        responsesHtml+='</tbody></table>';
      }

      var nonResponderHtml='';
      if(nonResponders.length>0){
        nonResponderHtml='<div class="mt-3"><h4 class="text-xs font-semibold uppercase text-brand-dark-gray/60 dark:text-brand-white/60">No Response</h4><div class="flex flex-wrap gap-2 mt-1">';
        nonResponders.forEach(function(student){
          var chipClass=student.violation?'bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-200':'bg-brand-light-gray text-brand-dark-gray dark:bg-brand-dark-gray/50 dark:text-brand-white/80';
          var displayName = student.name ? formatStudentName(student) : student.email;
          nonResponderHtml+='<span class="px-2 py-1 rounded-full text-xs '+chipClass+'">'+escapeHtml(displayName)+'</span>';
        });
        nonResponderHtml+='</div></div>';
      }

      var imageHtml=question.questionImageURL?'<div class="mt-3"><img src="'+escapeHtml(question.questionImageURL)+'" class="max-h-48 rounded-lg object-contain" alt="Question image" /></div>':'';
      var questionHtml='<div><h3 class="font-serif text-lg text-brand-dark-gray dark:text-brand-white">Question '+(index+1)+'</h3><p class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 mt-1">'+escapeHtml(question.questionText||'')+'</p></div>';
      var summaryHtml='<div class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 text-right">'+
        '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Correct:</span> '+summary.correct+'</p>'+
        '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Incorrect:</span> '+summary.incorrect+'</p>'+
        '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">No Response:</span> '+summary.noResponse+'</p>'+
        '<p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Violations:</span> '+summary.violations+'</p>'+
      '</div>';
      card.innerHTML='<div class="flex flex-wrap items-start justify-between gap-3">'+questionHtml+summaryHtml+'</div>'+imageHtml+'<div class="mt-4">'+responsesHtml+'</div>'+nonResponderHtml;

      archivedQuestionsContainer.appendChild(card);
    });
  }

  // =============================================================================
  // POST-POLL ANALYTICS - PSYCHOMETRIC ANALYSIS
  // =============================================================================

  function openPostPollAnalytics(pollId) {
    var modal = document.getElementById('post-poll-analytics-modal');
    var loadingEl = document.getElementById('analytics-loading');
    var reportEl = document.getElementById('analytics-report');

    modal.style.display = 'flex';
    loadingEl.classList.remove('hidden');
    reportEl.classList.add('hidden');

    google.script.run
      .withSuccessHandler(function(data) {
        if (data.success) {
          renderPostPollAnalytics(data);
        } else {
          loadingEl.innerHTML = '<div class="text-center py-12"><p class="text-red-600">Error: ' + escapeHtml(data.error || 'Failed to load analytics') + '</p></div>';
        }
      })
      .withFailureHandler(function(error) {
        loadingEl.innerHTML = '<div class="text-center py-12"><p class="text-red-600">Error: ' + escapeHtml(error.message || 'Unknown error') + '</p></div>';
      })
      .getPostPollAnalytics(pollId);
  }

  function renderPostPollAnalytics(data) {
    var loadingEl = document.getElementById('analytics-loading');
    var reportEl = document.getElementById('analytics-report');

    // Update header
    document.getElementById('analytics-poll-name').textContent = data.pollName || 'Poll Analysis';
    document.getElementById('analytics-poll-meta').textContent = data.className + ' â€¢ ' + data.questionCount + ' Questions';

    // Render Class Overview
    renderClassOverview(data.classOverview, data.distribution);

    // Render Metacognition (if enabled)
    if (data.metacognition && data.metacognition.enabled) {
      renderMetacognitionAnalysis(data.metacognition);
      document.getElementById('metacognition-section').classList.remove('hidden');
    } else {
      document.getElementById('metacognition-section').classList.add('hidden');
    }

    // Render Item Analysis
    renderItemAnalysis(data.itemAnalysis);

    loadingEl.classList.add('hidden');
    reportEl.classList.remove('hidden');
  }

  function renderClassOverview(overview, distribution) {
    var container = document.getElementById('class-overview-content');

    var html = '<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">';
    html += '<div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700/30 rounded-lg p-4">';
    html += '<div class="text-sm text-blue-700 dark:text-blue-300 font-semibold mb-1">Mean Score</div>';
    html += '<div class="text-3xl font-bold text-blue-900 dark:text-blue-100">' + overview.mean + '</div>';
    html += '</div>';

    html += '<div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700/30 rounded-lg p-4">';
    html += '<div class="text-sm text-green-700 dark:text-green-300 font-semibold mb-1">Median Score</div>';
    html += '<div class="text-3xl font-bold text-green-900 dark:text-green-100">' + overview.median + '</div>';
    html += '</div>';

    html += '<div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-700/30 rounded-lg p-4">';
    html += '<div class="text-sm text-purple-700 dark:text-purple-300 font-semibold mb-1">Std. Deviation</div>';
    html += '<div class="text-3xl font-bold text-purple-900 dark:text-purple-100">' + overview.stdDev + '</div>';
    html += '</div>';

    html += '<div class="bg-gray-50 dark:bg-gray-900/20 border border-gray-200 dark:border-gray-700/30 rounded-lg p-4">';
    html += '<div class="text-sm text-gray-700 dark:text-gray-300 font-semibold mb-1">Participants</div>';
    html += '<div class="text-3xl font-bold text-gray-900 dark:text-gray-100">' + overview.participantCount + '</div>';
    html += '</div>';
    html += '</div>';

    // Score distribution histogram
    if (distribution && distribution.histogram && distribution.histogram.length > 0) {
      html += '<div class="bg-white dark:bg-brand-dark-gray/40 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-4">';
      html += '<h4 class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white mb-3">Score Distribution</h4>';
      html += '<div class="flex items-end gap-2 h-48">';

      var maxCount = Math.max.apply(null, distribution.histogram.map(function(d) { return d.count; }));
      distribution.histogram.forEach(function(item) {
        var heightPct = maxCount > 0 ? (item.count / maxCount) * 100 : 0;
        html += '<div class="flex-1 flex flex-col items-center gap-1">';
        html += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">' + item.count + '</div>';
        html += '<div class="w-full bg-primary rounded-t" style="height: ' + heightPct + '%;"></div>';
        html += '<div class="text-xs font-semibold text-brand-dark-gray dark:text-brand-white">' + item.score + '</div>';
        html += '</div>';
      });
      html += '</div>';
      html += '</div>';
    }

    container.innerHTML = html;
  }

  function renderMetacognitionAnalysis(metacognition) {
    var container = document.getElementById('metacognition-content');

    if (!metacognition.overall) {
      container.innerHTML = '<p class="text-brand-dark-gray/60 dark:text-brand-white/60">No metacognition data available yet.</p>';
      return;
    }

    var html = '<div class="bg-white dark:bg-brand-dark-gray/40 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-6 mb-4">';
    html += '<h4 class="text-lg font-semibold text-brand-dark-gray dark:text-brand-white mb-4">Confidence vs. Correctness Matrix</h4>';
    html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';

    // Confident & Correct (Mastery)
    html += '<div class="bg-green-50 dark:bg-green-900/20 border-2 border-green-500 rounded-lg p-4">';
    html += '<div class="flex items-center gap-2 mb-2">';
    html += '<span class="text-2xl">ðŸ’¯</span>';
    html += '<div class="text-sm font-semibold text-green-700 dark:text-green-300">Conscious Competence</div>';
    html += '</div>';
    html += '<div class="text-3xl font-bold text-green-900 dark:text-green-100">' + metacognition.overall.confidentCorrect + '%</div>';
    html += '<div class="text-xs text-green-700 dark:text-green-300 mt-1">Confident & Correct (Mastery!)</div>';
    html += '</div>';

    // Confident & Incorrect (RED ALERT)
    html += '<div class="bg-red-50 dark:bg-red-900/20 border-2 border-red-500 rounded-lg p-4">';
    html += '<div class="flex items-center gap-2 mb-2">';
    html += '<span class="text-2xl">âš ï¸</span>';
    html += '<div class="text-sm font-semibold text-red-700 dark:text-red-300">Confidently Incorrect</div>';
    html += '</div>';
    html += '<div class="text-3xl font-bold text-red-900 dark:text-red-100">' + metacognition.overall.confidentIncorrect + '%</div>';
    html += '<div class="text-xs text-red-700 dark:text-red-300 mt-1">RED ALERT: Deep misconception!</div>';
    html += '</div>';

    // Uncertain & Correct (Lucky guess)
    html += '<div class="bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-500 rounded-lg p-4">';
    html += '<div class="flex items-center gap-2 mb-2">';
    html += '<span class="text-2xl">ðŸ¤”</span>';
    html += '<div class="text-sm font-semibold text-yellow-700 dark:text-yellow-300">Imposter Syndrome</div>';
    html += '</div>';
    html += '<div class="text-3xl font-bold text-yellow-900 dark:text-yellow-100">' + metacognition.overall.uncertainCorrect + '%</div>';
    html += '<div class="text-xs text-yellow-700 dark:text-yellow-300 mt-1">Uncertain but Correct (Lucky?)</div>';
    html += '</div>';

    // Uncertain & Incorrect (Conscious incompetence)
    html += '<div class="bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-500 rounded-lg p-4">';
    html += '<div class="flex items-center gap-2 mb-2">';
    html += '<span class="text-2xl">ðŸ¤·</span>';
    html += '<div class="text-sm font-semibold text-blue-700 dark:text-blue-300">Conscious Incompetence</div>';
    html += '</div>';
    html += '<div class="text-3xl font-bold text-blue-900 dark:text-blue-100">' + metacognition.overall.uncertainIncorrect + '%</div>';
    html += '<div class="text-xs text-blue-700 dark:text-blue-300 mt-1">Know they don\'t know (Good!)</div>';
    html += '</div>';

    html += '</div>';
    html += '</div>';

    container.innerHTML = html;
  }

  function renderItemAnalysis(items) {
    var container = document.getElementById('item-analysis-content');

    var html = '';
    items.forEach(function(item, index) {
      var difficultyColor = item.difficultyPct > 90 ? 'green' : item.difficultyPct < 30 ? 'red' : 'blue';
      var discColor = item.discrimination > 0.3 ? 'green' : item.discrimination < 0 ? 'red' : 'yellow';

      html += '<div class="bg-white dark:bg-brand-dark-gray/40 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-5 mb-4">';
      html += '<div class="flex items-start justify-between gap-4 mb-4">';
      html += '<div class="flex-1">';
      html += '<h4 class="font-semibold text-brand-dark-gray dark:text-brand-white">Question ' + (index + 1) + '</h4>';
      html += '<p class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 mt-1">' + escapeHtml(item.questionText) + '</p>';
      html += '</div>';

      // Metrics
      html += '<div class="flex gap-3">';
      html += '<div class="text-center">';
      html += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mb-1">Difficulty</div>';
      html += '<div class="text-2xl font-bold text-' + difficultyColor + '-600 dark:text-' + difficultyColor + '-400">' + item.difficultyPct + '%</div>';
      html += '</div>';
      html += '<div class="text-center">';
      html += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mb-1">Discrimination</div>';
      html += '<div class="text-2xl font-bold text-' + discColor + '-600 dark:text-' + discColor + '-400">' + item.discrimination + '</div>';
      html += '</div>';
      html += '</div>';
      html += '</div>';

      // Flags
      if (item.flags && item.flags.length > 0) {
        html += '<div class="flex flex-wrap gap-2 mb-3">';
        item.flags.forEach(function(flag) {
          var flagClass = flag === 'negative-discrimination' ? 'bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300' :
                         flag === 'too-hard' ? 'bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-300' :
                         'bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-300';
          html += '<span class="px-2 py-1 rounded-full text-xs font-semibold ' + flagClass + '">' + flag.replace(/-/g, ' ') + '</span>';
        });
        html += '</div>';
      }

      // Distractor Analysis
      if (item.distractorAnalysis && item.distractorAnalysis.length > 0) {
        html += '<div class="bg-gray-50 dark:bg-brand-dark-gray/20 rounded-lg p-3">';
        html += '<h5 class="text-xs font-semibold uppercase text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">Distractor Analysis</h5>';
        html += '<div class="space-y-2">';

        item.distractorAnalysis.forEach(function(dist) {
          var qualityColor = dist.quality === 'excellent' || dist.quality === 'good' ? 'green' :
                            dist.quality === 'problematic' ? 'red' : 'gray';

          html += '<div class="flex items-center justify-between text-sm">';
          html += '<div class="flex items-center gap-2">';
          html += '<span class="font-semibold text-brand-dark-gray dark:text-brand-white">' + dist.optionLetter + '</span>';
          html += '<span class="text-brand-dark-gray/70 dark:text-brand-white/70">' + escapeHtml(dist.option.substring(0, 50)) + (dist.option.length > 50 ? '...' : '') + '</span>';
          if (dist.isCorrect) {
            html += '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300">Correct</span>';
          }
          html += '</div>';
          html += '<div class="flex items-center gap-3">';
          html += '<span class="text-brand-dark-gray/60 dark:text-brand-white/60">' + dist.totalPct + '%</span>';
          html += '<span class="text-xs text-' + qualityColor + '-600 dark:text-' + qualityColor + '-400">' + dist.quality + '</span>';
          html += '</div>';
          html += '</div>';
        });

        html += '</div>';
        html += '</div>';
      }

      html += '</div>';
    });

    container.innerHTML = html;
  }

  // =============================================================================
  // ANALYTICS HUB - CLIENT-SIDE CODE
  // =============================================================================

  var analyticsData = null;
  var analyticsCurrentTab = 'overview';
  var analyticsFilters = { className: 'all' };
  var analyticsItemsSort = { field: 'qNum', direction: 'asc' };
  var analyticsSelectedStudent = null;

  function showAnalyticsView() {
    clearLiveIntervals();
    headerDefault.style.display = 'flex';
    headerLive.style.display = 'none';
    setMainSection('analytics');

    // Populate class filter
    var analyticsClassFilter = document.getElementById('analytics-class-filter');
    analyticsClassFilter.innerHTML = '<option value="all">All Classes</option>';
    var classes = Array.from(new Set(ALL_POLLS.map(function(p) { return p.className; })));
    classes.forEach(function(className) {
      var opt = document.createElement('option');
      opt.value = className;
      opt.textContent = className;
      analyticsClassFilter.appendChild(opt);
    });

    if (!analyticsData) {
      loadAnalytics();
    } else {
      renderAnalyticsByTab();
    }

    // Start auto-refresh every 30 seconds
    if (analyticsRefreshInterval) {
      clearInterval(analyticsRefreshInterval);
    }
    analyticsRefreshInterval = setInterval(function() {
      // Silently refresh in the background
      analyticsData = null; // Clear cache
      loadAnalytics(analyticsFilters);
    }, 30000); // 30 seconds
  }

  function loadAnalytics(filters) {
    analyticsFilters = filters || analyticsFilters;

    // Show loading states
    document.getElementById('analytics-overview-loading').classList.remove('hidden');
    document.getElementById('analytics-overview-content').classList.add('hidden');
    document.getElementById('analytics-items-loading').classList.remove('hidden');
    document.getElementById('analytics-items-content').classList.add('hidden');
    document.getElementById('analytics-students-loading').classList.remove('hidden');
    document.getElementById('analytics-students-content').classList.add('hidden');

    if(PREVIEW_MODE&&PREVIEW_PAYLOAD){
      setTimeout(function(){
        analyticsData=deepClone(PREVIEW_PAYLOAD.analytics||{});
        document.getElementById('analytics-overview-loading').classList.add('hidden');
        document.getElementById('analytics-items-loading').classList.add('hidden');
        document.getElementById('analytics-students-loading').classList.add('hidden');
        renderAnalyticsByTab();
      },160);
      return;
    }

    google.script.run
      .withSuccessHandler(function(data) {
        analyticsData = data;
        // Clear loading states
        document.getElementById('analytics-overview-loading').classList.add('hidden');
        document.getElementById('analytics-items-loading').classList.add('hidden');
        document.getElementById('analytics-students-loading').classList.add('hidden');
        renderAnalyticsByTab();
      })
      .withFailureHandler(function(error) {
        console.error('Analytics loading error:', error);
        // Show error states
        document.getElementById('analytics-overview-loading').innerHTML = '<p class="text-red-600">Error loading analytics: ' + escapeHtml(error.message || 'Unknown error') + '</p>';
        document.getElementById('analytics-items-loading').innerHTML = '<p class="text-red-600">Error loading analytics: ' + escapeHtml(error.message || 'Unknown error') + '</p>';
        document.getElementById('analytics-students-loading').innerHTML = '<p class="text-red-600">Error loading analytics: ' + escapeHtml(error.message || 'Unknown error') + '</p>';
      })
      .getAnalyticsData(analyticsFilters);
  }

  function renderAnalyticsByTab() {
    if (analyticsCurrentTab === 'overview') {
      renderAnalyticsOverview();
    } else if (analyticsCurrentTab === 'items') {
      renderAnalyticsItems();
    } else if (analyticsCurrentTab === 'students') {
      renderAnalyticsStudents();
    }
  }

  // --- Overview Tab ---
  function renderAnalyticsOverview() {
    document.getElementById('analytics-overview-loading').classList.add('hidden');
    document.getElementById('analytics-overview-content').classList.remove('hidden');

    if (!analyticsData) return;

    // Render KPIs
    var kpiContainer = document.getElementById('analytics-kpi-container');
    kpiContainer.innerHTML = '';

    (analyticsData.kpis || []).forEach(function(kpi) {
      var card = document.createElement('div');
      card.className = 'bg-brand-white dark:bg-brand-dark-gray/40 rounded-xl p-5 border border-brand-light-gray dark:border-brand-dark-gray/40 shadow-sm hover:shadow-md transition-shadow cursor-pointer';
      card.title = kpi.tooltip;

      var deltaHtml = '';
      if (kpi.delta !== undefined && kpi.delta !== null) {
        var deltaColor = kpi.delta >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
        var deltaIcon = kpi.delta >= 0 ? 'â–²' : 'â–¼';
        deltaHtml = '<div class="text-xs font-semibold ' + deltaColor + ' mt-1">' + deltaIcon + ' ' + Math.abs(kpi.delta) + '</div>';
      }

      card.innerHTML = '<div class="text-xs font-semibold uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">' +
        escapeHtml(kpi.label) + '</div>' +
        '<div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">' +
        escapeHtml(kpi.value) + '</div>' + deltaHtml;

      kpiContainer.appendChild(card);
    });

    // Render Topic Heat (simplified version)
    var topicHeat = document.getElementById('analytics-topic-heat');
    if (analyticsData.topics && analyticsData.topics.length > 0) {
      var topicHtml = '<div class="space-y-2">';
      analyticsData.topics.forEach(function(topic) {
        var color = topic.masteryPct >= 70 ? 'bg-green-500' : topic.masteryPct >= 50 ? 'bg-yellow-500' : 'bg-red-500';
        topicHtml += '<div class="flex items-center gap-3">';
        topicHtml += '<div class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white min-w-[120px]">' + escapeHtml(topic.topic) + '</div>';
        topicHtml += '<div class="flex-1 bg-brand-light-gray dark:bg-brand-dark-gray/30 rounded-full h-6 overflow-hidden">';
        topicHtml += '<div class="' + color + ' h-full flex items-center justify-end px-2 text-xs text-white font-semibold" style="width: ' + topic.masteryPct + '%">';
        if (topic.masteryPct > 15) topicHtml += topic.masteryPct + '%';
        topicHtml += '</div></div>';
        topicHtml += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 min-w-[60px] text-right">' + topic.questionCount + ' items</div>';
        topicHtml += '</div>';
      });
      topicHtml += '</div>';
      topicHeat.innerHTML = topicHtml;
    } else {
      topicHeat.innerHTML = '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No topic data available. Add topic tags to your questions.</p>';
    }

    // Render Item Scatter (simplified - using Google Charts)
    var scatterHost=document.getElementById('analytics-item-scatter');
    if(!scatterHost){
      return;
    }
    if(!analyticsData.items||analyticsData.items.length===0){
      scatterHost.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No item data available</p>';
    }else if(googleChartsReady&&window.google&&google.visualization&&typeof google.visualization.ScatterChart==='function'){
      var scatterData=[['Difficulty (% Correct)','Discrimination','Question']];
      analyticsData.items.forEach(function(item){
        scatterData.push([item.correctPct,item.rbis,'Q'+item.qNum]);
      });

      var data=google.visualization.arrayToDataTable(scatterData);
      var options={
        title:'Item Difficulty vs Discrimination',
        hAxis:{title:'Difficulty (% Correct)',minValue:0,maxValue:100},
        vAxis:{title:'Discrimination (r_bis)',minValue:-0.5,maxValue:1.0},
        legend:'none',
        pointSize:5,
        backgroundColor:'transparent',
        chartArea:{width:'85%',height:'75%'}
      };

      var chart=new google.visualization.ScatterChart(scatterHost);
      chart.draw(data,options);
    }else{
      scatterHost.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">Preparing analytics visualsâ€¦</p>';
    }
  }

  // --- Items Tab ---
  function renderAnalyticsItems() {
    document.getElementById('analytics-items-loading').classList.add('hidden');
    document.getElementById('analytics-items-content').classList.remove('hidden');

    if (!analyticsData || !analyticsData.items) return;

    var items = analyticsData.items.slice();

    // Sort items
    items.sort(function(a, b) {
      var aVal = a[analyticsItemsSort.field];
      var bVal = b[analyticsItemsSort.field];
      if (typeof aVal === 'number' && typeof bVal === 'number') {
        return analyticsItemsSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
      }
      var aStr = String(aVal || '');
      var bStr = String(bVal || '');
      return analyticsItemsSort.direction === 'asc'
        ? aStr.localeCompare(bStr)
        : bStr.localeCompare(aStr);
    });

    var tbody = document.getElementById('analytics-items-tbody');
    tbody.innerHTML = '';

    items.forEach(function(item) {
      var row = document.createElement('tr');
      row.className = 'hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30 cursor-pointer';

      // Q#
      var qNumCell = document.createElement('td');
      qNumCell.className = 'py-3 px-4 font-semibold';
      qNumCell.textContent = item.qNum;
      row.appendChild(qNumCell);

      // Topic
      var topicCell = document.createElement('td');
      topicCell.className = 'py-3 px-4 text-xs';
      topicCell.textContent = item.topic || 'Untagged';
      row.appendChild(topicCell);

      // Correct%
      var correctCell = document.createElement('td');
      correctCell.className = 'py-3 px-4 font-semibold';
      var correctColor = item.correctPct >= 70 ? 'text-green-600 dark:text-green-400' :
                        item.correctPct >= 50 ? 'text-yellow-600 dark:text-yellow-400' :
                        'text-red-600 dark:text-red-400';
      correctCell.innerHTML = '<span class="' + correctColor + '">' + item.correctPct + '%</span>';
      row.appendChild(correctCell);

      // Discrimination
      var discCell = document.createElement('td');
      discCell.className = 'py-3 px-4 font-semibold';
      var discColor = item.rbis >= 0.3 ? 'text-green-600 dark:text-green-400' :
                     item.rbis >= 0.15 ? 'text-yellow-600 dark:text-yellow-400' :
                     'text-red-600 dark:text-red-400';
      discCell.innerHTML = '<span class="' + discColor + '">' + item.rbis.toFixed(2) + '</span>';
      row.appendChild(discCell);

      // Choices (inline bar)
      var choicesCell = document.createElement('td');
      choicesCell.className = 'py-3 px-4';
      choicesCell.innerHTML = renderChoiceBar(item);
      row.appendChild(choicesCell);

      // Time
      var timeCell = document.createElement('td');
      timeCell.className = 'py-3 px-4';
      timeCell.textContent = item.medianTimeSec + 's';
      row.appendChild(timeCell);

      // Flags
      var flagsCell = document.createElement('td');
      flagsCell.className = 'py-3 px-4';
      if (item.flags && item.flags.length > 0) {
        var flagsHtml = '';
        item.flags.forEach(function(flag) {
          var flagColor = 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300';
          if (flag === 'low-disc') flagColor = 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300';
          flagsHtml += '<span class="inline-block px-2 py-0.5 rounded text-xs font-semibold ' + flagColor + ' mr-1">' + escapeHtml(flag) + '</span>';
        });
        flagsCell.innerHTML = flagsHtml;
      }
      row.appendChild(flagsCell);

      tbody.appendChild(row);
    });
  }

  function renderChoiceBar(item) {
    var total = item.total || 1;
    var choices = ['A', 'B', 'C', 'D'];
    var colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
    var html = '<div class="flex items-center gap-1 text-xs">';

    choices.forEach(function(choice, idx) {
      var count = item.choiceCounts[choice] || 0;
      var pct = (count / total * 100).toFixed(0);
      var isCorrect = idx === item.correctIndex;
      var borderStyle = isCorrect ? 'border-2 border-brand-dark-gray dark:border-brand-white' : '';

      if (count > 0) {
        html += '<div class="flex items-center gap-0.5">';
        html += '<span class="font-semibold">' + choice + '</span>';
        html += '<div class="h-4 rounded ' + borderStyle + '" style="width: ' + (pct * 0.8) + 'px; background-color: ' + colors[idx] + '; opacity: 0.7;"></div>';
        html += '<span class="text-brand-dark-gray/60 dark:text-brand-white/60">' + pct + '%</span>';
        html += '</div>';
      }
    });

    html += '</div>';
    return html;
  }

  // --- Students Tab ---
  // --- Student Insights (2025 Enhancement) ---
  var currentStudentInsights = null;
  var filteredStudentInsights = [];
  var studentInsightsFilter = null;
  var studentInsightsSortBy = 'name';
  var studentInsightsSortAsc = true;

  function loadStudentInsights() {
    // Get current class filter
    var className = analyticsFilters && analyticsFilters.className ? analyticsFilters.className : 'all';
    var dateFrom = analyticsFilters && analyticsFilters.dateFrom ? analyticsFilters.dateFrom : null;
    var dateTo = analyticsFilters && analyticsFilters.dateTo ? analyticsFilters.dateTo : null;

    google.script.run
      .withSuccessHandler(function(data) {
        if (data && data.success) {
          currentStudentInsights = data;
          filteredStudentInsights = data.students || [];
          renderStudentInsights();
        }
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load student insights:', error);
      })
      .getStudentInsights(className, { dateFrom: dateFrom, dateTo: dateTo });
  }

  function renderStudentInsights() {
    if (!currentStudentInsights) return;

    var stats = currentStudentInsights.classStats;

    // Update insight counts
    document.getElementById('struggling-count').textContent = stats.strugglingCount || 0;
    document.getElementById('non-responder-count').textContent = stats.nonResponderCount || 0;
    document.getElementById('rule-violator-count').textContent = stats.ruleViolatorCount || 0;
    document.getElementById('high-performer-count').textContent = stats.highPerformerCount || 0;

    // Render student table
    renderStudentInsightsTable();
  }

  function renderStudentInsightsTable() {
    var tbody = document.getElementById('student-insights-table-body');
    if (!tbody) return;

    // Apply current filter
    var displayStudents = filteredStudentInsights;

    // Sort students
    displayStudents.sort(function(a, b) {
      var aVal, bVal;
      switch (studentInsightsSortBy) {
        case 'name':
          aVal = a.name || a.email;
          bVal = b.name || b.email;
          break;
        case 'accuracy':
          aVal = a.accuracy;
          bVal = b.accuracy;
          break;
        case 'participation':
          aVal = a.participationRate;
          bVal = b.participationRate;
          break;
        case 'violations':
          aVal = a.violations.length;
          bVal = b.violations.length;
          break;
        default:
          return 0;
      }

      if (aVal < bVal) return studentInsightsSortAsc ? -1 : 1;
      if (aVal > bVal) return studentInsightsSortAsc ? 1 : -1;
      return 0;
    });

    // Render rows
    var html = '';
    displayStudents.forEach(function(student) {
      var accuracyColor = student.accuracy >= 85 ? 'text-green-600 dark:text-green-400' :
                          student.accuracy >= 70 ? 'text-blue-600 dark:text-blue-400' :
                          student.accuracy >= 50 ? 'text-yellow-600 dark:text-yellow-400' :
                          'text-red-600 dark:text-red-400';

      var participationColor = student.participationRate >= 90 ? 'text-green-600 dark:text-green-400' :
                               student.participationRate >= 75 ? 'text-blue-600 dark:text-blue-400' :
                               student.participationRate >= 50 ? 'text-yellow-600 dark:text-yellow-400' :
                               'text-red-600 dark:text-red-400';

      var violationsColor = student.violations.length === 0 ? 'text-green-600 dark:text-green-400' :
                            student.violations.length === 1 ? 'text-yellow-600 dark:text-yellow-400' :
                            'text-red-600 dark:text-red-400';

      var flagsHtml = '';
      student.flags.forEach(function(flag) {
        var flagClass = '';
        var flagText = '';
        switch (flag) {
          case 'struggling':
            flagClass = 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300';
            flagText = 'Struggling';
            break;
          case 'non-responder':
            flagClass = 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300';
            flagText = 'Non-Responder';
            break;
          case 'rule-violator':
            flagClass = 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300';
            flagText = 'Rule Violator';
            break;
          case 'high-performer':
            flagClass = 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300';
            flagText = 'High Performer';
            break;
          case 'consistent':
            flagClass = 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300';
            flagText = 'Consistent';
            break;
        }
        flagsHtml += '<span class="' + flagClass + ' px-2 py-0.5 rounded text-xs font-semibold mr-1">' + flagText + '</span>';
      });

      html += '<tr class="border-t border-brand-light-gray dark:border-brand-dark-gray/40 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30 transition-colors">';
      html += '<td class="px-4 py-3 text-sm font-medium text-brand-dark-gray dark:text-brand-white">' + escapeHtml(formatStudentName(student)) + '</td>';
      html += '<td class="px-4 py-3 text-center"><span class="text-sm font-semibold ' + accuracyColor + '">' + Math.round(student.accuracy) + '%</span><br><span class="text-xs text-brand-dark-gray/50 dark:text-brand-white/50">' + student.correctAnswers + '/' + (student.correctAnswers + student.incorrectAnswers) + '</span></td>';
      html += '<td class="px-4 py-3 text-center"><span class="text-sm font-semibold ' + participationColor + '">' + Math.round(student.participationRate) + '%</span><br><span class="text-xs text-brand-dark-gray/50 dark:text-brand-white/50">' + student.questionsAnswered + '/' + student.totalQuestions + '</span></td>';
      html += '<td class="px-4 py-3 text-center text-sm font-semibold ' + violationsColor + '">' + student.violations.length + '</td>';
      html += '<td class="px-4 py-3 text-sm">' + flagsHtml + '</td>';
      html += '</tr>';
    });

    tbody.innerHTML = html || '<tr><td colspan="5" class="px-4 py-8 text-center text-brand-dark-gray/60 dark:text-brand-white/60">No students found</td></tr>';
  }

  function filterStudentsByFlag(flag) {
    if (!currentStudentInsights) return;

    studentInsightsFilter = flag;
    filteredStudentInsights = currentStudentInsights.students.filter(function(s) {
      return s.flags.includes(flag);
    });

    // Show filter badge and clear button
    var badge = document.getElementById('student-insights-filter-badge');
    var clearBtn = document.getElementById('clear-student-filter-btn');
    badge.textContent = flag.replace('-', ' ').toUpperCase();
    badge.classList.remove('hidden');
    clearBtn.classList.remove('hidden');

    renderStudentInsightsTable();
  }

  function clearStudentFilter() {
    if (!currentStudentInsights) return;

    studentInsightsFilter = null;
    filteredStudentInsights = currentStudentInsights.students || [];

    // Hide filter badge and clear button
    document.getElementById('student-insights-filter-badge').classList.add('hidden');
    document.getElementById('clear-student-filter-btn').classList.add('hidden');

    renderStudentInsightsTable();
  }

  function sortStudentsBy(column) {
    if (studentInsightsSortBy === column) {
      studentInsightsSortAsc = !studentInsightsSortAsc;
    } else {
      studentInsightsSortBy = column;
      studentInsightsSortAsc = true;
    }
    renderStudentInsightsTable();
  }

  // --- End Student Insights ---

  function renderAnalyticsStudents() {
    document.getElementById('analytics-students-loading').classList.add('hidden');
    document.getElementById('analytics-students-content').classList.remove('hidden');

    // Load student insights (2025)
    loadStudentInsights();

    if (!analyticsData || !analyticsData.students) return;

    var studentsArray = Object.values(analyticsData.students);

    // Setup student search
    var searchInput = document.getElementById('analytics-student-search');
    var suggestions = document.getElementById('analytics-student-suggestions');

    searchInput.oninput = function() {
      var query = searchInput.value.toLowerCase();
      if (query.length < 2) {
        suggestions.classList.add('hidden');
        return;
      }

      var matches = studentsArray.filter(function(s) {
        return s.name.toLowerCase().includes(query) || s.email.toLowerCase().includes(query);
      }).slice(0, 10);

      if (matches.length > 0) {
        suggestions.innerHTML = '';
        matches.forEach(function(student) {
          var div = document.createElement('div');
          div.className = 'px-4 py-2 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/50 cursor-pointer';
          div.textContent = formatStudentName(student);
          div.onclick = function() {
            selectStudent(student);
            suggestions.classList.add('hidden');
            searchInput.value = '';
          };
          suggestions.appendChild(div);
        });
        suggestions.classList.remove('hidden');
      } else {
        suggestions.classList.add('hidden');
      }
    };
  }

  function selectStudent(student) {
    analyticsSelectedStudent = student;
    document.getElementById('analytics-student-empty').classList.add('hidden');
    document.getElementById('analytics-student-detail').classList.remove('hidden');

    // Render student summary
    var summary = document.getElementById('analytics-student-summary');
    summary.innerHTML = '<div class="flex flex-wrap items-center justify-between gap-4">' +
      '<div><h3 class="text-xl font-bold text-brand-dark-gray dark:text-brand-white">' + escapeHtml(formatStudentName(student)) + '</h3>' +
      '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">' + escapeHtml(student.email) + '</p></div>' +
      '<div class="grid grid-cols-3 gap-4 text-center">' +
      '<div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">' + student.successLast10.toFixed(1) + '%</div>' +
      '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Success Rate</div></div>' +
      '<div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">' + student.participationPct.toFixed(0) + '%</div>' +
      '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Participation</div></div>' +
      '<div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">' + student.integrityCount + '</div>' +
      '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Integrity Events</div></div>' +
      '</div></div>';

    // Render sparkline (last 10 sessions)
    var sparkline = document.getElementById('analytics-student-sparkline');
    var sessions = student.sessions || [];
    if (sessions.length > 0) {
      var sparkHtml = '<div class="flex gap-2">';
      sessions.slice(0, 10).reverse().forEach(function(session) {
        var color = session.scorePct >= 70 ? 'bg-green-500' : session.scorePct >= 50 ? 'bg-yellow-500' : 'bg-red-500';
        sparkHtml += '<div class="flex-1 flex flex-col items-center gap-1" title="' + escapeHtml(session.sessionName) + ': ' + session.scorePct + '%">';
        sparkHtml += '<div class="w-full rounded ' + color + '" style="height: ' + (session.scorePct * 0.8) + 'px; min-height: 20px;"></div>';
        sparkHtml += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">' + session.scorePct.toFixed(0) + '%</div>';
        sparkHtml += '</div>';
      });
      sparkHtml += '</div>';
      sparkline.innerHTML = sparkHtml;
    } else {
      sparkline.innerHTML = '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No session data</p>';
    }

    // Render topic bands
    var topicsDiv = document.getElementById('analytics-student-topics');
    var topics = Object.keys(student.topicPerformance || {});
    if (topics.length > 0) {
      var topicsHtml = '<div class="space-y-2">';
      topics.forEach(function(topic) {
        var perf = student.topicPerformance[topic];
        var pct = perf.total > 0 ? (perf.correct / perf.total * 100).toFixed(0) : 0;
        var color = pct >= 70 ? 'bg-green-500' : pct >= 50 ? 'bg-yellow-500' : 'bg-red-500';
        topicsHtml += '<div class="flex items-center gap-2">';
        topicsHtml += '<div class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white min-w-[100px]">' + escapeHtml(topic) + '</div>';
        topicsHtml += '<div class="flex-1 bg-brand-light-gray dark:bg-brand-dark-gray/30 rounded-full h-5 overflow-hidden">';
        topicsHtml += '<div class="' + color + ' h-full flex items-center justify-end px-2 text-xs text-white font-semibold" style="width: ' + pct + '%">';
        if (pct > 15) topicsHtml += pct + '%';
        topicsHtml += '</div></div>';
        topicsHtml += '<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">' + perf.correct + '/' + perf.total + '</div>';
        topicsHtml += '</div>';
      });
      topicsHtml += '</div>';
      topicsDiv.innerHTML = topicsHtml;
    } else {
      topicsDiv.innerHTML = '<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No topic data</p>';
    }
  }

  // --- Analytics Event Listeners ---
  document.getElementById('analytics-apply-filters-btn').onclick = function() {
    var className = document.getElementById('analytics-class-filter').value;
    var dateFrom = document.getElementById('analytics-date-from').value;
    var dateTo = document.getElementById('analytics-date-to').value;
    loadAnalytics({ className: className, dateFrom: dateFrom, dateTo: dateTo });
  };

  document.getElementById('analytics-clear-filters-btn').onclick = function() {
    document.getElementById('analytics-class-filter').value = 'all';
    document.getElementById('analytics-date-from').value = '';
    document.getElementById('analytics-date-to').value = '';
    loadAnalytics({ className: 'all' });
  };

  document.getElementById('analytics-refresh-btn').onclick = function() {
    loadAnalytics(analyticsFilters);
  };

  // Date preset handlers
  document.querySelectorAll('.analytics-date-preset').forEach(function(btn) {
    btn.onclick = function() {
      var days = btn.getAttribute('data-days');
      var preset = btn.getAttribute('data-preset');
      var today = new Date();
      var dateFrom = '';
      var dateTo = today.toISOString().split('T')[0];

      if (days) {
        var pastDate = new Date();
        pastDate.setDate(pastDate.getDate() - parseInt(days));
        dateFrom = pastDate.toISOString().split('T')[0];
      } else if (preset === 'thisMonth') {
        var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        dateFrom = firstDay.toISOString().split('T')[0];
      } else if (preset === 'lastMonth') {
        var lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        var lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
        dateFrom = lastMonthStart.toISOString().split('T')[0];
        dateTo = lastMonthEnd.toISOString().split('T')[0];
      } else if (preset === 'all') {
        dateFrom = '';
        dateTo = '';
      }

      document.getElementById('analytics-date-from').value = dateFrom;
      document.getElementById('analytics-date-to').value = dateTo;

      var className = document.getElementById('analytics-class-filter').value;
      loadAnalytics({ className: className, dateFrom: dateFrom, dateTo: dateTo });
    };
  });

  // Export analytics data
  document.getElementById('analytics-export-btn').onclick = function() {
    if (!analyticsData) {
      alert('No data to export. Please load analytics first.');
      return;
    }

    var exportData = {
      exportDate: new Date().toISOString(),
      filters: analyticsFilters,
      kpis: analyticsData.kpis || [],
      sessions: analyticsData.sessions || [],
      items: analyticsData.items || [],
      students: Object.values(analyticsData.students || {}),
      topics: analyticsData.topics || []
    };

    // Convert to CSV format (sessions only for now)
    var csv = 'Session Name,Class,Date,Questions,Participants,Total Students,Mastery %,Participation %,Median Time (s),Integrity Rate\n';
    (exportData.sessions || []).forEach(function(session) {
      csv += '"' + (session.sessionName || '').replace(/"/g, '""') + '",';
      csv += '"' + (session.className || '').replace(/"/g, '""') + '",';
      csv += '"' + (session.date || '') + '",';
      csv += session.questionCount + ',';
      csv += session.participants + ',';
      csv += session.totalStudents + ',';
      csv += session.masteryPct + ',';
      csv += session.participationPct + ',';
      csv += session.medianTimeSec + ',';
      csv += session.integrityRate + '\n';
    });

    // Download CSV
    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement('a');
    var url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'veritas-analytics-' + new Date().toISOString().split('T')[0] + '.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // Tab switching
  document.querySelectorAll('.analytics-tab').forEach(function(tab) {
    tab.onclick = function() {
      var tabId = tab.id.replace('analytics-tab-', '');
      analyticsCurrentTab = tabId;

      // Update tab styles
      document.querySelectorAll('.analytics-tab').forEach(function(t) {
        t.classList.remove('bg-primary', 'text-brand-white');
        t.classList.add('text-brand-dark-gray/70', 'dark:text-brand-white/70', 'hover:bg-brand-light-gray/20', 'dark:hover:bg-brand-dark-gray/30');
      });
      tab.classList.add('bg-primary', 'text-brand-white');
      tab.classList.remove('text-brand-dark-gray/70', 'dark:text-brand-white/70', 'hover:bg-brand-light-gray/20', 'dark:hover:bg-brand-dark-gray/30');

      // Update content
      document.querySelectorAll('.analytics-tab-content').forEach(function(content) {
        content.classList.add('hidden');
      });
      document.getElementById('analytics-content-' + tabId).classList.remove('hidden');

      renderAnalyticsByTab();
    };
  });

  // Item table sorting
  document.querySelectorAll('#analytics-items-table th[data-sort]').forEach(function(th) {
    th.onclick = function() {
      var field = th.getAttribute('data-sort');
      if (analyticsItemsSort.field === field) {
        analyticsItemsSort.direction = analyticsItemsSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        analyticsItemsSort.field = field;
        analyticsItemsSort.direction = 'asc';
      }
      renderAnalyticsItems();
    };
  });

  // --- Poll Lifecycle Controls ---
  async function onStartPoll(){
    var pollId=pollSelect.value;
    if(!pollId){
      await veritasAlert('Please select a poll first.',{title:'Live poll'});
      return;
    }
    setButtonLoading(startPollBtn,true,'Starting...');
    clearLiveIntervals();
    isPaused=false;
    isLiveSession=true;
    if(PREVIEW_MODE){
      setButtonLoading(startPollBtn,false);
      await previewOnlyNotice('start a live poll');
      return;
    }
    google.script.run
      .withSuccessHandler(function(data){
        setButtonLoading(startPollBtn,false);
        updateLiveView(data);
      })
      .withFailureHandler(function(error){
        setButtonLoading(startPollBtn,false);
        handleError(error);
      })
      .startPoll(pollId);
  }

  function onResumePoll(){
    if(pollInterval)clearInterval(pollInterval);
    pauseTimerCountdown();
    stopVisualTimer();
    timerExpiredHandled=false;
    timerActive=false;
    timerRemainingSeconds=timerPresetSeconds;
    updateTimerDisplay();
    updateTimerStatus('Timer idle.','info');
    isPaused=false;
    isLiveSession=true;
    if(PREVIEW_MODE){
      previewOnlyNotice('resume a live poll');
      return;
    }
    google.script.run
      .withSuccessHandler(updateLiveView)
      .withFailureHandler(handleError)
      .resumePoll();
  }

  function onStopPoll(){
    pauseTimerCountdown();
    stopVisualTimer();
    timerActive=false;
    timerRemainingSeconds=timerPresetSeconds;
    updateTimerDisplay();
    updateTimerStatus('Timer idle.','info');
    if(PREVIEW_MODE){
      previewOnlyNotice('pause the live poll');
      return;
    }
    google.script.run
      .withSuccessHandler(function(data){
        isPaused=true;
        updateLiveView(data);
      })
      .withFailureHandler(handleError)
      .stopPoll();
  }

  function onEndQuestionAndShowAnswer(){
    pauseTimerCountdown();
    stopVisualTimer();
    timerActive=false;
    timerRemainingSeconds=timerPresetSeconds;
    updateTimerDisplay();
    updateTimerStatus('Timer idle.','info');
    var endShowBtn=document.getElementById('header-end-show-btn');
    if(endShowBtn){endShowBtn.disabled=true;}
    if(PREVIEW_MODE){
      if(endShowBtn){endShowBtn.disabled=false;}
      previewOnlyNotice('reveal answers');
      return;
    }
    google.script.run
      .withSuccessHandler(function(data){
        if(endShowBtn){endShowBtn.disabled=false;}
        isPaused=true;
        updateLiveView(data);
      })
      .withFailureHandler(function(error){
        if(endShowBtn){endShowBtn.disabled=false;}
        handleError(error);
      })
      .endQuestionAndRevealResults();
  }

  function onPreviousQuestion(){
    if(pollInterval)clearInterval(pollInterval);
    pauseTimerCountdown();
    stopVisualTimer();
    timerExpiredHandled=false;
    timerActive=false;
    timerRemainingSeconds=timerPresetSeconds;
    updateTimerDisplay();
    updateTimerStatus('Timer ready for previous question.','info');
    isPaused=false;
    isNavigating=true; // Set flag to prevent polling during navigation
    if(PREVIEW_MODE){
      isNavigating=false;
      previewOnlyNotice('navigate to a previous question');
      return;
    }
    google.script.run
      .withSuccessHandler(function(data){
        updateLiveView(data);
        // Clear navigation flag after a short delay to ensure state is fully synced
        setTimeout(function(){
          isNavigating=false;
        },500);
      })
      .withFailureHandler(function(error){
        isNavigating=false;
        handleError(error);
      })
      .previousQuestion();
  }

  function onNextQuestion(){
    if(pollInterval)clearInterval(pollInterval);
    pauseTimerCountdown();
    stopVisualTimer();
    timerExpiredHandled=false;
    timerActive=false;
    timerRemainingSeconds=timerPresetSeconds;
    updateTimerDisplay();
    updateTimerStatus('Timer ready for next question.','info');
    isPaused=false;
    violationsAlertDismissed=false; // Reset violations alert for new question
    isNavigating=true; // Set flag to prevent polling during navigation
    if(PREVIEW_MODE){
      isNavigating=false;
      previewOnlyNotice('advance to the next question');
      return;
    }
    google.script.run
      .withSuccessHandler(function(data){
        updateLiveView(data);
        // Clear navigation flag after a short delay to ensure state is fully synced
        setTimeout(function(){
          isNavigating=false;
        },500);
      })
      .withFailureHandler(function(error){
        isNavigating=false;
        handleError(error);
      })
      .nextQuestion();
  }

  async function onResetQuestion(){
    var pollId=CURRENT_POLL_DATA.pollId;
    var questionIndex=CURRENT_POLL_DATA.questionIndex;
    if(!pollId||typeof questionIndex==='undefined'){
      await veritasAlert('No active question to reset.',{title:'Reset question'});
      return;
    }
    var proceed=await veritasConfirm('Reset the current question for all students?',{
      title:'Reset question',
      confirmText:'Reset question',
      destructive:true
    });
    if(!proceed){
      return;
    }
    var clearResponses=await veritasConfirm('Select OK to reset and clear responses, or Cancel to reset while keeping submissions.',{
      title:'Responses',
      confirmText:'Reset & clear',
      cancelText:'Keep submissions',
      destructive:true
    });
    // Pause and reset timer
    pauseTimer();
    stopVisualTimer();
    timerExpiredHandled=false;
    timerActive=false;
    isRunning=false;
    timerRemainingSeconds=timerPresetSeconds;
    totalSeconds=timerPresetSeconds;
    toggleButtons(false);
    updateDisplay();
    updateTimerStatus('Timer idle.','info');

    if(PREVIEW_MODE){
      await previewOnlyNotice('reset the live question');
      return;
    }

    google.script.run
      .withSuccessHandler(function(data){
        isPaused=false;
        updateLiveView(data);
      })
      .withFailureHandler(handleError)
      .resetLiveQuestion(pollId,questionIndex,clearResponses);
  }

  function onRevealResults(){
    var revealBtn=document.getElementById('reveal-results-btn');
    if(revealBtn){revealBtn.disabled=true;}
    if(PREVIEW_MODE){
      if(revealBtn){revealBtn.disabled=false;}
      previewOnlyNotice('reveal results to students');
      return;
    }
    google.script.run
      .withSuccessHandler(function(data){
        if(revealBtn){revealBtn.disabled=false;}
        updateLiveView(data);
      })
      .withFailureHandler(function(error){
        if(revealBtn){revealBtn.disabled=false;}
        handleError(error);
      })
      .revealResultsToStudents();
  }

  function onHideResults(){
    var hideBtn=document.getElementById('hide-results-btn');
    if(hideBtn){hideBtn.disabled=true;}
    if(PREVIEW_MODE){
      if(hideBtn){hideBtn.disabled=false;}
      previewOnlyNotice('hide results from students');
      return;
    }
    google.script.run
      .withSuccessHandler(function(data){
        if(hideBtn){hideBtn.disabled=false;}
        updateLiveView(data);
      })
      .withFailureHandler(function(error){
        if(hideBtn){hideBtn.disabled=false;}
        handleError(error);
      })
      .hideResultsFromStudents();
  }

  async function onEndPoll(){
    var confirmed=await veritasConfirm('Are you sure you want to end this poll completely?',{
      title:'End poll',
      confirmText:'End poll',
      destructive:true
    });
    if(!confirmed)return;
    showDashboard();
    if(PREVIEW_MODE){
      previewOnlyNotice('end the live poll');
      return;
    }
    google.script.run
      .withSuccessHandler(function(data){
        if(data&&data.status!=='ENDED'){
          showDashboard();
        }
      })
      .withFailureHandler(handleError)
      .closePoll();
  }

  // --- Live View & Data Polling ---
  function updateLiveOverviewFromData(data){
    var totalResponses=(data&&typeof data.totalResponses==='number')?data.totalResponses:0;
    var totalStudents=(data&&typeof data.totalStudents==='number')?data.totalStudents:0;
    var responsesEl=document.getElementById('live-overview-responses');
    var progressEl=document.getElementById('live-overview-response-progress');
    var responseCaption=document.getElementById('live-overview-response-caption');
    var allRespondedBanner=document.getElementById('all-responded-banner');
    var bannerTitle=document.getElementById('all-responded-title');
    var bannerSubtitle=document.getElementById('all-responded-subtitle');
    var hudResponseCount=document.getElementById('hud-response-count');
    var hudResponseCaption=document.getElementById('hud-response-caption');
    var hudResponseTrend=document.getElementById('hud-response-trend');

    if(responsesEl){
      responsesEl.textContent=totalResponses+' / '+totalStudents;
    }

    var completionPct=totalStudents>0?Math.round((totalResponses/totalStudents)*100):0;
    if(progressEl){
      var safeWidth=Math.max(0,Math.min(100,completionPct));
      progressEl.style.width=safeWidth+'%';
    }
    if(responseCaption){
      responseCaption.textContent=totalStudents>0?completionPct+'% complete':'Awaiting roster data';
    }

    if(hudResponseCount){
      hudResponseCount.textContent=(totalStudents>0?totalResponses:'0')+' / '+(totalStudents||0);
    }
    if(hudResponseCaption){
      hudResponseCaption.textContent=totalStudents>0?completionPct+'% complete':'Awaiting roster data';
    }
    if(hudResponseTrend){
      hudResponseTrend.classList.remove('hud-trend-up','hud-trend-down','hud-trend-steady');
      var previousPct=sessionHudState.lastCompletionPct;
      if(previousPct===null||totalStudents===0){
        hudResponseTrend.textContent='â€¢ steady';
        hudResponseTrend.classList.add('hud-trend-steady');
      }else{
        var delta=completionPct-previousPct;
        if(delta>0){
          hudResponseTrend.textContent='â–² +'+delta+'%';
          hudResponseTrend.classList.add('hud-trend-up');
        }else if(delta<0){
          hudResponseTrend.textContent='â–¼ '+delta+'%';
          hudResponseTrend.classList.add('hud-trend-down');
        }else{
          hudResponseTrend.textContent='â€¢ steady';
          hudResponseTrend.classList.add('hud-trend-steady');
        }
      }
    }
    sessionHudState.lastCompletionPct=totalStudents>0?completionPct:null;

    // Update progress ring for responses
    updateProgressRing('hud-response-ring', completionPct);
    var hudResponsePercent=document.getElementById('hud-response-percent');
    if(hudResponsePercent){
      hudResponsePercent.textContent=completionPct+'%';
    }

    // Track sparkline data for responses
    addSparklineDataPoint('responses', completionPct);

    var allResponded=totalStudents>0&&totalResponses===totalStudents;
    if(allRespondedBanner){
      if(allResponded){
        allRespondedBanner.classList.remove('hidden');
        if(!sessionHudState.allRespondedCelebrated){
          triggerCelebration(allRespondedBanner, 'all-responded');
          // Track activity
          trackAllResponded();
          sessionHudState.allRespondedCelebrated=true;
        }
        if(bannerTitle){
          bannerTitle.textContent='âœ… Everyone Responded!';
        }
        if(bannerSubtitle){
          if(totalStudents===1){
            bannerSubtitle.textContent='The lone student has submitted their answer. Ready to reveal and advance.';
        }else{
          bannerSubtitle.textContent='All '+totalStudents+' students have submitted their answers. Ready to reveal and advance.';
        }
      }
      }else{
        allRespondedBanner.classList.add('hidden');
        allRespondedBanner.classList.remove('celebrate');
        sessionHudState.allRespondedCelebrated=false;
      }
    }

    var remainingSeconds=typeof totalSeconds==='number'?totalSeconds:(typeof timerRemainingSeconds==='number'?timerRemainingSeconds:0);
    if(typeof window.checkAllRespondedState==='function'){
      window.checkAllRespondedState(allResponded?remainingSeconds:0);
    }

    var rawResults=data&&data.results;
    var resultsArray;
    if(Array.isArray(rawResults)){
      resultsArray=rawResults;
    }else if(rawResults&&typeof rawResults==='object'){
      resultsArray=Object.keys(rawResults).map(function(answerText){
        var value=rawResults[answerText];
        if(value&&typeof value==='object'&&!Array.isArray(value)){
          var mapped={};
          Object.keys(value).forEach(function(key){
            mapped[key]=value[key];
          });
          mapped.answerText=answerText;
          mapped.count=typeof value.count==='number'?value.count:0;
          return mapped;
        }
        return {
          answerText:answerText,
          count:typeof value==='number'?value:0
        };
      });
    }else{
      resultsArray=[];
    }

    var correctAnswer=data&&data.correctAnswer;
    var countedResponses=0;
    var correctCount=0;

    resultsArray.forEach(function(result){
      if(!result)return;
      var count=typeof result.count==='number'?result.count:0;
      countedResponses+=count;
      var answerText=result.answerText||result.text||result.optionText||'';
      var isCorrect=result.isCorrect===true || (!!correctAnswer && answerText===correctAnswer);
      if(isCorrect){
        correctCount+=count;
      }
    });

    var accuracyEl=document.getElementById('live-overview-accuracy');
    var accuracyCaption=document.getElementById('live-overview-accuracy-caption');
    var hudAccuracyValue=document.getElementById('hud-accuracy-value');
    var hudAccuracyCaption=document.getElementById('hud-accuracy-caption');
    var hudAccuracyTrend=document.getElementById('hud-accuracy-trend');
    var accuracyPct=countedResponses>0?Math.round((correctCount/countedResponses)*100):0;
    if(accuracyEl){
      accuracyEl.textContent=accuracyPct+'%';
    }
    if(accuracyCaption){
      if(countedResponses===0){
        accuracyCaption.textContent='No responses yet';
      }else{
        accuracyCaption.textContent=correctCount+' of '+countedResponses+' correct';
      }
    }

    if(hudAccuracyValue){
      hudAccuracyValue.textContent=countedResponses>0?accuracyPct+'%':'--%';
    }

    // Update progress ring for accuracy
    if(countedResponses>0){
      updateProgressRing('hud-accuracy-ring', accuracyPct);
      var hudAccuracyPercent=document.getElementById('hud-accuracy-percent');
      if(hudAccuracyPercent){
        hudAccuracyPercent.textContent=accuracyPct+'%';
      }

      // Track sparkline data for accuracy
      addSparklineDataPoint('accuracy', accuracyPct);

      // Celebrate perfect accuracy
      if(accuracyPct === 100 && countedResponses >= 3) {
        var accuracyCard = document.getElementById('hud-accuracy-card');
        if(accuracyCard && !accuracyCard.classList.contains('celebrate')) {
          triggerCelebration(accuracyCard, 'perfect-accuracy');
        }
      }
    }

    if(hudAccuracyCaption){
      if(countedResponses===0){
        hudAccuracyCaption.textContent='Waiting for responses';
      }else{
        hudAccuracyCaption.textContent=correctCount+' of '+countedResponses+' correct';
      }
    }
    if(hudAccuracyTrend){
      hudAccuracyTrend.classList.remove('hud-trend-up','hud-trend-down','hud-trend-steady');
      if(countedResponses===0){
        hudAccuracyTrend.textContent='â€¢ steady';
        hudAccuracyTrend.classList.add('hud-trend-steady');
      }else{
        var previousAccuracy=sessionHudState.lastAccuracyPct;
        if(previousAccuracy===null){
          hudAccuracyTrend.textContent='â€¢ steady';
          hudAccuracyTrend.classList.add('hud-trend-steady');
        }else{
          var accuracyDelta=accuracyPct-previousAccuracy;
          if(accuracyDelta>0){
            hudAccuracyTrend.textContent='â–² +'+accuracyDelta+'%';
            hudAccuracyTrend.classList.add('hud-trend-up');
          }else if(accuracyDelta<0){
            hudAccuracyTrend.textContent='â–¼ '+accuracyDelta+'%';
            hudAccuracyTrend.classList.add('hud-trend-down');
          }else{
            hudAccuracyTrend.textContent='â€¢ steady';
            hudAccuracyTrend.classList.add('hud-trend-steady');
          }
        }
      }
    }
    sessionHudState.lastAccuracyPct=countedResponses>0?accuracyPct:null;
  }

  function updateLiveOverviewCounts(lockedCount,blockedCount,waitingCount){
    var lockoutsEl=document.getElementById('live-overview-lockouts');
    if(lockoutsEl){
      lockoutsEl.textContent=lockedCount||0;
    }

    var lockoutsCaption=document.getElementById('live-overview-lockouts-caption');
    var hudLockoutsValue=document.getElementById('hud-lockouts-value');
    var hudLockoutsCaption=document.getElementById('hud-lockouts-caption');
    var hudLockoutsCard=document.getElementById('hud-lockouts-card');
    var hudFocusBtn=document.getElementById('hud-focus-lockouts-btn');
    if(lockoutsCaption){
      var pendingTotal=(lockedCount||0)+(blockedCount||0);
      if(pendingTotal===0){
        lockoutsCaption.textContent='No approvals pending';
      }else{
        var parts=[];
        if(lockedCount){parts.push(lockedCount+' locked');}
        if(blockedCount){parts.push(blockedCount+' blocked');}
        lockoutsCaption.textContent=parts.join(' â€¢ ');
      }
    }

    var pendingTotalForHud=(lockedCount||0)+(blockedCount||0);
    if(hudLockoutsValue){
      hudLockoutsValue.textContent=pendingTotalForHud;
    }
    if(hudLockoutsCaption){
      if(pendingTotalForHud===0){
        hudLockoutsCaption.textContent='No approvals pending';
      }else{
        hudLockoutsCaption.textContent='Requires quick approval';
      }
    }
    if(hudFocusBtn){
      var isDisabled=pendingTotalForHud===0;
      hudFocusBtn.disabled=isDisabled;
      hudFocusBtn.setAttribute('aria-disabled',isDisabled?'true':'false');
    }
    if(hudLockoutsCard){
      if(pendingTotalForHud>0){
        hudLockoutsCard.classList.add('student-needs-attention');
      }else{
        hudLockoutsCard.classList.remove('student-needs-attention');
      }
    }
    sessionHudState.lastLockoutTotal=pendingTotalForHud;

    var focusBtn=document.getElementById('focus-lockouts-btn');
    if(focusBtn){
      focusBtn.disabled=(lockedCount||0)===0;
    }

    var waitingEl=document.getElementById('live-overview-waiting');
    if(waitingEl){
      waitingEl.textContent=waitingCount||0;
    }

    var waitingCaption=document.getElementById('live-overview-waiting-caption');
    if(waitingCaption){
      if(!waitingCount){
        waitingCaption.textContent='Everyone has responded';
      }else if(waitingCount===1){
        waitingCaption.textContent='1 student still working';
      }else{
        waitingCaption.textContent=waitingCount+' students still working';
      }
    }
  }

  function updateLiveView(data){
    mainLoader.style.display='none';
    setButtonLoading(startPollBtn,false);

    if(!data){return;}

    var status=data.status||'PRE_LIVE';
    var metadata=data.metadata||{};
    var isCollecting=typeof metadata.isCollecting==='boolean'?metadata.isCollecting:(status==='LIVE');
    var resultsVisibility=metadata.resultsVisibility||'HIDDEN';
    var isResultsRevealed=resultsVisibility==='REVEALED';
    var isPreLive=status==='PRE_LIVE';
    var isEnded=status==='ENDED';

    if(!isLiveSession && !isPreLive){
      return;
    }

    if(isPreLive||isEnded){
      showDashboard();
      return;
    }

    if(data.error){handleError(data.error);return;}

    var previousQuestionIndex=typeof CURRENT_POLL_DATA.questionIndex==='number'?CURRENT_POLL_DATA.questionIndex:null;
    isPaused=!isCollecting;

    CURRENT_POLL_DATA.pollId=data.pollId||pollSelect.value;
    CURRENT_POLL_DATA.questionIndex=data.questionIndex;
    CURRENT_POLL_DATA.correctAnswer=data.correctAnswer;
    CURRENT_POLL_DATA.totalQuestions=data.totalQuestions;
    CURRENT_POLL_DATA.timerSeconds=data.timerSeconds||null;
    CURRENT_POLL_DATA.options=data.options||[];
    CURRENT_POLL_DATA.metacognition=data.metacognition||null;

    var questionChanged=previousQuestionIndex===null||data.questionIndex!==previousQuestionIndex;

    // Show live view
    setMainSection('live');
    headerDefault.style.display='none';
    headerLive.style.display='flex';

    // Update header
    document.getElementById('header-poll-name').textContent=data.pollName;

    // Update question dots
    updateQuestionDots(data.questionIndex,data.totalQuestions);

    // Enable/disable navigation buttons
    var backBtn=document.getElementById('header-back-btn');
    var nextBtn=document.getElementById('header-next-btn');
    if(backBtn){
      backBtn.disabled=data.questionIndex<=0;
      if(data.questionIndex<=0){
        backBtn.style.opacity='0.5';
        backBtn.style.cursor='not-allowed';
      } else {
        backBtn.style.opacity='1';
        backBtn.style.cursor='pointer';
      }
    }
    if(nextBtn){
      var isLastQuestion=data.questionIndex>=data.totalQuestions-1;
      nextBtn.disabled=isLastQuestion;
      if(isLastQuestion){
        nextBtn.style.opacity='0.5';
        nextBtn.style.cursor='not-allowed';
      } else {
        nextBtn.style.opacity='1';
        nextBtn.style.cursor='pointer';
      }
    }

    // Show/hide end-show/start buttons based on state
    var isResultsRevealed = resultsVisibility === 'REVEALED';

    if(isResultsRevealed){
      // Results already revealed - hide both action buttons
      document.getElementById('header-start-btn').style.display='none';
      document.getElementById('header-end-show-btn').style.display='none';
    } else if(isPaused){
      // Paused (responses closed) but not revealed - show resume and reveal buttons
      document.getElementById('header-start-btn').style.display='flex';
      document.getElementById('header-end-show-btn').style.display='flex';
    } else {
      // Active (collecting responses) - show only reveal button (teacher can end early)
      document.getElementById('header-start-btn').style.display='none';
      document.getElementById('header-end-show-btn').style.display='flex';
    }

    if(questionChanged){
      // Reset timer to default or custom duration for the new question
      var defaultSeconds=data.timerSeconds?Math.min(600,Math.max(15,parseInt(data.timerSeconds,10))):90;
      timerPresetSeconds=defaultSeconds;
      timerRemainingSeconds=defaultSeconds;
      totalSeconds=defaultSeconds; // Update new timer variable
      timerExpiredHandled=false;
      timerActive=false;
      isRunning=false; // Update new timer variable

      // Stop any running timer
      if(visualTimerInterval){
        clearInterval(visualTimerInterval);
        visualTimerInterval=null;
      }

      // Update UI
      toggleButtons(false);
      updateDisplay();
      updateTimerStatus('Timer idle.','info');
    }

    if(data.metadata){
      if(data.metadata.reason==='TIMER_EXPIRED'){
        timerRemainingSeconds=0;
        totalSeconds=0; // Update new timer variable
        var previousState=timerActive;
        timerActive=true;
        updateDisplay();
        timerActive=previousState;
        timerExpiredHandled=true;
        updateTimerStatus('Time expired â€” poll paused.','danger');
      } else if(data.metadata.reason==='MANUAL_PAUSE'){
        updateTimerStatus('Poll paused.','info');
      } else if(data.metadata.reason==='RESPONSES_CLOSED'){
        updateTimerStatus('Responses closed. Ready to reveal.','info');
      } else if(data.metadata.reason==='RESULTS_REVEALED'){
        updateTimerStatus('Results shared with students.','success');
      } else if(data.metadata.reason==='RESULTS_HIDDEN'){
        updateTimerStatus('Results hidden from students.','info');
      } else {
        updateTimerStatus('Timer idle.','info');
      }
    }

    // DEBUG: Log what teacher received
    console.log('=== TEACHER RECEIVED DATA ===');
    console.log('questionImageURL:', data.questionImageURL);
    console.log('options:', data.options);
    if(data.options && data.options.length>0){
      data.options.forEach(function(opt,idx){
        console.log('  Option '+idx+':', 'text="'+opt.text+'", imageURL='+opt.imageURL);
      });
    }

    // Update question display
    document.getElementById('live-question-info').textContent='Q'+(data.questionIndex+1)+'/'+data.totalQuestions;
    document.getElementById('live-question-text').textContent=data.questionText;
    document.getElementById('live-question-text-compact').textContent=data.questionText;

    // Handle question image with cache-busting
    var questionImageContainer=document.getElementById('question-image-container');
    var questionImageEl=document.getElementById('live-question-image');
    if(data.questionImageURL){
      questionImageContainer.style.display='block';

      // Add cache-busting query parameter based on question index
      // This ensures the browser re-fetches when switching questions
      var imageUrl=data.questionImageURL;
      var cacheBuster='q='+data.questionIndex;
      var separator=imageUrl.includes('?')?'&':'?';
      questionImageEl.src=imageUrl+separator+cacheBuster;
      questionImageEl.style.display='block';

      // Also set referrerpolicy for cross-origin images
      questionImageEl.setAttribute('referrerpolicy','no-referrer');
    } else {
      questionImageContainer.style.display='none';
      questionImageEl.src='';
    }

    // Update response count
    document.getElementById('response-count').textContent=data.totalResponses+' / '+data.totalStudents+' answered';
    var responseCountHeader = document.getElementById('response-count-header');
    if (responseCountHeader) {
      responseCountHeader.textContent=data.totalResponses+' / '+data.totalStudents+' answered';
    }

    updateLiveOverviewFromData(data);

    // Update results bars
    renderResultsBars(data.results,data.correctAnswer,data.studentStatusList);
    renderLiveMetacognition(data.metacognition||null);

    var resultsStrip=document.getElementById('results-reveal-strip');
    if(resultsStrip){
      var hasQuestion=typeof data.questionIndex==='number'&&data.questionIndex>=0;
      // Only show the strip when results are revealed
      if(isCollecting||!hasQuestion||!isResultsRevealed){
        resultsStrip.classList.add('hidden');
      } else {
        resultsStrip.classList.remove('hidden');
        var hideBtn=document.getElementById('hide-results-btn');
        var stripNextBtn=document.getElementById('strip-next-btn');
        var stripStatus=document.getElementById('results-strip-status');
        if(hideBtn){
          hideBtn.disabled=!hasQuestion;
        }
        if(stripNextBtn){
          stripNextBtn.disabled=!hasQuestion;
        }
        if(stripStatus){
          var suffix=data.totalResponses===0?' No responses were recorded.':'';
          stripStatus.textContent='Students can now see the correct answer and results.'+suffix;
        }
      }
    }

    // Update student status
    currentStudentStatusData=data.studentStatusList;
    renderStudentStatus();

    if(pollInterval)clearInterval(pollInterval);
    if(!isPaused){
      // OPTIMIZATION: Use adaptive interval instead of hardcoded 2500ms
      pollInterval=setInterval(pollForResults,currentPollInterval);
    }
  }

  function updateQuestionDots(current,total){
    var dotsContainer=document.getElementById('question-dots');
    dotsContainer.innerHTML='';
    for(var i=0;i<total;i++){
      var dot=document.createElement('span');
      dot.className='h-2 w-2 rounded-full '+(i===current?'bg-primary':'bg-primary/50');
      dotsContainer.appendChild(dot);
    }
  }

  function renderResultsBars(results,correctAnswer,studentsList){
    var container=document.getElementById('results-bars');
    container.innerHTML='';

    var optionDefs=Array.isArray(CURRENT_POLL_DATA.options)?CURRENT_POLL_DATA.options.slice():[];
    var knownKeys={};
    optionDefs.forEach(function(option){
      knownKeys[(option&&option.text)||'']=true;
    });

    if(results){
      Object.keys(results).forEach(function(answerText){
        if(!knownKeys[answerText||'']){
          optionDefs.push({text:answerText||'',imageURL:''});
          knownKeys[answerText||'']=true;
        }
      });
    }

    if(optionDefs.length===0){
      optionDefs=(results&&Object.keys(results).length>0)?Object.keys(results).map(function(key){return {text:key,imageURL:''};}):[];
    }

    if(optionDefs.length===0){
      container.innerHTML='<p class="text-center text-gray-500 py-4">Waiting for responses...</p>';
      return;
    }

    var total=optionDefs.reduce(function(sum,opt){
      var key=(opt&&opt.text)||'';
      var value=(results&&typeof results[key]==='number')?results[key]:0;
      return sum+value;
    },0);

    var letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ';

    optionDefs.forEach(function(option,index){
      var answerText=(option&&option.text)||'';
      var count=(results&&typeof results[answerText]==='number')?results[answerText]:0;
      var percentage=total>0?Math.round((count/total)*100):0;
      var isCorrect=answerText===correctAnswer;
      var letter=letters[index]||String(index+1);
      var imageURL=option&&option.imageURL;

      var card=document.createElement('div');
      card.className='teacher-result-card'+(isCorrect?' is-correct':'');

      var safePercentage=Math.max(0,Math.min(100,percentage));
      var progressClass='teacher-result-progress'+(isCorrect?' is-correct':'');
      var barHtml='<div class="'+progressClass+'" style="width: '+safePercentage+'%;"></div>';
      barHtml+='<div class="teacher-result-content-row">';
      barHtml+='<div class="teacher-result-leading" aria-hidden="true"><span class="teacher-result-letter">'+letter+'</span></div>';
      barHtml+='<div class="teacher-result-body">';
      if(imageURL){
        barHtml+='<div class="teacher-result-image-wrap"><img src="'+escapeHtml(imageURL)+'" class="teacher-result-image" alt="Answer '+letter+' image" referrerpolicy="no-referrer"/></div>';
      }
      if(answerText){
        barHtml+='<p class="teacher-result-text">'+escapeHtml(answerText)+'</p>';
      } else if(!imageURL){
        barHtml+='<p class="teacher-result-text teacher-result-text--empty">(No content)</p>';
      }
      barHtml+='</div>';
      barHtml+='<div class="teacher-result-percentage">'+
        '<span>'+percentage+'%</span>'+
        '<span class="teacher-result-count">'+count+' votes</span>'+
      '</div>';
      barHtml+='</div>';

      var studentsWithAnswer=Array.isArray(studentsList)?studentsList.filter(function(s){return s.answer===answerText;}):[];
      if(studentsWithAnswer.length>0){
        barHtml+='<div class="teacher-result-students">';
        studentsWithAnswer.forEach(function(student){
          barHtml+='<span class="teacher-result-student">';
          barHtml+=escapeHtml(formatStudentName(student));
          var confidenceText=describeConfidence(student.confidence);
          if(confidenceText){
            var style=CONFIDENCE_LEVEL_STYLES[student.confidence]||{};
            var badgeClass=style.badgeClass||'bg-brand-light-gray/60 text-brand-dark-gray/70 dark:bg-brand-dark-gray/40 dark:text-brand-white/70 border border-brand-light-gray/40 dark:border-brand-dark-gray/50';
            barHtml+=' <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] font-semibold '+badgeClass+'">'+escapeHtml(confidenceText)+'</span>';
          }
          barHtml+='</span>';
        });
        barHtml+='</div>';
      }

      card.innerHTML=barHtml;
      container.appendChild(card);
    });
  }

  function renderLiveMetacognition(metacognition){
    console.log('=== RENDER LIVE METACOGNITION CALLED ===');
    console.log('metacognition:', metacognition);

    var card=document.getElementById('live-metacognition-card');
    if(!card){
      console.log('live-metacognition-card element not found');
      return;
    }

    if(!metacognition||!metacognition.enabled){
      console.log('Metacognition not enabled or data missing - hiding card');
      card.classList.add('hidden');
      card.innerHTML='';
      return;
    }

    console.log('Metacognition is enabled - rendering card');

    var html='<div class="flex flex-wrap items-center justify-between gap-3 mb-3">';
    html+='<div class="flex items-center gap-2">';
    html+='<span class="material-symbols-outlined text-purple-600 dark:text-purple-300">psychology</span>';
    html+='<h4 class="text-brand-dark-gray dark:text-brand-white font-semibold text-base">Confidence Pulse</h4>';
    html+='</div>';
    html+='<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">';
    if(metacognition.totalResponses>0){
      html+=escapeHtml(metacognition.totalResponses+' responses â€¢ '+metacognition.responseRate+'% of class');
    }else{
      html+='Waiting for students...';
    }
    html+='</div>';
    html+='</div>';

    if(!metacognition.totalResponses){
      html+='<p class="text-xs text-brand-dark-gray/70 dark:text-brand-white/70">Students will report their confidence level. Responses appear here instantly.</p>';
      card.innerHTML=html;
      card.classList.remove('hidden');
      return;
    }

    // Compact 4-quadrant display - single row
    var matrixDefs=[
      {key:'confidentCorrect',emoji:'ðŸ’¯',label:'Confident & Correct',bgClass:'bg-green-500/10',borderClass:'border-green-500/30',textClass:'text-green-700 dark:text-green-300'},
      {key:'confidentIncorrect',emoji:'âš ï¸',label:'Confident & Wrong',bgClass:'bg-red-500/10',borderClass:'border-red-500/30',textClass:'text-red-700 dark:text-red-300'},
      {key:'uncertainCorrect',emoji:'ðŸ¤”',label:'Unsure but Correct',bgClass:'bg-amber-500/10',borderClass:'border-amber-500/30',textClass:'text-amber-700 dark:text-amber-300'},
      {key:'uncertainIncorrect',emoji:'ðŸ¤·',label:'Unsure & Wrong',bgClass:'bg-blue-500/10',borderClass:'border-blue-500/30',textClass:'text-blue-700 dark:text-blue-300'}
    ];

    html+='<div class="grid grid-cols-2 gap-2 mb-3">';
    matrixDefs.forEach(function(def){
      var pct=metacognition.matrixPercentages&&typeof metacognition.matrixPercentages[def.key]==='number'?metacognition.matrixPercentages[def.key]:0;
      var count=metacognition.matrixCounts&&typeof metacognition.matrixCounts[def.key]==='number'?metacognition.matrixCounts[def.key]:0;
      html+='<div class="rounded-lg border '+def.borderClass+' '+def.bgClass+' p-2">';
      html+='<div class="flex items-center gap-1.5 mb-1">';
      html+='<span class="text-base">'+def.emoji+'</span>';
      html+='<span class="text-xs font-medium '+def.textClass+'">'+def.label+'</span>';
      html+='</div>';
      html+='<div class="flex items-baseline gap-1">';
      html+='<span class="text-xl font-bold '+def.textClass+'">'+pct+'%</span>';
      html+='<span class="text-[10px] '+def.textClass+' opacity-70">('+count+')</span>';
      html+='</div>';
      html+='</div>';
    });
    html+='</div>';

    // Show flagged students prominently but compact
    var flagged=Array.isArray(metacognition.flaggedStudents)?metacognition.flaggedStudents:[];
    if(flagged.length>0){
      html+='<div class="rounded-lg border border-red-500/40 bg-red-500/10 p-2">';
      html+='<div class="flex items-center gap-1.5 mb-1.5">';
      html+='<span class="material-symbols-outlined text-sm text-red-600 dark:text-red-300">report</span>';
      html+='<span class="text-xs font-semibold text-red-700 dark:text-red-200">âš ï¸ Urgent: '+flagged.length+' Confidently Incorrect</span>';
      html+='</div>';
      html+='<div class="flex flex-wrap gap-1.5">';
      flagged.forEach(function(student){
        var display=escapeHtml(student.name||student.email||'Student');
        html+='<span class="px-2 py-0.5 rounded bg-red-600/20 text-xs font-medium text-red-700 dark:text-red-200">'+display+'</span>';
      });
      html+='</div>';
      html+='</div>';
    }

    card.innerHTML=html;
    card.classList.remove('hidden');
  }

  // Global filters for student status panel
  var studentStatusFilter = 'all';
  var studentCorrectnessFilter = 'all';
  var violationsAlertDismissed = false;

  function updateViolationsAlert(flaggedStudents) {
    var alertPanel = document.getElementById('violations-alert-panel');
    var quickList = document.getElementById('violations-quick-list');
    var summary = document.getElementById('violations-summary');

    if (!flaggedStudents || flaggedStudents.length === 0 || violationsAlertDismissed) {
      alertPanel.classList.add('hidden');
      return;
    }

    alertPanel.classList.remove('hidden');

    var lockedCount = flaggedStudents.filter(function(student) {
      return student.status === 'LOCKED' || student.status === 'AWAITING_FULLSCREEN';
    }).length;
    var blockedCount = flaggedStudents.filter(function(student) {
      return student.status === 'BLOCKED';
    }).length;
    var total = flaggedStudents.length;

    var summaryParts = [];
    if (lockedCount) {
      summaryParts.push(lockedCount + ' locked');
    }
    if (blockedCount) {
      summaryParts.push(blockedCount + ' blocked');
    }

    var summaryLabel = summaryParts.join(' â€¢ ');
    if (summaryLabel) {
      summary.textContent = summaryLabel + (total > 1 ? ' students need attention' : ' student needs attention');
    } else {
      summary.textContent = total + (total > 1 ? ' students need attention' : ' student needs attention');
    }

    var html = '';
    flaggedStudents.forEach(function(student) {
      if (student.status === 'BLOCKED') {
        html += '<button class="quick-unblock-btn flex items-center gap-2 px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm font-semibold transition-colors" data-email="' + student.email + '">';
        html += '<span class="material-symbols-outlined text-base">lock_open</span>';
        html += '<span>Unblock ' + escapeHtml(formatStudentName(student)) + '</span>';
        html += '</button>';
      } else {
        html += '<button class="quick-approve-btn flex items-center gap-2 px-3 py-2 rounded-lg bg-white/20 hover:bg-white/30 text-white text-sm font-semibold transition-colors" data-email="' + student.email + '" data-poll-id="' + CURRENT_POLL_DATA.pollId + '" data-lock-version="' + (student.lockVersion || 0) + '">';
        html += '<span class="material-symbols-outlined text-base">lock_open</span>';
        html += '<span>Approve ' + escapeHtml(formatStudentName(student)) + '</span>';
        html += '</button>';
      }
    });
    quickList.innerHTML = html;

    quickList.querySelectorAll('.quick-approve-btn').forEach(function(btn) {
      btn.onclick = async function() {
        var email = this.dataset.email;
        var pollId = this.dataset.pollId;
        var lockVersion = parseInt(this.dataset.lockVersion, 10);
        await approveStudentUnlock(email, pollId, lockVersion, this);
      };
    });

    quickList.querySelectorAll('.quick-unblock-btn').forEach(function(btn) {
      btn.onclick = async function() {
        var email = this.dataset.email;
        await requestTeacherUnblock(email, this);
      };
    });
  }

  function updateLockoutBanner() {
    var banner = document.getElementById('lockout-alert-banner');
    var namesEl = document.getElementById('lockout-student-names');
    var actionsEl = document.getElementById('lockout-actions');

    if (!banner || !namesEl || !actionsEl) {
      return;
    }

    var lockoutStudents = Array.isArray(currentStudentStatusData)
      ? currentStudentStatusData.filter(function(student) {
          return student && (student.status === 'LOCKED' || student.status === 'AWAITING_FULLSCREEN');
        })
      : [];

    if (lockoutStudents.length === 0) {
      banner.classList.add('hidden');
      banner.setAttribute('aria-hidden','true');
      namesEl.textContent = '';
      actionsEl.innerHTML = '';
      return;
    }

    banner.classList.remove('hidden');
    banner.setAttribute('aria-hidden','false');

    var descriptions = lockoutStudents.map(function(student) {
      var description = formatStudentName(student);
      if (student.status === 'AWAITING_FULLSCREEN') {
        description += ' (awaiting fullscreen)';
      } else {
        description += ' (locked out)';
      }
      return description;
    });
    namesEl.textContent = descriptions.join(', ');

    actionsEl.innerHTML = '';
    lockoutStudents.forEach(function(student) {
      var button = createUnlockButton(student);
      var label = button.querySelector('span:last-child');
      if (label) {
        label.textContent = 'Approve ' + formatStudentName(student);
      }
      button.onclick = async function() {
        var email = this.dataset.email;
        var pollId = this.dataset.pollId;
        var lockVersion = parseInt(this.dataset.lockVersion, 10);
        if (isNaN(lockVersion)) {
          lockVersion = 0;
        }
        await approveStudentUnlock(email, pollId, lockVersion, this);
      };
      actionsEl.appendChild(button);
    });
  }

  /**
   * ENHANCED: Update exited students panel (2025)
   * More visible and functional than the violations alert
   */
  function updateExitedStudentsPanel(lockedStudents) {
    var panel = document.getElementById('exited-students-panel');
    var list = document.getElementById('exited-students-list-inline');
    var countSpan = document.getElementById('exited-students-count');

    if (!panel || !list || !countSpan) {
      console.warn('Exited students panel elements missing.');
      return;
    }

    // Filter for only LOCKED students (not AWAITING_FULLSCREEN)
    var exitedStudents = lockedStudents.filter(function(s) {
      return s.status === 'LOCKED';
    });

    if (exitedStudents.length === 0) {
      panel.classList.add('hidden');
      return;
    }

    // Show panel
    panel.classList.remove('hidden');
    countSpan.textContent = exitedStudents.length;

    // Render student cards
    var html = '';
    exitedStudents.forEach(function(student) {
      var lockTimeAgo = student.lockedAt ? getTimeAgo(new Date(student.lockedAt)) : 'recently';
      html += '<div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-700/50 rounded-lg p-3 flex items-center justify-between gap-3">';
      html += '  <div class="flex items-center gap-3 flex-1 min-w-0">';
      html += '    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-orange-200 dark:bg-orange-700/50 flex items-center justify-center">';
      html += '      <span class="material-symbols-outlined text-orange-700 dark:text-orange-300 text-xl">person_off</span>';
      html += '    </div>';
      html += '    <div class="flex-1 min-w-0">';
      html += '      <p class="font-semibold text-brand-dark-gray dark:text-brand-white text-sm truncate">' + escapeHtml(formatStudentName(student)) + '</p>';
      html += '      <p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Exited ' + lockTimeAgo + '</p>';
      if (student.lockReason) {
        html += '      <p class="text-xs text-orange-600 dark:text-orange-400 mt-1">' + escapeHtml(student.lockReason) + '</p>';
      }
      html += '    </div>';
      html += '  </div>';
      html += '  <button class="exited-approve-btn flex-shrink-0 px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs font-semibold transition-colors flex items-center gap-1.5" data-email="' + student.email + '" data-poll-id="' + CURRENT_POLL_DATA.pollId + '" data-lock-version="' + (student.lockVersion || 0) + '" title="Approve ' + escapeHtml(student.name) + ' to re-enter">';
      html += '    <span class="material-symbols-outlined text-sm">check_circle</span>';
      html += '    <span>Approve</span>';
      html += '  </button>';
      html += '</div>';
    });
    list.innerHTML = html;

    // Add event listeners
    list.querySelectorAll('.exited-approve-btn').forEach(function(btn) {
      btn.onclick = async function() {
        var email = this.dataset.email;
        var pollId = this.dataset.pollId;
        var lockVersion = parseInt(this.dataset.lockVersion, 10);
        await approveStudentUnlock(email, pollId, lockVersion, this);
      };
    });
  }

  /**
   * Approve all locked students at once
   */
  async function approveAllUnlocks() {
    if (!CURRENT_POLL_DATA || !CURRENT_POLL_DATA.pollId) return;

    var lockedStudents = currentStudentStatusData.filter(function(s) {
      return s.status === 'LOCKED';
    });

    if (lockedStudents.length === 0) {
      await veritasAlert('No students are currently locked.', { title: 'No students to approve' });
      return;
    }

    var confirmed = await veritasConfirm(
      'Approve re-entry for all ' + lockedStudents.length + ' locked student(s)?',
      {
        title: 'Approve All',
        confirmText: 'Approve All (' + lockedStudents.length + ')'
      }
    );

    if (!confirmed) return;

    // Disable the approve all button
    var approveAllBtn = document.getElementById('approve-all-unlocks-btn');
    if (approveAllBtn) {
      approveAllBtn.disabled = true;
      approveAllBtn.querySelector('span:last-child').textContent = 'Approving...';
    }

    // Approve each student
    var successCount = 0;
    var failCount = 0;

    for (var i = 0; i < lockedStudents.length; i++) {
      var student = lockedStudents[i];
      try {
        var response = await new Promise(function(resolve, reject) {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .teacherApproveUnlock(student.email, CURRENT_POLL_DATA.pollId, student.lockVersion || 0);
        });

        if (response.ok) {
          successCount++;
          // Update local status
          currentStudentStatusData = currentStudentStatusData.map(function(s) {
            if (s.email === student.email) {
              return {
                name: s.name,
                email: s.email,
                status: 'AWAITING_FULLSCREEN',
                lockVersion: response.lockVersion || student.lockVersion,
                lockReason: s.lockReason,
                lockedAt: s.lockedAt,
                answer: s.answer,
                isCorrect: s.isCorrect,
                timestamp: s.timestamp
              };
            }
            return s;
          });
        } else {
          failCount++;
        }
      } catch (error) {
        failCount++;
      }
    }

    // Re-render status
    renderStudentStatus();

    // Re-enable button
    if (approveAllBtn) {
      approveAllBtn.disabled = false;
      approveAllBtn.querySelector('span:last-child').textContent = 'Approve All';
    }

    // Show result
    if (successCount > 0) {
      await veritasAlert(
        'Approved ' + successCount + ' student(s) for re-entry.' +
        (failCount > 0 ? ' ' + failCount + ' failed.' : ' They must now re-enter fullscreen to continue.'),
        { title: 'Batch Approval Complete' }
      );
    } else {
      await veritasAlert('Failed to approve students. Please try again.', {
        title: 'Approval Failed',
        destructive: true
      });
    }
  }

  /**
   * Helper: Get time ago string
   */
  function getTimeAgo(date) {
    var seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return 'just now';
    if (seconds < 120) return '1 minute ago';
    if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
    if (seconds < 7200) return '1 hour ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
    return Math.floor(seconds / 86400) + ' days ago';
  }

  async function approveStudentUnlock(email, pollId, lockVersion, buttonElement) {
    if (!email || !pollId) return;

    var approved = await veritasConfirm('Approve unlock for ' + email + '?', {
      title: 'Approve unlock',
      confirmText: 'Approve'
    });
    if (!approved) {
      return;
    }

    if (buttonElement) {
      buttonElement.disabled = true;
      buttonElement.querySelector('span:last-child').textContent = 'Unlocking...';
    }

    if (PREVIEW_MODE) {
      await previewOnlyNotice('approve unlock requests');
      if (buttonElement) {
        buttonElement.disabled = false;
        buttonElement.querySelector('span:last-child').textContent = formatStudentName(email);
      }
      return;
    }

    google.script.run
      .withSuccessHandler(async function(response) {
        if (response.ok) {
          currentStudentStatusData = currentStudentStatusData.map(function(s) {
            if (s.email === email) {
              return {
                name: s.name,
                email: s.email,
                status: 'AWAITING_FULLSCREEN',
                lockVersion: response.lockVersion || lockVersion,
                lockReason: s.lockReason,
                lockedAt: s.lockedAt,
                answer: s.answer,
                isCorrect: s.isCorrect,
                timestamp: s.timestamp
              };
            }
            return s;
          });
          renderStudentStatus();
          await veritasAlert('Student approved for re-entry. They must re-enter fullscreen to continue.', {
            title: 'Unlock approved'
          });
        } else {
          await veritasAlert(response.message || 'Failed to unlock student. Please try again.', {
            title: 'Unlock failed',
            destructive: true
          });
          if (buttonElement) {
            buttonElement.disabled = false;
            buttonElement.querySelector('span:last-child').textContent = formatStudentName(email);
          }
        }
      })
      .withFailureHandler(async function(error) {
        await veritasAlert('Error: ' + (error.message || error), {
          title: 'Unlock failed',
          destructive: true
        });
        if (buttonElement) {
          buttonElement.disabled = false;
          buttonElement.querySelector('span:last-child').textContent = formatStudentName(email);
        }
      })
      .teacherApproveUnlock(email, pollId, lockVersion);
  }

  function createResetButton(student){
    var button=document.createElement('button');
    button.className='reset-btn flex-shrink-0 flex items-center justify-center gap-1 h-7 px-2.5 rounded-md bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-xs font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors';
    button.dataset.email=student.email||'';
    var icon=document.createElement('span');
    icon.className='material-symbols-outlined text-sm';
    icon.textContent='refresh';
    var label=document.createElement('span');
    label.textContent='Reset';
    button.appendChild(icon);
    button.appendChild(label);
    return button;
  }

  function createUnlockButton(student){
    var button=document.createElement('button');
    button.className='unlock-btn flex-shrink-0 flex items-center justify-center gap-1 h-8 px-3 rounded-md bg-red-600 text-white text-xs font-bold hover:bg-red-700 transition-colors shadow-sm';
    button.dataset.email=student.email||'';
    if(CURRENT_POLL_DATA&&CURRENT_POLL_DATA.pollId!==undefined){
      button.dataset.pollId=CURRENT_POLL_DATA.pollId;
    }
    button.dataset.lockVersion=student.lockVersion!=null?student.lockVersion:0;
    var icon=document.createElement('span');
    icon.className='material-symbols-outlined text-sm';
    icon.textContent='lock_open';
    var label=document.createElement('span');
    label.textContent='Approve';
    button.appendChild(icon);
    button.appendChild(label);
    return button;
  }

  function createBlockButton(student){
    var button=document.createElement('button');
    button.className='block-btn flex-shrink-0 flex items-center justify-center gap-1 h-8 px-3 rounded-md bg-amber-500/10 text-amber-700 dark:text-amber-300 dark:bg-amber-500/20 text-xs font-semibold hover:bg-amber-500/20 dark:hover:bg-amber-500/30 transition-colors';
    button.dataset.email=student.email||'';
    var icon=document.createElement('span');
    icon.className='material-symbols-outlined text-sm';
    icon.textContent='block';
    var label=document.createElement('span');
    label.textContent='Block';
    button.appendChild(icon);
    button.appendChild(label);
    return button;
  }

  function createUnblockButton(student){
    var button=document.createElement('button');
    button.className='unblock-btn flex-shrink-0 flex items-center justify-center gap-1 h-8 px-3 rounded-md bg-green-500/10 text-green-700 dark:text-green-300 dark:bg-green-500/20 text-xs font-semibold hover:bg-green-500/20 dark:hover:bg-green-500/30 transition-colors';
    button.dataset.email=student.email||'';
    var icon=document.createElement('span');
    icon.className='material-symbols-outlined text-sm';
    icon.textContent='lock_open';
    var label=document.createElement('span');
    label.textContent='Unblock';
    button.appendChild(icon);
    button.appendChild(label);
    return button;
  }

  function setButtonLoadingState(button,label){
    if(!button){
      return function(){};
    }
    var originalHtml=button.innerHTML;
    button.disabled=true;
    button.innerHTML='<span class="material-symbols-outlined text-sm animate-spin">progress_activity</span><span>'+label+'</span>';
    return function(){
      button.disabled=false;
      button.innerHTML=originalHtml;
    };
  }

  function runTeacherBlock(email,pollId,reason){
    return new Promise(function(resolve,reject){
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .teacherBlockStudent(email,pollId,reason||'');
    });
  }

  function runTeacherUnblock(email,pollId){
    return new Promise(function(resolve,reject){
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .teacherUnblockStudent(email,pollId);
    });
  }

  async function requestTeacherBlock(student,buttonElement){
    if(!student||!student.email)return;
    var pollId=CURRENT_POLL_DATA&&CURRENT_POLL_DATA.pollId;
    if(pollId===undefined){
      await veritasAlert('Start a poll before blocking students.',{title:'No active poll'});
      return;
    }

    var displayName=formatStudentName(student);
    var confirmed=await veritasConfirm('Temporarily block '+displayName+' from responding? This will be recorded for proctoring.',{
      title:'Block Student',
      confirmText:'Block',
      destructive:true
    });
    if(!confirmed)return;

    var restore=setButtonLoadingState(buttonElement,'Blocking...');
    try{
      await runTeacherBlock(student.email,pollId,'');
      pollForResults();
    }catch(error){
      restore();
      handleError(error);
    }
  }

  async function requestTeacherUnblock(email,buttonElement){
    if(!email)return;
    var pollId=CURRENT_POLL_DATA&&CURRENT_POLL_DATA.pollId;
    if(pollId===undefined){
      await veritasAlert('Start a poll before unblocking students.',{title:'No active poll'});
      return;
    }

    var student=currentStudentStatusData.find(function(s){return s.email===email;});
    var displayName=formatStudentName(student||email);
    var confirmed=await veritasConfirm('Unblock '+displayName+'?',{
      title:'Unblock Student',
      confirmText:'Unblock'
    });
    if(!confirmed)return;

    var restore=setButtonLoadingState(buttonElement,'Unblocking...');
    try{
      await runTeacherUnblock(email,pollId);
      pollForResults();
    }catch(error){
      restore();
      handleError(error);
    }
  }

  function buildStudentStatusTile(student){
    var tile=document.createElement('div');
    var wrapper=document.createElement('div');
    wrapper.className='flex items-center gap-3 min-w-0';
    tile.appendChild(wrapper);

    var icon=document.createElement('span');
    icon.className='material-symbols-outlined text-xl';
    wrapper.appendChild(icon);

    var textWrapper=document.createElement('div');
    textWrapper.className='flex flex-col min-w-0';
    wrapper.appendChild(textWrapper);

    var nameSpan=document.createElement('span');
    nameSpan.className='text-sm font-semibold truncate';
    nameSpan.textContent=formatStudentName(student);
    textWrapper.appendChild(nameSpan);

    var detailSpan=document.createElement('span');
    detailSpan.className='text-xs truncate';
    textWrapper.appendChild(detailSpan);

    var status=student.status||'Unknown';
    var actions=[];
    if(status==='Submitted'){
      var isCorrect=student.isCorrect===true;
      var isIncorrect=student.isCorrect===false;
      var iconName=isCorrect?'check_circle':(isIncorrect?'cancel':'task_alt');
      var baseColorClass=isCorrect?'bg-green-500/10 dark:bg-green-500/20':(isIncorrect?'bg-red-500/10 dark:bg-red-500/20':'bg-blue-500/10 dark:bg-blue-500/20');
      var iconClass=isCorrect?'text-green-600 dark:text-green-300':(isIncorrect?'text-red-600 dark:text-red-300':'text-blue-600 dark:text-blue-300');
      var textClass=isCorrect?'text-green-800 dark:text-green-200':(isIncorrect?'text-red-800 dark:text-red-200':'text-blue-800 dark:text-blue-200');
      var subTextClass=isCorrect?'text-green-700/80 dark:text-green-200/80':(isIncorrect?'text-red-700/80 dark:text-red-200/80':'text-blue-700/80 dark:text-blue-200/80');
      var statusLabel=isCorrect?'Correct':(isIncorrect?'Incorrect':'Submitted');
      var detailParts=[statusLabel];
      if(student.answer){
        detailParts.push(student.answer);
      }
      var confidenceText=describeConfidence(student.confidence);
      if(confidenceText){
        detailParts.push(confidenceText);
      }

      tile.className='flex items-center justify-between gap-3 p-3 rounded-lg '+baseColorClass+' transition-all duration-200';
      icon.className+=' '+iconClass;
      icon.textContent=iconName;
      nameSpan.className+=' '+textClass;
      detailSpan.className+=' '+subTextClass;
      detailSpan.textContent=detailParts.join(' â€¢ ');
      actions.push(createResetButton(student));
      actions.push(createBlockButton(student));
    }else if(status==='LOCKED'){
      tile.className='flex items-center justify-between p-3 rounded-lg bg-red-50 dark:bg-red-900/30 border-2 border-red-200 dark:border-red-700 gap-3 transition-all duration-200';
      icon.className+=' text-red-600 dark:text-red-300';
      icon.textContent='lock';
      nameSpan.className+=' text-red-800 dark:text-red-200';
      var lockedDuration='';
      if(student.lockedAt){
        try{
          var lockedMs=Date.now()-new Date(student.lockedAt).getTime();
          var lockedSec=Math.max(0,Math.floor(lockedMs/1000));
          lockedDuration=' â€¢ '+lockedSec+'s ago';
        }catch(e){
          lockedDuration='';
        }
      }
      detailSpan.className+=' text-red-600 dark:text-red-300';
      detailSpan.textContent='Locked v'+(student.lockVersion||0)+lockedDuration;
      actions.push(createUnlockButton(student));
    }else if(status==='AWAITING_FULLSCREEN'){
      tile.className='flex items-center justify-between p-3 rounded-lg bg-blue-500/10 dark:bg-blue-500/20 gap-3 transition-all duration-200';
      icon.className+=' text-blue-600 dark:text-blue-300';
      icon.textContent='hourglass_empty';
      nameSpan.className+=' text-blue-800 dark:text-blue-200';
      detailSpan.className+=' text-blue-600 dark:text-blue-300';
      detailSpan.textContent='Awaiting fullscreen confirmation';
      actions.push(createBlockButton(student));
    }else if(status==='Waiting...'){
      tile.className='flex items-center justify-between p-3 rounded-lg bg-gray-50 dark:bg-gray-900/30 transition-all duration-200';
      icon.className+=' text-gray-500 dark:text-gray-300';
      icon.textContent='pending';
      nameSpan.className+=' text-gray-600 dark:text-gray-300';
      detailSpan.className+=' text-gray-500 dark:text-gray-300';
      detailSpan.textContent='Waiting for response';
      actions.push(createBlockButton(student));
    }else if(status==='BLOCKED'){
      tile.className='flex items-center justify-between p-3 rounded-lg bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700/60 gap-3 transition-all duration-200';
      icon.className+=' text-amber-600 dark:text-amber-300';
      icon.textContent='block';
      nameSpan.className+=' text-amber-700 dark:text-amber-200';
      var blockedText='Blocked by teacher';
      if(student.blockedAt){
        try{
          var blockedAgo=getTimeAgo(new Date(student.blockedAt));
          blockedText+=' â€¢ '+blockedAgo;
        }catch(e){}
      }
      if(student.blockedNote){
        blockedText+=' â€¢ '+student.blockedNote;
      }
      detailSpan.className+=' text-amber-600 dark:text-amber-300';
      detailSpan.textContent=blockedText;
      actions.push(createUnblockButton(student));
    }else{
      tile.className='flex items-center justify-between p-3 rounded-lg bg-orange-500/10 dark:bg-orange-500/20 transition-all duration-200';
      icon.className+=' text-orange-600 dark:text-orange-300';
      icon.textContent='error';
      nameSpan.className+=' text-orange-700 dark:text-orange-200';
      detailSpan.className+=' text-orange-600 dark:text-orange-300';
    }

    if(actions.length>0){
      var actionsWrapper=document.createElement('div');
      actionsWrapper.className='flex items-center gap-2 flex-shrink-0';
      actions.forEach(function(actionEl){
        actionsWrapper.appendChild(actionEl);
      });
      tile.appendChild(actionsWrapper);
    }

    return tile;
  }

  function buildStudentStatusRow(student){
    var row=document.createElement('tr');
    row.className='border-b border-brand-light-gray/30 dark:border-brand-dark-gray/20 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/20';

    var nameCell=document.createElement('td');
    nameCell.className='px-3 py-2 text-sm font-semibold text-brand-dark-gray dark:text-brand-white truncate';
    nameCell.textContent=formatStudentName(student);
    row.appendChild(nameCell);

    var statusCell=document.createElement('td');
    statusCell.className='px-3 py-2 text-sm text-brand-dark-gray/80 dark:text-brand-white/80';
    statusCell.textContent=student.status||'Unknown';
    row.appendChild(statusCell);

    var answerCell=document.createElement('td');
    answerCell.className='px-3 py-2 text-sm text-brand-dark-gray/70 dark:text-brand-white/70 truncate';
    answerCell.textContent=student.answer||'';
    row.appendChild(answerCell);

    var confidenceCell=document.createElement('td');
    confidenceCell.className='px-3 py-2 text-sm text-brand-dark-gray/60 dark:text-brand-white/60 truncate';
    var confidenceText=describeConfidence(student.confidence);
    confidenceCell.textContent=confidenceText||'â€”';
    row.appendChild(confidenceCell);

    var correctCell=document.createElement('td');
    correctCell.className='px-3 py-2 text-sm text-brand-dark-gray/70 dark:text-brand-white/70 text-center';
    if(student.isCorrect===true){
      correctCell.textContent='âœ”';
    }else if(student.isCorrect===false){
      correctCell.textContent='âœ–';
    }else{
      correctCell.textContent='â€”';
    }
    row.appendChild(correctCell);

    var violations=(student.sessionViolations||0)+(student.sessionExits||0);
    var violationsCell=document.createElement('td');
    violationsCell.className='px-3 py-2 text-sm text-brand-dark-gray/70 dark:text-brand-white/70 text-center';
    violationsCell.textContent=violations>0?violations:'â€”';
    row.appendChild(violationsCell);

    var actionsCell=document.createElement('td');
    actionsCell.className='px-3 py-2 text-sm text-right space-x-2';
    var actionElements=[];
    if(student.status==='Submitted'){
      actionElements.push(createResetButton(student));
      actionElements.push(createBlockButton(student));
    }else if(student.status==='Waiting...'){
      actionElements.push(createBlockButton(student));
    }else if(student.status==='LOCKED'){
      actionElements.push(createUnlockButton(student));
    }else if(student.status==='AWAITING_FULLSCREEN'){
      actionElements.push(createBlockButton(student));
    }else if(student.status==='BLOCKED'){
      actionElements.push(createUnblockButton(student));
    }
    actionElements.forEach(function(el){actionsCell.appendChild(el);});
    row.appendChild(actionsCell);

    return row;
  }

  function renderStudentStatus(){
    var grid=document.getElementById('student-status-grid');
    var tbody=document.getElementById('student-status-tbody');
    var container=grid||tbody;
    if(!container)return;

    syncStatusFilterButtons();

    var students=Array.isArray(currentStudentStatusData)?currentStudentStatusData.slice():[];

    if(studentSearchQuery){
      var query=studentSearchQuery.toLowerCase();
      students=students.filter(function(student){
        var fields=[
          (student.displayName||student.name||'').toLowerCase(),
          (student.firstName||'').toLowerCase(),
          (student.lastName||'').toLowerCase(),
          (student.email||'').toLowerCase(),
          (student.status||'').toLowerCase(),
          (student.answer||'').toLowerCase(),
          (describeConfidence(student.confidence)||'').toLowerCase()
        ];
        return fields.some(function(value){return value&&value.indexOf(query)!==-1;});
      });
    }

    if(studentStatusFilter==='waiting'){
      students=students.filter(function(s){return (s.status||'').toLowerCase()==='waiting...';});
    }else if(studentStatusFilter==='submitted'){
      students=students.filter(function(s){return s.status==='Submitted';});
    }else if(studentStatusFilter==='locked'){
      students=students.filter(function(s){return s.status==='LOCKED'||s.status==='AWAITING_FULLSCREEN';});
    }else if(studentStatusFilter==='blocked'){
      students=students.filter(function(s){return s.status==='BLOCKED';});
    }

    if(studentCorrectnessFilter==='correct'){
      students=students.filter(function(s){return s.isCorrect===true;});
    }else if(studentCorrectnessFilter==='incorrect'){
      students=students.filter(function(s){return s.isCorrect===false;});
    }else if(studentCorrectnessFilter==='unanswered'){
      students=students.filter(function(s){return s.status!=='Submitted';});
    }

    if(!studentTableSort||!studentTableSort.column){
      studentTableSort={column:'lastName',direction:'asc'};
    }

    var dirMultiplier=studentTableSort.direction==='desc'?-1:1;

    function compareStrings(a,b){
      var aVal=(a||'').toString().toLowerCase();
      var bVal=(b||'').toString().toLowerCase();
      if(aVal<bVal)return -1;
      if(aVal>bVal)return 1;
      return 0;
    }

    function compareNumbers(a,b){
      return (a||0)-(b||0);
    }

    var statusOrder={
      'BLOCKED':0,
      'LOCKED':1,
      'AWAITING_FULLSCREEN':2,
      'Submitted':3,
      'Waiting...':4
    };

    function statusRank(status){
      return statusOrder[status]!==undefined?statusOrder[status]:5;
    }

    function correctnessRank(student){
      if(student.isCorrect===true)return 2;
      if(student.isCorrect===false)return 1;
      return 0;
    }

    students.sort(function(a,b){
      var result=0;
      switch(studentTableSort.column){
        case 'firstName':
          result=compareStrings(a.firstName||a.displayName||a.name, b.firstName||b.displayName||b.name);
          break;
        case 'lastName':
          result=compareStrings(a.lastName||'', b.lastName||'');
          if(result===0){
            result=compareStrings(a.firstName||'', b.firstName||'');
          }
          break;
        case 'status':
          result=compareNumbers(statusRank(a.status), statusRank(b.status));
          break;
        case 'correct':
          result=compareNumbers(correctnessRank(a), correctnessRank(b));
          break;
        case 'violations':
          result=compareNumbers((a.sessionViolations||0)+(a.sessionExits||0),(b.sessionViolations||0)+(b.sessionExits||0));
          break;
        case 'recent':
          result=compareNumbers(a.timestamp||0,b.timestamp||0);
          break;
        case 'email':
          result=compareStrings(a.email||'',b.email||'');
          break;
        default:
          result=compareStrings(a.displayName||a.name||'',b.displayName||b.name||'');
      }
      if(result===0){
        result=compareStrings(a.email||'',b.email||'');
      }
      return result*dirMultiplier;
    });

    var correctCount=0;
    var lockedCount=0;
    var waitingCount=0;
    var blockedCount=0;
    var flaggedStudents=[];
    var lockedStudents=[];

    currentStudentStatusData.forEach(function(student){
      if(student.status==='Submitted'&&student.isCorrect===true){
        correctCount++;
      }
      if(student.status==='LOCKED'||student.status==='AWAITING_FULLSCREEN'){
        lockedCount++;
        flaggedStudents.push(student);
        if(student.status==='LOCKED'){
          lockedStudents.push(student);
        }
      }else if(student.status==='BLOCKED'){
        blockedCount++;
        flaggedStudents.push(student);
      }
      if((student.status||'').toLowerCase()==='waiting...'){
        waitingCount++;
      }
    });

    var correctCountEl=document.getElementById('correct-count');
    if(correctCountEl)correctCountEl.textContent=correctCount;
    var lockedCountEl=document.getElementById('locked-count');
    if(lockedCountEl)lockedCountEl.textContent=lockedCount;
    var blockedCountEl=document.getElementById('blocked-count');
    if(blockedCountEl)blockedCountEl.textContent=blockedCount;
    var waitingCountEl=document.getElementById('waiting-count');
    if(waitingCountEl)waitingCountEl.textContent=waitingCount;

    updateLiveOverviewCounts(lockedCount,blockedCount,waitingCount);
    updateViolationsAlert(flaggedStudents);
    updateLockoutBanner();
    updateExitedStudentsPanel(lockedStudents);

    if(tbody)tbody.innerHTML='';
    if(grid)grid.innerHTML='';

    var fragment=document.createDocumentFragment();
    students.forEach(function(student){
      if(grid){
        fragment.appendChild(buildStudentStatusTile(student));
      }else if(tbody){
        fragment.appendChild(buildStudentStatusRow(student));
      }
    });

    container.appendChild(fragment);

    container.querySelectorAll('.unlock-btn').forEach(function(btn){
      btn.onclick=async function(){
        var email=this.dataset.email;
        var pollId=this.dataset.pollId;
        var lockVersion=parseInt(this.dataset.lockVersion,10);
        await approveStudentUnlock(email,pollId,lockVersion,this);
      };
    });

    container.querySelectorAll('.reset-btn').forEach(function(btn){
      btn.onclick=function(){
        var email=this.dataset.email;
        var pollId=CURRENT_POLL_DATA.pollId;
        var questionIndex=CURRENT_POLL_DATA.questionIndex;
        if(!email||pollId===undefined||questionIndex===undefined)return;
        var button=this;
        var originalHtml=button.innerHTML;
        button.disabled=true;
        var label=button.querySelector('span:last-child');
        if(label)label.textContent='Resetting...';
        google.script.run
          .withSuccessHandler(pollForResults)
          .withFailureHandler(function(error){
            handleError(error);
            button.disabled=false;
            button.innerHTML=originalHtml;
          })
          .resetStudentResponse(email,pollId,questionIndex);
      };
    });

    container.querySelectorAll('.block-btn').forEach(function(btn){
      btn.onclick=async function(){
        var email=this.dataset.email;
        var student=currentStudentStatusData.find(function(s){return s.email===email;});
        await requestTeacherBlock(student,this);
      };
    });

    container.querySelectorAll('.unblock-btn').forEach(function(btn){
      btn.onclick=async function(){
        var email=this.dataset.email;
        await requestTeacherUnblock(email,this);
      };
    });
  }

  function pollForResults(){
    if(isPaused||!isLiveSession||isNavigating)return;
    var pollId=CURRENT_POLL_DATA.pollId;
    var questionIndex=CURRENT_POLL_DATA.questionIndex;
    if(pollId===undefined||questionIndex===undefined)return;

    google.script.run
      .withSuccessHandler(function(data){
        // OPTIMIZATION: Reset failure count and interval on success
        pollFailureCount=0;
        if(currentPollInterval!==basePollInterval){
          currentPollInterval=basePollInterval;
          restartPollingWithNewInterval();
        }
        updateLiveView(data);
      })
      .withFailureHandler(function(e){
        console.warn('Poll refresh error:',e);
        // OPTIMIZATION: Implement backoff on failures
        pollFailureCount++;
        var newInterval=basePollInterval+Math.min(2000,pollFailureCount*500);
        newInterval=Math.min(maxPollInterval,Math.max(basePollInterval,newInterval));
        if(newInterval!==currentPollInterval){
          currentPollInterval=newInterval;
          console.log('Adjusting poll interval to '+currentPollInterval+'ms due to failures');
          restartPollingWithNewInterval();
        }
      })
      .getLivePollData(pollId,questionIndex);
  }

  function restartPollingWithNewInterval(){
    if(pollInterval){
      clearInterval(pollInterval);
      pollInterval=null;
    }
    if(!isPaused&&isLiveSession){
      pollInterval=setInterval(pollForResults,currentPollInterval);
    }
  }

  // --- Timer Controls ---
  // State variables
  var timerPresetSeconds = 90;        // Default timer duration (for compatibility)
  var timerRemainingSeconds = 90;     // Current countdown value (for compatibility)
  var timerExpiredHandled = false;    // Tracks if expiry event was processed
  var timerActive = false;            // Current running state
  var visualTimerInterval = null;     // setInterval reference for countdown

  // New timer implementation variables
  var totalSeconds = 90;              // Total seconds for new timer
  var isRunning = false;              // Is timer currently running

  // Sidebar toggle state
  var sidebarVisible = true;

  /**
   * Toggles the sidebar visibility in live view
   */
  function toggleSidebar() {
    var sidebar = document.getElementById('live-sidebar');
    var icon = document.getElementById('sidebar-toggle-icon');
    var label = document.getElementById('sidebar-toggle-label');
    var toggleBtn=document.getElementById('toggle-sidebar-btn');

    if (!sidebar || !icon || !label) return;

    sidebarVisible = !sidebarVisible;

    if (sidebarVisible) {
      sidebar.classList.remove('w-0', 'hidden');
      sidebar.classList.add('w-80');
      icon.textContent = 'chevron_right';
      label.textContent = 'Hide Sidebar';
    } else {
      sidebar.classList.remove('w-80');
      sidebar.classList.add('w-0', 'hidden');
      icon.textContent = 'chevron_left';
      label.textContent = 'Show Sidebar';
    }

    if(toggleBtn){
      toggleBtn.setAttribute('aria-expanded',sidebarVisible?'true':'false');
      toggleBtn.setAttribute('aria-label',sidebarVisible?'Hide student sidebar':'Show student sidebar');
    }
  }

  /**
   * Formats total seconds into MM:SS format
   * @param {number} seconds - The total seconds to format
   */
  function formatTime(seconds) {
    var safeSeconds = Math.max(0, Math.round(seconds || 0));
    var minutes = Math.floor(safeSeconds / 60);
    var remainingSeconds = safeSeconds % 60;

    // Use padStart equivalent to always show two digits
    var formattedMinutes = ('0' + minutes).slice(-2);
    var formattedSeconds = ('0' + remainingSeconds).slice(-2);

    return formattedMinutes + ':' + formattedSeconds;
  }

  // Legacy function for compatibility
  function formatSeconds(seconds){
    return formatTime(seconds);
  }

  function updateHudTimer(){
    var paceValue=document.getElementById('hud-pace-value');
    if(!paceValue)return;

    var paceCaption=document.getElementById('hud-pace-caption');
    var paceChip=document.getElementById('hud-pace-chip');
    var paceChipIcon=document.getElementById('hud-pace-chip-icon');
    var paceChipLabel=document.getElementById('hud-pace-chip-label');

    paceValue.textContent=formatTime(totalSeconds);

    var variant='ready';
    var caption='Timer ready';
    var icon='pause_circle';
    var label='Ready';

    if(totalSeconds<=0){
      variant='complete';
      caption='All time used';
      icon='task_alt';
      label='Complete';
    }else if(isRunning){
      if(totalSeconds<=15){
        variant='critical';
        caption='Wrap up now';
        icon='emergency';
        label='Critical';
      }else{
        variant='running';
        caption='Timer running';
        icon='play_arrow';
        label='Running';
      }
    }else if(totalSeconds<timerPresetSeconds){
      variant='paused';
      caption='Paused â€” extend or resume';
      icon='pause_circle';
      label='Paused';
    }

    if(paceCaption){
      paceCaption.textContent=caption;
    }
    if(paceChip){
      paceChip.setAttribute('data-variant',variant);
    }
    if(paceChipIcon){
      paceChipIcon.textContent=icon;
    }
    if(paceChipLabel){
      paceChipLabel.textContent=label;
    }
  }

  /**
   * Updates the timer display on the screen
   */
  function updateDisplay() {
    var timerDisplay = document.getElementById('timer-display');
    if (!timerDisplay) return;

    timerDisplay.value = formatTime(totalSeconds);
    document.title = formatTime(totalSeconds) + ' - Veritas Live Poll';

    // Update legacy variables for compatibility
    timerRemainingSeconds = totalSeconds;

    // ENHANCED: Visual feedback based on time remaining
    var timerMainContainer = document.getElementById('timer-main-container');
    var timerCompactContainer = document.getElementById('timer-compact-container');
    var timerDisplayCompact = document.getElementById('timer-display-compact');

    // Sync compact timer display
    if (timerDisplayCompact) {
      timerDisplayCompact.value = formatTime(totalSeconds);
    }

    // Apply color feedback classes
    if (timerMainContainer && timerCompactContainer) {
      // Remove all timer state classes
      timerMainContainer.classList.remove('timer-warning', 'timer-critical');
      timerCompactContainer.classList.remove('timer-warning', 'timer-critical');

      if (isRunning) {
        // Critical: less than 15 seconds (red, pulsing)
        if (totalSeconds > 0 && totalSeconds <= 15) {
          timerMainContainer.classList.add('timer-critical');
          timerCompactContainer.classList.add('timer-critical');
        }
        // Warning: less than 30 seconds (yellow)
        else if (totalSeconds > 15 && totalSeconds <= 30) {
          timerMainContainer.classList.add('timer-warning');
          timerCompactContainer.classList.add('timer-warning');
        }
      }
    }

    updateHudTimer();
  }

  /**
   * Toggles the UI state between running and paused
   */
  function toggleButtons(running) {
    isRunning = running;
    timerActive = running; // Update legacy variable

    var startBtn = document.getElementById('start-btn');
    var pauseBtn = document.getElementById('pause-btn');
    var add10sBtn = document.getElementById('add-10s-btn');
    var subtract10sBtn = document.getElementById('subtract-10s-btn');
    var timerDisplay = document.getElementById('timer-display');

    // Toggle Start/Pause buttons
    if (startBtn) startBtn.classList.toggle('hidden', running);
    if (pauseBtn) pauseBtn.classList.toggle('hidden', !running);

    // Disable editing buttons AND the input field while timer is running
    if (add10sBtn) add10sBtn.disabled = running;
    if (subtract10sBtn) subtract10sBtn.disabled = running;
    if (timerDisplay) timerDisplay.disabled = running;

    updateHudTimer();
  }

  /**
   * Starts the countdown
   */
  function startTimer() {
    if (isRunning || totalSeconds <= 0) return; // Don't start if already running or at 0

    toggleButtons(true);
    updateTimerStatus('Timer runningâ€¦', 'info');

    visualTimerInterval = setInterval(function() {
      totalSeconds--;
      updateDisplay();

      if (totalSeconds <= 0) {
        finishTimer();
      }
    }, 1000);
  }

  /**
   * Pauses the countdown
   */
  function pauseTimer() {
    if (!isRunning) return;

    clearInterval(visualTimerInterval);
    visualTimerInterval = null;
    toggleButtons(false);
    updateTimerStatus('Timer paused at ' + formatTime(totalSeconds) + '.', 'info');
  }

  /**
   * Resets the timer to the default value
   */
  function resetTimer() {
    // Clear any running interval
    if (visualTimerInterval) {
      clearInterval(visualTimerInterval);
      visualTimerInterval = null;
    }

    totalSeconds = timerPresetSeconds;
    timerRemainingSeconds = totalSeconds;
    timerExpiredHandled = false;
    updateDisplay();
    toggleButtons(false);

    var timerDisplay = document.getElementById('timer-display');
    if (timerDisplay) {
      timerDisplay.classList.remove('timer-finished'); // Remove flash effect if present
    }

    updateTimerStatus('Timer reset to ' + formatTime(timerPresetSeconds) + '.', 'info');
    document.title = 'Veritas Live Poll';
  }

  /**
   * Called when the timer reaches 0
   */
  function finishTimer() {
    clearInterval(visualTimerInterval);
    visualTimerInterval = null;
    toggleButtons(false);

    var timerDisplay = document.getElementById('timer-display');

    // Add flash animation
    if (timerDisplay) {
      timerDisplay.classList.add('timer-finished');

      // Remove class after animation finishes (1s)
      setTimeout(function() {
        timerDisplay.classList.remove('timer-finished');
      }, 1000);
    }

    // Handle timer expiry - pause the poll
    if (!timerExpiredHandled) {
      timerExpiredHandled = true;
      timerRemainingSeconds = 0;
      updateTimerStatus('Time expired â€” poll paused.', 'danger');

      if (PREVIEW_MODE) {
        previewOnlyNotice('auto-pause the poll when the timer expires');
      } else {
        google.script.run
          .withSuccessHandler(function(data) {
            isPaused = true;
            updateLiveView(data);
          })
          .withFailureHandler(handleError)
          .pausePollForTimerExpiry();
      }
    }
  }

  /**
   * Adds or subtracts time from the countdown
   * @param {number} secondsToAdd - The number of seconds to add (can be negative)
   */
  function editTime(secondsToAdd) {
    if (isRunning) return; // Don't edit while running

    totalSeconds += secondsToAdd;

    if (totalSeconds < 0) {
      totalSeconds = 0; // Don't allow time to go below zero
    }

    // Update legacy variables
    timerRemainingSeconds = totalSeconds;
    timerPresetSeconds = totalSeconds;

    updateDisplay();
  }

  /**
   * Parses the text from the input field and updates totalSeconds
   */
  function parseInputToTotalSeconds() {
    if (isRunning) return;

    var timerDisplay = document.getElementById('timer-display');
    if (!timerDisplay) return;

    var text = timerDisplay.value;
    var minutes = 0;
    var seconds = 0;

    if (text.includes(':')) {
      // Handle "MM:SS" format
      var parts = text.split(':');
      minutes = parseInt(parts[0], 10) || 0;
      seconds = parseInt(parts[1], 10) || 0;
      totalSeconds = (minutes * 60) + seconds;
    } else if (text.trim() !== '') {
      // Handle raw seconds format (e.g., "90")
      var parsedSeconds = parseInt(text, 10) || 0;
      totalSeconds = parsedSeconds;
    }

    // Update legacy variables
    timerRemainingSeconds = totalSeconds;
    timerPresetSeconds = totalSeconds;
    updateHudTimer();
  }

  function updateTimerStatus(message, tone){
    var statusEl=document.getElementById('timer-status-message');
    if(!statusEl)return;
    statusEl.textContent=message;
    if(tone==='danger'){
      statusEl.className='text-xs text-red-600 dark:text-red-400 text-center font-medium';
    } else if(tone==='success'){
      statusEl.className='text-xs text-green-600 dark:text-green-400 text-center font-medium';
    } else {
      statusEl.className='text-xs text-brand-dark-gray/60 dark:text-brand-white/60 text-center';
    }
  }

  // Legacy functions for compatibility
  function startTimerCountdown(){
    startTimer();
  }

  function pauseTimerCountdown(){
    pauseTimer();
  }

  function resetTimerCountdown(){
    resetTimer();
  }

  function stopVisualTimer(){
    clearInterval(visualTimerInterval);
    visualTimerInterval=null;
  }

  function updateTimerInputs(){
    updateDisplay();
  }

  function updateTimerDisplay(){
    // Sync totalSeconds from timerRemainingSeconds for legacy code compatibility
    // Legacy code may set timerRemainingSeconds and expect the display to update
    if (timerRemainingSeconds !== totalSeconds) {
      totalSeconds = timerRemainingSeconds;
    }
    updateDisplay();
  }

  function adjustTimerPreset(delta){
    editTime(delta);
  }

  // --- Student Link Controls ---
  async function onSendLink(){
    var btn=sendLinkBtn;
    if(!btn){
      console.warn('Missing send link button');
      return;
    }
    var className=btn&&btn.dataset.className;
    if(!className){
      await veritasAlert('Please select a poll first.',{title:'Send poll links'});
      return;
    }
    var confirmed=await veritasConfirm('This will email a new, unique poll link to all students in '+className+'. Are you sure?',{
      title:'Send poll links',
      confirmText:'Send links'
    });
    if(!confirmed)return;

    var restoreViewLinks=viewLinksBtn && !viewLinksBtn.disabled;
    if(viewLinksBtn){
      setButtonLoading(viewLinksBtn,false);
      viewLinksBtn.disabled=true;
      viewLinksBtn.setAttribute('aria-disabled','true');
    }

    setButtonLoading(btn,true,'Sending...');

    if(PREVIEW_MODE){
      await previewOnlyNotice('email poll links');
      setButtonLoading(btn,false);
      if(viewLinksBtn){
        if(restoreViewLinks){
          viewLinksBtn.disabled=false;
          viewLinksBtn.removeAttribute('aria-disabled');
        }
      }
      return;
    }

    google.script.run
      .withSuccessHandler(async function(response){
        await veritasAlert('âœ… Successfully sent '+response.count+' poll links.',{title:'Send poll links'});
        setButtonLoading(btn,false);
        if(viewLinksBtn){
          if(restoreViewLinks){
            viewLinksBtn.disabled=false;
            viewLinksBtn.removeAttribute('aria-disabled');
          }
        }
      })
      .withFailureHandler(function(err){
        handleError(err);
        setButtonLoading(btn,false);
        if(viewLinksBtn){
          if(restoreViewLinks){
            viewLinksBtn.disabled=false;
            viewLinksBtn.removeAttribute('aria-disabled');
          }
        }
      })
      .sendPollLinkToClass(className);
  }

  async function onViewLinks(){
    var btn=viewLinksBtn;
    if(!btn){
      console.warn('Missing view links button');
      return;
    }
    var className=btn&&btn.dataset.className;
    if(!className){
      await veritasAlert('Please select a poll first.',{title:'View links'});
      return;
    }
    setButtonLoading(btn,true,'Loading...');

    if(PREVIEW_MODE){
      var container=document.getElementById('links-container');
      var roster=(PREVIEW_PAYLOAD&&PREVIEW_PAYLOAD.rosters&&PREVIEW_PAYLOAD.rosters[className])||[];
      var html='<div class="overflow-x-auto"><table class="w-full border-collapse">';
      html+='<thead><tr class="bg-brand-light-gray dark:bg-brand-dark-gray/50 border-b-2 border-brand-light-gray dark:border-brand-dark-gray/40">';
      html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Student Name</th>';
      html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Email</th>';
      html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Link</th>';
      html+='<th class="px-4 py-3 text-center text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Actions</th>';
      html+='</tr></thead><tbody>';
      roster.forEach(function(student){
        html+='<tr class="border-b border-brand-light-gray/50 dark:border-brand-dark-gray/20">';
        html+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+escapeHtml(student.name||'Student')+'</td>';
        html+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+escapeHtml(student.email||'student@example.com')+'</td>';
        html+='<td class="px-4 py-3 text-xs text-brand-dark-gray/70 dark:text-brand-white/70 italic">Preview links unavailable</td>';
        html+='<td class="px-4 py-3 text-center text-xs text-brand-dark-gray/60 dark:text-brand-white/60">â€”</td>';
        html+='</tr>';
      });
      if(roster.length===0){
        html+='<tr><td colspan="4" class="px-4 py-6 text-center text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No roster data available in preview.</td></tr>';
      }
      html+='</tbody></table></div>';
      container.innerHTML=html;
      linksModal.style.display='flex';
      setButtonLoading(btn,false);
      return;
    }

    google.script.run
      .withSuccessHandler(function(response){
        if(!response.success)return handleError(new Error('Could not load links'));

        var container=document.getElementById('links-container');
        var html='<div class="overflow-x-auto"><table class="w-full border-collapse">';
        html+='<thead><tr class="bg-brand-light-gray dark:bg-brand-dark-gray/50 border-b-2 border-brand-light-gray dark:border-brand-dark-gray/40">';
        html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Student Name</th>';
        html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Email</th>';
        html+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Link</th>';
        html+='<th class="px-4 py-3 text-center text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Actions</th>';
        html+='</tr></thead><tbody>';

        response.links.forEach(function(link){
          var displayUrl=link.hasActiveLink?(link.url||link.fullUrl):null;
          var copyUrl=link.fullUrl||link.url||'';
          html+='<tr class="border-b border-brand-light-gray/50 dark:border-brand-dark-gray/20 hover:bg-brand-light-gray/30 dark:hover:bg-brand-dark-gray/10">';
          html+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+escapeHtml(link.name)+'</td>';
          html+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+escapeHtml(link.email)+'</td>';
          html+='<td class="px-4 py-3 text-xs font-mono text-brand-dark-gray/70 dark:text-brand-white/70 max-w-[200px] truncate" title="'+(displayUrl?escapeHtml(displayUrl):'No active link')+'">'+(displayUrl?escapeHtml(displayUrl):'<i class="text-gray-400">No active link</i>')+'</td>';
          html+='<td class="px-4 py-3 text-center">';
          if(link.hasActiveLink){
            html+='<button class="copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors" data-url="'+escapeHtml(copyUrl)+'">Copy</button>';
          }
          html+='</td></tr>';
        });

        html+='</tbody></table></div>';
        container.innerHTML=html;

        container.querySelectorAll('.copy-link-btn').forEach(function(btn){
          btn.onclick=async function(){
            var url=this.dataset.url;
            try{
              if(navigator.clipboard&&typeof navigator.clipboard.writeText==='function'){
                await navigator.clipboard.writeText(url);
              }else{
                await veritasAlert('Automatic copy is not supported in this browser. Please copy the link manually.',{title:'Copy link'});
                return;
              }

              btn.textContent='âœ“ Copied!';
              btn.className='copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-green-600 text-brand-white';
              setTimeout(function(){
                btn.textContent='Copy';
                btn.className='copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors';
              }, 2000);
            }catch(err){
              await veritasAlert('Could not copy link. Please copy it manually.',{title:'Copy link',destructive:true});
            }
          };
        });

        linksModal.style.display='flex';
        setButtonLoading(btn,false);
      })
      .withFailureHandler(function(err){
        handleError(err);
        setButtonLoading(btn,false);
      })
      .getStudentLinksForClass(className);
  }

  function closeLinksModal(){
    linksModal.style.display='none';
  }

  // --- Poll Preview Modal Functions ---
  var previewModal=document.getElementById('poll-preview-modal');
  var previewPollName=document.getElementById('preview-poll-name');
  var previewPollMeta=document.getElementById('preview-poll-meta');
  var previewQuestionsNav=document.getElementById('preview-questions-nav');
  var previewQuestionDisplay=document.getElementById('preview-question-display');
  var previewQuestionCounter=document.getElementById('preview-question-counter');
  var currentPreviewPoll=null;
  var currentPreviewQuestionIndex=0;
  var isPreviewReorderMode=false;
  var originalQuestionOrder=null;

  function openPollPreview(pollId){
    var poll=ALL_POLLS.find(function(p){return p.pollId===pollId;});
    if(!poll||!poll.questions||poll.questions.length===0){
      veritasAlert('This poll has no questions.',{title:'Cannot preview',destructive:true});
      return;
    }

    currentPreviewPoll=poll;
    currentPreviewQuestionIndex=0;
    isPreviewReorderMode=false;
    originalQuestionOrder=null;

    previewPollName.textContent=poll.pollName||'Untitled Poll';
    var questionsCount=poll.questions.length;
    var classText=poll.className||'No class';
    previewPollMeta.textContent=classText+' â€¢ '+questionsCount+' Question'+(questionsCount!==1?'s':'');

    renderPreviewNav();
    renderPreviewQuestion();
    previewModal.style.display='flex';
  }

  function closePollPreview(){
    previewModal.style.display='none';
    currentPreviewPoll=null;
    currentPreviewQuestionIndex=0;
    isPreviewReorderMode=false;
    originalQuestionOrder=null;
  }

  function renderPreviewNav(){
    if(!currentPreviewPoll||!currentPreviewPoll.questions)return;

    previewQuestionsNav.innerHTML='';
    currentPreviewPoll.questions.forEach(function(q,index){
      var div=document.createElement('div');
      div.className='preview-nav-item cursor-pointer rounded-lg p-3 transition-colors '+(index===currentPreviewQuestionIndex?'bg-primary/20 dark:bg-primary/30 border-l-4 border-primary':'bg-brand-white dark:bg-brand-dark-gray/30 hover:bg-brand-light-gray/40 dark:hover:bg-brand-dark-gray/40');
      div.dataset.questionIndex=index;

      var html='<div class="flex items-start gap-2">';
      if(isPreviewReorderMode){
        html+='<span class="material-symbols-outlined text-sm text-brand-dark-gray/40 dark:text-brand-white/40 cursor-move">drag_indicator</span>';
      }
      html+='<div class="flex-1 min-w-0">';
      html+='<div class="text-xs font-semibold text-brand-dark-gray/80 dark:text-brand-white/80">Q'+(index+1)+'</div>';
      html+='<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 truncate mt-1">'+escapeHtml(q.questionText||'No text')+'</div>';
      html+='</div></div>';

      div.innerHTML=html;
      div.onclick=function(){
        if(!isPreviewReorderMode){
          currentPreviewQuestionIndex=index;
          renderPreviewNav();
          renderPreviewQuestion();
        }
      };

      if(isPreviewReorderMode){
        div.setAttribute('draggable','true');
        setupDragHandlers(div,index);
      }

      previewQuestionsNav.appendChild(div);
    });
  }

  function renderPreviewQuestion(){
    if(!currentPreviewPoll||!currentPreviewPoll.questions||currentPreviewQuestionIndex>=currentPreviewPoll.questions.length){
      previewQuestionDisplay.innerHTML='<p class="text-brand-dark-gray/60 dark:text-brand-white/60">No question selected</p>';
      return;
    }

    var q=currentPreviewPoll.questions[currentPreviewQuestionIndex];
    var html='';

    // Question header
    html+='<div class="mb-6">';
    html+='<div class="flex items-center gap-2 mb-2">';
    html+='<span class="text-sm font-semibold text-brand-dark-gray/60 dark:text-brand-white/60">Question '+(currentPreviewQuestionIndex+1)+' of '+currentPreviewPoll.questions.length+'</span>';
    if(q.timerSeconds){
      html+='<span class="text-sm text-brand-dark-gray/50 dark:text-brand-white/50">â€¢ Timer: '+q.timerSeconds+'s</span>';
    }
    html+='</div>';
    html+='<h3 class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">'+escapeHtml(q.questionText||'No question text')+'</h3>';
    html+='</div>';

    // Question image
    if(q.questionImageURL){
      html+='<div class="mb-6">';
      html+='<img src="'+escapeHtml(q.questionImageURL)+'" alt="Question image" class="max-w-full max-h-96 rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/40" referrerpolicy="no-referrer" onerror="this.style.display=\'none\';">';
      html+='</div>';
    }

    // Answer options
    if(q.options&&q.options.length>0){
      html+='<div class="space-y-3">';
      html+='<h4 class="text-lg font-semibold text-brand-dark-gray dark:text-brand-white mb-3">Answer Options</h4>';
      q.options.forEach(function(opt,optIndex){
        var letter=String.fromCharCode(65+optIndex);
        var isCorrect=q.correctAnswer===letter;
        var optClass='flex items-start gap-3 p-4 rounded-lg border-2 transition-colors '+(isCorrect?'bg-green-50 dark:bg-green-900/20 border-green-500 dark:border-green-600':'bg-brand-light-gray/30 dark:bg-brand-dark-gray/20 border-brand-light-gray dark:border-brand-dark-gray/40');

        html+='<div class="'+optClass+'">';
        html+='<div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold '+(isCorrect?'bg-green-500 text-white':'bg-brand-dark-gray/10 dark:bg-brand-white/10 text-brand-dark-gray dark:text-brand-white')+'">'+letter+'</div>';
        html+='<div class="flex-1">';
        if(opt.text){
          html+='<p class="text-brand-dark-gray dark:text-brand-white">'+escapeHtml(opt.text)+'</p>';
        }
        if(opt.imageURL){
          html+='<img src="'+escapeHtml(opt.imageURL)+'" alt="Option image" class="mt-2 max-w-[200px] max-h-[150px] rounded border border-brand-light-gray dark:border-brand-dark-gray/40" referrerpolicy="no-referrer" onerror="this.style.display=\'none\';">';
        }
        html+='</div>';
        if(isCorrect){
          html+='<span class="material-symbols-outlined text-green-600 dark:text-green-400">check_circle</span>';
        }
        html+='</div>';
      });
      html+='</div>';
    } else {
      html+='<p class="text-brand-dark-gray/60 dark:text-brand-white/60">No answer options</p>';
    }

    previewQuestionDisplay.innerHTML=html;
    previewQuestionCounter.textContent=(currentPreviewQuestionIndex+1)+' / '+currentPreviewPoll.questions.length;

    // Update navigation button states
    document.getElementById('preview-prev-question-btn').disabled=currentPreviewQuestionIndex===0;
    document.getElementById('preview-next-question-btn').disabled=currentPreviewQuestionIndex===currentPreviewPoll.questions.length-1;
  }

  function previewPrevQuestion(){
    if(currentPreviewQuestionIndex>0){
      currentPreviewQuestionIndex--;
      renderPreviewNav();
      renderPreviewQuestion();
    }
  }

  function previewNextQuestion(){
    if(currentPreviewPoll&&currentPreviewQuestionIndex<currentPreviewPoll.questions.length-1){
      currentPreviewQuestionIndex++;
      renderPreviewNav();
      renderPreviewQuestion();
    }
  }

  function previewOpenLinks(){
    if(!currentPreviewPoll)return;
    var className=currentPreviewPoll.className;
    if(!className){
      veritasAlert('This poll has no class assigned.',{title:'No class',destructive:true});
      return;
    }
    openLinksModal(className);
  }

  function previewEditQuestion(){
    if(!currentPreviewPoll)return;
    closePollPreview();
    startEditPoll(currentPreviewPoll.pollId);
  }

  async function previewDeleteQuestion(){
    if(!currentPreviewPoll||!currentPreviewPoll.questions||currentPreviewPoll.questions.length===0)return;

    var confirmed=await veritasConfirm('Delete this question from the poll?',{
      title:'Delete question',
      confirmText:'Delete',
      destructive:true
    });
    if(!confirmed)return;

    currentPreviewPoll.questions.splice(currentPreviewQuestionIndex,1);

    if(currentPreviewPoll.questions.length===0){
      await veritasAlert('Cannot delete the last question. A poll must have at least one question.',{
        title:'Cannot delete',
        destructive:true
      });
      currentPreviewPoll.questions.splice(currentPreviewQuestionIndex,0,{questionText:'',options:[],correctAnswer:'A',timerSeconds:90});
      return;
    }

    if(currentPreviewQuestionIndex>=currentPreviewPoll.questions.length){
      currentPreviewQuestionIndex=currentPreviewPoll.questions.length-1;
    }

    // Save to backend
    if(PREVIEW_MODE){
      renderPreviewNav();
      renderPreviewQuestion();
      await veritasAlert('Question deleted (preview mode).',{title:'Question deleted'});
      return;
    }

    google.script.run
      .withSuccessHandler(async function(polls){
        refreshPollData(polls);
        renderPreviewNav();
        renderPreviewQuestion();
        await veritasAlert('Question deleted successfully.',{title:'Question deleted'});
      })
      .withFailureHandler(function(error){
        handleError(error);
      })
      .updatePoll(
        currentPreviewPoll.pollId,
        currentPreviewPoll.pollName,
        currentPreviewPoll.className,
        currentPreviewPoll.questions,
        currentPreviewPoll.sessionType,
        currentPreviewPoll.timeLimitMinutes
      );
  }

  function togglePreviewReorder(){
    isPreviewReorderMode=!isPreviewReorderMode;
    var btn=document.getElementById('preview-reorder-btn');

    if(isPreviewReorderMode){
      originalQuestionOrder=JSON.parse(JSON.stringify(currentPreviewPoll.questions));
      btn.innerHTML='<span class="material-symbols-outlined text-sm align-middle">check</span>';
      btn.classList.add('bg-primary','text-white');
      btn.classList.remove('bg-brand-dark-gray/10','dark:bg-brand-white/10','text-brand-dark-gray','dark:text-brand-white');
    } else {
      // Save the reordered questions
      if(JSON.stringify(originalQuestionOrder)!==JSON.stringify(currentPreviewPoll.questions)){
        saveReorderedQuestions();
      }
      originalQuestionOrder=null;
      btn.innerHTML='<span class="material-symbols-outlined text-sm align-middle">swap_vert</span>';
      btn.classList.remove('bg-primary','text-white');
      btn.classList.add('bg-brand-dark-gray/10','dark:bg-brand-white/10','text-brand-dark-gray','dark:text-brand-white');
    }

    renderPreviewNav();
  }

  function saveReorderedQuestions(){
    if(!currentPreviewPoll)return;

    if(PREVIEW_MODE){
      veritasAlert('Question order updated (preview mode).',{title:'Questions reordered'});
      return;
    }

    google.script.run
      .withSuccessHandler(async function(polls){
        refreshPollData(polls);
        await veritasAlert('Question order updated successfully.',{title:'Questions reordered'});
      })
      .withFailureHandler(function(error){
        handleError(error);
      })
      .updatePoll(
        currentPreviewPoll.pollId,
        currentPreviewPoll.pollName,
        currentPreviewPoll.className,
        currentPreviewPoll.questions,
        currentPreviewPoll.sessionType,
        currentPreviewPoll.timeLimitMinutes
      );
  }

  var draggedItemIndex=null;

  function setupDragHandlers(div,index){
    div.addEventListener('dragstart',function(e){
      draggedItemIndex=index;
      this.style.opacity='0.4';
      e.dataTransfer.effectAllowed='move';
    });

    div.addEventListener('dragend',function(e){
      this.style.opacity='1';
      draggedItemIndex=null;
    });

    div.addEventListener('dragover',function(e){
      e.preventDefault();
      e.dataTransfer.dropEffect='move';

      if(draggedItemIndex!==null&&draggedItemIndex!==index){
        var draggedQuestion=currentPreviewPoll.questions[draggedItemIndex];
        currentPreviewPoll.questions.splice(draggedItemIndex,1);
        currentPreviewPoll.questions.splice(index,0,draggedQuestion);

        if(currentPreviewQuestionIndex===draggedItemIndex){
          currentPreviewQuestionIndex=index;
        } else if(draggedItemIndex<currentPreviewQuestionIndex&&index>=currentPreviewQuestionIndex){
          currentPreviewQuestionIndex--;
        } else if(draggedItemIndex>currentPreviewQuestionIndex&&index<=currentPreviewQuestionIndex){
          currentPreviewQuestionIndex++;
        }

        draggedItemIndex=index;
        renderPreviewNav();
      }
    });
  }

  function generateQuestionId(){
    questionIdCounter+=1;
    return 'q-'+questionIdCounter;
  }

  function assignQuestionId(question){
    if(!question)return question;
    if(!question._id){
      question._id=generateQuestionId();
    }else{
      var match=String(question._id).match(/q-(\d+)/);
      if(match){
        var numeric=parseInt(match[1],10);
        if(!isNaN(numeric)&&numeric>questionIdCounter){
          questionIdCounter=numeric;
        }
      }
    }
    if(typeof question._createdOrder!=='number'){
      question._createdOrder=Date.now();
    }
    return question;
  }

  function ensureCustomOrderIncludes(questionId,insertIndex){
    if(!questionId)return;
    var existingIndex=customQuestionOrder.indexOf(questionId);
    if(existingIndex!==-1){
      if(typeof insertIndex==='number'&&insertIndex!==existingIndex){
        customQuestionOrder.splice(existingIndex,1);
        if(insertIndex>customQuestionOrder.length){
          insertIndex=customQuestionOrder.length;
        }
        customQuestionOrder.splice(insertIndex,0,questionId);
      }
      return;
    }
    if(typeof insertIndex==='number'&&insertIndex>=0&&insertIndex<=customQuestionOrder.length){
      customQuestionOrder.splice(insertIndex,0,questionId);
    }else{
      customQuestionOrder.push(questionId);
    }
  }

  function removeFromCustomOrder(questionId){
    if(!questionId)return;
    var index=customQuestionOrder.indexOf(questionId);
    if(index!==-1){
      customQuestionOrder.splice(index,1);
    }
  }

  function buildOrderFromIds(orderIds){
    var idMap=new Map();
    questions.forEach(function(question){
      if(question&&question._id){
        idMap.set(question._id,question);
      }
    });
    var ordered=[];
    (orderIds||[]).forEach(function(id){
      if(idMap.has(id)){
        ordered.push(idMap.get(id));
        idMap.delete(id);
      }
    });
    idMap.forEach(function(question){
      ordered.push(question);
    });
    return ordered;
  }

  function enforceQuestionOrder(preserveQuestionId){
    var selectionId=preserveQuestionId||(questions[selectedQuestionIndex]&&questions[selectedQuestionIndex]._id)||null;
    var ordered=buildOrderFromIds(customQuestionOrder);
    questions=ordered;
    customQuestionOrder=ordered.map(function(question){return question._id;});

    if(questions.length===0){
      selectedQuestionIndex=0;
      return;
    }

    if(selectionId){
      var newIndex=questions.findIndex(function(question){return question&&question._id===selectionId;});
      if(newIndex!==-1){
        selectedQuestionIndex=newIndex;
      }else if(selectedQuestionIndex>=questions.length){
        selectedQuestionIndex=Math.max(0,questions.length-1);
      }
    }else if(selectedQuestionIndex>=questions.length){
      selectedQuestionIndex=Math.max(0,questions.length-1);
    }
  }

  function setQuestionReorderHelp(){
    if(questionSortHelp){
      questionSortHelp.textContent='Drag questions to reorder them manually.';
    }
  }

  function resetQuestionOrderToInitial(){
    if(!initialQuestionOrder||initialQuestionOrder.length===0)return;
    var selectionId=questions[selectedQuestionIndex]&&questions[selectedQuestionIndex]._id;
    var ordered=buildOrderFromIds(initialQuestionOrder);
    questions=ordered;
    customQuestionOrder=ordered.map(function(question){return question._id;});
    enforceQuestionOrder(selectionId);
    renderQuestionNavigator();
    renderQuestionWorkspace();
    markPollDirty();
    setQuestionReorderHelp();
  }

  function clearDropIndicators(){
    if(!questionNavigatorContainer)return;
    questionNavigatorContainer.querySelectorAll('.question-nav-item').forEach(function(item){
      item.classList.remove('drop-before','drop-after');
    });
  }

  function clearDragVisuals(){
    if(!questionNavigatorContainer)return;
    questionNavigatorContainer.querySelectorAll('.question-nav-item').forEach(function(item){
      item.classList.remove('drop-before','drop-after','dragging');
    });
  }

  function moveQuestionToIndex(questionId,insertIndex){
    if(!questionId)return;
    var fromIndex=customQuestionOrder.indexOf(questionId);
    if(fromIndex===-1)return;
    if(insertIndex>customQuestionOrder.length){
      insertIndex=customQuestionOrder.length;
    }
    if(insertIndex>fromIndex){
      insertIndex--;
    }
    if(insertIndex===fromIndex)return;
    customQuestionOrder.splice(fromIndex,1);
    customQuestionOrder.splice(insertIndex,0,questionId);
    enforceQuestionOrder(questionId);
    renderQuestionNavigator();
    renderQuestionWorkspace();
    markPollDirty();
  }

  function handleQuestionDragStart(e){
    draggedQuestionId=this.dataset.questionId||null;
    if(!draggedQuestionId)return;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed='move';
    try{e.dataTransfer.setData('text/plain',draggedQuestionId);}catch(err){}
  }

  function handleQuestionDragOver(e){
    if(!draggedQuestionId)return;
    var questionId=this.dataset.questionId;
    if(!questionId||questionId===draggedQuestionId)return;
    e.preventDefault();
    clearDropIndicators();
    var rect=this.getBoundingClientRect();
    var before=(e.clientY-rect.top)<rect.height/2;
    if(before){
      this.classList.add('drop-before');
      this.classList.remove('drop-after');
    }else{
      this.classList.add('drop-after');
      this.classList.remove('drop-before');
    }
  }

  function handleQuestionDragLeave(){
    if(!this.classList.contains('question-nav-item'))return;
    this.classList.remove('drop-before','drop-after');
  }

  function handleQuestionDrop(e){
    if(!draggedQuestionId)return;
    var questionId=this.dataset.questionId;
    if(!questionId||questionId===draggedQuestionId)return;
    e.preventDefault();
    e.stopPropagation();
    var rect=this.getBoundingClientRect();
    var before=(e.clientY-rect.top)<rect.height/2;
    clearDropIndicators();
    var targetIndex=customQuestionOrder.indexOf(questionId);
    if(targetIndex===-1)return;
    var insertIndex=before?targetIndex:targetIndex+1;
    moveQuestionToIndex(draggedQuestionId,insertIndex);
    draggedQuestionId=null;
  }

  function handleQuestionDragEnd(){
    clearDragVisuals();
    draggedQuestionId=null;
  }

  function handleNavigatorDragOver(e){
    if(!draggedQuestionId)return;
    e.preventDefault();
    clearDropIndicators();
  }

  function handleNavigatorDrop(e){
    if(!draggedQuestionId)return;
    if(e.target!==questionNavigatorContainer)return;
    e.preventDefault();
    clearDropIndicators();
    moveQuestionToIndex(draggedQuestionId,customQuestionOrder.length);
    draggedQuestionId=null;
  }

  function setSaveStatus(message){
    var saveStatus=document.getElementById('save-status');
    if(saveStatus){
      saveStatus.textContent=message;
    }
  }

  function markPollDirty(){
    if(!isPollDirty){
      isPollDirty=true;
    }
    setSaveStatus('Unsaved changes');
  }

  function resetPollDirty(message){
    isPollDirty=false;
    setSaveStatus(message||'All changes saved');
  }

  // --- Poll Creator Modal ---
  function openPollCreator(existingPoll){
    var saveButton=document.getElementById('save-poll-btn');

    questionCounter=0;
    questions=[];
    selectedQuestionIndex=0;
    questionIdCounter=0;
    customQuestionOrder=[];
    initialQuestionOrder=[];
    draggedQuestionId=null;
    setQuestionReorderHelp();

    if(existingPoll){
      editingPollId=existingPoll.pollId;
      document.getElementById('new-poll-name').value=existingPoll.pollName||'';
      if(existingPoll.className){
        refreshClassOptions(BASE_CLASSES.concat([existingPoll.className]));
      }
      classSelect.value=existingPoll.className||'';

      var sessionTypeSelect=document.getElementById('session-type-select');
      var timeLimitInput=document.getElementById('time-limit-input');
      var timeLimitGroup=document.getElementById('time-limit-group');
      if(sessionTypeSelect){
        sessionTypeSelect.value=existingPoll.sessionType||'LIVE_POLL';
        if(existingPoll.sessionType==='INDIVIDUAL_TIMED'){
          if(timeLimitGroup)timeLimitGroup.style.display='block';
          if(timeLimitInput&&existingPoll.timeLimitMinutes){
            timeLimitInput.value=existingPoll.timeLimitMinutes;
          }
        }else if(timeLimitGroup){
          timeLimitGroup.style.display='none';
        }
      }

      questions=existingPoll.questions.map(function(question){
        var answers=(question.options||[]).map(function(opt){
          return {
            text:opt.text||'',
            image:opt.imageURL||null,
            imageURL:opt.imageURL||null,
            imageFileId:opt.imageFileId||null
          };
        });
        while(answers.length<2){
          answers.push({text:'',image:null,imageURL:null,imageFileId:null});
        }
        var correctIndex=0;
        answers.forEach(function(answer,idx){
          if(answer.text===question.correctAnswer){
            correctIndex=idx;
          }
        });
        return assignQuestionId({
          questionText:question.questionText||'',
          questionImage:null,
          questionImageURL:question.questionImageURL||null,
          questionImageFileId:question.questionImageFileId||null,
          answers:answers,
          correctAnswerIndex:correctIndex,
          timerSeconds:question.timerSeconds||null,
          metacognitionEnabled:!!question.metacognitionEnabled
        });
      });
      if(questions.length===0){
        addQuestion(true);
      }
      questionCounter=questions.length;
      selectedQuestionIndex=0;
      saveButton.innerHTML='<span class="truncate">Save Changes</span>';
      resetPollDirty('Editing existing poll');
    } else {
      editingPollId=null;
      document.getElementById('new-poll-name').value='';
      classSelect.value='';

      var newSessionTypeSelect=document.getElementById('session-type-select');
      var newTimeLimitInput=document.getElementById('time-limit-input');
      var newTimeLimitGroup=document.getElementById('time-limit-group');
      if(newSessionTypeSelect)newSessionTypeSelect.value='LIVE_POLL';
      if(newTimeLimitInput)newTimeLimitInput.value='';
      if(newTimeLimitGroup)newTimeLimitGroup.style.display='none';

      addQuestion(true);
      saveButton.innerHTML='<span class="truncate">Publish Poll</span>';
      resetPollDirty('All changes saved');
    }

    customQuestionOrder=questions.map(function(question){return question._id;});
    initialQuestionOrder=customQuestionOrder.slice();
    enforceQuestionOrder();
    renderQuestionNavigator();
    renderQuestionWorkspace();
    modal.style.display='flex';
  }

  function closePollCreator(){
    modal.style.display='none';
    questions=[];
    questionCounter=0;
    selectedQuestionIndex=0;
    editingPollId=null;
    document.getElementById('save-poll-btn').innerHTML='<span class="truncate">Publish Poll</span>';
    resetPollDirty('All changes saved');
    customQuestionOrder=[];
    initialQuestionOrder=[];
    questionIdCounter=0;
    draggedQuestionId=null;
    setQuestionReorderHelp();
  }

  function addQuestion(suppressDirty){
    var skipDirty=suppressDirty===true;
    var currentSelection=questions[selectedQuestionIndex];
    var insertIndex=customQuestionOrder.length;
    if(currentSelection&&currentSelection._id){
      var manualIndex=customQuestionOrder.indexOf(currentSelection._id);
      if(manualIndex!==-1){
        insertIndex=manualIndex+1;
      }
    }
    var newQuestion={
      questionText:'',
      questionImage:null,
      questionImageURL:null,
      questionImageFileId:null,
      answers:[
        {text:'',image:null,imageURL:null,imageFileId:null},
        {text:'',image:null,imageURL:null,imageFileId:null}
      ],
      correctAnswerIndex:0,
      timerSeconds:null,
      metacognitionEnabled:false
    };
    assignQuestionId(newQuestion);
    questions.push(newQuestion);
    ensureCustomOrderIncludes(newQuestion._id,insertIndex);
    enforceQuestionOrder(newQuestion._id);
    if(!skipDirty){
      markPollDirty();
    }
    renderQuestionNavigator();
    renderQuestionWorkspace();
  }

  async function deleteQuestion(index){
    if(questions.length<=1){
      await veritasAlert('A poll must have at least one question.',{title:'Edit poll'});
      return;
    }
    var removedQuestion=questions[index];
    var removedId=removedQuestion&&removedQuestion._id;
    questions.splice(index,1);
    if(removedId){
      removeFromCustomOrder(removedId);
    }
    if(selectedQuestionIndex>=questions.length){
      selectedQuestionIndex=Math.max(0,questions.length-1);
    }
    enforceQuestionOrder();
    renderQuestionNavigator();
    renderQuestionWorkspace();
    markPollDirty();
  }

  async function duplicateQuestionLocal(index){
    if(questions.length>=50){
      await veritasAlert('Maximum 50 questions per poll. Cannot duplicate.',{title:'Edit poll'});
      return;
    }
    // Deep copy the question
    var questionToDuplicate=questions[index];
    if(!questionToDuplicate)return;
    var duplicatedQuestion=JSON.parse(JSON.stringify(questionToDuplicate));
    delete duplicatedQuestion._id;
    delete duplicatedQuestion._createdOrder;
    assignQuestionId(duplicatedQuestion);
    duplicatedQuestion._createdOrder=Date.now();

    // Insert the duplicated question right after the original
    questions.splice(index+1,0,duplicatedQuestion);
    var manualIndex=questionToDuplicate._id?customQuestionOrder.indexOf(questionToDuplicate._id):-1;
    var insertIndex=manualIndex===-1?customQuestionOrder.length:manualIndex+1;
    ensureCustomOrderIncludes(duplicatedQuestion._id,insertIndex);
    questionCounter++;

    enforceQuestionOrder(duplicatedQuestion._id);
    renderQuestionNavigator();
    renderQuestionWorkspace();
    markPollDirty();
  }

  function renderQuestionNavigator(){
    var nav=document.getElementById('question-navigator');
    nav.innerHTML='';
    draggedQuestionId=null;
    clearDragVisuals();

    questions.forEach(function(q,index){
      var isSelected=index===selectedQuestionIndex;
      var div=document.createElement('div');
      div.className='question-nav-item group relative flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer '+(isSelected?'bg-primary/20 dark:bg-primary/30':'hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10');

      var html='<span class="material-symbols-outlined '+(isSelected?'text-brand-dark-gray dark:text-brand-white':'text-brand-dark-gray/50 dark:text-brand-white/50')+'">drag_indicator</span>';
      html+='<p class="'+(isSelected?'text-primary dark:text-brand-white':'text-brand-dark-gray dark:text-brand-white')+' text-sm font-medium leading-normal">Question '+(index+1)+'</p>';

      html+='<div class="absolute right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">';
      html+='<button class="duplicate-question-btn p-1 rounded-full hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10" data-index="'+index+'" title="Duplicate question">';
      html+='<span class="material-symbols-outlined text-brand-dark-gray dark:text-brand-white text-base">content_copy</span>';
      html+='</button>';
      if(questions.length>1){
        html+='<button class="delete-question-btn p-1 rounded-full hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10" data-index="'+index+'" title="Delete question">';
        html+='<span class="material-symbols-outlined text-brand-dark-gray dark:text-brand-white text-base">close</span>';
        html+='</button>';
      }
      html+='</div>';

      div.innerHTML=html;
      div.dataset.questionId=q&&q._id?q._id:('question-'+index);
      div.dataset.index=index;
      div.setAttribute('draggable','true');
      div.addEventListener('dragstart',handleQuestionDragStart);
      div.addEventListener('dragover',handleQuestionDragOver);
      div.addEventListener('dragleave',handleQuestionDragLeave);
      div.addEventListener('drop',handleQuestionDrop);
      div.addEventListener('dragend',handleQuestionDragEnd);

      div.onclick=function(e){
        if(e.target.classList.contains('material-symbols-outlined')&&(e.target.textContent==='close'||e.target.textContent==='content_copy'))return;
        selectedQuestionIndex=index;
        renderQuestionNavigator();
        renderQuestionWorkspace();
      };

      var duplicateBtn=div.querySelector('.duplicate-question-btn');
      if(duplicateBtn){
        duplicateBtn.onclick=function(e){
          e.stopPropagation();
          duplicateQuestionLocal(parseInt(this.dataset.index));
        };
      }

      var closeBtn=div.querySelector('.delete-question-btn');
      if(closeBtn){
        closeBtn.onclick=function(e){
          e.stopPropagation();
          deleteQuestion(parseInt(this.dataset.index));
        };
      }
      
      nav.appendChild(div);
    });
  }

  function renderQuestionWorkspace(){
    var workspace=document.getElementById('question-builder-workspace');
    var question=questions[selectedQuestionIndex];

    var html='<div class="max-w-4xl mx-auto">';
    html+='<div class="flex flex-wrap justify-between gap-3 mb-6">';
    html+='<div class="flex min-w-72 flex-col gap-1">';
    html+='<p class="text-brand-dark-gray dark:text-brand-white tracking-light text-[32px] font-bold leading-tight">Question '+(selectedQuestionIndex+1)+'</p>';
    html+='<p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm font-normal leading-normal">Edit the question and answer choices below.</p>';
    html+='</div></div>';

    html+='<div class="bg-brand-white dark:bg-brand-dark-gray/20 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/30 p-6 shadow-sm mb-6">';
    html+='<label class="flex flex-col w-full">';
    html+='<p class="text-brand-dark-gray dark:text-brand-white text-base font-medium leading-normal pb-2">Question Text</p>';
    html+='<textarea id="question-text-input" class="form-input flex w-full min-w-0 flex-1 resize-y overflow-hidden rounded-lg text-brand-dark-gray dark:text-brand-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 focus:border-primary min-h-36 placeholder:text-brand-dark-gray/50 dark:placeholder:text-brand-white/50 p-[15px] text-base font-normal leading-normal" placeholder="Type your question here...">'+escapeHtml(question.questionText||'')+'</textarea>';
    html+='</label>';
    html+='<div class="flex mt-4 items-center gap-3 flex-wrap">';
    html+='<label class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-light-gray dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white gap-2 pl-3 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/60 transition-colors">';
    html+='<span class="material-symbols-outlined text-xl">image</span>';
    html+='<span class="truncate">Upload Image</span>';
    html+='<input type="file" class="hidden" accept="image/*" id="question-image-input">';
    html+='</label>';
    html+='</div>';

    // Show image preview or uploading state
    var questionImagePreview=getImagePreviewUrl(question.questionImage||question.questionImageURL,question.questionImageFileId);
    var isUploading=question.questionImage==='UPLOADING';

    if(questionImagePreview||isUploading){
      html+='<div class="mt-4 flex flex-wrap items-center gap-3 bg-primary/5 dark:bg-primary/10 p-3 rounded-lg">';
      if(isUploading){
        html+='<div class="flex items-center gap-2 text-primary dark:text-brand-white">';
        html+='<div class="h-5 w-5 animate-spin rounded-full border-2 border-primary border-t-transparent"></div>';
        html+='<span class="text-sm font-medium">Uploading image...</span>';
        html+='</div>';
      } else if(questionImagePreview){
        html+='<img src="'+questionImagePreview+'" class="rounded-lg max-w-xs h-auto" referrerpolicy="no-referrer">';
        html+='<button type="button" class="remove-question-image-btn h-9 px-4 rounded-lg bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-sm font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors">Remove Image</button>';
      }
      html+='</div>';
    }

    html+='<div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">';
    html+='<div>';
    html+='<label class="text-brand-dark-gray dark:text-brand-white text-sm font-medium leading-normal block pb-2" for="question-topic-input">Topic/Standard Tag</label>';
    html+='<input id="question-topic-input" type="text" class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="e.g., Cell Division, Algebra, etc." value="'+escapeHtml(question.topicTag||question.topic||'')+'">';
    html+='<p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-1">Used for topic-level analytics and reporting.</p>';
    html+='</div>';
    html+='<div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700/30 rounded-lg p-3">';
    html+='<div class="flex items-start gap-2">';
    html+='<input type="checkbox" id="question-metacognition-input" class="mt-0.5 h-4 w-4 rounded border-blue-300 dark:border-blue-600 text-blue-600 focus:ring-blue-500 cursor-pointer" '+(question.metacognitionEnabled?'checked':'')+' />';
    html+='<div class="flex-1">';
    html+='<label for="question-metacognition-input" class="text-brand-dark-gray dark:text-brand-white text-xs font-semibold leading-normal cursor-pointer block">Enable Metacognition Assessment</label>';
    html+='<p class="text-xs text-brand-dark-gray/70 dark:text-brand-white/70 mt-1">Ask students how confident they are in their answer (Guessing, Somewhat Sure, Very Sure, Certain). This enables powerful confidence/correctness analytics to identify misconceptions.</p>';
    html+='</div>';
    html+='</div>';
    html+='</div>';
    html+='</div>';

    html+='</div>';

    html+='<div class="bg-brand-white dark:bg-brand-dark-gray/20 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/30 p-6 shadow-sm">';
    html+='<p class="text-brand-dark-gray dark:text-brand-white text-base font-medium leading-normal pb-4">Answer Choices</p>';
    html+='<div class="flex flex-col gap-4">';

    question.answers.forEach(function(answer,aIndex){
      html+=renderAnswerChoice(answer,aIndex,question.correctAnswerIndex===aIndex);
    });

    html+='</div>';
    html+='<div class="mt-4">';
    html+='<button id="add-answer-btn" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-light-gray dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/60 transition-colors">';
    html+='<span class="truncate">+ Add Answer Choice</span>';
    html+='</button></div></div></div>';

    workspace.innerHTML=html;

    document.getElementById('question-text-input').oninput=function(){
      questions[selectedQuestionIndex].questionText=this.value;
      markPollDirty();
    };

    var qImgInput=document.getElementById('question-image-input');
    if(qImgInput){
      qImgInput.onchange=function(){
        if(this.files&&this.files[0]){
          var file=this.files[0];

          // Show loading state
          var currentQuestion=questions[selectedQuestionIndex];
          currentQuestion.questionImage='UPLOADING';
          currentQuestion.questionImageURL=null;
          renderQuestionWorkspace();

          // Upload immediately to Drive
          uploadFile(file).then(function(fileId){
            // Store the fileId (not URL) - URLs generated at render time via proxy
            questions[selectedQuestionIndex].questionImageFileId=fileId;
            questions[selectedQuestionIndex].questionImage=null;
            questions[selectedQuestionIndex].questionImageURL=null;
            markPollDirty();
            renderQuestionWorkspace();
          }).catch(async function(error){
            await veritasAlert('Image upload failed: '+(error.message||error),{title:'Upload image',destructive:true});
            questions[selectedQuestionIndex].questionImage=null;
            questions[selectedQuestionIndex].questionImageFileId=null;
            questions[selectedQuestionIndex].questionImageURL=null;
            renderQuestionWorkspace();
          });
        }
      };
    }

    var removeQImgBtn=workspace.querySelector('.remove-question-image-btn');
    if(removeQImgBtn){
      removeQImgBtn.onclick=function(){
        questions[selectedQuestionIndex].questionImage=null;
        questions[selectedQuestionIndex].questionImageURL=null;
        questions[selectedQuestionIndex].questionImageFileId=null;
        markPollDirty();
        renderQuestionWorkspace();
      };
    }

    var topicInput=document.getElementById('question-topic-input');
    if(topicInput){
      topicInput.oninput=function(){
        questions[selectedQuestionIndex].topicTag=this.value.trim();
        questions[selectedQuestionIndex].topic=this.value.trim(); // Backward compatibility
        markPollDirty();
      };
    }

    var metacognitionInput=document.getElementById('question-metacognition-input');
    if(metacognitionInput){
      metacognitionInput.onchange=function(){
        questions[selectedQuestionIndex].metacognitionEnabled=this.checked;
        markPollDirty();
      };
    }

    document.getElementById('add-answer-btn').onclick=function(){
      questions[selectedQuestionIndex].answers.push({text:'',image:null,imageURL:null,imageFileId:null});
      markPollDirty();
      renderQuestionWorkspace();
    };

    workspace.querySelectorAll('.answer-text-input').forEach(function(input,index){
      input.oninput=function(){
        questions[selectedQuestionIndex].answers[index].text=this.value;
        markPollDirty();
      };
    });

    workspace.querySelectorAll('.correct-radio').forEach(function(radio,index){
      radio.onchange=function(){
        if(this.checked){
          questions[selectedQuestionIndex].correctAnswerIndex=index;
          markPollDirty();
        }
      };
    });

    workspace.querySelectorAll('.delete-answer-btn').forEach(function(btn,index){
      btn.onclick=function(){
        deleteAnswer(index);
      };
    });

    workspace.querySelectorAll('.answer-image-input').forEach(function(input,index){
      input.onchange=function(){
        if(this.files&&this.files[0]){
          var file=this.files[0];

          // Show loading state
          var currentAnswer=questions[selectedQuestionIndex].answers[index];
          currentAnswer.image='UPLOADING';
          currentAnswer.imageURL=null;
          renderQuestionWorkspace();

          // Upload immediately to Drive
          uploadFile(file).then(function(fileId){
            // Store the fileId (not URL) - URLs generated at render time via proxy
            questions[selectedQuestionIndex].answers[index].imageFileId=fileId;
            questions[selectedQuestionIndex].answers[index].image=null;
            questions[selectedQuestionIndex].answers[index].imageURL=null;
            markPollDirty();
            renderQuestionWorkspace();
          }).catch(async function(error){
            await veritasAlert('Image upload failed: '+(error.message||error),{title:'Upload image',destructive:true});
            questions[selectedQuestionIndex].answers[index].image=null;
            questions[selectedQuestionIndex].answers[index].imageFileId=null;
            questions[selectedQuestionIndex].answers[index].imageURL=null;
            renderQuestionWorkspace();
          });
        }
      };
    });

    workspace.querySelectorAll('.remove-answer-image-btn').forEach(function(btn){
      btn.onclick=function(){
        var idx=parseInt(this.dataset.index,10);
        questions[selectedQuestionIndex].answers[idx].image=null;
        questions[selectedQuestionIndex].answers[idx].imageURL=null;
        questions[selectedQuestionIndex].answers[idx].imageFileId=null;
        markPollDirty();
        renderQuestionWorkspace();
      };
    });
  }

  function renderAnswerChoice(answer,index,isCorrect){
    var html='<div class="flex items-center gap-3">';
    html+='<label class="relative flex items-center justify-center cursor-pointer" title="Set as correct answer">';
    html+='<input class="correct-radio peer h-5 w-5 cursor-pointer appearance-none rounded-full border border-brand-light-gray dark:border-brand-white/30 checked:border-primary checked:bg-primary transition-all" name="correct_answer" type="radio" '+(isCorrect?'checked':'')+'/>';
    html+='<span class="material-symbols-outlined absolute text-brand-white transition-opacity opacity-0 peer-checked:opacity-100 text-sm">check</span>';
    html+='</label>';
    html+='<input class="answer-text-input form-input flex-1 rounded-lg text-brand-dark-gray dark:text-brand-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 focus:border-primary placeholder:text-brand-dark-gray/50 dark:placeholder:text-brand-white/50 p-3 text-base" placeholder="Answer '+String.fromCharCode(65+index)+'" type="text" value="'+escapeHtml(answer.text||'')+'"/>';
    html+='<label class="p-2 rounded-lg hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10 transition-colors cursor-pointer" title="Upload image for this answer">';
    html+='<span class="material-symbols-outlined text-brand-dark-gray/60 dark:text-brand-white/60">image</span>';
    html+='<input type="file" class="answer-image-input hidden" accept="image/*">';
    html+='</label>';

    if(questions[selectedQuestionIndex].answers.length>2){
      html+='<button class="delete-answer-btn p-2 rounded-lg hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10 transition-colors" title="Remove this answer">';
      html+='<span class="material-symbols-outlined text-brand-dark-gray/60 dark:text-brand-white/60">delete</span>';
      html+='</button>';
    } else {
      html+='<div class="w-10"></div>';
    }

    html+='</div>';

    // Show image preview or uploading state for answer choices
    var answerPreview=getImagePreviewUrl(answer.image||answer.imageURL,answer.imageFileId);
    var isAnswerUploading=answer.image==='UPLOADING';

    if(answerPreview||isAnswerUploading){
      html+='<div class="mt-2 flex items-center gap-3 bg-primary/5 dark:bg-primary/10 p-2 rounded-lg">';
      if(isAnswerUploading){
        html+='<div class="flex items-center gap-2 text-primary dark:text-brand-white">';
        html+='<div class="h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent"></div>';
        html+='<span class="text-xs font-medium">Uploading...</span>';
        html+='</div>';
      } else if(answerPreview){
        html+='<img src="'+answerPreview+'" class="rounded-md max-w-[160px] h-auto" referrerpolicy="no-referrer">';
        html+='<button type="button" class="remove-answer-image-btn h-8 px-3 rounded-md bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-xs font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors" data-index="'+index+'">Remove</button>';
      }
      html+='</div>';
    }

    return html;
  }

  async function deleteAnswer(index){
    if(questions[selectedQuestionIndex].answers.length<=2){
      await veritasAlert('A question must have at least two answer choices.',{title:'Edit poll'});
      return;
    }
    questions[selectedQuestionIndex].answers.splice(index,1);
    if(questions[selectedQuestionIndex].correctAnswerIndex>=index){
      questions[selectedQuestionIndex].correctAnswerIndex=Math.max(0,questions[selectedQuestionIndex].correctAnswerIndex-1);
    }
    markPollDirty();
    renderQuestionWorkspace();
  }

  // Helper to get web app base URL for generating proxy URLs
  function getWebAppUrl(){
    // Use current page URL (web app deployment URL)
    var url=window.location.href;
    // Remove query parameters
    var baseUrl=url.split('?')[0];
    return baseUrl;
  }

  // Helper to generate Google Drive thumbnail URL from fileId
  function generateProxyUrl(fileId){
    if(!fileId||typeof fileId!=='string'){
      return'';
    }
    // Use Google Drive thumbnail API for direct image display
    // sz=w1000 specifies max width of 1000px (adjustable)
    return 'https://drive.google.com/thumbnail?id='+encodeURIComponent(fileId)+'&sz=w1000';
  }

  function getImagePreviewUrl(imageData,fileId){
    // If fileId is provided, generate proxy URL
    if(fileId&&typeof fileId==='string'){
      return generateProxyUrl(fileId);
    }

    // Otherwise handle legacy data
    if(imageData instanceof File){
      return URL.createObjectURL(imageData);
    }
    if(typeof imageData==='string'&&imageData){
      // Return the URL, unless it's the special UPLOADING marker
      if(imageData==='UPLOADING'){
        return'';
      }
      return imageData;
    }
    return'';
  }

  // --- Poll & Image Uploader ---
  async function savePoll(){
    var savePollBtn=document.getElementById('save-poll-btn');
    var defaultLabel=editingPollId?'<span class="truncate">Save Changes</span>':'<span class="truncate">Publish Poll</span>';

    savePollBtn.disabled=true;
    savePollBtn.innerHTML='<div class="h-5 w-5 animate-spin rounded-full border-2 border-primary border-t-transparent"></div><span>Saving...</span>';

    var pollName=document.getElementById('new-poll-name').value.trim();
    var className=(classSelect.value||'').trim();
    var sessionType=document.getElementById('session-type-select').value||'LIVE_POLL';
    var timeLimitMinutes=null;

    if(sessionType==='INDIVIDUAL_TIMED'){
      var timeLimitValue=document.getElementById('time-limit-input').value;
      if(!timeLimitValue||parseInt(timeLimitValue)<=0){
        await veritasAlert('Please enter a valid time limit for individual timed sessions.',{title:'Save poll'});
        savePollBtn.disabled=false;
        savePollBtn.innerHTML=defaultLabel;
        return;
      }
      timeLimitMinutes=parseInt(timeLimitValue);
    }

    if(!pollName||!className){
      await veritasAlert('Please enter a poll name and select a class.',{title:'Save poll'});
      savePollBtn.disabled=false;
      savePollBtn.innerHTML=defaultLabel;
      return;
    }

    if(questions.length===0){
      await veritasAlert('Please add at least one question.',{title:'Save poll'});
      savePollBtn.disabled=false;
      savePollBtn.innerHTML=defaultLabel;
      return;
    }

    var validationError='';
    questions.forEach(function(question,index){
      if(validationError)return;
      var questionText=(question.questionText||'').trim();
      if(questionText===''){
        validationError='Question '+(index+1)+' needs question text.';
        return;
      }
      var answerTexts=question.answers.map(function(answer){return(answer.text||'').trim();});
      var filledAnswers=answerTexts.filter(function(text){return text!=='';});
      if(filledAnswers.length<2){
        validationError='Question '+(index+1)+' must include at least two answer choices with text.';
        return;
      }
      var correctIndex=typeof question.correctAnswerIndex==='number'?question.correctAnswerIndex:0;
      if(correctIndex<0||correctIndex>=answerTexts.length){
        validationError='Question '+(index+1)+' has an invalid correct answer selection.';
        return;
      }
      if(answerTexts[correctIndex]===''){
        validationError='Question '+(index+1)+' must mark a correct answer with text.';
      }
    });

    if(validationError){
      await veritasAlert(validationError,{title:'Save poll'});
      savePollBtn.disabled=false;
      savePollBtn.innerHTML=defaultLabel;
      return;
    }

    // Check for any images still uploading
    var uploadsInProgress=false;
    var uploadMessages=[];
    questions.forEach(function(question,index){
      if(question.questionImage==='UPLOADING'){
        uploadsInProgress=true;
        uploadMessages.push('Question '+(index+1)+' image is still uploading. Please wait for upload to complete.');
      }
      question.answers.forEach(function(answer,aIndex){
        if(answer.image==='UPLOADING'){
          uploadsInProgress=true;
          uploadMessages.push('Question '+(index+1)+', answer '+(aIndex+1)+' image is still uploading. Please wait for upload to complete.');
        }
      });
    });

    if(uploadsInProgress){
      await veritasAlert(uploadMessages.join('\n'),{title:'Save poll'});
      savePollBtn.disabled=false;
      savePollBtn.innerHTML=defaultLabel;
      return;
    }

    // Build sanitized questions - all images should already be uploaded
    var sanitizedQuestions=questions.map(function(question){
      var answers=question.answers.map(function(answer){
        var text=(answer.text||'').trim();
        // Use imageFileId as canonical field (not URL)
        return{
          text:text,
          imageFileId:answer.imageFileId||null,
          imageURL:answer.imageURL||null  // Keep for backward compatibility
        };
      });

      var correctIndex=typeof question.correctAnswerIndex==='number'?question.correctAnswerIndex:0;
      if(correctIndex<0){correctIndex=0;}
      if(correctIndex>=answers.length){
        correctIndex=Math.max(0,answers.length-1);
      }

      var timerValue=null;
      if(typeof question.timerSeconds==='number'){
        timerValue=question.timerSeconds;
      } else if(typeof question.timerSeconds==='string'&&question.timerSeconds.trim()!==''){
        timerValue=parseInt(question.timerSeconds,10);
      }
      if(timerValue&&(!isFinite(timerValue)||timerValue<=0)){
        timerValue=null;
      }
      if(timerValue){
        timerValue=Math.min(Math.round(timerValue),600);
      }

      // Use questionImageFileId as canonical field (not URL)
      return{
        questionText:(question.questionText||'').trim(),
        questionImageFileId:question.questionImageFileId||null,
        questionImageURL:question.questionImageURL||null,  // Keep for backward compatibility
        answers:answers,
        correctAnswerIndex:correctIndex,
        timerSeconds:timerValue&&timerValue>0?timerValue:null,
        metacognitionEnabled:!!question.metacognitionEnabled
      };
    });

    try{
      var payloadQuestions=sanitizedQuestions.map(function(question){
        var options=question.answers.map(function(answer){
          var imageUrl=answer.imageURL||null;
          var imageFileId=answer.imageFileId||null;
          return{
            text:answer.text,
            image:imageUrl,
            imageURL:imageUrl,
            imageFileId:imageFileId
          };
        });
        var correctIndex=question.correctAnswerIndex;
        if(correctIndex<0||correctIndex>=options.length){
          correctIndex=Math.max(0,options.length-1);
        }
        var correctAnswerText=options[correctIndex]?options[correctIndex].text:null;
        var imageUrl=question.questionImageURL||null;
        var imageFileId=question.questionImageFileId||null;
        return{
          questionText:question.questionText,
          questionImage:imageUrl,
          questionImageURL:imageUrl,
          questionImageFileId:imageFileId,
          options:options,
          correctAnswer:correctAnswerText,
          timerSeconds:question.timerSeconds||null,
          metacognitionEnabled:!!question.metacognitionEnabled
        };
      });

      // Validate payload before sending
      if(!payloadQuestions||payloadQuestions.length===0){
        await veritasAlert('âŒ Error: No valid questions to save. Please check your poll data.',{title:'Save poll',destructive:true});
        savePollBtn.disabled=false;
        savePollBtn.innerHTML=defaultLabel;
        return;
      }

      // Capture question count immediately for success message
      var questionCount=payloadQuestions.length;
      console.log('Saving poll with '+questionCount+' questions');

      if(PREVIEW_MODE){
        var newPollRecord={
          pollId:editingPollId||('preview-poll-'+Date.now()),
          pollName:pollName,
          className:className,
          questions:payloadQuestions.map(function(q){
            return {
              questionText:q.questionText,
              options:q.options,
              correctAnswer:q.correctAnswer,
              timerSeconds:q.timerSeconds||null,
              metacognitionEnabled:!!q.metacognitionEnabled
            };
          }),
          updatedAt:new Date().toISOString(),
          lastRunAt:null,
          createdAt:new Date().toISOString()
        };
        if(editingPollId){
          var existingIndex=ALL_POLLS.findIndex(function(p){return p.pollId===editingPollId;});
          if(existingIndex!==-1){
            newPollRecord.createdAt=ALL_POLLS[existingIndex].createdAt||newPollRecord.createdAt;
            ALL_POLLS[existingIndex]=newPollRecord;
          }
        } else {
          ALL_POLLS.push(newPollRecord);
        }
        refreshPollData(ALL_POLLS);
        resetPollDirty('Preview changes saved');
        savePollBtn.disabled=false;
        savePollBtn.innerHTML=defaultLabel;
        closePollCreator();
        await veritasAlert('Poll saved locally for preview. Use the live dashboard to publish changes.',{title:'Save poll'});
        return;
      }

      var request=google.script.run
        .withSuccessHandler(async function(updatedPolls){
          // OPTIMIZATION: Invalidate cache when data changes
          LocalCache.invalidate('dashboardData');
          // Use the captured questionCount variable (not from server response)
          refreshPollData(updatedPolls);
          resetPollDirty('All changes saved');
          savePollBtn.disabled=false;
          savePollBtn.innerHTML=defaultLabel;

          // Generate success message with the count we know is correct
          var successMessage=editingPollId
            ?'âœ… Poll updated successfully with '+questionCount+' question'+(questionCount===1?'':'s')+'!'
            :'âœ… Poll created successfully with '+questionCount+' question'+(questionCount===1?'':'s')+'!';

          console.log(successMessage);

          var shouldSelectNew=!editingPollId;
          closePollCreator();
          if(shouldSelectNew){
            pollSelect.value='';
            onPollSelectChange();
          }
          await veritasAlert(successMessage,{title:'Save poll'});
        })
        .withFailureHandler(function(error){
          console.error('Poll save error:',error);
          handleError(error);
          savePollBtn.disabled=false;
          savePollBtn.innerHTML=defaultLabel;
        });

      if(editingPollId){
        request.updatePoll(editingPollId,pollName,className,payloadQuestions,sessionType,timeLimitMinutes);
      } else {
        request.createNewPoll(pollName,className,payloadQuestions,sessionType,timeLimitMinutes);
      }
    } catch(err){
      console.error('Upload/save error:',err);
      await veritasAlert('âŒ Upload error: '+(err.message||err),{title:'Save poll',destructive:true});
      savePollBtn.disabled=false;
      savePollBtn.innerHTML=defaultLabel;
    }
  }

  function fileToBase64(file){
    return new Promise(function(resolve,reject){
      // Validate file input
      if(!file){
        reject(new Error('No file provided'));
        return;
      }
      if(!(file instanceof File)){
        reject(new Error('Invalid file object'));
        return;
      }
      if(!file.type.startsWith('image/')){
        reject(new Error('File must be an image'));
        return;
      }
      if(file.size===0){
        reject(new Error('File is empty'));
        return;
      }
      if(file.size>5*1024*1024){
        reject(new Error('File exceeds 5MB limit'));
        return;
      }

      var reader=new FileReader();
      reader.readAsDataURL(file);
      reader.onload=function(){
        if(reader.result&&typeof reader.result==='string'){
          resolve(reader.result);
        } else {
          reject(new Error('Failed to read file data'));
        }
      };
      reader.onerror=function(error){
        reject(new Error('File read error: '+(error.message||'Unknown error')));
      };
    });
  }

  function uploadFile(file){
    return new Promise(function(resolve,reject){
      // Validate file before processing
      if(!file){
        reject(new Error('No file provided for upload'));
        return;
      }
      if(!file.name){
        reject(new Error('File has no name'));
        return;
      }

      fileToBase64(file).then(function(dataUrl){
        // Double-check dataUrl before sending
        if(!dataUrl||typeof dataUrl!=='string'){
          reject(new Error('Invalid data URL generated from file'));
          return;
        }

        if(PREVIEW_MODE){
          setTimeout(function(){
            resolve('preview-file-'+Date.now());
          },120);
          return;
        }

        google.script.run
          .withSuccessHandler(function(response){
            if(response&&response.success){
              // Server now returns fileId instead of url
              resolve(response.fileId);
            } else {
              reject(new Error(response.error||'Upload failed'));
            }
          })
          .withFailureHandler(function(error){
            reject(new Error('Server error: '+(error.message||error)));
          })
          .uploadImageToDrive(dataUrl,file.name);
      }).catch(function(error){
        reject(new Error('File conversion error: '+(error.message||error)));
      });
    });
  }

  // --- Utilities ---
  function formatDateTime(value){
    if(!value)return'â€”';
    var date=new Date(value);
    if(isNaN(date.getTime())){
      return value;
    }
    return date.toLocaleString();
  }

  function escapeHtml(text){
    if(!text)return'';
    var div=document.createElement('div');
    div.textContent=text;
    return div.innerHTML;
  }

  /**
   * Formats student names for roster/status displays.
   * Accepts either a student object (with first/last/display fields) or a raw string.
   * Prefers "First Last" when both are available, otherwise falls back to the most
   * descriptive identifier (display name, original string, or email).
   * @param {Object|string} student - Student object or name string
   * @returns {string} Formatted name
   */
  function formatStudentName(student){
    if(!student)return '';

    if(typeof student === 'string'){
      var raw=student.trim();
      if(!raw)return '';
      var pieces=raw.split(/\s+/).filter(Boolean);
      if(pieces.length>=2){
        return pieces[0]+' '+pieces[pieces.length-1];
      }
      return pieces[0]||'';
    }

    var first=(student.firstName||'').trim();
    var last=(student.lastName||'').trim();
    if(first||last){
      return (first+' '+last).trim();
    }

    if(student.displayName){
      return formatStudentName(student.displayName);
    }

    if(student.name){
      return formatStudentName(student.name);
    }

    if(student.email){
      return student.email;
    }

    return '';
  }

  async function handleError(error){
    mainLoader.style.display='none';
    console.error('Error:',error);
    await veritasAlert('Error: '+(error&&error.message?error.message:error),{
      title:'Something went wrong',
      destructive:true
    });
  }

  // Expand question image in modal
  window.expandQuestionImage=function(){
    var imgSrc=document.getElementById('live-question-image').src;
    var modalHtml='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;" onclick="this.remove()">';
    modalHtml+='<img src="'+imgSrc+'" style="max-width:90%;max-height:90%;"/>';
    modalHtml+='</div>';
    document.body.insertAdjacentHTML('beforeend',modalHtml);
  };

  // Post-Poll Analytics Modal Event Handlers
  var viewAnalyticsBtn = document.getElementById('view-analytics-btn');
  if (viewAnalyticsBtn) {
    viewAnalyticsBtn.addEventListener('click', function() {
      if (selectedArchivedPollId) {
        openPostPollAnalytics(selectedArchivedPollId);
      }
    });
  }

  var closeAnalyticsBtn = document.getElementById('close-analytics-modal-btn');
  if (closeAnalyticsBtn) {
    closeAnalyticsBtn.addEventListener('click', function() {
      document.getElementById('post-poll-analytics-modal').style.display = 'none';
    });
  }

  // Close modal on backdrop click
  document.getElementById('post-poll-analytics-modal').addEventListener('click', function(e) {
    if (e.target === this) {
      this.style.display = 'none';
    }
  });

  // Student Status Filter Buttons
  var filterLockedBtn = document.getElementById('filter-locked-only-btn');
  if (filterLockedBtn) {
    filterLockedBtn.addEventListener('click', function() {
      studentStatusFilter = 'locked';
      var statusSelect=document.getElementById('student-status-filter-select');
      if(statusSelect){
        statusSelect.value='locked';
      }
      syncStatusFilterButtons();
      renderStudentStatus();
    });
  }

  var filterAllBtn = document.getElementById('filter-all-btn');
  if (filterAllBtn) {
    filterAllBtn.addEventListener('click', function() {
      studentStatusFilter = 'all';
      var statusSelect=document.getElementById('student-status-filter-select');
      if(statusSelect){
        statusSelect.value='all';
      }
      syncStatusFilterButtons();
      renderStudentStatus();
    });
  }

  syncStatusFilterButtons();

  // Violations Alert Dismiss Button
  var dismissViolationsBtn = document.getElementById('dismiss-violations-alert');
  if (dismissViolationsBtn) {
    dismissViolationsBtn.addEventListener('click', function() {
      violationsAlertDismissed = true;
      document.getElementById('violations-alert-panel').classList.add('hidden');
    });
  }

  // Enhanced exited students panel event listeners (2025)
  var approveAllBtn = document.getElementById('approve-all-unlocks-btn');
  if (approveAllBtn) {
    approveAllBtn.addEventListener('click', approveAllUnlocks);
  }

  var toggleExitedPanelBtn = document.getElementById('toggle-exited-panel-btn');
  if (toggleExitedPanelBtn) {
    toggleExitedPanelBtn.addEventListener('click', function() {
      var list = document.getElementById('exited-students-list-inline');
      if (!list) return;

      var icon = this.querySelector('.material-symbols-outlined');
      if (list.style.display === 'none') {
        list.style.display = '';
        if (icon) {
          icon.textContent = 'expand_more';
        }
      } else {
        list.style.display = 'none';
        if (icon) {
          icon.textContent = 'expand_less';
        }
      }
    });
  }

  // ==========================================================================
  // ENHANCED UI FEATURES (2025 Redesign)
  // ==========================================================================

  // Quick Time Preset Buttons (+30s, +1m)
  var add30sBtn = document.getElementById('add-30s-btn');
  if (add30sBtn) {
    add30sBtn.addEventListener('click', function() {
      if (!isRunning) {
        editTime(30);
      }
    });
  }

  var add60sBtn = document.getElementById('add-60s-btn');
  if (add60sBtn) {
    add60sBtn.addEventListener('click', function() {
      if (!isRunning) {
        editTime(60);
      }
    });
  }

  // Card/Table View Toggle for Dashboard
  var viewCardsBtn = document.getElementById('view-cards-btn');
  var viewTableBtn = document.getElementById('view-table-btn');
  var pollsCardView = document.getElementById('polls-card-view');
  var pollsTableView = document.getElementById('polls-table-view');

  if (viewCardsBtn && viewTableBtn && pollsCardView && pollsTableView) {
    // Default to card view
    viewCardsBtn.classList.add('active');

    viewCardsBtn.addEventListener('click', function() {
      pollsCardView.classList.remove('hidden');
      pollsTableView.classList.add('hidden');
      viewCardsBtn.classList.add('active');
      viewTableBtn.classList.remove('active');
      localStorage.setItem('vlp_poll_view', 'cards');
    });

    viewTableBtn.addEventListener('click', function() {
      pollsCardView.classList.add('hidden');
      pollsTableView.classList.remove('hidden');
      viewTableBtn.classList.add('active');
      viewCardsBtn.classList.remove('active');
      localStorage.setItem('vlp_poll_view', 'table');
    });

    // Restore saved view preference
    var savedView = localStorage.getItem('vlp_poll_view');
    if (savedView === 'table') {
      viewTableBtn.click();
    }
  }

  // Keyboard Shortcuts for Live Poll Session
  document.addEventListener('keydown', function(e) {
    // Only activate shortcuts when NOT typing in an input/textarea
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
      return;
    }

    // Only during live session
    if (!isLiveSession) return;

    switch(e.key) {
      case 'ArrowRight':
      case 'n':
      case 'N':
        // Next Question
        e.preventDefault();
        var nextBtn = document.getElementById('header-next-btn');
        if (nextBtn && !nextBtn.disabled && nextBtn.offsetParent !== null) {
          nextBtn.click();
        }
        break;

      case 'ArrowLeft':
      case 'b':
      case 'B':
        // Back/Previous Question
        e.preventDefault();
        var backBtn = document.getElementById('header-back-btn');
        if (backBtn && !backBtn.disabled && backBtn.offsetParent !== null) {
          backBtn.click();
        }
        break;

      case ' ':
      case 'Spacebar':
        // Toggle Timer (Start/Pause)
        e.preventDefault();
        if (isRunning) {
          pauseTimer();
        } else if (totalSeconds > 0) {
          startTimer();
        }
        break;

      case 'r':
      case 'R':
        // Reset Timer
        e.preventDefault();
        if (!isRunning) {
          resetTimer();
        }
        break;

      case 'e':
      case 'E':
        // End & Reveal
        e.preventDefault();
        var endShowBtn = document.getElementById('header-end-show-btn');
        if (endShowBtn && !endShowBtn.disabled && endShowBtn.offsetParent !== null) {
          endShowBtn.click();
        }
        break;
    }
  });

  // Auto-Pulse "Next Question" Button When All Responded
  // This is called from renderStudentStatus when all students have answered
  window.checkAllRespondedState = function(remainingSeconds) {
    if (!isLiveSession) return;

    var nextBtn = document.getElementById('header-next-btn');
    var allRespondedBanner = document.getElementById('all-responded-banner');

    if (!nextBtn) return;

    // Check if all-responded banner is visible
    if (allRespondedBanner && !allRespondedBanner.classList.contains('hidden')) {
      // Add pulsing effect to Next button
      nextBtn.classList.add('pulse-ready');

      var timeSavedBadge = document.getElementById('time-saved-badge');
      var timeSavedAmount = document.getElementById('time-saved-amount');
      if (timeSavedBadge && timeSavedAmount) {
        var safeRemaining = typeof remainingSeconds === 'number' ? Math.max(0, Math.round(remainingSeconds)) : 0;
        if (safeRemaining > 0) {
          timeSavedAmount.textContent = safeRemaining;
          timeSavedBadge.classList.remove('hidden');
        } else {
          timeSavedBadge.classList.add('hidden');
        }
      }
    } else {
      // Remove pulsing effect
      nextBtn.classList.remove('pulse-ready');

      // Hide time saved badge
      var timeSavedBadge = document.getElementById('time-saved-badge');
      if (timeSavedBadge) {
        timeSavedBadge.classList.add('hidden');
      }
    }
  };

  console.log('âœ“ Teacher Panel Ready (Enhanced UI)');
})();
  </script>
  
</body>
</html>
