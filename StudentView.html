<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veritas Live Poll - Student</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            // Veritas Brand Colors (Primary Design System)
            "veritas-navy": "#12385d",
            "veritas-gold": "#c5a05a",
            primary: "#12385d",
            // Supporting Brand Colors
            "brand-white": "#ffffff",
            "brand-light-gray": "#d9e0e7",
            "brand-dark-gray": "#242424",
            "background-light": "#f7f8fa",
            "background-dark": "#0f1723",
            // Semantic Colors
            "success-green": "#1b5e20",
            "success-bg": "#e8f5ec",
            "error-red": "#c62828",
            "text-primary": "#111111",
            "text-secondary": "#4b5563",
            "text-muted": "#6b7280"
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
            serif: ["Noto Serif", "serif"]
          },
          borderRadius: {
            DEFAULT: "0.25rem",
            lg: "0.5rem",
            xl: "0.75rem",
            "2xl": "1rem",
            full: "9999px"
          },
          spacing: {
            '18': '4.5rem',
            '88': '22rem',
            '128': '32rem'
          },
          animation: {
            'fade-in': 'fade-in 0.6s ease-out forwards',
            'spin-slow': 'spin 3s linear infinite',
            'pulse-dot': 'pulse-dot 1.2s ease-in-out infinite'
          },
          keyframes: {
            'fade-in': {
              'from': { opacity: '0', transform: 'translateY(10px)' },
              'to': { opacity: '1', transform: 'translateY(0)' }
            },
            'pulse-dot': {
              '0%, 80%, 100%': { opacity: '0.25', transform: 'scale(0.85)' },
              '40%': { opacity: '1', transform: 'scale(1)' }
            }
          }
        }
      }
    };
  </script>
  <?!= include('SecureAssessmentShared'); ?>
  <script>window.SESSION_TOKEN = '<?= sessionToken ?>';</script>
  <style>
    /* Veritas Design System - CSS Custom Properties */
    :root {
      /* Brand Colors */
      --veritas-navy: #12385d;
      --veritas-gold: #c5a05a;
      --brand-white: #ffffff;
      --brand-light-gray: #d9e0e7;
      --brand-dark-gray: #242424;

      /* Background Colors */
      --bg-light: #f7f8fa;
      --bg-dark: #0f1723;
      --bg-card: #ffffff;

      /* Text Colors */
      --text-primary: #111111;
      --text-secondary: #4b5563;
      --text-muted: #6b7280;
      --text-on-navy: #ffffff;

      /* Semantic Colors */
      --success-green: #1b5e20;
      --success-bg: #e8f5ec;
      --error-red: #c62828;

      /* Opacity Modifiers */
      --navy-10: rgba(18, 56, 93, 0.1);
      --navy-12: rgba(18, 56, 93, 0.12);
      --gold-08: rgba(197, 160, 90, 0.08);

      /* Spacing Scale (following 8px baseline) */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --space-2xl: 48px;

      /* Border Radius */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 14px;
      --radius-full: 9999px;
    }

    body.secure-overlay-active {
      overflow: hidden;
    }

    .secure-topbar-timer {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 5px 11px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.35);
      background: rgba(4, 12, 30, 0.45);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
    }

    .secure-topbar-time {
      font-size: 1.45rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: #fff;
    }

    .student-card {
      width: min(98vw, 1600px);
      margin: 16px auto;
      background: var(--bg-card);
      color: var(--text-primary);
      border-radius: var(--radius-md);
      border-top: 4px solid var(--veritas-gold);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      max-width: 100%;
    }

    .student-card.results-stage,
    .student-card.showing-results {
      background: var(--bg-card);
    }

    .student-card-header {
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 10px 17px 7px;
      border-bottom: 1px solid var(--navy-12);
      background: linear-gradient(135deg, rgba(18, 56, 93, 0.06), var(--gold-08));
      backdrop-filter: blur(8px);
    }

    .student-question-number {
      font-size: 0.85rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--veritas-navy);
      font-weight: 600;
    }

    .student-card-body {
      padding: 12px 12px 7px;
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: flex-start;
      max-width: 100%;
      overflow-x: hidden;
    }

    .student-card-body-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 0;
      max-width: 100%;
      overflow: hidden;
    }

    .student-question-image {
      width: 300px;
      height: 300px;
      object-fit: contain;
      border-radius: var(--radius-md);
      border: 1px solid var(--navy-12);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      flex-shrink: 0;
      cursor: pointer;
      transition: transform 200ms ease, box-shadow 200ms ease;
    }

    .student-question-image:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }


    .student-card-options {
      padding: 7px 12px 17px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 100%;
      overflow-x: hidden;
    }

    .student-pre-live-card {
      max-width: 720px;
      text-align: center;
    }

    .secure-session-card {
      position: relative;
      width: min(98vw, 1600px);
      max-width: 100%;
      margin: clamp(8px, 2vw, 20px) auto;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(18, 56, 93, 0.12);
      box-shadow: 0 25px 70px rgba(15, 23, 42, 0.18);
      min-height: calc(100vh - 200px);
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    .secure-session-header {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(18, 56, 93, 0.1);
      background: linear-gradient(120deg, rgba(18, 56, 93, 0.08), rgba(197, 160, 90, 0.12));
    }

    .secure-session-meta {
      font-size: 0.8rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    .secure-session-progress {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .secure-connection-dot {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      box-shadow: 0 0 12px rgba(18, 56, 93, 0.35);
    }

    .secure-connection-warning {
      padding: 8px 19px;
      background: #fffbeb;
      color: #92400e;
      border-top: 1px solid #fef3c7;
      border-bottom: 1px solid #fef3c7;
      font-weight: 500;
    }

    .secure-session-body {
      padding: clamp(12px, 1.5vw, 19px);
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
      max-width: 100%;
      overflow-x: hidden;
    }

    .secure-question-pane {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 100%;
      overflow: hidden;
    }

    .secure-question-pane .student-stem {
      font-size: 1.2rem;
      line-height: 1.6;
      font-weight: 400;
      color: var(--text-primary);
      margin: 0;
      text-align: left;
    }

    .secure-question-pane .student-question-image {
      width: 100%;
      max-width: 360px;
      max-height: 320px;
      margin-top: 8px;
      cursor: zoom-in;
    }

    .secure-options-pane {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 100%;
      overflow: hidden;
    }

    .secure-options-pane .student-choices {
      gap: 14px;
    }

    .secure-answer-option .option-text {
      font-size: 1.02rem;
    }

    .secure-answer-option .letter-badge {
      width: 42px;
      height: 42px;
    }

    .secure-session-footer {
      padding: 14px 19px 19px;
      border-top: 1px solid rgba(18, 56, 93, 0.08);
      background: rgba(18, 56, 93, 0.02);
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }

    @media (max-width: 1023px) {
      .secure-session-body {
        flex-direction: column;
      }

      .secure-session-footer {
        align-items: stretch;
      }

      .secure-submit-btn {
        width: 100%;
      }
    }

    @media (max-height: 760px) {
      .secure-session-card {
        min-height: auto;
      }
    }

    .secure-connection-indicator {
      position: fixed;
      top: 110px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(15, 23, 42, 0.4);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      color: #fff;
      z-index: 30;
    }

    .secure-submit-btn {
      width: 100%;
      max-width: 240px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      background: linear-gradient(135deg, #12385d, #1b4c7a);
      color: #fff;
      font-weight: 600;
      font-size: 1.05rem;
      letter-spacing: 0.03em;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .secure-submit-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 15px 30px rgba(18, 56, 93, 0.2);
    }

    .secure-submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .secure-submit-hint {
      margin-top: 4px;
      font-size: 0.95rem;
      color: rgba(18, 56, 93, 0.7);
      text-align: right;
      width: 100%;
    }

    .secure-lobby-card {
      border-radius: 32px;
      border: 1px solid rgba(18, 56, 93, 0.08);
      background: #ffffff;
      color: #0f172a;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
    }

    .secure-lobby-chip {
      display: flex;
      flex-direction: column;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(18, 56, 93, 0.03);
      min-width: 150px;
    }

    .secure-rules-list li {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 0.95rem;
      color: #334155;
    }

    .student-pre-live-body {
      align-items: center;
      gap: 18px;
    }

    .student-pre-live-icon {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: var(--navy-10);
      color: var(--veritas-navy);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.4rem;
      margin: 0 auto;
    }

    .student-pre-live-footer {
      align-items: center;
      gap: 16px;
    }

    .student-pre-live-status {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      letter-spacing: 0.28em;
      color: var(--veritas-navy);
      font-size: 0.75rem;
    }

    .student-pre-live-label {
      font-weight: 700;
    }

    .student-pre-live-pips {
      display: inline-flex;
      gap: 6px;
    }

    .student-pre-live-pips .pip {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(18, 56, 93, 0.35);
      animation: pulse-dot 1.2s ease-in-out infinite;
    }

    .student-pre-live-reconnect {
      font-size: 0.9rem;
      color: var(--error-red);
      margin: 0;
    }

    .student-stem {
      font-size: 1.2rem;
      line-height: 1.6;
      font-weight: 400;
      color: var(--text-primary);
      margin: 0;
      text-align: left;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      max-width: 100%;
    }

    .student-subline {
      font-size: 0.95rem;
      color: rgba(17, 17, 17, 0.72);
      margin: 0;
    }

    .student-no-responses {
      font-size: 0.95rem;
      font-style: italic;
      color: var(--veritas-navy);
      text-align: left;
      margin: 0;
    }

    .student-choices {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 100%;
      overflow: hidden;
    }

    .student-choices li {
      list-style: none;
      margin: 0 !important;
      padding: 0 !important;
      line-height: 1;
    }

    .student-card img {
      max-width: 100%;
      height: auto;
      border-radius: var(--radius-md);
      border: 1px solid var(--navy-12);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    }

    .answer-option {
      position: relative;
      width: 100%;
      max-width: 100%;
      text-align: left;
      display: flex;
      align-items: flex-start;
      gap: 18px;
      background: var(--bg-card);
      color: var(--text-primary);
      border-radius: var(--radius-md);
      border: 1px solid rgba(18, 56, 93, 0.18);
      padding: 12px 13px;
      box-shadow: 0 2px 8px rgba(18, 56, 93, 0.08);
      transition: border-color 200ms ease, box-shadow 200ms ease, transform 200ms ease, background-color 200ms ease;
      cursor: pointer;
      appearance: none;
      box-sizing: border-box;
      overflow: hidden;
    }

    .answer-option:hover {
      border-color: var(--veritas-navy);
      box-shadow: 0 6px 18px rgba(18, 56, 93, 0.16);
      transform: translateY(-1px);
    }

    .answer-option:focus-visible {
      outline: 3px solid rgba(18, 56, 93, 0.4);
      outline-offset: 2px;
    }

    .answer-option.result-readonly {
      pointer-events: none;
      cursor: default !important;
      box-shadow: 0 2px 6px rgba(18, 56, 93, 0.05);
    }

    .answer-option.answer-option-disabled {
      opacity: 0.55;
      pointer-events: none;
      cursor: default;
      box-shadow: 0 2px 6px rgba(18, 56, 93, 0.05);
    }

    .answer-option .result-indicator {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: var(--radius-full);
      font-size: 0.95rem;
      font-weight: 700;
      background-color: rgba(18, 56, 93, 0.08);
      color: var(--veritas-navy);
      opacity: 0;
      transform: scale(0.85);
      position: absolute;
      top: 16px;
      right: 18px;
      transition: opacity 220ms ease, transform 220ms ease, background-color 220ms ease, color 220ms ease;
    }

    #question-container.showing-results .answer-option .result-indicator {
      opacity: 1;
      transform: scale(1);
    }

    .answer-option .letter-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background-color: rgba(18, 56, 93, 0.08);
      border: 1px solid rgba(18, 56, 93, 0.22);
      color: var(--veritas-navy);
      font-weight: 600;
      font-size: 1.05rem;
      transition: background-color 220ms ease, border-color 220ms ease, color 220ms ease, transform 220ms ease;
    }

    .answer-option .option-leading {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      align-self: flex-start;
    }

    .answer-option .option-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0;
      min-width: 0;
      max-width: 100%;
      justify-content: flex-start;
      overflow: hidden;
    }

    .answer-option .option-text {
      color: #1c1c1c;
      font-size: 1.05rem;
      line-height: 1.6;
      font-family: "Inter", sans-serif;
      margin: 0;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      max-width: 100%;
    }

    .answer-option .option-image {
      max-width: min(300px, 100%);
      width: 100%;
      height: auto;
      border-radius: var(--radius-md);
      border: 1px solid rgba(18, 56, 93, 0.16);
      box-shadow: 0 3px 10px rgba(18, 56, 93, 0.12);
      margin-bottom: 12px;
      cursor: pointer;
      transition: transform 200ms ease, box-shadow 200ms ease;
    }

    .answer-option .option-image:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 16px rgba(18, 56, 93, 0.16);
    }

    .answer-option .result-ribbon {
      font-size: 0.9rem;
      font-weight: 600;
      align-self: flex-end;
      color: var(--veritas-navy);
      display: none;
    }

    .answer-option .result-ribbon.is-visible {
      display: inline-flex;
      margin-top: 8px;
    }

    .answer-option.result-correct .result-ribbon {
      color: var(--success-green);
    }

    .answer-option.result-incorrect .result-ribbon {
      color: var(--text-secondary);
    }

    #question-container.results-stage .answer-option {
      pointer-events: none;
      cursor: default !important;
    }

    #question-container.showing-results .answer-option {
      transition: background-color 240ms ease, border-color 240ms ease, color 240ms ease, box-shadow 240ms ease;
    }

    .answer-option.answer-option-selected {
      border-color: var(--veritas-navy);
      box-shadow: 0 0 0 3px rgba(18, 56, 93, 0.2);
    }

    .answer-option.answer-option-selected .letter-badge {
      background-color: var(--veritas-navy);
      border-color: var(--veritas-navy);
      color: var(--brand-white);
      transform: scale(1.02);
    }

    .answer-option.answer-option-selected .option-text {
      color: var(--veritas-navy);
    }

    .answer-option.result-correct {
      background-color: var(--success-bg) !important;
      border-color: #2e7d32 !important;
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.2);
    }

    .answer-option.result-correct .letter-badge {
      background-color: rgba(46, 125, 50, 0.18) !important;
      border-color: rgba(46, 125, 50, 0.4) !important;
      color: var(--success-green) !important;
    }

    .answer-option.result-correct .option-text {
      color: var(--success-green) !important;
    }

    .answer-option.result-correct .result-indicator {
      background-color: rgba(46, 125, 50, 0.2);
      color: var(--success-green);
    }

    .answer-option.result-incorrect {
      background-color: #f5f6f8 !important;
      border-color: rgba(17, 24, 39, 0.12) !important;
      color: #1c1c1c !important;
      box-shadow: none;
    }

    .answer-option.result-incorrect .letter-badge {
      background-color: rgba(18, 56, 93, 0.06) !important;
      border-color: rgba(18, 56, 93, 0.16) !important;
      color: var(--veritas-navy) !important;
    }

    .answer-option.result-incorrect .result-indicator {
      background-color: rgba(244, 67, 54, 0.12);
      color: var(--error-red);
    }

    .answer-option.result-incorrect.result-your-choice {
      border-color: rgba(198, 40, 40, 0.45) !important;
      box-shadow: 0 0 0 2px rgba(198, 40, 40, 0.15);
    }

    .answer-option.result-your-choice .option-text {
      color: var(--error-red) !important;
    }

    .prevent-select {
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    .prevent-select button,
    .prevent-select .material-symbols-outlined {
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .student-card img,
    .student-card video,
    .student-card figure {
      max-width: 100%;
      height: auto;
    }

    .veritas-modal-root {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .veritas-modal-root.is-active {
      display: flex;
    }

    .veritas-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(9, 17, 34, 0.55);
      backdrop-filter: blur(3px);
    }

    .veritas-modal-dialog {
      position: relative;
      z-index: 1;
      width: min(520px, 92vw);
      border-radius: 16px;
      background: var(--bg-card);
      border-top: 4px solid var(--veritas-gold);
      box-shadow: 0 24px 48px rgba(9, 17, 34, 0.25);
      padding: 17px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      animation: veritas-modal-in 220ms ease;
    }

    .veritas-modal-header h2 {
      margin: 0;
      font-size: 1.25rem;
      color: var(--veritas-navy);
      font-weight: 700;
    }

    .veritas-modal-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
      color: var(--text-primary);
      font-size: 0.98rem;
      line-height: 1.55;
    }

    .veritas-modal-subtext {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .veritas-modal-input {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .veritas-modal-input input {
      border-radius: 10px;
      border: 1px solid rgba(18, 56, 93, 0.28);
      padding: 6px 7px;
      font-size: 0.95rem;
      transition: border-color 160ms ease, box-shadow 160ms ease;
    }

    .veritas-modal-input input:focus-visible {
      outline: none;
      border-color: var(--veritas-navy);
      box-shadow: 0 0 0 3px rgba(18, 56, 93, 0.2);
    }

    .veritas-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }

    .veritas-modal-button {
      border: none;
      border-radius: 999px;
      padding: 6px 13px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 140ms ease, box-shadow 140ms ease, background-color 140ms ease, color 140ms ease;
    }

    .veritas-modal-button.primary {
      background: var(--veritas-navy);
      color: var(--brand-white);
      box-shadow: 0 8px 20px rgba(18, 56, 93, 0.25);
    }

    .veritas-modal-button.primary:hover:not([disabled]) {
      background: #0f2d4a;
      transform: translateY(-1px);
    }

    .veritas-modal-button.secondary {
      background: transparent;
      color: var(--veritas-navy);
      border: 1px solid rgba(18, 56, 93, 0.3);
    }

    .veritas-modal-button.secondary:hover:not([disabled]) {
      background: rgba(18, 56, 93, 0.08);
    }

    .veritas-modal-button.destructive {
      background: var(--error-red);
      color: var(--brand-white);
      box-shadow: 0 8px 18px rgba(198, 40, 40, 0.25);
    }

    .veritas-modal-button.destructive:hover:not([disabled]) {
      background: #a61b1b;
    }

    .veritas-modal-button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .veritas-modal-spinner {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.6);
      border-top-color: transparent;
      animation: veritas-spin 0.7s linear infinite;
      display: none;
      margin-left: 10px;
    }

    .veritas-modal-button.loading .veritas-modal-spinner {
      display: inline-block;
    }

    .veritas-modal-button.loading span {
      opacity: 0.75;
    }

    .dark .veritas-modal-dialog {
      background: rgba(15, 23, 35, 0.96);
      color: #e2e8f0;
      border-top-color: #c5a05a;
      box-shadow: 0 24px 48px rgba(2, 6, 23, 0.55);
    }

    .dark .veritas-modal-header h2 {
      color: #f8fafc;
    }

    .dark .veritas-modal-body {
      color: #f1f5f9;
    }

    .dark .veritas-modal-subtext {
      color: #cbd5f5;
    }

    .dark .veritas-modal-input input {
      background: rgba(15, 23, 42, 0.7);
      border-color: rgba(148, 163, 184, 0.4);
      color: #f8fafc;
    }

    .dark .veritas-modal-input input:focus-visible {
      border-color: #93c5fd;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35);
    }

    .dark .veritas-modal-button.secondary {
      color: #e2e8f0;
      border-color: rgba(148, 163, 184, 0.4);
    }

    .dark .veritas-modal-button.secondary:hover:not([disabled]) {
      background: rgba(148, 163, 184, 0.16);
    }

    .dark .veritas-modal-button.primary {
      background: #234776;
    }

    .dark .veritas-modal-button.primary:hover:not([disabled]) {
      background: #1a3456;
    }

    .dark .veritas-modal-backdrop {
      background: rgba(2, 6, 23, 0.7);
      backdrop-filter: blur(4px);
    }

    body.veritas-modal-open {
      overflow: hidden;
    }

    @keyframes veritas-modal-in {
      from {
        opacity: 0;
        transform: translateY(16px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes veritas-spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 480px) {
      .student-card {
        width: min(98vw, 480px);
        margin: 12px auto;
      }

      .student-card-header {
        padding: 8px 12px 6px;
      }

      .student-card-body {
        padding: 13px 12px 5px;
      }

      .student-card-options {
        padding: 5px 12px 13px;
        gap: 10px;
      }

      .answer-option {
        flex-direction: column;
        align-items: stretch;
      }

      .answer-option .letter-badge {
        width: 40px;
        height: 40px;
      }

      .veritas-modal-dialog {
        width: min(98vw, 480px);
        padding: 13px;
        gap: 16px;
      }

      .veritas-modal-actions {
        width: 100%;
        justify-content: stretch;
      }

      .veritas-modal-button {
        flex: 1;
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Student Landing Page Animations */
    @keyframes drawLine {
      from {
        transform: scaleX(0);
      }
      to {
        transform: scaleX(1);
      }
    }

    @keyframes shimmerBg {
      0% {
        background-position: -1000px 0;
      }
      100% {
        background-position: 1000px 0;
      }
    }

    @keyframes floatParticle {
      0%, 100% {
        transform: translateY(0) translateX(0);
        opacity: 0.4;
      }
      50% {
        transform: translateY(-20px) translateX(10px);
        opacity: 0.8;
      }
    }

    @keyframes pulseDot {
      0%, 80%, 100% {
        opacity: 0.3;
        transform: scale(1);
      }
      40% {
        opacity: 1;
        transform: scale(1.2);
      }
    }

    .shimmer-particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: radial-gradient(circle, #c5a05a, transparent);
      border-radius: 50%;
      animation: floatParticle 6s ease-in-out infinite;
      pointer-events: none;
    }

    .waiting-dots .dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      margin: 0 4px;
      background: #12385d;
      border-radius: 50%;
      animation: pulseDot 1.4s ease-in-out infinite;
    }

    .waiting-dots .dot:nth-child(1) { animation-delay: 0s; }
    .waiting-dots .dot:nth-child(2) { animation-delay: 0.2s; }
    .waiting-dots .dot:nth-child(3) { animation-delay: 0.4s; }
  </style>
</head>
<body class="font-display bg-gradient-to-br from-veritas-navy via-[#1a4a73] to-[#2a5a83] text-white min-h-screen">
  <!-- Header - Subtle overlay style -->
  <header class="fixed top-0 left-0 right-0 z-50 flex items-center justify-between px-6 py-4 bg-gradient-to-br from-veritas-navy/95 via-[#1a4a73]/95 to-[#2a5a83]/95 backdrop-blur-sm">
    <div class="flex items-center gap-3">
      <img alt="Malvern Prep Logo" class="h-12 w-auto" src="https://raw.githubusercontent.com/stephenborish/veritasassets/main/Malvern%20Logo.png"/>
      <div class="flex flex-col">
        <h1 class="text-white text-xl font-extrabold tracking-[0.15em] uppercase">Veritas</h1>
        <p id="student-mode-label" class="text-white/70 text-xs tracking-wide">Live Poll</p>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <div id="secure-topbar-timer" class="secure-topbar-timer hidden">
        <div class="flex flex-col text-right leading-tight">
          <span class="text-[0.6rem] uppercase tracking-[0.35em] text-white/70">Time Remaining</span>
          <span id="secure-countdown" class="secure-topbar-time">00:00</span>
        </div>
      </div>
      <div id="loader" class="loader" style="display: none;">
        <div class="h-6 w-6 animate-spin rounded-full border-2 border-white/80 border-t-transparent"></div>
      </div>
    </div>
  </header>

  <main class="flex flex-col items-center justify-center min-h-screen p-6 pt-24 space-y-4">
    <div id="connectivity-banner" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-lg flex items-center gap-3 rounded-xl border border-amber-300 bg-amber-50 px-4 py-3 text-amber-800 shadow-lg transition-all duration-200 backdrop-blur-sm">
      <span id="connectivity-icon" class="material-symbols-outlined text-2xl">sync</span>
      <div class="flex flex-col text-left flex-1">
        <span id="connectivity-message" class="text-sm font-semibold">Reconnecting... your poll data is catching up.</span>
        <span id="connectivity-submessage" class="text-xs text-amber-700/80 opacity-0"></span>
      </div>
    </div>
    <!-- Entry Screen - Clean Professional Landing Panel -->
    <div id="entry-screen" class="w-full max-w-4xl mx-auto text-center animate-fade-in px-6">
      <!-- Main Welcome Card -->
      <div class="bg-white rounded-3xl shadow-2xl border border-gray-100 p-12 sm:p-16 relative">
        <!-- Decorative accent bar -->
        <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-24 h-1.5 bg-gradient-to-r from-transparent via-[#c5a05a] to-transparent rounded-full"></div>

        <!-- Logo/Brand Icon -->
        <div class="mb-8">
          <div class="w-20 h-20 mx-auto rounded-2xl flex items-center justify-center mb-6" style="background: linear-gradient(135deg, #12385d 0%, #1a4a75 100%);">
            <span class="material-symbols-outlined text-5xl text-white">fact_check</span>
          </div>
        </div>

        <!-- Welcome Message -->
        <div class="mb-10">
          <h1 class="text-5xl sm:text-6xl font-bold mb-6" style="color: #12385d; letter-spacing: -0.02em;">
            Welcome to <span style="color: #c5a05a;">VERITAS</span>
          </h1>
          <p class="text-lg text-gray-600 leading-relaxed max-w-xl mx-auto">
            Your live polling session is ready. Click below to begin and participate in real-time.
          </p>
        </div>

        <!-- Begin Button -->
        <button id="start-session-btn" class="relative inline-flex items-center justify-center gap-3 px-12 py-4 rounded-xl text-white text-lg font-semibold transition-all duration-200 hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0 focus:outline-none focus:ring-4 focus:ring-[#12385d]/20" style="background: linear-gradient(135deg, #12385d 0%, #1a4a75 100%); z-index: 10;">
          <span class="material-symbols-outlined text-2xl">play_arrow</span>
          <span>Begin Poll</span>
        </button>

        <!-- Session Info -->
        <div class="mt-10 pt-8 border-t border-gray-100">
          <div class="flex items-center justify-center gap-2 text-sm text-gray-500">
            <span class="material-symbols-outlined text-lg">info</span>
            <span>This session will enter fullscreen mode for your focus</span>
          </div>
        </div>
      </div>
    </div>


    <!-- Student App Container -->
    <div class="w-full max-w-6xl mx-auto" id="student-container" style="display: none;">
      <div id="student-loader" class="text-center py-12 animate-fade-in" style="display: block;">
        <div class="h-16 w-16 animate-spin rounded-full border-4 border-white/30 border-t-white mx-auto mb-4"></div>
        <p class="text-white/90 text-lg">Preparing your secure session...</p>
      </div>

      <section id="secure-lobby" class="secure-lobby-card animate-fade-in" style="display: none;">
        <div class="px-8 sm:px-12 py-8 border-b border-slate-100">
          <p class="text-xs font-semibold tracking-[0.3em] text-veritas-navy/70 uppercase">Secure Assessment</p>
          <h2 id="secure-lobby-title" class="text-3xl sm:text-4xl font-semibold text-veritas-navy mt-2">Secure Assessment</h2>
          <p id="secure-lobby-summary" class="text-base text-slate-500 mt-2"></p>
        </div>
        <div class="px-8 sm:px-12 py-8 grid gap-8 lg:grid-cols-2">
          <div class="space-y-6">
            <div class="flex flex-wrap gap-4">
              <div class="secure-lobby-chip">
                <span class="text-xs font-semibold tracking-wide text-slate-500 uppercase">Time Limit</span>
                <span id="secure-lobby-time" class="text-2xl font-semibold text-veritas-navy mt-1">--</span>
              </div>
              <div class="secure-lobby-chip">
                <span class="text-xs font-semibold tracking-wide text-slate-500 uppercase">Questions</span>
                <span id="secure-lobby-questions" class="text-2xl font-semibold text-veritas-navy mt-1">--</span>
              </div>
            </div>
            <p id="secure-window-message" class="text-sm text-slate-500"></p>
          </div>
          <div id="secure-access-code-group" class="space-y-2" style="display: none;">
            <label for="secure-access-code" class="text-sm font-semibold text-slate-600">Access Code</label>
            <input id="secure-access-code" type="text" inputmode="text" autocomplete="off" maxlength="16" class="w-full rounded-2xl border border-slate-200 px-4 py-3 text-lg font-semibold tracking-[0.4em] text-center uppercase focus:border-veritas-navy focus:ring-2 focus:ring-veritas-navy/30" placeholder="ENTER CODE" />
            <p id="secure-access-code-error" class="text-sm text-red-600 hidden"></p>
          </div>
        </div>
        <div class="px-8 sm:px-12 pb-10 flex flex-col gap-4">
          <button id="secure-begin-btn" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-veritas-navy px-8 py-4 text-white text-lg font-semibold shadow-lg transition hover:-translate-y-0.5 hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-veritas-navy/30">
            <span class="material-symbols-outlined text-xl">fullscreen</span>
            <span id="secure-begin-label">Begin Assessment</span>
          </button>
          <p class="text-xs text-slate-500">Going fullscreen is required. Your teacher is monitoring for tab switches and disconnects.</p>
          <ul id="secure-rules-list" class="secure-rules-list space-y-3"></ul>
        </div>
      </section>

      <!-- Pre-Live Card - Redesigned Waiting Screen -->
      <section id="pre-live-card" class="student-card student-pre-live-card text-center animate-fade-in" style="display: none; max-width: 900px; background: white; color: #111;">
        <div class="student-card-body student-pre-live-body" style="padding: 29px 19px;">
          <!-- Animated Icon -->
          <div class="student-pre-live-icon mb-6" aria-hidden="true" style="width: 96px; height: 96px; margin: 0 auto; background: rgba(18, 56, 93, 0.08); color: #12385d; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;">
            <span class="material-symbols-outlined" style="font-size: 3.5rem;">hourglass_top</span>
          </div>

          <!-- Main Message -->
          <h2 id="pre-live-primary" class="student-stem text-4xl sm:text-5xl font-bold mb-4" style="color: #12385d;">
            Waiting for your teacher to start the poll
            <span class="waiting-dots ml-2">
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
            </span>
          </h2>

          <!-- Subtext -->
          <p id="pre-live-subline" class="student-subline text-lg max-w-2xl mx-auto mb-6" style="color: #6b7280;">
            Keep this tab open — the question will appear automatically.
          </p>

          <!-- Humorous Footer -->
          <p class="text-sm italic mt-8" style="color: #9ca3af;">
            Patience is a virtue (and a graded skill).
          </p>

          <!-- Optional Shimmer Particles -->
          <div class="shimmer-particle" style="top: 20%; left: 15%; animation-delay: 0s;"></div>
          <div class="shimmer-particle" style="top: 60%; right: 20%; animation-delay: 2s;"></div>
          <div class="shimmer-particle" style="bottom: 30%; left: 25%; animation-delay: 4s;"></div>
        </div>

        <!-- Status Footer -->
        <div class="student-card-options student-pre-live-footer" style="background: rgba(18, 56, 93, 0.04); padding: 12px 19px; border-top: 1px solid rgba(18, 56, 93, 0.1);">
          <div class="student-pre-live-status" style="color: #12385d;">
            <span class="student-pre-live-label font-bold">PRE-LIVE</span>
            <span class="student-pre-live-pips" aria-hidden="true">
              <span class="pip" style="animation-delay: 0s; background: #12385d;"></span>
              <span class="pip" style="animation-delay: 0.2s; background: #12385d;"></span>
              <span class="pip" style="animation-delay: 0.4s; background: #12385d;"></span>
            </span>
          </div>
          <p id="pre-live-reconnect-line" class="student-pre-live-reconnect hidden" style="color: #12385d;">
            Reconnecting… syncing you back into place.
          </p>
        </div>
      </section>

      <!-- Status Container -->
      <div id="status-container" class="text-center py-12 animate-fade-in" style="display: none;">
        <div class="bg-black/20 backdrop-blur-lg rounded-xl border border-white/10 p-8 sm:p-12 shadow-2xl max-w-3xl mx-auto">
          <span class="material-symbols-outlined text-6xl text-white mb-4 inline-block">schedule</span>
          <h2 id="status-message" class="text-white text-2xl font-semibold">Connecting to poll...</h2>
          <p id="status-submessage" class="text-white/70 text-lg mt-4" style="display: none;"></p>
          <div id="resume-controls" class="mt-8 space-y-3" style="display: none;">
            <p class="text-white/90 text-base leading-relaxed">
              Click below to return to fullscreen and resume the poll.
            </p>
            <button id="resume-session-btn" class="mx-auto flex items-center justify-center gap-2 px-8 py-4 rounded-lg bg-green-500 text-white text-lg font-bold hover:bg-green-600 transition-transform duration-300 hover:scale-105 shadow-lg">
              <span class="material-symbols-outlined text-xl">fullscreen</span>
              <span>Resume Poll</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Question Container -->
      <section id="question-container" class="student-card prevent-select animate-fade-in" aria-live="polite" style="display: none;">
        <div class="student-card-header">
          <p id="question-number" class="student-question-number"></p>
        </div>
        <div id="question-content" class="student-card-body">
          <div class="student-card-body-content">
            <h2 id="question-text" class="student-stem"></h2>
            <p id="question-subline" class="student-subline hidden"></p>
          </div>
          <img id="question-image" src="" alt="Question" class="student-question-image" referrerpolicy="no-referrer" onerror="this.style.display='none';" style="display: none;" />
        </div>
        <div class="student-card-options">
          <p id="no-responses-message" class="student-no-responses hidden"></p>
          <ul id="options-list" class="student-choices"></ul>
        </div>
      </section>

      <!-- Secure Assessment Focus Mode -->
      <section id="individual-timed-session" class="student-card secure-session-card prevent-select animate-fade-in" style="display: none;" aria-live="polite">
        <div class="student-card-header secure-session-header">
          <div>
            <p class="secure-session-meta">Secure Assessment</p>
            <p id="secure-progress-label" class="secure-session-progress">Question 1 of 10</p>
          </div>
        </div>
        <div id="secure-connection-warning" class="secure-connection-warning hidden"></div>
        <div class="student-card-body secure-session-body">
          <div class="secure-question-pane">
            <h2 id="secure-question-text" class="student-stem"></h2>
            <img id="secure-question-image" src="" alt="Question" class="student-question-image" referrerpolicy="no-referrer" onerror="this.style.display='none';" style="display: none;" />
          </div>
          <div class="secure-options-pane">
            <ul id="secure-options-list" class="student-choices"></ul>
          </div>
        </div>
        <div class="secure-session-footer">
          <button id="secure-submit-btn" class="secure-submit-btn" type="button">
            <span class="material-symbols-outlined text-xl" aria-hidden="true">arrow_forward</span>
            <span id="secure-submit-label">Submit &amp; Next</span>
          </button>
          <p id="secure-submit-hint" class="secure-submit-hint">Select an answer or submit to leave blank.</p>
        </div>
      </section>

      <div id="secure-connection-indicator" class="secure-connection-indicator hidden" aria-live="polite">
        <span id="secure-connection-dot" class="secure-connection-dot bg-emerald-400" aria-hidden="true"></span>
        <span id="secure-connection-status" class="sr-only" role="status">Connected</span>
      </div>

    </div>
  </main>

  <script>
    (function() {
        var secureFocusContainer = document.getElementById('individual-timed-session');
        var secureProgressLabel = document.getElementById('secure-progress-label');
        var secureCountdownEl = document.getElementById('secure-countdown');
        var secureTopbarTimer = document.getElementById('secure-topbar-timer');
        var studentModeLabel = document.getElementById('student-mode-label');
        var secureConnectionDot = document.getElementById('secure-connection-dot');
        var secureConnectionIndicator = document.getElementById('secure-connection-indicator');
        var secureConnectionStatus = document.getElementById('secure-connection-status');
        var secureConnectionWarning = document.getElementById('secure-connection-warning');
        var secureQuestionText = document.getElementById('secure-question-text');
        var secureQuestionImage = document.getElementById('secure-question-image');
        var secureOptionsList = document.getElementById('secure-options-list');
        var secureSubmitBtn = document.getElementById('secure-submit-btn');
        var secureSubmitLabel = document.getElementById('secure-submit-label');
        var secureSubmitHint = document.getElementById('secure-submit-hint');
        var secureCloseTimer = null;

        var secureCountdownController = window.SecureAssessmentShared.createCountdown({
            onTick: function(seconds) {
                updateSecureTimerDisplay(seconds);
            },
            onExpire: function() {
                handleSecureTimeExpiry();
            }
        });
        var secureSessionHeartbeat = window.SecureAssessmentShared.createHeartbeat({
            intervalMs: 3500,
            onBeat: function() {
                pollForIndividualSessionState();
            }
        });
        var secureFullscreenManager = window.SecureAssessmentShared.createFullscreenManager(document, {
            onChange: handleSecureFullscreenChange
        });
        var secureSessionActive = false;
        var secureQuestionState = null;
        var secureSelectedOptionIndex = null;
        var secureCurrentQuestionKey = null;
        var secureSubmitting = false;
        var secureTimeExpired = false;
        var securePollInFlight = false;

        function setSecureChromeState(isActive) {
            if (studentModeLabel) {
                studentModeLabel.textContent = isActive ? 'Secure Assessment' : 'Live Poll';
            }
            if (secureTopbarTimer) {
                secureTopbarTimer.classList.toggle('hidden', !isActive);
            }
        }

        function formatTime(seconds) {
            var minutes = Math.floor(seconds / 60);
            var remainingSeconds = seconds % 60;
            return ('0' + minutes).slice(-2) + ':' + ('0' + remainingSeconds).slice(-2);
        }

        function deriveSecureQuestionKey(state) {
            if (!state || !state.question) {
                return null;
            }
            if (state.question.id) {
                return state.question.id;
            }
            if (state.question.questionId) {
                return state.question.questionId;
            }
            if (typeof state.actualQuestionIndex === 'number') {
                return (state.pollId || 'poll') + ':' + state.actualQuestionIndex;
            }
            return (state.pollId || 'poll') + ':' + (state.progressIndex || 0);
        }

        function setSecureConnectionIndicatorVisible(visible) {
            if (!secureConnectionIndicator) return;
            if (visible) {
                secureConnectionIndicator.classList.remove('hidden');
            } else {
                secureConnectionIndicator.classList.add('hidden');
            }
        }

        function syncSecureOptionSelection() {
            if (!secureOptionsList) return;
            var buttons = secureOptionsList.querySelectorAll('button.secure-answer-option');
            buttons.forEach(function(btn) {
                var btnIndex = parseInt(btn.dataset.optionIndex, 10);
                var selected = btnIndex === secureSelectedOptionIndex;
                btn.classList.toggle('answer-option-selected', selected);
                btn.setAttribute('aria-pressed', selected ? 'true' : 'false');
            });
        }

        function showIndividualTimedView(state) {
            hideSecureLobby();
            if (studentLoader) studentLoader.style.display = 'none';
            if (entryScreen) entryScreen.style.display = 'none';
            studentContainer.style.display = 'block';
            questionContainer.style.display = 'none';
            statusContainer.style.display = 'none';
            if (preLiveCard) preLiveCard.style.display = 'none';
            if (secureFocusContainer) secureFocusContainer.style.display = 'block';
            if (!secureSessionActive) {
                secureSessionActive = true;
                secureSessionHeartbeat.start(true);
            }
            setSecureChromeState(true);
            hideSecureOverlay();
            setSecureConnectionIndicatorVisible(true);
            secureQuestionState = state;
            var nextQuestionKey = deriveSecureQuestionKey(state);
            var isNewQuestion = secureCurrentQuestionKey !== nextQuestionKey;
            secureCurrentQuestionKey = nextQuestionKey;
            if (isNewQuestion) {
                secureSelectedOptionIndex = null;
            }
            secureSubmitting = false;
            secureTimeExpired = false;
            disableSecureOptions(false);
            renderSecureQuestion(state);
            startSecureCountdown(state.timeRemainingSeconds || 0);
            updateSecureConnectionIndicators(state);
        }

        function renderSecureQuestion(state) {
            if (!state) return;
            if (secureProgressLabel) {
                secureProgressLabel.textContent = `Question ${state.progressIndex + 1} of ${state.totalQuestions}`;
            }
            if (secureQuestionText) {
                secureQuestionText.textContent = state.question.questionText || '';
            }
            if (secureQuestionImage) {
                if (state.question.questionImageURL) {
                    secureQuestionImage.src = state.question.questionImageURL;
                    secureQuestionImage.style.display = 'block';
                } else {
                    secureQuestionImage.style.display = 'none';
                }
            }
            if (secureOptionsList) {
                secureOptionsList.innerHTML = '';
                var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                var options = Array.isArray(state.question.options) ? state.question.options : [];
                options.forEach(function(option, index) {
                    secureOptionsList.appendChild(buildSecureOption(option, index, letters.charAt(index) || '#'));
                });
                syncSecureOptionSelection();
            }
            updateSecureSubmitState();
        }

        function buildSecureOption(option, index, letter) {
            var li = document.createElement('li');
            var button = document.createElement('button');
            button.type = 'button';
            button.className = 'answer-option secure-answer-option relative w-full text-left';
            button.dataset.optionIndex = index;
            button.setAttribute('aria-pressed', 'false');
            var displayText = (option && option.text) ? option.text.toString() : '';
            var cleanText = displayText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            var content = '<div class="option-leading">';
            content += '<div class="letter-badge" aria-hidden="true">' + letter + '</div>';
            content += '</div>';
            content += '<div class="option-body">';
            if (option && option.imageURL) {
                content += '<img src="' + escapeHtml(option.imageURL) + '" alt="Answer ' + letter + '" class="option-image" referrerpolicy="no-referrer">';
            }
            if (cleanText) {
                content += '<p class="option-text">' + escapeHtml(cleanText).replace(/\n/g, '<br>') + '</p>';
            }
            content += '<span class="result-ribbon"></span>';
            content += '<span class="sr-only secure-selection-announcement"></span>';
            content += '</div>';
            content += '<span class="result-indicator" aria-hidden="true"></span>';
            button.innerHTML = content;
            button.addEventListener('click', function(event) {
                if (event && event.target && event.target.closest('.option-image')) {
                    return;
                }
                handleSecureOptionSelect(index);
            });
            li.appendChild(button);
            return li;
        }

        function handleSecureOptionSelect(index) {
            if (!secureOptionsList) return;
            secureSelectedOptionIndex = index;
            syncSecureOptionSelection();
            updateSecureSubmitState();
        }

        function updateSecureSubmitState() {
            if (!secureSubmitBtn) return;
            var hasState = !!secureQuestionState;
            var disabled = !hasState || secureSubmitting || secureTimeExpired;
            secureSubmitBtn.disabled = disabled;
            secureSubmitBtn.classList.toggle('opacity-60', disabled);
            if (secureSubmitLabel && hasState && !secureSubmitting) {
                var onLastQuestion = secureQuestionState.progressIndex >= secureQuestionState.totalQuestions - 1;
                secureSubmitLabel.textContent = onLastQuestion ? 'Submit Exam' : 'Submit & Next';
            }
            if (secureSubmitHint) {
                if (!hasState) {
                    secureSubmitHint.textContent = '';
                } else if (typeof secureSelectedOptionIndex === 'number') {
                    var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    var letter = letters.charAt(secureSelectedOptionIndex) || '#';
                    secureSubmitHint.textContent = 'Selected ' + letter + '. Submit when ready.';
                } else {
                    secureSubmitHint.textContent = 'No answer selected — submitting will record this as blank.';
                }
            }
        }

        function setSecureSubmitLoading(isLoading) {
            secureSubmitting = isLoading;
            if (!secureSubmitBtn) return;
            secureSubmitBtn.disabled = isLoading;
            secureSubmitBtn.classList.toggle('opacity-60', isLoading);
            if (secureSubmitLabel && isLoading) {
                secureSubmitLabel.textContent = 'Saving...';
            }
            if (!isLoading) {
                updateSecureSubmitState();
            }
        }

        function disableSecureOptions(disabled) {
            if (!secureOptionsList) return;
            secureOptionsList.querySelectorAll('button.secure-answer-option').forEach(function(btn) {
                btn.disabled = disabled;
                btn.classList.toggle('answer-option-disabled', disabled);
            });
        }

        function submitIndividualAnswer(state, answerText) {
            if (!state || secureSubmitting) return;
            setSecureSubmitLoading(true);
            disableSecureOptions(true);
            var answerDetails = {
                pollId: state.pollId,
                sessionId: state.sessionId,
                actualQuestionIndex: state.actualQuestionIndex,
                answer: answerText || '',
                confidenceLevel: null
            };
            google.script.run
                .withSuccessHandler(function(response) {
                    setSecureSubmitLoading(false);
                    disableSecureOptions(false);
                    if (response && response.success) {
                        // Clear current question state immediately to prevent re-display
                        var previousQuestionKey = secureCurrentQuestionKey;
                        secureSelectedOptionIndex = null;
                        secureQuestionState = null;
                        secureCurrentQuestionKey = null;

                        // Clear the UI to show transition between questions
                        if (secureQuestionText) secureQuestionText.textContent = '';
                        if (secureQuestionImage) secureQuestionImage.style.display = 'none';
                        if (secureOptionsList) secureOptionsList.innerHTML = '';

                        // Brief delay before polling to allow server state to update
                        setTimeout(function() {
                            pollForIndividualSessionState();
                        }, 300);
                    } else {
                        handleError((response && response.error) || 'Failed to submit answer.');
                    }
                })
                .withFailureHandler(function(error) {
                    setSecureSubmitLoading(false);
                    disableSecureOptions(false);
                    handleError(error);
                })
                .submitAnswerIndividualTimed(SESSION_TOKEN, answerDetails);
        }

        function stopSecureCountdown() {
            secureCountdownController.stop();
        }

        function updateSecureTimerDisplay(seconds) {
            if (!secureCountdownEl) return;
            secureCountdownEl.textContent = formatTime(Math.max(0, seconds));
            secureCountdownEl.classList.remove('text-red-500', 'text-amber-500', 'animate-pulse');
            if (seconds <= 60) {
                secureCountdownEl.classList.add('text-red-500', 'animate-pulse');
            } else if (seconds <= 300) {
                secureCountdownEl.classList.add('text-amber-500');
            }
        }

        function startSecureCountdown(timeRemainingSeconds) {
            var remaining = Math.max(0, Math.floor(timeRemainingSeconds || 0));
            secureCountdownController.start(remaining);
        }

        function handleSecureTimeExpiry() {
            if (secureTimeExpired) return;
            secureTimeExpired = true;
            showSecureOverlay('TIME_UP', "Time's up!", 'Hold tight while we finalize your work.');
            autoSubmitSecureAnswer(false);
            scheduleSecureWindowClose(4000);
        }

        function autoSubmitSecureAnswer(forceBlank) {
            if (!secureQuestionState || secureSubmitting) return;
            var answerText = '';
            if (!forceBlank && typeof secureSelectedOptionIndex === 'number') {
                var option = (secureQuestionState.question.options || [])[secureSelectedOptionIndex];
                if (option && typeof option.text === 'string') {
                    answerText = option.text;
                }
            }
            submitIndividualAnswer(secureQuestionState, answerText);
        }

        function scheduleSecureWindowClose(delayMs) {
            if (secureCloseTimer) return;
            var timeout = Math.max(500, Number(delayMs) || 2500);
            secureCloseTimer = setTimeout(function() {
                try {
                    if (google && google.script && google.script.host && typeof google.script.host.close === 'function') {
                        google.script.host.close();
                        return;
                    }
                } catch (err) {
                    console.warn('Unable to close Apps Script host', err);
                }
                if (typeof window !== 'undefined' && typeof window.close === 'function') {
                    window.close();
                }
            }, timeout);
        }

        function finalizeSecureSession(statusType, message, subtext) {
            stopSecureCountdown();
            setSecureConnectionIndicatorVisible(false);
            if (secureSessionActive) {
                secureSessionHeartbeat.stop();
                secureSessionActive = false;
            }
            setSecureChromeState(false);
            secureQuestionState = null;
            secureCurrentQuestionKey = null;
            secureSelectedOptionIndex = null;
            secureSubmitting = false;
            showSecureOverlay(statusType, message, subtext);
            scheduleSecureWindowClose(2500);
        }

        function showSecureOverlay(type, message, subtext) {
            var icon = 'lock';
            var iconClass = 'text-red-300';
            var messageClass = 'text-white text-2xl font-semibold';
            var subClass = 'text-white/80 text-base mt-4';
            if (type === 'COMPLETED') {
                icon = 'task_alt';
                iconClass = 'text-green-300';
                messageClass = 'text-green-200 text-2xl font-semibold';
            } else if (type === 'TIME_UP') {
                icon = 'hourglass_bottom';
            } else if (type === 'ENDED') {
                icon = 'info';
            } else if (type === 'LOCKED') {
                iconClass = 'text-red-300';
                messageClass = 'text-red-300 text-xl font-semibold';
                subClass = 'text-red-200 text-base mt-4';
            }
            showStatusPanel({
                icon: icon,
                iconClass: iconClass,
                message: message || '',
                messageClass: messageClass,
                subtext: subtext || '',
                subClass: subClass,
                showResume: false,
                lockScroll: true
            });
        }

        function hideSecureOverlay() {
            if (document && document.body) {
                document.body.classList.remove('secure-overlay-active');
            }
            if (statusContainer && !isInteractionBlocked) {
                statusContainer.style.display = 'none';
            }
            if (statusSubMessage) {
                statusSubMessage.style.display = 'none';
                statusSubMessage.textContent = '';
            }
        }

        function showSecureLockout(message, subtext) {
            stopSecureCountdown();
            setSecureConnectionIndicatorVisible(true);
            if (secureFocusContainer) {
                secureFocusContainer.style.display = 'block';
            }
            disableSecureOptions(true);
            showSecureOverlay('LOCKED', message || 'Your session has been paused.', subtext || 'Wait for your teacher to unlock you.');
        }

        function updateSecureConnectionIndicators(state) {
            if (!state || !secureConnectionDot) return;
            var health = (state.connectionHealth || '').toUpperCase();
            var dotClasses = ['bg-emerald-400', 'bg-amber-400', 'bg-red-500'];
            dotClasses.forEach(function(cls) { secureConnectionDot.classList.remove(cls); });
            var label = 'Synced';
            var warningText = '';
            if (health === 'RED') {
                secureConnectionDot.classList.add('bg-red-500');
                label = 'Connection issue';
                warningText = 'We are reconnecting and saving your work...';
            } else if (health === 'YELLOW') {
                secureConnectionDot.classList.add('bg-amber-400');
                label = 'Reconnecting';
                warningText = 'Syncing your progress...';
            } else {
                secureConnectionDot.classList.add('bg-emerald-400');
                label = 'Synced';
            }
            var lagSeconds = state.heartbeatLagMs ? Math.max(0, Math.round(state.heartbeatLagMs / 1000)) : 0;
            if (secureConnectionStatus) {
                var srLabel = label;
                if (lagSeconds > 0) {
                    srLabel += ' • ' + lagSeconds + ' second lag';
                }
                secureConnectionStatus.textContent = srLabel;
            }
            if (secureConnectionWarning) {
                if (warningText) {
                    secureConnectionWarning.textContent = warningText;
                    secureConnectionWarning.classList.remove('hidden');
                } else {
                    secureConnectionWarning.textContent = '';
                    secureConnectionWarning.classList.add('hidden');
                }
            }
        }

        function pollForIndividualSessionState() {
            if (securePollInFlight) return;
            securePollInFlight = true;
            google.script.run
                .withSuccessHandler(function(state) {
                    securePollInFlight = false;
                    if (studentLoader) {
                        studentLoader.style.display = 'none';
                    }
                    if (!state) {
                        return;
                    }
                    if (state.status === 'LOBBY') {
                        showSecureLobby(state);
                        return;
                    }
                    if (state.sessionType === 'INDIVIDUAL_TIMED' || state.sessionType === 'SECURE_ASSESSMENT') {
                        hideSecureLobby();
                        var lockReason = (state.lockReason || '').toString().toUpperCase();
                        var lockMessage = (state.message || '').toString().toLowerCase();
                        var isTerminalLock = state.locked === true || lockReason === 'FORCED_SUBMIT' || lockReason === 'TIME_EXPIRED' || lockMessage.indexOf('ended') >= 0 || lockMessage.indexOf('submitted') >= 0;
                        if (state.completed || state.status === 'COMPLETED') {
                            updateSecureConnectionIndicators(state);
                            finalizeSecureSession('COMPLETED', state.message || 'Assessment submitted!', 'Stay in fullscreen until released.');
                        } else if (state.status === 'ENDED') {
                            updateSecureConnectionIndicators(state);
                            finalizeSecureSession('ENDED', state.message || 'This assessment is no longer active.', 'You may exit once your teacher confirms.');
                        } else if (isTerminalLock) {
                            updateSecureConnectionIndicators(state);
                            finalizeSecureSession('ENDED', state.message || 'This assessment has been closed.', 'Your responses have been secured.');
                        } else if (state.status === 'LOCKED') {
                            if (secureFocusContainer) secureFocusContainer.style.display = 'block';
                            secureQuestionState = null;
                            secureCurrentQuestionKey = null;
                            secureSelectedOptionIndex = null;
                            updateSecureConnectionIndicators(state);
                            showSecureLockout(state.message || 'Your session has been paused.', 'Wait for your teacher to unlock you.');
                        } else if (isInteractionBlocked) {
                            updateSecureConnectionIndicators(state);
                            setSecureConnectionIndicatorVisible(true);
                            showSecureLockout(state.message || 'Your session has been paused.', 'Wait for your teacher to unlock you.');
                        } else if (state.question && (state.status === 'ACTIVE' || !state.status)) {
                            showIndividualTimedView(state);
                        } else {
                            console.log('Secure session state', state);
                        }
                    } else {
                        updateStudentView(state);
                    }
                })
                .withFailureHandler(function(error) {
                    securePollInFlight = false;
                    handleError(error);
                })
                .getIndividualTimedSessionState(SESSION_TOKEN);
        }

        if (secureSubmitBtn) {
            secureSubmitBtn.addEventListener('click', function() {
                if (!secureQuestionState || secureSubmitting) return;
                var answerText = '';
                if (typeof secureSelectedOptionIndex === 'number') {
                    var option = (secureQuestionState.question.options || [])[secureSelectedOptionIndex];
                    if (option && typeof option.text === 'string') {
                        answerText = option.text;
                    }
                }
                submitIndividualAnswer(secureQuestionState, answerText);
            });
        }

        // Add click handler to secure assessment question image for zoom
        if (secureQuestionImage) {
            secureQuestionImage.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                if (window.expandImage) {
                    window.expandImage(this);
                }
            });
        }

        console.log('Student poll script initializing...');
        var studentLoader = document.getElementById('student-loader');
        var preLiveCard = document.getElementById('pre-live-card');
        var statusContainer = document.getElementById('status-container');
        var statusMessage = document.getElementById('status-message');
        var questionContainer = document.getElementById('question-container');
        var optionsList = document.getElementById('options-list');
        var questionNumberEl = document.getElementById('question-number');
        var questionTextEl = document.getElementById('question-text');
        var questionImageEl = document.getElementById('question-image');
        var questionSublineEl = document.getElementById('question-subline');
        var noResponsesMessageEl = document.getElementById('no-responses-message');
        var entryScreen = document.getElementById('entry-screen');
        var startSessionBtn = document.getElementById('start-session-btn');
        var studentContainer = document.getElementById('student-container');
        // Simple image zoom function (same approach as teacher panel)
        window.expandImage = function(imgElement) {
            var imgSrc = imgElement.src;
            var modalHtml = '<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:pointer;" onclick="this.remove()">';
            modalHtml += '<img src="' + imgSrc + '" style="max-width:90%;max-height:90%;"/>';
            modalHtml += '</div>';
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        };

        // Add click handler to question image
        if (questionImageEl) {
            questionImageEl.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                window.expandImage(this);
            });
        }

        // Event delegation for dynamically created option images
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('option-image')) {
                e.stopPropagation();
                e.preventDefault();
                window.expandImage(e.target);
            }
        });
        var preLivePrimary = document.getElementById('pre-live-primary');
        var preLiveSubline = document.getElementById('pre-live-subline');
        var preLiveReconnectLine = document.getElementById('pre-live-reconnect-line');

        console.log('Start session button found:', startSessionBtn ? 'YES' : 'NO');
        console.log('Entry screen found:', entryScreen ? 'YES' : 'NO');
        var resumeControls = document.getElementById('resume-controls');
        var resumeSessionBtn = document.getElementById('resume-session-btn');
        var statusSubMessage = document.getElementById('status-submessage');
        var connectivityBanner = document.getElementById('connectivity-banner');
        var connectivityIcon = document.getElementById('connectivity-icon');
        var connectivityMessage = document.getElementById('connectivity-message');
        var connectivitySubMessage = document.getElementById('connectivity-submessage');

        var currentPollState = {};
        var lastUnlockedState = null;
        var pollTimerId = null;
        var defaultPollInterval = 2500;
        var maxPollInterval = 12000;
        var pollFailureCount = 0;
        var proctorPollInterval = null;
        var isInteractionBlocked = false;
        var isTeacherBlocked = false;
        var currentLockVersion = 0;
        var hasAnsweredCurrent = false;
        var violationLogged = false;
        var violationDebounceTimer = null;
        var fullscreenEnteredOnce = false; // Track if fullscreen has been entered to prevent false violations
        var pendingSubmission = false;
        var currentQuestionKey = null;
        var pendingAnswerText = null; // Store answer while waiting for confidence
        var currentMetacognitionEnabled = false; // Track if current question has metacognition
        var lastStateVersion = null;
        var lastSuccessfulPollAt = 0;
        var pollInFlight = false;
        var recoveringFromOutage = false;
        var connectivityHideTimer = null;
        var lastAdvisedInterval = defaultPollInterval;
        var optionBaseClass = 'answer-option relative w-full text-left';
        var optionSelectedClass = optionBaseClass + ' answer-option-selected';
        var optionDisabledClass = optionBaseClass + ' answer-option-disabled';
        var SECURE_RULES_FALLBACK = [
            'Stay in fullscreen for the entire assessment',
            'No tab or app switching is allowed',
            'Mission Control monitors your progress in real time'
        ];
        var secureLobbyCard = document.getElementById('secure-lobby');
        var secureLobbyTitle = document.getElementById('secure-lobby-title');
        var secureLobbySummary = document.getElementById('secure-lobby-summary');
        var secureLobbyTime = document.getElementById('secure-lobby-time');
        var secureLobbyQuestions = document.getElementById('secure-lobby-questions');
        var secureWindowMessage = document.getElementById('secure-window-message');
        var secureAccessCodeGroup = document.getElementById('secure-access-code-group');
        var secureAccessCodeInput = document.getElementById('secure-access-code');
        var secureAccessCodeError = document.getElementById('secure-access-code-error');
        var secureBeginBtn = document.getElementById('secure-begin-btn');
        var secureBeginLabel = document.getElementById('secure-begin-label');
        var secureRulesList = document.getElementById('secure-rules-list');
        var secureLobbyContext = null;
        var secureWindowAutoReloaded = false;

        function reportViolationDebounced(reason) {
            if (violationDebounceTimer) {
                clearTimeout(violationDebounceTimer);
            }
            violationDebounceTimer = setTimeout(function() {
                if (violationLogged || (isInteractionBlocked && !isTeacherBlocked)) {
                    return;
                }
                violationLogged = true;
                isInteractionBlocked = true;
                showLockEnforcementUI('Fullscreen required', 'Return to fullscreen and wait for your teacher to resume the assessment.');
                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success) {
                            currentLockVersion = response.lockVersion;
                            showLockEnforcementUI('Fullscreen required', 'Your teacher will let you back in once they confirm fullscreen.');
                            startProctorPolling();
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Violation report failed:', error);
                        showLockEnforcementUI('Fullscreen required', 'Please contact your teacher to resume.');
                    })
                    .reportStudentViolation(reason, SESSION_TOKEN);
            }, 300);
        }

        var VeritasModal = null;
        var veritasModalReady = new Promise(function(resolve) {
            function initializeModal() {
                VeritasModal = window.VeritasModal || createVeritasModal();
                window.VeritasModal = VeritasModal;
                resolve(VeritasModal);
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeModal, { once: true });
            } else {
                initializeModal();
            }
        });

        function withVeritasModal(callback) {
            return veritasModalReady.then(function(controller) {
                return callback(controller);
            });
        }

        function veritasAlert(message, options) {
            return withVeritasModal(function(modal) {
                return modal.alert(Object.assign({ message: message }, options || {}));
            });
        }

        function veritasConfirm(message, options) {
            return withVeritasModal(function(modal) {
                return modal.confirm(Object.assign({ message: message }, options || {}));
            });
        }

        function veritasPrompt(message, options) {
            return withVeritasModal(function(modal) {
                return modal.prompt(Object.assign({ message: message }, options || {}));
            });
        }

        function describeSecureTimeLimit(minutes) {
            if (!minutes || minutes <= 0) {
                return 'Untimed';
            }
            if (minutes >= 60) {
                var hours = Math.floor(minutes / 60);
                var remainder = minutes % 60;
                if (remainder === 0) {
                    return hours + (hours === 1 ? ' hour' : ' hours');
                }
                return hours + ' hr ' + remainder + ' min';
            }
            return minutes + ' min';
        }

        function describeSecureQuestionCount(count) {
            if (typeof count !== 'number' || count <= 0) {
                return '—';
            }
            return count + (count === 1 ? ' Question' : ' Questions');
        }

        function renderSecureRules(rules) {
            if (!secureRulesList) return;
            secureRulesList.innerHTML = '';
            var appliedRules = Array.isArray(rules) && rules.length ? rules : SECURE_RULES_FALLBACK;
            appliedRules.forEach(function(rule) {
                var li = document.createElement('li');
                var icon = document.createElement('span');
                icon.className = 'material-symbols-outlined text-base text-veritas-navy mt-0.5';
                icon.textContent = 'shield_person';
                var text = document.createElement('span');
                text.textContent = rule;
                li.appendChild(icon);
                li.appendChild(text);
                secureRulesList.appendChild(li);
            });
        }

        function setSecureAccessError(message) {
            if (!secureAccessCodeError) return;
            if (message) {
                secureAccessCodeError.textContent = message;
                secureAccessCodeError.classList.remove('hidden');
            } else {
                secureAccessCodeError.textContent = '';
                secureAccessCodeError.classList.add('hidden');
            }
        }

        function computeSecureBeginLabel(windowStatus) {
            if (windowStatus === 'NOT_YET_OPEN') {
                return 'Opens Soon';
            }
            if (windowStatus === 'PAST_DUE') {
                return 'Window Closed';
            }
            return 'Begin Assessment';
        }

        function isSecureWindowBlocked(status) {
            return status === 'NOT_YET_OPEN' || status === 'PAST_DUE';
        }

        function updateSecureBeginButton() {
            if (!secureBeginBtn) return;
            var windowStatus = secureLobbyContext ? secureLobbyContext.windowStatus : 'OPEN';
            var label = computeSecureBeginLabel(windowStatus);
            var blocked = isSecureWindowBlocked(windowStatus);
            var loading = secureBeginBtn.dataset.loading === '1';
            if (secureLobbyContext) {
                secureLobbyContext.beginLabel = label;
            }
            secureBeginBtn.disabled = blocked || loading;
            secureBeginBtn.classList.toggle('opacity-60', blocked || loading);
            if (secureBeginLabel && !loading) {
                secureBeginLabel.textContent = label;
            }
        }

        function setSecureBeginLoading(isLoading) {
            if (!secureBeginBtn) return;
            secureBeginBtn.dataset.loading = isLoading ? '1' : '0';
            if (isLoading) {
                secureBeginBtn.disabled = true;
                secureBeginBtn.classList.add('opacity-60');
                if (secureBeginLabel) {
                    secureBeginLabel.textContent = 'Preparing...';
                }
            } else {
                secureBeginBtn.classList.remove('opacity-60');
                updateSecureBeginButton();
            }
        }

        function hideSecureLobby() {
            if (secureLobbyCard) {
                secureLobbyCard.style.display = 'none';
            }
            secureLobbyContext = null;
            setSecureAccessError('');
        }

        function shouldAutoReloadForSecureWindow(previousStatus, nextStatus) {
            if (!previousStatus || !nextStatus) {
                return false;
            }
            var wasBlocked = isSecureWindowBlocked(previousStatus);
            var isBlockedNow = isSecureWindowBlocked(nextStatus);
            return wasBlocked && !isBlockedNow;
        }

        function triggerSecureWindowReload() {
            if (secureWindowAutoReloaded) {
                return;
            }
            secureWindowAutoReloaded = true;
            if (secureBeginBtn) {
                secureBeginBtn.disabled = true;
                secureBeginBtn.classList.add('opacity-60');
            }
            if (secureBeginLabel) {
                secureBeginLabel.textContent = 'Refreshing...';
            }
            setTimeout(function() {
                window.location.reload();
            }, 750);
        }

        function showSecureLobby(state) {
            var previousContext = secureLobbyContext;
            var previousLobbyKey = previousContext && previousContext.lobbyKey
                ? previousContext.lobbyKey
                : (previousContext ? (previousContext.pollId + '|' + previousContext.sessionId) : null);
            var nextLobbyKey = (state.pollId || 'poll') + '|' + (state.sessionId || '');
            var isNewLobbyContext = previousLobbyKey !== nextLobbyKey;
            var previousWindowStatus = previousContext ? previousContext.windowStatus : null;
            setSecureConnectionIndicatorVisible(false);
            setSecureChromeState(true);

            secureLobbyContext = {
                pollId: state.pollId,
                sessionId: state.sessionId,
                requiresAccessCode: !!state.requiresAccessCode,
                windowStatus: (state.availability && state.availability.windowStatus) || state.windowStatus || 'OPEN',
                lobbyKey: nextLobbyKey
            };

            if (shouldAutoReloadForSecureWindow(previousWindowStatus, secureLobbyContext.windowStatus)) {
                triggerSecureWindowReload();
                return;
            }

            if (entryScreen) entryScreen.style.display = 'none';
            if (studentContainer) studentContainer.style.display = 'block';
            if (studentLoader) studentLoader.style.display = 'none';
            if (preLiveCard) preLiveCard.style.display = 'none';
            if (statusContainer) statusContainer.style.display = 'none';
            if (questionContainer) questionContainer.style.display = 'none';
            if (secureFocusContainer) secureFocusContainer.style.display = 'none';
            if (secureLobbyCard) secureLobbyCard.style.display = 'block';

            if (secureLobbyTitle) {
                secureLobbyTitle.textContent = state.pollName || 'Secure Assessment';
            }
            if (secureLobbySummary) {
                if (state.className) {
                    secureLobbySummary.textContent = 'Class: ' + state.className;
                    secureLobbySummary.style.display = 'block';
                } else {
                    secureLobbySummary.textContent = '';
                    secureLobbySummary.style.display = 'none';
                }
            }
            if (secureLobbyTime) {
                secureLobbyTime.textContent = describeSecureTimeLimit(state.timeLimitMinutes);
            }
            if (secureLobbyQuestions) {
                secureLobbyQuestions.textContent = describeSecureQuestionCount(state.questionCount);
            }

            var availability = state.availability || {};
            var availabilityMessage = availability.message || 'Available now';
            if (availability.blockingMessage) {
                availabilityMessage += ' • ' + availability.blockingMessage;
            }
            if (secureWindowMessage) {
                secureWindowMessage.textContent = availabilityMessage;
            }

            if (secureAccessCodeGroup) {
                secureAccessCodeGroup.style.display = secureLobbyContext.requiresAccessCode ? 'block' : 'none';
            }
            if (secureAccessCodeInput && isNewLobbyContext) {
                secureAccessCodeInput.value = '';
            }
            if (isNewLobbyContext) {
                setSecureAccessError('');
            }
            renderSecureRules(state.proctoringRules);
            updateSecureBeginButton();
        }

        function requestFullscreenForSecureAssessment() {
            if (!secureFullscreenManager) {
                return Promise.resolve();
            }
            if (secureFullscreenManager.isFullscreen()) {
                return Promise.resolve();
            }
            return secureFullscreenManager.request().catch(function() {
                return Promise.resolve();
            });
        }

        function handleSecureFullscreenChange(event) {
            if (!secureSessionActive) {
                return;
            }
            if (event.hidden && !isInteractionBlocked && !violationLogged) {
                reportViolationDebounced('tab-blur');
                return;
            }
            if (event.isFullscreen) {
                fullscreenEnteredOnce = true;
                return;
            }
            if (fullscreenEnteredOnce && !isInteractionBlocked && !violationLogged) {
                reportViolationDebounced('exit-fullscreen');
            }
        }

        function handleSecureBeginClick() {
            if (!secureLobbyContext || !secureBeginBtn || secureBeginBtn.disabled) {
                return;
            }
            setSecureAccessError('');
            var providedCode = secureAccessCodeInput ? secureAccessCodeInput.value.trim() : '';
            if (secureLobbyContext.requiresAccessCode && !providedCode) {
                setSecureAccessError('Access code is required.');
                if (secureAccessCodeInput) {
                    secureAccessCodeInput.focus();
                }
                return;
            }

            requestFullscreenForSecureAssessment()
                .then(function() {
                    setSecureBeginLoading(true);
                    google.script.run
                        .withSuccessHandler(function(response) {
                            setSecureBeginLoading(false);
                            if (response && response.success) {
                                pollForIndividualSessionState();
                            } else {
                                veritasAlert('Unable to begin the assessment right now.', { title: 'Secure Assessment' });
                            }
                        })
                        .withFailureHandler(function(error) {
                            setSecureBeginLoading(false);
                            var message = (error && error.message) ? error.message : 'Unable to begin assessment.';
                            if (/access code/i.test(message)) {
                                setSecureAccessError(message);
                                if (secureAccessCodeInput) {
                                    secureAccessCodeInput.focus();
                                }
                            } else {
                                veritasAlert(message, { title: 'Secure Assessment' });
                            }
                        })
                        .beginIndividualTimedAttempt(
                            secureLobbyContext.pollId,
                            secureLobbyContext.sessionId,
                            SESSION_TOKEN,
                            { accessCode: providedCode }
                        );
                })
                .catch(function(err) {
                    console.warn('Fullscreen request was rejected', err);
                    veritasAlert('Fullscreen permission is required to begin the assessment.', { title: 'Secure Assessment' });
                });
        }

        function ensureVeritasModalRoot() {
            var existing = document.getElementById('veritas-modal-root');
            if (existing) {
                return existing;
            }

            var root = document.createElement('div');
            root.id = 'veritas-modal-root';
            root.className = 'veritas-modal-root';
            root.setAttribute('aria-hidden', 'true');
            root.innerHTML = '' +
                '<div class="veritas-modal-backdrop"></div>' +
                '<div class="veritas-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="veritas-modal-title" aria-describedby="veritas-modal-message">' +
                    '<div class="veritas-modal-header">' +
                        '<h2 id="veritas-modal-title">Notice</h2>' +
                    '</div>' +
                    '<div class="veritas-modal-body">' +
                        '<p id="veritas-modal-message"></p>' +
                        '<div id="veritas-modal-subtext" class="veritas-modal-subtext"></div>' +
                        '<div id="veritas-modal-input" class="veritas-modal-input" style="display: none;">' +
                            '<label for="veritas-modal-input-field" class="sr-only">Input</label>' +
                            '<input id="veritas-modal-input-field" type="text" autocomplete="off" />' +
                        '</div>' +
                    '</div>' +
                    '<div class="veritas-modal-actions">' +
                        '<button type="button" class="veritas-modal-button secondary" data-action="cancel">Cancel</button>' +
                        '<button type="button" class="veritas-modal-button primary" data-action="confirm">' +
                            '<span class="veritas-modal-spinner" aria-hidden="true"></span>' +
                            '<span>Confirm</span>' +
                        '</button>' +
                    '</div>' +
                '</div>';

            (document.body || document.documentElement).appendChild(root);
            return root;
        }

        function createVeritasModal() {
            var root = ensureVeritasModalRoot();

            var dialog = root.querySelector('.veritas-modal-dialog');
            var titleEl = root.querySelector('#veritas-modal-title');
            var messageEl = root.querySelector('#veritas-modal-message');
            var subtextEl = root.querySelector('#veritas-modal-subtext');
            var inputWrap = root.querySelector('#veritas-modal-input');
            var inputField = root.querySelector('#veritas-modal-input-field');
            var confirmBtn = root.querySelector('[data-action="confirm"]');
            var cancelBtn = root.querySelector('[data-action="cancel"]');
            var confirmLabel = confirmBtn.querySelector('span:not(.veritas-modal-spinner)');
            var active = false;
            var currentConfig = null;
            var resolveFn = null;
            var previousFocus = null;
            var allowEscape = true;
            var hiddenNodes = [];

            function toggleBackground(state) {
                var siblings = [].slice.call(document.body.children);
                if (state) {
                    hiddenNodes = [];
                    siblings.forEach(function(node) {
                        if (node === root) return;
                        hiddenNodes.push({
                            node: node,
                            ariaHidden: node.getAttribute('aria-hidden'),
                            inert: ('inert' in node) ? node.inert : null
                        });
                        node.setAttribute('aria-hidden', 'true');
                        if ('inert' in node) {
                            node.inert = true;
                        }
                    });
                } else {
                    hiddenNodes.forEach(function(record) {
                        if (record.ariaHidden === null) {
                            record.node.removeAttribute('aria-hidden');
                        } else {
                            record.node.setAttribute('aria-hidden', record.ariaHidden);
                        }
                        if ('inert' in record.node) {
                            if (record.inert !== null) {
                                record.node.inert = record.inert;
                            } else {
                                record.node.inert = false;
                            }
                        }
                    });
                    hiddenNodes = [];
                }
            }

            function setPending(state) {
                if (state) {
                    confirmBtn.classList.add('loading');
                    confirmBtn.setAttribute('disabled', 'disabled');
                    if (cancelBtn.style.display !== 'none') {
                        cancelBtn.setAttribute('disabled', 'disabled');
                    }
                } else {
                    confirmBtn.classList.remove('loading');
                    confirmBtn.removeAttribute('disabled');
                    cancelBtn.removeAttribute('disabled');
                }
            }

            function getFocusable() {
                var selectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
                var nodes = [].slice.call(dialog.querySelectorAll(selectors));
                return nodes.filter(function(node) {
                    return !node.hasAttribute('disabled') && node.offsetParent !== null;
                });
            }

            function focusFirst() {
                var focusable = getFocusable();
                if (focusable.length > 0) {
                    focusable[0].focus();
                } else {
                    dialog.focus();
                }
            }

            function trapKey(event) {
                if (!active) return;
                if (event.key === 'Escape') {
                    if (!allowEscape) return;
                    event.preventDefault();
                    handleCancel();
                } else if (event.key === 'Tab') {
                    var focusable = getFocusable();
                    if (focusable.length === 0) {
                        event.preventDefault();
                        return;
                    }
                    var index = focusable.indexOf(document.activeElement);
                    if (event.shiftKey) {
                        if (index <= 0) {
                            focusable[focusable.length - 1].focus();
                            event.preventDefault();
                        }
                    } else {
                        if (index === focusable.length - 1) {
                            focusable[0].focus();
                            event.preventDefault();
                        }
                    }
                } else if (event.key === 'Enter' && currentConfig && currentConfig.mode === 'prompt') {
                    if (document.activeElement === inputField) {
                        event.preventDefault();
                        handleConfirm();
                    }
                }
            }

            function enforceFocus(event) {
                if (!active) return;
                if (!dialog.contains(event.target)) {
                    event.stopPropagation();
                    focusFirst();
                }
            }

            function closeModal(result) {
                active = false;
                root.classList.remove('is-active');
                root.setAttribute('aria-hidden', 'true');
                document.body.classList.remove('veritas-modal-open');
                root.removeEventListener('keydown', trapKey, true);
                document.removeEventListener('focus', enforceFocus, true);
                toggleBackground(false);
                setPending(false);
                if (previousFocus && typeof previousFocus.focus === 'function') {
                    setTimeout(function() { previousFocus.focus(); }, 0);
                }
                if (resolveFn) {
                    resolveFn(result);
                }
                currentConfig = null;
                resolveFn = null;
            }

            function handleConfirm() {
                if (!active) return;
                setPending(true);
                var mode = currentConfig ? currentConfig.mode : 'alert';
                var result;
                if (mode === 'prompt') {
                    result = inputField.value;
                } else if (mode === 'confirm') {
                    result = true;
                }
                closeModal(result);
            }

            function handleCancel() {
                if (!active) return;
                var mode = currentConfig ? currentConfig.mode : 'alert';
                if (mode === 'alert') {
                    closeModal(undefined);
                    return;
                }
                if (mode === 'confirm') {
                    closeModal(false);
                } else if (mode === 'prompt') {
                    closeModal(null);
                }
            }

            function openModal(mode, options) {
                options = options || {};
                currentConfig = Object.assign({}, options, { mode: mode });
                allowEscape = options.allowEscape !== false;
                titleEl.textContent = options.title || (mode === 'confirm' ? 'Please Confirm' : (mode === 'prompt' ? 'Enter Response' : 'Notice'));
                if (options.html) {
                    messageEl.innerHTML = options.html;
                } else {
                    messageEl.textContent = options.message || '';
                }
                if (options.subtext) {
                    subtextEl.style.display = 'block';
                    subtextEl.textContent = options.subtext;
                } else {
                    subtextEl.style.display = 'none';
                    subtextEl.textContent = '';
                }
                if (mode === 'prompt') {
                    inputWrap.style.display = 'flex';
                    inputField.value = options.defaultValue || '';
                    if (options.placeholder) {
                        inputField.placeholder = options.placeholder;
                    } else {
                        inputField.removeAttribute('placeholder');
                    }
                } else {
                    inputWrap.style.display = 'none';
                    inputField.value = '';
                    inputField.removeAttribute('placeholder');
                }
                confirmLabel.textContent = options.confirmText || (mode === 'confirm' ? 'Confirm' : (mode === 'prompt' ? 'Submit' : 'OK'));
                if (options.destructive) {
                    confirmBtn.classList.add('destructive');
                } else {
                    confirmBtn.classList.remove('destructive');
                }
                cancelBtn.style.display = mode === 'alert' ? 'none' : 'inline-flex';
                cancelBtn.textContent = options.cancelText || 'Cancel';
                setPending(false);
                previousFocus = document.activeElement;
                root.classList.add('is-active');
                root.setAttribute('aria-hidden', 'false');
                document.body.classList.add('veritas-modal-open');
                toggleBackground(true);
                active = true;
                root.addEventListener('keydown', trapKey, true);
                document.addEventListener('focus', enforceFocus, true);

                return new Promise(function(resolve) {
                    resolveFn = resolve;
                    setTimeout(function() {
                        if (mode === 'prompt') {
                            inputField.focus();
                            inputField.select();
                        } else if (mode === 'confirm' && options.focusCancel) {
                            cancelBtn.focus();
                        } else {
                            confirmBtn.focus();
                        }
                    }, 0);
                });
            }

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
            root.addEventListener('click', function(event) {
                if (event.target === root || event.target.classList.contains('veritas-modal-backdrop')) {
                    if (!currentConfig || currentConfig.allowBackdropClose === false) {
                        return;
                    }
                    handleCancel();
                }
            });

            return {
                alert: function(options) {
                    return openModal('alert', options).then(function() { return; });
                },
                confirm: function(options) {
                    return openModal('confirm', options).then(function(result) { return result !== false; });
                },
                prompt: function(options) {
                    return openModal('prompt', options).then(function(result) { return result; });
                }
            };
        }
        var currentOptionLayout = [];

        var connectivityThemes = {
            connecting: ['border-amber-300', 'bg-amber-50', 'text-amber-800', 'dark:border-amber-500', 'dark:bg-amber-900/20', 'dark:text-amber-100'],
            offline: ['border-red-300', 'bg-red-50', 'text-red-800', 'dark:border-red-600', 'dark:bg-red-900/20', 'dark:text-red-200'],
            recovered: ['border-green-300', 'bg-green-50', 'text-green-800', 'dark:border-green-600', 'dark:bg-green-900/20', 'dark:text-green-100']
        };
        var allConnectivityClasses = connectivityThemes.connecting.concat(connectivityThemes.offline, connectivityThemes.recovered);

        function isPreLiveVisible() {
            return preLiveCard && preLiveCard.style.display !== 'none';
        }

        function setPreLiveReconnectMessage(text) {
            // Disabled for student view - students don't need to see sync notifications
            return;
        }

        function applyConnectivityTheme(theme) {
            if (!connectivityBanner) return;
            for (var i = 0; i < allConnectivityClasses.length; i++) {
                connectivityBanner.classList.remove(allConnectivityClasses[i]);
            }
            var themeClasses = connectivityThemes[theme] || connectivityThemes.connecting;
            for (var j = 0; j < themeClasses.length; j++) {
                connectivityBanner.classList.add(themeClasses[j]);
            }
        }

        function showConnectivityState(state, options) {
            // Disabled for student view - students don't need to see sync notifications
            // Background sync continues to work normally
            return;
        }

        function hideConnectivityBanner() {
            if (!connectivityBanner) return;
            clearTimeout(connectivityHideTimer);
            connectivityBanner.classList.add('hidden');
            if (connectivitySubMessage) {
                connectivitySubMessage.textContent = '';
                connectivitySubMessage.classList.remove('opacity-0');
            }
            setPreLiveReconnectMessage('');
        }

        function stopPolling() {
            if (pollTimerId) {
                clearTimeout(pollTimerId);
                pollTimerId = null;
            }
            pollInFlight = false;
        }

        function scheduleNextPoll(delay) {
            if (isInteractionBlocked) return;
            stopPolling();
            var boundedDelay = Math.min(maxPollInterval, Math.max(1000, delay));
            var jitter = Math.random() * 0.15 * boundedDelay;
            pollTimerId = setTimeout(function() {
                pollTimerId = null;
                pollForStatus();
            }, boundedDelay + jitter);
        }

        function startPolling(immediate) {
            pollFailureCount = 0;
            recoveringFromOutage = false;
            if (immediate) {
                stopPolling();
                pollForStatus(true);
            } else {
                scheduleNextPoll(defaultPollInterval);
            }
        }

        function handlePostPollSuccess(data, hadFailures) {
            if (typeof data.stateVersion === 'number') {
                lastStateVersion = data.stateVersion;
            }
            if (typeof data.advisedPollIntervalMs === 'number') {
                lastAdvisedInterval = data.advisedPollIntervalMs;
            } else {
                lastAdvisedInterval = defaultPollInterval;
            }

            if (hadFailures || data.connectionHealth === 'RECOVERED_AFTER_OUTAGE') {
                showConnectivityState('recovered', {
                    message: 'Back on track - synced with your teacher.',
                    icon: 'cloud_done',
                    autoHide: 2400
                });
            } else if (data.connectionHealth === 'RECOVERING') {
                hideConnectivityBanner();
                if (isPreLiveVisible()) {
                    setPreLiveReconnectMessage('Syncing back up — we will take off in a moment.');
                }
            } else if (!recoveringFromOutage && !hadFailures) {
                hideConnectivityBanner();
            }

            updateStudentView(data);
            var delay = Math.max(1200, Math.min(maxPollInterval, lastAdvisedInterval));
            scheduleNextPoll(delay);
        }

        function handlePollingFailure(error) {
            var messageText = (error && error.message) ? error.message : (typeof error === 'string' ? error : '');
            if (messageText && /Authentication|not enrolled|Invalid link/i.test(messageText)) {
                stopPolling();
                handleError(error);
                return;
            }

            recoveringFromOutage = true;
            var backoffMultiplier = Math.pow(1.6, Math.max(1, pollFailureCount));
            var retryDelay = Math.min(maxPollInterval, Math.round((lastAdvisedInterval || defaultPollInterval) * backoffMultiplier));
            var seconds = Math.max(1, Math.round(retryDelay / 1000));

            var online = typeof navigator !== 'undefined' ? navigator.onLine : true;
            showConnectivityState(online ? 'connecting' : 'offline', {
                message: online ? 'Reconnecting... your poll data is catching up.' : 'Offline detected - we will hold your spot and resync when you are back.',
                icon: online ? 'sync_problem' : 'signal_wifi_off',
                submessage: online ? ('Retrying in ' + seconds + 's...') : '',
                preLiveMessage: online ? 'Reconnecting… syncing you back into place.' : 'Offline detected — we will hold your spot and sync when you are back.'
            });

            scheduleNextPoll(retryDelay);
        }

        function pollForStatus() {
            if (isInteractionBlocked || pollInFlight) return;
            pollInFlight = true;
            var context = {
                lastStateVersion: lastStateVersion,
                lastSuccessAt: lastSuccessfulPollAt,
                failureCount: pollFailureCount,
                advisedInterval: lastAdvisedInterval
            };

            google.script.run
                .withSuccessHandler(function(data) {
                    pollInFlight = false;
                    var hadFailures = pollFailureCount > 0 || recoveringFromOutage;
                    pollFailureCount = 0;
                    recoveringFromOutage = false;
                    lastSuccessfulPollAt = Date.now();
                    handlePostPollSuccess(data || {}, hadFailures);
                })
                .withFailureHandler(function(error) {
                    pollInFlight = false;
                    pollFailureCount += 1;
                    console.error('Polling error', error);
                    handlePollingFailure(error);
                })
                .getStudentPollStatus(SESSION_TOKEN, context);
        }

        function isSessionActive() {
            return studentContainer && studentContainer.style.display !== 'none' && entryScreen && entryScreen.style.display === 'none';
        }

        window.addEventListener('offline', function() {
            if (!isSessionActive()) return;
            recoveringFromOutage = true;
            showConnectivityState('offline', {
                message: 'Offline detected - we will hold your spot and resync when you are back.',
                icon: 'signal_wifi_off'
            });
        });

        window.addEventListener('online', function() {
            if (!isSessionActive()) return;
            showConnectivityState('connecting', {
                message: 'Reconnecting... your poll data is catching up.',
                icon: 'sync',
                submessage: 'Syncing now...'
            });
            startPolling(true);
        });

        if (resumeSessionBtn) {
            resumeSessionBtn.onclick = function() {
                console.log('Resume button clicked - attempting fullscreen');
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen()
                        .then(function() {
                            console.log('Fullscreen entered - confirming with server');
                            // Call studentConfirmFullscreen with the current lockVersion
                            google.script.run
                                .withSuccessHandler(function(response) {
                                    if (response.success && response.status === 'OK') {
                                        console.log('Server confirmed unlock - resuming poll');
                                        isInteractionBlocked = false;
                                        violationLogged = false;
                                        fullscreenEnteredOnce = false; // Reset for new fullscreen session
                                        if (proctorPollInterval) {
                                            clearInterval(proctorPollInterval);
                                            proctorPollInterval = null;
                                        }
                                        if (resumeControls) {
                                            resumeControls.style.display = 'none';
                                        }
                                        hideConnectivityBanner();
                                        startPolling(true);
                                        if (lastUnlockedState && lastUnlockedState.status && lastUnlockedState.status !== 'LOCKED' && lastUnlockedState.status !== 'AWAITING_FULLSCREEN') {
                                            updateStudentView(lastUnlockedState);
                                        }
                                    } else {
                                        console.error('Failed to confirm fullscreen:', response);
                                        statusMessage.textContent = 'Failed to resume. Please try again.';
                                    }
                                })
                                .withFailureHandler(function(error) {
                                    console.error('Error confirming fullscreen:', error);
                                    statusMessage.textContent = 'Error resuming session.';
                                })
                                .studentConfirmFullscreen(currentLockVersion, SESSION_TOKEN);
                        })
                        .catch(function(e) {
                            console.warn('Fullscreen denied on resume:', e);
                            statusMessage.textContent = 'Fullscreen is required. Please allow fullscreen and try again.';
                        });
                }
            };
        }

        if (startSessionBtn) {
            console.log('Attaching onclick handler to start session button');
            startSessionBtn.onclick = function() {
                console.log('!!! BEGIN SESSION BUTTON CLICKED !!!');
                console.log('Hiding entry screen, showing student container');
                entryScreen.style.display = 'none';
                studentContainer.style.display = 'block';
                isInteractionBlocked = false;
                isTeacherBlocked = false;
                violationLogged = false;
                fullscreenEnteredOnce = false; // Reset for new session
                if (resumeControls) {
                    resumeControls.style.display = 'none';
                }

                try {
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen().catch(function(e) {
                            console.warn('Fullscreen denied:', e);
                        });
                    }
                } catch (e) {
                    console.error('Fullscreen error:', e);
                }

                hideConnectivityBanner();
                startPolling(true);
            };
        } else {
            console.error('Start session button not found!');
        }

        function startProctorPolling() {
            stopPolling();
            if (proctorPollInterval) {
                clearInterval(proctorPollInterval);
            }
            proctorPollInterval = setInterval(checkProctorState, 2500);
            checkProctorState();
        }

        function checkProctorState() {
            google.script.run
                .withSuccessHandler(function(response) {
                    if (!response.success) {
                        console.error('Proctor state check failed:', response.error);
                        return;
                    }

                    // Check if status is AWAITING_FULLSCREEN and lockVersion matches
                    if (response.status === 'AWAITING_FULLSCREEN' && response.lockVersion === currentLockVersion) {
                        if (proctorPollInterval) {
                            clearInterval(proctorPollInterval);
                            proctorPollInterval = null;
                        }
                        showResumePrompt();
                    } else if (response.status === 'LOCKED' && response.lockVersion !== currentLockVersion) {
                        // New violation or version mismatch - update lockVersion
                        currentLockVersion = response.lockVersion;
                        showLockEnforcementUI();
                    } else if (response.status === 'BLOCKED') {
                        isTeacherBlocked = true;
                        if (response.lockVersion && response.lockVersion !== currentLockVersion) {
                            currentLockVersion = response.lockVersion;
                        }
                        showTeacherBlockedMessage();
                    } else if (response.status === 'OK') {
                        // Unlocked - resume normal polling
                        if (proctorPollInterval) {
                            clearInterval(proctorPollInterval);
                            proctorPollInterval = null;
                        }
                        isInteractionBlocked = false;
                        isTeacherBlocked = false;
                        violationLogged = false;
                        hideConnectivityBanner();
                        startPolling(true);
                        if (lastUnlockedState && lastUnlockedState.status && lastUnlockedState.status !== 'LOCKED' && lastUnlockedState.status !== 'AWAITING_FULLSCREEN') {
                            updateStudentView(lastUnlockedState);
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Proctor state check error:', error);
                })
                .getStudentProctorState(SESSION_TOKEN);
        }

        function updateStudentView(data) {
            data = data || {};
            if (studentLoader) studentLoader.style.display = 'none';
            if (data.sessionType === 'INDIVIDUAL_TIMED' || data.sessionType === 'SECURE_ASSESSMENT') {
                if (!secureSessionActive) {
                    secureSessionActive = true;
                    secureSessionHeartbeat.start(true);
                }
                setSecureChromeState(true);
                return;
            }
            if (secureSessionActive) {
                secureSessionActive = false;
                secureSessionHeartbeat.stop();
                setSecureConnectionIndicatorVisible(false);
                setSecureChromeState(false);
            }
            console.log('Status update:', data.status);

            // Only clear any existing status submessage content when
            // we're not showing the metacognition confidence prompt.
            if (statusSubMessage && pendingAnswerText === null) {
                statusSubMessage.style.display = 'none';
                statusSubMessage.textContent = '';
                statusSubMessage.innerHTML = '';
            }
            setPreLiveReconnectMessage('');

            currentPollState = data || {};

            if (data.status === 'LOCKED' || data.status === 'AWAITING_FULLSCREEN' || data.status === 'BLOCKED') {
                console.log('Server confirmed lock status on page load:', data.status);
                isInteractionBlocked = true;
                if (data.status === 'BLOCKED') {
                    isTeacherBlocked = true;
                    showTeacherBlockedMessage();
                }
                google.script.run
                    .withSuccessHandler(function(proctorResponse) {
                        if (proctorResponse.success) {
                            currentLockVersion = proctorResponse.lockVersion;
                            if (proctorResponse.status === 'AWAITING_FULLSCREEN') {
                                showResumePrompt();
                            } else if (proctorResponse.status === 'LOCKED') {
                                isTeacherBlocked = false;
                                showLockEnforcementUI();
                                startProctorPolling();
                            } else if (proctorResponse.status === 'BLOCKED') {
                                isTeacherBlocked = true;
                                showTeacherBlockedMessage();
                                startProctorPolling();
                            }
                        }
                    })
                    .withFailureHandler(handleError)
                    .getStudentProctorState(SESSION_TOKEN);
                return;
            }

            isTeacherBlocked = false;

            if (preLiveCard) {
                preLiveCard.style.display = 'none';
            }

            if (data.status !== 'LOCKED' && data.status !== 'AWAITING_FULLSCREEN' && data.status !== 'BLOCKED') {
                lastUnlockedState = data;
            }

            if (resumeControls) {
                resumeControls.style.display = 'none';
            }

            if (data.status === 'PRE_LIVE') {
                hasAnsweredCurrent = false;
                pendingSubmission = false;
                currentQuestionKey = null;
                questionContainer.style.display = 'none';
                if (statusContainer) {
                    statusContainer.style.display = 'none';
                }
                if (preLiveCard) {
                    preLiveCard.style.display = 'block';
                    if (preLivePrimary) {
                        preLivePrimary.textContent = data.message || 'Waiting for your teacher to begin the poll...';
                    }
                    if (preLiveSubline) {
                        preLiveSubline.textContent = 'This page will update automatically.';
                        preLiveSubline.style.display = 'block';
                        preLiveSubline.classList.remove('hidden');
                    }
                } else {
                    statusContainer.style.display = 'block';
                    statusMessage.textContent = data.message || 'Waiting for your teacher to begin the poll...';
                    statusMessage.className = 'text-white text-2xl font-semibold';
                    if (statusSubMessage) {
                        statusSubMessage.textContent = 'This page will update automatically.';
                        statusSubMessage.style.display = 'block';
                        statusSubMessage.className = 'text-white/60 text-base mt-4';
                    }
                }
                return;
            }

            if (data.status === 'LIVE' && typeof data.questionIndex === 'number' && data.questionIndex >= 0) {
                resetResultDecorations();
                lastUnlockedState = data;
                var resetTimestamp = (data.metadata && data.metadata.resetAt) ? data.metadata.resetAt : '';
                var questionKey = data.pollId + ':' + data.questionIndex + ':' + resetTimestamp;
                var isNewQuestion = questionKey !== currentQuestionKey;

                if (isNewQuestion) {
                    currentQuestionKey = questionKey;
                    hasAnsweredCurrent = !!data.hasSubmitted;
                    pendingSubmission = false;
                    pendingAnswerText = null;
                    currentMetacognitionEnabled = !!data.metacognitionEnabled;
                    currentPollState = data;
                    statusContainer.style.display = hasAnsweredCurrent ? 'block' : 'none';
                    questionContainer.style.display = hasAnsweredCurrent ? 'none' : 'block';

                    var qNum = (data.questionIndex || 0) + 1;
                    var qTotal = data.totalQuestions || '?';
                    if (questionNumberEl) {
                        questionNumberEl.textContent = 'Question ' + qNum + ' of ' + qTotal;
                    }

                    if (questionTextEl) {
                        questionTextEl.textContent = data.questionText || '';
                    }

                    if (questionSublineEl) {
                        questionSublineEl.classList.add('hidden');
                        questionSublineEl.textContent = '';
                    }

                    if (questionImageEl) {
                        if (data.questionImageURL) {
                            questionImageEl.src = data.questionImageURL;
                            questionImageEl.style.display = 'block';
                        } else {
                            questionImageEl.style.display = 'none';
                        }
                    }

                    if (noResponsesMessageEl) {
                        noResponsesMessageEl.classList.add('hidden');
                        noResponsesMessageEl.textContent = '';
                    }

                    optionsList.innerHTML = "";
                    var shuffled = shuffle(data.options || []);
                    var letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

                    // DEBUG: Log what we received
                    console.log('=== STUDENT RECEIVED DATA ===');
                    console.log('questionImageURL:', data.questionImageURL);
                    console.log('metacognitionEnabled:', data.metacognitionEnabled);
                    console.log('currentMetacognitionEnabled will be set to:', !!data.metacognitionEnabled);
                    console.log('options:', data.options);
                    if (data.options && data.options.length > 0) {
                        data.options.forEach(function(opt, idx) {
                            console.log('  Option ' + idx + ':', 'text="' + opt.text + '", imageURL=' + opt.imageURL);
                        });
                    }

                    currentOptionLayout = [];
                    shuffled.forEach(function(option, index) {
                        var letter = letters[index] || (index + 1).toString();
                        var btn = createOptionButton(option, letter, data.pollId, data.questionIndex);
                        var listItem = document.createElement('li');
                        listItem.appendChild(btn);
                        optionsList.appendChild(listItem);
                        currentOptionLayout.push({
                            text: option.text || '',
                            imageURL: option.imageURL || ''
                        });
                    });
                }

                if (pendingSubmission && !data.hasSubmitted) {
                    return;
                }

                // Only update hasAnsweredCurrent if we've actually attempted to submit
                // This prevents premature hiding of options due to stale server data
                if (data.hasSubmitted && (pendingSubmission || hasAnsweredCurrent)) {
                    hasAnsweredCurrent = true;
                    pendingSubmission = false;
                }

                if (hasAnsweredCurrent) {
                    questionContainer.style.display = 'none';
                    statusContainer.style.display = 'block';
                    statusMessage.textContent = data.hasSubmitted ? (data.message || 'Answer received - nice work.') : 'Answer received - nice work.';
                    statusMessage.className = 'text-green-300 text-2xl font-semibold';
                    if (statusSubMessage) {
                        statusSubMessage.textContent = 'Your teacher will reveal the answer shortly...';
                        statusSubMessage.style.display = 'block';
                        statusSubMessage.className = 'text-white/70 text-lg mt-4';
                    }
                    var iconEl = statusContainer.querySelector('.material-symbols-outlined');
                    if (iconEl) {
                        iconEl.textContent = 'check_circle';
                        iconEl.className = 'material-symbols-outlined text-6xl text-green-300 mb-4 inline-block';
                    }
                } else if (pendingAnswerText === null) {
                    // Only show question if we're not waiting for confidence input
                    questionContainer.style.display = 'block';
                    statusContainer.style.display = 'none';
                }
                // If pendingAnswerText is not null, we're showing confidence question - don't change display
                return;
            }

            if (data.status === 'RESULTS_HOLD' || data.status === 'RESULTS_REVEALED') {
                renderResultsStage(data);
                return;
            }

            // Non-live states
            resetResultDecorations();
            questionContainer.style.display = 'none';
            pendingSubmission = false;
            if (data.status !== 'PRE_LIVE') {
                hasAnsweredCurrent = !!data.hasSubmitted;
            } else {
                currentPollState = {};
                questionContainer.style.display = 'none';
                if (preLiveCard) {
                    preLiveCard.style.display = 'none';
                }
                statusContainer.style.display = 'block';
                var statusIcon = 'schedule';
                var statusClass = 'text-white';
                var statusTextClass = 'text-white text-2xl font-semibold';

                if (data.status === 'PRE_LIVE') {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || 'Waiting for your teacher to begin the poll...';
                    statusIcon = 'schedule';
                    statusClass = 'text-white';
                    if (statusSubMessage) {
                        statusSubMessage.textContent = 'This page will update automatically.';
                        statusSubMessage.style.display = 'block';
                        statusSubMessage.className = 'text-white/60 text-base mt-4';
                    }
                } else if (data.status === 'PAUSED') {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || 'Intermission! Your teacher’s cooking up the next one.';
                    statusIcon = 'hourglass_top';
                    statusClass = 'text-white';
                    if (statusSubMessage) {
                        statusSubMessage.style.display = 'none';
                        statusSubMessage.textContent = '';
                    }
                } else if (data.status === 'ENDED') {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || "That's a wrap! You just finished the poll — nicely done.";
                    statusIcon = 'emoji_events';
                    statusClass = 'text-yellow-300';
                    if (statusSubMessage) {
                        statusSubMessage.style.display = 'none';
                        statusSubMessage.textContent = '';
                    }
                    // Exit fullscreen when poll ends
                    if (document.fullscreenElement) {
                        document.exitFullscreen().catch(function(err) {
                            console.log('Error exiting fullscreen:', err);
                        });
                    }
                } else if (data.status === 'NOT_ENROLLED') {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || "You are not enrolled.";
                    statusTextClass = 'text-red-300 text-2xl font-bold';
                    statusIcon = 'error';
                    statusClass = 'text-red-300';
                    if (statusSubMessage) {
                        statusSubMessage.style.display = 'none';
                        statusSubMessage.textContent = '';
                    }
                    stopPolling();
                } else if (data.status === 'ERROR') {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || "We hit a snag. Try again soon.";
                    statusTextClass = 'text-red-300 text-2xl font-bold';
                    statusIcon = 'error';
                    statusClass = 'text-red-300';
                    if (statusSubMessage) {
                        statusSubMessage.style.display = 'none';
                        statusSubMessage.textContent = '';
                    }
                } else {
                    hasAnsweredCurrent = false;
                    statusMessage.textContent = data.message || 'Hang tight — your teacher’s loading the next challenge.';
                    statusIcon = 'hourglass_top';
                    statusClass = 'text-white';
                    if (statusSubMessage) {
                        statusSubMessage.style.display = 'none';
                        statusSubMessage.textContent = '';
                    }
                }
                if (preLivePrimary) {
                    preLivePrimary.textContent = data.message || 'Showtime is moments away.';
                }
                if (preLiveSubline) {
                    preLiveSubline.textContent = data.submessage || 'Your teacher is lining up the first challenge now — stay focused and we’ll launch together.';
                }
                return;
            }

            if (preLiveCard) {
                preLiveCard.style.display = 'none';
            }

            statusContainer.style.display = 'block';
            var statusIcon = 'schedule';
            var statusClass = 'text-white';
            var statusTextClass = 'text-white text-2xl font-semibold';

            if (data.status === 'PAUSED') {
                statusMessage.textContent = data.message || 'Poll is paused for a quick breather.';
                statusIcon = 'pause_circle';
                statusClass = 'text-white';
                if (statusSubMessage) {
                    statusSubMessage.textContent = data.submessage || 'Stay ready — we will resume as soon as your teacher unlocks the next prompt.';
                    statusSubMessage.style.display = 'block';
                    statusSubMessage.className = 'text-white/70 text-lg mt-4';
                }
            } else if (data.status === 'ENDED') {
                statusMessage.textContent = data.message || 'That is a wrap! You just finished the poll - nicely done.';
                statusIcon = 'emoji_events';
                statusClass = 'text-yellow-300';
                if (statusSubMessage) {
                    statusSubMessage.style.display = 'none';
                }
            } else if (data.status === 'NOT_ENROLLED') {
                statusMessage.textContent = data.message || 'You are not enrolled.';
                statusTextClass = 'text-red-300 text-2xl font-bold';
                statusIcon = 'error';
                statusClass = 'text-red-300';
                stopPolling();
            } else if (data.status === 'ERROR') {
                statusMessage.textContent = data.message || 'We hit a snag. Try again soon.';
                statusTextClass = 'text-red-300 text-2xl font-bold';
                statusIcon = 'error';
                statusClass = 'text-red-300';
            } else {
                statusMessage.textContent = data.message || 'Hang tight - your teacher is loading the next challenge.';
                statusIcon = 'hourglass_top';
                statusClass = 'text-white';
            }

            statusMessage.className = statusTextClass;
            var iconEl = statusContainer.querySelector('.material-symbols-outlined');
            if (iconEl) {
                iconEl.textContent = statusIcon;
                iconEl.className = 'material-symbols-outlined text-6xl mb-4 inline-block ' + statusClass;
            }
        }

        function submitAnswer(pollId, questionIndex, answerText) {
            console.log('=== SUBMIT ANSWER CALLED ===');
            console.log('currentMetacognitionEnabled:', currentMetacognitionEnabled);
            console.log('answerText:', answerText);

            if (isInteractionBlocked) {
                return;
            }
            if (hasAnsweredCurrent) {
                return;
            }

            var buttons = optionsList.querySelectorAll('button');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].disabled = true;
                if (buttons[i].dataset.answerText === answerText) {
                    buttons[i].className = optionSelectedClass;
                } else {
                    buttons[i].className = optionDisabledClass;
                }
            }

            // Check if metacognition is enabled for this question
            if (currentMetacognitionEnabled) {
                console.log('Metacognition is enabled - showing confidence question');
                pendingAnswerText = answerText;
                questionContainer.style.display = 'none';
                showConfidenceQuestion(pollId, questionIndex);
            } else {
                console.log('Metacognition is NOT enabled - submitting answer directly');
                hasAnsweredCurrent = true;
                pendingSubmission = true;
                statusContainer.style.display = 'block';
                questionContainer.style.display = 'none';
                submitAnswerToServer(pollId, questionIndex, answerText, null);
            }
        }

        function showConfidenceQuestion(pollId, questionIndex) {
            statusContainer.style.display = 'block';
            questionContainer.style.display = 'none';

            statusMessage.textContent = 'How confident are you in your answer?';
            statusMessage.className = 'text-white text-xl font-semibold mb-4';

            if (statusSubMessage) {
                statusSubMessage.innerHTML = '<div class="confidence-selector mt-6 flex flex-col gap-3">' +
                    '<button class="confidence-btn h-14 px-6 rounded-xl bg-red-500/20 hover:bg-red-500/30 text-white border-2 border-red-500/40 hover:border-red-500/60 transition-all font-semibold text-lg" data-confidence="guessing">' +
                    '<span class="mr-2">🤔</span> Guessing' +
                    '</button>' +
                    '<button class="confidence-btn h-14 px-6 rounded-xl bg-yellow-500/20 hover:bg-yellow-500/30 text-white border-2 border-yellow-500/40 hover:border-yellow-500/60 transition-all font-semibold text-lg" data-confidence="somewhat-sure">' +
                    '<span class="mr-2">🤷</span> Somewhat Sure' +
                    '</button>' +
                    '<button class="confidence-btn h-14 px-6 rounded-xl bg-blue-500/20 hover:bg-blue-500/30 text-white border-2 border-blue-500/40 hover:border-blue-500/60 transition-all font-semibold text-lg" data-confidence="very-sure">' +
                    '<span class="mr-2">👍</span> Very Sure' +
                    '</button>' +
                    '<button class="confidence-btn h-14 px-6 rounded-xl bg-green-500/20 hover:bg-green-500/30 text-white border-2 border-green-500/40 hover:border-green-500/60 transition-all font-semibold text-lg" data-confidence="certain">' +
                    '<span class="mr-2">💯</span> Absolutely Certain' +
                    '</button>' +
                    '</div>';
                statusSubMessage.style.display = 'block';
                statusSubMessage.className = 'text-white/90 text-base mt-4';

                var confidenceBtns = statusSubMessage.querySelectorAll('.confidence-btn');
                for (var i = 0; i < confidenceBtns.length; i++) {
                    confidenceBtns[i].addEventListener('click', function(event) {
                        event.preventDefault();
                        var confidence = this.dataset.confidence;
                        submitAnswerWithConfidence(pollId, questionIndex, pendingAnswerText, confidence);
                    });
                }
            }
        }

        if (secureBeginBtn) {
            secureBeginBtn.addEventListener('click', handleSecureBeginClick);
        }

        if (secureAccessCodeInput) {
            secureAccessCodeInput.addEventListener('input', function() {
                setSecureAccessError('');
            });
        }

        function submitAnswerWithConfidence(pollId, questionIndex, answerText, confidence) {
            hasAnsweredCurrent = true;
            pendingSubmission = true;
            statusMessage.textContent = 'Transmitting your response...';
            statusMessage.className = 'text-white text-2xl font-semibold';
            if (statusSubMessage) {
                statusSubMessage.innerHTML = '';
                statusSubMessage.style.display = 'none';
            }
            submitAnswerToServer(pollId, questionIndex, answerText, confidence);
        }

        function submitAnswerToServer(pollId, questionIndex, answerText, confidence) {
             // Live Poll
            google.script.run
                .withSuccessHandler(function(response) {
                    if (!response.success) {
                        hasAnsweredCurrent = false;
                        pendingSubmission = false;
                        pendingAnswerText = null;
                        statusMessage.textContent = response.error || 'We hit a hiccup. Try again?';
                        statusMessage.className = 'text-red-300 text-2xl font-semibold';
                        if (statusSubMessage) {
                            statusSubMessage.style.display = 'none';
                            statusSubMessage.textContent = '';
                        }
                        setTimeout(function() {
                            if (!isInteractionBlocked) {
                                questionContainer.style.display = 'block';
                                statusContainer.style.display = 'none';
                                var buttons = optionsList.querySelectorAll('button');
                                for (var i = 0; i < buttons.length; i++) {
                                    buttons[i].disabled = false;
                                    buttons[i].className = optionBaseClass;
                                }
                            }
                        }, 2000);
                    } else {
                        pendingAnswerText = null;
                        statusMessage.textContent = 'Answer received - nice work.';
                        statusMessage.className = 'text-green-300 text-2xl font-semibold';
                        if (statusSubMessage) {
                            statusSubMessage.textContent = 'Your teacher will reveal the answer shortly...';
                            statusSubMessage.style.display = 'block';
                            statusSubMessage.className = 'text-white/70 text-lg mt-4';
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    hasAnsweredCurrent = false;
                    pendingSubmission = false;
                    pendingAnswerText = null;
                    handleError(error);
                })
                .submitLivePollAnswer(pollId, questionIndex, answerText, SESSION_TOKEN, confidence);
        }

        function shuffle(array) {
            var arr = array.slice();
            for (var i = arr.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = arr[i];
                arr[i] = arr[j];
                arr[j] = temp;
            }
            return arr;
        }

        function createOptionButton(option, letter, pollId, questionIndex) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = optionBaseClass;
            btn.dataset.answerText = option.text || '';

            var displayText = (option.text || '').trim();

            var content = '<div class="option-leading">';
            content += '<div class="letter-badge" aria-hidden="true">' + letter + '</div>';
            content += '</div>';
            content += '<div class="option-body">';
            if (option.imageURL) {
                content += '<img src="' + escapeHtml(option.imageURL) + '" alt="Answer ' + letter + '" class="option-image" referrerpolicy="no-referrer">';
            }
            if (displayText) {
                // Remove carriage returns and normalize line endings before converting to <br>
                var cleanText = displayText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                content += '<p class="option-text">' + escapeHtml(cleanText).replace(/\n/g, '<br>') + '</p>';
            }
            content += '<span class="result-ribbon"></span>';
            content += '<span class="sr-only result-announcement"></span>';
            content += '</div>';

            content += '<span class="result-indicator" aria-hidden="true"></span>';
            btn.innerHTML = content;
            btn.addEventListener('click', function(event) {
                if (event && event.target && event.target.closest('.option-image')) {
                    return;
                }
                submitAnswer(pollId, questionIndex, option.text);
            });

            return btn;
        }

        function resetResultDecorations() {
            if (questionContainer) {
                questionContainer.classList.remove('results-stage');
                questionContainer.classList.remove('showing-results');
            }
            if (questionSublineEl) {
                questionSublineEl.classList.add('hidden');
                questionSublineEl.textContent = '';
            }
            if (noResponsesMessageEl) {
                noResponsesMessageEl.classList.add('hidden');
                noResponsesMessageEl.textContent = '';
            }
            if (!optionsList) return;
            var buttons = optionsList.querySelectorAll('button');
            buttons.forEach(function(btn) {
                btn.disabled = false;
                btn.className = optionBaseClass;
                btn.classList.remove('result-readonly', 'result-correct', 'result-incorrect', 'result-your-choice');
                var ribbon = btn.querySelector('.result-ribbon');
                if (ribbon) {
                    ribbon.textContent = '';
                    ribbon.classList.remove('is-visible');
                }
                var indicator = btn.querySelector('.result-indicator');
                if (indicator) {
                    indicator.textContent = '';
                }
                var srOnly = btn.querySelector('.result-announcement');
                if (srOnly) {
                    srOnly.textContent = '';
                }
            });
        }

        function ensureOptionsRenderedForResults(data) {
            if (!optionsList) return;
            if (optionsList.children.length > 0) {
                return;
            }

            var baseOptions = currentOptionLayout.length > 0 ? currentOptionLayout : (data.options || []);
            var letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            optionsList.innerHTML = '';
            currentOptionLayout = [];

            baseOptions.forEach(function(option, index) {
                var normalized = {
                    text: option.text || option,
                    imageURL: option.imageURL || option.imageUrl || ''
                };
                var letter = letters[index] || (index + 1).toString();
                var btn = createOptionButton(normalized, letter, data.pollId, data.questionIndex);
                btn.disabled = true;
                btn.classList.add('result-readonly');
                var listItem = document.createElement('li');
                listItem.appendChild(btn);
                optionsList.appendChild(listItem);
                currentOptionLayout.push({
                    text: normalized.text || '',
                    imageURL: normalized.imageURL || ''
                });
            });
        }

        function decorateOptionsForResults(data) {
            if (!optionsList) return;
            var totalResponses = typeof data.totalResponses === 'number' ? data.totalResponses : 0;
            var percentages = data.resultPercentages || {};
            var buttons = optionsList.querySelectorAll('button');

            buttons.forEach(function(btn) {
                var answerText = btn.dataset.answerText || '';
                btn.disabled = true;
                btn.className = optionBaseClass + ' result-readonly';
                btn.classList.remove('result-correct', 'result-incorrect', 'result-your-choice');

                var ribbon = btn.querySelector('.result-ribbon');
                if (ribbon) {
                    ribbon.textContent = '';
                    ribbon.classList.remove('is-visible');
                }

                var indicator = btn.querySelector('.result-indicator');
                if (indicator) {
                    indicator.textContent = '';
                }

                var srOnly = btn.querySelector('.result-announcement');
                if (srOnly) {
                    srOnly.textContent = '';
                }

                if (data.status !== 'RESULTS_REVEALED') {
                    return;
                }

                var percentage = typeof percentages[answerText] === 'number' ? percentages[answerText] : 0;
                if (ribbon) {
                    if (totalResponses > 0) {
                        ribbon.textContent = percentage + '%';
                        ribbon.classList.add('is-visible');
                    } else {
                        ribbon.textContent = '';
                        ribbon.classList.remove('is-visible');
                    }
                }

                var isCorrect = data.correctAnswer && answerText === data.correctAnswer;
                var hasStudentAnswer = data.studentAnswer !== undefined && data.studentAnswer !== null && data.studentAnswer !== '';
                var isStudentChoice = hasStudentAnswer && answerText === data.studentAnswer;
                var studentIsCorrect = (data.studentIsCorrect === null || data.studentIsCorrect === undefined)
                    ? null
                    : !!data.studentIsCorrect;

                if (isCorrect) {
                    btn.classList.add('result-correct');
                } else {
                    btn.classList.add('result-incorrect');
                }

                if (isStudentChoice && (studentIsCorrect === false || !isCorrect)) {
                    btn.classList.add('result-your-choice');
                }

                if (indicator) {
                    if (isCorrect) {
                        indicator.textContent = '✓';
                    } else if (isStudentChoice && studentIsCorrect === false) {
                        indicator.textContent = '✕';
                    } else {
                        indicator.textContent = '';
                    }
                }

                if (srOnly) {
                    var srParts = [];
                    if (isCorrect) {
                        srParts.push('Correct answer');
                    }
                    if (isStudentChoice) {
                        srParts.push('Your selection');
                    }
                    if (totalResponses > 0) {
                        srParts.push(percentage + '% of class selected this choice');
                    } else {
                        srParts.push('No responses recorded');
                    }
                    srOnly.textContent = srParts.join('. ') + '.';
                }
            });
        }

        function renderResultsStage(data) {
            currentPollState = data;
            var resetTimestamp = (data.metadata && data.metadata.resetAt) ? data.metadata.resetAt : '';
            currentQuestionKey = data.pollId + ':' + data.questionIndex + ':' + resetTimestamp;
            hasAnsweredCurrent = !!data.hasSubmitted;
            questionContainer.style.display = 'block';
            statusContainer.style.display = 'none';

            var qNum = (data.questionIndex || 0) + 1;
            var qTotal = data.totalQuestions || '?';
            if (questionNumberEl) {
                questionNumberEl.textContent = 'Question ' + qNum + ' of ' + qTotal;
            }
            if (questionTextEl) {
                questionTextEl.textContent = data.questionText || '';
            }
            if (questionImageEl) {
                if (data.questionImageURL) {
                    questionImageEl.src = data.questionImageURL;
                    questionImageEl.style.display = 'block';
                } else {
                    questionImageEl.style.display = 'none';
                }
            }

            if (questionSublineEl) {
                questionSublineEl.textContent = 'Shown after responses closed.';
                questionSublineEl.classList.remove('hidden');
            }

            if (data.status === 'RESULTS_REVEALED' && noResponsesMessageEl) {
                if ((data.totalResponses || 0) === 0) {
                    noResponsesMessageEl.textContent = 'No responses recorded for this question.';
                    noResponsesMessageEl.classList.remove('hidden');
                } else {
                    noResponsesMessageEl.classList.add('hidden');
                    noResponsesMessageEl.textContent = '';
                }
            } else if (noResponsesMessageEl) {
                noResponsesMessageEl.classList.add('hidden');
                noResponsesMessageEl.textContent = '';
            }

            ensureOptionsRenderedForResults(data);

            questionContainer.classList.add('results-stage');
            questionContainer.classList.remove('showing-results');
            if (data.status === 'RESULTS_REVEALED') {
                requestAnimationFrame(function() {
                    questionContainer.classList.add('showing-results');
                });
            }

            decorateOptionsForResults(data);
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showStatusPanel(options) {
            options = options || {};
            hideConnectivityBanner();
            hideSecureLobby();
            if (studentContainer) studentContainer.style.display = 'block';
            if (entryScreen) entryScreen.style.display = 'none';
            if (questionContainer) questionContainer.style.display = 'none';
            if (secureFocusContainer) secureFocusContainer.style.display = 'none';
            if (studentLoader) studentLoader.style.display = 'none';
            if (statusContainer) statusContainer.style.display = 'block';
            if (statusMessage) {
                statusMessage.textContent = options.message || '';
                statusMessage.className = options.messageClass || 'text-white text-2xl font-semibold';
            }
            if (statusSubMessage) {
                if (options.subtext) {
                    statusSubMessage.style.display = 'block';
                    statusSubMessage.textContent = options.subtext;
                    statusSubMessage.className = options.subClass || 'text-white/70 text-base mt-4';
                } else {
                    statusSubMessage.style.display = 'none';
                    statusSubMessage.textContent = '';
                }
            }
            var iconEl = statusContainer ? statusContainer.querySelector('.material-symbols-outlined') : null;
            if (iconEl) {
                iconEl.textContent = options.icon || 'info';
                iconEl.className = 'material-symbols-outlined text-6xl mb-4 inline-block ' + (options.iconClass || 'text-white');
            }
            if (resumeControls) {
                resumeControls.style.display = options.showResume ? 'block' : 'none';
            }
            if (document && document.body) {
                if (options.lockScroll) {
                    document.body.classList.add('secure-overlay-active');
                } else {
                    document.body.classList.remove('secure-overlay-active');
                }
            }
        }

        function showLockedMessage(message, subMessage) {
            console.log('Showing locked message');
            stopPolling();
            recoveringFromOutage = false;
            showStatusPanel({
                icon: 'lock',
                iconClass: 'text-red-300',
                message: message || 'Oops - you left fullscreen. Your poll has been paused until your teacher lets you back in.',
                messageClass: 'text-red-300 text-xl font-semibold',
                subtext: subMessage || '',
                subClass: 'text-red-200 text-base mt-4',
                showResume: false,
                lockScroll: true
            });
            isTeacherBlocked = false;
        }

        function showLockEnforcementUI(message, subtext) {
            if (secureSessionActive) {
                showSecureLockout(message, subtext);
            } else {
                showLockedMessage(message, subtext);
            }
        }

        function showTeacherBlockedMessage() {
            console.log('Showing teacher block message');
            stopPolling();
            isInteractionBlocked = true;
            isTeacherBlocked = true;
            showStatusPanel({
                icon: 'block',
                iconClass: 'text-amber-200',
                message: 'Your teacher has paused responses for this question.',
                messageClass: 'text-amber-200 text-xl font-semibold',
                subtext: 'Stay in fullscreen and wait for your teacher to unblock you.',
                subClass: 'text-amber-200/80 text-base mt-4',
                showResume: false,
                lockScroll: true
            });
        }

        function showResumePrompt() {
            console.log('Showing resume prompt');
            stopPolling();
            showStatusPanel({
                icon: 'fullscreen',
                iconClass: 'text-green-300',
                message: 'You are cleared for re-entry. Go fullscreen to get back in the game.',
                messageClass: 'text-white text-xl font-semibold',
                showResume: true,
                lockScroll: true
            });
        }

        function handleError(error) {
            console.error('Error:', error);
            showStatusPanel({
                icon: 'error',
                iconClass: 'text-yellow-300',
                message: 'An error occurred: ' + (error.message || error),
                messageClass: 'text-yellow-300 text-2xl font-bold',
                showResume: false,
                lockScroll: false
            });
            if (resumeControls) resumeControls.style.display = 'none';
        }
    })();
    </script>
</body>
</html>
