import"./firebase-7PLbf-9k.js";import"./proctoring-CP4HimPX.js";(function(){console.log("Veritas Student Script IIFE executing...");var D=document.getElementById("individual-timed-session"),gn=document.getElementById("secure-progress-label"),Ne=document.getElementById("secure-countdown"),$=document.getElementById("secure-topbar-timer"),we=document.getElementById("timer-visibility-toggle"),ne=document.getElementById("question-progress"),yn=document.getElementById("student-mode-label"),et=document.getElementById("question-content"),tt=document.getElementById("question-visual"),pn=document.getElementById("secure-question-layout"),bn=document.getElementById("secure-question-visual"),Be=document.getElementById("secure-connection-dot"),kt=document.getElementById("secure-connection-indicator"),hn=document.getElementById("secure-connection-status"),Me=document.getElementById("secure-connection-warning"),X=document.getElementById("secure-question-text"),_t=document.getElementById("secure-question-subline"),J=document.getElementById("secure-question-image"),O=document.getElementById("secure-options-list"),H=document.getElementById("secure-submit-btn"),nt=document.getElementById("secure-submit-label"),st=document.getElementById("secure-submit-hint"),Z=document.getElementById("secure-confidence-prompt"),ge=!1,it="00:00",ot=0,En=document.body,xe=null,U=null,rt=null,K=null,z=null,se=null,lt=-1,at=null,Pt=null,ct="vlp_poll_state_cache",cs=300*1e3;function us(e){if(!(!e||!e.pollId))try{var t={state:e,cachedAt:Date.now()};sessionStorage.setItem(ct,JSON.stringify(t)),console.log("[StateCache] Cached poll state for:",e.pollId)}catch(n){console.warn("[StateCache] Failed to cache state:",n)}}function ds(){try{var e=sessionStorage.getItem(ct);if(!e)return null;var t=JSON.parse(e),n=Date.now()-t.cachedAt;return n>cs?(console.log("[StateCache] Cache expired (age:",Math.round(n/1e3),"s)"),sessionStorage.removeItem(ct),null):(console.log("[StateCache] Found valid cache (age:",Math.round(n/1e3),"s)"),t.state)}catch(s){return console.warn("[StateCache] Failed to read cache:",s),null}}function fs(){try{sessionStorage.removeItem(ct)}catch{}}function ms(e,t){return e?{pollId:t,status:e.status,questionIndex:typeof e.currentQuestionIndex=="number"?e.currentQuestionIndex:null,questionText:e.questionText||null,options:e.options||null,resultsVisibility:e.resultsVisibility||null,studentEmail:window.STUDENT_EMAIL,calculatorEnabled:e.calculatorEnabled===!0,liveProctoring:e.liveProctoring===!0,sessionType:e.sessionType||"LIVE_POLL"}:null}function vs(){var e=ds();if(!e)return console.log("[StateRehydration] No valid cached state found"),!1;if(console.log("[StateRehydration] Rehydrating from cache immediately"),e.status==="ENDED"||e.status==="CLOSED")return console.log("[StateRehydration] Cached state is ENDED/CLOSED, clearing cache"),fs(),!1;try{return fe(e),console.log("[StateRehydration] Successfully rendered from cache"),!0}catch(t){return console.error("[StateRehydration] Failed to render cached state:",t),!1}}var ye=(function(){var e={};return{attach:function(t,n,s,i){this.detach(t),n.on(s,i),e[t]={ref:n,eventType:s,callback:i,attachedAt:Date.now()},console.log("[ListenerManager] Attached listener: "+t)},detach:function(t){if(e[t]){var n=e[t];try{n.ref.off(n.eventType,n.callback),console.log("[ListenerManager] Detached listener: "+t)}catch(s){console.warn("[ListenerManager] Error detaching "+t+":",s)}delete e[t]}},detachAll:function(){var t=Object.keys(e);t.forEach(function(n){ye.detach(n)}),console.log("[ListenerManager] Detached all listeners ("+t.length+" total)")},getActiveCount:function(){return Object.keys(e).length},listActive:function(){return Object.keys(e)}}})();if(typeof firebase<"u"&&typeof FIREBASE_CONFIG<"u"){if(!firebase.apps.length)try{firebase.initializeApp(FIREBASE_CONFIG),console.log("[Init] Firebase initialized eagerly")}catch(e){console.error("[Init] Firebase eager init failed:",e)}firebase.apps.length&&(U=firebase.database(),firebase.functions&&(rt=firebase.functions()))}function gs(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}function ut(e){if(!e)return"";var t=e;return typeof DOMPurify<"u"?t=DOMPurify.sanitize(e,{ADD_TAGS:["math","annotation","semantics","mrow","mi","mo","mn","msup","sub","sup"],ADD_ATTR:["class","style"]}):console.warn("DOMPurify not loaded - rendering as raw HTML"),'<div class="ql-editor">'+t+"</div>"}function Nt(){window.renderMathInElement&&renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})}async function wn(e,t){if(!(!FIREBASE_CONFIG||!e||!t)){if(se&&se!==e&&(console.log("[Firebase] PollId changed from "+se+" to "+e+" - Cleaning up via ListenerManager..."),ye.detachAll(),K=null,at=null,Pt=null,se=null),K&&se===e){console.log("[Firebase] Already initialized for pollId: "+e+" (Active listeners: "+ye.getActiveCount()+")");return}if(typeof firebase<"u"&&!firebase.apps.length&&firebase.initializeApp(FIREBASE_CONFIG),typeof firebase<"u"){U=firebase.database(),firebase.functions&&(rt=firebase.functions()),z=await window.VeritasShared.generateStudentKey(t,e),se=e;var n="sessions/"+e+"/students/"+z;K=U.ref(n),K.once("value").then(function(l){var a=l.val(),c=!a||typeof a!="object";if(c){var u={status:"ACTIVE",name:window.STUDENT_NAME||"Unknown",email:window.STUDENT_EMAIL||"unknown",joinedAt:firebase.database.ServerValue.TIMESTAMP,lockVersion:0,userAgent:navigator.userAgent};K.set(u),console.log("[Firebase] Initialized student state object:",u)}else(a.status==="DISCONNECTED"||!a.status)&&K.update({status:"ACTIVE",lastActiveAt:firebase.database.ServerValue.TIMESTAMP})}),K.onDisconnect().update({status:"DISCONNECTED",lastDisconnectedAt:firebase.database.ServerValue.TIMESTAMP});var s=function(l){var a=l.val();bs(a),Mt(a,null,se)};ye.attach("studentStatus_"+e,K,"value",s),Pt=U.ref(".info/connected");var i=function(l){var a=l.val()===!0;Mt(null,a,se),ys(a),a?(console.log("[Adaptive Polling] Firebase connected - switching to balanced poll (5s)"),Ie=5e3,console.log("[Connectivity Recovery] Reconnected - triggering soft poll to sync state"),typeof re=="function"&&re(!0)):(console.log("[Adaptive Polling] Firebase disconnected - switching to fast poll (2.5s)"),Ie=2500)};ye.attach("connectionState",Pt,"value",i);var o="sessions/"+e+"/live_session";at=U.ref(o),console.log("[Firebase] Executing immediate fetch on live_session..."),at.once("value").then(function(l){var a=l.val();if(a&&(console.log("[Firebase] Immediate fetch received:",a.status),!window._immediateFetchProcessed)){window._immediateFetchProcessed=!0;var c=ms(a,e);c&&fe(c)}}).catch(function(l){console.warn("[Firebase] Immediate fetch failed:",l)});var r=function(l){var a=l.val();if(a){if(console.log("[Firebase] Live Session update received:",a),typeof a.questionIndex=="number"){var c=a.questionIndex;lt!==c&&console.log("[Sync Spine] Server question index ("+c+") differs from local ("+lt+") - forcing sync")}if(a.questionText&&a.pollId&&typeof fe=="function"){console.log("[Firebase] Fast Path: Updating view from pushed state");var u={pollId:a.pollId,questionIndex:a.questionIndex,status:a.status||"OPEN",questionText:a.questionText,questionImageURL:a.questionImageURL,options:a.options||[],totalQuestions:a.totalQuestions,sessionPhase:a.sessionPhase||a.metadata&&a.metadata.sessionPhase||"LIVE",resultsVisibility:a.resultsVisibility||a.metadata&&a.metadata.resultsVisibility||"HIDDEN"};if(a.metadata)for(var f in a.metadata)u.hasOwnProperty(f)||(u[f]=a.metadata[f]);fe(u),setTimeout(Nt,50)}else a.status&&a.status!=="OPEN"&&(console.log("[Firebase] Fast Path (Status Only): Processing status change to "+a.status),typeof fe=="function"&&fe({pollId:a.pollId||e,questionIndex:a.questionIndex,status:a.status,sessionPhase:a.sessionPhase||"LIVE"})),console.log("[Firebase] Slow Path: Incomplete data, polling server to ensure consistency"),re(!0)}};ye.attach("liveSession_"+e,at,"value",r),console.log("[Firebase] Sidecar initialized for",n,"(Listeners: "+ye.getActiveCount()+")")}}}var dt=!1,R=null;function ys(e){R||(R=document.createElement("div"),R.id="connectivity-toast",R.className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] px-6 py-3 rounded-full shadow-lg transition-all duration-300 flex items-center gap-3",R.style.cssText="opacity: 0; pointer-events: none;",document.body.appendChild(R)),!e&&!dt?(R.innerHTML='<span class="inline-block w-3 h-3 rounded-full bg-amber-400 animate-pulse"></span><span class="font-semibold text-amber-900">Reconnecting...</span>',R.className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] px-6 py-3 rounded-full shadow-lg transition-all duration-300 flex items-center gap-3 bg-amber-100 border border-amber-300",R.style.opacity="1",R.style.pointerEvents="auto",dt=!0,console.log("[Connectivity] Showing reconnecting toast")):e&&dt&&(R.innerHTML='<span class="inline-block w-3 h-3 rounded-full bg-emerald-500"></span><span class="font-semibold text-emerald-900">Connected</span>',R.className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] px-6 py-3 rounded-full shadow-lg transition-all duration-300 flex items-center gap-3 bg-emerald-100 border border-emerald-300",setTimeout(function(){R.style.opacity="0",R.style.pointerEvents="none",dt=!1,console.log("[Connectivity] Hiding toast - connection restored")},2e3))}async function xn(e,t,n,s,i,o,r){if(!U)return console.warn("[Firebase] DB not initialized, skipping fast write"),null;try{var l=o||window.STUDENT_EMAIL||sessionStorage.getItem("veritas_student_email");if(!l)return console.error("[Firebase] Cannot submit answer - no email found"),null;var a=gs(),c=new Date().toISOString(),u={responseId:a,pollId:e,questionIndex:t,answer:n,answerId:s,studentEmail:l,confidenceLevel:i||null,timestamp:c,clientTimestamp:Date.now(),timeOnQuestionMs:r?r.timeOnQuestion:null,usingCalculator:r?r.usingCalculator:!1,activityStatus:r?r.status:null},f=z||l.replace(/\./g,",");if(!f)return console.error("[Firebase] No student key available for submission"),null;var m="answers/"+e+"/"+f,p=U.ref(m).set(u),I="sessions/"+e+"/students/"+f,L={status:"Submitted",lastActive:firebase.database.ServerValue.TIMESTAMP,lastSubmissionQuestionIndex:t,lastSubmissionTimestamp:firebase.database.ServerValue.TIMESTAMP},Q=U.ref(I).update(L);return await Promise.all([p,Q]),console.log("[Firebase] DUAL-WRITE successful:"),console.log("  - Answer path: "+m),console.log("  - Status path: "+I),{success:!0,responseId:a,timestamp:c}}catch(j){return console.error("[Firebase] Fast Answer Failed:",j),null}}var ps=(function(){var e=null;function t(){var n=[],s=null,i=null,o=null,r=null,l=null;document.hasFocus();var a=null,c=3e3,u=50;function f(w,F,M){s=w,i=F||"",o=M,r=Date.now(),l=null,a||(a=setInterval(le,c)),window._activityTrackerFocusAttached||(window.addEventListener("focus",j),window.addEventListener("blur",me),window._activityTrackerFocusAttached=!0),p("QUESTION_VIEW",{viewedAt:Date.now(),questionIndex:M})}function m(w){r=w||Date.now()}function p(w,F){if(s){var M={pollId:s,sessionId:i,questionIndex:o!==void 0?o:"",eventType:w,eventData:F||{},clientTimestamp:new Date().toISOString()};n.push(M),n.length>=u&&le()}}function I(w,F){var M=F?"ANSWER_CHANGED":"ANSWER_SELECTED",ve=r?Date.now()-r:0;p(M,{answer:w,previousAnswer:l,timeOnQuestionMs:ve}),l=w}function L(w,F){var M=r?Date.now()-r:0;p("ANSWER_SUBMITTED",{answer:w,confidenceLevel:F||null,timeOnQuestionMs:M,totalTimeMs:M})}function Q(w,F){p("OPTION_CLICKED",{optionIndex:w,optionText:F})}function j(){p("FOCUS_GAINED",{timestamp:Date.now()})}function me(){p("FOCUS_LOST",{timestamp:Date.now()})}async function le(){if(!(n.length===0||!U)){var w=n.slice();n=[];var F=se||(w.length>0?w[0].pollId:null);if(!F||!z){n=w.concat(n);return}try{var M=U.ref("sessions/"+F+"/activities/"+z),ve={};w.forEach(function(d){var v=M.push().key;ve[v]=d}),await M.update(ve),console.log("[ActivityTracker] (Firebase) Flushed "+w.length+" events")}catch(d){console.error("[ActivityTracker] Firebase Flush failed:",d),n=w.concat(n)}}}function Pe(){le(),s=null,i=null,o=null,r=null,l=null}function Tt(){a&&(clearInterval(a),a=null),le()}return{init:f,setQuestionStart:m,recordActivity:p,recordAnswerSelected:I,recordAnswerSubmitted:L,recordOptionClick:Q,flushActivities:le,reset:Pe,destroy:Tt}}return{getInstance:function(){return e||(e=t()),e}}})(),Bt=ps.getInstance();function Mt(e,t,n){if(!(!FIREBASE_CONFIG||!Veritas.Config.DEBUG_FIREBASE)){var s=document.getElementById("firebase-debug-hud");s||(s=document.createElement("div"),s.id="firebase-debug-hud",s.style.cssText="position:fixed;bottom:10px;left:10px;background:rgba(0,0,0,0.95);color:#4ade80;font-family:monospace;font-size:11px;padding:12px;z-index:9999;pointer-events:none;max-width:350px;border:2px solid #4ade80;border-radius:8px;",document.body.appendChild(s)),e!=null&&(s.dataset.status=e),t!=null&&(s.dataset.connected=t),n!=null&&(s.dataset.pollId=n);var i=s.dataset.status||"UNKNOWN",o=s.dataset.connected==="true",r=s.dataset.pollId||"N/A",l=o?'<span style="color:#4ade80">‚óè</span>':'<span style="color:#f87171">‚óè</span>',a='<strong style="color:#fff">üî• FIREBASE DEBUG (STUDENT)</strong><br>';a+=l+" <strong>.info/connected:</strong> "+o+"<br>",a+="<strong>PollId (sessionKey):</strong> "+r+"<br>",a+="<strong>StudentKey:</strong> "+(z?z.substring(0,12)+"...":"N/A")+"<br>";var c=i==="LOCKED"?"#f87171":i==="ACTIVE"?"#4ade80":"#facc15";a+='<strong>RTDB Status:</strong> <span style="color:'+c+'">'+i+"</span><br>";var u="";try{u=sessionStorage.getItem("lock_reason")||"None"}catch{u="N/A"}a+="<strong>Last violation:</strong> "+u,s.innerHTML=a}}function bs(e){console.log("[Firebase] Remote status update:",e);var t;if(typeof e=="string")t=e;else if(e&&typeof e=="object")t=e.status;else{console.warn("[Firebase] Invalid status data received:",e);return}if(t==="LOCKED"){if(!_.isLocked()){var n=e&&e.lastViolationReason||"Teacher Remote Lock";_.lock(n)}}else if(t==="ACTIVE"||t==="AWAITING_FULLSCREEN"){var s=_.isLocked()||qt();s?(console.log("[Firebase] Unlock signal received - checking server for AWAITING_FULLSCREEN"),checkProctorState()):console.log("[Firebase] Unlock signal received but not locally locked - ignoring")}else t==="DISCONNECTED"&&console.log("[Firebase] Detected DISCONNECTED state - will recover on reconnect")}function pe(e,t){e&&sessionStorage.setItem("lock_reason",e);var n=t||A&&A.pollId||S&&S.pollId||window.currentPollId;if(!n)try{n=sessionStorage.getItem("veritas_active_poll_id")}catch{}if(K){if(K.update({status:"LOCKED",lastViolationReason:e,lastViolationAt:firebase.database.ServerValue.TIMESTAMP}).catch(function(r){console.error("[Firebase] Failed to report violation lock:",r)}),e&&n&&(window.studentKey||z)){var s=window.studentKey||z,i=U.ref("sessions/"+n+"/violations/"+s);i.push({reason:e,timestamp:firebase.database.ServerValue.TIMESTAMP})}}else if(U&&n&&(window.studentKey||z)){var s=window.studentKey||z,o="sessions/"+n+"/students/"+s;K=U.ref(o),pe(e,n)}else console.log("[Firebase] RTDB Ref not ready - relying on Cloud Function for violation report");Mt("LOCKED",null,n)}var ft=(function(){var e;function t(){var n=Date.now(),s=Date.now(),i=!1;function o(){n=Date.now()}function r(u){s=u||Date.now()}function l(u){i=!!u}function a(){var u=Date.now(),f=u-n,m=f>3e4?"IDLE":i?"CALCULATOR":"ACTIVE";return{status:m,lastInteraction:n,currentQuestionStart:s,timeOnQuestion:Math.max(0,u-s),usingCalculator:i}}function c(){["click","mousemove","keydown","touchstart"].forEach(function(f){document.addEventListener(f,o,{passive:!0})});var u=document.getElementById("calc-iframe");u&&(u.addEventListener("focus",function(){l(!0),o()}),u.addEventListener("blur",function(){l(!1)}))}return c(),{markInteraction:o,setQuestionStart:r,setCalculatorState:l,getTelemetry:a}}return{getInstance:function(){return e||(e=t()),e}}})(),Ft=null,Dt=null,Fe=null;try{window.SecureAssessmentShared?(Ft=window.SecureAssessmentShared.createCountdown({onTick:function(e){Is(e)},onExpire:function(){Cs()}}),Dt=window.SecureAssessmentShared.createHeartbeat({intervalMs:3500,onBeat:function(){Nn()}}),Fe=window.SecureAssessmentShared.createFullscreenManager(document,{onChange:js})):console.error("[Proctor] SecureAssessmentShared dependency is missing. Secure features will be disabled.")}catch(e){console.error("[Proctor] Failed to initialize SecureAssessmentShared modules:",e)}var Sn=null,mt=null,Ot=null;we&&we.addEventListener("click",function(){ge=!ge,bt()}),bt();var N=!1,E=null,Y=null,vt=null,ie=!1,gt=!1,yt=!1,Rt=!1,De=null,oe={views:["entry-screen","secure-lobby","status-container","pre-live-card","student-container","question-container","individual-timed-session","student-loader"],show:function(e){var t=["question-container","pre-live-card","status-container"].indexOf(e)!==-1;this.views.forEach(function(n){var s=document.getElementById(n);s&&(n===e||n==="student-container"&&t?(s.style.display="block",s.classList.remove("hidden")):(s.style.display="none",s.classList.add("hidden")))}),console.log("[ViewManager] Active View:",e)}};window.onerror=function(e,t,n,s,i){var o=document.getElementById("debug-content");if(o){var r=new Date().toLocaleTimeString();o.innerHTML+=`
[${r}] ERROR: ${e}
Line: ${n}`;var l=document.getElementById("debug-overlay");l&&e.indexOf("ScriptError")===-1&&l.classList.remove("hidden")}return!1};var _={isLocked:function(){try{return sessionStorage.getItem("veritas_lock_active")==="true"}catch{return!1}},lock:function(e){console.warn("[LockManager] LOCKING:",e);try{sessionStorage.setItem("veritas_lock_active","true"),sessionStorage.setItem("lock_reason",e||"unknown")}catch{}this.renderLockScreen(e);var t=typeof A<"u"&&A&&A.pollId||typeof S<"u"&&S&&S.pollId||typeof E<"u"&&E&&E.pollId||window.currentPollId;if(!t)try{t=sessionStorage.getItem("veritas_active_poll_id")}catch{}if(!t){console.error("[LockManager] CRITICAL: No pollId available for violation report!");return}typeof pe=="function"&&pe(e,t);var n=window.STUDENT_EMAIL||"";if(!n)try{n=sessionStorage.getItem("veritas_student_email")||""}catch{}console.log("[LockManager] Violation reported via Firebase path")},unlock:function(){console.log("[LockManager] UNLOCKING");try{sessionStorage.removeItem("veritas_lock_active"),sessionStorage.removeItem("lock_reason")}catch{}At()},renderLockScreen:function(e){V(e)}};function In(){try{console.log("[Proctor] ANTIDOTE - Clearing Poison Pill lock state"),sessionStorage.removeItem("veritas_lock_active"),sessionStorage.removeItem("is_locally_locked"),sessionStorage.removeItem("lock_reason"),sessionStorage.removeItem("lock_timestamp")}catch(e){console.warn("[Proctor] Could not clear lock from sessionStorage:",e)}}function qt(){try{return sessionStorage.getItem("veritas_lock_active")==="true"}catch{return!1}}function hs(){return N?"Secure Assessment":"Live Poll"}function Vt(e){yn&&(yn.textContent=e?"Secure Assessment":"Live Poll"),$&&($.classList.toggle("hidden",!e),e&&Ne&&(Ne.textContent=it||"00:00"))}function Ln(e){var t=Math.floor(e/60),n=e%60;return("0"+t).slice(-2)+":"+("0"+n).slice(-2)}function Ut(e,t){if(ne){var n=typeof e=="number"?e:parseInt(e,10),s=typeof t=="number"?t:parseInt(t,10),i=isNaN(n)?0:Math.max(0,n),o=isNaN(s)||s<=0?"?":Math.max(1,s);ne.textContent="QUESTION "+(i+1)+" OF "+o,ne.classList.remove("hidden")}}function Es(e){return!e||!e.question?null:e.question.id?e.question.id:e.question.questionId?e.question.questionId:typeof e.actualQuestionIndex=="number"?(e.pollId||"poll")+":"+e.actualQuestionIndex:(e.pollId||"poll")+":"+(e.progressIndex||0)}function Qt(e){En&&En.classList.toggle("secure-mode-active",!!e)}function pt(e){kt&&(e?kt.classList.remove("hidden"):kt.classList.add("hidden"))}function Cn(){if(O){var e=O.querySelectorAll("button.secure-answer-option");e.forEach(function(t){var n=parseInt(t.dataset.optionIndex,10),s=n===Y;t.classList.toggle("answer-option-selected",s),t.setAttribute("aria-pressed",s?"true":"false")})}}function An(e){if(_.isLocked()){console.log("[Proctor] showIndividualTimedView BLOCKED - Lock active"),_.renderLockScreen(sessionStorage.getItem("lock_reason"));return}if(cn(),ae&&(ae.style.display="none"),k&&(k.style.display="none"),W&&(W.style.display="none"),P.style.display="block",y.style.display="none",g.style.display="none",Se&&(Se.style.display="none"),D&&(D.style.display="block"),document.body.style.overflow="hidden",Qt(!0),N||(N=!0,Dt.start(!0)),Vt(!0),vn(e.calculatorEnabled),$&&$.classList.remove("hidden"),Ns(),pt(!0),qs(),E=e,e&&e.pollId){window.currentPollId=e.pollId;try{sessionStorage.setItem("veritas_active_poll_id",e.pollId)}catch{}}k&&(k.style.display="none"),W&&(W.style.display="none");var t=Es(e),n=vt!==t;if(vt=t,n&&(Y=null,De=null,Rt=!1,ht(),ft.getInstance().setQuestionStart(Date.now())),ie=!1,gt=!1,Oe(!1),ne){var s=typeof e.progressIndex=="number"?e.progressIndex:typeof e.currentQuestionIndex=="number"?e.currentQuestionIndex:0,i=typeof e.totalQuestions=="number"?e.totalQuestions:e.question&&e.question.options?e.question.options.length:1;console.log("[Secure] Question progress:",{progressIdx:s,totalCount:i,state:e}),ne.textContent="QUESTION "+(s+1)+" OF "+i}else console.warn("[Secure] questionProgressEl not found");ws(e),Ls(e.timeRemainingSeconds||0),Gt(e)}function ws(e){if(e){if(_.isLocked()){console.log("[Proctor] renderSecureQuestion BLOCKED - Lock active"),_.renderLockScreen(sessionStorage.getItem("lock_reason"));return}Rt=!!(e.question&&e.question.metacognitionEnabled);var t=typeof e.progressIndex=="number"?e.progressIndex:typeof e.currentQuestionIndex=="number"?e.currentQuestionIndex:0,n=typeof e.totalQuestions=="number"?e.totalQuestions:e.question&&e.question.options?e.question.options.length:0;if(gn&&(gn.textContent="Question "+(t+1)+" of "+n),Ut(t,n),X){var s=e.question.html||e.question.questionText||"";X.innerHTML=ut(s),X.className="ql-editor",X.style.padding="0"}_t&&(_t.classList.add("hidden"),_t.textContent=""),J&&(e.question.questionImageURL?(J.src=e.question.questionImageURL,J.style.display="block"):J.style.display="none");var i=!!e.question.questionImageURL;if(pn&&pn.classList.toggle("no-image",!i),bn&&(bn.style.display=i?"flex":"none"),O){O.innerHTML="";var o="ABCDEFGHIJKLMNOPQRSTUVWXYZ",r=Array.isArray(e.question.options)?e.question.options:[];r.forEach(function(l,a){O.appendChild(xs(l,a,o.charAt(a)||"#"))}),Cn()}Ht()}}function xs(e,t,n){var s=e.isCorrect===!0,i=E&&E.sessionStatus==="REVEAL"||E&&E.question&&E.question.resultsVisibility==="REVEALED",o=document.createElement("li"),r=document.createElement("button");r.type="button",r.className="answer-option secure-answer-option relative w-full text-left",i&&(r.disabled=!0,s?r.classList.add("ring-2","ring-green-500","bg-green-50","dark:bg-green-900/20"):r.classList.add("opacity-75")),r.dataset.optionIndex=t,r.setAttribute("aria-pressed","false");var l=e&&e.text?e.text.toString():"",a=e&&e.html?ut(e.html):Lt(l).replace(/\n/g,"<br>"),c="";return e&&e.imageURL&&(c+='<img src="'+Lt(e.imageURL)+'" alt="Answer '+n+'" class="option-image" referrerpolicy="no-referrer">'),c+='<div class="option-leading">',c+='<div class="letter-badge" aria-hidden="true">'+n+"</div>",c+='<div class="option-body">',c+='<div class="option-text-wrapper">',c+='<div class="option-text ql-editor" style="padding:0;">'+a+"</div>",i&&s&&(c+='<span class="material-symbols-outlined text-green-600 ml-2">check_circle</span>'),c+='<span class="result-ribbon"></span>',c+='<span class="sr-only secure-selection-announcement"></span>',c+="</div>",c+='<span class="percentage-bubble"></span>',c+="</div>",c+="</div>",c+='<span class="result-indicator" aria-hidden="true"></span>',r.innerHTML=c,r.addEventListener("click",function(u){u&&u.target&&u.target.closest(".option-image")||i||Ss(t)}),o.appendChild(r),o}function Ss(e){O&&(Y=e,Cn(),Ht())}function Ht(){if(H){var e=!!E,t=!e||ie||gt;if(H.disabled=t,H.classList.toggle("opacity-60",t),nt&&e&&!ie){var n=E.progressIndex>=E.totalQuestions-1;nt.textContent=n?"Submit Exam":"Submit & Next"}if(st)if(!e)st.textContent="";else if(typeof Y=="number"){var s="ABCDEFGHIJKLMNOPQRSTUVWXYZ",i=s.charAt(Y)||"#";st.textContent="Selected "+i+". Submit when ready."}else st.textContent="No answer selected ‚Äî submitting will record this as blank."}}function Kt(e){ie=e,H&&(H.disabled=e,H.classList.toggle("opacity-60",e),nt&&e&&(nt.textContent="Saving..."),e||Ht())}function Oe(e){O&&O.querySelectorAll("button.secure-answer-option").forEach(function(t){t.disabled=e,t.classList.toggle("answer-option-disabled",e)})}function Tn(e,t,n,s){if(!(!e||ie)){if(Rt&&!s){console.log("Metacognition enabled - showing confidence prompt"),As(t,n);return}Wt(e,t,n,null)}}function Wt(e,t,n,s,i){if(!(!e||ie)){Kt(!0),Oe(!0);var o={pollId:e.pollId,sessionId:e.sessionId,actualQuestionIndex:e.actualQuestionIndex,answer:t||"",answerId:n||null,confidenceLevel:s},r=ft.getInstance().getTelemetry();xn(o.pollId,o.actualQuestionIndex,o.answer,o.answerId,o.confidenceLevel,null,r).then(function(l){if(l&&l.success){console.log("Firebase write success, proceeding with optimistic UI update");try{localStorage.removeItem("secure_pending_answer")}catch{}Kt(!1),Oe(!1),ht(),Y=null,E=null,vt=null,X&&(X.innerHTML='<div style="display: flex; align-items: center; gap: 12px; padding: 20px 0;"><div style="width: 24px; height: 24px; border: 3px solid rgba(18, 56, 93, 0.2); border-top-color: #12385d; border-radius: 50%; animation: veritas-spin 0.7s linear infinite;"></div><span style="color: #4b5563; font-size: 1.1rem;">Answer Saved. Loading next...</span></div>'),J&&(J.style.display="none"),O&&(O.innerHTML=""),console.log("[Firebase] Submission finalized. Polling for next state."),setTimeout(function(){Nn()},50)}else{console.warn("[Firebase] Write failed. Saving to local backup for manual recovery.");try{localStorage.setItem("secure_pending_answer",JSON.stringify(o))}catch(a){console.error("Failed to backup answer",a)}Kt(!1),Oe(!1),ht(),mn("Submission failed. Your answer is backed up locally. Please check your connection and try again.")}})}}function kn(){Ft.stop()}function bt(){if(!(!Ne||!$)&&(Ne.textContent=ge?"‚Ä¢‚Ä¢:‚Ä¢‚Ä¢":it,$.classList.toggle("timer-hidden",ge),we)){we.setAttribute("aria-pressed",ge?"true":"false"),we.setAttribute("aria-label",ge?"Show timer":"Hide timer");var e=we.querySelector(".material-symbols-outlined");e&&(e.textContent=ge?"visibility_off":"visibility")}}function Is(e){if(!(!Ne||!$)){var t=Math.max(0,e);it=Ln(t),$.classList.remove("alert-warning","alert-danger");var n=ot>0?Math.max(0,Math.min(1,t/ot)):1;n<=.1?$.classList.add("alert-danger"):n<=.25&&$.classList.add("alert-warning"),bt()}}function Ls(e){var t=Math.max(0,Math.floor(e||0));ot=t||ot,it=Ln(t),bt(),Ft.start(t)}function Cs(){gt||(gt=!0,Yt("TIME_UP","Time's up!","Hold tight while we finalize your work."),ks(),Pn(4e3))}function As(e,t){if(Z){De=e,Z.dataset.pendingAnswerId=t||"",X&&(X.style.display="none"),J&&(J.style.display="none"),O&&(O.style.display="none"),H&&(H.style.display="none"),Z.style.display="block",Z.classList.remove("hidden");var n=Z.querySelectorAll(".confidence-btn");n.forEach(function(s){s.onclick=function(){var i=s.getAttribute("data-confidence");Ts(i)}})}}function ht(){Z&&(Z.style.display="none",Z.classList.add("hidden"),X&&(X.style.display="block"),O&&(O.style.display="block"),H&&(H.style.display="block"))}function Ts(e){if(!(De==null||!E)){ht();var t=Z.dataset.pendingAnswerId||null;Wt(E,De,t,e),De=null,Z.dataset.pendingAnswerId=""}}function ks(e){if(!(!E||ie)){var t="",n=null;if(typeof Y=="number"){var s=(E.question.options||[])[Y];s&&(t=s.text||"",n=s.id)}Tn(E,t,n,!0)}}function _n(){try{document&&document.fullscreenElement&&document.exitFullscreen&&document.exitFullscreen().catch(function(e){console.warn("Error exiting fullscreen:",e)})}catch(e){console.warn("Unable to exit fullscreen",e)}typeof window<"u"&&typeof window.close=="function"&&window.close()}function _s(){xe&&(clearTimeout(xe),xe=null)}function Pn(e){if(!xe){var t=Math.max(500,Number(e)||2500);xe=setTimeout(function(){xe=null,_n()},t)}}function Ps(){_s(),_n()}function zt(e,t,n){kn(),pt(!1),N&&(Dt.stop(),N=!1),Vt(!1),E=null,vt=null,Y=null,ie=!1,typeof Ze=="function"&&Ze(),Yt(e,t,n),Pn(2500)}function Yt(e,t,n){var s="lock",i="text-red-300",o="text-white text-2xl font-semibold",r="text-white/80 text-base mt-4",l=e==="COMPLETED"||e==="ENDED",a=e==="ENDED"?"Exit Session":"Exit Secure Session",c="Use the button below to leave fullscreen and close the secure window when dismissed.";e==="COMPLETED"?(s="task_alt",i="text-green-300",o="text-green-200 text-2xl font-semibold"):e==="TIME_UP"?(s="hourglass_bottom",l=!1):e==="ENDED"?s="info":e==="LOCKED"&&(s="lock",i="text-red-600",o="text-gray-900 text-2xl font-bold",r="text-gray-800 text-base mt-4 whitespace-pre-line",l=!1),Ct({icon:s,iconClass:i,message:t||"",messageClass:o,subtext:n||"",subClass:r,showExitAction:l,exitActionLabel:a,exitActionDescription:c,showResume:!1,lockScroll:!0})}function Ns(){document&&document.body&&document.body.classList.remove("secure-overlay-active"),g&&!x&&(g.style.display="none"),b&&(b.style.display="none",b.textContent="")}function Bs(e,t){kn(),pt(!0),D&&(D.style.display="block"),Oe(!0),Yt("LOCKED",e||"Assessment Paused",t),typeof Ze=="function"&&Ze()}function Gt(e){if(!(!e||!Be)){var t=(e.connectionHealth||"").toUpperCase(),n=["bg-emerald-400","bg-amber-400","bg-red-500"];n.forEach(function(l){Be.classList.remove(l)});var s="Synced",i="";t==="RED"?(Be.classList.add("bg-red-500"),s="Connection issue",i="We are reconnecting and saving your work..."):t==="YELLOW"?(Be.classList.add("bg-amber-400"),s="Reconnecting",i="Syncing your progress..."):(Be.classList.add("bg-emerald-400"),s="Synced");var o=e.heartbeatLagMs?Math.max(0,Math.round(e.heartbeatLagMs/1e3)):0;if(hn){var r=s;o>0&&(r+=" ‚Ä¢ "+o+" second lag"),hn.textContent=r}Me&&(i?(Me.textContent=i,Me.classList.remove("hidden")):(Me.textContent="",Me.classList.add("hidden")))}}function Nn(){if(qt()){console.log("[Proctor] POISON PILL ACTIVE in pollForIndividualSessionState - blocking"),x=!0,V();return}if(!yt){yt=!0,ft.getInstance().getTelemetry();var e=window.STUDENT_EMAIL||sessionStorage.getItem("veritas_student_email"),t=e?e.replace(/[.$#[\]]/g,"_"):"unknown",n=activePollId;Promise.all([firebase.database().ref("sessions/"+n+"/live_session").once("value"),firebase.database().ref("sessions/"+n+"/students/"+t).once("value")]).then(function(s){yt=!1,ae&&(ae.style.display="none");var i=sessionSnap.val()||{status:"CLOSED"},o=studentSnap.val(),r="ACTIVE",l="",a=!1;o&&(typeof o=="object"?(r=o.status||"ACTIVE",l=o.lastViolationReason||"",a=r==="LOCKED"):(r=o,a=r==="LOCKED"));var c={status:r,sessionStatus:i.status,locked:a,message:l,lockReason:l,completed:r==="FINISHED",completed:r==="FINISHED",question:i};if(c.sessionStatus==="PRE_LIVE"||!c.sessionStatus){jn({status:"LOBBY",pollName:"Wait for teacher..."});return}if(c.status==="LOBBY"){jn(c);return}cn();var u=(c.lockReason||"").toString().toUpperCase(),f=(c.message||"").toString().toLowerCase(),m=c.locked===!0||u==="FORCED_SUBMIT"||u==="TIME_EXPIRED"||f.indexOf("ended")>=0||f.indexOf("submitted")>=0;c.completed||o.status==="FINISHED"?(Gt(c),zt("COMPLETED","Assessment Submitted","Your responses have been secured.")):i.status==="ENDED"?(Gt(c),zt("ENDED","Session Concluded","The session has ended.")):m?zt("ENDED",c.message||"Assessment Finalized","Your responses have been secured."):c.status==="LOCKED"?(D&&(D.style.display="block"),Bs(c.message||"Locked","Teacher intervention required.")):(c.status==="ACTIVE"||!c.status)&&(c.question=i,c.timeLimitMinutes=i.metadata?i.metadata.timeLimitMinutes:60,An(c))}).catch(function(s){yt=!1,mn(s)})}}H&&H.addEventListener("click",function(){if(!(!E||ie)){var e="";if(typeof Y=="number"){var t=(E.question.options||[])[Y];t&&typeof t.text=="string"&&(e=t.text)}Tn(E,e)}}),J&&J.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault(),window.expandImage&&window.expandImage(this)}),console.log("Student poll script initializing...");try{var Bn=localStorage.getItem("secure_pending_answer");if(Bn){var Re=JSON.parse(Bn);setTimeout(function(){if(confirm("Veritas found an unsaved answer from a previous session. Would you like to retry submitting it?")){var e={pollId:Re.pollId,sessionId:Re.sessionId,actualQuestionIndex:Re.actualQuestionIndex,question:{}};Wt(e,Re.answer,Re.confidenceLevel)}else localStorage.removeItem("secure_pending_answer")},1e3)}}catch(e){console.error("Failed to check backup",e)}var ae=document.getElementById("student-loader"),Se=document.getElementById("pre-live-card"),g=document.getElementById("status-container"),C=document.getElementById("status-message"),y=document.getElementById("question-container"),T=document.getElementById("options-list"),be=document.getElementById("question-text"),ee=document.getElementById("question-image"),ce=document.getElementById("question-subline"),q=document.getElementById("no-responses-message"),k=document.getElementById("entry-screen"),Mn=document.getElementById("start-session-btn"),P=document.getElementById("student-container");Mn&&(console.log("Attaching onclick handler to start session button (Early Bind)"),Mn.onclick=function(){console.log("!!! BEGIN SESSION BUTTON CLICKED !!!"),qn=!0,k&&(k.style.display="none"),P&&(P.style.display="block"),x=!1,Le=!1,G=!1,Ve=!1;var e=document.getElementById("resume-controls");e&&(e.style.display="none");try{document.documentElement.requestFullscreen&&document.documentElement.requestFullscreen().catch(function(t){console.warn("Fullscreen denied or failed (benign):",t)})}catch(t){console.warn("Fullscreen execution error:",t)}ze(),re(!0)}),window.expandImage=function(e){var t=e.src,n='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:pointer;" onclick="this.remove()">';n+='<img src="'+t+'" style="max-width:90%;max-height:90%;"/>',n+="</div>",document.body.insertAdjacentHTML("beforeend",n)},ee&&ee.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault(),window.expandImage(this)}),document.addEventListener("click",function(e){e.target.classList.contains("option-image")&&(e.stopPropagation(),e.preventDefault(),window.expandImage(e.target))}),document.getElementById("pre-live-primary"),document.getElementById("pre-live-subline"),document.getElementById("pre-live-reconnect-line");var Fn=document.getElementById("resume-session-btn"),jt=document.getElementById("secure-exit-controls"),$t=document.getElementById("secure-exit-description"),Dn=document.getElementById("secure-exit-btn"),On=document.getElementById("secure-exit-label"),b=document.getElementById("status-submessage"),Rn=document.getElementById("connectivity-banner");document.getElementById("connectivity-icon"),document.getElementById("connectivity-message");var Xt=document.getElementById("connectivity-submessage"),A={},qe=null,Ie=1500,Jt=8e3,Et=0,x=!1,Le=!1,ue=0,de=!1,G=!1,Zt=null,Ve=!1,Ue=null,en=null,tn=!1,Ce=!1,Qe=!1,Ms=null,wt=Ie,N=!1,He=!1,qn=!1,Ke="answer-option relative w-full text-left",Fs=Ke+" answer-option-selected",Ds=Ke+" answer-option-disabled",Os=["Stay in fullscreen for the entire assessment","No tab or app switching is allowed","Mission Control monitors your progress in real time"],W=document.getElementById("secure-lobby"),Vn=document.getElementById("secure-lobby-title"),he=document.getElementById("secure-lobby-summary"),Un=document.getElementById("secure-lobby-time"),Qn=document.getElementById("secure-lobby-questions"),Hn=document.getElementById("secure-window-message"),nn=document.getElementById("secure-access-code-group"),te=document.getElementById("secure-access-code"),We=document.getElementById("secure-access-code-error"),B=document.getElementById("secure-begin-btn"),Ae=document.getElementById("secure-begin-label"),sn=document.getElementById("secure-rules-list"),S=null,Kn=!1,Wn=!1,xt=!1;function Rs(e){try{sessionStorage.setItem("veritas_lock_active","true"),sessionStorage.setItem("lock_reason",e||"violation")}catch{}_.lock(e||"proctoring_violation"),typeof St=="function"&&St(e)}function zn(e){Rs(e)}function Yn(e){document.activeElement&&document.activeElement.id==="calc-iframe"||(sessionStorage.setItem("veritas_lock_active","true"),typeof on=="function"?on(e):typeof St=="function"&&St(e),V(e))}function on(e){var t=window.currentPollId||window.pollData&&window.pollData.pollId||sessionStorage.getItem("veritas_active_poll_id");if(!t){console.error("[Proctor] CRITICAL: Attempted to report violation but Poll ID is missing. Retrying in 1s..."),setTimeout(function(){on(e)},1e3);return}console.warn("[Proctor] Reporting violation:",e,"for Poll:",t);try{typeof pe=="function"&&pe(e,t)}catch(i){console.warn("[Proctor] Firebase reporting failed:",i)}var n=window.STUDENT_EMAIL||"";if(!n)try{n=sessionStorage.getItem("veritas_student_email")||""}catch{}var s=rt.httpsCallable("reportStudentViolation");s({pollId:t,studentEmail:n,reason:e}).then(function(i){console.log("[Proctor] Violation logged:",i.data),i.data&&i.data.lockVersion!==void 0&&(ue=i.data.lockVersion)}).catch(function(i){console.error("[Proctor] Violation report failed:",i)})}function St(e){!x&&!G&&N&&(console.log("[Proctor] Violation detected:",e,"- blocking interaction immediately"),x=!0,V(),pe(e)),Zt&&clearTimeout(Zt),Zt=setTimeout(function(){if(!G){var t=A&&A.pollId||S&&S.pollId||window.currentPollId;if(!t)try{t=sessionStorage.getItem("veritas_active_poll_id")}catch{}if(!t){console.error("[Proctor] CRITICAL: Cannot report violation - no poll ID found in any source"),V();return}G=!0,x=!0,console.log("[Proctor] Reporting violation to server:",e,"pollId:",t),pe(e,t);var n=window.STUDENT_EMAIL||"";if(!n)try{n=sessionStorage.getItem("veritas_student_email")||""}catch{}V();var s=rt.httpsCallable("reportStudentViolation");s({pollId:t,studentEmail:n,reason:e}).then(function(i){var o=i.data||i;console.log("[Proctor] Violation reported:",o),o.success&&(ue=o.lockVersion,V(),fn())}).catch(function(i){console.error("[Proctor] Violation report failed:",i),V()})}},100)}function qs(){Wn||(Wn=!0,window.addEventListener("blur",function(){if(!(!N||He||x||Le)&&!(A&&(A.status==="LOBBY"||A.status==="PRE_LIVE"||A.sessionPhase==="LOBBY"))){if(W&&W.style.display!=="none"){console.log("[Proctor] Blur ignored - Lobby is visible");return}G=!0,Yn("tab_switch")}}),document.addEventListener("visibilitychange",function(){if(document.hidden){if(!N||He||x||Le||A&&(A.status==="LOBBY"||A.status==="PRE_LIVE"||A.sessionPhase==="LOBBY"))return;if(W&&W.style.display!=="none"){console.log("[Proctor] visibilitychange ignored - Lobby is visible");return}G=!0,Yn("tab_hidden")}}))}var rn=null,Vs=new Promise(function(e){function t(){rn=window.VeritasModal||Js(),window.VeritasModal=rn,e(rn)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t,{once:!0}):t()});function Us(e){return Vs.then(function(t){return e(t)})}function ln(e,t){return Us(function(n){return n.alert(Object.assign({message:e},t||{}))})}function Qs(e){if(!e||e<=0)return"Untimed";if(e>=60){var t=Math.floor(e/60),n=e%60;return n===0?t+(t===1?" hour":" hours"):t+" hr "+n+" min"}return e+" min"}function Hs(e){return typeof e!="number"||e<=0?"‚Äî":e+(e===1?" Question":" Questions")}function Ks(e){if(sn){sn.innerHTML="";var t=Array.isArray(e)&&e.length?e:Os;t.forEach(function(n){var s=document.createElement("li"),i=document.createElement("span");i.className="material-symbols-outlined text-base text-veritas-navy mt-0.5",i.textContent="shield_person";var o=document.createElement("span");o.textContent=n,s.appendChild(i),s.appendChild(o),sn.appendChild(s)})}}function Te(e){We&&(e?(We.textContent=e,We.classList.remove("hidden")):(We.textContent="",We.classList.add("hidden")))}function Ws(e){return e==="NOT_YET_OPEN"?"Opens Soon":e==="PAST_DUE"?"Window Closed":"Begin Assessment"}function an(e){return e==="NOT_YET_OPEN"||e==="PAST_DUE"}function Gn(){if(B){var e=S?S.windowStatus:"OPEN",t=Ws(e),n=an(e),s=B.dataset.loading==="1";S&&(S.beginLabel=t),B.disabled=n||s,B.classList.toggle("opacity-60",n||s),Ae&&!s&&(Ae.textContent=t)}}function It(e){B&&(B.dataset.loading=e?"1":"0",e?(B.disabled=!0,B.classList.add("opacity-60"),Ae&&(Ae.textContent="Preparing...")):(B.classList.remove("opacity-60"),Gn()))}function cn(){W&&(W.style.display="none"),S=null,Te("")}function zs(e,t){if(!e||!t)return!1;var n=an(e),s=an(t);return n&&!s}function Ys(){Kn||(Kn=!0,B&&(B.disabled=!0,B.classList.add("opacity-60")),Ae&&(Ae.textContent="Refreshing..."),setTimeout(function(){window.location.reload()},750))}function jn(e){var t=S,n=t&&t.lobbyKey?t.lobbyKey:t?t.pollId+"|"+t.sessionId:null,s=(e.pollId||"poll")+"|"+(e.sessionId||""),i=n!==s,o=t?t.windowStatus:null;if(pt(!1),Vt(!0),S={pollId:e.pollId,sessionId:e.sessionId,requiresAccessCode:!!e.requiresAccessCode,windowStatus:e.availability&&e.availability.windowStatus||e.windowStatus||"OPEN",lobbyKey:s},e.pollId){window.currentPollId=e.pollId;try{sessionStorage.setItem("veritas_active_poll_id",e.pollId)}catch{}}if(zs(o,S.windowStatus)){Ys();return}k&&(k.style.display="none"),P&&(P.style.display="block"),ae&&(ae.style.display="none"),Se&&(Se.style.display="none"),g&&(g.style.display="none"),y&&(y.style.display="none"),D&&(D.style.display="none"),N=!1,Qt(!1),ne&&(ne.textContent="STANDBY"),W&&(W.style.display="block"),Vn&&(Vn.textContent=e.pollName||"Secure Assessment"),he&&(e.className?(he.textContent="Class: "+e.className,he.style.display="block",he.classList.remove("hidden")):(he.textContent="",he.style.display="none",he.classList.add("hidden"))),Un&&(Un.textContent=Qs(e.timeLimitMinutes)),Qn&&(Qn.textContent=Hs(e.questionCount));var r=e.availability||{},l=r.message||"Available now";r.blockingMessage&&(l+=" ‚Ä¢ "+r.blockingMessage),Hn&&(Hn.textContent=l),nn&&(nn.style.display=S.requiresAccessCode?"block":"none",nn.classList.toggle("hidden",!S.requiresAccessCode)),te&&i&&(te.value=""),i&&Te(""),Ks(e.proctoringRules),Gn()}function Gs(){return!Fe||Fe.isFullscreen()?Promise.resolve():Fe.request().catch(function(){return Promise.resolve()})}function js(e){if(console.log("[Proctor] Fullscreen change event:",{isFullscreen:e.isFullscreen,hidden:e.hidden,secureSessionActive:N,liveSessionActive:xt,fullscreenEnteredOnce:Ve,isInteractionBlocked:x,violationLogged:G}),e.hidden&&!x&&!G){console.log("[Proctor] ZERO TOLERANCE: Tab blur detected - IMMEDIATE LOCK"),zn("tab-blur");return}if(e.isFullscreen){console.log("[Proctor] Fullscreen entered"),Ve=!0;return}(Ve||N||xt)&&!x&&!G&&(console.log("[Proctor] ZERO TOLERANCE: Fullscreen exit detected - IMMEDIATE LOCK"),zn("exit-fullscreen"))}function $s(){if(!(!S||!B||B.disabled)){Te("");var e=te?te.value.trim():"";if(S.requiresAccessCode&&!e){Te("Access code is required."),te&&te.focus();return}Gs().then(function(){if(It(!0),He=!0,setTimeout(function(){He=!1},3e3),!Fe.isFullscreen())throw new Error("Fullscreen failed");N=!0;var t=S.pollId,n=window.STUDENT_EMAIL||sessionStorage.getItem("veritas_student_email");if(!n){It(!1),ln("Student identity not found. Please refresh.",{title:"Error"});return}firebase.database().ref("polls/"+t).once("value").then(function(s){var i=s.val();if(!i)throw new Error("Poll not found");var o=i.accessCode?i.accessCode:"";if(o&&o!==e)throw new Error("Invalid access code.");var r=n.replace(/[.$#[\]]/g,"_");return firebase.database().ref("sessions/"+t+"/students/"+r).update({status:"ACTIVE",startedAt:firebase.database.ServerValue.TIMESTAMP,email:n,name:window.STUDENT_NAME||n.split("@")[0]})}).then(function(){It(!1),Jn(),k.style.display="none",S=null,re(!0)}).catch(function(s){It(!1),He=!1,N=!1;var i=s.message||"Unable to begin assessment.";/access code/i.test(i)?(Te(i),te&&te.focus()):ln(i,{title:"Secure Assessment"})})}).catch(function(t){console.warn("Fullscreen request was rejected",t),ln("Fullscreen permission is required to begin the assessment.",{title:"Secure Assessment"})})}}function Xs(){var e=document.getElementById("veritas-modal-root");if(e)return e;var t=document.createElement("div");return t.id="veritas-modal-root",t.className="veritas-modal-root",t.setAttribute("aria-hidden","true"),t.innerHTML='<div class="veritas-modal-backdrop"></div><div class="veritas-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="veritas-modal-title" aria-describedby="veritas-modal-message"><div class="veritas-modal-header"><h2 id="veritas-modal-title">Notice</h2></div><div class="veritas-modal-body"><p id="veritas-modal-message"></p><div id="veritas-modal-subtext" class="veritas-modal-subtext"></div><div id="veritas-modal-input" class="veritas-modal-input" style="display: none;"><label for="veritas-modal-input-field" class="sr-only">Input</label><input id="veritas-modal-input-field" type="text" autocomplete="off" /></div><div class="veritas-modal-actions"><button type="button" class="veritas-modal-button secondary" data-action="cancel">Cancel</button><button type="button" class="veritas-modal-button primary" data-action="confirm"><span class="veritas-modal-spinner" aria-hidden="true"></span><span>Confirm</span></button></div></div>',(document.body||document.documentElement).appendChild(t),t}function Js(){var e=Xs(),t=e.querySelector(".veritas-modal-dialog"),n=e.querySelector("#veritas-modal-title"),s=e.querySelector("#veritas-modal-message"),i=e.querySelector("#veritas-modal-subtext"),o=e.querySelector("#veritas-modal-input"),r=e.querySelector("#veritas-modal-input-field"),l=e.querySelector('[data-action="confirm"]'),a=e.querySelector('[data-action="cancel"]'),c=l.querySelector("span:not(.veritas-modal-spinner)"),u=!1,f=null,m=null,p=null,I=!0,L=[];function Q(d){var v=[].slice.call(document.body.children);d?(L=[],v.forEach(function(h){h!==e&&(L.push({node:h,ariaHidden:h.getAttribute("aria-hidden"),inert:"inert"in h?h.inert:null}),h.setAttribute("aria-hidden","true"),"inert"in h&&(h.inert=!0))})):(L.forEach(function(h){h.ariaHidden===null?h.node.removeAttribute("aria-hidden"):h.node.setAttribute("aria-hidden",h.ariaHidden),"inert"in h.node&&(h.inert!==null?h.node.inert=h.inert:h.node.inert=!1)}),L=[])}function j(d){d?(l.classList.add("loading"),l.setAttribute("disabled","disabled"),a.style.display!=="none"&&a.setAttribute("disabled","disabled")):(l.classList.remove("loading"),l.removeAttribute("disabled"),a.removeAttribute("disabled"))}function me(){var d='button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',v=[].slice.call(t.querySelectorAll(d));return v.filter(function(h){return!h.hasAttribute("disabled")&&h.offsetParent!==null})}function le(){var d=me();d.length>0?d[0].focus():t.focus()}function Pe(d){if(u)if(d.key==="Escape"){if(!I)return;d.preventDefault(),M()}else if(d.key==="Tab"){var v=me();if(v.length===0){d.preventDefault();return}var h=v.indexOf(document.activeElement);d.shiftKey?h<=0&&(v[v.length-1].focus(),d.preventDefault()):h===v.length-1&&(v[0].focus(),d.preventDefault())}else d.key==="Enter"&&f&&f.mode==="prompt"&&document.activeElement===r&&(d.preventDefault(),F())}function Tt(d){u&&(t.contains(d.target)||(d.stopPropagation(),le()))}function w(d){u=!1,e.classList.remove("is-active"),e.setAttribute("aria-hidden","true"),document.body.classList.remove("veritas-modal-open"),e.removeEventListener("keydown",Pe,!0),document.removeEventListener("focus",Tt,!0),Q(!1),j(!1),p&&typeof p.focus=="function"&&setTimeout(function(){p.focus()},0),m&&m(d),f=null,m=null}function F(){if(u){j(!0);var d=f?f.mode:"alert",v;d==="prompt"?v=r.value:d==="confirm"&&(v=!0),w(v)}}function M(){if(u){var d=f?f.mode:"alert";if(d==="alert"){w(void 0);return}d==="confirm"?w(!1):d==="prompt"&&w(null)}}function ve(d,v){return v=v||{},f=Object.assign({},v,{mode:d}),I=v.allowEscape!==!1,n.textContent=v.title||(d==="confirm"?"Please Confirm":d==="prompt"?"Enter Response":"Notice"),v.html?s.innerHTML=v.html:s.textContent=v.message||"",v.subtext?(i.style.display="block",i.textContent=v.subtext):(i.style.display="none",i.textContent=""),d==="prompt"?(o.style.display="flex",r.value=v.defaultValue||"",v.placeholder?r.placeholder=v.placeholder:r.removeAttribute("placeholder")):(o.style.display="none",r.value="",r.removeAttribute("placeholder")),c.textContent=v.confirmText||(d==="confirm"?"Confirm":d==="prompt"?"Submit":"OK"),v.destructive?l.classList.add("destructive"):l.classList.remove("destructive"),a.style.display=d==="alert"?"none":"inline-flex",a.textContent=v.cancelText||"Cancel",j(!1),p=document.activeElement,e.classList.add("is-active"),e.setAttribute("aria-hidden","false"),document.body.classList.add("veritas-modal-open"),Q(!0),u=!0,e.addEventListener("keydown",Pe,!0),document.addEventListener("focus",Tt,!0),new Promise(function(h){m=h,setTimeout(function(){d==="prompt"?(r.focus(),r.select()):d==="confirm"&&v.focusCancel?a.focus():l.focus()},0)})}return l.addEventListener("click",F),a.addEventListener("click",M),e.addEventListener("click",function(d){if(d.target===e||d.target.classList.contains("veritas-modal-backdrop")){if(!f||f.allowBackdropClose===!1)return;M()}}),{alert:function(d){return ve("alert",d).then(function(){})},confirm:function(d){return ve("confirm",d).then(function(v){return v!==!1})},prompt:function(d){return ve("prompt",d).then(function(v){return v})}}}var Ee=[];function Zs(){return Se&&Se.style.display!=="none"}function ze(){Rn&&(clearTimeout(Ms),Rn.classList.add("hidden"),Xt&&(Xt.textContent="",Xt.classList.remove("opacity-0")))}function Ye(){qe&&(clearTimeout(qe),qe=null),Ce=!1}function un(e){if(!x){Ye();var t=Math.min(Jt,Math.max(1e3,e)),n=Math.random()*.15*t;qe=setTimeout(function(){qe=null,$n()},t+n)}}function re(e){if(sessionStorage.getItem("veritas_lock_active")==="true"){typeof V=="function"&&V();return}if(qt()){console.log("[Proctor] POISON PILL ACTIVE in startPolling - blocking resume"),x=!0,V(),fn();return}Et=0,Qe=!1,e?(Ye(),$n()):un(Ie)}function ei(e,t){typeof e.stateVersion=="number"&&e.stateVersion,typeof e.advisedPollIntervalMs=="number"?wt=e.advisedPollIntervalMs:wt=Ie,e.connectionHealth==="RECOVERED_AFTER_OUTAGE"||(e.connectionHealth==="RECOVERING"?(ze(),Zs()):Qe||ze()),fe(e);var n=Math.max(500,Math.min(Jt,wt));un(n)}function ti(e){var t=e&&e.message?e.message:typeof e=="string"?e:"";if(t&&/Authentication|not enrolled|Invalid link/i.test(t)){Ye(),mn(e);return}Qe=!0;var n=Math.pow(1.6,Math.max(1,Et)),s=Math.min(Jt,Math.round((wt||Ie)*n));un(s)}function Ge(e){if(P&&(P.style.display="block",P.classList.remove("hidden")),y&&(y.style.display="none"),g){g.style.display="block",g.classList.remove("hidden");var t=g.querySelector(".material-symbols-outlined");if(t){var n=`
                    <svg class="w-24 h-24 mx-auto mb-6 text-veritas-navy" viewBox="0 0 52 52" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle class="animate-draw-check" cx="26" cy="26" r="25" stroke="currentColor" stroke-width="2"/>
                        <path class="animate-draw-check" d="M14.1 27.2l7.1 7.2 16.7-16.8" stroke="currentColor" stroke-width="2" style="animation-delay: 0.2s"/>
                    </svg>
                    `;t.innerHTML=n,t.className="block mb-4",t.textContent="";var s=document.createElement("div");s.innerHTML=n,t.replaceWith(s)}}C&&(C.textContent=e||"Answer Saved",C.className="text-veritas-navy text-3xl font-bold tracking-tight animate-fade-in"),b&&(b.textContent="Response Recorded. Eyes on the board for results.",b.style.display="block",b.className="text-slate-500 font-medium mt-2 animate-fade-in");var i=document.getElementById("resume-controls");i&&(i.style.display="none")}function $n(){if(!(x||Ce)){if(!firebase||!firebase.apps||!firebase.apps.length){console.warn("[Polling] Firebase not initialized yet, skipping poll");return}Ce=!0,ft.getInstance().getTelemetry();var e=window.currentPollId||sessionStorage.getItem("veritas_active_poll_id");if(!e){console.warn("[Polling] No active poll ID found, skipping"),Ce=!1;return}firebase.database().ref("sessions/"+e+"/live_session").once("value").then(function(t){Ce=!1;var n=t.val();Et=0,Qe=!1,ei(n||{})}).catch(function(t){Ce=!1,Et+=1,console.error("Polling error",t),ti(t)})}}function dn(){var e=D&&D.style.display!=="none",t=y&&y.style.display!=="none";return(e||t)&&!_.isLocked()}window.addEventListener("offline",function(){dn()&&(Qe=!0)}),window.addEventListener("online",function(){if(dn()&&(re(!0),dn()&&!x)){var e=D&&D.style.display!=="none";e&&(N=!0)}}),Fn&&(Fn.onclick=function(){console.log("Resume button clicked - attempting fullscreen"),document.documentElement.requestFullscreen&&document.documentElement.requestFullscreen().then(function(){console.log("Fullscreen entered - confirming with server");var e=firebase.functions().httpsCallable("confirmFullscreen");e({pollId:CURRENT_POLL_ID||ACTIVE_SESSION&&ACTIVE_SESSION.pollId,studentEmail:STUDENT_INFO.id||STUDENT_INFO.email,lockVersion:ue}).then(function(t){t.data&&t.data.success?console.log("[Proctor] Server confirmed unlock via fullscreen confirmation - Firebase listener will handle state change."):(console.error("Failed to confirm fullscreen:",t.data?.reason),C.textContent="Failed to resume. Please try again.")}).catch(function(t){console.error("Error confirming fullscreen:",t),C.textContent="Error resuming session."})}).catch(function(e){console.warn("Fullscreen denied on resume:",e),C.textContent="Fullscreen is required. Please allow fullscreen and try again."})}),Dn&&Dn.addEventListener("click",function(){Ps()});var Xn=null;function ni(e,t){if(!Xn){var n=typeof generateStudentKey=="function"?generateStudentKey(t):t.replace(/[.$#[\]]/g,"_"),s=firebase.database().ref("sessions/"+e+"/students/"+n);Xn=s,console.log("[Proctor] Initializing Firebase listener for status updates"),s.on("value",function(i){var o=i.val();o&&(console.log("[Proctor] Status Update Received:",o.status,{version:o.lockVersion}),o.status==="AWAITING_FULLSCREEN"?(ue=o.lockVersion,gi()):o.status==="LOCKED"&&o.lockVersion!==ue?(ue=o.lockVersion,V()):o.status==="BLOCKED"?(Le=!0,ue=o.lockVersion||ue,vi()):o.status==="ACTIVE"&&(x||G)&&(console.log("[Proctor] Status changed to ACTIVE - clearing local lock"),In(),x=!1,Le=!1,G=!1,Ve=!1,ze(),N=!0,re(!0)))})}}function fn(){var e=A&&A.pollId||S&&S.pollId||E&&E.pollId,t=window.STUDENT_EMAIL||STUDENT_DATA&&STUDENT_DATA.email;e&&t&&ni(e,t)}function Jn(){["entry-screen","secure-lobby","status-container","pre-live-card","student-container","question-container","individual-timed-session"].forEach(function(e){var t=document.getElementById(e);t&&(t.style.display="none",t.classList.add("hidden"))}),x||(document.body.style.overflow="")}function fe(e){e=e||{},e.pollId&&(window.currentPollId=e.pollId,sessionStorage.setItem("veritas_active_poll_id",e.pollId)),e.pollId&&e.status&&us(e),console.log("[ViewManager] Update View State:",e);var t=typeof e.questionIndex=="number"?e.questionIndex:null,n=e.resultsVisibility||(e.status==="RESULTS_REVEALED"?"REVEALED":null),s=!1;try{s=sessionStorage.getItem("veritas_lock_active")==="true"}catch{s=!1}if(s)if(e&&e.unlock_granted===!0)In(),s=!1,typeof At=="function"&&At();else{typeof V=="function"&&V(),x=!0,fn();return}if(_.isLocked())if(e.unlockApproved===!0)console.log("[LockManager] Server approved unlock - Clearing Poison Pill"),_.unlock();else{console.warn("[LockManager] Local Lock Active - Blocking View Update");var i=sessionStorage.getItem("lock_reason");_.renderLockScreen(i);return}else if(e.isLocked||e.status==="LOCKED"){_.lock(e.lockReason||"Server Command");return}var o=document.getElementById("paused-overlay");if(e.status==="PAUSED"?(console.log("[ViewManager] Session PAUSED - showing Eyes on Teacher overlay"),o&&(o.classList.remove("hidden"),o.style.display="flex"),x=!0):o&&o.style.display!=="none"&&(console.log("[ViewManager] Session resumed - hiding PAUSED overlay"),o.classList.add("hidden"),o.style.display="none",x=!1),e.hasSubmitted===!0&&t!==null&&(Sn=t),t!==null&&Sn===t&&e.status==="LIVE"&&n!=="REVEALED"){y&&(y.style.display="none"),Ge("Answer Saved. Waiting for next question...");return}if(Jn(),["entry-screen","secure-lobby","student-container"].forEach(function(p){var I=document.getElementById(p);I&&(I.style.display="none",I.classList.add("hidden"))}),!K&&e.pollId&&e.studentEmail&&wn(e.pollId,e.studentEmail),e.resultsVisibility==="REVEALED"||e.status==="RESULTS_REVEALED"){var r=e.status||"RESULTS_REVEALED";e.status=r,fi(e);return}if(e.status==="RESULTS_HOLD"){Ge("Results Pending Analysis");return}var l=e.calculatorEnabled===!0;if(window.syncCalculatorVisibility&&window.syncCalculatorVisibility(l),e.status==="CLOSED"||e.sessionPhase==="ENDED"){window.hideCalculatorOnSessionEnd&&window.hideCalculatorOnSessionEnd(),oe.show("status-container"),mi("Session Concluded","The live session has ended. Thanks for participating!");return}if(!e.sessionType&&!e.pollId){k&&(k.style.display="block",k.classList.remove("hidden")),oe.show("entry-screen");return}var a=lt!==t&&t!==null;if(a){lt=t;var c=document.getElementById("student-container");c&&(c.classList.remove("motion-slide-in-right"),c.offsetWidth,c.classList.add("motion-slide-in-right"))}P&&(P.style.display="block",P.classList.remove("hidden"));var u=e.sessionType==="SECURE_ASSESSMENT"||e.sessionType==="SECURE";if(u)if(e.status==="LOBBY"||e.sessionPhase==="LOBBY"){var f=document.getElementById("secure-lobby");f&&(f.style.display="block",f.classList.remove("hidden")),oe.show("secure-lobby"),renderSecureLobby(e)}else oe.show("individual-timed-session"),An(e);else{if(!qn){console.log("[ViewManager] Blocking Live Poll render - student has not clicked Begin Poll"),k&&(k.style.display="block",k.classList.remove("hidden")),oe.show("entry-screen");return}if(e.sessionPhase==="LOBBY")oe.show("pre-live-card"),updatePreLiveCard(e);else if(oe.show("question-container"),e.status==="PRE_LIVE")xt=!1,de=!1,Ue=null,Qt(!1),ne&&(ne.textContent="QUESTION 1 OF ?"),oe.show("pre-live-card");else{if(mt===t&&Ot!==t){Zn(e.pollId,t);return}if(e.hasSubmitted===!0&&t!==null){Ge("Answer Saved. Waiting for next question...");return}si(e)}}var m=document.getElementById("resume-controls");m&&(m.style.display="none")}function si(e){if(_.isLocked()){console.log("[Proctor] renderQuestion BLOCKED - Lock active"),_.renderLockScreen(sessionStorage.getItem("lock_reason"));return}if(!y||!T||!be){console.error("[renderQuestion] Critical DOM elements missing");var t=document.getElementById("render-error-overlay");t||(t=document.createElement("div"),t.id="render-error-overlay",t.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;color:white;font-family:sans-serif;",t.innerHTML='<h2 style="font-size:24px;margin-bottom:16px;">Unable to Load Question</h2><p style="max-width:400px;text-align:center;">Critical UI elements are missing. Please refresh the page or contact your teacher.</p>',document.body.appendChild(t));return}A=e,console.log("[renderQuestion] Rendering Live Poll question:",e);var n=e.metadata&&e.metadata.resetAt?e.metadata.resetAt:"",s=e.pollId+":"+e.questionIndex+":"+n,i=Ue!==s;if(i&&(console.log("[renderQuestion] Question changed from",Ue,"to",s),Ue=s,de=!!e.hasSubmitted,Ee=[],xt=!0,mt=null,Ot=null,Bt.init(e.pollId,e.sessionId||"",e.questionIndex)),tn=!!e.metacognitionEnabled,Ut(e.questionIndex,e.totalQuestions),y.style.display="block",g&&(g.style.display="none"),be){var o=e.questionText||e.text||e.stem||"";!o&&e.options&&e.options.length>0?(o='<span class="animate-pulse text-gray-500 italic">Loading question...</span>',console.error("[renderQuestion] Missing question text. Full data:",JSON.stringify(e,null,2)),console.warn("[renderQuestion] Question text is missing, showing loader"),typeof re=="function"&&re(!0)):o||(console.error("[renderQuestion] No question text and no options. Full data:",JSON.stringify(e,null,2)),o="[Question Text Missing]"),be.innerHTML=ut(o),Nt(),be.style.display="block",be.classList.remove("hidden")}var r=!!e.questionImageURL;if(ee&&(r?(ee.src=e.questionImageURL,ee.style.display="block"):ee.style.display="none"),et&&et.classList.toggle("no-image",!r),tt&&(tt.style.display=r?"flex":"none"),ce&&(ce.classList.add("hidden"),ce.textContent=""),q&&(q.classList.add("hidden"),q.textContent=""),ci(),i||T.children.length===0){var l=e.options||[],a=["A","B","C","D","E","F","G","H"];i&&e.shuffleOptions&&(l=ri(l.slice())),T.innerHTML="",Ee=[],l.forEach(function(c,u){var f={text:typeof c=="string"?c:c.text||"",imageURL:typeof c=="object"&&(c.imageURL||c.imageUrl)||"",id:typeof c=="object"&&c.id||null},m=a[u]||(u+1).toString(),p=ts(f,m,e.pollId,e.questionIndex,u);de&&(p.disabled=!0,p.classList.add("answer-option-disabled"));var I=document.createElement("li");I.appendChild(p),T.appendChild(I),Ee.push({text:f.text,imageURL:f.imageURL})}),ai(e.pollId,e.questionIndex)}else if(de){Ge("Answer Saved. Waiting for next question...");return}Nt()}function ii(e,t,n,s){if(console.log("=== SUBMIT ANSWER CALLED ==="),console.log("currentMetacognitionEnabled:",tn),console.log("answerText:",n),!x&&!de){for(var i=T.querySelectorAll("button"),o=0;o<i.length;o++)i[o].disabled=!0,i[o].dataset.answerText===n?i[o].className=Fs:i[o].className=Ds;tn?(console.log("Metacognition is enabled - showing confidence question"),en=n,g&&(g.dataset.pendingAnswerId=s||""),y.style.display="none",Zn(e,t)):(console.log("Metacognition is NOT enabled - submitting answer directly"),de=!0,g.style.display="block",y.style.display="none",C&&(C.textContent="Submitting answer...",C.className="text-veritas-navy text-2xl font-bold"),b&&(b.textContent="Please wait while we confirm your submission.",b.style.display="block",b.className="text-slate-500 text-sm mt-2 animate-pulse"),es(e,t,n,s,null))}}function Zn(e,t){if(g.style.display="block",y.style.display="none",mt=t,C.textContent="How confident are you in your answer?",C.className="text-gray-800 text-xl font-semibold mb-4",b){b.innerHTML='<div class="confidence-selector mt-6 flex flex-col gap-3"><button class="confidence-btn h-14 px-6 rounded-xl bg-red-500/20 hover:bg-red-500/30 text-gray-900 border-2 border-red-500/40 hover:border-red-500/60 transition-all font-semibold text-lg" data-confidence="guessing"><span class="mr-2">ü§î</span> Guessing</button><button class="confidence-btn h-14 px-6 rounded-xl bg-yellow-500/20 hover:bg-yellow-500/30 text-gray-900 border-2 border-yellow-500/40 hover:border-yellow-500/60 transition-all font-semibold text-lg" data-confidence="somewhat-sure"><span class="mr-2">ü§∑</span> Somewhat Sure</button><button class="confidence-btn h-14 px-6 rounded-xl bg-blue-500/20 hover:bg-blue-500/30 text-gray-900 border-2 border-blue-500/40 hover:border-blue-500/60 transition-all font-semibold text-lg" data-confidence="very-sure"><span class="mr-2">üëç</span> Very Sure</button><button class="confidence-btn h-14 px-6 rounded-xl bg-green-500/20 hover:bg-green-500/30 text-gray-900 border-2 border-green-500/40 hover:border-green-500/60 transition-all font-semibold text-lg" data-confidence="certain"><span class="mr-2">üíØ</span> Absolutely Certain</button></div>',b.style.display="block",b.className="text-gray-700 text-base mt-4";for(var n=b.querySelectorAll(".confidence-btn"),s=0;s<n.length;s++)n[s].addEventListener("click",function(i){i.preventDefault();var o=this.dataset.confidence,r=g?g.dataset.pendingAnswerId:null;oi(e,t,en,r,o)})}}B&&B.addEventListener("click",$s),te&&te.addEventListener("input",function(){Te("")});function oi(e,t,n,s,i){Bt.recordAnswerSubmitted(n,i),de=!0,Ot=t,mt=null,C.textContent="Transmitting your response...",C.className="text-gray-900 text-2xl font-semibold",b&&(b.innerHTML="",b.style.display="none"),es(e,t,n,s,i)}function es(e,t,n,s,i){en=null,Ge("Answer Saved. Waiting for next question..."),console.log("[Optimistic UI] Showing success state immediately"),xn(e,t,n,s,i).then(function(o){o&&o.success?console.log("[Firebase] Dual-write confirmed successful"):console.warn("[Firebase] Dual-write may have failed, but UI already transitioned")}).catch(function(o){console.error("[Firebase] Dual-write error:",o)})}function ri(e){for(var t=e.slice(),n=t.length-1;n>0;n--){var s=Math.floor(Math.random()*(n+1)),i=t[n];t[n]=t[s],t[s]=i}return t}function ts(e,t,n,s,i){var o=document.createElement("button");o.type="button",o.className=Ke,o.dataset.answerText=e.text||"",o.dataset.optionIndex=i;var r=(e.text||"").trim(),l="";e.imageURL&&(l+='<img src="'+Lt(e.imageURL)+'" alt="Answer '+t+'" class="option-image" referrerpolicy="no-referrer">'),l+='<div class="option-leading">',l+='<div class="letter-badge" aria-hidden="true">'+t+"</div>",l+='<div class="option-body">',l+='<div class="option-text-wrapper">',r&&(l+='<div class="option-text">',l+=ut(r),l+="</div>"),l+='<span class="sr-only result-announcement"></span>',l+="</div>",l+="</div>",l+="</div>",l+='<div class="result-metadata">',l+='<div class="percentage-flag" style="display:none"></div>',l+='<div class="result-icon-marker"></div>',l+="</div>",l+='<div class="result-badges"></div>',l+='<button type="button" class="cross-out-toggle" aria-label="Cross out this answer" title="Click to eliminate this option">',l+='<span class="material-symbols-outlined">visibility_off</span>',l+="</button>",o.innerHTML=l;var a=o.querySelector(".cross-out-toggle");return a&&a.addEventListener("click",function(c){c.stopPropagation(),c.preventDefault();var u=o.classList.toggle("crossed-out"),f=a.querySelector(".material-symbols-outlined");f&&(f.textContent=u?"visibility":"visibility_off"),a.setAttribute("aria-label",u?"Restore this answer":"Cross out this answer"),a.setAttribute("title",u?"Click to restore this option":"Click to eliminate this option"),li(n,s)}),o.addEventListener("click",function(c){if(!(c&&c.target&&c.target.closest(".cross-out-toggle"))){if(c&&c.target&&(c.target.closest(".option-image")||c.target.closest("img"))){console.log("[Interaction] Image clicked - ignoring submission to allow zoom");return}if(o.classList.contains("crossed-out")){console.log("[Interaction] Crossed-out option clicked - ignoring");return}var u=Array.from(o.parentElement.parentElement.children).indexOf(o.parentElement);Bt.recordOptionClick(u,e.text),ii(n,s,e.text,e.id)}}),o}function ns(e,t){return"vlp_crossout_"+e+"_"+t}function li(e,t){try{var n=[],s=T?T.querySelectorAll("button.answer-option"):[];s.forEach(function(o,r){o.classList.contains("crossed-out")&&n.push(r)});var i=ns(e,t);sessionStorage.setItem(i,JSON.stringify(n)),console.log("[CrossOut] Saved state:",n,"for key:",i)}catch(o){console.warn("[CrossOut] Failed to save state:",o)}}function ai(e,t){try{var n=ns(e,t),s=sessionStorage.getItem(n);if(!s)return;var i=JSON.parse(s);if(!Array.isArray(i))return;var o=T?T.querySelectorAll("button.answer-option"):[];i.forEach(function(r){if(o[r]){o[r].classList.add("crossed-out");var l=o[r].querySelector(".cross-out-toggle");if(l){var a=l.querySelector(".material-symbols-outlined");a&&(a.textContent="visibility"),l.setAttribute("aria-label","Restore this answer"),l.setAttribute("title","Click to restore this option")}}}),console.log("[CrossOut] Restored state:",i,"for key:",n)}catch(r){console.warn("[CrossOut] Failed to restore state:",r)}}function ci(){if(y){y.classList.remove("results-stage","showing-results","review-mode");var e=y.querySelector(".review-ribbon-strip");e&&e.remove()}var t=document.getElementById("flashlight-overlay");if(t&&(t.style.display="none"),y&&y.classList.remove("privacy-active"),ce&&(ce.classList.add("hidden"),ce.textContent=""),q&&(q.classList.add("hidden"),q.textContent=""),!!T){var n=T.querySelectorAll("button");n.forEach(function(s){s.disabled=!1,s.className=Ke,s.classList.remove("result-readonly","result-correct","result-incorrect","result-your-choice","result-neutral");var i=s.querySelector(".percentage-flag");i&&(i.style.display="none",i.textContent="");var o=s.querySelector(".result-icon-marker");o&&(o.textContent="");var r=s.querySelector(".result-badges");r&&(r.innerHTML="")})}}function ui(e){if(T&&!(T.children.length>0)){var t=Ee.length>0?Ee:e.options||[],n=["A","B","C","D","E","F","G","H"];T.innerHTML="",Ee=[],t.forEach(function(s,i){var o={text:s.text||s,imageURL:s.imageURL||s.imageUrl||""},r=n[i]||(i+1).toString(),l=ts(o,r,e.pollId,e.questionIndex,i);l.disabled=!0,l.classList.add("result-readonly");var a=document.createElement("li");a.appendChild(l),T.appendChild(a),Ee.push({text:o.text||"",imageURL:o.imageURL||""})})}}function di(e){if(T){var t=typeof e.totalResponses=="number"?e.totalResponses:0,n=e.resultPercentages||{},s=T.querySelectorAll("button");s.forEach(function(i){var o=i.dataset.answerText||"";i.disabled=!0,i.className=Ke+" result-readonly",i.classList.remove("result-correct","result-incorrect","result-your-choice");var r=i.querySelector(".result-announcement");if(r&&(r.textContent=""),e.status==="RESULTS_REVEALED"){var l=typeof n[o]=="number"?n[o]:0,a=i.querySelector(".percentage-flag");a&&(a.style.display="block",t>0||l>0?a.textContent=l+"%":a.textContent="0%");var c=e.correctAnswer&&o===e.correctAnswer,u=e.studentAnswer!==void 0&&e.studentAnswer!==null&&e.studentAnswer!=="",f=u&&o===e.studentAnswer,m=e.studentIsCorrect===null||e.studentIsCorrect===void 0?null:!!e.studentIsCorrect;c?i.classList.add("result-correct"):f&&(m===!1||!c)?i.classList.add("result-incorrect"):i.classList.add("result-neutral");var p=i.querySelector(".result-icon-marker");p&&(c?(p.textContent="check_circle",p.parentElement.parentElement.classList.add("result-correct")):f&&(m===!1||!c)?(p.textContent="cancel",p.parentElement.parentElement.classList.add("result-incorrect")):p.textContent="");var I=i.querySelector(".result-badges");if(I){if(I.innerHTML="",f){var L=document.createElement("span");L.className="badge-pill badge-your-choice",L.textContent="Your Choice",I.appendChild(L)}if(c){var L=document.createElement("span");L.className="badge-pill badge-correct",L.textContent="Correct",I.appendChild(L)}}if(r){var Q=[];c&&Q.push("Correct answer"),f&&Q.push("Your selection"),Q.push(l+"% of class selected this choice"),r.textContent=Q.join(". ")+"."}}})}}function fi(e){A=e;var t=e.metadata&&e.metadata.resetAt?e.metadata.resetAt:"";Ue=e.pollId+":"+e.questionIndex+":"+t,de=!!e.hasSubmitted,P&&(P.style.display="block",P.classList.remove("hidden")),y.style.display="block",y.classList.remove("hidden"),g.style.display="none",(e.questionIndex||0)+1,e.totalQuestions,Ut(e.questionIndex,e.totalQuestions),be&&(be.textContent=e.questionText||"");var n=!!e.questionImageURL;if(ee&&(n?(ee.src=e.questionImageURL,ee.style.display="block"):ee.style.display="none"),et&&et.classList.toggle("no-image",!n),tt&&(tt.style.display=n?"flex":"none"),ce&&ce.classList.add("hidden"),e.status==="RESULTS_REVEALED"&&q?(e.totalResponses||0)===0?(q.textContent="No responses recorded for this question.",q.classList.remove("hidden")):(q.classList.add("hidden"),q.textContent=""):q&&(q.classList.add("hidden"),q.textContent=""),ui(e),y.classList.add("results-stage","review-mode"),!y.querySelector(".review-ribbon-strip")){var s=document.createElement("div");s.className="review-ribbon-strip animate-fade-in",s.textContent="REVIEW",y.appendChild(s)}var i=document.getElementById("flashlight-overlay");i&&(i.style.display="none",i.style.setProperty("--x",window.innerWidth/2+"px"),i.style.setProperty("--y",window.innerHeight/2+"px")),y&&y.classList.add("privacy-active"),y.classList.remove("showing-results"),e.status==="RESULTS_REVEALED"&&requestAnimationFrame(function(){y.classList.add("showing-results")}),di(e)}function Lt(e){if(!e)return"";var t=document.createElement("div");return t.textContent=e,t.innerHTML}function Ct(e){e=e||{},ze(),cn(),P&&(P.style.display="block"),k&&(k.style.display="none"),y&&(y.style.display="none"),D&&(D.style.display="none"),ae&&(ae.style.display="none"),g&&(g.style.display="block");var t=e.theme==="dark",n=g?g.querySelector(".status-card"):null;if(t){g&&(g.className="fixed inset-0 z-[9000] flex items-center justify-center p-6 transition-all duration-700 backdrop-blur-3xl bg-slate-950/40 select-none",g.style.display="flex"),n&&(n.className="status-card relative w-full max-w-xl mx-auto p-12 overflow-hidden rounded-[2.5rem] border border-white/10 bg-white/5 shadow-[0_32px_64px_-16px_rgba(0,0,0,0.5)] flex flex-col items-center text-center motion-slide-up",n.style.backdropFilter="blur(20px)",n.style.webkitBackdropFilter="blur(20px)");var s=document.querySelector(".student-header");s&&(s.style.display="none")}else{g&&(g.className="text-center py-12 animate-fade-in block",g.style.display="block"),n&&(n.className="status-card bg-white rounded-2xl border border-gray-200 p-8 sm:p-12 shadow-2xl max-w-3xl mx-auto",n.style.backdropFilter="none",n.style.webkitBackdropFilter="none");var s=document.querySelector(".student-header");s&&(s.style.display="")}C&&(C.textContent=e.message||"",C.className=e.messageClass||(t?"text-white text-4xl font-bold tracking-tight mb-2 drop-shadow-sm":"text-gray-900 text-2xl font-semibold")),b&&(e.subtext?(b.style.display="block",b.textContent=e.subtext,b.className=e.subClass||(t?"text-slate-300 text-xl mt-4 max-w-lg mx-auto leading-relaxed":"text-gray-700 text-lg mt-4")):(b.style.display="none",b.textContent=""));var i=g?g.querySelector(".material-symbols-outlined"):null;if(i&&(i.textContent=e.icon||"info",t?(i.className="material-symbols-outlined text-8xl mb-10 select-none "+(e.iconClass||"text-emerald-400"),i.style.textShadow="0 0 30px rgba(52, 211, 153, 0.4)"):(i.className="material-symbols-outlined text-6xl mb-4 inline-block "+(e.iconClass||"text-veritas-navy"),i.style.textShadow="none")),resumeControls&&(resumeControls.style.display=e.showResume?"block":"none",t&&e.showResume)){var o=document.getElementById("resume-session-btn");o&&(o.className="mx-auto mt-8 flex items-center justify-center gap-3 px-10 py-5 rounded-2xl bg-white text-slate-900 text-xl font-bold hover:bg-slate-50 transition-all duration-300 hover:scale-105 shadow-[0_20px_40px_-10px_rgba(255,255,255,0.2)] active:scale-95")}jt&&(e.showExitAction?(jt.classList.remove("hidden"),$t&&($t.textContent=e.exitActionDescription||"Click below to exit fullscreen and close the secure window.",t&&($t.className="text-slate-400 text-sm mt-12 mb-4 max-w-sm mx-auto")),secureExitBtn&&t&&(secureExitBtn.className="mx-auto flex items-center justify-center gap-2 px-8 py-4 rounded-xl border border-white/10 bg-white/5 text-slate-300 text-base font-medium hover:bg-white/10 transition-all duration-300 hover:text-white"),On&&(On.textContent=e.exitActionLabel||"Exit Secure Session")):jt.classList.add("hidden")),document&&document.body&&(e.lockScroll?document.body.classList.add("secure-overlay-active"):document.body.classList.remove("secure-overlay-active"))}const ke={LOCKED:{title:"Assessment Paused",icon:"fullscreen_exit",body:"Fullscreen exit detected. Please wait for your instructor to re-admit you.",footer:"Your work has been saved. Stay on this screen.",badge:"PAUSED",statusLight:"CONNECTION ACTIVE"}};function V(e){var t=document.getElementById("lock-overlay");if(t){document.body.style.opacity="1",t.style.display="flex";var n=e?Lt(e):ke.LOCKED.body;t.innerHTML=`
                <div class="flex flex-col items-center justify-center h-full w-full max-w-2xl mx-auto p-8 animate-fade-in text-center">

                    <div class="h-20 w-20 bg-amber-900/20 rounded-full flex items-center justify-center mb-6 border-2 border-amber-700">
                        <span class="material-symbols-outlined text-4xl text-amber-400">
                            ${ke.LOCKED.icon}
                        </span>
                    </div>

                    <h1 class="text-3xl font-bold text-white mb-2 tracking-tight">
                        ${ke.LOCKED.title}
                    </h1>

                    <div class="w-full bg-amber-900/10 border-l-4 border-amber-500 p-5 my-6 text-left rounded-r-md">
                        <p class="text-xs font-semibold text-amber-400 uppercase tracking-wide mb-1">
                            ${ke.LOCKED.badge}
                        </p>
                        <p class="text-lg text-gray-100">
                            ${n}
                        </p>
                    </div>

                    <p class="text-base text-gray-400">
                        ${ke.LOCKED.footer}
                    </p>

                    <div class="mt-8 flex items-center gap-2 text-xs text-gray-500 font-medium">
                        <span class="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span>${ke.LOCKED.statusLight}</span>
                    </div>
                </div>
            `}}function At(){var e=document.getElementById("lock-overlay");e&&(e.style.display="none",e.innerHTML=""),document.body.style.opacity="1"}function mi(e,t,n){n=n||{};var s=n.icon||"check_circle",i=n.iconClass||"text-veritas-navy";g&&(g.style.display="block"),y&&(y.style.display="none"),C&&(C.textContent=e,C.className="text-gray-900 text-2xl font-semibold"),b&&(b.textContent=t,b.style.display="block",b.className="text-gray-700 text-lg mt-4");var o=g?g.querySelector(".status-card"):null;if(o){var r=o.querySelector(".material-symbols-outlined")||o.querySelector("div:first-child");if(!r||r.tagName!=="SPAN"||!r.classList.contains("material-symbols-outlined")){var l=document.createElement("span");l.className="material-symbols-outlined text-6xl mb-4 inline-block "+i,l.textContent=s,r?r.replaceWith(l):o.insertBefore(l,o.firstChild)}else r.textContent=s,r.className="material-symbols-outlined text-6xl mb-4 inline-block "+i}var a=document.getElementById("resume-controls");a&&(a.style.display="none");var c=document.getElementById("secure-exit-controls");c&&n.showExit&&c.classList.remove("hidden")}function vi(){console.log("Showing teacher block message"),Ye(),x=!0,Le=!0,Ct({icon:"pause_circle",iconClass:"text-amber-600",message:"Session Paused",messageClass:"text-gray-900 text-xl font-semibold",subtext:"Your teacher has temporarily frozen responses. Hold position.",subClass:"text-gray-700 text-base mt-4",showResume:!1,lockScroll:!0})}function gi(){console.log("Showing resume prompt"),Ye(),At();var e=hs(),t=document.getElementById("resume-session-label");t&&(t.textContent="Resume "+e),Ct({theme:"dark",icon:"fullscreen",message:"Cleared for Re-Entry",subtext:"Click below to return to fullscreen and rejoin the session.",showResume:!0,lockScroll:!0})}function mn(e){console.error("Error:",e);var t=e.message||e||"Unknown error",n=String(t);typeof t=="string"&&t.indexOf("Error: ")===0&&(t=t.substring(7)),(n.includes("NetworkError")||n.includes("HTTP 0")||n.includes("Connection failure"))&&(t="Network connection interrupted. Please check your internet connection and try again."),Ct({icon:"error",iconClass:"text-veritas-navy",message:"An error occurred: "+t,messageClass:"text-gray-900 text-2xl font-bold",showResume:!1,lockScroll:!1}),resumeControls&&(resumeControls.style.display="none")}var je=document.getElementById("calc-fab"),_e=document.getElementById("calc-window");document.getElementById("calc-header");var ss=document.getElementById("calc-close"),$e=document.getElementById("calc-iframe"),is=document.getElementById("calc-loader"),os=!1,Xe=!1;function vn(e){je&&(e?je.classList.remove("hidden"):(je.classList.add("hidden"),_e&&(_e.classList.add("hidden"),Xe=!1)))}function yi(){!_e||!$e||(_e.classList.remove("hidden"),Xe=!0,!os&&$e.dataset.src&&($e.src=$e.dataset.src,os=!0,$e.addEventListener("load",function(){is&&(is.style.display="none"),console.log("[Calculator] TI-84 iframe loaded")},{once:!0})))}function rs(){_e&&(_e.classList.add("hidden"),Xe=!1)}je&&je.addEventListener("click",function(){Xe?rs():yi()}),ss&&ss.addEventListener("click",function(e){e.stopPropagation(),rs()});function pi(){var e=document.getElementById("calc-header"),t=document.getElementById("calc-window");if(document.getElementById("calc-iframe"),!e||!t)return;var n="veritas-drag-shield",s=document.getElementById(n);s||(s=document.createElement("div"),s.id=n,s.style.position="fixed",s.style.top="0",s.style.left="0",s.style.width="100vw",s.style.height="100vh",s.style.zIndex="2147483647",s.style.cursor="move",s.style.display="none",s.style.background="transparent",document.body.appendChild(s));var i=!1,o,r,l,a;function c(m){if(!m.target.closest("#calc-close")){i=!0,s.style.display="block";var p=m.type.indexOf("touch")!==-1?m.touches[0].clientX:m.clientX,I=m.type.indexOf("touch")!==-1?m.touches[0].clientY:m.clientY;o=p,r=I;var L=t.getBoundingClientRect();l=L.left,a=L.top,t.style.transform="none",t.style.left=l+"px",t.style.top=a+"px",t.style.right="auto",t.style.bottom="auto",m.cancelable&&!m.target.tagName.match(/INPUT|TEXTAREA|SELECT|BUTTON/i)&&m.preventDefault()}}function u(m){if(i){m.cancelable&&m.preventDefault();var p=m.type.indexOf("touch")!==-1?m.touches[0].clientX:m.clientX,I=m.type.indexOf("touch")!==-1?m.touches[0].clientY:m.clientY,L=p-o,Q=I-r,j=l+L,me=a+Q,le=window.innerWidth-t.offsetWidth,Pe=window.innerHeight-t.offsetHeight;j=Math.max(0,Math.min(j,le)),me=Math.max(0,Math.min(me,Pe)),t.style.left=j+"px",t.style.top=me+"px"}}function f(){i=!1,s.style.display="none"}e.style.cursor="move",e.addEventListener("mousedown",c),e.addEventListener("touchstart",c,{passive:!1}),s.addEventListener("mousemove",u),s.addEventListener("touchmove",u,{passive:!1}),s.addEventListener("mouseup",f),s.addEventListener("touchend",f),s.addEventListener("mouseleave",f)}function bi(){var e=document.getElementById("question-progress");e&&(e.classList.add("hidden"),e.textContent="WAITING TO START");var t=document.querySelectorAll("#entry-screen");if(t.length>1){console.warn("[VisualFix] Found "+t.length+" entry-screens. Removing duplicates.");for(var n=1;n<t.length;n++)t[n].remove()}else{var s=document.querySelectorAll("h1");if(s.length>1){console.warn("[VisualFix] Found duplicate H1 elements. Cleaning up.");for(var i=1;i<s.length;i++){var o=s[i].closest(".flex.items-center.gap-4");o?o.remove():s[i].remove()}}}}function hi(e){return new Promise(function(t,n){if(!e){console.warn("[findActivePollForClass] No className provided"),t(null);return}var s=firebase.database();console.log("[findActivePollForClass] Searching for active polls in class:",e),s.ref("polls").orderByChild("className").equalTo(e).once("value").then(function(i){var o=i.val()||{},r=Object.keys(o);if(console.log("[findActivePollForClass] Found",r.length,"polls for class"),r.length===0){t(null);return}var l=r.map(function(a){return s.ref("sessions/"+a+"/live_session").once("value").then(function(c){var u=c.val();return u&&u.status&&u.status!=="ENDED"&&u.status!=="PRE_LIVE"?(console.log("[findActivePollForClass] Active session found:",a,"status:",u.status),a):null}).catch(function(c){return console.warn("[findActivePollForClass] Could not check session for poll",a,c.message),null})});return Promise.all(l)}).then(function(i){if(!i){t(null);return}var o=i.find(function(r){return r!==null});o?console.log("[findActivePollForClass] Returning active poll:",o):console.log("[findActivePollForClass] No active polls found for class:",e),t(o||null)}).catch(function(i){console.error("[findActivePollForClass] Query error:",i),n(i)})})}function Je(){var e=vs();e&&console.log("[App] State rehydrated from cache - continuing with fresh fetch"),pi(),bi();var t=window.currentPollId||sessionStorage.getItem("veritas_active_poll_id"),n=window.STUDENT_EMAIL||sessionStorage.getItem("veritas_student_email");t&&n?(console.log("[App] Starting Firebase Sidecar for poll:",t),wn(t,n)):console.warn("[App] Cannot start sidecar - missing pollId or email")}function ls(){var e=new URLSearchParams(window.location.search),t=e.get("token"),n=e.get("pollId");if(n&&(window.currentPollId=n,sessionStorage.setItem("veritas_active_poll_id",n)),t){console.log("[Auth] Token found in URL:",t);var s=document.getElementById("login-overlay");s&&(s.style.display="none");var i=document.getElementById("student-container");i&&(i.style.display="none"),!firebase.apps.length&&FIREBASE_CONFIG&&firebase.initializeApp(FIREBASE_CONFIG),firebase.auth().signInAnonymously().then(function(){return console.log("[Auth] Signed in anonymously"),firebase.database().ref("tokens/"+t).once("value")}).then(function(r){var l=r.val();if(l&&l.email){console.log("[Auth] Token verified. Student:",l.email,"Class:",l.className),window.STUDENT_EMAIL=l.email,window.SESSION_TOKEN=t,window.STUDENT_CLASS=l.className;try{sessionStorage.setItem("veritas_student_email",l.email),sessionStorage.setItem("veritas_session_token",t),l.className&&sessionStorage.setItem("veritas_student_class",l.className)}catch{}window.LoginManager&&LoginManager.hide();var a=document.getElementById("login-overlay");a&&(a.style.display="none");var c=document.getElementById("student-container");c&&(c.style.display="block"),window.currentPollId?Je():(console.log("[Auth] No pollId in URL, searching for active session..."),hi(l.className).then(function(u){u?(console.log("[Auth] Found active poll:",u),window.currentPollId=u,sessionStorage.setItem("veritas_active_poll_id",u)):console.warn("[Auth] No active poll found for class:",l.className),Je()}).catch(function(u){console.error("[Auth] Error finding active poll:",u),Je()}))}else throw new Error("Invalid or expired link.")}).catch(function(r){console.error("[Auth] Token validation failed:",r),r.code==="auth/admin-restricted-operation"?alert("Configuration Error: Anonymous Authentication is disabled in Firebase Console. Please enable it in Authentication > Sign-in method."):alert("Invalid link: "+r.message),as()})}else if(window.STUDENT_EMAIL)console.log("[Auth] Authenticated via injection:",window.STUDENT_EMAIL),firebase.auth&&!firebase.auth().currentUser&&(console.log("[Auth] ensuring anonymous auth for injected session..."),firebase.auth().signInAnonymously().catch(function(r){console.warn("[Auth] Background anon sign-in warning:",r)})),Je();else{var o=sessionStorage.getItem("veritas_student_email");o?(console.log("[Auth] Found persisted student email in sessionStorage:",o),window.STUDENT_EMAIL=o,Je()):(console.log("[Auth] No identity found. Initiating Login Flow."),as())}}function as(){document.body.classList.add("auth-required");var e=document.getElementById("student-container"),t=document.getElementById("entry-screen");if(e&&(e.style.display="none"),t&&(t.style.display="none"),window.LoginManager){var n=document.querySelector(".login-subtitle");n&&(n.textContent="Student Access"),LoginManager.init(function(s){console.log("[Auth] Student Login successful:",s.email);try{sessionStorage.setItem("veritas_student_email",s.email)}catch{}console.log("[Auth] Reloading to initialize session."),setTimeout(function(){window.location.reload()},500)}),LoginManager.show()}else console.error("LoginManager not loaded!"),alert("Authentication system missing. Please contact support.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ls):ls();function Ze(){var e=document.getElementById("calc-fab"),t=document.getElementById("calc-window");e&&(e.style.display="none"),t&&(t.classList.add("hidden"),t.classList.remove("active"),t.style.display="none",Xe=!1)}window.syncCalculatorVisibility=vn,window.hideCalculatorOnSessionEnd=Ze,window.updateStudentView=fe,window.LockManager=_,window.ViewManager=oe})();
