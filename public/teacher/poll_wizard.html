<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poll Wizard - Veritas Live Poll</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MathLive for math formulas -->
  <script src="//unpkg.com/mathlive"></script>

  <!-- Quill Rich Text Editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <!-- Firebase V9 SDK (Modular) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    import { richTextManager } from './RichTextManager.js';

    // Make available globally
    window.richTextManager = richTextManager;

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAv0bCe5KIuQx_sou8toBy5DG2PYaB_pBM",
      authDomain: "classroomproctor.firebaseapp.com",
      databaseURL: "https://classroomproctor-default-rtdb.firebaseio.com",
      projectId: "classroomproctor",
      storageBucket: "classroomproctor.firebasestorage.app",
      messagingSenderId: "600627073908",
      appId: "1:600627073908:web:935970f5849b28f6ad5221"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app);
    const storage = getStorage(app);

    // Store globally
    window.firebaseApp = { auth, db, functions, storage };
    window.firebaseModules = { ref, uploadBytes, getDownloadURL, collection, query, where, getDocs, httpsCallable };

    // Authentication State Management
    onAuthStateChanged(auth, async (user) => {
      const authSection = document.getElementById('auth-section');
      const mainContent = document.getElementById('main-content');
      const userInfo = document.getElementById('user-info');

      if (user) {
        authSection.classList.add('hidden');
        mainContent.classList.remove('hidden');
        userInfo.textContent = user.email;

        // Load classes for dropdown
        await window.loadClasses(user.uid);
      } else {
        authSection.classList.remove('hidden');
        mainContent.classList.add('hidden');
      }
    });

    // Sign In with Google
    window.signInWithGoogle = async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        console.error('Sign-in error:', error);
        alert('Failed to sign in: ' + error.message);
      }
    };

    // Sign Out
    window.signOutUser = async () => {
      try {
        await signOut(auth);
      } catch (error) {
        console.error('Sign-out error:', error);
        alert('Failed to sign out: ' + error.message);
      }
    };
  </script>

  <style>
    .question-card {
      scroll-margin-top: 100px;
    }

    .dropzone {
      border: 2px dashed #cbd5e1;
      transition: all 0.3s ease;
    }

    .dropzone.dragover {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }

    .progress-bar {
      transition: width 0.3s ease;
    }

    .ql-editor {
      min-height: 100px;
      font-size: 16px;
    }

    .floating-action-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 50;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen pb-24">

  <!-- Authentication Section -->
  <div id="auth-section" class="hidden">
    <div class="min-h-screen flex items-center justify-center">
      <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
        <h1 class="text-3xl font-bold text-gray-900 mb-2 text-center">Veritas Poll Wizard</h1>
        <p class="text-gray-600 text-center mb-8">Sign in to create your poll</p>

        <button onclick="signInWithGoogle()"
          class="w-full flex items-center justify-center px-4 py-3 border border-gray-300 rounded-md shadow-sm bg-white text-gray-700 hover:bg-gray-50 transition-colors font-medium">
          <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
            <path fill="#4285F4"
              d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
            <path fill="#34A853"
              d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
            <path fill="#FBBC05"
              d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
            <path fill="#EA4335"
              d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
          </svg>
          Sign in with Google
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="hidden">
    <!-- Header Removed by Request for Modal integration -->

    <!-- Main Poll Builder -->
    <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">

      <!-- Header Config Card -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Poll Configuration</h2>

        <!-- Poll Title -->
        <div class="mb-4">
          <label for="poll-title" class="block text-sm font-medium text-gray-700 mb-2">
            Poll Title <span class="text-red-500">*</span>
          </label>
          <input type="text" id="poll-title"
            class="w-full px-4 py-3 text-lg border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Enter poll title..." />
        </div>

        <!-- Target Class -->
        <div class="mb-4">
          <label for="target-class" class="block text-sm font-medium text-gray-700 mb-2">
            Target Class <span class="text-red-500">*</span>
          </label>
          <select id="target-class"
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Select a class...</option>
          </select>
        </div>

        <!-- Settings Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Timer -->
          <div>
            <label for="timer-minutes" class="block text-sm font-medium text-gray-700 mb-2">
              Timer (minutes)
            </label>
            <input type="number" id="timer-minutes"
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="0 = No timer" min="0" value="0" />
          </div>

          <!-- Shuffle Questions -->
          <div class="flex items-center pt-8">
            <input type="checkbox" id="shuffle-questions"
              class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
            <label for="shuffle-questions" class="ml-3 text-sm font-medium text-gray-700">
              Shuffle Questions
            </label>
          </div>
        </div>
      </div>

      <!-- Questions Container -->
      <div id="questions-container" class="space-y-6 mb-6">
        <!-- Question cards will be added here dynamically -->
      </div>

      <!-- Add Question Hint (shown when no questions) -->
      <div id="empty-state" class="text-center py-12 bg-white rounded-lg border-2 border-dashed border-gray-300">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">No questions yet</h3>
        <p class="mt-1 text-sm text-gray-500">Get started by adding your first question below.</p>
      </div>

    </main>

    <!-- Floating Action Bar -->
    <div class="floating-action-bar">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex justify-between items-center">
          <button onclick="addQuestion()"
            class="px-6 py-3 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors font-medium flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Add Question
          </button>

          <div class="flex items-center space-x-3">
            <span id="question-count" class="text-sm text-gray-600">0 questions</span>
            <button onclick="savePoll()" id="save-btn"
              class="px-8 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-medium shadow-lg">
              Save & Publish
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ========================================================================
    // STATE MANAGEMENT
    // ========================================================================

    let questions = [];
    let quillInstances = {}; // Store Quill editors by question ID

    // ========================================================================
    // CLASS LOADING
    // ========================================================================

    window.loadClasses = async (teacherId) => {
      const classDropdown = document.getElementById('target-class');
      classDropdown.innerHTML = '<option value="">Loading classes...</option>';

      try {
        const { db } = window.firebaseApp;
        const { collection, query, where, getDocs } = window.firebaseModules;

        const q = query(
          collection(db, 'classes'),
          where('teacherId', '==', teacherId)
        );

        const querySnapshot = await getDocs(q);
        const classes = [];
        querySnapshot.forEach((doc) => {
          classes.push({ id: doc.id, ...doc.data() });
        });

        if (classes.length === 0) {
          classDropdown.innerHTML = '<option value="">No classes found - Create one first</option>';
        } else {
          classDropdown.innerHTML = '<option value="">Select a class...</option>';
          classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls.id;
            option.textContent = cls.className;
            classDropdown.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading classes:', error);
        classDropdown.innerHTML = '<option value="">Error loading classes</option>';
      }
    };

    // ========================================================================
    // QUESTION MANAGEMENT
    // ========================================================================

    function addQuestion() {
      const questionId = `q_${Date.now()}`;
      const question = {
        id: questionId,
        stemHtml: '',
        mediaUrl: null,
        options: [
          { text: '', imageUrl: null },
          { text: '', imageUrl: null }
        ],
        correctAnswer: null,
        metacognitionEnabled: false
      };

      questions.push(question);
      renderQuestion(question);
      updateQuestionCount();
      hideEmptyState();

      // Scroll to new question
      setTimeout(() => {
        document.getElementById(`question-${questionId}`).scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }, 100);
    }

    function renderQuestion(question) {
      const container = document.getElementById('questions-container');
      const questionIndex = questions.findIndex(q => q.id === question.id);

      const questionCard = document.createElement('div');
      questionCard.id = `question-${question.id}`;
      questionCard.className = 'question-card bg-white rounded-lg shadow-md p-6';

      questionCard.innerHTML = `
        <!-- Question Header -->
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Question ${questionIndex + 1}</h3>
          <button
            onclick="removeQuestion('${question.id}')"
            class="text-red-600 hover:text-red-800 transition-colors"
            title="Delete question"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>

        <!-- Question Stem (Rich Text) -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Question Stem <span class="text-red-500">*</span>
          </label>
          <div id="editor-${question.id}" class="bg-white border border-gray-300 rounded-md"></div>
        </div>

        <!-- Media Dropzone -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Media (Optional)
          </label>
          <div
            id="dropzone-${question.id}"
            class="dropzone rounded-md p-6 text-center cursor-pointer"
            ondrop="handleDrop(event, '${question.id}')"
            ondragover="handleDragOver(event)"
            ondragleave="handleDragLeave(event)"
            onclick="document.getElementById('file-input-${question.id}').click()"
          >
            <input
              type="file"
              id="file-input-${question.id}"
              class="hidden"
              accept="image/*"
              onchange="handleFileSelect(event, '${question.id}')"
            />
            <div id="dropzone-content-${question.id}">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              <p class="mt-2 text-sm text-gray-600">Drag & drop image or click to browse</p>
              <p class="text-xs text-gray-500 mt-1">PNG, JPG, GIF up to 10MB</p>
            </div>
            <div id="upload-progress-${question.id}" class="hidden">
              <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                <div class="progress-bar bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
              </div>
              <p class="text-sm text-gray-600">Uploading...</p>
            </div>
            <div id="image-preview-${question.id}" class="hidden">
              <!-- Image preview will be inserted here -->
            </div>
          </div>
        </div>

        <!-- Answer Options -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Answer Options <span class="text-red-500">*</span>
          </label>
          <div id="options-${question.id}" class="space-y-4">
            <!-- Options will be rendered here -->
          </div>
          <button
            onclick="addOption('${question.id}')"
            class="mt-4 px-4 py-2 text-sm text-blue-600 hover:text-blue-800 font-medium"
            id="add-option-btn-${question.id}"
          >
            + Add Option (${question.options.length}/6)
          </button>
        </div>

        <!-- Metacognition Toggle -->
        <div class="flex items-center pt-4 border-t border-gray-200">
          <input
            type="checkbox"
            id="metacognition-${question.id}"
            class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
            onchange="toggleMetacognition('${question.id}', this.checked)"
            ${question.metacognitionEnabled ? 'checked' : ''}
          />
          <label for="metacognition-${question.id}" class="ml-3 text-sm font-medium text-gray-700">
            Enable Confidence Check
          </label>
        </div>
      `;

      container.appendChild(questionCard);

      // Initialize Quill editor for Stem
      const quill = window.richTextManager.initialize(`editor-${question.id}`, 'stem', 'Enter your question text...');
      if (quill) {
        if (question.stemHtml) {
          window.richTextManager.setContent(`editor-${question.id}`, question.stemHtml);
        }

        quill.on('text-change', () => {
          question.stemHtml = window.richTextManager.getContent(`editor-${question.id}`);
        });
      }

      // Render options
      renderOptions(question.id);
    }


    function renderOptions(questionId) {
      const question = questions.find(q => q.id === questionId);
      const container = document.getElementById(`options-${questionId}`);

      // We need to preserve existing editor contents if we are re-rendering simply to add/remove an option.
      // However, Quill editors on DOM nodes that are removed will be destroyed.
      // Easiest strategy: Re-render HTML structure, then re-initialize editors and populate them from data model.

      container.innerHTML = '';

      question.options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'flex items-start space-x-3'; // items-start for multiline editor
        optionDiv.innerHTML = `
          <div class="pt-2"> <!-- Padding to align radio with first line of text -->
            <input
                type="radio"
                name="correct-${questionId}"
                id="correct-${questionId}-${index}"
                class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300"
                onchange="setCorrectAnswer('${questionId}', ${index})"
                ${question.correctAnswer === index ? 'checked' : ''}
            />
          </div>
          
          <div class="flex-1">
             <!-- Editor Container -->
             <div id="option-editor-${questionId}-${index}" class="bg-white border border-gray-300 rounded-md" style="min-height: 60px;"></div>
          </div>

          ${question.options.length > 2 ? `
            <button
              onclick="removeOption('${questionId}', ${index})"
              class="text-red-600 hover:text-red-800 transition-colors pt-2"
              title="Remove option"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          ` : '<div class="w-5"></div>'}
        `;
        container.appendChild(optionDiv);

        // Initialize Quill for this option
        const editorId = `option-editor-${questionId}-${index}`;
        const quill = window.richTextManager.initialize(editorId, 'option', `Option ${index + 1}`);

        if (quill) {
          if (option.text) { // "text" is actually holding HTML now
            window.richTextManager.setContent(editorId, option.text);
          }

          quill.on('text-change', () => {
            option.text = window.richTextManager.getContent(editorId);
          });
        }
      });

      // Update add option button
      const addBtn = document.getElementById(`add-option-btn-${questionId}`);
      if (addBtn) {
        addBtn.textContent = `+ Add Option (${question.options.length}/6)`;
        addBtn.style.display = question.options.length >= 6 ? 'none' : 'block';
      }
    }

    function addOption(questionId) {
      const question = questions.find(q => q.id === questionId);
      if (question && question.options.length < 6) {
        question.options.push({ text: '', imageUrl: null });
        renderOptions(questionId);
      }
    }

    function removeOption(questionId, index) {
      const question = questions.find(q => q.id === questionId);
      if (question && question.options.length > 2) {
        question.options.splice(index, 1);
        // Adjust correct answer if needed
        if (question.correctAnswer === index) {
          question.correctAnswer = null;
        } else if (question.correctAnswer > index) {
          question.correctAnswer--;
        }
        renderOptions(questionId);
      }
    }

    function updateOptionText(questionId, index, text) {
      const question = questions.find(q => q.id === questionId);
      if (question && question.options[index]) {
        question.options[index].text = text;
      }
    }

    function setCorrectAnswer(questionId, index) {
      const question = questions.find(q => q.id === questionId);
      if (question) {
        question.correctAnswer = index;
      }
    }

    function toggleMetacognition(questionId, enabled) {
      const question = questions.find(q => q.id === questionId);
      if (question) {
        question.metacognitionEnabled = enabled;
      }
    }

    function removeQuestion(questionId) {
      if (!confirm('Are you sure you want to delete this question?')) {
        return;
      }

      const index = questions.findIndex(q => q.id === questionId);
      if (index !== -1) {
        questions.splice(index, 1);
        document.getElementById(`question-${questionId}`).remove();
        delete quillInstances[questionId];

        updateQuestionCount();
        renumberQuestions();

        if (questions.length === 0) {
          showEmptyState();
        }
      }
    }

    // updateOptionText function removed as it is no longer used (Quill handles updates)


    function renumberQuestions() {
      questions.forEach((question, index) => {
        const header = document.querySelector(`#question-${question.id} h3`);
        if (header) {
          header.textContent = `Question ${index + 1}`;
        }
      });
    }

    function updateQuestionCount() {
      const countEl = document.getElementById('question-count');
      const count = questions.length;
      countEl.textContent = `${count} question${count !== 1 ? 's' : ''}`;
    }

    function hideEmptyState() {
      document.getElementById('empty-state').style.display = 'none';
    }

    function showEmptyState() {
      document.getElementById('empty-state').style.display = 'block';
    }

    // ========================================================================
    // FILE UPLOAD (Firebase Storage with Optimistic UI)
    // ========================================================================

    function handleDragOver(event) {
      event.preventDefault();
      event.currentTarget.classList.add('dragover');
    }

    function handleDragLeave(event) {
      event.currentTarget.classList.remove('dragover');
    }

    function handleDrop(event, questionId) {
      event.preventDefault();
      event.currentTarget.classList.remove('dragover');

      const files = event.dataTransfer.files;
      if (files.length > 0) {
        uploadImage(files[0], questionId);
      }
    }

    function handleFileSelect(event, questionId) {
      const files = event.target.files;
      if (files.length > 0) {
        uploadImage(files[0], questionId);
      }
    }

    async function uploadImage(file, questionId) {
      // Validate file
      if (!file.type.startsWith('image/')) {
        alert('Please upload an image file');
        return;
      }

      if (file.size > 10 * 1024 * 1024) {
        alert('File size must be less than 10MB');
        return;
      }

      const { auth, storage } = window.firebaseApp;
      const { ref, uploadBytes, getDownloadURL } = window.firebaseModules;
      const user = auth.currentUser;

      if (!user) {
        alert('You must be signed in to upload images');
        return;
      }

      // Show optimistic preview immediately
      const dropzoneContent = document.getElementById(`dropzone-content-${questionId}`);
      const uploadProgress = document.getElementById(`upload-progress-${questionId}`);
      const imagePreview = document.getElementById(`image-preview-${questionId}`);

      // Hide dropzone content, show progress
      dropzoneContent.classList.add('hidden');
      uploadProgress.classList.remove('hidden');

      // Show preview of local file
      const reader = new FileReader();
      reader.onload = (e) => {
        imagePreview.innerHTML = `
          <div class="relative">
            <img src="${e.target.result}" class="max-h-64 mx-auto rounded-md" alt="Preview" />
            <button
              onclick="removeImage('${questionId}')"
              class="absolute top-2 right-2 bg-red-600 text-white rounded-full p-2 hover:bg-red-700 transition-colors"
              title="Remove image"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        `;
      };
      reader.readAsDataURL(file);

      try {
        // Upload to Firebase Storage
        const timestamp = Date.now();
        const fileName = `poll-images/${user.uid}/${timestamp}_${file.name}`;
        const storageRef = ref(storage, fileName);

        // Simulate progress (Firebase SDK doesn't provide detailed progress for uploadBytes)
        const progressBar = uploadProgress.querySelector('.progress-bar');
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 10;
          if (progress <= 90) {
            progressBar.style.width = `${progress}%`;
          }
        }, 100);

        await uploadBytes(storageRef, file);
        clearInterval(progressInterval);
        progressBar.style.width = '100%';

        const downloadURL = await getDownloadURL(storageRef);

        // Update question data
        const question = questions.find(q => q.id === questionId);
        if (question) {
          question.mediaUrl = downloadURL;
        }

        // Hide progress, show preview
        setTimeout(() => {
          uploadProgress.classList.add('hidden');
          imagePreview.classList.remove('hidden');
        }, 500);

      } catch (error) {
        console.error('Upload error:', error);
        alert('Failed to upload image: ' + error.message);

        // Reset UI
        dropzoneContent.classList.remove('hidden');
        uploadProgress.classList.add('hidden');
        imagePreview.classList.add('hidden');
        imagePreview.innerHTML = '';
      }
    }

    function removeImage(questionId) {
      const question = questions.find(q => q.id === questionId);
      if (question) {
        question.mediaUrl = null;
      }

      const dropzoneContent = document.getElementById(`dropzone-content-${questionId}`);
      const imagePreview = document.getElementById(`image-preview-${questionId}`);

      dropzoneContent.classList.remove('hidden');
      imagePreview.classList.add('hidden');
      imagePreview.innerHTML = '';
    }

    // ========================================================================
    // SAVE POLL (Cloud Function Call)
    // ========================================================================

    async function savePoll() {
      const saveBtn = document.getElementById('save-btn');
      const originalText = saveBtn.textContent;

      try {
        // Validation
        const pollTitle = document.getElementById('poll-title').value.trim();
        const targetClass = document.getElementById('target-class').value;
        const timerMinutes = parseInt(document.getElementById('timer-minutes').value) || 0;
        const shuffleQuestions = document.getElementById('shuffle-questions').checked;

        // Validate title
        if (!pollTitle) {
          alert('❌ Poll title is required');
          document.getElementById('poll-title').focus();
          return;
        }

        // Validate class
        if (!targetClass) {
          alert('❌ Please select a target class');
          document.getElementById('target-class').focus();
          return;
        }

        // Validate questions exist
        if (questions.length === 0) {
          alert('❌ You must add at least one question');
          return;
        }

        // Validate each question
        for (let i = 0; i < questions.length; i++) {
          const q = questions[i];

          // Check question text using RichTextManager
          const stemText = window.richTextManager.getText(`editor-${q.id}`).trim();
          if (!stemText) {
            alert(`❌ Question ${i + 1} must have text`);
            document.getElementById(`question-${q.id}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
          }

          // Check correct answer is marked
          if (q.correctAnswer === null || q.correctAnswer === undefined) {
            alert(`❌ Question ${i + 1} must have a correct answer marked`);
            document.getElementById(`question-${q.id}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
          }

          // Check all options have text
          for (let j = 0; j < q.options.length; j++) {
            const editorId = `option-editor-${q.id}-${j}`;
            const optionText = window.richTextManager.getText(editorId).trim();

            if (!optionText) {
              alert(`❌ Question ${i + 1}, Option ${j + 1} cannot be empty`);
              document.getElementById(`question-${q.id}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
              return;
            }
          }
        }

        // All validation passed - proceed with save
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        const { functions, auth } = window.firebaseApp;
        const { httpsCallable } = window.firebaseModules;
        const savePollFn = httpsCallable(functions, 'savePoll');

        const pollData = {
          title: pollTitle,
          classId: targetClass,
          settings: {
            timerMinutes,
            shuffleQuestions
          },
          questions: questions.map(q => ({
            id: q.id,
            stemHtml: q.stemHtml,
            mediaUrl: q.mediaUrl,
            options: q.options,
            correctAnswer: q.correctAnswer,
            metacognitionEnabled: q.metacognitionEnabled,
            points: 1
          }))
        };

        const result = await savePollFn(pollData);

        if (result.data.success) {
          alert('✅ Poll saved successfully!');

          // Option: Reset form or redirect
          if (confirm('Poll saved! Do you want to create another poll?')) {
            window.location.reload();
          } else {
            window.location.href = '/teacher/index.html';
          }
        } else {
          alert('❌ Failed to save poll: ' + (result.data.message || 'Unknown error'));
        }

      } catch (error) {
        console.error('Save error:', error);
        alert('❌ Error saving poll: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
      }
    }

    // ========================================================================
    // INITIALIZATION
    // ========================================================================

    // Add first question on load (if empty)
    window.addEventListener('load', () => {
      // Wait for auth to complete
      setTimeout(() => {
        if (questions.length === 0 && window.firebaseApp.auth.currentUser) {
          // Don't auto-add, let user add manually
        }
      }, 1000);
    });

  </script>

</body>

</html>