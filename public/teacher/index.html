<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veritas Live Poll - Class Manager</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase V9 SDK (Modular) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, query, where, getDocs, onSnapshot, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAv0bCe5KIuQx_sou8toBy5DG2PYaB_pBM",
      authDomain: "classroomproctor.firebaseapp.com",
      databaseURL: "https://classroomproctor-default-rtdb.firebaseio.com",
      projectId: "classroomproctor",
      storageBucket: "classroomproctor.firebasestorage.app",
      messagingSenderId: "600627073908",
      appId: "1:600627073908:web:935970f5849b28f6ad5221"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app);

    // Store globally for access from inline event handlers
    window.firebaseApp = { auth, db, functions };

    // Authentication State Management
    onAuthStateChanged(auth, async (user) => {
      const authSection = document.getElementById('auth-section');
      const mainContent = document.getElementById('main-content');
      const userInfo = document.getElementById('user-info');

      if (user) {
        // User is signed in
        authSection.classList.add('hidden');
        mainContent.classList.remove('hidden');
        userInfo.textContent = user.email;

        // Load classes
        await loadClasses(user.uid);
      } else {
        // User is signed out
        authSection.classList.remove('hidden');
        mainContent.classList.add('hidden');
      }
    });

    // Sign In with Google
    window.signInWithGoogle = async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        console.error('Sign-in error:', error);
        alert('Failed to sign in: ' + error.message);
      }
    };

    // Sign Out
    window.signOutUser = async () => {
      try {
        await signOut(auth);
      } catch (error) {
        console.error('Sign-out error:', error);
        alert('Failed to sign out: ' + error.message);
      }
    };

    // Load Classes for Teacher
    async function loadClasses(teacherId) {
      const classesList = document.getElementById('classes-list');
      classesList.innerHTML = '<div class="text-gray-500">Loading classes...</div>';

      try {
        const q = query(
          collection(db, 'classes'),
          where('teacherId', '==', teacherId)
        );

        // Real-time listener for classes
        onSnapshot(q, (querySnapshot) => {
          const classes = [];
          querySnapshot.forEach((doc) => {
            classes.push({ id: doc.id, ...doc.data() });
          });

          if (classes.length === 0) {
            classesList.innerHTML = `
              <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No classes yet</h3>
                <p class="mt-1 text-sm text-gray-500">Get started by creating your first class.</p>
              </div>
            `;
          } else {
            classesList.innerHTML = classes.map(cls => `
              <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                <div class="flex justify-between items-start">
                  <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900">${escapeHtml(cls.className)}</h3>
                    <p class="text-sm text-gray-500 mt-1">
                      Created: ${cls.createdAt ? new Date(cls.createdAt.toDate()).toLocaleDateString() : 'Just now'}
                    </p>
                  </div>
                  <button
                    onclick="viewClassDetails('${cls.id}')"
                    class="ml-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm font-medium"
                  >
                    Manage
                  </button>
                </div>
              </div>
            `).join('');
          }
        }, (error) => {
          console.error('Error loading classes:', error);
          classesList.innerHTML = `<div class="text-red-500">Error loading classes: ${error.message}</div>`;
        });

      } catch (error) {
        console.error('Error setting up classes listener:', error);
        classesList.innerHTML = `<div class="text-red-500">Error: ${error.message}</div>`;
      }
    }

    // Show Create Class Modal
    window.showCreateClassModal = () => {
      document.getElementById('create-class-modal').classList.remove('hidden');
    };

    // Hide Create Class Modal
    window.hideCreateClassModal = () => {
      document.getElementById('create-class-modal').classList.add('hidden');
      document.getElementById('class-name-input').value = '';
    };

    // Create Class
    window.createClass = async () => {
      const className = document.getElementById('class-name-input').value.trim();

      if (!className) {
        alert('Please enter a class name.');
        return;
      }

      const submitBtn = document.getElementById('create-class-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';

      try {
        const createClassFn = httpsCallable(functions, 'createClass');
        const result = await createClassFn({ className });

        if (result.data.success) {
          alert(result.data.message || 'Class created successfully!');
          hideCreateClassModal();
        } else {
          alert('Failed to create class: ' + (result.data.message || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error creating class:', error);
        alert('Error creating class: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Class';
      }
    };

    // View Class Details
    window.viewClassDetails = async (classId) => {
      const modal = document.getElementById('class-details-modal');
      const className = document.getElementById('detail-class-name');
      const studentsList = document.getElementById('students-list');

      // Store classId for later use
      window.currentClassId = classId;

      // Show modal
      modal.classList.remove('hidden');

      // Load class data
      try {
        const classDoc = await getDoc(doc(db, 'classes', classId));
        if (classDoc.exists()) {
          className.textContent = classDoc.data().className;
        }

        // Load students
        studentsList.innerHTML = '<div class="text-gray-500">Loading students...</div>';

        const studentsQuery = collection(db, 'classes', classId, 'students');
        const studentsSnapshot = await getDocs(studentsQuery);

        const students = [];
        studentsSnapshot.forEach((doc) => {
          students.push({ id: doc.id, ...doc.data() });
        });

        if (students.length === 0) {
          studentsList.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <p>No students in this class yet.</p>
              <p class="text-sm mt-2">Use the "Add Students" button to add students.</p>
            </div>
          `;
        } else {
          studentsList.innerHTML = `
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Added</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                ${students.map(student => `
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${escapeHtml(student.name)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHtml(student.email)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      ${student.createdAt ? new Date(student.createdAt.toDate()).toLocaleDateString() : 'Recently'}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (error) {
        console.error('Error loading class details:', error);
        studentsList.innerHTML = `<div class="text-red-500">Error loading students: ${error.message}</div>`;
      }
    };

    // Hide Class Details Modal
    window.hideClassDetailsModal = () => {
      document.getElementById('class-details-modal').classList.add('hidden');
      window.currentClassId = null;
    };

    // Show Add Students Modal
    window.showAddStudentsModal = () => {
      document.getElementById('add-students-modal').classList.remove('hidden');
    };

    // Hide Add Students Modal
    window.hideAddStudentsModal = () => {
      document.getElementById('add-students-modal').classList.add('hidden');
      document.getElementById('students-csv-input').value = '';
    };

    // Add Students (Bulk)
    window.addStudents = async () => {
      const csvInput = document.getElementById('students-csv-input').value.trim();

      if (!csvInput) {
        alert('Please enter student data.');
        return;
      }

      if (!window.currentClassId) {
        alert('No class selected.');
        return;
      }

      // Parse CSV (simple format: Name, Email)
      const lines = csvInput.split('\n').filter(line => line.trim());
      const students = [];

      for (const line of lines) {
        const parts = line.split(',').map(p => p.trim());
        if (parts.length >= 2) {
          students.push({
            name: parts[0],
            email: parts[1]
          });
        }
      }

      if (students.length === 0) {
        alert('No valid student entries found. Format: Name, Email (one per line)');
        return;
      }

      const submitBtn = document.getElementById('add-students-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Adding...';

      try {
        const bulkAddStudentsFn = httpsCallable(functions, 'bulkAddStudents');
        const result = await bulkAddStudentsFn({
          classId: window.currentClassId,
          students: students
        });

        if (result.data.success) {
          alert(result.data.message || `Added ${result.data.addedCount} student(s) successfully!`);
          hideAddStudentsModal();

          // Refresh class details
          viewClassDetails(window.currentClassId);
        } else {
          alert('Failed to add students: ' + (result.data.message || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error adding students:', error);
        alert('Error adding students: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Students';
      }
    };

    // Utility: Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>

  <style>
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.5);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Authentication Section -->
  <div id="auth-section" class="hidden">
    <div class="min-h-screen flex items-center justify-center">
      <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
        <h1 class="text-3xl font-bold text-gray-900 mb-2 text-center">Veritas Live Poll</h1>
        <p class="text-gray-600 text-center mb-8">Class Manager - Teacher Dashboard</p>

        <button
          onclick="signInWithGoogle()"
          class="w-full flex items-center justify-center px-4 py-3 border border-gray-300 rounded-md shadow-sm bg-white text-gray-700 hover:bg-gray-50 transition-colors font-medium"
        >
          <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Sign in with Google
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="hidden">
    <!-- Header -->
    <header class="bg-white shadow">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Class Manager</h1>
            <p class="text-sm text-gray-500">Manage your classes and students</p>
          </div>
          <div class="flex items-center space-x-4">
            <span class="text-sm text-gray-600" id="user-info"></span>
            <button
              onclick="signOutUser()"
              class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
            >
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Dashboard -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Actions Bar -->
      <div class="mb-6 flex justify-between items-center">
        <h2 class="text-xl font-semibold text-gray-900">Your Classes</h2>
        <button
          onclick="showCreateClassModal()"
          class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-medium flex items-center"
        >
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
          Create Class
        </button>
      </div>

      <!-- Classes List -->
      <div id="classes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="text-gray-500">Loading...</div>
      </div>
    </main>
  </div>

  <!-- Create Class Modal -->
  <div id="create-class-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="modal-overlay fixed inset-0" onclick="hideCreateClassModal()"></div>

      <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 relative z-10">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Create New Class</h3>

        <div class="mb-4">
          <label for="class-name-input" class="block text-sm font-medium text-gray-700 mb-2">
            Class Name
          </label>
          <input
            type="text"
            id="class-name-input"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="e.g., AP Computer Science A - Period 1"
          />
        </div>

        <div class="flex justify-end space-x-3">
          <button
            onclick="hideCreateClassModal()"
            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            id="create-class-btn"
            onclick="createClass()"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium"
          >
            Create Class
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Class Details Modal -->
  <div id="class-details-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="modal-overlay fixed inset-0" onclick="hideClassDetailsModal()"></div>

      <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full p-6 relative z-10">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 id="detail-class-name" class="text-xl font-semibold text-gray-900"></h3>
            <p class="text-sm text-gray-500">Class Details</p>
          </div>
          <button
            onclick="showAddStudentsModal()"
            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium"
          >
            Add Students
          </button>
        </div>

        <div id="students-list" class="mt-4 overflow-auto max-h-96">
          <div class="text-gray-500">Loading students...</div>
        </div>

        <div class="mt-6 flex justify-end">
          <button
            onclick="hideClassDetailsModal()"
            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Students Modal -->
  <div id="add-students-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="modal-overlay fixed inset-0" onclick="hideAddStudentsModal()"></div>

      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 relative z-10">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Add Students</h3>

        <div class="mb-4">
          <label for="students-csv-input" class="block text-sm font-medium text-gray-700 mb-2">
            Enter students (one per line, format: Name, Email)
          </label>
          <textarea
            id="students-csv-input"
            rows="8"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
            placeholder="John Smith, jsmith@example.com
Jane Doe, jdoe@example.com
Bob Johnson, bjohnson@example.com"
          ></textarea>
          <p class="text-xs text-gray-500 mt-1">Duplicate emails will be automatically skipped.</p>
        </div>

        <div class="flex justify-end space-x-3">
          <button
            onclick="hideAddStudentsModal()"
            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            id="add-students-btn"
            onclick="addStudents()"
            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium"
          >
            Add Students
          </button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
