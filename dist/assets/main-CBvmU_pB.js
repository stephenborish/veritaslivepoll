import"./firebase-QpG6acjP.js";import"./proctoring-CP4HimPX.js";(function(){window.LoginManager={show:function(){var ce=document.getElementById("login-overlay");ce&&(ce.style.display="flex")},hide:function(){var ce=document.getElementById("login-overlay");ce&&(ce.style.display="none")},setError:function(ce){var Fe=document.getElementById("login-error");Fe&&(Fe.textContent=ce,Fe.style.display="block")},init:function(ce){var Fe=function(f){ce&&ce(f)},V=document.getElementById("google-login-btn");V&&V.addEventListener("click",function(){var f=V.innerHTML;V.innerHTML="<span>Signing in...</span>",V.disabled=!0;var se=new firebase.auth.GoogleAuthProvider;se.setCustomParameters({prompt:"select_account"}),firebase.auth().signInWithPopup(se).then(function(P){var Ie=P.user;console.log("[Auth] Signed in as:",Ie.email),sessionStorage.setItem("veritas_session_token",Ie.uid),sessionStorage.setItem("veritas_teacher_email",Ie.email),window.SESSION_TOKEN=Ie.uid,window.TEACHER_EMAIL=Ie.email,LoginManager.hide(),Fe(Ie)}).catch(function(P){console.error("[Auth] Login failed:",P),LoginManager.setError(P.message||"Authentication failed. Please try again.")}).finally(function(){V.innerHTML=f,V.disabled=!1})});var K=document.getElementById("simple-login-btn");K&&K.addEventListener("click",function(){var f=document.getElementById("login-username"),se=document.getElementById("login-password"),P=f?f.value.trim():"",Ie=se?se.value.trim():"";if(!P||!Ie){LoginManager.setError("Please enter username and password.");return}var pe=K.innerText;K.innerText="Verifying...",K.disabled=!0;var X="",ve="";if(P.toLowerCase()==="teacher"&&Ie==="1234")X="teacher@veritas.app",ve="password1234";else if(P.includes("@"))X=P,Ie.length<6?ve="password"+Ie:ve=Ie;else{LoginManager.setError("Invalid username or password."),K.innerText=pe,K.disabled=!1;return}firebase.auth().signInWithEmailAndPassword(X,ve).then(function(oe){console.log("[Auth] Simple login success:",oe.user.email),LoginManager.hide(),Fe(oe.user)}).catch(function(oe){var Ae=oe.code==="auth/user-not-found"||oe.code==="auth/invalid-login-credentials"||oe.code==="auth/wrong-password"||oe.code==="auth/invalid-credential";if(Ae)return console.log("[Auth] User or Credential issue, attempting auto-create/recovery for demo..."),firebase.auth().createUserWithEmailAndPassword(X,ve).then(function(O){console.log("[Auth] Demo account created:",O.user.email),LoginManager.hide(),Fe(O.user)});throw oe}).catch(function(oe){console.error("[Auth] Login failed:",oe),oe.code==="auth/email-already-in-use"?LoginManager.setError("Incorrect password for existing demo account."):LoginManager.setError(oe.message),K.innerText=pe,K.disabled=!1})})}}})();(function(){try{console.log("[Info] Teacher Scripts Initializing...");var ce=document.getElementById("loader"),Me=document.getElementById("polls-card-view"),Fe=document.getElementById("polls-table-view"),ha=document.getElementById("polls-table-body"),$t=document.getElementById("polls-empty-state")}catch(e){console.error("[Critical] DOM Init Failed:",e)}var V=[],K=[],f={},se=null,P=[],Ie="",pe={column:"lastName",direction:"asc"},X=null,ve=null;try{window.SecureAssessmentShared&&window.SecureAssessmentShared.createHeartbeat?ve=window.SecureAssessmentShared.createHeartbeat({intervalMs:2500,onBeat:function(){typeof Jn=="function"&&Jn()}}):console.warn("[Warn] SecureAssessmentShared not found, heartbeat disabled")}catch(e){console.error("[Error] Heartbeat init failed:",e)}var oe=0,Ae=null,O=null,te=[],ae=new Set,ia=new Set,er=!1,J=null,Te=!1,je=!1,Be=!1,We=!1,I=[],yn=0,j=[],sa=[],be=null,lt="";function tr(e){if(!e)return"";var n=e;return typeof DOMPurify<"u"&&(n=DOMPurify.sanitize(e,{ADD_TAGS:["math","annotation","semantics","mrow","mi","mo","mn","msup","sub","sup"],ADD_ATTR:["class","style","src","alt","width","height"]})),'<div class="ql-editor">'+n+"</div>"}function nr(){window.renderMathInElement?renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]}):window.MathLive&&window.MathLive.renderMathInDocument&&window.MathLive.renderMathInDocument()}var dt={lastCompletionPct:null,lastAccuracyPct:null,lastLockoutTotal:null,allRespondedCelebrated:!1},ct=null,qe=null,oa=null,xn={},Je=!1,ci=-1,wn="question",la=2500,fo={get:function(e){try{var n=localStorage.getItem("vlp_"+e);if(!n)return null;var t=JSON.parse(n);return t.expires&&Date.now()>t.expires?null:t.value}catch(a){return console.warn("LocalCache get error:",a),null}},set:function(e,n,t){try{var a={value:n,expires:t?Date.now()+t:null};localStorage.setItem("vlp_"+e,JSON.stringify(a))}catch(r){console.warn("LocalCache set error:",r)}},invalidate:function(e){try{localStorage.removeItem("vlp_"+e)}catch(n){console.warn("LocalCache invalidate error:",n)}}},Oe={instances:{},lastFocusedQuillId:null,init:function(e,n,t,a){var r=document.getElementById(e);if(!r)return null;if(this.instances[e])if(this.instances[e].container!==r)delete this.instances[e];else return this.instances[e];var i=new Quill("#"+e,{theme:"snow",placeholder:t||"Enter text...",modules:{imageResize:{displaySize:!0},toolbar:{container:[["bold","italic","underline","strike"],["blockquote","code-block"],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{color:[]},{background:[]}],["link","image","formula"],[{align:[]}],["clean"]],handlers:{formula:function(){console.log("Formula button clicked");var s=this.quill.getSelection();typeof window.openFormulaModal=="function"?window.openFormulaModal(this.quill,s):(console.error("window.openFormulaModal is not defined. Checking global scope..."),window.openFormulaModal?window.openFormulaModal(this.quill,s):alert("Error: Formula editor could not be loaded. Please refresh."))}}}}});return n&&(typeof n=="object"&&n.ops?i.setContents(n):i.clipboard.dangerouslyPasteHTML(n)),i.on("text-change",function(s,d,o){if(a){var l=r.querySelector(".ql-editor"),c=l?l.innerHTML:i.root.innerHTML,u=i.getText(),g=i.getContents();a({html:c,text:u,delta:g})}}),i.on("selection-change",function(s,d,o){if(s&&(Oe.lastFocusedQuillId=e),s&&s.length===0){var[l,c]=i.getLeaf(s.index);l&&l.statics.blotName==="formula"&&openFormulaModal(i,s,l)}}),this.instances[e]=i,i},get:function(e){return this.instances[e]},clearAll:function(){this.instances={},this.lastFocusedQuillId=null},insertMathSymbol:function(e){if(!this.lastFocusedQuillId){var n=Object.keys(this.instances);if(n.length>0)this.lastFocusedQuillId=n[0];else return}var t=this.instances[this.lastFocusedQuillId];if(t){var a=t.getSelection(!0);a?(t.insertText(a.index,e),t.setSelection(a.index+e.length)):t.insertText(t.getLength()-1,e)}}};function Ze(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=Math.random()*16|0,t=e=="x"?n:n&3|8;return t.toString(16)})}var ui={NetworkError:{title:"Connection Problem",message:"Please check your internet and try again."},"permission-denied":{title:"Access Denied",message:"You don't have permission for this action."},"not-found":{title:"Not Found",message:"The requested item could not be found."},default:{title:"Error",message:"An unexpected error occurred. Please try again."}};function Ht(e){var n=e&&e.code||"default",t=ui[n]||ui.default;typeof D=="function"?D("error",t.title,t.message):console.error(t.title+": "+t.message,e)}var ar={guessing:{label:"Guessing",emoji:"ðŸ¤”",textClass:"text-red-700 dark:text-red-200",badgeClass:"bg-red-500/10 text-red-700 dark:text-red-200 border border-red-500/30",barClass:"bg-red-500",accentClass:"text-red-700/80 dark:text-red-200/80"},"somewhat-sure":{label:"Somewhat sure",emoji:"ðŸ¤·",textClass:"text-amber-700 dark:text-amber-200",badgeClass:"bg-amber-500/10 text-amber-700 dark:text-amber-200 border border-amber-500/30",barClass:"bg-amber-500",accentClass:"text-amber-700/80 dark:text-amber-200/80"},"very-sure":{label:"Very sure",emoji:"ðŸ‘",textClass:"text-blue-700 dark:text-blue-200",badgeClass:"bg-blue-500/10 text-blue-700 dark:text-blue-200 border border-blue-500/30",barClass:"bg-blue-500",accentClass:"text-blue-700/80 dark:text-blue-200/80"},certain:{label:"Absolutely certain",emoji:"ðŸ’¯",textClass:"text-green-700 dark:text-green-200",badgeClass:"bg-green-500/10 text-green-700 dark:text-green-200 border border-green-500/30",barClass:"bg-green-500",accentClass:"text-green-700/80 dark:text-green-200/80"}};const fi={success:4e3,info:5e3,warning:7e3,error:0};function D(e,n,t,a=null,r=null){const i=document.getElementById("toast-container");if(!i)return;const s=e==="warn"?"warning":e,d=document.createElement("div");d.className=`toast toast-${s}`;const o={success:"check_circle",error:"error",warning:"warning",info:"info"};let l="";if(r&&r.label&&(l=`<button class="toast-action-btn">${r.label}</button>`),d.innerHTML=`
      <span class="material-symbols-outlined toast-icon">${o[s]||"notifications"}</span>
      <div class="toast-content">
        <div class="toast-title">${n}</div>
        <div class="toast-message">${t}</div>
        ${l}
      </div>
      <button class="toast-close" onclick="this.closest('.toast').remove()">
        <span class="material-symbols-outlined" style="font-size: 18px">close</span>
      </button>
      <div class="toast-progress"></div>
    `,r&&r.onClick){const u=d.querySelector(".toast-action-btn");u&&(u.onclick=function(g){g.stopPropagation(),r.onClick(),d.remove()})}i.appendChild(d);let c=a??fi[s]??fi.info;c>0&&setTimeout(()=>{d.classList.add("toast-out"),setTimeout(()=>d.remove(),300)},c)}window.showToast=D;var da=!1,ke=null;function mo(e){ke||(ke=document.createElement("div"),ke.id="teacher-connectivity-toast",ke.className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] px-6 py-3 rounded-full shadow-lg transition-all duration-300 flex items-center gap-3",ke.style.cssText="opacity: 0; pointer-events: none;",document.body.appendChild(ke)),!e&&!da?(ke.innerHTML='<span class="inline-block w-3 h-3 rounded-full bg-amber-400 animate-pulse"></span><span class="font-semibold text-amber-900">Reconnecting to Server...</span>',ke.className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] px-6 py-3 rounded-full shadow-lg transition-all duration-300 flex items-center gap-3 bg-amber-100 border border-amber-300",ke.style.opacity="1",ke.style.pointerEvents="auto",da=!0,console.log("[Connectivity] Teacher - showing reconnecting toast")):e&&da&&(ke.innerHTML='<span class="inline-block w-3 h-3 rounded-full bg-emerald-500"></span><span class="font-semibold text-emerald-900">Connected - Syncing Data</span>',ke.className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] px-6 py-3 rounded-full shadow-lg transition-all duration-300 flex items-center gap-3 bg-emerald-100 border border-emerald-300",setTimeout(function(){ke.style.opacity="0",ke.style.pointerEvents="none",da=!1,console.log("[Connectivity] Teacher - hiding toast - connection restored")},2e3))}let zt=!1;function go(){const e=document.getElementById("fab-main-toggle"),n=document.getElementById("fab-menu"),t=document.getElementById("fab-container");if(!e||!n)return;e.addEventListener("click",function(){zt=!zt,zt?(n.classList.add("is-open"),e.classList.add("is-open"),e.setAttribute("aria-expanded","true")):(n.classList.remove("is-open"),e.classList.remove("is-open"),e.setAttribute("aria-expanded","false"))});const a=document.getElementById("fab-next-btn"),r=document.getElementById("fab-show-results-btn"),i=document.getElementById("fab-reset-btn"),s=document.getElementById("fab-stop-btn");a&&a.addEventListener("click",function(){typeof zn=="function"&&zn(),Lt()}),r&&r.addEventListener("click",function(){const d=document.getElementById("header-end-show-btn");d&&(typeof Ma=="function"?Ma():d.click()),Lt()}),i&&i.addEventListener("click",function(){typeof Ra=="function"&&Ra(),Lt()}),s&&s.addEventListener("click",function(){typeof as=="function"&&as(),Lt()}),document.addEventListener("click",function(d){zt&&!t.contains(d.target)&&Lt()})}function Lt(){zt=!1;const e=document.getElementById("fab-menu"),n=document.getElementById("fab-main-toggle");e&&e.classList.remove("is-open"),n&&(n.classList.remove("is-open"),n.setAttribute("aria-expanded","false"))}function mi(e,n){const t=document.getElementById(e);if(!t)return;const a=138.23,r=a-n/100*a;t.style.strokeDashoffset=r,t.classList.remove("ring-success","ring-warning","ring-danger"),n>=70?t.classList.add("ring-success"):n>=40?t.classList.add("ring-warning"):t.classList.add("ring-danger")}function po(e){const n=document.getElementById("ambient-state-overlay");n&&(n.className="ambient-state-overlay",n.classList.add(`state-${e}`))}var Vt={responses:[],accuracy:[],maxPoints:20};function gi(e,n){Vt[e]||(Vt[e]=[]),Vt[e].push(n),Vt[e].length>Vt.maxPoints&&Vt[e].shift()}function vo(e,n="default"){e&&(e.classList.remove("celebrate"),e.offsetWidth,e.classList.add("celebrate"),setTimeout(function(){e.classList.remove("celebrate")},600),n==="all-responded"?(D("success","ðŸŽ‰ All Students Responded!","Great work! Everyone has submitted their answer."),po("all-responded")):n==="perfect-accuracy"&&D("success","ðŸ’¯ Perfect Accuracy!","100% of students got the answer correct!"))}var Ct=[],En=!1,pi=50;function bo(){const e=document.getElementById("activity-feed"),n=document.getElementById("activity-feed-close"),t=document.getElementById("fab-activity-btn");e&&(n&&n.addEventListener("click",function(){ca()}),t&&t.addEventListener("click",function(){vi(),Lt()}),document.addEventListener("click",function(a){En&&!e.contains(a.target)&&!t.contains(a.target)&&ca()}))}function vi(){En?ca():ho()}function ho(){const e=document.getElementById("activity-feed");e&&(e.classList.add("is-open"),En=!0)}function ca(){const e=document.getElementById("activity-feed");e&&(e.classList.remove("is-open"),En=!1)}function yo(e,n,t){const r={type:e,icon:n,message:t,timestamp:new Date};Ct.unshift(r),Ct.length>pi&&(Ct=Ct.slice(0,pi)),xo()}function xo(){const e=document.getElementById("activity-feed-list"),n=document.getElementById("activity-feed-count");if(!e)return;if(Ct.length===0){e.innerHTML=`
        <div class="activity-feed-empty">
          <span class="material-symbols-outlined">inbox</span>
          <p>No recent activity</p>
        </div>
      `,n&&(n.textContent="0");return}n&&(n.textContent=Ct.length.toString());const t=Ct.map(function(a){const r=Ur(a.timestamp);return`
        <div class="activity-item">
          <div class="activity-icon ${a.type}">
            <span class="material-symbols-outlined">${a.icon}</span>
          </div>
          <div class="activity-content">
            <div class="activity-message">${y(a.message)}</div>
            <div class="activity-time">${r}</div>
          </div>
        </div>
      `}).join("");e.innerHTML=t}function wo(){document.addEventListener("keydown",function(e){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")return;const n=document.getElementById("live-view");if(!(!n||n.style.display==="none"))switch(e.key){case"ArrowRight":e.preventDefault();const t=document.getElementById("header-next-btn");t&&!t.disabled&&t.click();break;case"ArrowLeft":e.preventDefault();const a=document.getElementById("header-back-btn");a&&!a.disabled&&a.click();break;case" ":if(e.target.id==="timer-display")return;e.preventDefault(),ye?cn():Pa();break;case"r":case"R":e.preventDefault();const i=document.getElementById("header-reset-question-btn");i&&!i.disabled&&i.click();break;case"a":case"A":e.preventDefault(),vi();break;case"Escape":e.preventDefault(),En&&ca(),zt&&Lt();break}})}function Ne(e){if(this.inputId=e.inputId,this.containerId=e.containerId,this.data=e.data||[],this.onSelect=e.onSelect,this.filterFn=e.filterFn||function(n,t){return(n.label||"").toLowerCase().includes(t.toLowerCase())},this.renderItem=e.renderItem||function(n,t,a){var r=t?'<span class="absolute inset-y-0 right-0 flex items-center pr-4 text-veritas-navy"><span class="material-symbols-outlined text-sm">check</span></span>':"",i=a?"bg-veritas-navy text-white":"text-gray-900",s=n.subLabel?'<span class="block truncate text-xs opacity-70">'+y(n.subLabel)+"</span>":"";return'<li class="relative cursor-default select-none py-2 pl-3 pr-9 '+i+'" role="option" aria-selected="'+t+'" data-index="'+n.index+'"><div class="flex flex-col"><span class="block truncate font-medium">'+y(n.label)+"</span>"+s+"</div>"+r+"</li>"},this.input=document.getElementById(this.inputId),this.container=document.getElementById(this.containerId)||(this.input?this.input.parentElement:null),!this.input||!this.container){console.warn("Combobox init failed: missing input or container",this.inputId);return}this.button=this.container.querySelector("button[data-combobox-toggle]"),this.optionsList=document.createElement("ul"),this.optionsList.className="absolute z-[100] mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black/5 focus:outline-none sm:text-sm hidden",this.container.appendChild(this.optionsList),this.isOpen=!1,this.activeIndex=-1,this.filteredData=[],this.query="",this.init()}Ne.prototype.init=function(){var e=this;this.input.addEventListener("input",function(n){e.query=n.target.value,e.isOpen=!0,e.activeIndex=-1,e.renderOptions()}),this.input.addEventListener("focus",function(){e.data.length>0}),this.input.addEventListener("keydown",function(n){if(!e.isOpen){n.key==="ArrowDown"&&(e.isOpen=!0,e.renderOptions(),n.preventDefault());return}switch(n.key){case"ArrowDown":n.preventDefault(),e.activeIndex=(e.activeIndex+1)%e.filteredData.length,e.updateActiveOption(),e.scrollActiveIntoView();break;case"ArrowUp":n.preventDefault(),e.activeIndex=(e.activeIndex-1+e.filteredData.length)%e.filteredData.length,e.updateActiveOption(),e.scrollActiveIntoView();break;case"Enter":n.preventDefault(),e.activeIndex>=0&&e.filteredData[e.activeIndex]&&e.selectItem(e.filteredData[e.activeIndex]);break;case"Escape":e.close();break;case"Tab":e.close();break}}),this.button&&this.button.addEventListener("click",function(n){n.stopPropagation(),e.toggle()}),this.optionsList.addEventListener("click",function(n){var t=n.target.closest("li");if(t){var a=parseInt(t.dataset.index,10),r=e.filteredData[a];r&&e.selectItem(r)}}),document.addEventListener("click",function(n){e.isOpen&&!e.container.contains(n.target)&&e.close()})},Ne.prototype.updateData=function(e){this.data=e,this.isOpen&&this.renderOptions()},Ne.prototype.toggle=function(){this.isOpen?this.close():this.open()},Ne.prototype.open=function(){this.isOpen=!0,this.query=this.input.value,this.renderOptions()},Ne.prototype.close=function(){this.isOpen=!1,this.optionsList.classList.add("hidden"),this.activeIndex=-1},Ne.prototype.renderOptions=function(){var e=this;this.query===""?this.filteredData=this.data:this.filteredData=this.data.filter(function(n){return e.filterFn(n,e.query)}),this.filteredData.length===0?this.optionsList.innerHTML='<div class="relative cursor-default select-none py-2 px-4 text-gray-700">Nothing found.</div>':this.optionsList.innerHTML=this.filteredData.map(function(n,t){var a=Object.assign({},n,{index:t});return e.renderItem(a,!1,t===e.activeIndex)}).join(""),this.optionsList.classList.remove("hidden")},Ne.prototype.updateActiveOption=function(){var e=this.optionsList.querySelectorAll("li");e.forEach((function(n,t){t===this.activeIndex?(n.classList.add("bg-veritas-navy","text-white"),n.classList.remove("text-gray-900")):(n.classList.remove("bg-veritas-navy","text-white"),n.classList.add("text-gray-900"))}).bind(this))},Ne.prototype.scrollActiveIntoView=function(){var e=this.optionsList.children[this.activeIndex];e&&e.scrollIntoView({block:"nearest"})},Ne.prototype.selectItem=function(e){this.input.value=e.label,this.query=e.label,this.close(),this.onSelect&&this.onSelect(e);var n=new Event("input",{bubbles:!0});this.input.dispatchEvent(n)};var rr=null,ir=null,sr=null;function Eo(){go(),bo(),Pd(),wo(),ko(),Lo(),ji(),Io()}async function Io(){try{var e=sessionStorage.getItem("veritas_active_poll_id");if(!e){console.log("[Rehydration] No active poll in sessionStorage - showing dashboard");return}if(console.log("[Rehydration] Found active poll:",e,"- checking Firebase..."),typeof firebase>"u"||!firebase.database){console.warn("[Rehydration] Firebase not available - showing dashboard");return}var n=firebase.database(),t=n.ref("sessions/"+e+"/live_session"),a=await t.once("value"),r=a.val();if(!r){console.log("[Rehydration] No live_session data found - poll may have ended"),sessionStorage.removeItem("veritas_active_poll_id");return}var i=r.status||"",s=r.sessionPhase||r.metadata&&r.metadata.sessionPhase||"";if(i==="CLOSED"||i==="ENDED"||s==="ENDED"){console.log("[Rehydration] Poll is closed/ended - cleaning up and showing dashboard"),sessionStorage.removeItem("veritas_active_poll_id");return}console.log("[Rehydration] Poll is ACTIVE (status: "+i+", phase: "+s+") - restoring live view");var d=V?V.find(function(x){return x.pollId===e}):null;if(!d){console.log("[Rehydration] Poll not in ALL_POLLS cache - fetching from server...");var o=n.ref("polls/"+e),l=await o.once("value");if(d=l.val(),!d){console.error("[Rehydration] Could not find poll data for:",e),sessionStorage.removeItem("veritas_active_poll_id");return}d.pollId=e}f={pollId:e,pollName:d.pollName||d.name,questions:d.questions||[],questionIndex:r.questionIndex!==void 0?r.questionIndex:0,totalQuestions:d.questions?d.questions.length:0,className:d.className,sessionType:d.sessionType||"LIVE_POLL"};var c=f.questions[f.questionIndex]||{},u=c.timerSeconds||r.metadata&&r.metadata.timeLimit||0;if(u>0&&r.metadata&&r.metadata.startedAt){var g=r.metadata.startedAt,m=new Date(g).getTime(),p=Date.now(),b=Math.floor((p-m)/1e3),h=Math.max(0,u-b);console.log("[Rehydration] Timer sync: preset="+u+"s, elapsed="+b+"s, remaining="+h+"s"),typeof window<"u"&&(window.REHYDRATED_TIMER_REMAINING=h,window.REHYDRATED_TIMER_PRESET=u,window.REHYDRATED_TIMER_ACTIVE=i==="OPEN"&&h>0)}typeof gn=="function"&&gn(e),je=!0;var w={pollId:e,status:i||"OPEN",questionIndex:f.questionIndex,pollName:f.pollName,questionText:c.questionText||r.questionText||"",questionImageURL:c.questionImageURL||r.questionImageURL||"",options:c.options||r.options||[],totalQuestions:f.totalQuestions,correctAnswer:c.correctAnswer,timerSeconds:c.timerSeconds,metadata:r.metadata||{},authoritativeStatus:"LIVE",results:{},totalResponses:0,totalStudents:0,studentStatusList:[]};if(console.log("[Rehydration] SUCCESS - Restoring live view with data:",w),typeof showLiveView=="function")showLiveView(w);else if(typeof vt=="function"){var q=document.getElementById("dashboard-content"),T=document.getElementById("live-view");q&&(q.style.display="none"),T&&(T.style.display="block"),vt(w)}typeof Dt=="function"&&setTimeout(Dt,500),D("success","Session Restored","Live poll resumed. Timer synced with server.",3e3)}catch(x){console.error("[Rehydration] Error restoring session:",x),sessionStorage.removeItem("veritas_active_poll_id")}}function bi(){var e=0,n=30;function t(){window.LoginManager?a():(e++,e<n?(console.log("[Auth] Waiting for LoginManager...",e),setTimeout(t,100)):(console.error("[Critical] LoginManager failed to load after 3s"),alert("Auth System Missing - Please reload the page")))}function a(){if(console.log("initTeacherAuth firing"),sessionStorage.getItem("veritas_session_token")){console.log("[Auth] Teacher Authenticated");var r=document.getElementById("dashboard-root");r&&(r.style.display="flex"),Eo()}else{console.log("[Auth] No teacher session found. Initiating Login Flow.");var r=document.getElementById("dashboard-root");r&&(r.style.display="none"),LoginManager.init(function(i){console.log("[Auth] Teacher Login Successful:",i.email),sessionStorage.setItem("veritas_teacher_email",i.email),setTimeout(function(){window.location.reload()},500)}),LoginManager.show()}}t()}function ko(){rr=new Ne({inputId:"poll-search-input",containerId:"poll-search-container",onSelect:function(e){if(e.type==="class"){var n=document.getElementById("poll-filter-select");if(n){n.value=e.value;var t=new Event("change");n.dispatchEvent(t)}}}}),ir=new Ne({inputId:"student-search-input",containerId:"student-search-container",onSelect:function(e){}}),sr=new Ne({inputId:"analytics-student-search",containerId:"analytics-student-search-container",onSelect:function(e){e.student&&(Sl(e.student),document.getElementById("analytics-student-search").value="")}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",function(){setTimeout(bi,50)}):(console.log("[Info] Document already ready, firing initTeacherAuth immediately"),setTimeout(bi,50)),window.expandImage=function(e){var n=e.src,t='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:pointer;" onclick="this.remove()">';t+='<img src="'+n+'" style="max-width:90%;max-height:90%;"/>',t+="</div>",document.body.insertAdjacentHTML("beforeend",t)};function Lo(){console.log("âœ¨ Enhanced UI systems initialized (Phase 3)");var e=document.getElementById("live-question-image");e&&e.addEventListener("click",function(n){n.stopPropagation(),n.preventDefault(),this.src&&this.style.display!=="none"&&window.expandImage(this)})}function Co(e){var n=ar[e];return n?n.emoji+" "+n.label:null}var L=0,Qt=null,ut="LIVE_POLL",Ge=!1,xe={timeLimitMinutes:60,accessCode:"",availableFrom:"",dueBy:""},hi="updated_desc",St="all",Z={},M="",In=[],At="all",kn="",jt=[],So=null,Wt=null,or=!1,lr=!1,Tt=null;const ua=!1;function Ao(e){console.log("[Auth] Rendering Logout button for:",e.email);var n=document.querySelector(".header-right");if(n&&!document.getElementById("teacher-logout-btn")){var t=document.createElement("button");t.id="teacher-logout-btn",t.className="flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-all bg-white/10 hover:bg-white/20 text-white border border-white/20",t.innerHTML=`
          <span class="material-symbols-outlined text-[18px]">logout</span>
          <span class="hidden sm:inline">Logout</span>
        `,t.onclick=function(){yi()},t.title="Signed in as "+(e.email||"Teacher"),n.insertBefore(t,n.firstChild)}}function yi(){confirm("Are you sure you want to log out?")&&(console.log("[Auth] Initiating logout..."),firebase.auth().signOut().then(function(){console.log("[Auth] Signed out from Firebase."),sessionStorage.removeItem("veritas_session_token"),sessionStorage.removeItem("veritas_teacher_email"),localStorage.removeItem("veritas_teacher_email"),window.SESSION_TOKEN=null,window.TEACHER_EMAIL=null,window.DATA_LOAD_INITIATED=!1,window.location.reload()}).catch(function(e){console.error("[Auth] Logout failed:",e),D("error","Logout Failed",e.message)}))}window.logout=yi;function dr(){if(console.log("[Veritas] Initializing Firebase backend..."),typeof FIREBASE_CONFIG<"u"&&FIREBASE_CONFIG){if(typeof firebase>"u"){console.error("[Firebase] SDK not loaded! Retrying in 500ms..."),setTimeout(dr,500);return}if(!firebase.apps.length)try{firebase.initializeApp(FIREBASE_CONFIG),console.log("[Firebase] App initialized successfully.")}catch(e){console.error("[Firebase] Initialization error:",e),D("error","Critical Error","Failed to initialize backend. Please refresh.");return}}else{console.error("[Firebase] FIREBASE_CONFIG missing!"),D("error","Configuration Error","Backend config missing.");return}window.AUTH_READY=!1;try{firebase.auth().onAuthStateChanged(function(e){if(e){var n=Date.now();console.log("[Auth] User authenticated:",e.email,"| UID:",e.uid),sessionStorage.setItem("veritas_session_token",e.uid),sessionStorage.setItem("veritas_teacher_email",e.email),window.SESSION_TOKEN=e.uid,window.TEACHER_EMAIL=e.email,window.LoginManager&&window.LoginManager.hide();var t=document.getElementById("dashboard-root");t&&(t.style.display="flex"),t&&(t.style.display="flex"),ce&&(ce.style.display="none"),Ao(e),e.getIdToken().then(function(){window.AUTH_READY=!0,console.log("[Auth] Token validated - API calls enabled"),window.DATA_LOAD_INITIATED||(window.DATA_LOAD_INITIATED=!0,ka(),Fn())}).catch(function(r){console.error("[Auth] Token validation failed:",r),window.AUTH_READY=!1}),firebase.functions().httpsCallable("verifyTeacher")().then(function(r){var i=Date.now()-n;r.data.isTeacher?console.log("[Auth] Teacher authorized:",e.email,"(Verified in "+i+"ms)"):console.warn("[Auth] Unauthorized teacher access attempt:",e.email,r.data.reason||"")}).catch(function(r){console.error("[Auth] VerifyTeacher Error:",r)})}else{console.log("[Auth] No teacher session found. Initiating Login Flow."),window.AUTH_READY=!1,window.DATA_LOAD_INITIATED=!1,ce&&(ce.style.display="none");var t=document.getElementById("dashboard-root");t&&(t.style.display="none"),window.LoginManager?window.LoginManager.show():setTimeout(function(){window.LoginManager&&window.LoginManager.show()},500)}})}catch(e){console.error("[Auth] Error setting up auth listener:",e),D("error","Auth Setup Failed","Please refresh the page.")}}function xi(){var e=document.getElementById("header-datetime");if(e){var n=new Date,t={month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"};e.textContent=n.toLocaleDateString("en-US",t)}}xi(),setInterval(xi,6e4);var cr=null,To=new Promise(function(e){function n(){cr=window.VeritasModal||qo(),window.VeritasModal=cr,e(cr)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n,{once:!0}):n()});function ur(e){return To.then(function(n){return e(n)})}function S(e,n){return ur(function(t){return t.alert(Object.assign({message:e},n||{}))})}function Ke(e,n){return ur(function(t){return t.confirm(Object.assign({message:e},n||{}))})}function fr(e,n){return ur(function(t){return t.prompt(Object.assign({message:e},n||{}))})}function Bo(){var e=document.getElementById("veritas-modal-root");if(e)return e;var n=document.createElement("div");return n.id="veritas-modal-root",n.className="veritas-modal-root",n.setAttribute("aria-hidden","true"),n.innerHTML='<div class="veritas-modal-backdrop"></div><div class="veritas-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="veritas-modal-title" aria-describedby="veritas-modal-message"><div class="veritas-modal-header"><h2 id="veritas-modal-title">Notice</h2></div><div class="veritas-modal-body"><p id="veritas-modal-message"></p><div id="veritas-modal-subtext" class="veritas-modal-subtext"></div><div id="veritas-modal-input" class="veritas-modal-input" style="display: none;"><label for="veritas-modal-input-field" class="sr-only">Input</label><input id="veritas-modal-input-field" type="text" autocomplete="off" /></div></div><div class="veritas-modal-actions"><button type="button" class="veritas-modal-button secondary" data-action="cancel">Cancel</button><button type="button" class="veritas-modal-button primary" data-action="confirm"><span class="veritas-modal-spinner" aria-hidden="true"></span><span>Confirm</span></button></div></div>',(document.body||document.documentElement).appendChild(n),n}function qo(){var e=Bo(),n=e.querySelector(".veritas-modal-dialog"),t=e.querySelector("#veritas-modal-title"),a=e.querySelector("#veritas-modal-message"),r=e.querySelector("#veritas-modal-subtext"),i=e.querySelector("#veritas-modal-input"),s=e.querySelector("#veritas-modal-input-field"),d=e.querySelector('[data-action="confirm"]'),o=e.querySelector('[data-action="cancel"]'),l=d.querySelector("span:not(.veritas-modal-spinner)"),c=!1,u=null,g=null,m=null,p=!0,b=[];function h(E){var A=[].slice.call(document.body.children);E?(b=[],A.forEach(function(B){B!==e&&(b.push({node:B,ariaHidden:B.getAttribute("aria-hidden"),inert:"inert"in B?B.inert:null}),B.setAttribute("aria-hidden","true"),"inert"in B&&(B.inert=!0))})):(b.forEach(function(B){B.ariaHidden===null?B.node.removeAttribute("aria-hidden"):B.node.setAttribute("aria-hidden",B.ariaHidden),"inert"in B.node&&(B.inert!==null?B.node.inert=B.inert:B.node.inert=!1)}),b=[])}function w(E){E?(d.classList.add("loading"),d.setAttribute("disabled","disabled"),o.style.display!=="none"&&o.setAttribute("disabled","disabled")):(d.classList.remove("loading"),d.removeAttribute("disabled"),o.removeAttribute("disabled"))}function q(){var E='button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',A=[].slice.call(n.querySelectorAll(E));return A.filter(function(B){return!B.hasAttribute("disabled")&&B.offsetParent!==null})}function T(){var E=q();E.length>0?E[0].focus():n.focus()}function x(E){if(c)if(E.key==="Escape"){if(!p)return;E.preventDefault(),Q()}else if(E.key==="Tab"){var A=q();if(A.length===0){E.preventDefault();return}var B=A.indexOf(document.activeElement);E.shiftKey?B<=0&&(A[A.length-1].focus(),E.preventDefault()):B===A.length-1&&(A[0].focus(),E.preventDefault())}else E.key==="Enter"&&u&&u.mode==="prompt"&&document.activeElement===s&&(E.preventDefault(),N())}function C(E){c&&(n.contains(E.target)||(E.stopPropagation(),T()))}function R(E){c=!1,e.classList.remove("is-active"),e.setAttribute("aria-hidden","true"),document.body.classList.remove("veritas-modal-open"),e.removeEventListener("keydown",x,!0),document.removeEventListener("focus",C,!0),h(!1),w(!1),m&&typeof m.focus=="function"&&setTimeout(function(){m.focus()},0),g&&g(E),u=null,g=null}function N(){if(c){w(!0);var E=u?u.mode:"alert",A;E==="prompt"?A=s.value:E==="confirm"&&(A=!0),R(A)}}function Q(){if(c){var E=u?u.mode:"alert";if(E==="alert"){R(void 0);return}E==="confirm"?R(!1):E==="prompt"&&R(null)}}function G(E,A){return A=A||{},u=Object.assign({},A,{mode:E}),p=A.allowEscape!==!1,t.textContent=A.title||(E==="confirm"?"Please Confirm":E==="prompt"?"Enter Response":"Notice"),A.html?a.innerHTML=A.html:a.textContent=A.message||"",A.subtext?(r.style.display="block",r.textContent=A.subtext):(r.style.display="none",r.textContent=""),E==="prompt"?(i.style.display="flex",s.value=A.defaultValue||"",A.placeholder?s.placeholder=A.placeholder:s.removeAttribute("placeholder")):(i.style.display="none",s.value="",s.removeAttribute("placeholder")),l.textContent=A.confirmText||(E==="confirm"?"Confirm":E==="prompt"?"Submit":"OK"),A.destructive?d.classList.add("destructive"):d.classList.remove("destructive"),o.style.display=E==="alert"?"none":"inline-flex",o.textContent=A.cancelText||"Cancel",w(!1),m=document.activeElement,e.classList.add("is-active"),e.setAttribute("aria-hidden","false"),document.body.classList.add("veritas-modal-open"),c=!0,e.addEventListener("keydown",x,!0),document.addEventListener("focus",C,!0),E==="prompt"?(s.focus(),s.select()):E==="confirm"&&A.focusCancel?o.focus():d.focus(),h(!0),new Promise(function(B){g=B})}return d.addEventListener("click",N),o.addEventListener("click",Q),e.addEventListener("click",function(E){if(E.target===e||E.target.classList.contains("veritas-modal-backdrop")){if(!u||u.allowBackdropClose===!1)return;Q()}}),{alert:function(E){return G("alert",E).then(function(){})},confirm:function(E){return G("confirm",E).then(function(A){return A!==!1})},prompt:function(E){return G("prompt",E).then(function(A){return A})}}}function k(e,n,t){var a=document.getElementById(e);return a?(a.addEventListener("click",n),a):(t&&console.error("[Button Binding] CRITICAL button not found:",e),null)}function No(e,n,t){var a=document.getElementById(e);return a?(a.addEventListener(n,t),a):null}function Mo(e,n,t){e&&e.addEventListener("change",n)}function fa(){var e=document.getElementById("filter-locked-only-btn"),n=document.getElementById("filter-all-btn");e&&(typeof Rt<"u"&&Rt==="locked"?(e.classList.add("bg-red-500/30"),e.classList.remove("bg-red-500/10")):(e.classList.remove("bg-red-500/30"),e.classList.add("bg-red-500/10"))),n&&(typeof Rt<"u"&&Rt==="all"?(n.classList.add("bg-primary/30"),n.classList.remove("bg-primary/10")):(n.classList.remove("bg-primary/30"),n.classList.add("bg-primary/10")))}function Ro(){var e=document.getElementById("exited-students-panel");e&&(e.classList.remove("hidden"),e.scrollIntoView({behavior:"smooth",block:"start"}))}function wi(){var e=Ln?"menu_open":"menu",n=Ln?"Hide navigation":"Show navigation";ki.forEach(function(t){if(t){var a=t.querySelector(".material-symbols-outlined");a&&(a.textContent=e),t.setAttribute("aria-label",n),t.setAttribute("aria-expanded",Ln?"true":"false")}})}function et(e){Gt&&(Ln=e,e?(Gt.classList.remove("w-0","p-0","border-none","opacity-0"),Gt.classList.add("w-64","p-4","border-r","flex")):(Gt.classList.remove("w-64","p-4","border-r"),Gt.classList.add("w-0","p-0","border-none","opacity-0"),Gt.classList.add("flex")),wi())}function Do(e){e&&e.preventDefault(),et(!Ln)}function Ei(e){var n=k(e,Do);n&&ki.push(n)}function ma(e){e&&!e.dataset.defaultHtml&&(e.dataset.defaultHtml=e.innerHTML)}function Po(e){return'<span class="flex w-full items-center justify-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"></span><span>'+y(e||"Loading...")+"</span></span>"}function Y(e,n,t){e&&(n?(ma(e),e.disabled=!0,e.setAttribute("aria-busy","true"),e.setAttribute("aria-disabled","true"),e.innerHTML=Po(t)):(e.dataset.defaultHtml&&(e.innerHTML=e.dataset.defaultHtml),e.disabled=!1,e.removeAttribute("aria-busy"),e.removeAttribute("aria-disabled")))}function Ii(){or||lr||window.google&&google.charts&&typeof google.charts.load=="function"&&(lr=!0,google.charts.load("current",{packages:["corechart"]}),google.charts.setOnLoadCallback(function(){or=!0,lr=!1,Tt&&(clearInterval(Tt),Tt=null);try{Uo()}catch(e){console.error("Post-chart bootstrap failed:",e)}}))}function Uo(){if(typeof _n=="function"&&typeof W<"u"&&W)try{_n()}catch(e){console.error("Analytics redraw failed:",e)}}var ne=document.getElementById("poll-select"),_=document.getElementById("start-session-main-btn"),_e=document.getElementById("send-link-btn"),$=document.getElementById("view-links-btn");document.getElementById("header-session-controls");var Gt=document.getElementById("dashboard-sidebar"),Ln=window.innerWidth>=1024,ki=[],Kt=document.getElementById("dashboard");document.getElementById("live-view");var Li=document.getElementById("live-mobile-nav"),Ci=document.getElementById("live-mobile-actions");document.getElementById("roster-manager"),document.getElementById("archived-view"),document.getElementById("analytics-view");var ga=document.getElementById("header-default"),pa=document.getElementById("header-live"),we=document.getElementById("header-calc-toggle"),va=document.getElementById("header-calc-state"),ba=document.getElementById("poll-creator-modal"),ft=document.getElementById("student-links-modal"),Si=document.getElementById("poll-sort-select"),Cn=document.getElementById("poll-filter-select"),Sn=document.getElementById("poll-search-input"),An=document.getElementById("poll-search-clear-btn"),Me=document.getElementById("polls-card-view"),ha=document.getElementById("polls-table-body"),$t=document.getElementById("polls-empty-state"),mt=document.getElementById("class-select"),Tn=document.querySelectorAll(".builder-session-toggle"),mr=document.getElementById("secure-assessment-settings"),Yt=document.getElementById("secure-session-meta"),Xt=document.getElementById("secure-time-limit-input"),Jt=document.getElementById("secure-access-code-input"),Zt=document.getElementById("secure-available-input"),en=document.getElementById("secure-due-input"),tn=document.getElementById("student-manager-modal"),Ai=document.getElementById("student-manager-name"),Ti=document.getElementById("student-manager-status"),Bi=document.getElementById("student-manager-progress"),qi=document.getElementById("student-manager-time"),Ni=document.getElementById("student-manager-extra"),Mi=document.getElementById("student-manager-connection"),gr=document.getElementById("student-manager-connection-dot"),pr=document.getElementById("student-manager-message"),Ri=document.getElementById("student-manager-loading"),vr=document.getElementById("student-manager-add-5"),br=document.getElementById("student-manager-add-10"),Bn=document.getElementById("student-manager-pause"),Bt=document.getElementById("student-manager-unlock"),hr=document.getElementById("student-manager-force-submit"),Di=document.getElementById("student-manager-close"),yr=document.getElementById("bulk-time-input"),nn=document.getElementById("bulk-time-all-btn"),gt=document.getElementById("bulk-time-selected-btn"),Pi=document.getElementById("bulk-selection-count"),ya=document.getElementById("bulk-selection-clear"),qn=document.getElementById("bulk-selected-label"),Ui=document.getElementById("question-sort-reset-btn"),Fi=document.getElementById("question-sort-help"),pt=document.getElementById("question-navigator"),Nn=document.getElementById("archived-class-filter"),xa=document.getElementById("archived-list"),wa=document.getElementById("archived-empty-state"),Ea=document.getElementById("archived-detail"),Fo=document.getElementById("archived-poll-title"),Oo=document.getElementById("archived-poll-meta"),_o=document.getElementById("archived-question-count"),Ho=document.getElementById("archived-response-count"),Oi=document.getElementById("archived-questions-container"),xr=document.getElementById("roster-class-list"),_i=document.getElementById("roster-class-title"),wr=document.getElementById("roster-empty-state"),Er=document.getElementById("roster-table-wrapper"),Mn=document.getElementById("roster-table-body"),le=document.getElementById("roster-status"),Rn=document.getElementById("rename-class-btn"),Dn=document.getElementById("delete-class-btn"),Hi=document.getElementById("add-class-btn"),zi=document.getElementById("add-student-row-btn"),Pn=document.getElementById("save-roster-btn"),Vi=document.getElementById("refresh-archived-btn");document.getElementById("emulator-controls");var Ia=document.getElementById("emulator-enabled");document.getElementById("emulator-options"),document.getElementById("emulator-student-count"),document.getElementById("emulator-concurrent");var Qi=!1;ma(_),ma(_e),ma($),window.VeritasDebug={initialize:dr,loadInitialData:ka,loadDashboardSummary:Fn,forceSync:function(){ka(),Fn()}},dr(),window.google&&google.charts&&typeof google.charts.load=="function"?Ii():(console.warn("Google Charts unavailable â€“ continuing initialization without charts."),Tt=setInterval(function(){window.google&&google.charts&&typeof google.charts.load=="function"&&Ii()},400),setTimeout(function(){Tt&&(clearInterval(Tt),Tt=null)},8e3));function ji(){try{console.log("[App] Initializing dashboard bindings..."),_=document.getElementById("start-session-main-btn"),ne=document.getElementById("poll-select"),k("nav-create-poll",function(){console.log("Create New Poll button clicked - opening wizard via Wizard.init()"),et(!1),window.Wizard&&window.Wizard.init?Wizard.init():console.error("Wizard system not loaded")}),k("nav-polls-list",function(){He(),et(!0)}),k("nav-rosters",function(){zo(),et(!1)}),k("nav-archived",function(){Vo(),et(!1)}),k("nav-analytics",function(){hl(),et(!1)}),k("close-modal-btn",Cs),k("close-links-modal-btn",$l),k("close-preview-modal-btn",Fa),k("add-question-btn",Ad),k("save-poll-btn",Rd),k("import-from-bank-btn",yd),k("close-question-bank-btn",Ss),k("import-selected-btn",Ed),k("ai-suggest-btn",Id),k("close-ai-modal-btn",Ts),k("generate-ai-btn",Cd),k("add-stimulus-btn",function(){typeof qs=="function"&&(qs(),setTimeout(function(){window.QuillManager&&Oe.init&&Oe.init("stimulus-content-editor","","Enter passage content...",function(c){})},100))}),k("close-stimulus-modal-btn",Jr),k("cancel-stimulus-btn",Jr),k("create-stimulus-btn",Sd),No("new-poll-name","input",z),Mo(mt,z,"class-select"),Tn&&Tn.length&&Tn.forEach(function(c){c.addEventListener("click",function(){var u=this.dataset.sessionType;typeof $r=="function"&&$r(u)})}),Xt&&Xt.addEventListener("input",function(){Qn(),z()}),Jt&&Jt.addEventListener("input",function(){this.value=(this.value||"").toUpperCase(),Qn(),z()}),Zt&&Zt.addEventListener("change",function(){Qn(),z()}),en&&en.addEventListener("change",function(){Qn(),z()}),typeof Gr=="function"&&Gr(),typeof Va=="function"&&Va(),typeof Kr=="function"&&Kr(),Sn&&Sn.addEventListener("input",function(){lt=(this.value||"").trim(),an(),Cr()}),An&&An.addEventListener("click",function(){lt="",Sn&&(Sn.value="",Sn.focus()),an(),Cr()}),Cr(),Wr(),Ui&&Ui.addEventListener("click",function(){ld()}),pt&&(pt.addEventListener("dragover",gd),pt.addEventListener("drop",pd)),_?(console.log("[DashboardBindings] Found startPollBtn (ID: start-session-main-btn). Binding click event..."),_.removeEventListener("click",Pr),_.addEventListener("click",Pr),console.log("[DashboardBindings] Bound onStartPoll to start-session-main-btn")):console.error("[DashboardBindings] CRITICAL: startPollBtn (ID: start-session-main-btn) NOT FOUND in DOM.");var e=document.getElementById("wizard-calculator-toggle");e&&e.addEventListener("change",function(){typeof v<"u"&&(v.calculatorEnabled=this.checked)}),k("header-start-btn",ns),k("header-end-show-btn",Ma),k("header-stop-btn",ss),k("header-present-btn",Mc);var n=document.getElementById("header-calc-toggle");n&&n.addEventListener("click",Al),k("live-more-actions-btn",function(c){c.stopPropagation(),console.log("[LiveUI] Three-dots menu clicked");var u=document.getElementById("live-more-menu");u&&(u.classList.toggle("hidden"),console.log("[LiveUI] Menu hidden:",u.classList.contains("hidden")))}),document.addEventListener("click",function(c){var u=document.getElementById("live-more-menu"),g=document.getElementById("live-more-actions-btn");u&&!u.classList.contains("hidden")&&!u.contains(c.target)&&(!g||!g.contains(c.target))&&u.classList.add("hidden")}),k("header-edit-poll-btn",function(){f&&f.pollId&&Ca(f.pollId)}),k("header-back-btn",rs,!0),k("header-prev-btn",rs,!0),k("header-next-btn",zn,!0),document.addEventListener("click",function(c){var u=document.getElementById("live-more-menu"),g=document.getElementById("live-more-actions-btn");u&&!u.classList.contains("hidden")&&!u.contains(c.target)&&!g.contains(c.target)&&u.classList.add("hidden");var m=document.getElementById("student-inspector-panel");if(m&&!m.classList.contains("hidden")){var p=m.contains(c.target),b=c.target.closest(".student-status-card")||c.target.closest(".student-row");!p&&!b&&Or()}}),k("header-reset-question-btn",Ra),k("hide-results-btn",Tl),k("strip-next-btn",zn),Ei("dashboard-sidebar-toggle"),Ei("dashboard-sidebar-toggle-live"),wi();var t=document.querySelectorAll(".live-mobile-tab");t.forEach(function(c){c.addEventListener("click",function(){var u=c.getAttribute("data-panel");kr(u)})}),Ir(),k("focus-lockouts-btn",Ro);var a=document.getElementById("hud-focus-lockouts-btn");a&&(a.onclick=function(c){c.stopPropagation();var u=document.getElementById("locked-students-popover");u&&u.classList.toggle("hidden")}),k("start-btn",Pa),k("pause-btn",cn),k("reset-btn",cs),k("add-10s-btn",function(){Pt(),Ye(10)}),k("subtract-10s-btn",function(){Pt(),Ye(-10)}),k("mobile-start-btn",Pa),k("mobile-pause-btn",cn),k("mobile-reset-btn",Ra),k("mobile-next-btn",zn),k("mobile-reveal-btn",Ma),k("mobile-resume-btn",ns),k("mobile-stop-btn",ss),k("add-10s-btn-mobile",function(){Pt(),Ye(10)}),k("subtract-10s-btn-mobile",function(){Pt(),Ye(-10)}),k("mobile-locks-btn",function(){var c=document.getElementById("hud-focus-lockouts-btn");c&&!c.disabled&&c.click()});var r=document.getElementById("timer-display");r&&(r.addEventListener("blur",function(){Pt(),ht()}),r.addEventListener("keydown",function(c){c.key==="Enter"&&r.blur()})),ht(),re("Timer idle.","info"),k("send-link-btn",zr),k("view-links-btn",Ua),k("header-send-link-btn",zr),k("header-view-links-btn",Ua),console.log("[DashboardBindings] Bound link action buttons."),k("add-30s-btn-preset",function(){Pt(),Ye(30);var c=document.getElementById("live-more-menu");c&&c.classList.add("hidden")}),k("add-60s-btn-preset",function(){Pt(),Ye(60);var c=document.getElementById("live-more-menu");c&&c.classList.add("hidden")});var i=document.getElementById("student-search-input");i&&i.addEventListener("input",function(){Ie=this.value,Ee()}),k("filter-all-btn",function(){ds("ALL")}),k("filter-locked-only-btn",function(){ds("LOCKED")});var s=document.getElementById("student-status-filter-select");s&&s.addEventListener("change",function(){Rt=this.value,fa(),Ee()});var d=document.getElementById("student-correctness-filter-select");d&&d.addEventListener("change",function(){Ul=this.value,Ee()});var o=document.getElementById("student-sort-select");o&&o.addEventListener("change",function(){if(pe.column=this.value,this.value==="recent"&&pe.direction==="asc"){pe.direction="desc";var c=document.querySelector("#student-sort-direction-btn span");c&&(c.textContent="north")}else{var u=document.querySelector("#student-sort-direction-btn span");u&&(u.textContent=pe.direction==="asc"?"south":"north")}Ee()});var l=document.getElementById("student-sort-direction-btn");l&&l.addEventListener("click",function(){pe.direction=pe.direction==="asc"?"desc":"asc";var c=this.querySelector("span");c&&(c.textContent=pe.direction==="asc"?"south":"north"),Ee()}),document.querySelectorAll("th[data-sort]").forEach(function(c){c.addEventListener("click",function(){var u=this.dataset.sort;pe.column===u?pe.direction=pe.direction==="asc"?"desc":"asc":(pe.column=u,pe.direction="asc"),document.querySelectorAll("th[data-sort] .sort-icon").forEach(function(m){m.textContent="unfold_more"});var g=this.querySelector(".sort-icon");g&&(g.textContent=pe.direction==="asc"?"arrow_upward":"arrow_downward"),Ee()})}),ne?ne.addEventListener("change",Nt):console.warn("Missing change target: poll-select"),Si?Si.addEventListener("change",function(){hi=this.value,an()}):console.warn("Missing change target: poll-sort-select"),Cn?Cn.addEventListener("change",function(){St=this.value,an()}):console.warn("Missing change target: poll-filter-select"),Nn?Nn.addEventListener("change",function(){At=this.value,Ta()}):console.warn("Missing change target: archived-class-filter"),Hi?Hi.addEventListener("click",dl):console.warn("Missing click target: add-class-btn"),zi?zi.addEventListener("click",rl):console.warn("Missing click target: add-student-row-btn"),k("bulk-add-students-btn",ol),k("cancel-bulk-add-btn",Mr),k("confirm-bulk-add-btn",ll),Pn?Pn.addEventListener("click",sl):console.warn("Missing click target: save-roster-btn"),Rn?Rn.addEventListener("click",cl):console.warn("Missing click target: rename-class-btn"),Dn?Dn.addEventListener("click",ul):console.warn("Missing click target: delete-class-btn"),Vi?Vi.addEventListener("click",function(){Zi(!0)}):console.warn("Missing click target: refresh-archived-btn")}catch(c){console.error("[App] Binding Error:",c)}}function Re(e){console.log("[UI] setMainSection called via:",e);var n=document.querySelector("main");n&&(n.scrollTop=0);var t=document.getElementById("dashboard"),a=document.getElementById("live-view"),r=document.getElementById("roster-manager"),i=document.getElementById("archived-view"),s=document.getElementById("analytics-view"),d=document.getElementById("individual-timed-view"),o=document.getElementById("create-poll-view"),l=document.getElementById("dashboard-root"),c=document.getElementById("header-session-controls");et(e==="dashboard");function u(){var g=document.getElementById("header-default"),m=document.getElementById("header-live"),p=document.getElementById("live-control-bar"),b=document.getElementById("fab-container");e==="create-poll"?(l&&(l.style.display="none"),o&&(o.style.display="flex")):(l&&(l.style.display="flex"),o&&(o.style.display="none")),e==="live"?(console.log("[UI] Switching to live header"),g&&(g.style.display="none"),m&&(m.style.display="flex"),p&&p.classList.remove("hidden"),p&&(p.style.display="flex"),b&&(b.style.display="block")):(console.log("[UI] Switching to default header"),g&&(g.style.display="flex"),m&&(m.style.display="none"),p&&p.classList.add("hidden"),p&&(p.style.display="none"),b&&(b.style.display="none")),t&&(t.style.display=e==="dashboard"?"block":"none"),a&&(a.style.display=e==="live"?"grid":"none"),r&&(r.style.display=e==="roster"?"grid":"none"),i&&(i.style.display=e==="archived"?"grid":"none"),s&&(s.style.display=e==="analytics"?"flex":"none"),d&&(d.style.display=e==="individual-timed"?"block":"none");var h=document.querySelectorAll(".sidebar-nav-btn[data-section-target]");h.forEach(function(w){var q=w.getAttribute("data-section-target"),T=q===e;w.classList.toggle("is-active",T),w.setAttribute("aria-current",T?"page":"false"),T?w.classList.add("font-semibold"):w.classList.remove("font-semibold")}),c&&(e==="dashboard"?c.classList.remove("hidden"):c.classList.add("hidden")),e==="live"&&kr(wn||"question"),Ir()}document.startViewTransition?document.startViewTransition(u):u()}function Ir(){Li&&(Li.style.display="none"),Ci&&(Ci.style.display="none"),kr(wn||"question")}function kr(e){wn=e||"question";var n=document.querySelectorAll("[data-mobile-panel]"),t=window.innerWidth<=1024;n.forEach(function(r){var i=r.getAttribute("data-mobile-panel")===wn||!t;r.classList.toggle("is-active",i)});var a=document.querySelectorAll(".live-mobile-tab");a.forEach(function(r){var i=r.getAttribute("data-panel")===wn;r.classList.toggle("is-active",i),r.setAttribute("aria-selected",i?"true":"false")})}window.addEventListener("resize",function(){Ir()});function Un(){X&&(clearInterval(X),X=null),ve.stop(),Wt&&(clearInterval(Wt),Wt=null),Ut(),yt(),ue=he,ye=!1,Ft(),re("Timer idle.","info")}function He(){Un(),je=!1,f={},O=null,Ae=null,oe=0,ve.stop(),ga.style.display="flex",pa.style.display="none",Re("dashboard"),et(!0),setTimeout(function(){Fn()},100)}function Fn(){console.log("[Firebase] loadDashboardSummary: Skipped Firestore listener.")}function zo(){Un(),ga.style.display="flex",pa.style.display="none",Re("roster"),Object.keys(Z).length===0?rn():(Nr(),M?On():(wr.classList.remove("hidden"),Er.classList.add("hidden"),Rn.classList.add("hidden"),Dn.classList.add("hidden")))}function Vo(){Un(),ga.style.display="flex",pa.style.display="none",Re("archived"),In.length===0?Zi():(Ta(),Rr())}function ka(){O=null,Ae=null,oe=0,ve.stop(),console.log("[Firebase] loadInitialData: Fetching polls and classes from RTDB...");var e=firebase.auth().currentUser;if(!e||!e.email){console.warn("[Firebase] loadInitialData skipped: No authenticated teacher (User: "+(e?"Anonymous":"Null")+").");return}var n=firebase.database();Promise.all([n.ref("polls").once("value"),n.ref("rosters/classes").once("value")]).then(function(t){var a=t[0],r=t[1],i=a.val()||{},s=r.val()||[],d=Object.keys(i).map(function(o){var l=i[o];return l.id=o,l});d.sort(function(o,l){return(l.updatedAt||0)-(o.updatedAt||0)}),console.log("[Firebase] Loaded "+d.length+" polls and "+s.length+" classes."),Qo({polls:d,classes:s})}).catch(function(t){console.error("[Firebase] Failed to load initial data:",t),D("error","Data Load Error","Failed to load polls. Please refresh.")})}function Qo(e){e||(console.warn("onDashboardDataLoaded received null/undefined data"),e={polls:[],classes:[]}),ce.style.display="none";try{V=e.polls||[];try{Lr(e.classes||[])}catch(n){console.warn("refreshClassOptions error:",n)}try{an()}catch(n){console.error("refreshPollViews CRITICAL FAILURE:",n)}if(e.activePollId&&e.activePoll)try{f=e.activePoll,vt(e.activePoll),Re("live")}catch(n){console.error("Failed to auto-route to active poll",n),Kt&&(Kt.style.display="block")}else try{Re("dashboard")}catch(n){console.error("setMainSection failed:",n),Kt&&(Kt.style.display="block")}setTimeout(function(){try{So||Fn()}catch(n){console.warn("Summary load failed",n)}},100)}catch(n){console.error("Error loading dashboard:",n),F(n),Kt&&(Kt.style.display="block")}}function jo(e){e=e||Sr();var n=ne.value;ne.innerHTML='<option value="">-- Choose a poll --</option>';var t=!1;e.forEach(function(a){var r=document.createElement("option");r.value=a.pollId;var i=Array.isArray(a.questions)?a.questions.length:0,s=a.pollName+" ("+(a.className||"Unassigned")+") - "+i+" questions";if(wt(a.sessionType)){var d=Gi(a),o=Sa(a);s="ðŸ”’ "+s,d&&(s+=" â€¢ "+d+" min"),o&&(s+=" â€¢ Code "+o)}r.textContent=s,a.pollId===n&&(r.selected=!0,t=!0),ne.appendChild(r)}),t||(ne.value=""),Nt()}function Lr(e){jt=(e||[]).map(function(a){return(a||"").toString().trim()}).filter(function(a){return a!==""});var n=new Set;if(jt.forEach(function(a){n.add(a)}),Object.keys(Z).forEach(function(a){a&&n.add(a)}),V.forEach(function(a){a.className&&n.add(a.className)}),K=Array.from(n).sort(),window.ALL_CLASSES=K,mt){var t=mt.value;mt.innerHTML='<option value="">-- Select Class --</option>',K.forEach(function(a){var r=document.createElement("option");r.value=a,r.textContent=a,mt.appendChild(r)}),t&&K.indexOf(t)!==-1?mt.value=t:mt.value=""}Wo()}function Wo(){var e=St;Cn.innerHTML='<option value="all">All classes</option>',K.forEach(function(t){var a=document.createElement("option");a.value=t,a.textContent=t,Cn.appendChild(a)}),e&&K.indexOf(e)!==-1?St=e:St="all",Cn.value=St;var n=At;Nn.innerHTML='<option value="all">All classes</option>',K.forEach(function(t){var a=document.createElement("option");a.value=t,a.textContent=t,Nn.appendChild(a)}),n&&K.indexOf(n)!==-1?At=n:At="all",Nn.value=At}function Cr(){An&&(lt?An.classList.remove("hidden"):An.classList.add("hidden"))}function Go(e,n){if(!n)return!0;var t=(e&&e.pollName?e.pollName:"").toLowerCase();if(t.indexOf(n)!==-1)return!0;var a=(e&&e.className?e.className:"").toLowerCase();if(a.indexOf(n)!==-1)return!0;if(!e)return!1;if(Array.isArray(e.questions))for(var r=0;r<e.questions.length;r++){var i=e.questions[r]||{},s=(i.questionText||"").toLowerCase();if(s.indexOf(n)!==-1)return!0;var d=(i.topicTag||i.topic||"").toLowerCase();if(d.indexOf(n)!==-1)return!0;var o=(i.correctAnswer||"").toLowerCase();if(o&&o.indexOf(n)!==-1)return!0;for(var l=Array.isArray(i.options)?i.options:Array.isArray(i.answers)?i.answers:[],c=0;c<l.length;c++){var u=l[c]||{},g=(u.text||u.label||"").toLowerCase();if(g.indexOf(n)!==-1)return!0}}var m=[];e&&Array.isArray(e.liveSessions)&&m.push(e.liveSessions),e&&Array.isArray(e.recentSessions)&&m.push(e.recentSessions),e&&Array.isArray(e.sessions)&&m.push(e.sessions);for(var p=0;p<m.length;p++)for(var b=m[p],h=0;h<b.length;h++){var w=b[h]||{},q=w.sessionName||w.title||"",T=(typeof q=="string"?q:String(q||"")).toLowerCase();if(T.indexOf(n)!==-1)return!0;var x=w.notes||w.summary||"",C=(typeof x=="string"?x:String(x||"")).toLowerCase();if(C.indexOf(n)!==-1)return!0;for(var R=Array.isArray(w.questions)?w.questions:[],N=0;N<R.length;N++){var Q=R[N]||{},G=Q.questionText||Q.text||"",E=(typeof G=="string"?G:String(G||"")).toLowerCase();if(E.indexOf(n)!==-1)return!0;for(var A=Array.isArray(Q.options)?Q.options:[],B=0;B<A.length;B++){var Qe=A[B]||{},ot=Qe.text||Qe.label||"",kt=(typeof ot=="string"?ot:String(ot||"")).toLowerCase();if(kt.indexOf(n)!==-1)return!0}}}return!1}function Sr(){var e=V.slice();if(St!=="all"&&(e=e.filter(function(t){return t.className===St})),lt){var n=lt.toLowerCase();e=e.filter(function(t){return Go(t,n)})}return e.sort(function(t,a){switch(hi){case"updated_asc":return La(t)-La(a);case"name_asc":return(t.pollName||"").localeCompare(a.pollName||"");case"class_asc":var r=(t.className||"").localeCompare(a.className||"");return r!==0?r:(t.pollName||"").localeCompare(a.pollName||"");default:return La(a)-La(t)}}),e}function La(e){var n=e&&(e.updatedAt||e.lastRunAt||e.createdAt||""),t=n?Date.parse(n):NaN;return isNaN(t)?0:t}function an(){var e=Sr();if(rr){var n=[];K.forEach(function(i){n.push({label:i,type:"class",subLabel:"Class"})}),V.forEach(function(i){n.push({label:i.pollName,type:"poll",subLabel:i.className})}),rr.updateData(n)}try{Ko(e)}catch(i){console.error("Error rendering poll cards:",i),Me&&(Me.innerHTML='<div class="col-span-full text-center p-8 text-red-500 bg-red-50 rounded-lg border border-red-200">System Error: Unable to render polls. Please refresh or contact support.</div>')}try{Zo(e)}catch(i){console.error("Error rendering poll table:",i)}if(jo(e),$t)if(e.length===0){if($t.classList.remove("hidden"),lt)var t=y(lt);var a=$t.querySelector("h3"),r=$t.querySelector("p");lt?(a&&(a.textContent="No Polls Found"),r&&(r.textContent='Your search for "'+t+'" did not return any results. Try different keywords.')):(a&&(a.textContent="Welcome to Your Poll Library"),r&&(r.textContent="This is where your polls will live. Create your first interactive poll to engage your students and gather real-time feedback."))}else $t.classList.add("hidden")}function Ca(e,n){if(e){var t=null,a=firebase.database();a.ref("polls/"+e).once("value").then(function(r){var i=r.val();i?(i.pollId=e,na(i,t)):S("Failed to load poll data (Not found).",{title:"Error"})}).catch(function(r){F(r)})}}function Ko(e){if(Me&&(Me.innerHTML="",!(!e||e.length===0))){var n=0;e.forEach(function(t){try{if(!t)return;var a=document.createElement("article");a.className="poll-card",t&&t.pollId&&(a.dataset.pollId=t.pollId),a.setAttribute("tabindex","0"),a.setAttribute("role","group");var r=y(t&&t.pollName?t.pollName:"Untitled Poll");a.setAttribute("aria-label","Poll: "+r);var i=y(t&&t.className?t.className:"Unassigned"),s=Array.isArray(t&&t.questions)?t.questions.length:0,d=st(t.updatedAt||t.lastRunAt||t.createdAt),o=Xe(t.sessionType),l=[];l.push('<div class="mb-4">'),l.push('<h3 class="text-lg font-bold text-veritas-navy dark:text-white">'+r+"</h3>"),l.push("</div>"),l.push('<div class="flex flex-wrap gap-2 mb-4">');var c=Wi(o);if(l.push('<span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full '+c.badgeClass+'">'),l.push('<span class="material-symbols-outlined text-sm">'+c.icon+"</span>"),l.push(c.label),l.push("</span>"),l.push('<span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">'),l.push('<span class="material-symbols-outlined text-sm">quiz</span>'),l.push(s+" Questions"),l.push("</span>"),l.push("</div>"),o==="SECURE_ASSESSMENT"){var u=Ar(t),g=Sa(t),m=Ki(t);l.push('<div class="rounded-xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-900 dark:border-rose-500/40 dark:bg-rose-500/10 dark:text-rose-100 mb-4">'),u&&l.push('<div class="flex items-center gap-2 mb-2"><span class="material-symbols-outlined text-base">timer</span><span>'+y(u)+"</span></div>"),l.push('<div class="flex items-center gap-2 mb-2"><span class="material-symbols-outlined text-base">key</span><span>Access Code: '),g?l.push('<span class="font-semibold tracking-widest">'+y(g)+"</span>"):l.push('<span class="opacity-80">Not required</span>'),l.push("</span></div>"),m&&l.push('<div class="flex items-center gap-2"><span class="material-symbols-outlined text-base">calendar_month</span><span>'+y(m)+"</span></div>"),l.push("</div>")}l.push('<div class="text-xs text-gray-500 dark:text-gray-400 mb-4">Last updated: '+d+"</div>"),l.push('<div class="flex gap-2 mt-auto">'),l.push('<button type="button" class="flex-1 poll-card-btn primary poll-preview-btn" data-poll-id="'+(t&&t.pollId?t.pollId:"")+'" aria-label="Preview & Edit '+r+'"><span class="material-symbols-outlined text-base">visibility</span>Preview & Edit</button>'),l.push('<button type="button" class="poll-card-btn info poll-copy-btn" data-poll-id="'+(t&&t.pollId?t.pollId:"")+'" aria-label="Duplicate '+r+'"><span class="material-symbols-outlined text-base">content_copy</span></button>'),l.push('<button type="button" class="poll-card-btn danger poll-delete-btn" data-poll-id="'+(t&&t.pollId?t.pollId:"")+'" aria-label="Delete '+r+'"><span class="material-symbols-outlined text-base">delete</span></button>'),l.push("</div>"),a.innerHTML=l.join(""),a.addEventListener("click",function(p){if(!p.target.closest(".poll-card-btn")){var b=this.dataset.pollId;b&&(ne.value=b,Nt(),He())}}),a.addEventListener("keydown",function(p){if(!p.target.closest(".poll-card-btn")&&(p.key==="Enter"||p.key===" "||p.key==="Spacebar")){p.preventDefault();var b=this.dataset.pollId;if(!b)return;ne.value=b,Nt(),He()}}),Me.appendChild(a)}catch(p){console.error("Error rendering individual poll card:",p,t),n++}}),n>0&&Me.children.length===0&&(Me.innerHTML='<div class="col-span-full text-center p-8 text-red-500 bg-red-50 rounded-lg border border-red-200">Unable to load polls due to a data error. Please contact support.</div>'),Ji(Me)}}function Wi(e){var n=Xe(e);return n==="SECURE_ASSESSMENT"?{label:"Secure Assessment",icon:"lock",badgeClass:"bg-rose-100 text-rose-800 dark:bg-rose-900 dark:text-rose-200"}:{label:"Live Poll",icon:"groups",badgeClass:"bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200"}}function Gi(e){if(!e)return null;var n=e.timeLimitMinutes;if(typeof n=="number"&&n>0)return n;if(typeof n=="string"&&n.trim()!==""){var t=parseInt(n,10);if(!isNaN(t)&&t>0)return t}if(e.secureSettings){var a=e.secureSettings.timeLimitMinutes;if(typeof a=="number"&&a>0)return a;if(typeof a=="string"&&a.trim()!==""){var r=parseInt(a,10);if(!isNaN(r)&&r>0)return r}}return null}function Ar(e){var n=Gi(e);if(!n)return"";var t=n===1?"minute":"minutes";return"Time limit: "+n+" "+t}function Sa(e){return e?e.accessCode&&e.accessCode.toString().trim()!==""?e.accessCode.toString().trim().toUpperCase():e.secureSettings&&e.secureSettings.accessCode?e.secureSettings.accessCode.toString().trim().toUpperCase():"":""}function $o(e){if(!e)return{availableFrom:"",dueBy:""};var n=e.availableFrom||"",t=e.dueBy||"";return!n&&e.secureSettings&&(n=e.secureSettings.availableFrom||""),!t&&e.secureSettings&&(t=e.secureSettings.dueBy||""),{availableFrom:n||"",dueBy:t||""}}function Ki(e){var n=$o(e),t=n.availableFrom,a=n.dueBy;return t&&a?"Window: "+st(t)+" â†’ "+st(a):t?"Opens "+st(t):a?"Due "+st(a):""}function Yo(e){var n=Xe(e.sessionType),t=Wi(n),a='<div class="flex flex-col gap-1">';if(a+='<span class="inline-flex items-center gap-1.5 px-2 py-0.5 text-xs font-semibold rounded-full '+t.badgeClass+'">',a+='<span class="material-symbols-outlined text-sm">'+t.icon+"</span>"+t.label+"</span>",n==="SECURE_ASSESSMENT"){var r=Ar(e),i=Sa(e);r&&(a+='<span class="text-xs text-rose-700 dark:text-rose-200">'+y(r)+"</span>"),i?a+='<span class="text-xs text-rose-700 dark:text-rose-200">Code: <span class="font-semibold tracking-widest">'+y(i)+"</span></span>":a+='<span class="text-xs text-rose-700/80 dark:text-rose-200/80">No access code</span>'}return a+="</div>",a}var qt=null;function Tr(){qt&&(qt.remove(),qt=null,document.removeEventListener("click",$i))}function $i(e){qt&&qt.contains(e.target)||Tr()}function Xo(e,n){var t=qt;if(Tr(),!(t&&t.dataset.triggerId===n)){var a=e.getBoundingClientRect();window.pageYOffset||document.documentElement.scrollTop,window.pageXOffset||document.documentElement.scrollLeft;var r=document.createElement("div");r.className="fixed z-[9999] w-52 rounded-xl border border-white/5 bg-gray-800 p-1 text-sm text-white shadow-lg transition duration-100 ease-out origin-top-right",r.style.top=a.bottom+5+"px";var i=208,s=a.right-i;s<10&&(s=a.left),r.style.left=s+"px",r.dataset.triggerId=n;var d=[{label:"Edit",icon:"edit",action:"edit",kbd:"âŒ˜E"},{label:"Duplicate",icon:"content_copy",action:"duplicate",kbd:"âŒ˜D"},{label:"Preview",icon:"visibility",action:"preview",kbd:"âŒ˜P"},{type:"divider"},{label:"Delete",icon:"delete",action:"delete",kbd:"âŒ˜Del",danger:!0}];d.forEach(function(o){if(o.type==="divider"){var l=document.createElement("div");l.className="my-1 h-px bg-white/5",r.appendChild(l);return}var c=document.createElement("button");c.className="group flex w-full items-center gap-2 rounded-lg px-3 py-1.5 hover:bg-white/10 text-left transition-colors "+(o.danger?"text-red-400 hover:text-red-300":"text-white");var u=o.danger?"text-red-400 group-hover:text-red-300":"text-white/60 group-hover:text-white";c.innerHTML=`
        <span class="material-symbols-outlined text-base ${u}">${o.icon}</span>
        <span>${o.label}</span>
        ${o.kbd?`<kbd class="ml-auto hidden font-sans text-xs text-white/50 group-hover:inline">${o.kbd}</kbd>`:""}
      `,c.onclick=function(g){g.stopPropagation(),Jo(o.action,n),Tr()},r.appendChild(c)}),document.body.appendChild(r),qt=r,requestAnimationFrame(function(){document.addEventListener("click",$i)})}}function Jo(e,n){e==="edit"?Ca(n):e==="duplicate"?Yi(n):e==="preview"?vs(n):e==="delete"&&Xi(n)}function Zo(e){e=e||Sr(),ha.innerHTML="",e.length!==0&&(e.forEach(function(n){try{if(!n)return;var t=document.createElement("tr");t.className="hover:bg-brand-light-gray/40 dark:hover:bg-brand-dark-gray/40 transition-colors";var a=st(n.updatedAt||n.lastRunAt||n.createdAt),r=n.createdAt?st(n.createdAt):"â€”",i=[];i.push('<td class="px-4 py-3 align-top">'),i.push('<div class="font-semibold text-brand-dark-gray dark:text-brand-white"><span class="poll-name-link cursor-pointer hover:text-primary dark:hover:text-primary transition-colors" data-poll-id="'+n.pollId+'">'+y(n.pollName||"Untitled Poll")+"</span></div>"),i.push('<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/50">Created '+r+"</div>"),i.push("</td>"),i.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+y(n.className||"â€”")+"</td>"),i.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+(n.questions?n.questions.length:0)+"</td>"),i.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+Yo(n)+"</td>"),i.push('<td class="px-4 py-3 align-top text-brand-dark-gray/80 dark:text-brand-white/70">'+a+"</td>"),i.push('<td class="px-4 py-3 align-top text-right">'),i.push('<div class="flex justify-end items-center gap-2">'),i.push('<button class="poll-select-btn h-8 px-3 rounded-md bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-xs font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors" data-poll-id="'+n.pollId+'">Select</button>'),i.push('<div class="relative inline-block text-left">'),i.push('<button type="button" class="poll-options-btn inline-flex items-center gap-2 rounded-md bg-gray-800 px-3 py-1.5 text-xs font-semibold text-white shadow-inner shadow-white/10 hover:bg-gray-700 focus:outline-none transition-colors" data-poll-id="'+n.pollId+'" aria-expanded="false" aria-haspopup="true">'),i.push("Options"),i.push('<span class="material-symbols-outlined text-base text-white/60">keyboard_arrow_down</span>'),i.push("</button>"),i.push("</div>"),i.push("</div>"),i.push("</td>"),t.innerHTML=i.join(""),ha.appendChild(t)}catch(s){console.error("Error rendering poll table row:",s,n)}}),Ji(ha))}async function Yi(e){var n=V.find(function(s){return s.pollId===e});if(n){var t=await fr("Enter a name for the copied poll:",{defaultValue:n.pollName+" (Copy)",title:"Copy poll"});if(t!==null){if(t=t.trim(),t===""){await S("Poll name cannot be empty",{title:"Copy poll"});return}var a=deepClone(n);a.pollName=t,a.createdAt=Date.now(),a.updatedAt=a.createdAt;var r={pollName:a.pollName,className:a.className,questions:a.questions,sessionType:a.sessionType||"LIVE_POLL",timeLimitMinutes:a.timeLimitMinutes||null,accessCode:a.accessCode||"",availableFrom:a.availableFrom||"",dueBy:a.dueBy||"",secureSettings:a.secureSettings||{}},i=firebase.functions().httpsCallable("createPoll");i(r).then(function(s){if(s.data&&s.data.success)S("Poll copied successfully.",{title:"Success"});else throw new Error(s.data?s.data.message:"Failed to copy poll")}).catch(function(s){F(s)})}}}async function Xi(e){var n=await Ke("Delete this poll permanently? This will also remove all responses.",{title:"Delete poll",confirmText:"Delete",destructive:!0});if(n){var t=firebase.database(),a={};a["polls/"+e]=null,a["answers/"+e]=null,a["history/"+e]=null,a["sessions/"+e]=null,t.ref().update(a).then(function(){S("Poll deleted successfully.",{title:"Success"})}).catch(function(r){F(r)})}}function Ji(e){e&&(e.querySelectorAll(".poll-select-btn").forEach(function(n){n.onclick=function(t){t.stopPropagation();var a=this.dataset.pollId;a&&(ne.value=a,Nt(),He())}}),e.querySelectorAll(".poll-options-btn").forEach(function(n){n.onclick=function(t){t.stopPropagation();var a=this.dataset.pollId;a&&Xo(this,a)}}),e.querySelectorAll(".poll-name-link").forEach(function(n){n.onclick=function(t){t.preventDefault(),t.stopPropagation();var a=this.dataset.pollId;a&&Ca(a)}}),e.querySelectorAll(".poll-copy-btn").forEach(function(n){n.onclick=function(t){t.stopPropagation(),Yi(this.dataset.pollId)}}),e.querySelectorAll(".poll-edit-btn").forEach(function(n){n.onclick=function(t){t.stopPropagation(),Ca(this.dataset.pollId)}}),e.querySelectorAll(".poll-preview-btn").forEach(function(n){n.onclick=function(t){t.stopPropagation(),vs(this.dataset.pollId)}}),e.querySelectorAll(".poll-delete-btn").forEach(function(n){n.onclick=function(t){t.stopPropagation(),Xi(this.dataset.pollId)}}))}function el(e){V=e||[],Lr(jt),an()}function Nt(){console.log("[onPollSelectChange] Triggered."),_=document.getElementById("start-session-main-btn"),_e=document.getElementById("send-link-btn"),$=document.getElementById("view-links-btn"),ne=document.getElementById("poll-select"),ne&&console.log("[onPollSelectChange] Current value:",ne.value);var e=ne.value,n=e?V.find(function(r){return r.pollId===e}):null,t=n&&n.className?n.className:"",a=!!n;console.log("[onPollSelectChange] Poll:",e,"Found:",a,"Class:",t),Ee(),tl(n),nl(n),_e&&(a&&t?(_e.disabled=!1,_e.removeAttribute("aria-disabled"),_e.dataset.className=t):(Y(_e,!1),_e.disabled=!0,_e.setAttribute("aria-disabled","true"),delete _e.dataset.className)),$&&(a&&t?($.disabled=!1,$.removeAttribute("aria-disabled"),$.dataset.className=t):(Y($,!1),$.disabled=!0,$.setAttribute("aria-disabled","true"),delete $.dataset.className)),_&&(Y(_,!1),_.disabled=!a,_.disabled?_.setAttribute("aria-disabled","true"):_.removeAttribute("aria-disabled"))}function tl(e){if(_){var n=e?wt(e.sessionType):!1,t=n?"rocket_launch":"play_circle",a=n?"Launch Exam Room":"Start Session",r='<span class="material-symbols-outlined text-lg">'+t+"</span><span>"+a+"</span>";_.dataset.defaultHtml=r,_.dataset.sessionMode=n?"secure":"live",_.setAttribute("aria-label",a),_.classList.remove("bg-veritas-gold","hover:bg-veritas-gold/90","bg-rose-600","hover:bg-rose-700"),n?_.classList.add("bg-rose-600","hover:bg-rose-700"):_.classList.add("bg-veritas-gold","hover:bg-veritas-gold/90"),_.getAttribute("aria-busy")!=="true"&&(_.innerHTML=r)}}function nl(e){if(Yt){if(!e||!wt(e.sessionType)){Yt.classList.add("hidden"),Yt.setAttribute("aria-hidden","true");return}Yt.classList.remove("hidden"),Yt.setAttribute("aria-hidden","false");var n=[],t=Ar(e);t&&n.push('<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm opacity-80">timer</span><span>'+y(t)+"</span></span>");var a=Sa(e);a?n.push('<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm opacity-80">key</span><span>Code: <span class="font-semibold tracking-widest">'+y(a)+"</span></span></span>"):n.push('<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm opacity-80">key</span><span class="opacity-70">No access code</span></span>');var r=e.calculatorEnabled===!0||e.secureSettings&&e.secureSettings.calculatorEnabled===!0;n.push('<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm opacity-80">calculate</span><span>'+(r?"Calculator enabled":"Calculator off")+"</span></span>");var i=Ki(e);i&&n.push('<span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm opacity-80">calendar_month</span><span>'+y(i)+"</span></span>"),Yt.innerHTML=n.join('<span class="opacity-50">|</span>')}}function Br(e){var n=oa;if(!n)try{n=oa=firebase.functions()}catch(t){console.error("[Firebase] Functions SDK not initialized:",t)}return n?Promise.resolve({callable:n.httpsCallable(e)}):Promise.reject(new Error("Backend is unavailable. Please refresh and sign in again."))}function tt(e){return Br("manageRoster").then(function(n){return n.callable(e||{})})}function rn(){if(le.textContent="Loading roster...",!firebase.auth().currentUser||!window.AUTH_READY){le.textContent="",firebase.auth().currentUser?(console.log("[Firebase] Auth token not ready, retrying loadRosterData in 500ms..."),setTimeout(rn,500)):(S("You must be authenticated to load rosters.",{title:"Authentication required",destructive:!0}),window.LoginManager&&window.LoginManager.show());return}tt({action:"GET_DATA"}).then(function(e){var n=e.data;if(le.textContent="",n&&n.success)console.log("[Firebase] Rosters loaded via Cloud Function"),qr(n,M);else throw new Error("Could not load roster data")}).catch(function(e){le.textContent="",console.error("[Firebase] Roster fetch error:",e),F(e)})}function qr(e,n){Z=e&&e.rosters?e.rosters:{},Lr(e&&e.classes||jt),n&&(M=n),M&&!Z[M]&&(M=""),Nr(),M?On():(_i.textContent="Select a class",wr.classList.remove("hidden"),Er.classList.add("hidden"),Rn.classList.add("hidden"),Dn.classList.add("hidden"),le.textContent="")}function Nr(){if(xr.innerHTML="",K.length===0){xr.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No classes yet. Click the + button to add one.</p>';return}K.forEach(function(e){var n=document.createElement("button");n.type="button";var t=e===M;n.className="w-full text-left px-3 py-2 rounded-lg transition-colors "+(t?"bg-primary text-brand-white shadow-sm":"bg-brand-light-gray/40 dark:bg-brand-dark-gray/30 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/60 dark:hover:bg-brand-dark-gray/50"),n.textContent=e,n.onclick=function(){al(e)},xr.appendChild(n)})}function al(e){M=e,le.textContent="",Nr(),On()}function On(){if(M){var e=Z[M]||[];Z[M]=e,e.length===0&&e.push({name:"",email:""}),_i.textContent=M,wr.classList.add("hidden"),Er.classList.remove("hidden"),Rn.classList.remove("hidden"),Dn.classList.remove("hidden"),Mn.innerHTML="",e.forEach(function(n,t){var a=document.createElement("tr");a.innerHTML='<td class="px-4 py-2 align-top"><input type="text" class="roster-name-input w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" data-index="'+t+'" placeholder="Student Name" value="'+y(n.name||"")+'" /></td><td class="px-4 py-2 align-top"><input type="email" class="roster-email-input w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" data-index="'+t+'" placeholder="email@example.com" value="'+y(n.email||"")+'" /></td><td class="px-4 py-2 align-top text-center"><button class="remove-roster-row-btn h-8 w-8 rounded-full bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors" data-index="'+t+'" title="Remove"><span class="material-symbols-outlined text-base">close</span></button></td>',Mn.appendChild(a)}),Mn.querySelectorAll(".roster-name-input").forEach(function(n){n.oninput=function(){var t=parseInt(this.dataset.index,10);Z[M][t].name=this.value,Aa()}}),Mn.querySelectorAll(".roster-email-input").forEach(function(n){n.oninput=function(){var t=parseInt(this.dataset.index,10);Z[M][t].email=this.value,Aa()}}),Mn.querySelectorAll(".remove-roster-row-btn").forEach(function(n){n.onclick=function(){var t=parseInt(this.dataset.index,10);il(t)}})}}function Aa(){le.textContent="Unsaved changes"}async function rl(){if(!M){await S("Select a class first.",{title:"Roster"});return}Z[M]||(Z[M]=[]),Z[M].push({name:"",email:""}),Aa(),On()}function il(e){if(M){var n=Z[M]||[];n.length>e&&(n.splice(e,1),Aa(),n.length===0&&n.push({name:"",email:""}),On())}}async function sl(){if(!M){await S("Select a class to save.",{title:"Roster"});return}var e=(Z[M]||[]).map(function(n){return{name:(n.name||"").trim(),email:(n.email||"").trim()}}).filter(function(n){return n.name!==""&&n.email!==""});Pn.disabled=!0,le.textContent="Saving roster...",tt({action:"SAVE",className:M,students:e}).then(function(n){Pn.disabled=!1,le.textContent="Roster saved.",Z||(Z={}),Z[M]=e,qr({rosters:Z,classes:K.includes(M)?K:K.concat([M])},M)}).catch(function(n){Pn.disabled=!1,F(n)})}async function ol(){if(!M){await S("Select a class first.",{title:"Roster"});return}document.getElementById("bulk-student-input").value="",document.getElementById("bulk-add-students-modal").style.display="flex"}function Mr(){document.getElementById("bulk-add-students-modal").style.display="none"}async function ll(){if(!M){await S("Select a class first.",{title:"Roster"}),Mr();return}var e=document.getElementById("bulk-student-input").value,n=e.split(`
`),t=[];if(n.forEach(function(r){if(r=r.trim(),r!==""){var i=r.split(",");if(i.length>=2){var s=i[0].trim(),d=i.slice(1).join(",").trim();s&&d&&t.push({name:s,email:d})}}}),t.length===0){await S("No valid student entries found. Use format: Name, Email",{title:"Bulk add students"});return}var a=document.getElementById("confirm-bulk-add-btn");a.disabled=!0,a.textContent="Adding...",tt({action:"BULK_ADD",className:M,students:t}).then(function(){a.disabled=!1,a.textContent="Add Students",Mr(),rn(),D("success","Students added","Successfully added "+t.length+" students.")}).catch(function(r){a.disabled=!1,a.textContent="Add Students",F(r)})}async function dl(){var e=await fr("Class name",{title:"Add class",confirmText:"Create"});if(e&&(e=e.trim(),e!=="")){le.textContent="Creating class...";var n=firebase.database(),t=n.ref("rosters");t.once("value").then(function(a){var r=a.val()||{classes:[],rosters:{}};return r.classes||(r.classes=[]),r.rosters||(r.rosters={}),r.classes.includes(e)||r.classes.push(e),r.rosters[e]=r.rosters[e]||[],t.set(r)}).then(function(){le.textContent="Class created.",M=e,rn()}).catch(function(a){le.textContent="",F(a)})}}async function cl(){if(!M){await S("Select a class first.",{title:"Roster"});return}var e=await fr("Rename class",{title:"Rename class",defaultValue:M,confirmText:"Rename"});e&&(e=e.trim(),e!==""&&e!==M&&(le.textContent="Renaming class...",tt({action:"RENAME",className:M,newClassName:e}).then(function(n){if(n.data&&n.data.success)le.textContent="Class renamed.",n.data.pollsUpdated>0&&(le.textContent+=" ("+n.data.pollsUpdated+" poll"+(n.data.pollsUpdated===1?"":"s")+" updated)"),M=e,rn();else throw new Error(n.data?.error||"Failed to rename class")}).catch(function(n){le.textContent="",typeof Ht=="function"?Ht(n):F(n)})))}async function ul(){if(!M){await S("Select a class first.",{title:"Roster"});return}var e=await Ke('Delete class "'+M+'" and remove all students?',{title:"Delete class",confirmText:"Delete",destructive:!0});if(e){le.textContent="Deleting class...";var n=M;tt({action:"DELETE",className:n}).then(function(t){if(t.data&&t.data.success)le.textContent="Class deleted.",M="",rn();else throw new Error(t.data?.error||"Failed to delete class")}).catch(function(t){le.textContent="",typeof Ht=="function"?Ht(t):F(t)})}}function Zi(e){if(In.length>0&&!e){Ta(),Rr();return}xa.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">Loading archived polls...</p>',wa.classList.remove("hidden"),Ea.classList.add("hidden"),console.warn("[Firebase] loadArchivedPolls: Legacy RTDB history disabled."),archivedStatus.textContent="Archived polls are temporarily unavailable."}function Ta(){xa.innerHTML="";var e=At==="all"?In:In.filter(function(n){return n.className===At});if(e.length===0){xa.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No archived polls for this filter.</p>',wa.classList.remove("hidden"),Ea.classList.add("hidden");return}e.forEach(function(n){var t=document.createElement("button");t.type="button";var a=n.pollId===kn;t.className="w-full text-left px-3 py-2 rounded-lg transition-colors "+(a?"bg-primary text-brand-white shadow-sm":"bg-brand-light-gray/40 dark:bg-brand-dark-gray/30 text-brand-dark-gray dark:text-brand-white hover:bg-brand-light-gray/60 dark:hover:bg-brand-dark-gray/50");var r=(n.className||"Unassigned")+" â€¢ "+st(n.lastRunAt||n.updatedAt||n.createdAt);t.innerHTML='<div class="font-semibold">'+y(n.pollName||"Untitled Poll")+'</div><div class="text-xs opacity-80">'+y(r)+"</div>",t.onclick=function(){kn=n.pollId,Ta(),Rr()},xa.appendChild(t)})}function Rr(){var e=In.find(function(n){return n.pollId===kn});if(!e){wa.classList.remove("hidden"),Ea.classList.add("hidden");return}wa.classList.add("hidden"),Ea.classList.remove("hidden"),Fo.textContent=e.pollName||"Untitled Poll",Oo.textContent=(e.className||"Unassigned")+" â€¢ Last run "+st(e.lastRunAt||e.updatedAt||e.createdAt),_o.textContent=e.questionCount||0,Ho.textContent=(e.totalResponses||0)+" of "+(e.totalStudents||0),Oi.innerHTML="",e.questions.forEach(function(n,t){var a=document.createElement("div");a.className="border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-4 bg-brand-white dark:bg-brand-dark-gray/40";var r=n.summary||{correct:0,incorrect:0,noResponse:0,violations:0},i=Array.isArray(n.responses)?n.responses:[],s=Array.isArray(n.nonResponders)?n.nonResponders:[];r.correct=r.correct||0,r.incorrect=r.incorrect||0,r.noResponse=r.noResponse||0,r.violations=r.violations||0;var d="";i.length===0?d='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No responses recorded.</p>':(d='<table class="min-w-full text-sm divide-y divide-brand-light-gray dark:divide-brand-dark-gray/40"><thead class="text-xs uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/50"><tr><th class="py-2 text-left">Student</th><th class="py-2 text-left">Answer</th><th class="py-2 text-left">Status</th></tr></thead><tbody class="divide-y divide-brand-light-gray/70 dark:divide-brand-dark-gray/40">',i.forEach(function(g){var m=g.violation?"Violation":g.isCorrect?"Correct":"Incorrect",p=g.violation?"text-orange-600 dark:text-orange-300":g.isCorrect?"text-green-600 dark:text-green-300":"text-red-600 dark:text-red-300";d+='<tr><td class="py-2 pr-3">'+y(g.name||g.email)+'</td><td class="py-2 pr-3">'+y(g.answer||"â€”")+'</td><td class="py-2 pr-3 '+p+'">'+m+"</td></tr>"}),d+="</tbody></table>");var o="";s.length>0&&(o='<div class="mt-3"><h4 class="text-xs font-semibold uppercase text-brand-dark-gray/60 dark:text-brand-white/60">No Response</h4><div class="flex flex-wrap gap-2 mt-1">',s.forEach(function(g){var m=g.violation?"bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-200":"bg-brand-light-gray text-brand-dark-gray dark:bg-brand-dark-gray/50 dark:text-brand-white/80",p=g.name?Ve(g):g.email;o+='<span class="px-2 py-1 rounded-full text-xs '+m+'">'+y(p)+"</span>"}),o+="</div></div>");var l=n.questionImageURL?'<div class="mt-3"><img src="'+y(n.questionImageURL)+'" class="max-h-48 rounded-lg object-contain" alt="Question image" /></div>':"",c='<div><h3 class="font-serif text-lg text-brand-dark-gray dark:text-brand-white">Question '+(t+1)+'</h3><p class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 mt-1">'+y(n.questionText||"")+"</p></div>",u='<div class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 text-right"><p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Correct:</span> '+r.correct+'</p><p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Incorrect:</span> '+r.incorrect+'</p><p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">No Response:</span> '+r.noResponse+'</p><p><span class="font-semibold text-brand-dark-gray dark:text-brand-white">Violations:</span> '+r.violations+"</p></div>";a.innerHTML='<div class="flex flex-wrap items-start justify-between gap-3">'+c+u+"</div>"+l+'<div class="mt-4">'+d+"</div>"+o,Oi.appendChild(a)})}function fl(e){var n=document.getElementById("post-poll-analytics-modal"),t=document.getElementById("analytics-loading"),a=document.getElementById("analytics-report");n.style.display="flex",t.classList.remove("hidden"),a.classList.add("hidden"),firebase.functions().httpsCallable("getAnalytics")({pollId:e}).then(function(i){var s=i.data;s.success?ml(s):t.innerHTML='<div class="text-center py-12"><p class="text-red-600">Error: '+y(s.error||"Failed to load analytics")+"</p></div>"}).catch(function(i){t.innerHTML='<div class="text-center py-12"><p class="text-red-600">Error: '+y(i.message||"Unknown error")+"</p></div>"})}function ml(e){var n=document.getElementById("analytics-loading"),t=document.getElementById("analytics-report");document.getElementById("analytics-poll-name").textContent=e.pollName||"Poll Analysis",document.getElementById("analytics-poll-meta").textContent=e.className+" â€¢ "+e.questionCount+" Questions",e.teacherActionItems&&gl(e.teacherActionItems),pl(e.classOverview,e.distribution),e.metacognition&&e.metacognition.enabled?(vl(e.metacognition),document.getElementById("metacognition-section").classList.remove("hidden")):document.getElementById("metacognition-section").classList.add("hidden"),bl(e.itemAnalysis),n.classList.add("hidden"),t.classList.remove("hidden")}function gl(e){var n=document.getElementById("analytics-actions-container");if(n){if(!e||e.length===0){n.innerHTML="";return}var t='<h4 class="text-lg font-bold text-brand-dark-gray dark:text-white mb-3 flex items-center gap-2"><span class="material-symbols-outlined text-amber-500">lightbulb</span> Insights & Recommendations</h4><div class="grid grid-cols-1 gap-3">';e.forEach(function(a){var r=a.priority==="urgent"?"border-red-200 bg-red-50 text-red-900":"border-amber-200 bg-amber-50 text-amber-900",i=a.priority==="urgent"?"warning":"info";t+='<div class="flex items-start gap-3 p-4 rounded-lg border '+r+'"><span class="material-symbols-outlined mt-0.5">'+i+'</span><div><p class="font-semibold">'+y(a.message)+"</p>",a.items&&a.items.length>0&&(t+='<ul class="mt-2 text-sm list-disc list-inside opacity-90">',a.items.forEach(function(s){t+="<li>Q"+(s.index+1)+": "+y(s.text)+"</li>"}),t+="</ul>"),t+="</div></div>"}),t+="</div>",n.innerHTML=t}}function pl(e,n){var t=document.getElementById("class-overview-content"),a=e.interpretation||{},r='<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">';if(r+='<div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700/30 rounded-lg p-4">',r+='<div class="text-sm text-blue-700 dark:text-blue-300 font-semibold mb-1">Mean Score</div>',r+='<div class="text-3xl font-bold text-blue-900 dark:text-blue-100">'+e.mean+"</div>",a.meanScore&&(r+='<div class="mt-2 text-xs font-medium text-blue-800 dark:text-blue-200">'+y(a.meanScore.message)+"</div>"),r+="</div>",r+='<div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700/30 rounded-lg p-4">',r+='<div class="text-sm text-green-700 dark:text-green-300 font-semibold mb-1">Median Score</div>',r+='<div class="text-3xl font-bold text-green-900 dark:text-green-100">'+e.median+"</div>",r+="</div>",r+='<div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-700/30 rounded-lg p-4">',r+='<div class="text-sm text-purple-700 dark:text-purple-300 font-semibold mb-1">Std. Deviation</div>',r+='<div class="text-3xl font-bold text-purple-900 dark:text-purple-100">'+e.stdDev+"</div>",a.stdDev&&(r+='<div class="mt-2 text-xs font-medium text-purple-800 dark:text-purple-200">'+y(a.stdDev.message)+"</div>"),r+="</div>",r+='<div class="bg-gray-50 dark:bg-gray-900/20 border border-gray-200 dark:border-gray-700/30 rounded-lg p-4">',r+='<div class="text-sm text-gray-700 dark:text-gray-300 font-semibold mb-1">Participants</div>',r+='<div class="text-3xl font-bold text-gray-900 dark:text-gray-100">'+e.participantCount+"</div>",a.participation&&(r+='<div class="mt-2 text-xs font-medium text-gray-800 dark:text-gray-200">'+y(a.participation.message)+"</div>"),r+="</div>",r+="</div>",n&&n.histogram&&n.histogram.length>0){r+='<div class="bg-white dark:bg-brand-dark-gray/40 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-4">',r+='<h4 class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white mb-3">Score Distribution</h4>',r+='<div class="flex items-end gap-2 h-48">';var i=Math.max.apply(null,n.histogram.map(function(s){return s.count}));n.histogram.forEach(function(s){var d=i>0?s.count/i*100:0;r+='<div class="flex-1 flex flex-col items-center gap-1">',r+='<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">'+s.count+"</div>",r+='<div class="w-full bg-primary rounded-t" style="height: '+d+'%;"></div>',r+='<div class="text-xs font-semibold text-brand-dark-gray dark:text-brand-white">'+s.score+"</div>",r+="</div>"}),r+="</div>",r+="</div>"}t.innerHTML=r}function vl(e){var n=document.getElementById("metacognition-content");if(!e.overall){n.innerHTML='<p class="text-brand-dark-gray/60 dark:text-brand-white/60">No metacognition data available yet.</p>';return}var t='<div class="bg-white dark:bg-brand-dark-gray/40 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-6 mb-4">';t+='<h4 class="text-lg font-semibold text-brand-dark-gray dark:text-brand-white mb-4">Confidence vs. Correctness Matrix</h4>',t+='<div class="grid grid-cols-1 md:grid-cols-2 gap-4">',t+='<div class="bg-green-50 dark:bg-green-900/20 border-2 border-green-500 rounded-lg p-4">',t+='<div class="flex items-center gap-2 mb-2">',t+='<span class="text-2xl">ðŸ’¯</span>',t+='<div class="text-sm font-semibold text-green-700 dark:text-green-300">Conscious Competence</div>',t+="</div>",t+='<div class="text-3xl font-bold text-green-900 dark:text-green-100">'+e.overall.confidentCorrect+"%</div>",t+='<div class="text-xs text-green-700 dark:text-green-300 mt-1">Confident & Correct (Mastery!)</div>',t+="</div>",t+='<div class="bg-red-50 dark:bg-red-900/20 border-2 border-red-500 rounded-lg p-4">',t+='<div class="flex items-center gap-2 mb-2">',t+='<span class="text-2xl">âš ï¸</span>',t+='<div class="text-sm font-semibold text-red-700 dark:text-red-300">Confidently Incorrect</div>',t+="</div>",t+='<div class="text-3xl font-bold text-red-900 dark:text-red-100">'+e.overall.confidentIncorrect+"%</div>",t+='<div class="text-xs text-red-700 dark:text-red-300 mt-1">RED ALERT: Deep misconception!</div>',t+="</div>",t+='<div class="bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-500 rounded-lg p-4">',t+='<div class="flex items-center gap-2 mb-2">',t+='<span class="text-2xl">ðŸ¤”</span>',t+='<div class="text-sm font-semibold text-yellow-700 dark:text-yellow-300">Imposter Syndrome</div>',t+="</div>",t+='<div class="text-3xl font-bold text-yellow-900 dark:text-yellow-100">'+e.overall.uncertainCorrect+"%</div>",t+='<div class="text-xs text-yellow-700 dark:text-yellow-300 mt-1">Uncertain but Correct (Lucky?)</div>',t+="</div>",t+='<div class="bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-500 rounded-lg p-4">',t+='<div class="flex items-center gap-2 mb-2">',t+='<span class="text-2xl">ðŸ¤·</span>',t+='<div class="text-sm font-semibold text-blue-700 dark:text-blue-300">Conscious Incompetence</div>',t+="</div>",t+='<div class="text-3xl font-bold text-blue-900 dark:text-blue-100">'+e.overall.uncertainIncorrect+"%</div>",t+=`<div class="text-xs text-blue-700 dark:text-blue-300 mt-1">Know they don't know (Good!)</div>`,t+="</div>",t+="</div>",t+="</div>",n.innerHTML=t}function bl(e){var n=document.getElementById("item-analysis-content"),t="";e.forEach(function(a,r){var i=a.difficultyPct>90?"green":a.difficultyPct<30?"red":"blue",s=a.discrimination>.3?"green":a.discrimination<0?"red":"yellow",d=a.interpretation||{};if(t+='<div class="bg-white dark:bg-brand-dark-gray/40 border border-brand-light-gray dark:border-brand-dark-gray/40 rounded-lg p-5 mb-4">',t+='<div class="flex items-start justify-between gap-4 mb-4">',t+='<div class="flex-1">',t+='<div class="flex items-center gap-2">',t+='<h4 class="font-semibold text-brand-dark-gray dark:text-brand-white">Question '+(r+1)+"</h4>",d.overall){var o=d.overall.quality==="excellent"?"bg-green-100 text-green-800":d.overall.quality==="flawed"?"bg-red-100 text-red-800":d.overall.quality==="needs-adjustment"?"bg-orange-100 text-orange-800":"bg-gray-100 text-gray-800";t+='<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase '+o+'">'+y(d.overall.quality)+"</span>"}t+="</div>",t+='<p class="text-sm text-brand-dark-gray/70 dark:text-brand-white/70 mt-1">'+y(a.questionText)+"</p>",t+="</div>",t+='<div class="flex gap-3">',t+='<div class="text-center">',t+='<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mb-1">Difficulty</div>',t+='<div class="text-2xl font-bold text-'+i+"-600 dark:text-"+i+'-400">'+a.difficultyPct+"%</div>",d.difficulty&&(t+='<div class="text-[10px] text-gray-500">'+y(d.difficulty.level)+"</div>"),t+="</div>",t+='<div class="text-center">',t+='<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mb-1">Discrimination</div>',t+='<div class="text-2xl font-bold text-'+s+"-600 dark:text-"+s+'-400">'+a.discrimination+"</div>",d.discrimination&&(t+='<div class="text-[10px] text-gray-500">'+y(d.discrimination.level)+"</div>"),t+="</div>",t+="</div>",t+="</div>",a.flags&&a.flags.length>0&&(t+='<div class="flex flex-wrap gap-2 mb-3">',a.flags.forEach(function(l){var c=l==="negative-discrimination"?"bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300":l==="too-hard"?"bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-300":"bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-300";t+='<span class="px-2 py-1 rounded-full text-xs font-semibold '+c+'">'+l.replace(/-/g," ")+"</span>"}),t+="</div>"),d.actionable&&d.actionable.length>0&&(t+='<div class="mt-3 p-3 bg-amber-50 dark:bg-amber-900/10 border border-amber-100 dark:border-amber-800/30 rounded text-sm text-amber-800 dark:text-amber-200">',t+='<p class="font-semibold text-xs uppercase tracking-wide mb-1">Recommendation:</p>',t+='<ul class="list-disc list-inside space-y-1">',d.actionable.forEach(function(l){t+="<li>"+y(l)+"</li>"}),t+="</ul></div>"),a.distractorAnalysis&&a.distractorAnalysis.length>0&&(t+='<div class="bg-gray-50 dark:bg-brand-dark-gray/20 rounded-lg p-3">',t+='<h5 class="text-xs font-semibold uppercase text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">Distractor Analysis</h5>',t+='<div class="space-y-2">',a.distractorAnalysis.forEach(function(l){var c=l.quality==="excellent"||l.quality==="good"?"green":l.quality==="problematic"?"red":"gray";t+='<div class="flex items-center justify-between text-sm">',t+='<div class="flex items-center gap-2">',t+='<span class="font-semibold text-brand-dark-gray dark:text-brand-white">'+l.optionLetter+"</span>",t+='<span class="text-brand-dark-gray/70 dark:text-brand-white/70">'+y(l.option.substring(0,50))+(l.option.length>50?"...":"")+"</span>",l.isCorrect&&(t+='<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300">Correct</span>'),t+="</div>",t+='<div class="flex items-center gap-3">',t+='<span class="text-brand-dark-gray/60 dark:text-brand-white/60">'+l.totalPct+"%</span>",t+='<span class="text-xs text-'+c+"-600 dark:text-"+c+'-400">'+l.quality+"</span>",t+="</div>",t+="</div>"}),t+="</div>",t+="</div>"),t+="</div>"}),n.innerHTML=t}var W=null,Ba="overview",Le={className:"all"},nt={field:"qNum",direction:"asc"};function hl(){Un(),ga.style.display="flex",pa.style.display="none",Re("analytics");var e=document.getElementById("analytics-class-filter");e.innerHTML='<option value="all">All Classes</option>';var n=Array.from(new Set(V.map(function(t){return t.className})));n.forEach(function(t){var a=document.createElement("option");a.value=t,a.textContent=t,e.appendChild(a)}),W?_n():sn(),Wt&&clearInterval(Wt),Wt=setInterval(function(){W=null,sn(Le)},3e4)}function sn(e){Le=e||Le,document.getElementById("analytics-overview-loading").classList.remove("hidden"),document.getElementById("analytics-overview-content").classList.add("hidden"),document.getElementById("analytics-items-loading").classList.remove("hidden"),document.getElementById("analytics-items-content").classList.add("hidden"),document.getElementById("analytics-students-loading").classList.remove("hidden"),document.getElementById("analytics-students-content").classList.add("hidden"),firebase.functions().httpsCallable("getAnalytics")(Le).then(function(t){W=t.data,document.getElementById("analytics-overview-loading").classList.add("hidden"),document.getElementById("analytics-items-loading").classList.add("hidden"),document.getElementById("analytics-students-loading").classList.add("hidden"),_n()}).catch(function(t){console.error("Analytics loading error:",t),document.getElementById("analytics-overview-loading").innerHTML='<p class="text-red-600">Error loading analytics: '+y(t.message||"Unknown error")+"</p>",document.getElementById("analytics-items-loading").innerHTML='<p class="text-red-600">Error loading analytics: '+y(t.message||"Unknown error")+"</p>",document.getElementById("analytics-students-loading").innerHTML='<p class="text-red-600">Error loading analytics: '+y(t.message||"Unknown error")+"</p>"})}function _n(){Ba==="overview"?yl():Ba==="items"?es():Ba==="students"&&Cl()}function yl(){if(document.getElementById("analytics-overview-loading").classList.add("hidden"),document.getElementById("analytics-overview-content").classList.remove("hidden"),!!W){var e=document.getElementById("analytics-kpi-container");e.innerHTML="",(W.kpis||[]).forEach(function(o){var l=document.createElement("div");l.className="bg-brand-white dark:bg-brand-dark-gray/40 rounded-xl p-5 border border-brand-light-gray dark:border-brand-dark-gray/40 shadow-sm hover:shadow-md transition-shadow cursor-pointer",l.title=o.tooltip;var c="";if(o.delta!==void 0&&o.delta!==null){var u=o.delta>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400",g=o.delta>=0?"â–²":"â–¼";c='<div class="text-xs font-semibold '+u+' mt-1">'+g+" "+Math.abs(o.delta)+"</div>"}l.innerHTML='<div class="text-xs font-semibold uppercase tracking-wide text-brand-dark-gray/60 dark:text-brand-white/60 mb-2">'+y(o.label)+'</div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">'+y(o.value)+"</div>"+c,e.appendChild(l)});var n=document.getElementById("analytics-topic-heat");if(n){if(W.topics&&W.topics.length>0){var t='<div class="space-y-2">';W.topics.forEach(function(o){var l=o.masteryPct>=70?"bg-green-500":o.masteryPct>=50?"bg-yellow-500":"bg-red-500";t+='<div class="flex items-center gap-3">',t+='<div class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white min-w-[120px]">'+y(o.topic)+"</div>",t+='<div class="flex-1 bg-brand-light-gray dark:bg-brand-dark-gray/30 rounded-full h-6 overflow-hidden">',t+='<div class="'+l+' h-full flex items-center justify-end px-2 text-xs text-white font-semibold" style="width: '+o.masteryPct+'%">',o.masteryPct>15&&(t+=o.masteryPct+"%"),t+="</div></div>",t+='<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 min-w-[60px] text-right">'+o.questionCount+" items</div>",t+="</div>"}),t+="</div>",n.innerHTML=t}else n.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No topic data available. Add topic tags to your questions.</p>';var a=document.getElementById("analytics-item-scatter");if(a)if(!W.items||W.items.length===0)a.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No item data available</p>';else if(or&&window.google&&google.visualization&&typeof google.visualization.ScatterChart=="function"){var r=[["Difficulty (% Correct)","Discrimination","Question"]];W.items.forEach(function(o){r.push([o.correctPct,o.rbis,"Q"+o.qNum])});var i=google.visualization.arrayToDataTable(r),s={title:"Item Difficulty vs Discrimination",hAxis:{title:"Difficulty (% Correct)",minValue:0,maxValue:100},vAxis:{title:"Discrimination (r_bis)",minValue:-.5,maxValue:1},legend:"none",pointSize:5,backgroundColor:"transparent",chartArea:{width:"85%",height:"75%"}},d=new google.visualization.ScatterChart(a);d.draw(i,s)}else a.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">Preparing analytics visualsâ€¦</p>'}}}function es(){if(document.getElementById("analytics-items-loading").classList.add("hidden"),document.getElementById("analytics-items-content").classList.remove("hidden"),!(!W||!W.items)){var e=W.items.slice();e.sort(function(t,a){var r=t[nt.field],i=a[nt.field];if(typeof r=="number"&&typeof i=="number")return nt.direction==="asc"?r-i:i-r;var s=String(r||""),d=String(i||"");return nt.direction==="asc"?s.localeCompare(d):d.localeCompare(s)});var n=document.getElementById("analytics-items-tbody");n.innerHTML="",e.forEach(function(t){var a=document.createElement("tr");a.className="hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30 cursor-pointer";var r=document.createElement("td");r.className="py-3 px-4 font-semibold",r.textContent=t.qNum,a.appendChild(r);var i=document.createElement("td");i.className="py-3 px-4 text-xs",i.textContent=t.topic||"Untagged",a.appendChild(i);var s=document.createElement("td");s.className="py-3 px-4 font-semibold";var d=t.correctPct>=70?"text-green-600 dark:text-green-400":t.correctPct>=50?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400";s.innerHTML='<span class="'+d+'">'+t.correctPct+"%</span>",a.appendChild(s);var o=document.createElement("td");o.className="py-3 px-4 font-semibold";var l=t.rbis>=.3?"text-green-600 dark:text-green-400":t.rbis>=.15?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400";o.innerHTML='<span class="'+l+'">'+t.rbis.toFixed(2)+"</span>",a.appendChild(o);var c=document.createElement("td");c.className="py-3 px-4",c.innerHTML=xl(t),a.appendChild(c);var u=document.createElement("td");u.className="py-3 px-4",u.textContent=t.medianTimeSec+"s",a.appendChild(u);var g=document.createElement("td");if(g.className="py-3 px-4",t.flags&&t.flags.length>0){var m="";t.flags.forEach(function(p){var b="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300";p==="low-disc"&&(b="bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300"),m+='<span class="inline-block px-2 py-0.5 rounded text-xs font-semibold '+b+' mr-1">'+y(p)+"</span>"}),g.innerHTML=m}a.appendChild(g),n.appendChild(a)})}}function xl(e){var n=e.total||1,t=["A","B","C","D"],a=["#3b82f6","#10b981","#f59e0b","#ef4444"],r='<div class="flex items-center gap-1 text-xs">';return t.forEach(function(i,s){var d=e.choiceCounts[i]||0,o=(d/n*100).toFixed(0),l=s===e.correctIndex,c=l?"border-2 border-brand-dark-gray dark:border-brand-white":"";d>0&&(r+='<div class="flex items-center gap-0.5">',r+='<span class="font-semibold">'+i+"</span>",r+='<div class="h-4 rounded '+c+'" style="width: '+o*.8+"px; background-color: "+a[s]+'; opacity: 0.7;"></div>',r+='<span class="text-brand-dark-gray/60 dark:text-brand-white/60">'+o+"%</span>",r+="</div>")}),r+="</div>",r}var Mt=null,qa=[],Dr="name",Hn=!0;function ts(e){var n=document.getElementById("student-insights-content");n&&(n.innerHTML='<div class="flex items-center justify-center p-12 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700/30 rounded-lg"><div class="text-center"><span class="material-symbols-outlined text-5xl text-red-600 dark:text-red-400 mb-4">error</span><p class="text-red-800 dark:text-red-200 text-lg font-semibold mb-2">Failed to Load Student Insights</p><p class="text-red-600 dark:text-red-300 text-sm">'+y(e)+'</p><button onclick="loadStudentInsights()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Retry</button></div></div>'),D("error","Error",e,5e3)}function wl(){var e=Le&&Le.className?Le.className:"all";Le&&Le.dateFrom&&Le.dateFrom,Le&&Le.dateTo&&Le.dateTo,firebase.functions().httpsCallable("getAnalytics")({className:e}).then(function(t){var a=t.data;if(a&&a.success)Mt=a,qa=a.students||[],El();else{var r=a&&a.error?a.error:"Failed to load insights";ts(r)}}).catch(function(t){ts(t.message||"Unknown error")})}function El(){if(Mt){var e=Mt.classStats;document.getElementById("struggling-count").textContent=e.strugglingCount||0,document.getElementById("non-responder-count").textContent=e.nonResponderCount||0,document.getElementById("rule-violator-count").textContent=e.ruleViolatorCount||0,document.getElementById("high-performer-count").textContent=e.highPerformerCount||0,Na()}}function Na(){var e=document.getElementById("student-insights-table-body");if(e){var n=qa;n.sort(function(a,r){var i,s;switch(Dr){case"name":i=a.name||a.email,s=r.name||r.email;break;case"accuracy":i=a.accuracy,s=r.accuracy;break;case"participation":i=a.participationRate,s=r.participationRate;break;case"violations":i=a.violations.length,s=r.violations.length;break;default:return 0}return i<s?Hn?-1:1:i>s?Hn?1:-1:0});var t="";n.forEach(function(a){var r=a.accuracy>=85?"text-green-600 dark:text-green-400":a.accuracy>=70?"text-blue-600 dark:text-blue-400":a.accuracy>=50?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400",i=a.participationRate>=90?"text-green-600 dark:text-green-400":a.participationRate>=75?"text-blue-600 dark:text-blue-400":a.participationRate>=50?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400",s=a.violations.length===0?"text-green-600 dark:text-green-400":a.violations.length===1?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400",d="";a.flags.forEach(function(o){var l="",c="";switch(o){case"struggling":l="bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300",c="Struggling";break;case"non-responder":l="bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300",c="Non-Responder";break;case"rule-violator":l="bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300",c="Rule Violator";break;case"high-performer":l="bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300",c="High Performer";break;case"consistent":l="bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",c="Consistent";break}d+='<span class="'+l+' px-2 py-0.5 rounded text-xs font-semibold mr-1">'+c+"</span>"}),t+='<tr class="border-t border-brand-light-gray dark:border-brand-dark-gray/40 hover:bg-brand-light-gray/20 dark:hover:bg-brand-dark-gray/30 transition-colors">',t+='<td class="px-4 py-3 text-sm font-medium text-brand-dark-gray dark:text-brand-white">'+y(Ve(a))+"</td>",t+='<td class="px-4 py-3 text-center"><span class="text-sm font-semibold '+r+'">'+Math.round(a.accuracy)+'%</span><br><span class="text-xs text-brand-dark-gray/50 dark:text-brand-white/50">'+a.correctAnswers+"/"+(a.correctAnswers+a.incorrectAnswers)+"</span></td>",t+='<td class="px-4 py-3 text-center"><span class="text-sm font-semibold '+i+'">'+Math.round(a.participationRate)+'%</span><br><span class="text-xs text-brand-dark-gray/50 dark:text-brand-white/50">'+a.questionsAnswered+"/"+a.totalQuestions+"</span></td>",t+='<td class="px-4 py-3 text-center text-sm font-semibold '+s+'">'+a.violations.length+"</td>",t+='<td class="px-4 py-3 text-sm">'+d+"</td>",t+="</tr>"}),e.innerHTML=t||'<tr><td colspan="5" class="px-4 py-8 text-center text-brand-dark-gray/60 dark:text-brand-white/60">No students found</td></tr>'}}function Il(e){if(Mt){qa=Mt.students.filter(function(a){return a.flags.includes(e)});var n=document.getElementById("student-insights-filter-badge"),t=document.getElementById("clear-student-filter-btn");n.textContent=e.replace("-"," ").toUpperCase(),n.classList.remove("hidden"),t.classList.remove("hidden"),Na()}}function kl(){Mt&&(qa=Mt.students||[],document.getElementById("student-insights-filter-badge").classList.add("hidden"),document.getElementById("clear-student-filter-btn").classList.add("hidden"),Na())}function Ll(e){Dr===e?Hn=!Hn:(Dr=e,Hn=!0),Na()}function Cl(){if(document.getElementById("analytics-students-loading").classList.add("hidden"),document.getElementById("analytics-students-content").classList.remove("hidden"),wl(),!(!W||!W.students)){var e=Object.values(W.students);if(sr){var n=e.map(function(t){return{label:Ve(t),subLabel:t.email,student:t}});sr.updateData(n)}}}function Sl(e){document.getElementById("analytics-student-empty").classList.add("hidden"),document.getElementById("analytics-student-detail").classList.remove("hidden");var n=document.getElementById("analytics-student-summary");n.innerHTML='<div class="flex flex-wrap items-center justify-between gap-4"><div><h3 class="text-xl font-bold text-brand-dark-gray dark:text-brand-white">'+y(Ve(e))+'</h3><p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">'+y(e.email)+'</p></div><div class="grid grid-cols-3 gap-4 text-center"><div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">'+e.successLast10.toFixed(1)+'%</div><div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Success Rate</div></div><div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">'+e.participationPct.toFixed(0)+'%</div><div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Participation</div></div><div><div class="text-2xl font-bold text-brand-dark-gray dark:text-brand-white">'+e.integrityCount+'</div><div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Integrity Events</div></div></div></div>';var t=document.getElementById("analytics-student-sparkline"),a=e.sessions||[];if(a.length>0){var r='<div class="flex gap-2">';a.slice(0,10).reverse().forEach(function(o){var l=o.scorePct>=70?"bg-green-500":o.scorePct>=50?"bg-yellow-500":"bg-red-500";r+='<div class="flex-1 flex flex-col items-center gap-1" title="'+y(o.sessionName)+": "+o.scorePct+'%">',r+='<div class="w-full rounded '+l+'" style="height: '+o.scorePct*.8+'px; min-height: 20px;"></div>',r+='<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">'+o.scorePct.toFixed(0)+"%</div>",r+="</div>"}),r+="</div>",t.innerHTML=r}else t.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No session data</p>';var i=document.getElementById("analytics-student-topics"),s=Object.keys(e.topicPerformance||{});if(s.length>0){var d='<div class="space-y-2">';s.forEach(function(o){var l=e.topicPerformance[o],c=l.total>0?(l.correct/l.total*100).toFixed(0):0,u=c>=70?"bg-green-500":c>=50?"bg-yellow-500":"bg-red-500";d+='<div class="flex items-center gap-2">',d+='<div class="text-sm font-semibold text-brand-dark-gray dark:text-brand-white min-w-[100px]">'+y(o)+"</div>",d+='<div class="flex-1 bg-brand-light-gray dark:bg-brand-dark-gray/30 rounded-full h-5 overflow-hidden">',d+='<div class="'+u+' h-full flex items-center justify-end px-2 text-xs text-white font-semibold" style="width: '+c+'%">',c>15&&(d+=c+"%"),d+="</div></div>",d+='<div class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">'+l.correct+"/"+l.total+"</div>",d+="</div>"}),d+="</div>",i.innerHTML=d}else i.innerHTML='<p class="text-sm text-brand-dark-gray/60 dark:text-brand-white/60">No topic data</p>'}document.getElementById("analytics-apply-filters-btn").onclick=function(){var e=document.getElementById("analytics-class-filter").value,n=document.getElementById("analytics-date-from").value,t=document.getElementById("analytics-date-to").value;sn({className:e,dateFrom:n,dateTo:t})},document.getElementById("analytics-clear-filters-btn").onclick=function(){document.getElementById("analytics-class-filter").value="all",document.getElementById("analytics-date-from").value="",document.getElementById("analytics-date-to").value="",sn({className:"all"})},document.getElementById("analytics-refresh-btn").onclick=function(){sn(Le)},document.querySelectorAll(".analytics-date-preset").forEach(function(e){e.onclick=function(){var n=e.getAttribute("data-days"),t=e.getAttribute("data-preset"),a=new Date,r="",i=a.toISOString().split("T")[0];if(n){var s=new Date;s.setDate(s.getDate()-parseInt(n)),r=s.toISOString().split("T")[0]}else if(t==="thisMonth"){var d=new Date(a.getFullYear(),a.getMonth(),1);r=d.toISOString().split("T")[0]}else if(t==="lastMonth"){var o=new Date(a.getFullYear(),a.getMonth()-1,1),l=new Date(a.getFullYear(),a.getMonth(),0);r=o.toISOString().split("T")[0],i=l.toISOString().split("T")[0]}else t==="all"&&(r="",i="");document.getElementById("analytics-date-from").value=r,document.getElementById("analytics-date-to").value=i;var c=document.getElementById("analytics-class-filter").value;sn({className:c,dateFrom:r,dateTo:i})}}),document.getElementById("analytics-export-btn").onclick=function(){if(!W){alert("No data to export. Please load analytics first.");return}var e={exportDate:new Date().toISOString(),kpis:W.kpis||[],sessions:W.sessions||[],items:W.items||[],students:Object.values(W.students||{}),topics:W.topics||[]},n=`Session Name,Class,Date,Questions,Participants,Total Students,Mastery %,Participation %,Median Time (s),Integrity Rate
`;(e.sessions||[]).forEach(function(i){n+='"'+(i.sessionName||"").replace(/"/g,'""')+'",',n+='"'+(i.className||"").replace(/"/g,'""')+'",',n+='"'+(i.date||"")+'",',n+=i.questionCount+",",n+=i.participants+",",n+=i.totalStudents+",",n+=i.masteryPct+",",n+=i.participationPct+",",n+=i.medianTimeSec+",",n+=i.integrityRate+`
`});var t=new Blob([n],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a"),r=URL.createObjectURL(t);a.setAttribute("href",r),a.setAttribute("download","veritas-analytics-"+new Date().toISOString().split("T")[0]+".csv"),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)},document.querySelectorAll(".analytics-tab").forEach(function(e){e.onclick=function(){var n=e.id.replace("analytics-tab-","");Ba=n,document.querySelectorAll(".analytics-tab").forEach(function(t){t.classList.remove("bg-primary","text-brand-white"),t.classList.add("text-brand-dark-gray/70","dark:text-brand-white/70","hover:bg-brand-light-gray/20","dark:hover:bg-brand-dark-gray/30")}),e.classList.add("bg-primary","text-brand-white"),e.classList.remove("text-brand-dark-gray/70","dark:text-brand-white/70","hover:bg-brand-light-gray/20","dark:hover:bg-brand-dark-gray/30"),document.querySelectorAll(".analytics-tab-content").forEach(function(t){t.classList.add("hidden")}),document.getElementById("analytics-content-"+n).classList.remove("hidden"),_n()}}),document.querySelectorAll("#analytics-items-table th[data-sort]").forEach(function(e){e.onclick=function(){var n=e.getAttribute("data-sort");nt.field===n?nt.direction=nt.direction==="asc"?"desc":"asc":(nt.field=n,nt.direction="asc"),es()}});async function Pr(e){console.log("[onStartPoll] EVENT TRIGGERED. Element:",e&&e.target?e.target.id:"N/A"),e&&e.preventDefault(),ne||(ne=document.getElementById("poll-select")),console.log("[onStartPoll] Current pollSelect value:",ne?ne.value:"N/A");try{var n=ne.value;if(!n){console.warn("[onStartPoll] No poll selected."),await S("Please select a poll first.",{title:"Live poll"});return}var t=V.find(function(p){return p.pollId===n});if(console.log("[onStartPoll] Selected Poll found:",!!t,t),!t){console.error("[onStartPoll] Could not find poll data for ID:",n),await S("Could not find the selected poll data.",{title:"Error"}),Y(_,!1);return}if(f=t,console.log("[onStartPoll] CURRENT_POLL_DATA:",{pollId:f.pollId,pollName:f.pollName,hasQuestions:!!f.questions,questionsLength:f.questions?f.questions.length:0,firstQuestion:f.questions&&f.questions[0]?f.questions[0]:"NO FIRST QUESTION"}),wt(t.sessionType)){console.log("[onStartPoll] Starting Secure Session..."),Y(_,!0,"Launching...");var o=f.questions&&f.questions[0]?f.questions[0]:null,a=o&&(o.questionText||o.stemHtml||o.text)||"",r=o?o.options||[]:[],i=o&&o.correctAnswer!==void 0?o.correctAnswer:null,s=o&&(o.questionImageURL||o.imageURL||o.mediaUrl)||"",d=f.questions&&f.questions.length?f.questions.length:0;Br("setLiveSessionState").then(function(b){return console.log("[onStartPoll] secure: obtained callable context"),b.callable({pollId:n,status:"OPEN",questionIndex:0,questionText:a,options:r,correctAnswer:i,questionImageURL:s,totalQuestions:d,metadata:{sessionPhase:"ASSESSMENT_START",resultsVisibility:"HIDDEN"}})}).then(function(b){console.log("[onStartPoll] secure: callable result:",b);var h=b.data;if(Y(_,!1),h&&h.success)Nl(h),Qi&&Ia&&Ia.checked;else throw new Error(h&&h.error||"Failed to start secure session")}).catch(function(b){console.error("[onStartPoll] secure: error:",b),Y(_,!1),F(b)});return}console.log("[onStartPoll] Starting Live Session..."),Y(_,!0,"Starting..."),Un(),Te=!1,je=!0;var o=f.questions&&f.questions[0]?f.questions[0]:null,l=o&&(o.questionText||o.stemHtml||o.text)||"",c=o?o.options||[]:[],u=o&&o.correctAnswer!==void 0?o.correctAnswer:null,g=o&&(o.questionImageURL||o.imageURL||o.mediaUrl)||"",m=f.questions&&f.questions.length?f.questions.length:0;console.log("[onStartPoll] Question data being sent to Firebase:",{questionText:l,questionOptionsLength:c?c.length:0,questionOptions:c,correctAnswer:u,questionImageURL:g,totalQuestions:m,firstQuestion:o}),Br("setLiveSessionState").then(function(p){return console.log("[onStartPoll] live: obtained callable context"),p.callable({pollId:n,status:"OPEN",questionIndex:0,questionText:l,options:c,correctAnswer:u,questionImageURL:g,totalQuestions:m,metadata:{sessionPhase:"LIVE",resultsVisibility:"HIDDEN"}})}).then(function(p){console.log("[onStartPoll] live: callable result:",p),Y(_,!1);var b=p.data;if(b&&b.success){console.log("[onStartPoll] Session started successfully. Triggering UI transition..."),sessionStorage.setItem("veritas_active_poll_id",n);var h=f.questions[0];gn(n),Re("live"),typeof vt=="function"&&vt({pollId:n,status:"OPEN",questionIndex:0,questionText:h.questionText,questionImageURL:h.questionImageURL||"",options:h.options,correctAnswer:h.correctAnswer,totalQuestions:f.questions.length,pollName:f.pollName,metadata:{sessionPhase:"LIVE",resultsVisibility:"HIDDEN"}}),Qi&&Ia&&Ia.checked}else throw new Error(b.error||"Failed to start poll")}).catch(function(p){console.error("[onStartPoll] live: error:",p),Y(_,!1),F(p)})}catch(p){console.error("[onStartPoll] Synchronous error:",p),typeof Y=="function"&&_&&Y(_,!1),F(p)}}function ns(){X&&clearInterval(X),Ut(),yt(),$e=!1,ye=!1,ue=he,Ft(),re("Timer idle.","info"),Te=!1,je=!0;var e=f&&f.pollId||"",n=typeof f.questionIndex=="number"?f.questionIndex:0,t=f.questions&&f.questions[n]?f.questions[n]:null;firebase.functions().httpsCallable("setLiveSessionState")({pollId:e,status:"OPEN",questionIndex:n,questionText:t?t.questionText:"",options:t?t.options:[],correctAnswer:t?t.correctAnswer:null,questionImageURL:t&&(t.questionImageURL||t.imageURL||t.mediaUrl)||"",totalQuestions:f.questions&&f.questions.length?f.questions.length:0}).then(function(a){var r=a.data;if(r&&(r.success===!1||r.error))throw new Error(r.error||"Failed to resume poll");console.log("[Firebase] Poll Resumed:",r)}).catch(F)}function as(){Ut(),yt(),ye=!1,ue=he,Ft(),re("Timer idle.","info");var e=firebase.functions().httpsCallable("setLiveSessionState"),n=f.pollId,t=f.questionIndex||0,a=f.questions&&f.questions[t]?f.questions[t]:null;e({pollId:n,status:"PAUSED",questionIndex:t,questionText:a?a.questionText:"",options:a?a.options:[],correctAnswer:a?a.correctAnswer:null,questionImageURL:a&&(a.questionImageURL||a.imageURL||a.mediaUrl)||"",totalQuestions:f.questions&&f.questions.length?f.questions.length:0}).then(function(r){Te=!0,console.log("Poll Stopped (Paused):",r.data)}).catch(F)}function Ma(){Ut(),yt(),ye=!1,ue=he,Ft(),re("Timer idle.","info");var e=document.getElementById("header-end-show-btn");e&&(e.disabled=!0);var n=firebase.functions().httpsCallable("setLiveSessionState"),t=f.pollId,a=f.questionIndex,r=f.resultsVisibility||"HIDDEN",i=r==="REVEALED";if(!t){console.error("Missing pollId");return}var s=i?"HIDDEN":"REVEALED",d=f.questions&&f.questions[a]?f.questions[a]:null;n({pollId:t,questionIndex:a,status:"LIVE",questionText:d?d.questionText:"",options:d?d.options:[],correctAnswer:d?d.correctAnswer:null,questionImageURL:d&&(d.questionImageURL||d.imageURL||d.mediaUrl)||"",totalQuestions:f.questions&&f.questions.length?f.questions.length:0,metadata:{serverProcessed:!0,resultsVisibility:s}}).then(function(o){console.log("Question Visibility Toggled via Cloud Function (REVEALED="+!i+")"),e&&(e.disabled=!1)}).catch(function(o){console.error("Finalize Session Error:",o),e&&(e.disabled=!1),F(o)})}function rs(){if(We){console.warn("[Navigation] Previous question already in progress; ignoring extra click");return}We=!0,at++;var e=at;console.log("[Navigation] Previous question starting with sequenceId:",e),setTimeout(function(){We=!1,Be=!1},5e3),X&&clearInterval(X),Ut(),yt(),$e=!1,ye=!1,ue=he,Ft(),re("Timer ready for previous question.","info"),Te=!1,Be=!0;var n=(f.questionIndex||0)-1;n<0&&(n=0);var t=firebase.functions().httpsCallable("setLiveSessionState"),a=f.pollId,r=f.questions&&f.questions[n]?f.questions[n]:null;t({pollId:a,questionIndex:n,status:"OPEN",questionText:r?r.questionText:"",options:r?r.options:[],correctAnswer:r?r.correctAnswer:null,questionImageURL:r&&(r.questionImageURL||r.imageURL||r.mediaUrl)||"",totalQuestions:f.questions&&f.questions.length?f.questions.length:0,metadata:{sequenceId:e,timestamp:Date.now()}}).then(function(i){console.log("[Navigation] Previous question confirmed with sequenceId:",e),e===at?setTimeout(function(){Be=!1,We=!1},500):console.warn("[Navigation] Sequence mismatch: local="+at+", this="+e+" (ignoring stale response)")}).catch(function(i){console.error("[Navigation] Previous question error with sequenceId:",e,i),Be=!1,We=!1,F(i)})}var at=0;function zn(){if(We){console.warn("[Navigation] Already in progress; ignoring extra Next click");return}We=!0,at++;var e=at;console.log("[Navigation] Starting with sequenceId:",e),setTimeout(function(){We=!1,Be=!1},5e3),X&&clearInterval(X),Ut(),yt(),$e=!1,ye=!1,ue=he,Ft(),re("Timer ready for next question.","info"),Te=!1,Be=!0;var n=(f.questionIndex||0)+1;if(f&&f.questions&&n<f.questions.length){console.log("[Optimistic] Advancing UI to question index:",n,"sequenceId:",e);var t={mode:"lightweight",pollId:f.pollId,questionIndex:n,status:"OPEN",metadata:{sessionPhase:"LIVE",resultsVisibility:"HIDDEN",startedAt:new Date().toISOString(),sequenceId:e}};li(t)}var a=firebase.functions().httpsCallable("setLiveSessionState"),r=f.pollId,i=f.questions&&f.questions[n]?f.questions[n]:null;a({pollId:r,questionIndex:n,status:"OPEN",questionText:i?i.questionText:"",options:i?i.options:[],correctAnswer:i?i.correctAnswer:null,questionImageURL:i&&(i.questionImageURL||i.imageURL||i.mediaUrl)||"",totalQuestions:f.questions&&f.questions.length?f.questions.length:0,metadata:{sequenceId:e,timestamp:Date.now()}}).then(function(s){console.log("[Navigation] Server confirmed sequenceId:",e),e===at?setTimeout(function(){Be=!1,We=!1},500):console.warn("[Navigation] Sequence mismatch: local="+at+", this="+e+" (ignoring stale response)")}).catch(function(s){console.error("[Navigation] Error with sequenceId:",e,s),e===at&&(Be=!1,We=!1),F(s)})}async function Ra(){var e=f.pollId,n=f.questionIndex;if(!e||typeof n>"u"){await S("No active question to reset.",{title:"Reset question"});return}var t=await Ke("Reset the current question for all students?",{title:"Reset question",confirmText:"Reset question",destructive:!0});if(t){var a=await Ke("Select OK to reset and clear responses, or Cancel to reset while keeping submissions.",{title:"Responses",confirmText:"Reset & clear",cancelText:"Keep submissions",destructive:!0});cn(),yt(),$e=!1,ye=!1,de=!1,ue=he,U=he,dn(!1),ht(),re("Timer idle.","info");var r=firebase.functions().httpsCallable("setLiveSessionState");a&&firebase.database().ref("answers/"+e).remove().then(function(){console.log("Responses cleared for poll reset.")}).catch(console.error);var i=f.questions&&f.questions[n]?f.questions[n]:null;r({pollId:e,questionIndex:n,status:"OPEN",questionText:i?i.questionText:"",options:i?i.options:[],correctAnswer:i?i.correctAnswer:null,questionImageURL:i&&(i.questionImageURL||i.imageURL||i.mediaUrl)||"",totalQuestions:f.questions&&f.questions.length?f.questions.length:0}).then(function(s){Te=!1,D("success","Question Reset",a?"Timer restarted and responses cleared.":"Timer restarted (responses kept).")}).catch(F)}}function is(e,n){if(Ge=!!e,!!we){var t=!f.pollId;we.disabled=t,we.setAttribute("aria-disabled",t?"true":"false"),we.setAttribute("aria-pressed",Ge?"true":"false"),we.dataset.state=Ge?"on":"off",we.classList.toggle("bg-amber-500",Ge&&!t),we.classList.toggle("text-veritas-navy",Ge&&!t),we.classList.toggle("bg-white/10",!(Ge&&!t)),va&&(va.textContent=Ge?"On":"Off",va.classList.toggle("text-veritas-gold",Ge),va.classList.toggle("opacity-80",!Ge))}}async function Al(){if(!(!we||ua)){var e=f&&f.pollId;if(!e){F("No active session to update.");return}var n=!Ge;we.setAttribute("aria-busy","true"),we.disabled=!0;try{var t=firebase.functions().httpsCallable("setLiveSessionState"),a=await t({pollId:e,metadata:{calculatorEnabled:n}});we.removeAttribute("aria-busy"),we.disabled=!1,is(n,!0)}catch(r){we.removeAttribute("aria-busy"),we.disabled=!1,F(r)}}}function Tl(){var e=document.getElementById("hide-results-btn");e&&(e.disabled=!0);const n=firebase.functions().httpsCallable("setLiveSessionState");var t=f.questions&&f.questions[CURRENT_QUESTION_INDEX]?f.questions[CURRENT_QUESTION_INDEX]:null;n({pollId:f.pollId,status:"PAUSED",questionIndex:CURRENT_QUESTION_INDEX,questionText:t?t.questionText:"",options:t?t.options:[],correctAnswer:t?t.correctAnswer:null,questionImageURL:t&&(t.questionImageURL||t.imageURL||t.mediaUrl)||"",totalQuestions:f.questions&&f.questions.length?f.questions.length:0,metadata:{sessionPhase:"RESULTS_HOLD",resultsVisibility:"HIDDEN"}}).then(function(a){e&&(e.disabled=!1)}).catch(function(a){e&&(e.disabled=!1),F(a)})}async function ss(){var e=await Ke("Are you sure you want to end this poll completely?",{title:"End poll",confirmText:"End poll",destructive:!0});if(!e)return;sessionStorage.removeItem("veritas_active_poll_id"),He(),firebase.functions().httpsCallable("finalizeSession")({pollId:f&&f.pollId||""}).then(function(t){He()}).catch(F)}function Bl(e){var n=e&&typeof e.totalResponses=="number"?e.totalResponses:0,t=e&&typeof e.totalStudents=="number"?e.totalStudents:0,a=document.getElementById("live-overview-responses"),r=document.getElementById("live-overview-response-progress"),i=document.getElementById("live-overview-response-caption"),s=document.getElementById("hud-response-count"),d=document.getElementById("hud-response-caption"),o=document.getElementById("hud-response-trend"),l=document.getElementById("mobile-response-chip");a&&(a.textContent=n+" / "+t);var c=t>0?Math.round(n/t*100):0;if(r){var u=Math.max(0,Math.min(100,c));r.style.width=u+"%"}if(i&&(i.textContent=t>0?c+"% complete":"Awaiting roster data"),s&&(s.textContent=(t>0?n:"0")+" / "+(t||0)),l&&(l.textContent=(t>0?n:0)+" / "+(t||0)),d&&(d.textContent=t>0?c+"% complete":"Awaiting roster data"),o){o.classList.remove("hud-trend-up","hud-trend-down","hud-trend-steady");var g=dt.lastCompletionPct;if(g===null||t===0)o.textContent="â€¢ steady",o.classList.add("hud-trend-steady");else{var m=c-g;m>0?(o.textContent="â–² +"+m+"%",o.classList.add("hud-trend-up")):m<0?(o.textContent="â–¼ "+m+"%",o.classList.add("hud-trend-down")):(o.textContent="â€¢ steady",o.classList.add("hud-trend-steady"))}}dt.lastCompletionPct=t>0?c:null,mi("hud-response-ring",c);var p=document.getElementById("hud-response-percent");p&&(p.textContent=c+"%"),gi("responses",c);var b=t>0&&n===t,h=document.getElementById("all-responded-banner");b?dt.allRespondedCelebrated||(D("success","All Students Responded!","Everyone has submitted their answer.",null,{label:"Reveal Answer",onClick:function(){var me=document.getElementById("header-end-show-btn");me&&me.click()}}),h&&(h.classList.add("hidden"),h.setAttribute("aria-hidden","true")),dt.allRespondedCelebrated=!0):(h&&(h.classList.add("hidden"),h.setAttribute("aria-hidden","true")),dt.allRespondedCelebrated=!1),typeof window.checkAllRespondedState=="function"&&window.checkAllRespondedState(b);var w=e&&e.results,q;Array.isArray(w)?q=w:w&&typeof w=="object"?q=Object.keys(w).map(function(me){var Ue=w[me];if(Ue&&typeof Ue=="object"&&!Array.isArray(Ue)){var hn={};return Object.keys(Ue).forEach(function(Za){hn[Za]=Ue[Za]}),hn.answerText=me,hn.count=typeof Ue.count=="number"?Ue.count:0,hn}return{answerText:me,count:typeof Ue=="number"?Ue:0}}):q=[];var T=e&&e.correctAnswer,x=0,C=0;q.forEach(function(me){if(me){var Ue=typeof me.count=="number"?me.count:0;x+=Ue;var hn=me.answerText||me.text||me.optionText||"",Za=me.isCorrect===!0||!!T&&hn===T;Za&&(C+=Ue)}});var R=document.getElementById("live-overview-accuracy"),N=document.getElementById("live-overview-accuracy-caption"),Q=document.getElementById("hud-accuracy-value"),G=document.getElementById("hud-accuracy-caption"),E=document.getElementById("hud-accuracy-trend"),A=document.getElementById("mobile-accuracy-chip"),B=x>0?Math.round(C/x*100):0;R&&(R.textContent=B+"%"),N&&(x===0?N.textContent="No responses yet":N.textContent=C+" of "+x+" correct"),Q&&(Q.textContent=x>0?B+"%":"--%"),A&&(A.textContent=x>0?B+"%":"--%");var Qe=document.getElementById("hud-metacognition-value");if(Qe)if(!e||!e.studentStatuses||x===0)Qe.textContent="--";else{var ot=0,kt=0,ra={guessing:1,"somewhat-sure":2,"very-sure":3,certain:4};if(Object.values(e.studentStatuses).forEach(function(me){me.confidence&&ra[me.confidence]&&(ot+=ra[me.confidence],kt++)}),kt>0){var di=(ot/kt).toFixed(1);Qe.textContent=di+"/4"}else Qe.textContent="--"}if(x>0){mi("hud-accuracy-ring",B);var Ya=document.getElementById("hud-accuracy-percent");if(Ya&&(Ya.textContent=B+"%"),gi("accuracy",B),B===100&&x>=3){var fe=document.getElementById("hud-accuracy-card");fe&&!fe.classList.contains("celebrate")&&vo(fe,"perfect-accuracy")}}if(G&&(x===0?G.textContent="Waiting for responses":G.textContent=C+" of "+x+" correct"),E)if(E.classList.remove("hud-trend-up","hud-trend-down","hud-trend-steady"),x===0)E.textContent="â€¢ steady",E.classList.add("hud-trend-steady");else{var Xa=dt.lastAccuracyPct;if(Xa===null)E.textContent="â€¢ steady",E.classList.add("hud-trend-steady");else{var Ja=B-Xa;Ja>0?(E.textContent="â–² +"+Ja+"%",E.classList.add("hud-trend-up")):Ja<0?(E.textContent="â–¼ "+Ja+"%",E.classList.add("hud-trend-down")):(E.textContent="â€¢ steady",E.classList.add("hud-trend-steady"))}}dt.lastAccuracyPct=x>0?B:null}function ql(e,n,t){var a=document.getElementById("live-overview-lockouts");a&&(a.textContent=e||0);var r=document.getElementById("live-overview-lockouts-caption"),i=document.getElementById("hud-lockouts-value"),s=document.getElementById("hud-lockouts-caption");document.getElementById("hud-lockouts-card");var d=document.getElementById("hud-focus-lockouts-btn"),o=document.getElementById("mobile-lock-chip"),l=document.getElementById("mobile-locks-btn"),c=document.getElementById("mobile-locks-label");if(r){var u=(e||0)+0;if(u===0)r.textContent="No approvals pending";else{var g=[];e&&g.push(e+" locked"),r.textContent=g.join(" â€¢ ")}}var m=(e||0)+0;if(i&&(i.textContent=m),o&&(o.textContent=m),c&&(c.textContent=m===1?"1 Locked":m+" Locked"),s&&(m===0?s.textContent="No approvals pending":s.textContent="Requires quick approval"),d)if(m>0)d.disabled=!1,d.classList.remove("opacity-50","pointer-events-none");else{d.disabled=!0,d.classList.add("opacity-50","pointer-events-none");var p=document.getElementById("locked-students-popover");p&&p.classList.add("hidden")}l&&(l.disabled=m===0),dt.lastLockoutTotal=m;var b=document.getElementById("focus-lockouts-btn");b&&(b.disabled=(e||0)===0);var h=document.getElementById("live-overview-waiting");h&&(h.textContent=t||0);var w=document.getElementById("live-overview-waiting-caption");w&&(t?t===1?w.textContent="1 student still working":w.textContent=t+" students still working":w.textContent="Everyone has responded")}function Nl(e){Ks(e)}async function Ml(){var e=await Ke("Are you sure you want to end this session for all students?",{title:"End Session",confirmText:"End Session",cancelText:"Cancel"});if(!e)return;ve.stop();var n=O||f&&f.pollId;if(!n)return;firebase.functions().httpsCallable("finalizeSession")({pollId:n}).then(function(){He()}).catch(F)}function on(e,n){var t=document.querySelectorAll('[id="'+e+'"]');t.forEach(function(a){a.style.display=n})}function Da(e,n){var t=document.querySelectorAll('[id="'+e+'"]');t.forEach(function(a){"disabled"in a&&(a.disabled=n),n?(a.style.opacity="0.5",a.style.cursor="not-allowed"):(a.style.opacity="1",a.style.cursor="pointer")})}function vt(e){if(ce.style.display="none",Y(_,!1),!!e){e.pollId&&gn(e.pollId);var n=e.status||"PRE_LIVE",t=e.metadata||{},a=typeof t.isCollecting=="boolean"?t.isCollecting:n==="LIVE",r=t.resultsVisibility||"HIDDEN",b=r==="REVEALED",i=n==="PRE_LIVE",s=n==="ENDED",d=t.calculatorEnabled===!0||e.calculatorEnabled===!0||e.secureSettings&&e.secureSettings.calculatorEnabled===!0;if(!je&&!i)if(n==="LIVE"||n==="OPEN")console.log("[updateLiveView] Transitioning to LIVE session state"),je=!0;else return;if((n==="LIVE"||n==="OPEN")&&Re("live"),(typeof se>"u"||se===null)&&(se=e.questionIndex),i||s){console.log("[updateLiveView] Session is PRE_LIVE or ENDED, showing dashboard"),He();return}if(e.error){F(e.error);return}var o=typeof f.questionIndex=="number"?f.questionIndex:null;if(Te=!a,f.pollId=e.pollId||ne.value,f.questionIndex=e.questionIndex,f.correctAnswer=e.correctAnswer,e.sessionType&&(ut=Xe(e.sessionType),f.sessionType=e.sessionType),!f.questions&&V){var l=V.find(function(fe){return fe.pollId===(e.pollId||f.pollId)});l&&l.questions&&(console.log("[Enrichment] Restored questions from ALL_POLLS cache"),f.questions=l.questions)}f.pollId&&gn(f.pollId),f.totalQuestions=e.totalQuestions,f.timerSeconds=e.timerSeconds||null,f.options=e.options||[],f.metacognition=e.metacognition||null,f.calculatorEnabled=d,wt(e.sessionType||ut),is(d);var c=o===null||e.questionIndex!==o;mn("header-poll-name",e.pollName),mn("header-poll-name",e.pollName);var u=se!==null?se:e.questionIndex,g=se===e.questionIndex,m=document.getElementById("header-present-btn");m&&(!g&&u!==e.questionIndex?m.classList.remove("hidden"):m.classList.add("hidden")),os(e.questionIndex,e.totalQuestions,se),f.questions&&f.questions[u]&&uo(u),Da("header-back-btn",e.questionIndex<=0),Da("header-prev-btn",e.questionIndex<=0);var p=e.questionIndex>=e.totalQuestions-1;Da("header-next-btn",p),Da("mobile-next-btn",p);var b=r==="REVEALED",h=document.getElementById("mobile-resume-btn"),w=document.getElementById("mobile-reveal-btn");if(b?(on("header-start-btn","none"),on("header-end-show-btn","none"),h&&h.classList.add("hidden"),w&&w.classList.add("hidden")):Te?(on("header-start-btn","flex"),on("header-end-show-btn","flex"),h&&h.classList.remove("hidden"),w&&w.classList.remove("hidden")):(on("header-start-btn","none"),on("header-end-show-btn","flex"),h&&h.classList.add("hidden"),w&&w.classList.remove("hidden")),c){var q=e.timerSeconds?Math.min(600,Math.max(15,parseInt(e.timerSeconds,10))):90;he=q,ue=q,U=q,$e=!1,ye=!1,de=!1,rt.stop(),de=!1,ye=!1,dn(!1),ht(),re("Timer idle.","info")}if(e.metadata)if(e.metadata.reason==="TIMER_EXPIRED"){ue=0,U=0;var T=ye;ye=!0,ht(),ye=T,$e=!0,re("Time expired â€” poll paused.","danger")}else e.metadata.reason==="MANUAL_PAUSE"?re("Poll paused.","info"):e.metadata.reason==="RESPONSES_CLOSED"?re("Responses closed. Ready to reveal.","info"):e.metadata.reason==="RESULTS_REVEALED"?re("Results shared with students.","success"):e.metadata.reason==="RESULTS_HIDDEN"?re("Results hidden from students.","info"):re("Timer idle.","info");console.log("=== TEACHER RECEIVED DATA ==="),console.log("questionImageURL:",e.questionImageURL),console.log("options:",e.options),e.options&&e.options.length>0&&e.options.forEach(function(fe,Xa){console.log("  Option "+Xa+":",'text="'+fe.text+'", imageURL='+fe.imageURL)});var x=ci!==e.questionIndex;if(x){ci=e.questionIndex;var C=document.querySelector(".live-question-card");C&&(C.classList.remove("motion-slide-in-right"),C.offsetWidth,C.classList.add("motion-slide-in-right"))}mn("live-question-info","Q"+(e.questionIndex+1)+"/"+e.totalQuestions),Ms("live-question-text",e.questionText),Ms("live-question-text-compact",e.questionText);var R=document.getElementById("question-image-container"),N=document.querySelectorAll('[id="live-question-image"]'),Q=document.getElementById("question-layout-container");if(e.questionImageURL){R&&(R.style.display="flex"),Q&&Q.classList.remove("no-image");var G=e.questionImageURL,E="q="+e.questionIndex,A=G.includes("?")?"&":"?";N.forEach(function(fe){fe.src=G+A+E,fe.style.display="block",fe.setAttribute("referrerpolicy","no-referrer")})}else R&&(R.style.display="none"),N.forEach(function(fe){fe.src=""}),Q&&Q.classList.add("no-image");mn("response-count",e.totalResponses+" / "+e.totalStudents+" answered"),mn("response-count-header",e.totalResponses+" / "+e.totalStudents+" answered"),Bl(e),Dl(e.results,e.correctAnswer,e.studentStatusList),Pl(e.metacognition||null);var B=document.getElementById("results-reveal-strip");if(B){var Qe=typeof e.questionIndex=="number"&&e.questionIndex>=0;if(a||!Qe||!b)B.classList.add("hidden");else{B.classList.remove("hidden");var ot=document.getElementById("hide-results-btn"),kt=document.getElementById("strip-next-btn"),ra=document.getElementById("results-strip-status");if(ot&&(ot.disabled=!Qe),kt&&(kt.disabled=!Qe),ra){var di=e.totalResponses===0?" No responses were recorded.":"";ra.textContent="Students can now see the correct answer and results."+di}}}if(P=e.studentStatusList,typeof ja=="function"&&ja(),ir&&Array.isArray(P)){var Ya=P.map(function(fe){return{label:Ve(fe),subLabel:fe.status,value:fe.email}});ir.updateData(Ya)}Ee(),X&&clearInterval(X),Te||(X=setInterval(Dt,la))}}function Rl(e){if(!(Te||Be)&&e!==f.questionIndex){X&&clearInterval(X),Ut(),yt(),$e=!1,ye=!1,ue=he,Ft(),re("Navigating...","info"),Te=!1,Be=!0,se=e,os(f.questionIndex,f.totalQuestions,se),uo(se);var n=document.getElementById("header-present-btn");n&&(se!==f.questionIndex?n.classList.remove("hidden"):n.classList.add("hidden")),Be=!1}}function os(e,n,t){t==null&&(t=e);var a=document.getElementById("question-progress-container");if(a){a.innerHTML="";var r=10,i=0,s=n;if(n>r&&(i=Math.max(0,t-Math.floor(r/2)),s=Math.min(n,i+r),s-i<r&&(i=Math.max(0,s-r))),i>0){var d=document.createElement("span");d.className="text-white/30 text-xs mx-1",d.textContent="...",a.appendChild(d)}for(var o=i;o<s;o++){var l=document.createElement("button");l.type="button";var c=o===e,u=o===t,g=o<e;l.className="question-step flex items-center justify-center rounded-full transition-all duration-300 cursor-pointer ",u?(l.className+="w-8 h-8 sm:w-9 sm:h-9 bg-veritas-gold text-white font-bold text-xs sm:text-sm shadow-md ring-2 ring-white/20 z-10",l.innerHTML="<span>"+(o+1)+"</span>"):c?(l.className+="w-8 h-8 bg-green-500 text-white font-bold hover:scale-105 ring-2 ring-green-400/50",l.innerHTML='<span class="material-symbols-outlined text-lg">podium</span>'):g?(l.className+="w-8 h-8 bg-emerald-500/80 text-white font-bold hover:bg-emerald-500 hover:scale-105",l.innerHTML='<span class="material-symbols-outlined text-lg">check</span>'):(l.className+="w-6 h-6 sm:w-7 sm:h-7 bg-white/10 text-white/50 border border-white/10 font-bold text-[10px] sm:text-xs hover:bg-white/20 hover:text-white hover:scale-105",l.innerHTML="<span>"+(o+1)+"</span>"),(function(p){l.onclick=function(b){b.stopPropagation(),Rl(p)},l.title="View Question "+(p+1)})(o),a.appendChild(l)}if(s<n){var m=document.createElement("span");m.className="text-white/30 text-xs mx-1",m.textContent="...",a.appendChild(m)}}}function Dl(e,n,t){var a=document.getElementById("results-bars");a.innerHTML="";var r=Array.isArray(f.options)?f.options.slice():[],i={};if(r.forEach(function(o){i[o&&o.text||""]=!0}),e&&Object.keys(e).forEach(function(o){i[o||""]||(r.push({text:o||"",imageURL:""}),i[o||""]=!0)}),r.length===0&&(r=e&&Object.keys(e).length>0?Object.keys(e).map(function(o){return{text:o,imageURL:""}}):[]),r.length===0){a.innerHTML='<p class="text-center text-gray-500 py-4">Waiting for responses...</p>';return}var s=r.reduce(function(o,l){var c=l&&l.text||"",u=e&&typeof e[c]=="number"?e[c]:0;return o+u},0),d="ABCDEFGHIJKLMNOPQRSTUVWXYZ";r.forEach(function(o,l){var c=o&&o.text||"",u=e&&typeof e[c]=="number"?e[c]:0,g=s>0?Math.round(u/s*100):0,m=c===n,p=d[l]||String(l+1),b=o&&o.imageURL,h=document.createElement("div"),w=m?"border-green-500 dark:border-green-400":"border-gray-200 dark:border-gray-700",q=m?"bg-green-50/50 dark:bg-green-900/20":"bg-white dark:bg-brand-dark-gray/30";h.className="relative rounded-xl border "+w+" "+q+" overflow-hidden transition-all hover:shadow-sm";var T='<div class="flex items-start gap-2.5 p-3">',x=m?"bg-green-500 dark:bg-green-600":"bg-gray-600 dark:bg-gray-500";T+='<div class="flex-shrink-0 w-8 h-8 '+x+' rounded-lg flex items-center justify-center">',T+='<span class="text-white text-base font-bold">'+p+"</span>",T+="</div>",T+='<div class="flex-1 min-w-0">',c?T+='<div class="text-[1.125rem] font-medium text-brand-dark-gray dark:text-brand-white break-words leading-relaxed ql-editor-reset">'+tr(c)+"</div>":b||(T+='<p class="text-sm font-medium text-gray-400 dark:text-gray-500">(No content)</p>'),b&&(T+='<div class="mt-1.5"><img src="'+y(b)+'" class="max-w-full max-h-24 rounded-lg border border-gray-200 dark:border-gray-700" alt="Answer '+p+' image" referrerpolicy="no-referrer"/></div>');var C=Array.isArray(t)?t.filter(function(N){return N.answer===c}):[];C.length>0&&(T+='<div class="mt-1.5 flex flex-wrap gap-1">',C.forEach(function(N){var Q=Co(N.confidence),G=ar[N.confidence]||{},E=G.badgeClass||"bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300",A=Ve(N);if(Q){var B=G.emoji||"";A=B+" "+A}T+='<span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[11px] font-medium '+E+'">'+y(A)+"</span>"}),T+="</div>"),T+="</div>";var R=m?"bg-green-500 dark:bg-green-600":"bg-gray-700 dark:bg-gray-600";T+='<div class="flex-shrink-0 '+R+' text-white rounded-lg px-2 py-1 flex flex-col items-center">',T+='<span class="text-lg font-bold leading-none">'+g+"%</span>",T+='<span class="text-[10px] opacity-90 mt-0.5">'+u+"</span>",T+="</div>",T+="</div>",h.innerHTML=T,a.appendChild(h)}),nr()}function Pl(e){var n=document.getElementById("confidence-pulse-container");if(n&&(n.innerHTML="",!(!e||!e.enabled))){var t=document.createElement("div");t.id="live-metacognition-card",t.className="bg-white dark:bg-brand-dark-gray/30 p-3 rounded-xl border border-purple-200 dark:border-purple-700 shadow-sm";var a=e.totalResponses||0,r=e.responseRate||0,i=Array.isArray(e.flaggedStudents)?e.flaggedStudents:[],s=a>0?a+" responses â€¢ "+r+"% participation":"Waiting for responses",d=[{key:"confidentCorrect",emoji:"ðŸ’¯",label:"Sure & Right",barClass:"bg-emerald-500",textClass:"text-emerald-700 dark:text-emerald-200"},{key:"confidentIncorrect",emoji:"âš ï¸",label:"Sure & Wrong",barClass:"bg-rose-500",textClass:"text-rose-700 dark:text-rose-200"},{key:"uncertainCorrect",emoji:"ðŸ¤”",label:"Unsure & Right",barClass:"bg-amber-500",textClass:"text-amber-700 dark:text-amber-200"},{key:"uncertainIncorrect",emoji:"ðŸ¤·",label:"Unsure & Wrong",barClass:"bg-blue-500",textClass:"text-blue-700 dark:text-blue-200"}],o='<div class="flex items-start justify-between gap-3 mb-2">';o+='<div class="flex items-start gap-2">',o+='<span class="material-symbols-outlined text-purple-600 dark:text-purple-300 text-xl">psychology</span>',o+='<div><h4 class="text-brand-dark-gray dark:text-brand-white font-semibold text-sm leading-tight">Confidence Pulse</h4>',o+='<p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">Certainty vs. accuracy snapshot</p></div>',o+="</div>",o+='<div class="text-xs px-2 py-1 rounded-md bg-purple-50 text-purple-700 dark:bg-purple-900/30 dark:text-purple-200 font-semibold">'+y(s)+"</div>",o+="</div>",o+='<div class="flex flex-wrap gap-2 mb-3 text-xs font-semibold">',o+='<span class="px-2 py-1 rounded-md bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-200">âœ“ Correct: '+(e.correctCount||0)+"</span>",o+='<span class="px-2 py-1 rounded-md bg-rose-50 text-rose-700 dark:bg-rose-900/30 dark:text-rose-200">âœ— Incorrect: '+(e.incorrectCount||0)+"</span>",o+='<span class="px-2 py-1 rounded-md bg-slate-100 text-slate-700 dark:bg-slate-800/50 dark:text-slate-200">âŠ˜ Unanswered: '+(e.unansweredCount||0)+"</span>",o+="</div>",o+='<div class="grid grid-cols-1 sm:grid-cols-2 gap-2">',d.forEach(function(l){var c=e.matrixPercentages&&typeof e.matrixPercentages[l.key]=="number"?e.matrixPercentages[l.key]:0,u=e.matrixCounts&&typeof e.matrixCounts[l.key]=="number"?e.matrixCounts[l.key]:0,g=[];Array.isArray(P)&&(g=P.filter(function(m){if(m.status!=="Submitted"||!m.confidence)return!1;var p=m.isCorrect===!0,b=m.confidence>=.75;return l.key==="confidentCorrect"?b&&p:l.key==="confidentIncorrect"?b&&!p:l.key==="uncertainCorrect"?!b&&p:l.key==="uncertainIncorrect"?!b&&!p:!1})),o+='<div class="confidence-row flex flex-col">',o+='<div class="flex items-center justify-between gap-2">',o+='<div class="flex items-center gap-1.5"><span class="text-sm">'+l.emoji+'</span><span class="text-xs font-semibold '+l.textClass+'">'+l.label+"</span></div>",o+='<span class="text-sm font-bold '+l.textClass+'">'+c+"%</span>",o+="</div>",o+='<div class="confidence-bar-track my-1"><div class="confidence-bar-fill '+l.barClass+'" style="width:'+c+'%"></div></div>',g.length>0&&(o+='<div class="flex flex-wrap gap-1 mt-1 mb-2">',g.forEach(function(m){o+='<span class="px-1.5 py-0.5 rounded bg-white/50 dark:bg-black/20 text-[10px] font-medium border border-black/5 truncate max-w-full">'+y(Ve(m))+"</span>"}),o+="</div>"),o+='<div class="flex items-center justify-between text-[11px] text-brand-dark-gray/60 dark:text-brand-white/60 mt-auto">',o+="<span>"+u+" students</span>",o+="<span>live</span>",o+="</div>",o+="</div>"}),o+="</div>",i.length>0&&(o+='<div class="rounded-lg border border-rose-500/40 bg-rose-500/10 p-2 mt-2">',o+='<div class="flex items-center gap-1 mb-1">',o+='<span class="material-symbols-outlined text-sm text-rose-700 dark:text-rose-200">report</span>',o+='<span class="text-xs font-semibold text-rose-700 dark:text-rose-200">'+i.length+" confidently wrong</span>",o+="</div>",o+='<div class="flex flex-wrap gap-1">',i.forEach(function(l){var c=y(l.name||l.email||"Student");o+='<span class="px-1.5 py-0.5 rounded bg-white/70 text-xs font-medium text-rose-700 dark:bg-rose-900/40 dark:text-rose-100">'+c+"</span>"}),o+="</div>",o+="</div>"),t.innerHTML=o,n.appendChild(t)}}var Rt="all",Ul="all";function Fl(e){if(e==null)return null;var n=e.toString().trim().toLowerCase(),t=n.replace(/\s+/g,"_");return t.indexOf("blocked")===0?"BLOCKED":t.indexOf("awaiting_fullscreen")===0||t.indexOf("awaitingfullscreen")===0||t.indexOf("awaiting_full_screen")===0?"AWAITING_FULLSCREEN":t.indexOf("locked")===0||t.indexOf("locked")>0&&t.indexOf("unlocked")===-1||t.indexOf("approval")!==-1&&t.indexOf("unlocked")===-1?"LOCKED":null}function ln(e){return e?Fl(e.status||e.proctorStatus||null):null}function Ol(e){return ln(e)==="LOCKED"}async function _l(){if(!(!f||!f.pollId)){var e=P.filter(function(u){return Ol(u)});if(e.length===0){await S("No students are currently locked.",{title:"No students to approve"});return}var n=await Ke("Approve re-entry for all "+e.length+" locked student(s)?",{title:"Approve All",confirmText:"Approve All ("+e.length+")"});if(n){var t=document.getElementById("approve-all-unlocks-btn");t&&(t.disabled=!0,t.querySelector("span:last-child").textContent="Approving...");for(var a=0,r=0,i=0;i<e.length;i++){var s=e[i];try{var d=firebase.functions().httpsCallable("manageProctoring"),o=parseInt(s.lockVersion,10);isNaN(o)&&(o=0);var l=await d({action:"UNLOCK",studentEmail:s.email,pollId:f.pollId,lockVersion:o});l.data&&l.data.success?(a++,P=P.map(function(u){return u.email===s.email?{name:u.name,email:u.email,status:"AWAITING_FULLSCREEN",lockVersion:l.data.lockVersion||s.lockVersion,lockReason:u.lockReason,lockedAt:u.lockedAt,answer:u.answer,isCorrect:u.isCorrect,timestamp:u.timestamp}:u})):r++}catch{r++}}if(Ee(),t&&(t.disabled=!1,t.querySelector("span:last-child").textContent="Approve All"),a>0){var c="Approved "+a+" student(s)";r>0&&(c+=", "+r+" failed"),D("success","Batch Approval Complete",c,4e3)}else D("error","Approval Failed","Failed to approve students. Please try again.",4e3)}}}function Ur(e){var n=Math.floor((new Date-e)/1e3);return n<60?"just now":n<120?"1 minute ago":n<3600?Math.floor(n/60)+" minutes ago":n<7200?"1 hour ago":n<86400?Math.floor(n/3600)+" hours ago":Math.floor(n/86400)+" days ago"}async function ls(e,n,t,a,r){if(!(!e||!n)){if(r=r||{},t=parseInt(t,10),isNaN(t)&&(t=0),!r.skipConfirm){var i=await Ke("Approve unlock for "+e+"?",{title:"Approve unlock",confirmText:"Approve"});if(!i)return}if(a){a.disabled=!0;var d=a.querySelector("span.material-symbols-outlined"),o=a.querySelector("span:last-child");d&&(d.textContent="progress_activity"),d&&d.classList.add("animate-spin"),o&&(o.textContent="Unlocking...")}var s=!1;P=P.map(function(c){return c.email===e?(s=!0,Object.assign({},c,{status:"AWAITING_FULLSCREEN",optimistic:!0})):c}),s&&(Ee(),console.log("[Optimistic UI] Student",e,"marked as AWAITING_FULLSCREEN (pending server confirmation)"));var d,o,l=firebase.functions().httpsCallable("manageProctoring");l({action:"UNLOCK",pollId:n,studentEmail:e,expectedLockVersion:t}).then(function(c){var u=c.data;if(u&&u.success){if(a){a.disabled=!1;var g=a.querySelector("span.material-symbols-outlined"),m=a.querySelector("span:last-child");g&&(g.textContent="check_circle",g.classList.remove("animate-spin")),m&&(lastSpan.textContent="Unlocked"),setTimeout(function(){J&&J.email===e&&populateStudentModal(J)},1e3)}D("success","Unlocked",e+" has been approved to rejoin.")}else throw new Error(u&&u.error||"Failed to approve unlock")}).catch(function(c){if(console.error("[Unlock Error]",c),P=P.map(function(m){return m.email===e&&m.optimistic?(delete m.optimistic,Object.assign({},m,{status:"LOCKED"})):m}),Ee(),a){a.disabled=!1;var u=a.querySelector("span.material-symbols-outlined"),g=a.querySelector("span:last-child");u&&(u.textContent="lock_open",u.classList.remove("animate-spin")),g&&(g.textContent="Approve Unlock")}c.message&&c.message.includes("version_mismatch")?D("warning","Unlock Failed","Student violated policy again. Refresh and retry.",5e3):F(c)})}}function Hl(e){var n=document.createElement("button");n.className="reset-btn flex-shrink-0 flex items-center justify-center gap-1 h-7 px-2.5 rounded-md bg-primary/10 text-primary dark:text-brand-white dark:bg-brand-white/10 text-xs font-semibold hover:bg-primary/20 dark:hover:bg-brand-white/20 transition-colors",n.dataset.email=e.email||"";var t=document.createElement("span");t.className="material-symbols-outlined text-sm",t.textContent="refresh";var a=document.createElement("span");return a.textContent="Reset",n.appendChild(t),n.appendChild(a),n.addEventListener("click",function(r){r.stopPropagation(),e.email&&_r("RESET",e.email)}),n}function zl(e){var n=document.createElement("button");n.className="unlock-btn flex-shrink-0 flex items-center justify-center gap-1 h-8 px-3 rounded-md bg-red-600 text-white text-xs font-bold hover:bg-red-700 transition-colors shadow-sm",n.dataset.email=e.email||"",f&&f.pollId!==void 0&&(n.dataset.pollId=f.pollId),n.dataset.lockVersion=e.lockVersion!=null?e.lockVersion:0;var t=document.createElement("span");t.className="material-symbols-outlined text-sm",t.textContent="lock_open";var a=document.createElement("span");return a.textContent="Approve",n.appendChild(t),n.appendChild(a),n.addEventListener("click",function(r){r.stopPropagation(),e.email&&_r("UNLOCK",e.email)}),n}function Vl(e){if(!e)return null;var n=Ve(e),t=ln(e),a=t==="LOCKED",r=t==="BLOCKED",i=t==="AWAITING_FULLSCREEN",s=e.isCorrect===!0,d=document.createElement("div"),o="relative group p-4 rounded-xl border transition-all duration-200 hover:shadow-md";a||i?o+=" bg-red-50 dark:bg-red-900/10 border-red-200 dark:border-red-800/30":r?o+=" bg-gray-100 dark:bg-gray-800 border-gray-300 dark:border-gray-600 opacity-60":e.status==="Submitted"?s?o+=" bg-emerald-50 dark:bg-emerald-900/10 border-emerald-200 dark:border-emerald-800/30":e.isCorrect===!1?o+=" bg-amber-50 dark:bg-amber-900/10 border-amber-200 dark:border-amber-800/30":o+=" bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700":o+=" bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",d.className=o;var l="INVITED",c=(e.status||"").toUpperCase();a?l="VIOLATION DETECTED":r?l="BLOCKED":i?l="ALLOW RE-ENTRY":c==="SUBMITTED"?l="ANSWERED":c==="IN PROGRESS"?l="WORKING...":c==="ACTIVE"?l="THINKING...":c==="CONNECTED"?l="JOINED":c==="TYPING"&&(l="TYPING...");var u='<div class="flex items-start justify-between mb-2 gap-2">';u+='<div class="flex flex-col min-w-0 flex-1">',u+='<span class="font-bold text-sm text-gray-900 dark:text-white truncate" title="'+y(n)+'">'+y(n)+"</span>",u+='<span class="text-[10px] uppercase font-bold tracking-wide text-gray-400 dark:text-gray-500 truncate">'+y(l)+"</span>",u+="</div>";var g="bg-gray-300";a?g="bg-red-500 animate-pulse":e.status==="Submitted"?g="bg-emerald-500":c==="IN PROGRESS"||c==="TYPING"?g="bg-indigo-400 animate-pulse":(c==="ACTIVE"||c==="CONNECTED")&&(g="bg-blue-400"),u+='<span class="flex-shrink-0 w-2.5 h-2.5 rounded-full shadow-sm mt-1 '+g+'"></span>',u+="</div>",u+='<div class="flex items-center justify-between border-t border-gray-100 dark:border-gray-700/50 pt-3 mt-1">';var m=e.answer?y(e.answer):'<span class="text-gray-300 italic">Thinking...</span>',p="text-gray-900 dark:text-white";if(e.status==="Submitted"&&(s?p="text-emerald-700 dark:text-emerald-300":e.isCorrect===!1&&(p="text-amber-700 dark:text-amber-300 line-through decoration-amber-500/50")),u+='<div class="flex flex-col">',u+='<span class="text-[10px] font-mono text-gray-400 mb-0.5">ANSWER</span>',u+='<span class="text-sm font-bold '+p+' truncate max-w-[100px]">'+m+"</span>",u+="</div>",e.confidence){var b=ar[e.confidence]||{},h=b.emoji||"â€¢",w=b.textClass||"text-gray-400";u+='<div class="flex flex-col items-end" title="'+(b.label||"")+'">',u+='<span class="text-[10px] font-mono text-gray-400 mb-0.5">CONFIDENCE</span>',u+='<span class="text-lg '+w+'">'+h+"</span>",u+="</div>"}u+="</div>";var q=a||e.status==="Submitted"||e.status==="Waiting...";if(q&&(u+='<div class="absolute inset-0 bg-white/95 dark:bg-gray-800/95 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2 rounded-xl backdrop-blur-[2px] z-10 pointer-events-none">',u+='<span class="text-xs font-bold text-gray-500 mb-1">ACTIONS</span>',u+='<div class="action-btn-container flex gap-2 pointer-events-auto"></div>',u+="</div>"),d.innerHTML=u,q){var T=d.querySelector(".action-btn-container");if(T){if(a){var x=zl(e);x.className="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-bold rounded shadow-sm",x.innerHTML="UNLOCK",T.appendChild(x)}if(e.status==="Submitted"){var C=Hl(e);C.className="px-3 py-1.5 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold rounded shadow-sm",C.innerHTML="RESET",T.appendChild(C)}}}return d}var Fr="ALL";function ds(e){if(Fr!==e){Fr=e;var n=document.getElementById("filter-all-btn"),t=document.getElementById("filter-locked-only-btn");n&&(e==="ALL"?n.className="px-3 py-1 text-xs font-bold rounded-md bg-white dark:bg-gray-600 text-gray-800 dark:text-white shadow-sm transition-all":n.className="px-3 py-1 text-xs font-bold rounded-md text-gray-500 hover:text-gray-700 dark:text-gray-400 hover:bg-gray-300 dark:hover:bg-gray-600 transition-all"),t&&(e==="LOCKED"?t.className="px-3 py-1 text-xs font-bold rounded-md bg-white dark:bg-gray-600 text-red-600 dark:text-red-400 shadow-sm transition-all flex items-center gap-1":t.className="px-3 py-1 text-xs font-bold rounded-md text-gray-500 hover:text-gray-700 dark:text-gray-400 hover:bg-gray-300 dark:hover:bg-gray-600 transition-all flex items-center gap-1"),Ee()}}function Ee(){var e=document.getElementById("student-status-grid");if(e){var n=Array.isArray(P)?P:[],t=[];Fr==="LOCKED"?t=n.filter(function(h){var w=ln(h);return w==="LOCKED"||w==="BLOCKED"}):t=n.slice(),t.sort(function(h,w){var q=function(C){var R=ln(C);return R==="LOCKED"||R==="BLOCKED"?0:C.status==="Submitted"?C.isCorrect===!0?3:2:1},T=q(h),x=q(w);return T!==x?T-x:(h.lastName||"").localeCompare(w.lastName||"")}),e.innerHTML="";var a=document.createDocumentFragment();t.forEach(function(h){var w=Vl(h);w&&(w.style.cursor="pointer",w.onclick=function(){Ql(h.email)},a.appendChild(w))}),e.appendChild(a);var r=t.filter(h=>h.status==="Submitted").length,i=t.filter(h=>h.status==="Submitted"&&h.isCorrect===!0).length,s=t.filter(h=>ln(h)==="LOCKED").length,d=t.filter(h=>h.status!=="Submitted").length,o=t.length,l=r>0?Math.round(i/r*100):0,c=document.getElementById("hud-accuracy-value");c&&(c.textContent=r>0?l+"%":"--%");var u=document.getElementById("hud-response-count");u&&(u.textContent=r+"/"+o);var g=0,m=0;t.forEach(function(h){h.status==="Submitted"&&h.confidence&&(h.confidence==="guessing"?g+=0:h.confidence==="somewhat-sure"?g+=50:h.confidence==="very-sure"&&(g+=100),m++)});var p=m>0?Math.round(g/m):null,b=document.getElementById("hud-metacognition-value");b&&(p!==null?(b.textContent=p,b.className="text-xl font-bold "+(p>=80?"text-emerald-600":p>=50?"text-amber-600":"text-red-500")):(b.textContent="--",b.className="text-xl font-bold text-gray-400")),ql(s,0,d)}}function Ql(e){var n=P.find(function(l){return l.email===e});if(n){var t=document.getElementById("student-inspector-panel");if(t){var a=Ve(n),r=ln(n),i=r==="LOCKED",s=r==="BLOCKED",d=i?"text-red-600 bg-red-50":s?"text-gray-600 bg-gray-100":"text-emerald-600 bg-emerald-50",o=`
        <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-900">
          <div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white">${y(a)}</h3>
            <span class="text-xs px-2 py-0.5 rounded font-bold uppercase tracking-wide ${d}">${r||"UNKNOWN"}</span>
          </div>
          <button onclick="closeStudentInspector()" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-6">
          <div class="space-y-4">
            <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Actions</h4>
            <div class="grid grid-cols-1 gap-3">
              ${i?`
              <button onclick="proctorAction('UNLOCK', '${e}')" class="flex items-center justify-center gap-2 p-3 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700 transition-all shadow-md">
                <span class="material-symbols-outlined">lock_open</span>
                <span>Unlock Student</span>
              </button>`:""}
              
              <button onclick="proctorAction('RESET', '${e}')" class="flex items-center justify-center gap-2 p-3 bg-white border border-gray-300 text-gray-700 rounded-lg font-bold hover:bg-gray-50 transition-all">
                <span class="material-symbols-outlined">restart_alt</span>
                <span>Reset Question</span>
              </button>
              
              <button onclick="resendLinkToStudent('${e}')" class="flex items-center justify-center gap-2 p-3 bg-blue-50 text-blue-600 border border-blue-200 rounded-lg font-bold hover:bg-blue-100 transition-all">
                <span class="material-symbols-outlined">send</span>
                <span>Re-send Link</span>
              </button>
              
              ${s?`
              <button onclick="proctorAction('UNBLOCK', '${e}')" class="flex items-center justify-center gap-2 p-3 bg-gray-100 text-gray-700 border border-gray-300 rounded-lg font-bold hover:bg-gray-200 transition-all">
                <span class="material-symbols-outlined">check_circle</span>
                <span>Unblock Student</span>
              </button>`:`
              <button onclick="proctorAction('BLOCK', '${e}')" class="flex items-center justify-center gap-2 p-3 bg-red-50 text-red-600 border border-red-200 rounded-lg font-bold hover:bg-red-100 transition-all">
                <span class="material-symbols-outlined">block</span>
                <span>Block Student</span>
              </button>`}
            </div>
          </div>
          
          <div class="space-y-2">
            <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Details</h4>
            <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg text-sm space-y-2 border border-gray-200 dark:border-gray-700">
              <div class="flex justify-between">
                <span class="text-gray-500">Email</span>
                <span class="text-gray-900 dark:text-white font-mono">${y(n.email)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">Attempt Count</span>
                <span class="text-gray-900 dark:text-white font-mono">${n.attemptCount||0}</span>
              </div>
              
              <!-- Telemetry -->
              <div class="border-t border-gray-200 dark:border-gray-700 my-2 pt-2"></div>
              
              <div class="flex justify-between">
                <span class="text-gray-500">Time Spent</span>
                <span class="text-gray-900 dark:text-white font-mono">${n.timeOnQuestionMs?Math.round(n.timeOnQuestionMs/1e3)+"s":"--"}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">Calculator Used</span>
                <span class="font-bold border px-1.5 rounded text-xs ${n.usingCalculator?"text-amber-600 bg-amber-50 border-amber-200":"text-gray-400 border-gray-200"}">
                  ${n.usingCalculator?"YES":"NO"}
                </span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">Confidence</span>
                <span class="text-gray-900 dark:text-white">${n.confidence?n.confidence.replace("-"," ").toUpperCase():"--"}</span>
              </div>
              
               ${i?`
               <div class="border-t border-gray-200 dark:border-gray-700 my-2 pt-2"></div>
               <div class="flex justify-between">
                <span class="text-red-500 font-bold">Details</span>
                <span class="text-red-600 font-mono text-xs">${y(n.lastViolationReason||"Unknown Violation")}</span>
               </div>
               `:""}
               
            </div>
          </div>
        </div>
      `;t.innerHTML=o,t.classList.remove("hidden"),t.offsetWidth,t.classList.remove("translate-x-full")}}}function Or(){var e=document.getElementById("student-inspector-panel");e&&(e.classList.add("translate-x-full"),setTimeout(function(){e.classList.add("hidden")},300))}window.closeStudentInspector=Or,window.proctorAction=_r,window.resendLinkToStudent=jl;async function jl(e){if(confirm("Re-send the unique poll link to "+e+"?")){var n=document.getElementById("send-link-btn"),t=n&&n.dataset.className;if(t||f&&f.className&&(t=f.className),!t){D("Error: Could not determine class name","error");return}var a=window.location.origin+"/student.html";D("info","Sending Link","Preparing email for "+e+"...");try{var r=await tt({action:"SEND_EMAILS",className:t,pollId:f.pollId}),i=r.data;if(!i.success)throw new Error("Could not retrieve student link data");var s=i.links.find(function(m){return m.email===e});if(!s)throw new Error("Student not found in roster for this class");var d=(f.sessionType||"").toUpperCase().includes("SECURE"),o=a+"?token="+s.token,l=us(s.name,o,d,e),c={subject:i.subject,students:[{email:e,name:s.name,subject:i.subject,body:l}]},u=await firebase.functions().httpsCallable("sendEmail")(c),g=u.data;if(g.success&&g.sentCount>0)D("success","Link Sent","Email sent to "+e);else throw new Error(g.error||"Failed to send email")}catch(m){console.error(m),D("error","Send Failed",m.message)}}}function _r(e,n){if(confirm("Are you sure you want to "+e+" this student?")){if(!f||!f.pollId){console.error("[Proctor] No active poll data found."),D("Error: No active poll found","error");return}var t=firebase.functions().httpsCallable("manageProctoring");t({action:e,pollId:f.pollId,studentEmail:n}).then(function(a){console.log("[Proctor] Action success:",a),D("Action "+e+" successful","success"),Or()}).catch(function(a){console.error("[Proctor] Action failed:",a),F(a)})}}function Wl(e){if(typeof e!="number"||isNaN(e))return"--";var n=Math.max(0,Math.floor(e/1e3)),t=Math.floor(n/60),a=n%60;return t+"m "+(a<10?"0"+a:a)+"s"}function Gl(e){if(!e)return"";var n=e.isIdle?"bg-amber-400":"bg-emerald-400",t=typeof e.timeOnQuestion=="number"?Wl(e.timeOnQuestion):"",a=e.usingCalculator?'<span class="material-symbols-outlined text-sm text-blue-500">calculate</span>':"",r=t?"<span>"+t+"</span>":"";return`<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] bg-slate-100 text-slate-700 mr-2">
        <span class="h-2.5 w-2.5 rounded-full ${n}"></span>
        <span>${e.isIdle?"Idle":"Active"}</span>
        ${a}
        ${r}
      </span>`}function Dt(){if(!(Te||!je||Be)){var e=f.pollId,n=f.questionIndex;!e||n===void 0||Je||(console.warn("[Firebase] Connection lost, attempting reconnect..."),qe&&qe.once("value").then(function(t){t.exists()&&console.log("[Firebase] Reconnected, refreshing data...")}))}}var he=90,ue=90,$e=!1,ye=!1,U=90,de=!1,rt=window.SecureAssessmentShared.createCountdown({onTick:function(e){U=e,ue=e,ht()},onExpire:function(){Kl()}});function bt(e){var n=Math.max(0,Math.round(e||0)),t=Math.floor(n/60),a=n%60,r=("0"+t).slice(-2),i=("0"+a).slice(-2);return r+":"+i}function Hr(){var e=document.getElementById("hud-pace-value");if(e){var n=document.getElementById("hud-pace-caption"),t=document.getElementById("hud-pace-chip"),a=document.getElementById("hud-pace-chip-icon"),r=document.getElementById("hud-pace-chip-label");e.textContent=bt(U);var i="ready",s="Timer ready",d="pause_circle",o="Ready";U<=0?(i="complete",s="All time used",d="task_alt",o="Complete"):de?U<=15?(i="critical",s="Wrap up now",d="emergency",o="Critical"):(i="running",s="Timer running",d="play_arrow",o="Running"):U<he&&(i="paused",s="Paused â€” extend or resume",d="pause_circle",o="Paused"),n&&(n.textContent=s),t&&t.setAttribute("data-variant",i),a&&(a.textContent=d),r&&(r.textContent=o)}}function ht(){var e=document.getElementById("timer-display");if(e){e.value=bt(U),de?document.title=bt(U)+" - Veritas Live Poll":document.title="Veritas Live Poll",ue=U;var n=document.getElementById("timer-main-container");document.getElementById("timer-compact-container");var t=document.getElementById("timer-display-compact");t&&(t.value=bt(U)),n&&(n.classList.remove("timer-safe","timer-warning","timer-critical"),de&&U>0&&(U<15?n.classList.add("timer-critical"):U<=30?n.classList.add("timer-warning"):n.classList.add("timer-safe"))),Hr()}}function dn(e){de=e,ye=e;var n=document.getElementById("start-btn"),t=document.getElementById("pause-btn"),a=document.getElementById("add-10s-btn"),r=document.getElementById("subtract-10s-btn"),i=document.getElementById("timer-display"),s=document.getElementById("add-30s-btn-preset"),d=document.getElementById("add-60s-btn-preset"),o=document.getElementById("mobile-start-btn"),l=document.getElementById("mobile-pause-btn"),c=document.getElementById("mobile-timer-label"),u=document.getElementById("timer-display-compact"),g=document.getElementById("add-10s-btn-mobile"),m=document.getElementById("subtract-10s-btn-mobile");n&&n.classList.toggle("hidden",e),t&&t.classList.toggle("hidden",!e),o&&o.classList.toggle("hidden",e),l&&l.classList.toggle("hidden",!e),c&&(e?c.textContent="Running":U<he?c.textContent="Resume":c.textContent="Start"),a&&(a.disabled=e),r&&(r.disabled=e),i&&(i.disabled=e),s&&(s.disabled=e),d&&(d.disabled=e),g&&(g.disabled=e),m&&(m.disabled=e),u&&(u.disabled=e),Hr()}function Pa(){if(console.log("[Timer] startTimer called. isRunning:",de,"totalSeconds:",U),de||U<=0){console.log("[Timer] Cannot start - already running or no time");return}dn(!0),re("Timer runningâ€¦","info"),rt.start(U),console.log("[Timer] Timer started")}function cn(){de&&(rt.pause(),dn(!1),re("Timer paused at "+bt(U)+".","info"))}function cs(){rt.stop(),U=he,ue=U,$e=!1,rt.set(U),dn(!1);var e=document.getElementById("timer-display");e&&e.classList.remove("timer-finished"),re("Timer reset to "+bt(he)+".","info"),document.title="Veritas Live Poll"}function Kl(){rt.stop(),dn(!1);var e=document.getElementById("timer-display");e&&(e.classList.add("timer-finished"),setTimeout(function(){e.classList.remove("timer-finished")},1e3)),$e||($e=!0,ue=0,U=0,ht(),re("Time expired â€” poll paused.","danger"),firebase.functions().httpsCallable("setLiveSessionState")({pollId:f.pollId,status:"PAUSED",questionIndex:f.questionIndex||0,metadata:{reason:"TIMER_EXPIRED"}}).then(function(n){var t=n.data;t&&t.success?(Te=!0,vt(t)):F(t.error||"Failed to pause poll on timer expiry")}).catch(F))}function Ye(e){de||(U+=e,U<0&&(U=0),ue=U,he=U,rt.set(U))}function Pt(){if(!de){var e=document.getElementById("timer-display");if(e){var n=e.value,t=0,a=0;if(n.includes(":")){var r=n.split(":");t=parseInt(r[0],10)||0,a=parseInt(r[1],10)||0,U=t*60+a}else if(n.trim()!==""){var i=parseInt(n,10)||0;U=i}ue=U,he=U,rt.set(U),Hr()}}}function re(e,n){var t=document.getElementById("timer-status-message");t&&(t.textContent=e,n==="danger"?t.className="text-xs text-red-600 dark:text-red-400 text-center font-medium":n==="success"?t.className="text-xs text-green-600 dark:text-green-400 text-center font-medium":t.className="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 text-center")}function Ut(){cn()}function yt(){rt.stop(),de=!1,ye=!1}function Ft(){ue!==U&&(U=ue),ht()}function us(e,n,t,a){var r=t?"Secure Assessment Session":"Live Poll Session",i=t?"Your personalized link for today's secure assessment is ready. Please click the button below to begin.":"Your personalized link for today's live poll is ready. Please click the button below to begin.";return`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
    <title>VERITAS Live Poll</title>
    <style>
        /* BASE STYLES */
        body { margin: 0; padding: 0; width: 100% !important; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; color: #333333; line-height: 1.6; }
        .container { max-width: 600px; margin: 40px auto; padding: 0; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .content-padding { padding: 30px; }
        /* TYPOGRAPHY */
        h1, p, li, span, div, a { font-size: 16px; }
        h1 { margin: 0 0 16px 0; font-weight: 700; color: #12385d; letter-spacing: -0.5px; }
        p { margin: 0 0 16px 0; }
        /* BUTTON */
        .btn { display: inline-block; background-color: #12385d; color: #ffffff !important; text-decoration: none; padding: 14px 35px; border-radius: 4px; font-weight: 600; margin: 10px 0; }
        .btn:hover { background-color: #0f2f4d; }
        /* UTILS */
        .divider { height: 1px; background-color: #e5e7eb; margin: 20px 0; border: none; }
        .text-muted { color: #6b7280; }
        .footer { font-size: 12px; color: #9ca3af; margin-top: 30px; text-align: center; }
        .instructions-list { padding-left: 18px; color: #4b5563; margin-bottom: 0; }
        .instructions-list li { margin-bottom: 8px; }
        /* RESPONSIVE */
        @media screen and (max-width: 600px) {
            .container { margin: 0; border-radius: 0; }
            .content-padding { padding: 20px; }
            .btn { display: block; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div style="background-color: #12385d; padding: 20px 30px;">
            <span style="font-weight: 700; font-size: 26px; color: #ffffff;">VERITAS</span> 
            <span style="color: #c5a05a; margin: 0 8px; font-size: 26px;">|</span>
            <span style="color: #e5e7eb; font-size: 22px;">${r}</span>
        </div>
        <div class="content-padding">
            <p>Hello <strong>${e}</strong>,</p>
            <p>${i}</p>
            <div style="text-align: center;">
                <a href="${n}" class="btn">Begin Session</a>
            </div>
            <hr class="divider">
            <div style="background-color: #ffdcdc; padding: 20px; border-radius: 6px; border: 1px solid #fed7d7;">
                <p style="font-weight: 600; margin-bottom: 12px; margin-top: 0; color: #c53030;">Important Instructions:</p>
                <ul class="instructions-list" style="margin: 0;">
                    <li>You must remain in fullscreen mode throughout the entire session.</li>
                    <li>Don't navigate to other tabs or applications.</li>
                    <li>Do not refresh the browser to prevent disconnection.</li>
                </ul>
            </div>
            <div class="footer">
                <p style="margin-bottom: 8px;">ðŸ”’ This is a unique link for <strong>${a}</strong>. Do not share it.</p>
                <p style="margin-bottom: 0;">&copy; 2025 VERITAS</p>
            </div>
        </div>
    </div>
</body>
</html>`}async function zr(){console.log("[onSendLink] Triggered");var e=_e||document.getElementById("send-link-btn");if(!e){console.warn("Missing send link button");return}var n=e&&e.dataset.className;if(!n){await S("Please select a poll first.",{title:"Send poll links"});return}var t=await Ke("This will email a new, unique poll link to all students in "+n+". Are you sure?",{title:"Send poll links",confirmText:"Send links"});if(t){var a=$&&!$.disabled;$&&(Y($,!1),$.disabled=!0,$.setAttribute("aria-disabled","true")),Y(e,!0,"Sending...");var r=window.location.origin+"/student.html";tt({action:"SEND_EMAILS",className:n,pollId:f.pollId}).then(function(i){var s=i.data;if(!s.success)throw new Error("Could not prepare email data");s.baseUrl=r;var d=(f.sessionType||"").toUpperCase().includes("SECURE");return s.students=s.links.map(function(o){var l=r+"?token="+o.token,c=us(o.name,l,d,o.email);return{email:o.email,name:o.name,subject:s.subject,body:c}}),firebase.functions().httpsCallable("sendEmail")(s).then(function(o){var l=o.data;if(Y(e,!1),$&&a&&($.disabled=!1,$.removeAttribute("aria-disabled")),l.success)S("Emails processed for "+l.sentCount+" students.",{title:"Emails Processed"});else{var c="Sent: "+(l.sentCount||0)+", Failed: "+(l.failedCount||0)+".";l.failures&&l.failures.length>0&&(c+=`

Failures:
`+l.failures.map(function(u){return u.name+": "+u.error}).join(`
`)),l.error&&(c="Error: "+l.error),S(c,{title:"Email Delivery Report",destructive:!0}),$&&($.click(),D("info","Fallback","Opening link list for manual distribution.",4e3))}})}).catch(function(i){Y(e,!1),F(i)})}}async function Ua(){var e=$;if(!e){console.warn("Missing view links button");return}var n=e&&e.dataset.className;if(!n){await S("Please select a poll first.",{title:"View links"});return}Y(e,!0,"Loading...");var t=window.location.origin+"/student.html";tt({action:"GET_LINKS",className:n}).then(function(a){var r=a.data;if(!r.success)return F(new Error("Could not load links"));var i=document.getElementById("links-container"),s='<div class="overflow-x-auto"><table class="w-full border-collapse">';s+='<thead><tr class="bg-brand-light-gray dark:bg-brand-dark-gray/50 border-b-2 border-brand-light-gray dark:border-brand-dark-gray/40">',s+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Student Name</th>',s+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Email</th>',s+='<th class="px-4 py-3 text-left text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Link</th>',s+='<th class="px-4 py-3 text-center text-sm font-semibold text-brand-dark-gray dark:text-brand-white">Actions</th>',s+="</tr></thead><tbody>",r.links.forEach(function(d){var o=t+"?token="+d.token;s+='<tr class="border-b border-brand-light-gray/50 dark:border-brand-dark-gray/20 hover:bg-brand-light-gray/30 dark:hover:bg-brand-dark-gray/10">',s+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+y(d.name)+"</td>",s+='<td class="px-4 py-3 text-sm text-brand-dark-gray dark:text-brand-white">'+y(d.email)+"</td>",s+='<td class="px-4 py-3 text-xs font-mono text-brand-dark-gray/70 dark:text-brand-white/70 max-w-[200px] truncate" title="'+y(o)+'">'+y(o)+"</td>",s+='<td class="px-4 py-3 text-center">',s+='<button class="copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors" data-url="'+y(o)+'">Copy</button>',s+="</td></tr>"}),s+="</tbody></table></div>",i.innerHTML=s,i.querySelectorAll(".copy-link-btn").forEach(function(d){d.onclick=async function(){var o=this.dataset.url;try{if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")await navigator.clipboard.writeText(o);else{await S("Automatic copy is not supported in this browser. Please copy the link manually.",{title:"Copy link"});return}d.textContent="âœ“ Copied!",d.className="copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-green-600 text-brand-white",setTimeout(function(){d.textContent="Copy",d.className="copy-link-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-primary text-brand-white hover:bg-primary/90 transition-colors"},2e3)}catch{await S("Could not copy link. Please copy it manually.",{title:"Copy link",destructive:!0})}}}),ft.parentElement!==document.body&&document.body.appendChild(ft),ft.classList.remove("hidden"),ft.style.cssText="display: flex !important; visibility: visible !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: 99999 !important; background-color: rgba(0,0,0,0.6) !important;",ft.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden",Y(e,!1)}).catch(function(a){F(a),Y(e,!1)})}function $l(){ft.classList.add("hidden"),ft.style.display="none",ft.style.cssText="",document.body.style.overflow=""}var un=document.getElementById("poll-preview-modal");document.getElementById("editor-sidebar");var Yl=document.getElementById("preview-poll-name"),Xl=document.getElementById("preview-poll-meta"),Vr=document.getElementById("preview-questions-nav");document.getElementById("editor-question-input");var fs=document.getElementById("editor-timer-input"),ms=document.getElementById("editor-img-preview-container"),Jl=document.getElementById("editor-img-thumbnail"),gs=document.getElementById("editor-options-list");document.getElementById("true-preview-container");var Zl=document.getElementById("preview-student-stem"),Qr=document.getElementById("preview-student-visual"),ps=document.getElementById("preview-student-options"),H=null,ge=0,Vn=null,ze=!1,xt=null;function vs(e){var n=V.find(function(t){return t.pollId===e});if(!n){D("error","Error","Poll not found.");return}H=JSON.parse(JSON.stringify(n)),H.questions||(H.questions=[]),H.questions.length===0&&H.questions.push(ed()),ge=0,ze=!1,Yl.textContent=n.pollName||"Untitled Poll",td(),nd(),jr(),hs(0),un.parentElement!==document.body&&document.body.appendChild(un),un.style.display="flex",un.classList.remove("hidden"),document.body.style.overflow="hidden",document.addEventListener("keydown",bs)}function Fa(){ze&&!confirm("You have unsaved changes. Are you sure you want to close?")||(un.style.display="none",un.classList.add("hidden"),document.body.style.overflow="",document.removeEventListener("keydown",bs),H=null)}function bs(e){e.key==="Escape"&&Fa(),(e.metaKey||e.ctrlKey)&&e.key==="s"&&(e.preventDefault(),id())}function ed(){return{questionText:"New Question",options:[{text:"Option A",imageURL:""},{text:"Option B",imageURL:""},{text:"Option C",imageURL:""},{text:"Option D",imageURL:""}],correctAnswer:"A",timerSeconds:60,questionImageURL:""}}function td(){var e=H.questions.length,n=H.className||"No Class";Xl.textContent=n+" â€¢ "+e+" Question"+(e!==1?"s":""),document.getElementById("preview-question-count-badge").textContent=e}function jr(){Vr.innerHTML="",H.questions.forEach(function(e,n){var t=document.createElement("div");t.className="group flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all border border-transparent "+(n===ge?"bg-veritas-navy/5 border-veritas-navy/10 shadow-sm":"hover:bg-gray-50 dark:hover:bg-gray-800"),t.draggable=!0;var a=document.createElement("span");a.className="material-symbols-outlined text-gray-400 text-lg cursor-grab active:cursor-grabbing opacity-0 group-hover:opacity-100 transition-opacity",a.textContent="drag_indicator";var r=document.createElement("span");r.className="text-xs font-bold w-5 h-5 flex items-center justify-center rounded bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 "+(n===ge?"bg-veritas-navy text-white dark:bg-veritas-navy dark:text-white":""),r.textContent=n+1;var i=document.createElement("div");i.className="flex-1 min-w-0";var s=document.createElement("div");s.innerHTML=e.questionText||"New Question";var d=s.textContent||s.innerText||"New Question";i.innerHTML='<p class="text-xs font-semibold text-gray-700 dark:text-gray-200 truncate">'+y(d)+"</p>",t.appendChild(a),t.appendChild(r),t.appendChild(i),t.onclick=function(){hs(n)},t.addEventListener("dragstart",function(o){xt=n,o.dataTransfer.effectAllowed="move",t.classList.add("opacity-50")}),t.addEventListener("dragend",function(){t.classList.remove("opacity-50"),xt=null}),t.addEventListener("dragover",function(o){o.preventDefault(),o.dataTransfer.dropEffect="move"}),t.addEventListener("drop",function(o){if(o.preventDefault(),xt!==null&&xt!==n){var l=H.questions.splice(xt,1)[0];H.questions.splice(n,0,l),ge===xt?ge=n:xt<ge&&n>=ge?ge--:xt>ge&&n<=ge&&ge++,jr(),ze=!0}}),Vr.appendChild(t)})}function nd(){Vn||(Vn=Oe.init("editor-question-input","","Type your question here...",function(e){H&&(H.questions[ge].questionText=e.html,fn(),jr(),ze=!0)}))}function hs(e){ge=e;for(var n=H.questions[e],t=Vr.children,a=0;a<t.length;a++)a===e?(t[a].classList.add("bg-veritas-navy/5","border-veritas-navy/10"),t[a].classList.remove("hover:bg-gray-50"),t[a].querySelector("span.w-5").classList.add("bg-veritas-navy","text-white")):(t[a].classList.remove("bg-veritas-navy/5","border-veritas-navy/10"),t[a].classList.add("hover:bg-gray-50"),t[a].querySelector("span.w-5").classList.remove("bg-veritas-navy","text-white"));if(document.getElementById("editor-current-num").textContent=e+1,Vn){var r=Vn.clipboard.convert(n.questionText||"");Vn.setContents(r,"silent")}fs.value=n.timerSeconds||60,fs.onchange=function(){n.timerSeconds=parseInt(this.value)||60,ze=!0},n.questionImageURL?(Jl.src=n.questionImageURL,ms.classList.remove("hidden")):ms.classList.add("hidden"),Oa(),fn()}function Oa(){gs.innerHTML="";var e=H.questions[ge];e.options.forEach(function(n,t){var a=String.fromCharCode(65+t),r=e.correctAnswer===a,i=document.createElement("div");i.className="flex flex-col gap-2 bg-white dark:bg-brand-dark-gray p-3 rounded-lg border "+(r?"border-green-500 ring-1 ring-green-500/20":"border-gray-200 dark:border-gray-700");var s=document.createElement("div");s.className="flex items-center gap-3 w-full";var d=document.createElement("label");d.className="flex-shrink-0 flex items-center justify-center w-8 h-8 rounded-full border cursor-pointer transition-colors "+(r?"bg-green-500 border-green-500 text-white":"bg-gray-50 border-gray-300 hover:border-gray-400 text-gray-400"),d.innerHTML='<span class="text-sm font-bold">'+a+'</span><input type="radio" name="correct_answer" class="hidden" '+(r?"checked":"")+">",d.onclick=function(){e.correctAnswer=a,Oa(),fn(),ze=!0};var o=document.createElement("input");o.type="text",o.value=n.text||"",o.placeholder="Answer option "+a,o.className="flex-1 min-w-0 px-3 py-1.5 rounded-md border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-veritas-navy/50 outline-none text-sm",o.oninput=function(){n.text=this.value,fn(),ze=!0};var l=document.createElement("div");l.className="flex items-center gap-1";var c=document.createElement("label");c.className="p-1.5 text-gray-400 hover:text-veritas-navy cursor-pointer transition-colors rounded hover:bg-gray-100",c.title="Add Image",c.innerHTML='<span class="material-symbols-outlined text-lg">image</span><input type="file" class="hidden" accept="image/*" onchange="handleOptionImageUpload('+t+', this)">';var u=document.createElement("button");if(u.className="p-1.5 text-gray-400 hover:text-red-500 transition-colors rounded hover:bg-gray-100",u.innerHTML='<span class="material-symbols-outlined text-lg">close</span>',u.title="Remove Option",u.onclick=function(){rd(t)},l.appendChild(c),l.appendChild(u),s.appendChild(d),s.appendChild(o),s.appendChild(l),i.appendChild(s),n.imageURL){var g=document.createElement("div");g.className="pl-11 relative group inline-block";var m=document.createElement("img");m.src=n.imageURL,m.className="h-20 w-auto rounded border border-gray-200 object-contain bg-gray-50";var p=document.createElement("button");p.className="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-500 text-white rounded-full p-0.5 shadow-sm opacity-0 group-hover:opacity-100 transition-opacity",p.innerHTML='<span class="material-symbols-outlined text-[12px]">close</span>',p.onclick=function(){ad(t)},g.appendChild(m),g.appendChild(p),i.appendChild(g)}gs.appendChild(i)})}function ad(e){var n=H.questions[ge];n.options[e]&&(n.options[e].imageURL="",Oa(),fn(),ze=!0)}function rd(e){var n=H.questions[ge];if(n.options.length<=2){D("warning","Cannot Remove","Minimum 2 options required.");return}n.options.splice(e,1);var t=n.correctAnswer;e<n.correctAnswer.charCodeAt(0)-65?t=String.fromCharCode(n.correctAnswer.charCodeAt(0)-1):e===n.correctAnswer.charCodeAt(0)-65&&(t="A"),n.correctAnswer=t,Oa(),fn(),ze=!0}function fn(){var e=H.questions[ge];Zl.innerHTML=e.questionText||'<span class="text-gray-400 italic">Start typing your question...</span>',e.questionImageURL?(Qr.querySelector("img").src=e.questionImageURL,Qr.classList.remove("hidden")):Qr.classList.add("hidden"),ps.innerHTML="",e.options.forEach(function(n,t){var a=String.fromCharCode(65+t),r=e.correctAnswer===a,i=document.createElement("div");i.className="student-option flex flex-col gap-2 "+(r?"correct-preview":"");var s=document.createElement("div");s.className="flex items-center gap-3 w-full";var d=document.createElement("div");d.className="student-badge",d.textContent=a;var o=document.createElement("div");if(o.className="text-sm font-medium flex-1 break-words",o.textContent=n.text||"Option "+a,s.appendChild(d),s.appendChild(o),r){var l=document.createElement("span");l.className="material-symbols-outlined text-green-500 text-lg",l.textContent="check_circle",s.appendChild(l)}if(i.appendChild(s),n.imageURL){var c=document.createElement("img");c.src=n.imageURL,c.className="w-full h-32 object-contain rounded border border-gray-100 bg-white ml-2",i.appendChild(c)}ps.appendChild(i)})}function id(){if(!ze){Fa();return}var e=document.getElementById("preview-save-btn");e.disabled=!0,e.innerHTML='<div class="h-4 w-4 border-2 border-white/50 border-t-white rounded-full animate-spin"></div> Saving...',firebase.functions().httpsCallable("updatePoll")({pollId:H.pollId,pollName:H.pollName,className:H.className,questions:H.questions,metadata:{sessionType:H.sessionType||"live",timeLimitMinutes:H.timeLimitMinutes||null,accessCode:H.accessCode||"",availableFrom:H.availableFrom||"",dueBy:H.dueBy||"",secureSettings:H.secureSettings||{}}}).then(function(n){if(n.data&&n.data.success){D("success","Saved","Poll updated successfully."),ze=!1;var t=V.findIndex(a=>a.pollId===H.pollId);t!==-1&&(V[t]=H),Fa()}else throw new Error("Save failed")}).catch(function(n){D("error","Save Failed",n.message),e.disabled=!1,e.innerHTML='<span class="material-symbols-outlined text-lg">save</span> Save & Close'})}function sd(){return yn+=1,"q-"+yn}function _a(e){if(!e)return e;if(!e._id)e._id=sd();else{var n=String(e._id).match(/q-(\d+)/);if(n){var t=parseInt(n[1],10);!isNaN(t)&&t>yn&&(yn=t)}}return typeof e._createdOrder!="number"&&(e._createdOrder=Date.now()),e}function Ha(e,n){if(e){var t=j.indexOf(e);if(t!==-1){typeof n=="number"&&n!==t&&(j.splice(t,1),n>j.length&&(n=j.length),j.splice(n,0,e));return}typeof n=="number"&&n>=0&&n<=j.length?j.splice(n,0,e):j.push(e)}}function od(e){if(e){var n=j.indexOf(e);n!==-1&&j.splice(n,1)}}function ys(e){var n=new Map;I.forEach(function(a){a&&a._id&&n.set(a._id,a)});var t=[];return(e||[]).forEach(function(a){n.has(a)&&(t.push(n.get(a)),n.delete(a))}),n.forEach(function(a){t.push(a)}),t}function Ot(e){var n=e||I[L]&&I[L]._id||null,t=ys(j);if(I=t,j=t.map(function(r){return r._id}),I.length===0){L=0;return}if(n){var a=I.findIndex(function(r){return r&&r._id===n});a!==-1?L=a:L>=I.length&&(L=Math.max(0,I.length-1))}else L>=I.length&&(L=Math.max(0,I.length-1))}function Wr(){Fi&&(Fi.textContent="Drag questions to reorder them manually.")}function ld(){if(!(!sa||sa.length===0)){var e=I[L]&&I[L]._id,n=ys(sa);I=n,j=n.map(function(t){return t._id}),Ot(e),Et(),ie(),z(),Wr()}}function za(){pt&&pt.querySelectorAll(".question-nav-item").forEach(function(e){e.classList.remove("drop-before","drop-after")})}function xs(){pt&&pt.querySelectorAll(".question-nav-item").forEach(function(e){e.classList.remove("drop-before","drop-after","dragging")})}function ws(e,n){if(e){var t=j.indexOf(e);t!==-1&&(n>j.length&&(n=j.length),n>t&&n--,n!==t&&(j.splice(t,1),j.splice(n,0,e),Ot(e),Et(),ie(),z()))}}function dd(e){if(be=this.dataset.questionId||null,!!be){this.classList.add("dragging"),e.dataTransfer.effectAllowed="move";try{e.dataTransfer.setData("text/plain",be)}catch{}}}function cd(e){if(be){var n=this.dataset.questionId;if(!(!n||n===be)){e.preventDefault(),za();var t=this.getBoundingClientRect(),a=e.clientY-t.top<t.height/2;a?(this.classList.add("drop-before"),this.classList.remove("drop-after")):(this.classList.add("drop-after"),this.classList.remove("drop-before"))}}}function ud(){this.classList.contains("question-nav-item")&&this.classList.remove("drop-before","drop-after")}function fd(e){if(be){var n=this.dataset.questionId;if(!(!n||n===be)){e.preventDefault(),e.stopPropagation();var t=this.getBoundingClientRect(),a=e.clientY-t.top<t.height/2;za();var r=j.indexOf(n);if(r!==-1){var i=a?r:r+1;ws(be,i),be=null}}}}function md(){xs(),be=null}function gd(e){be&&(e.preventDefault(),za())}function pd(e){be&&e.target===pt&&(e.preventDefault(),za(),ws(be,j.length),be=null)}function Es(e){var n=document.getElementById("save-status");n&&(n.textContent=e)}function z(){Es("Unsaved changes")}function Is(e){Es(e||"All changes saved")}function Xe(e){if(!e)return"LIVE_POLL";var n=e.toString().toUpperCase();return n==="LIVE"||n==="LIVE_POLL"?"LIVE_POLL":n==="SECURE_ASSESSMENT"||n==="SECURE"||n==="INDIVIDUAL_TIMED"?"SECURE_ASSESSMENT":"LIVE_POLL"}function wt(e){return Xe(e)==="SECURE_ASSESSMENT"}function Gr(){Tn&&Tn.forEach(function(e){var n=Xe(e.dataset.sessionType)===Xe(ut);n?(e.classList.add("bg-primary","text-brand-white"),e.classList.remove("text-brand-dark-gray","dark:text-brand-white/70")):(e.classList.remove("bg-primary","text-brand-white"),e.classList.add("text-brand-dark-gray","dark:text-brand-white/70"))})}function Va(){mr&&(wt(ut)?mr.classList.remove("hidden"):mr.classList.add("hidden"))}function ks(e){if(!e)return"";var n=new Date(e);if(isNaN(n.getTime()))return"";var t=n.getFullYear(),a=String(n.getMonth()+1).padStart(2,"0"),r=String(n.getDate()).padStart(2,"0"),i=String(n.getHours()).padStart(2,"0"),s=String(n.getMinutes()).padStart(2,"0");return t+"-"+a+"-"+r+"T"+i+":"+s}function Ls(e){if(!e)return"";var n=new Date(e);return isNaN(n.getTime())?"":n.toISOString()}function Kr(){Xt&&(Xt.value=typeof xe.timeLimitMinutes=="number"?xe.timeLimitMinutes:""),Jt&&(Jt.value=xe.accessCode||""),Zt&&(Zt.value=ks(xe.availableFrom)),en&&(en.value=ks(xe.dueBy))}function Qn(){if(Xt){var e=parseInt(Xt.value,10);xe.timeLimitMinutes=isNaN(e)?"":e}return Jt&&(xe.accessCode=(Jt.value||"").trim().toUpperCase()),Zt&&(xe.availableFrom=Ls(Zt.value)),en&&(xe.dueBy=Ls(en.value)),{timeLimitMinutes:typeof xe.timeLimitMinutes=="number"?xe.timeLimitMinutes:null,accessCode:xe.accessCode||"",availableFrom:xe.availableFrom||"",dueBy:xe.dueBy||""}}function vd(){xe={timeLimitMinutes:60,accessCode:"",availableFrom:"",dueBy:""},Kr()}function $r(e,n){ut=Xe(e),Gr(),Va(),n||z()}function bd(){var e=Qn();return{sessionType:ut,timeLimitMinutes:e.timeLimitMinutes,accessCode:e.accessCode,availableFrom:e.availableFrom,dueBy:e.dueBy,secureSettings:{timeLimitMinutes:e.timeLimitMinutes,accessCode:e.accessCode,availableFrom:e.availableFrom,dueBy:e.dueBy,fullscreenRequired:wt(ut),proctoringRules:["Fullscreen required","No tab switching","Mission Control monitoring"]}}}function hd(e){console.warn("Legacy openPollCreator called. Redirecting to Wizard."),typeof ea=="function"?(ea(),na(e)):console.error("New Wizard not found.")}function Cs(){ba&&(ba.style.display="none",ba.classList.add("hidden"),ba.style.cssText=""),document.body.style.overflow="",I=[],L=0,Qt=null,document.getElementById("save-poll-btn").innerHTML='<span class="truncate">Publish Poll</span>',Is("All changes saved"),j=[],sa=[],yn=0,be=null,Wr(),vd(),$r("LIVE_POLL",!0),Va()}var _t=[],it=new Set;function yd(){var e=document.getElementById("question-bank-modal");e&&(e.style.display="flex",xd())}function Ss(){var e=document.getElementById("question-bank-modal");e&&(e.style.display="none"),it.clear(),As()}function xd(){var e=document.getElementById("bank-questions-container");document.getElementById("bank-poll-filter"),e&&(e.innerHTML='<p class="text-center text-brand-dark-gray/60 py-8">Loading questions from your polls...</p>',(function(){try{var n=[];(V||[]).forEach(function(t){!t||!t.questions||t.questions.forEach(function(a,r){n.push({pollId:t.pollId,pollName:t.pollName,questionIndex:r,questionText:a.questionText||"",answers:a.answers||a.options||[],topicTag:a.topicTag||a.topic||"",difficultyLevel:a.difficultyLevel||""})})}),_t=n,Yr(),wd()}catch(t){console.error("Question Bank synthesis failed:",t),e.innerHTML='<p class="text-center text-red-600 py-8">Failed to synthesize question bank: '+t.message+"</p>"}})())}function wd(){var e=document.getElementById("bank-poll-filter");if(e){var n=[...new Set(_t.map(function(t){return t.pollName}))];e.innerHTML='<option value="">All Polls ('+_t.length+" questions)</option>",n.forEach(function(t){var a=_t.filter(function(r){return r.pollName===t}).length;e.innerHTML+='<option value="'+y(t)+'">'+y(t)+" ("+a+")</option>"}),e.onchange=function(){Yr(this.value)}}}function Yr(e){var n=document.getElementById("bank-questions-container");if(n){var t=e?_t.filter(function(a){return a.pollName===e}):_t;if(t.length===0){n.innerHTML='<p class="text-center text-brand-dark-gray/60 py-8">No questions found in your question bank.</p>';return}n.innerHTML=t.map(function(a,r){var i=it.has(a.pollId+":"+a.questionIndex),s=a.difficultyLevel?'<span class="text-xs px-2 py-0.5 rounded-full '+(a.difficultyLevel==="easy"?"bg-green-100 text-green-700":a.difficultyLevel==="medium"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700")+'">'+a.difficultyLevel+"</span>":"";return'<div class="bank-question-item p-4 rounded-lg border cursor-pointer transition-colors '+(i?"border-amber-500 bg-amber-50 dark:bg-amber-900/20":"border-brand-light-gray dark:border-brand-dark-gray/40 hover:bg-brand-light-gray/30")+'" data-bank-key="'+a.pollId+":"+a.questionIndex+'"><div class="flex items-start justify-between gap-3"><div class="flex-1"><p class="text-sm font-medium text-brand-dark-gray dark:text-brand-white line-clamp-2">'+y(a.questionText||"No question text")+'</p><div class="flex flex-wrap items-center gap-2 mt-2"><span class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60">'+y(a.pollName)+"</span>"+(a.topicTag?'<span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300">'+y(a.topicTag)+"</span>":"")+s+'</div></div><div class="flex-shrink-0"><span class="material-symbols-outlined text-xl '+(i?"text-amber-600":"text-brand-light-gray")+'">'+(i?"check_circle":"radio_button_unchecked")+"</span></div></div></div>"}).join(""),n.querySelectorAll(".bank-question-item").forEach(function(a){a.onclick=function(){var r=this.dataset.bankKey;it.has(r)?it.delete(r):it.add(r),Yr(document.getElementById("bank-poll-filter")?.value),As()}})}}function As(){var e=document.getElementById("bank-selected-count"),n=document.getElementById("import-selected-btn"),t=it.size;e&&(e.textContent=t+" question"+(t!==1?"s":"")+" selected"),n&&(n.disabled=t===0)}function Ed(){it.size!==0&&(it.forEach(function(e){var n=e.split(":"),t=n[0],a=parseInt(n[1],10),r=_t.find(function(s){return s.pollId===t&&s.questionIndex===a});if(r){var i={questionText:r.questionText||"",answers:(r.answers||[]).map(function(s){return typeof s=="string"?{text:s}:{text:s.text||"",imageURL:s.imageURL||null}}),correctAnswerIndex:0,metacognitionEnabled:!1,topicTag:r.topicTag||"",difficultyLevel:r.difficultyLevel||""};i.answers.length<2&&(i.answers=[{text:""},{text:""}]),_a(i),I.push(i),Ha(i._id)}}),Ot(),Et(),ie(),z(),Ss(),S(it.size+" question(s) imported successfully!",{title:"Question Bank"}))}var jn={"Unit 1":{name:"Chemistry of Life",weight:"8-11%",topics:["1.1 Structure of Water and Hydrogen Bonding","1.2 Elements of Life","1.3 Introduction to Biological Macromolecules","1.4 Properties of Biological Macromolecules","1.5 Structure and Function of Biological Macromolecules","1.6 Nucleic Acids"]},"Unit 2":{name:"Cell Structure and Function",weight:"10-13%",topics:["2.1 Cell Structure: Subcellular Components","2.2 Cell Structure and Function","2.3 Cell Size","2.4 Plasma Membranes","2.5 Membrane Permeability","2.6 Membrane Transport","2.7 Facilitated Diffusion","2.8 Tonicity and Osmoregulation","2.9 Mechanisms of Transport","2.10 Cell Compartmentalization","2.11 Origins of Cell Compartmentalization"]},"Unit 3":{name:"Cellular Energetics",weight:"12-16%",topics:["3.1 Enzyme Structure","3.2 Enzyme Catalysis","3.3 Environmental Impacts on Enzyme Function","3.4 Cellular Energy","3.5 Photosynthesis","3.6 Cellular Respiration","3.7 Fitness"]},"Unit 4":{name:"Cell Communication and Cell Cycle",weight:"10-15%",topics:["4.1 Cell Communication","4.2 Introduction to Signal Transduction","4.3 Signal Transduction","4.4 Changes in Signal Transduction Pathways","4.5 Feedback","4.6 Cell Cycle","4.7 Regulation of Cell Cycle"]},"Unit 5":{name:"Heredity",weight:"8-11%",topics:["5.1 Meiosis","5.2 Meiosis and Genetic Diversity","5.3 Mendelian Genetics","5.4 Non-Mendelian Genetics","5.5 Environmental Effects on Phenotype","5.6 Chromosomal Inheritance"]},"Unit 6":{name:"Gene Expression and Regulation",weight:"12-16%",topics:["6.1 DNA and RNA Structure","6.2 Replication","6.3 Transcription and RNA Processing","6.4 Translation","6.5 Regulation of Gene Expression","6.6 Gene Expression and Cell Specialization","6.7 Mutations"]},"Unit 7":{name:"Natural Selection",weight:"13-20%",topics:["7.1 Introduction to Natural Selection","7.2 Natural Selection","7.3 Artificial Selection","7.4 Population Genetics","7.5 Hardy-Weinberg Equilibrium","7.6 Evidence of Evolution","7.7 Common Ancestry","7.8 Continuing Evolution","7.9 Phylogeny","7.10 Speciation","7.11 Extinction","7.12 Variations in Populations","7.13 Origin of Life on Earth"]},"Unit 8":{name:"Ecology",weight:"10-15%",topics:["8.1 Responses to the Environment","8.2 Energy Flow Through Ecosystems","8.3 Population Ecology","8.4 Effect of Density of Populations","8.5 Community Ecology","8.6 Biodiversity","8.7 Disruptions to Ecosystems"]}};function Id(){var e=document.getElementById("ai-suggestions-modal");e&&(e.style.display="flex",kd(),Ld())}function Ts(){var e=document.getElementById("ai-suggestions-modal");e&&(e.style.display="none")}function kd(){var e=document.getElementById("ai-current-question");if(e){var n=I[L];n&&n.questionText?e.textContent='"'+n.questionText.substring(0,150)+(n.questionText.length>150?"...":"")+'"':e.textContent='"No question text entered"'}}function Ld(){var e=document.getElementById("apbio-unit-select"),n=document.getElementById("apbio-topic-select"),t=document.getElementById("apbio-preview");document.getElementById("apbio-tag-preview"),e.value="",n.innerHTML='<option value="">-- Select Unit First --</option>',n.disabled=!0,document.getElementById("bigidea-evo").checked=!1,document.getElementById("bigidea-ene").checked=!1,document.getElementById("bigidea-ist").checked=!1,document.getElementById("bigidea-syi").checked=!1,t.classList.add("hidden");var a=I[L];if(a&&a.topicTag){var r=a.topicTag,i=r.match(/Unit \d/);i&&(e.value=i[0],Bs(i[0]))}e.onchange=function(){Bs(this.value),Xr()},n.onchange=Xr,["bigidea-evo","bigidea-ene","bigidea-ist","bigidea-syi"].forEach(function(s){document.getElementById(s).onchange=Xr})}function Bs(e){var n=document.getElementById("apbio-topic-select");if(!e||!jn[e]){n.innerHTML='<option value="">-- Select Unit First --</option>',n.disabled=!0;return}var t=jn[e];n.innerHTML='<option value="">-- Select Topic --</option>',t.topics.forEach(function(a){var r=document.createElement("option");r.value=a,r.textContent=a,n.appendChild(r)}),n.disabled=!1}function Xr(){var e=document.getElementById("apbio-preview"),n=document.getElementById("apbio-tag-preview"),t=document.getElementById("apbio-unit-select"),a=document.getElementById("apbio-topic-select"),r=[];t.value&&jn[t.value]&&r.push(t.value+": "+jn[t.value].name),a.value&&r.push(a.value);var i=[];document.getElementById("bigidea-evo").checked&&i.push("EVO"),document.getElementById("bigidea-ene").checked&&i.push("ENE"),document.getElementById("bigidea-ist").checked&&i.push("IST"),document.getElementById("bigidea-syi").checked&&i.push("SYI"),i.length>0&&r.push("Big Ideas: "+i.join(", ")),r.length>0?(n.textContent=r.join(" | "),e.classList.remove("hidden")):e.classList.add("hidden")}function Cd(){var e=document.getElementById("apbio-unit-select"),n=document.getElementById("apbio-topic-select");if(!e.value){S("Please select a unit before applying the tag.",{title:"AP Bio Topic Tagger"});return}var t=[];e.value&&jn[e.value]&&t.push(e.value),n.value&&t.push(n.value);var a=[];document.getElementById("bigidea-evo").checked&&a.push("EVO"),document.getElementById("bigidea-ene").checked&&a.push("ENE"),document.getElementById("bigidea-ist").checked&&a.push("IST"),document.getElementById("bigidea-syi").checked&&a.push("SYI"),a.length>0&&t.push("["+a.join(", ")+"]");var r=t.join(" | ");I[L].topicTag=r,I[L].topic=r,I[L].apBioUnit=e.value,I[L].apBioTopic=n.value,I[L].apBioBigIdeas=a,z(),ie(),Ts(),S("AP Bio topic tag applied: "+r,{title:"Topic Tagged!"})}function qs(){var e=document.getElementById("stimulus-modal");e&&(e.style.display="flex",document.getElementById("stimulus-title-input").value="",document.getElementById("stimulus-content-input").value="",document.getElementById("stimulus-question-count").value="2")}function Jr(){var e=document.getElementById("stimulus-modal");e&&(e.style.display="none")}function Sd(){var e=(document.getElementById("stimulus-title-input").value||"").trim(),n=Oe.get("stimulus-content-editor"),t=n?n.root.innerHTML:"",a=n?n.getContents():null,r=n?n.getText():"";if(!t){var i=document.getElementById("stimulus-content-input");i&&(t=i.value)}var s=parseInt(document.getElementById("stimulus-question-count").value,10)||2;if(!e&&!r.trim()){S("Please enter a stimulus title or content.",{title:"Stimulus Required"});return}for(var d="stimulus-"+Date.now(),o=0;o<s;o++){var l={questionText:"",answers:[{text:""},{text:""}],correctAnswerIndex:0,metacognitionEnabled:!1,topicTag:"",difficultyLevel:"",stimulusId:d,stimulusTitle:e,stimulusHtml:t,stimulusDelta:a,stimulusText:r,stimulusContent:t,isStimulus:o===0};_a(l),I.push(l),Ha(l._id)}Jr(),Ot(),Et(),ie(),z(),S(s+' question(s) created with stimulus "'+(e||"Untitled")+'"',{title:"Stimulus Created"})}function Ad(e){var n=e===!0,t=I[L],a=j.length;if(t&&t._id){var r=j.indexOf(t._id);r!==-1&&(a=r+1)}var i={questionText:"",questionImage:null,questionImageURL:null,questionImageFileId:null,answers:[{text:"",image:null,imageURL:null,imageFileId:null},{text:"",image:null,imageURL:null,imageFileId:null}],correctAnswerIndex:0,timerSeconds:null,metacognitionEnabled:!1,shuffleOptions:!1};_a(i),I.push(i),Ha(i._id,a),Ot(i._id),n||z(),Et(),ie()}async function Td(e){if(I.length<=1){await S("A poll must have at least one question.",{title:"Edit poll"});return}var n=I[e],t=n&&n._id;I.splice(e,1),t&&od(t),L>=I.length&&(L=Math.max(0,I.length-1)),Ot(),Et(),ie(),z()}async function Bd(e){if(I.length>=50){await S("Maximum 50 questions per poll. Cannot duplicate.",{title:"Edit poll"});return}var n=I[e];if(n){var t=JSON.parse(JSON.stringify(n));delete t._id,delete t._createdOrder,_a(t),t._createdOrder=Date.now(),I.splice(e+1,0,t);var a=n._id?j.indexOf(n._id):-1,r=a===-1?j.length:a+1;Ha(t._id,r),Ot(t._id),Et(),ie(),z()}}function Et(){var e=document.getElementById("question-navigator");e.innerHTML="",be=null,xs(),I.forEach(function(n,t){var a=t===L,r=document.createElement("div");r.className="question-nav-item group relative flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer "+(a?"bg-primary/20 dark:bg-primary/30":"hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10");var i='<span class="material-symbols-outlined '+(a?"text-brand-dark-gray dark:text-brand-white":"text-brand-dark-gray/50 dark:text-brand-white/50")+'">drag_indicator</span>';i+='<p class="'+(a?"text-primary dark:text-brand-white":"text-brand-dark-gray dark:text-brand-white")+' text-sm font-medium leading-normal">Question '+(t+1)+"</p>",i+='<div class="absolute right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">',i+='<button class="duplicate-question-btn p-1 rounded-full hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10" data-index="'+t+'" title="Duplicate question">',i+='<span class="material-symbols-outlined text-brand-dark-gray dark:text-brand-white text-base">content_copy</span>',i+="</button>",I.length>1&&(i+='<button class="delete-question-btn p-1 rounded-full hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10" data-index="'+t+'" title="Delete question">',i+='<span class="material-symbols-outlined text-brand-dark-gray dark:text-brand-white text-base">close</span>',i+="</button>"),i+="</div>",r.innerHTML=i,r.dataset.questionId=n&&n._id?n._id:"question-"+t,r.dataset.index=t,r.setAttribute("draggable","true"),r.addEventListener("dragstart",dd),r.addEventListener("dragover",cd),r.addEventListener("dragleave",ud),r.addEventListener("drop",fd),r.addEventListener("dragend",md),r.onclick=function(o){o.target.classList.contains("material-symbols-outlined")&&(o.target.textContent==="close"||o.target.textContent==="content_copy")||(L=t,Et(),ie())};var s=r.querySelector(".duplicate-question-btn");s&&(s.onclick=function(o){o.stopPropagation(),Bd(parseInt(this.dataset.index))});var d=r.querySelector(".delete-question-btn");d&&(d.onclick=function(o){o.stopPropagation(),Td(parseInt(this.dataset.index))}),e.appendChild(r)})}function ie(){var e=document.getElementById("question-builder-workspace"),n=I[L],t='<div class="max-w-4xl mx-auto">';t+='<div class="flex flex-wrap justify-between gap-3 mb-6">',t+='<div class="flex min-w-72 flex-col gap-1">',t+='<p class="text-brand-dark-gray dark:text-brand-white tracking-light text-[32px] font-bold leading-tight">Question '+(L+1)+"</p>",t+='<p class="text-brand-dark-gray/60 dark:text-brand-white/60 text-sm font-normal leading-normal">Edit the question and answer choices below.</p>',t+="</div></div>",t+='<div class="bg-brand-white dark:bg-brand-dark-gray/20 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/30 p-6 shadow-sm mb-6">',t+='<label class="flex flex-col w-full">',t+='<p class="text-brand-dark-gray dark:text-brand-white text-base font-medium leading-normal pb-2">Question Text</p>',t+='<textarea id="question-text-input" class="form-input flex w-full min-w-0 flex-1 resize-y overflow-hidden rounded-lg text-brand-dark-gray dark:text-brand-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 focus:border-primary min-h-36 placeholder:text-brand-dark-gray/50 dark:placeholder:text-brand-white/50 p-[15px] text-base font-normal leading-normal" placeholder="Type your question here...">'+y(n.questionText||"")+"</textarea>",t+="</label>",t+='<div class="grid w-full max-w-xs items-center gap-1.5 mt-4">',t+='<label for="question-image-input" class="text-sm text-gray-400 font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Question Image</label>',t+='<input id="question-image-input" type="file" accept="image/*" class="flex h-10 w-full rounded-md border border-brand-light-gray dark:border-brand-dark-gray/50 bg-white dark:bg-brand-dark-gray/30 px-3 py-2 text-sm text-gray-400 file:border-0 file:bg-transparent file:text-gray-600 dark:file:text-gray-300 file:text-sm file:font-medium focus:outline-none focus:ring-2 focus:ring-primary/50">',t+="</div>";var a=Zr(n.questionImage||n.questionImageURL,n.questionImageFileId),r=n.questionImage==="UPLOADING";(a||r)&&(t+='<div class="mt-4 flex flex-wrap items-center gap-3 bg-primary/5 dark:bg-primary/10 p-3 rounded-lg">',r?(t+='<div class="flex items-center gap-2 text-primary dark:text-brand-white">',t+='<div class="h-5 w-5 animate-spin rounded-full border-2 border-primary border-t-transparent"></div>',t+='<span class="text-sm font-medium">Uploading image...</span>',t+="</div>"):a&&(t+='<img src="'+a+'" class="rounded-lg max-w-xs h-auto" referrerpolicy="no-referrer">',t+='<button type="button" class="remove-question-image-btn h-9 px-4 rounded-lg bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-sm font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors">Remove Image</button>'),t+="</div>"),t+='<div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">',t+="<div>",t+='<label class="text-brand-dark-gray dark:text-brand-white text-sm font-medium leading-normal block pb-2" for="question-topic-input">Topic/Standard Tag</label>',t+='<input id="question-topic-input" type="text" class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="e.g., Cell Division, Algebra, etc." value="'+y(n.topicTag||n.topic||"")+'">',t+='<p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-1">Used for topic-level analytics.</p>',t+="</div>",t+="<div>",t+='<label class="text-brand-dark-gray dark:text-brand-white text-sm font-medium leading-normal block pb-2" for="question-difficulty-select">Difficulty Level</label>',t+='<select id="question-difficulty-select" class="w-full rounded-lg border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">';var i=n.difficultyLevel||"";t+='<option value=""'+(i===""?" selected":"")+">-- Select --</option>",t+='<option value="easy"'+(i==="easy"?" selected":"")+">ðŸŸ¢ Easy</option>",t+='<option value="medium"'+(i==="medium"?" selected":"")+">ðŸŸ¡ Medium</option>",t+='<option value="hard"'+(i==="hard"?" selected":"")+">ðŸ”´ Hard</option>",t+="</select>",t+='<p class="text-xs text-brand-dark-gray/60 dark:text-brand-white/60 mt-1">Compare predicted vs actual difficulty.</p>',t+="</div>",t+='<div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700/30 rounded-lg p-3">',t+='<div class="flex items-start gap-2">',t+='<input type="checkbox" id="question-metacognition-input" class="mt-0.5 h-4 w-4 rounded border-blue-300 dark:border-blue-600 text-blue-600 focus:ring-blue-500 cursor-pointer" '+(n.metacognitionEnabled?"checked":"")+" />",t+='<div class="flex-1">',t+='<label for="question-metacognition-input" class="text-brand-dark-gray dark:text-brand-white text-xs font-semibold leading-normal cursor-pointer block">Enable Metacognition Assessment</label>',t+='<p class="text-xs text-brand-dark-gray/70 dark:text-brand-white/70 mt-1">Ask students how confident they are in their answer.</p>',t+="</div>",t+="</div>",t+="</div>",t+='<div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-700/30 rounded-lg p-3">',t+='<div class="flex items-start gap-2">',t+='<input type="checkbox" id="question-shuffle-input" class="mt-0.5 h-4 w-4 rounded border-purple-300 dark:border-purple-600 text-purple-600 focus:ring-purple-500 cursor-pointer" '+(n.shuffleOptions?"checked":"")+" />",t+='<div class="flex-1">',t+='<label for="question-shuffle-input" class="text-brand-dark-gray dark:text-brand-white text-xs font-semibold leading-normal cursor-pointer block">Randomize Answer Order</label>',t+='<p class="text-xs text-brand-dark-gray/70 dark:text-brand-white/70 mt-1">Shuffle answer choices for each student (reduces cheating).</p>',t+="</div>",t+="</div>",t+="</div>",t+="</div>",t+="</div>",t+='<div class="bg-brand-white dark:bg-brand-dark-gray/20 rounded-xl border border-brand-light-gray dark:border-brand-dark-gray/30 p-6 shadow-sm">',t+='<p class="text-brand-dark-gray dark:text-brand-white text-base font-medium leading-normal pb-4">Answer Choices</p>',t+='<div class="flex flex-col gap-4">',n.answers.forEach(function(g,m){t+=qd(g,m,n.correctAnswerIndex===m)}),t+="</div>",t+='<div class="mt-4">',t+='<button id="add-answer-btn" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-brand-light-gray dark:bg-brand-dark-gray/40 text-brand-dark-gray dark:text-brand-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-brand-light-gray/80 dark:hover:bg-brand-dark-gray/60 transition-colors">',t+='<span class="truncate">+ Add Answer Choice</span>',t+="</button></div></div></div>",e.innerHTML=t,document.getElementById("question-text-input").oninput=function(){I[L].questionText=this.value,z()};var s=document.getElementById("question-image-input");s&&(s.onchange=function(){if(this.files&&this.files[0]){var g=this.files[0],m=I[L];m.questionImage="UPLOADING",m.questionImageURL=null,ie(),Ns(g).then(function(p){I[L].questionImageFileId=p,I[L].questionImage=null,I[L].questionImageURL=null,z(),ie()}).catch(async function(p){await S("Image upload failed: "+(p.message||p),{title:"Upload image",destructive:!0}),I[L].questionImage=null,I[L].questionImageFileId=null,I[L].questionImageURL=null,ie()})}});var d=e.querySelector(".remove-question-image-btn");d&&(d.onclick=function(){I[L].questionImage=null,I[L].questionImageURL=null,I[L].questionImageFileId=null,z(),ie()});var o=document.getElementById("question-topic-input");o&&(o.oninput=function(){I[L].topicTag=this.value.trim(),I[L].topic=this.value.trim(),z()});var l=document.getElementById("question-metacognition-input");l&&(l.onchange=function(){I[L].metacognitionEnabled=this.checked,z()});var c=document.getElementById("question-shuffle-input");c&&(c.onchange=function(){I[L].shuffleOptions=this.checked,z()});var u=document.getElementById("question-difficulty-select");u&&(u.onchange=function(){I[L].difficultyLevel=this.value,z()}),document.getElementById("add-answer-btn").onclick=function(){I[L].answers.push({text:"",image:null,imageURL:null,imageFileId:null}),z(),ie()},e.querySelectorAll(".answer-text-input").forEach(function(g,m){g.oninput=function(){I[L].answers[m].text=this.value,z()}}),e.querySelectorAll(".correct-radio").forEach(function(g,m){g.onchange=function(){this.checked&&(I[L].correctAnswerIndex=m,z())}}),e.querySelectorAll(".delete-answer-btn").forEach(function(g,m){g.onclick=function(){Nd(m)}}),e.querySelectorAll(".answer-image-input").forEach(function(g,m){g.onchange=function(){if(this.files&&this.files[0]){var p=this.files[0],b=I[L].answers[m];b.image="UPLOADING",b.imageURL=null,ie(),Ns(p).then(function(h){I[L].answers[m].imageFileId=h,I[L].answers[m].image=null,I[L].answers[m].imageURL=null,z(),ie()}).catch(async function(h){await S("Image upload failed: "+(h.message||h),{title:"Upload image",destructive:!0}),I[L].answers[m].image=null,I[L].answers[m].imageFileId=null,I[L].answers[m].imageURL=null,ie()})}}}),e.querySelectorAll(".remove-answer-image-btn").forEach(function(g){g.onclick=function(){var m=parseInt(this.dataset.index,10);I[L].answers[m].image=null,I[L].answers[m].imageURL=null,I[L].answers[m].imageFileId=null,z(),ie()}})}function qd(e,n,t){var a='<div class="flex items-center gap-3">';a+='<label class="relative flex items-center justify-center cursor-pointer" title="Set as correct answer">',a+='<input class="correct-radio peer h-5 w-5 cursor-pointer appearance-none rounded-full border border-brand-light-gray dark:border-brand-white/30 checked:border-primary checked:bg-primary transition-all" name="correct_answer" type="radio" '+(t?"checked":"")+"/>",a+='<span class="material-symbols-outlined absolute text-brand-white transition-opacity opacity-0 peer-checked:opacity-100 text-sm">check</span>',a+="</label>",a+='<input class="answer-text-input form-input flex-1 rounded-lg text-brand-dark-gray dark:text-brand-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-brand-light-gray dark:border-brand-dark-gray/50 bg-background-light dark:bg-brand-dark-gray/30 focus:border-primary placeholder:text-brand-dark-gray/50 dark:placeholder:text-brand-white/50 p-3 text-base" placeholder="Answer '+String.fromCharCode(65+n)+'" type="text" value="'+y(e.text||"")+'"/>',a+='<label class="p-2 rounded-lg hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10 transition-colors cursor-pointer" title="Upload image for this answer">',a+='<span class="material-symbols-outlined text-brand-dark-gray/60 dark:text-brand-white/60">image</span>',a+='<input type="file" class="answer-image-input hidden" accept="image/*">',a+="</label>",I[L].answers.length>2?(a+='<button class="delete-answer-btn p-2 rounded-lg hover:bg-brand-dark-gray/10 dark:hover:bg-brand-white/10 transition-colors" title="Remove this answer">',a+='<span class="material-symbols-outlined text-brand-dark-gray/60 dark:text-brand-white/60">delete</span>',a+="</button>"):a+='<div class="w-10"></div>',a+="</div>";var r=Zr(e.image||e.imageURL,e.imageFileId),i=e.image==="UPLOADING";return(r||i)&&(a+='<div class="mt-2 flex items-center gap-3 bg-primary/5 dark:bg-primary/10 p-2 rounded-lg">',i?(a+='<div class="flex items-center gap-2 text-primary dark:text-brand-white">',a+='<div class="h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent"></div>',a+='<span class="text-xs font-medium">Uploading...</span>',a+="</div>"):r&&(a+='<img src="'+r+'" class="rounded-md max-w-[160px] h-auto" referrerpolicy="no-referrer">',a+='<button type="button" class="remove-answer-image-btn h-8 px-3 rounded-md bg-red-600/10 text-red-600 dark:text-red-300 dark:bg-red-500/20 text-xs font-semibold hover:bg-red-600/20 dark:hover:bg-red-500/30 transition-colors" data-index="'+n+'">Remove</button>'),a+="</div>"),a}async function Nd(e){if(I[L].answers.length<=2){await S("A question must have at least two answer choices.",{title:"Edit poll"});return}I[L].answers.splice(e,1),I[L].correctAnswerIndex>=e&&(I[L].correctAnswerIndex=Math.max(0,I[L].correctAnswerIndex-1)),z(),ie()}function Md(e){return!e||typeof e!="string"?"":"https://drive.google.com/thumbnail?id="+encodeURIComponent(e)+"&sz=w1000"}function Zr(e,n){return n&&typeof n=="string"?Md(n):e instanceof File?URL.createObjectURL(e):typeof e=="string"&&e?e==="UPLOADING"?"":e:""}async function Rd(){var e=document.getElementById("save-poll-btn"),n=Qt?'<span class="truncate">Save Changes</span>':'<span class="truncate">Publish Poll</span>';e.disabled=!0,e.innerHTML='<div class="h-5 w-5 animate-spin rounded-full border-2 border-primary border-t-transparent"></div><span>Saving...</span>';var t=document.getElementById("new-poll-name").value.trim(),a=(mt.value||"").trim(),r=Xe(ut),i=bd();if(i.sessionType=r,!t||!a){await S("Please enter a poll name and select a class.",{title:"Save poll"}),e.disabled=!1,e.innerHTML=n;return}if(wt(r)&&(!i.timeLimitMinutes||i.timeLimitMinutes<=0)){await S("Secure Assessments require a positive time limit.",{title:"Save poll"}),e.disabled=!1,e.innerHTML=n;return}if(I.length===0){await S("Please add at least one question.",{title:"Save poll"}),e.disabled=!1,e.innerHTML=n;return}var s="";if(I.forEach(function(x,C){if(!s){var R=(x.questionText||"").trim();if(R===""){s="Question "+(C+1)+" needs question text.";return}var N=x.answers.map(function(E){return(E.text||"").trim()}),Q=N.filter(function(E){return E!==""});if(Q.length<2){s="Question "+(C+1)+" must include at least two answer choices with text.";return}var G=typeof x.correctAnswerIndex=="number"?x.correctAnswerIndex:0;if(G<0||G>=N.length){s="Question "+(C+1)+" has an invalid correct answer selection.";return}N[G]===""&&(s="Question "+(C+1)+" must mark a correct answer with text.")}}),s){await S(s,{title:"Save poll"}),e.disabled=!1,e.innerHTML=n;return}var d=!1,o=[];if(I.forEach(function(x,C){x.questionImage==="UPLOADING"&&(d=!0,o.push("Question "+(C+1)+" image is still uploading. Please wait for upload to complete.")),x.answers.forEach(function(R,N){R.image==="UPLOADING"&&(d=!0,o.push("Question "+(C+1)+", answer "+(N+1)+" image is still uploading. Please wait for upload to complete."))})}),d){await S(o.join(`
`),{title:"Save poll"}),e.disabled=!1,e.innerHTML=n;return}var l=I.map(function(x){var C=x.answers.map(function(Q){var G=(Q.text||"").trim();return{text:G,imageFileId:Q.imageFileId||null,imageURL:Q.imageURL||null}}),R=typeof x.correctAnswerIndex=="number"?x.correctAnswerIndex:0;R<0&&(R=0),R>=C.length&&(R=Math.max(0,C.length-1));var N=null;return typeof x.timerSeconds=="number"?N=x.timerSeconds:typeof x.timerSeconds=="string"&&x.timerSeconds.trim()!==""&&(N=parseInt(x.timerSeconds,10)),N&&(!isFinite(N)||N<=0)&&(N=null),N&&(N=Math.min(Math.round(N),600)),{questionText:(x.questionText||"").trim(),questionImageFileId:x.questionImageFileId||null,questionImageURL:x.questionImageURL||null,answers:C,correctAnswerIndex:R,timerSeconds:N&&N>0?N:null,metacognitionEnabled:!!x.metacognitionEnabled}});try{var c=l.map(function(x){var C=x.answers.map(function(E){var A=E.imageURL||null,B=E.imageFileId||null;return{text:E.text,image:A,imageURL:A,imageFileId:B}}),R=x.correctAnswerIndex;(R<0||R>=C.length)&&(R=Math.max(0,C.length-1));var N=C[R]?C[R].text:null,Q=x.questionImageURL||null,G=x.questionImageFileId||null;return{questionText:x.questionText,questionImage:Q,questionImageURL:Q,questionImageFileId:G,options:C,correctAnswer:N,timerSeconds:x.timerSeconds||null,metacognitionEnabled:!!x.metacognitionEnabled}});if(!c||c.length===0){await S("âŒ Error: No valid questions to save. Please check your poll data.",{title:"Save poll",destructive:!0}),e.disabled=!1,e.innerHTML=n;return}var u=c.length;console.log("Saving poll with "+u+" questions");var g,m;try{var p={sessionType:r,timeLimitMinutes:i.timeLimitMinutes,accessCode:i.accessCode,availableFrom:i.availableFrom,dueBy:i.dueBy,secureSettings:i.secureSettings},b;if(Qt){var h=firebase.functions().httpsCallable("updatePoll");b=await h({pollId:Qt,pollName:t,className:a,questions:c,metadata:p})}else{var w=firebase.functions().httpsCallable("createPoll");b=await w({pollName:t,className:a,questions:c,metadata:p})}if(b.data&&b.data.success){fo.invalidate("dashboardData"),await ka(),Is("All changes saved"),e.disabled=!1,e.innerHTML=n;var q=Qt?"âœ… Poll updated successfully with "+u+" question"+(u===1?"":"s")+"!":"âœ… Poll created successfully with "+u+" question"+(u===1?"":"s")+"!";console.log(q);var T=!Qt;Cs(),T&&(ne.value="",Nt()),await S(q,{title:"Save poll"})}else throw new Error(b.data?.error||"Failed to save poll")}catch(x){console.error("Firebase poll save error:",x),typeof Ht=="function"?Ht(x):await S("âŒ Error saving poll: "+(x.message||x),{title:"Save poll",destructive:!0}),e.disabled=!1,e.innerHTML=n}}catch(x){console.error("Upload/save error:",x),await S("âŒ Upload error: "+(x.message||x),{title:"Save poll",destructive:!0}),e.disabled=!1,e.innerHTML=n}}function Dd(e){return new Promise(function(n,t){if(!e){t(new Error("No file provided"));return}if(!(e instanceof File)){t(new Error("Invalid file object"));return}if(!e.type.startsWith("image/")){t(new Error("File must be an image"));return}if(e.size===0){t(new Error("File is empty"));return}if(e.size>5*1024*1024){t(new Error("File exceeds 5MB limit"));return}var a=new FileReader;a.readAsDataURL(e),a.onload=function(){a.result&&typeof a.result=="string"?n(a.result):t(new Error("Failed to read file data"))},a.onerror=function(r){t(new Error("File read error: "+(r.message||"Unknown error")))}})}function Ns(e){return new Promise(function(n,t){if(!e){t(new Error("No file provided for upload"));return}if(!e.name){t(new Error("File has no name"));return}Dd(e).then(function(a){if(!a||typeof a!="string"){t(new Error("Invalid data URL generated from file"));return}var r=0,i=3;function s(){r++;var d=firebase.storage().ref(),o=Date.now(),l=(e.name||"image").replace(/[^a-zA-Z0-9.-]/g,"_"),c="poll-images/uploads/"+o+"-"+l,u=d.child(c);u.putString(a,"data_url").then(function(g){return g.ref.getDownloadURL()}).then(function(g){console.log("[Firebase Storage] Upload success:",g),n(g)}).catch(function(g){console.error("[Firebase Storage] Upload failed:",g);var m=(g.message||"").toString(),p=m.includes("retry")||m.includes("network");p&&r<i?(console.warn("Upload attempt "+r+" failed. Retrying...",g),setTimeout(s,r*2e3)):t(new Error(g.message||"Image upload failed"))})}s()}).catch(function(a){t(new Error("File conversion error: "+(a.message||a)))})})}function st(e){if(!e)return"â€”";var n=new Date(e);return isNaN(n.getTime())?e:n.toLocaleString()}function mn(e,n){var t=document.getElementById(e);t&&(typeof n=="string"&&n.includes("<")&&n.includes(">")?(t.innerHTML=tr(n),nr()):t.textContent=n||"")}function Ms(e,n){var t=document.getElementById(e);t&&(t.innerHTML=tr(n),nr())}var ee,Ce,ei=!1,ti=0,ni=0,Rs="#059669",Qa=4,ai="pen";function Pd(){var e=document.getElementById("lcb-whiteboard-toggle");e&&e.addEventListener("click",Ds);var n=document.getElementById("wb-close-btn");n&&n.addEventListener("click",Ds);var t=document.getElementById("wb-clear-btn");if(t&&t.addEventListener("click",Ud),ee=document.getElementById("wb-canvas"),!!ee){Ce=ee.getContext("2d"),window.addEventListener("resize",Ps),ee.addEventListener("mousedown",Fd),ee.addEventListener("mousemove",Od),ee.addEventListener("mouseup",Us),ee.addEventListener("mouseout",Us),ee.addEventListener("touchstart",function(r){var i=r.touches[0],s=new MouseEvent("mousedown",{clientX:i.clientX,clientY:i.clientY});ee.dispatchEvent(s)},!1),ee.addEventListener("touchmove",function(r){var i=r.touches[0],s=new MouseEvent("mousemove",{clientX:i.clientX,clientY:i.clientY});ee.dispatchEvent(s)},!1),ee.addEventListener("touchend",function(r){var i=new MouseEvent("mouseup",{});ee.dispatchEvent(i)},!1);var a=document.querySelectorAll(".wb-tool");a.forEach(function(r){r.addEventListener("click",function(){a.forEach(function(s){s.classList.remove("active","scale-110","ring-2","ring-offset-2","ring-indigo-500")}),r.classList.add("active","scale-110","ring-2","ring-offset-2","ring-indigo-500");var i=r.dataset.mode;i==="eraser"?(ai="eraser",Qa=20):(ai="pen",Rs=r.dataset.color,Qa=parseInt(r.dataset.size)||4)})})}}function Ds(){var e=document.getElementById("whiteboard-overlay");if(e){var n=e.classList.contains("hidden");n?(e.classList.remove("hidden"),Ps()):e.classList.add("hidden")}}function Ps(){if(ee){var e=ee.parentElement;e&&(ee.width=e.clientWidth,ee.height=e.clientHeight)}}function Ud(){!ee||!Ce||Ce.clearRect(0,0,ee.width,ee.height)}function Fd(e){ei=!0;var n=ee.getBoundingClientRect();ti=e.clientX-n.left,ni=e.clientY-n.top}function Od(e){if(ei){var n=ee.getBoundingClientRect(),t=e.clientX-n.left,a=e.clientY-n.top;Ce.beginPath(),Ce.moveTo(ti,ni),Ce.lineTo(t,a),Ce.lineCap="round",Ce.lineJoin="round",ai==="eraser"?(Ce.globalCompositeOperation="destination-out",Ce.lineWidth=Qa):(Ce.globalCompositeOperation="source-over",Ce.strokeStyle=Rs,Ce.lineWidth=Qa),Ce.stroke(),ti=t,ni=a}}function Us(){ei=!1}function Ve(e){if(!e)return"";if(typeof e=="string"){var n=e.trim();if(!n)return"";var t=n.split(/\s+/).filter(Boolean);return t.length>=2?t[0]+" "+t[t.length-1]:t[0]||""}var a=(e.firstName||"").trim(),r=(e.lastName||"").trim();return a||r?(a+" "+r).trim():e.displayName?Ve(e.displayName):e.name?Ve(e.name):e.email?e.email:""}async function F(e){ce.style.display="none",console.error("Error:",e);var n=(e&&e.message?e.message:e)||"Unknown error",t=String(n);typeof n=="string"&&n.indexOf("Error: ")===0&&(n=n.substring(7)),(t.includes("NetworkError")||t.includes("HTTP 0")||t.includes("Connection failure"))&&(n="Network connection interrupted. Please check your internet connection and try again."),await S(n,{title:"Something went wrong",destructive:!0})}window.expandQuestionImage=function(){var e=document.getElementById("live-question-image").src,n='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;" onclick="this.remove()">';n+='<img src="'+e+'" style="max-width:90%;max-height:90%;"/>',n+="</div>",document.body.insertAdjacentHTML("beforeend",n)};var Fs=document.getElementById("view-analytics-btn");Fs&&Fs.addEventListener("click",function(){kn&&fl(kn)});var Os=document.getElementById("close-analytics-modal-btn");Os&&Os.addEventListener("click",function(){document.getElementById("post-poll-analytics-modal").style.display="none"}),document.getElementById("post-poll-analytics-modal").addEventListener("click",function(e){e.target===this&&(this.style.display="none")});var _s=document.getElementById("filter-locked-only-btn");_s&&_s.addEventListener("click",function(){Rt="locked";var e=document.getElementById("student-status-filter-select");e&&(e.value="locked"),fa(),Ee()});var Hs=document.getElementById("filter-all-btn");Hs&&Hs.addEventListener("click",function(){Rt="all";var e=document.getElementById("student-status-filter-select");e&&(e.value="all"),fa(),Ee()}),fa();var zs=document.getElementById("dismiss-violations-alert");zs&&zs.addEventListener("click",function(){document.getElementById("violations-alert-panel").classList.add("hidden")});var Vs=document.getElementById("approve-all-unlocks-btn");Vs&&Vs.addEventListener("click",_l);var Qs=document.getElementById("toggle-exited-panel-btn");Qs&&Qs.addEventListener("click",function(){var e=document.getElementById("exited-students-list-inline");if(e){var n=this.querySelector(".material-symbols-outlined");e.style.display==="none"?(e.style.display="",n&&(n.textContent="expand_more")):(e.style.display="none",n&&(n.textContent="expand_less"))}});var Kn=document.getElementById("add-30s-btn-preset");Kn&&Kn.addEventListener("click",function(){de||Ye(30)});var $n=document.getElementById("add-60s-btn-preset");$n&&$n.addEventListener("click",function(){de||Ye(60)});var Wn=document.getElementById("view-cards-btn"),Gn=document.getElementById("view-table-btn");if(Wn&&Gn&&Me&&Fe){Wn.classList.add("active"),Wn.addEventListener("click",function(){Me.classList.remove("hidden"),Fe.classList.add("hidden"),Wn.classList.add("active"),Gn.classList.remove("active"),localStorage.setItem("vlp_poll_view","cards")}),Gn.addEventListener("click",function(){Me.classList.add("hidden"),Fe.classList.remove("hidden"),Gn.classList.add("active"),Wn.classList.remove("active"),localStorage.setItem("vlp_poll_view","table")});var _d=localStorage.getItem("vlp_poll_view");_d==="table"&&Gn.click()}document.addEventListener("keydown",function(e){if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||e.target.isContentEditable)&&je)switch(e.key){case"ArrowRight":case"n":case"N":e.preventDefault();var n=document.getElementById("header-next-btn");n&&!n.disabled&&n.offsetParent!==null&&n.click();break;case"ArrowLeft":case"b":case"B":e.preventDefault();var t=document.getElementById("header-back-btn");t&&!t.disabled&&t.offsetParent!==null&&t.click();break;case" ":case"Spacebar":e.preventDefault(),de?cn():U>0&&Pa();break;case"r":case"R":e.preventDefault(),de||cs();break;case"e":case"E":e.preventDefault();var a=document.getElementById("header-end-show-btn");a&&!a.disabled&&a.offsetParent!==null&&a.click();break}}),window.checkAllRespondedState=function(e){if(je){var n=document.getElementById("header-next-btn");if(n){var t=f.questionIndex>=f.totalQuestions-1;e&&!t?n.classList.add("pulse-ready"):n.classList.remove("pulse-ready")}}};var Kn=document.getElementById("add-30s-btn-preset");Kn&&Kn.addEventListener("click",function(){de||Ye(30)});var $n=document.getElementById("add-60s-btn-preset");$n&&$n.addEventListener("click",function(){de||Ye(60)}),window.onStartPoll=Pr,window.onSendLink=zr,window.onViewLinks=Ua,window.initializeDashboardBindings=ji,window.onPollSelectChange=Nt,console.log("âœ“ Teacher Panel Ready (Enhanced UI)"),(function(){var n={firebasePresent:typeof firebase<"u",configPresent:typeof FIREBASE_CONFIG<"u"&&!!FIREBASE_CONFIG,databaseURL:typeof FIREBASE_CONFIG<"u"&&FIREBASE_CONFIG?FIREBASE_CONFIG.databaseURL:null,appsLengthBefore:typeof firebase<"u"&&firebase.apps?firebase.apps.length:"n/a",initCalled:!1,success:!1};if(typeof firebase<"u"&&FIREBASE_CONFIG){if(firebase.apps.length)n.success=!0;else try{n.initCalled=!0,n.success=!0}catch(t){console.error("[Firebase] Failed to initialize app:",t),n.error=t.message}firebase.apps.length>0&&(ct=firebase.database(),firebase.functions&&(oa=firebase.functions())),n.appsLengthAfter=firebase.apps.length}else typeof firebase>"u"&&console.error("[Firebase] SDK not loaded! Check script tags in Teacher_View.html"),FIREBASE_CONFIG||console.error("[Firebase] FIREBASE_CONFIG not available!");console.log("[Firebase Init] databaseURL="+n.databaseURL+", firebasePresent="+n.firebasePresent+", appsLength="+n.appsLengthAfter+", initCalled="+n.initCalled+", success="+n.success)})();async function Hd(e,n){if(!(!e||!n)){if(!f||!f.questions||!f.questions.length){console.error("[Broadcast] CRITICAL: CURRENT_POLL_DATA is not populated!",{hasCURRENT_POLL_DATA:!!f,hasQuestions:!!(f&&f.questions),questionCount:f&&f.questions?f.questions.length:0}),D("error","System Error","Cannot broadcast question: Poll data not loaded. Please refresh and try again.");return}var t=typeof n.questionIndex=="number"&&n.questionIndex>=0&&n.questionIndex<f.questions.length?f.questions[n.questionIndex]:null;if(!t){console.error("[Broadcast] CRITICAL: Question definition not found for index:",n.questionIndex,{totalQuestions:f.questions.length}),D("error","System Error","Cannot broadcast question: Question not found at index "+n.questionIndex);return}var a=n.questionText||t.questionText||"",r=n.options||t.options||[];if(!a||r.length===0){console.error("[Broadcast] CRITICAL: Incomplete question data!",{questionIndex:n.questionIndex,hasText:!!a,optionsCount:r.length,questionDef:t}),D("error","Invalid Question","This question is missing text or answer options. Please check the question and try again.");return}if(console.log("[Broadcast] Validated question data:",{questionIndex:n.questionIndex,textLength:a.length,optionsCount:r.length}),firebase&&firebase.functions)try{var i=firebase.functions().httpsCallable("setLiveSessionState");console.log("[Firebase] Calling Cloud Function: setLiveSessionState...");var s=n.correctAnswer||(t?t.correctAnswer:null),d=await i({pollId:e,status:n.status||"OPEN",questionIndex:n.questionIndex,questionText:a,correctAnswer:s,options:r,shuffleOptions:t.shuffleOptions||!1});console.log("[Firebase] Cloud Function Success:",d.data);return}catch(u){console.warn("[Firebase] Cloud Function failed userspace, falling back to legacy RTDB write:",u)}if(ct){var o="sessions/"+e+"/live_session",l=ct.ref(o),c={pollId:e,questionIndex:n.questionIndex,status:n.status||"OPEN",timestamp:firebase.database.ServerValue.TIMESTAMP,sessionPhase:n.sessionPhase||"LIVE",resultsVisibility:n.resultsVisibility||"HIDDEN",questionText:a,questionImageURL:n.questionImageURL||(t?t.questionImageURL:""),options:r,shuffleOptions:t.shuffleOptions||!1,metadata:{sessionPhase:n.sessionPhase||"LIVE",resultsVisibility:n.resultsVisibility||"HIDDEN",isCollecting:n.status==="OPEN"}};l.set(c).catch(function(u){console.warn("[Firebase] Broadcast to live_session failed:",u)})}}}var Yn=null;function gn(e){if(!(!FIREBASE_CONFIG||!e)){if(qe&&O!==e&&(console.log("[Firebase] Cleaning up listeners for previous pollId:",O),qe.off(),qe=null,pn&&(pn.off(),pn=null),Yn&&(Yn.off(),Yn=null)),qe&&O===e){console.log("[Firebase] Already subscribed to pollId:",e);return}if(typeof firebase<"u"&&!firebase.apps.length&&console.warn("[Firebase] Late init triggered in initFirebaseMissionControl - this should be rare."),typeof firebase<"u"){ct=firebase.database();var n="sessions/"+e+"/students";qe=ct.ref(n),O=e,Gs=qe.toString(),Yn=ct.ref(".info/connected"),Yn.on("value",function(a){Je=a.val()===!0,console.log("[Firebase] Connection status changed:",Je?"CONNECTED":"DISCONNECTED","pollId:",e),mo(Je);var r=Je?3e4:2500;ve&&ve.isRunning()&&(console.log("[Adaptive Polling] Updating Mission Control heartbeat to "+r+"ms"),ve.updateInterval(r)),X?(console.log("[Adaptive Polling] Updating Live Poll interval to "+r+"ms"),clearInterval(X),la=r,X=setInterval(Dt,la)):la=r,Je&&(console.log("[Connectivity Recovery] Teacher reconnected - syncing state"),typeof Dt=="function"&&je&&setTimeout(Dt,500)),js()}),qe.on("child_changed",async function(a){var r=a.key,i=a.val(),s=typeof i=="object"&&i?i.status||"ACTIVE":i,d=xn[r];if(console.log("[Firebase] Student status changed:",r.substring(0,8)+"...",d,"â†’",s),(s==="LOCKED"||typeof s=="object"&&s.status==="LOCKED")&&d!=="LOCKED"){var o="Student";if(te)for(var l=0;l<te.length;l++){var c=await window.VeritasShared.generateStudentKey(te[l].email,O);if(c===r){o=te[l].name||te[l].email;break}}yo("error","lock",o+" was locked out (violation detected).")}if(s==="ACTIVE"&&d&&d!=="ACTIVE"){var u=null;if(te&&O)for(var l=0;l<te.length;l++){var g=te[l],m=await window.VeritasShared.generateStudentKey(g.email,O);if(m===r){u=g.name||g.email;break}}if(!u&&P&&f&&f.pollId)for(var p=0;p<P.length;p++){var b=P[p],h=await window.VeritasShared.generateStudentKey(b.email,f.pollId);if(h===r){u=b.name||b.email;break}}D("info","Student Resumed",(u||"A student")+" has re-entered the session.",3e3)}}),qe.on("child_added",function(a){var r=a.key,i=a.val(),s=r.replace(/,/g,".");te||(te=[]);var d=te.some(function(l){return l.email===s});if(!d){console.log("[Firebase] New student detected via Fast Path:",s);var o={name:s,email:s,status:i,proctorStatus:i==="ACTIVE"?"ACTIVE":"LOCKED",progress:0,score:0};te.push(o),te.sort(function(l,c){return(l.name||"").localeCompare(c.name||"")}),ri({students:te}),ja()}}),qe.on("value",function(a){xn=a.val()||{},console.log("[Firebase] Status update received for pollId:",e,"Students:",Object.keys(xn).length),ja()}),pn=ct.ref("sessions/"+e+"/violations"),pn.on("child_added",function(a){var r=a.key,i=a.val();i&&i.reason&&(i.reason,Date.now(),console.log("[Firebase] Violation detected:",r.substring(0,8)+"...","-",i.reason))}),pn.on("child_changed",function(a){var r=a.key,i=a.val();i&&i.reason&&(i.reason,Date.now(),console.log("[Firebase] Violation updated:",r.substring(0,8)+"...","-",i.reason))});var t=ct.ref("answers/"+e);t.on("child_added",function(a){var r=a.val();r&&r.questionIndex!==void 0&&zd(r)}),console.log("[Firebase] Mission Control initialized for",n,"Connected:",Je),console.log("[Firebase] Actual subscription:",Gs)}}}function zd(e){if(!(!f||f.pollId!==e.pollId)){var n=P.find(function(o){return o.email===e.studentEmail});if(n){var t=Math.max(n.progress||0,(e.questionIndex||0)+1);n.progress=t,n.status="Submitted",n.timeOnQuestionMs=e.timeOnQuestionMs,n.usingCalculator=e.usingCalculator,n.confidence=e.confidenceLevel,n.lastAnswerTimestamp=e.clientTimestamp,e.questionIndex===f.questionIndex?n.status="Submitted":n.status="In Progress";var a=document.querySelector('.student-status-card[data-email="'+CSS.escape(n.email)+'"]');if(a){var r=a.querySelector(".progress-bar-fill"),i=a.querySelector(".progress-text"),s=a.querySelector(".status-badge");if(r&&n.totalQuestions>0){var d=Math.min(100,Math.round(t/n.totalQuestions*100));r.style.width=d+"%",r.classList.remove("pulse-once"),r.offsetWidth,r.classList.add("pulse-once")}i&&(i.textContent=t+"/"+n.totalQuestions),s&&(s.textContent="In Progress",s.className="status-badge bg-emerald-100 text-emerald-800")}console.log("[Firebase] Realtime Answer processed for:",e.studentEmail)}}}function js(){var e=document.getElementById("realtime-indicator");if(!e){var n=document.getElementById("individual-session-meta");if(n){var t=document.createElement("span");t.id="realtime-indicator",t.className="ml-4 inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-bold",n.appendChild(t)}}var a=document.getElementById("realtime-indicator");a&&(Je?(a.className="ml-4 inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700 border border-green-200",a.innerHTML='<span class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></span> Realtime Active'):typeof window.USING_FALLBACK_CONFIG<"u"&&window.USING_FALLBACK_CONFIG?(a.className="ml-4 inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700 border border-red-200 cursor-pointer hover:bg-red-200",a.innerHTML='<span class="material-symbols-outlined text-sm">warning</span> Setup Required',a.title="Firebase Config Missing. Click for instructions.",a.onclick=function(){alert(`ACTION REQUIRED:

The app is not connected to a backend because FIREBASE_CONFIG is missing.

Please refer to the SETUP_GUIDE.md to configure your Script Properties.`)}):(a.className="ml-4 inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700 border border-red-200",a.innerHTML='<span class="h-2 w-2 rounded-full bg-red-500"></span> Realtime OFF (Polling mode)'))}function Ws(e){if(!e)return!1;var n=Date.now(),t=typeof e=="number"?e:new Date(e).getTime(),a=3e4;return n-t>a}async function ja(){var e=!1;if(te&&O&&(await Promise.all(te.map(async function(t){var a=await window.VeritasShared.generateStudentKey(t.email,O),r=xn[a];if(r){var i=t.status,s=t.connection?t.connection.status:"GRAY",d=typeof r=="object"&&r?r.status:r,o=typeof r=="object"&&r?r.lastActive||r.lastActiveAt:null,l=Ws(o);d==="ACTIVE"?(t.status!=="Submitted"&&(i=l?"Idle":"In Progress"),s=l?"YELLOW":"GREEN"):d==="Submitted"?(i="Submitted",s="GREEN"):d==="LOCKED"?(i="LOCKED",t.proctorStatus="LOCKED",s="GREEN"):d==="DISCONNECTED"?(s="RED",i="Offline"):d==="FINISHED"&&(i="Submitted",s="GREEN"),t.isIdle=l,t.lastActive=o,(t.status!==i||t.connection&&t.connection.status!==s)&&(t.status=i,t.connection||(t.connection={}),t.connection.status=s,e=!0)}})),e&&ri({students:te})),P&&P.length>0&&f&&f.pollId){var n=!1;await Promise.all(P.map(async function(t){var a=await window.VeritasShared.generateStudentKey(t.email,f.pollId),r=xn[a];if(r){var i=t.status,s=typeof r=="object"&&r?r.status:r,d=typeof r=="object"&&r?r.lastActive||r.lastActiveAt:null,o=Ws(d);s==="ACTIVE"?t.status!=="Submitted"&&(i=o?"Idle":"In Progress"):s==="Submitted"?i="Submitted":s==="LOCKED"?(i="LOCKED",t.proctorStatus="LOCKED"):s==="DISCONNECTED"?i="Offline":s==="FINISHED"&&(i="Submitted"),t.isIdle=o,t.lastActive=d,t.status!==i&&(t.status=i,n=!0)}})),n&&Ee()}}async function Vd(e,n){var t=O||f&&f.pollId;if(!(!qe||!e||!t)){var a=await window.VeritasShared.generateStudentKey(e,t);qe.child(a).set(n)}}var Gs=null,pn=null;function Qd(e){}function Ks(e){if(e){Re("individual-timed"),O=e.pollId,Ae=e.sessionId,f.pollId=e.pollId,f.sessionId=e.sessionId,f.pollName=e.pollName,f.className=e.className,f.timeLimitMinutes=e.timeLimitMinutes||0,f.questionCount=e.totalQuestions||e.questionCount||0;var n=document.getElementById("individual-session-poll-name");n&&(n.textContent=e.pollName+" â€“ "+(e.className||""));var t=document.getElementById("individual-session-meta");if(t){var a=e.timeLimitMinutes?e.timeLimitMinutes+" min limit":"Untimed";t.textContent=a+" â€¢ "+(e.students?e.students.length:0)+" learners"}gn(e.pollId),Je&&js(),ri(e),Jn(),ve.stop(),ve.start(!0)}}window.showIndividualTimedView=Ks;function ri(e){var n=document.getElementById("individual-session-students-grid");if(n){var t=e&&e.students?e.students:[];if(te=t.slice(),n.innerHTML="",t.forEach(function(r){var i=r.proctorStatus==="LOCKED"||r.status==="Locked"||r.status&&r.status.indexOf("Locked")===0;i?ia.has(r.email)||(D("error","Security Violation",r.name+" has been locked."),ia.add(r.email)):ia.has(r.email)&&ia.delete(r.email)}),t.length===0){var a=document.createElement("div");a.className="col-span-full text-center py-10 text-slate-500",a.textContent="Students will appear here as they join the assessment.",n.appendChild(a)}else jd(t),t.forEach(function(r){var i="bg-slate-100 text-slate-700",s=(r.status||"").toString().toLowerCase();s.indexOf("in progress")===0?i="bg-emerald-50 text-emerald-700":s.indexOf("locked")===0||s.indexOf("blocked")===0?i="bg-red-50 text-red-700":r.status==="Awaiting Fullscreen"?i="bg-blue-50 text-blue-700":r.status==="Paused"?i="bg-amber-50 text-amber-700":r.status==="Submitted"&&(i="bg-slate-200 text-slate-700");var d="bg-slate-300",o="No data",l=r.connection?r.connection.status:"GRAY";l==="GREEN"?(d="bg-emerald-400",o="Synced"):l==="YELLOW"?(d="bg-amber-400",o="Reconnecting"):l==="RED"&&(d="bg-red-500",o="Offline");var c=r.timeRemainingSeconds!=null?bt(r.timeRemainingSeconds):"--:--",u=r.progressPct!=null?r.progressPct:0,g=`Q ${r.progress||0} / ${r.totalQuestions||0}`,m=r.status==="Not Started",p=ae.has(r.email),b=r.progress||0,h=typeof r.correctCount=="number"?r.correctCount:null,w=r.totalQuestions||0,q=b>0&&h!==null?`${h} correct`:b>0?"Responses recorded":"Awaiting responses",T=typeof r.scorePct=="number"&&w>0&&b>0?`${Math.round(r.scorePct)}% of exam`:"",x="bg-emerald-500";s.indexOf("locked")===0||s.indexOf("blocked")===0?x="bg-red-500":r.status==="Paused"&&(x="bg-amber-500");var C=r.proctorStatus==="LOCKED"||r.proctorStatus==="BLOCKED"||s.indexOf("locked")===0||s.indexOf("blocked")===0,R=document.createElement("div"),N="mission-student-card rounded-2xl border border-slate-200 dark:border-brand-dark-gray/60 bg-white dark:bg-brand-dark-gray/30 p-4 shadow-sm flex flex-col gap-3 transition-all";p&&(N+=" ring-2 ring-amber-400 ring-opacity-70 shadow-lg"),R.className=N,R.dataset.email=r.email,R.innerHTML=`
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-base font-semibold text-brand-dark-gray dark:text-white">${y(r.name)}</p>
              <div class="flex items-center gap-2 flex-wrap mt-1">
                <span class="inline-flex px-2.5 py-1 text-xs font-semibold rounded-full ${i}">${r.status}</span>
                ${Gl(r.telemetry)}
              </div>
            </div>
            <div class="flex items-center gap-3 text-xs text-slate-500">
              <button type="button" class="mission-select-btn rounded-full border border-slate-300 dark:border-slate-600 p-1.5 text-slate-500 hover:text-veritas-navy" data-action="toggle-select" data-email="${r.email}" aria-pressed="${p?"true":"false"}" title="Select student">
                <span class="material-symbols-outlined text-base" data-role="selection-icon">${p?"check_circle":"radio_button_unchecked"}</span>
              </button>
              <div class="flex items-center gap-1.5">
                <span class="h-2.5 w-2.5 rounded-full ${d}"></span>
                <span>${o}</span>
              </div>
            </div>
          </div>
          <div>
            <div class="flex items-center justify-between text-xs text-slate-500 mb-1">
              <span>${g}</span>
              <span>Remaining ${c}</span>
            </div>
            <div class="w-full h-2 rounded-full bg-slate-100 dark:bg-slate-800">
              <div class="h-2 rounded-full ${x}" style="width: ${u}%"></div>
            </div>
            <div class="flex items-center justify-between text-xs text-slate-600 mt-2">
              <span class="font-semibold">${q}</span>
              <span>${T}</span>
            </div>
          </div>
          <div class="flex flex-col gap-2 pt-1">
            <button class="mission-manage-btn inline-flex items-center justify-center gap-2 rounded-full border border-slate-300 dark:border-slate-600 px-4 py-2 text-sm font-semibold text-brand-dark-gray dark:text-white hover:bg-slate-50 disabled:opacity-60" data-action="manage-student" data-email="${r.email}" ${m?"disabled":""}>
              <span class="material-symbols-outlined text-base">tune</span>
              Manage
            </button>
            ${C?`<button type="button" class="inline-flex items-center justify-center gap-2 rounded-full border border-blue-200 text-blue-700 bg-blue-50 px-4 py-2 text-xs font-semibold hover:bg-blue-100" data-action="unlock-student" data-email="${r.email}" data-lock-version="${r.lockVersion||0}">
              <span class="material-symbols-outlined text-base">lock_open_right</span>
              <span>Approve re-entry</span>
            </button>`:""}
          </div>
        `,n.appendChild(R)});Yd(e&&e.summary?e.summary:{}),Xd(),Wd(),Gd(),Zd(),ii(),Xn()}}function jd(e){if(ae.size){var n=new Set(e.map(function(t){return t.email}));Array.from(ae).forEach(function(t){n.has(t)||ae.delete(t)})}}function Wd(){var e=document.querySelectorAll('#individual-session-students-grid [data-action="toggle-select"]');e.forEach(function(n){n.addEventListener("click",function(t){t.preventDefault(),t.stopPropagation(),Kd(n.dataset.email)})})}function Gd(){var e=document.querySelectorAll('#individual-session-students-grid [data-action="unlock-student"]');e.forEach(function(n){n.addEventListener("click",function(t){if(t.preventDefault(),t.stopPropagation(),!!O){var a=n.dataset.email,r=Number(n.dataset.lockVersion||0);ls(a,O,r,n)}})})}function Kd(e){e&&(ae.has(e)?ae.delete(e):ae.add(e),ii(),Xn())}function $d(){ae.size&&(ae.clear(),ii(),Xn())}function ii(){var e=document.querySelectorAll("#individual-session-students-grid .mission-student-card");e.forEach(function(n){var t=n.dataset.email,a=t&&ae.has(t);n.classList.toggle("ring-2",!!a),n.classList.toggle("ring-amber-400",!!a),n.classList.toggle("ring-opacity-70",!!a),n.classList.toggle("shadow-lg",!!a);var r=n.querySelector('[data-role="selection-icon"]');r&&(r.textContent=a?"check_circle":"radio_button_unchecked");var i=n.querySelector('[data-action="toggle-select"]');i&&i.setAttribute("aria-pressed",a?"true":"false")})}function Xn(){if(Pi&&(Pi.textContent=ae.size),ya&&ya.classList.toggle("hidden",ae.size===0),!er&&qn&&(qn.textContent=ae.size>0?"Add to selected ("+ae.size+")":"Add to selected"),!er&&gt){var e=ae.size===0||!O||!Ae;gt.disabled=e,gt.classList.toggle("opacity-60",e)}}function Wa(e,n){if(er=!!e,nn){nn.disabled=!!e,nn.classList.toggle("opacity-60",!!e);var t=nn.querySelector("span:last-child");t&&(t.textContent=e&&n==="ALL"?"Adding...":"Add to entire class")}if(gt){var a=e||ae.size===0||!O||!Ae;gt.disabled=a,gt.classList.toggle("opacity-60",a),qn&&(e&&n==="SELECTED"?qn.textContent="Adding...":e||(qn.textContent=ae.size>0?"Add to selected ("+ae.size+")":"Add to selected"))}e||Xn()}async function $s(e){if(!O||!Ae){await S("Launch a secure assessment before extending time.",{title:"Extend time"});return}if(e==="SELECTED"&&ae.size===0){await S("Select at least one student first.",{title:"Extend time"});return}if(!yr)return;var n=parseFloat(yr.value);if(isNaN(n)||n<=0){await S("Enter a positive number of minutes to add.",{title:"Extend time"}),yr.focus();return}Wa(!0,e);var t=[];e==="ALL"?firebase.database().ref("sessions/"+O+"/students").once("value").then(function(r){var i=r.val()||{};t=Object.keys(i).map(function(s){return i[s].email}),a(t,n)}):(t=Array.from(ae),a(t,n));function a(r,i){if(!r||r.length===0){Wa(!1,e);return}var s=r.map(function(d){var o=typeof generateStudentKey=="function"?generateStudentKey(d):d.replace(/[.$#[\]]/g,"_");return firebase.database().ref("sessions/"+O+"/students/"+o+"/timeAdjustment").transaction(function(l){return(l||0)+i})});Promise.all(s).then(function(){Wa(!1,e);var d=e==="ALL"?"the entire class":r.length+" student(s)";D("success","Time extended","Added "+i+" minute(s) for "+d+".",4e3),Jn()}).catch(function(d){Wa(!1,e),F(d)})}}function Jn(){if(!(!O||!Ae)&&oe>0){var e=oe-1e3;if(e<=0)oe=0;else{oe=e,console.log("Mission control polling backing off:",e+"ms remaining");return}}}function Yd(e){var n=document.getElementById("summary-not-started"),t=document.getElementById("summary-in-progress"),a=document.getElementById("summary-locked"),r=document.getElementById("summary-completed");n&&(n.textContent=e.notStarted||0),t&&(t.textContent=e.inProgress||0);var i=(e.locked||0)+(e.paused||0);a&&(a.textContent=i),r&&(r.textContent=e.completed||0)}function Xd(){var e=document.querySelectorAll('.mission-manage-btn, [data-action="manage-student"]');e.forEach(function(n){n.addEventListener("click",function(){var t=n.dataset.email,a=te.find(function(r){return r.email===t});a&&Jd(a)})})}function Jd(e){!tn||!e||(J=e,Xs(e),tn.classList.remove("hidden"))}function Ys(){tn&&(tn.classList.add("hidden"),J=null,Zn(!1))}function Zd(){if(!(!J||!te.length||!tn||tn.classList.contains("hidden"))){var e=te.find(function(n){return n.email===J.email});e&&(J=e,Xs(e))}}function Xs(e){if(e){if(Ai&&(Ai.textContent=e.name),Ti&&(Ti.textContent=e.status),Bi){var n=e.progress||0,t="Q "+n+" / "+(e.totalQuestions||0);typeof e.correctCount=="number"&&n>0&&(t+=" â€¢ "+e.correctCount+" correct"),Bi.textContent=t}if(qi&&(qi.textContent=e.timeRemainingSeconds!=null?bt(e.timeRemainingSeconds):"--:--"),Ni){var a=e.timeAdjustmentMinutes||0;Ni.textContent=(a>=0?"+":"")+a+"m"}if(Mi){var r="No signal",i=e.connection?e.connection.status:"";i==="GREEN"?r="Synced":i==="YELLOW"?r="Reconnecting":i==="RED"&&(r="Offline"),Mi.textContent=r}if(gr){gr.classList.remove("bg-emerald-400","bg-amber-400","bg-red-500","bg-slate-300");var s="bg-slate-300",d=e.connection?e.connection.status:"";d==="GREEN"?s="bg-emerald-400":d==="YELLOW"?s="bg-amber-400":d==="RED"&&(s="bg-red-500"),gr.classList.add(s)}if(pr&&(e.lastHeartbeatMs?pr.textContent="Last heartbeat "+Ur(new Date(e.lastHeartbeatMs))+".":pr.textContent=""),Bn&&(Bn.innerHTML='<span class="material-symbols-outlined text-base">'+(e.pauseActive?"play_arrow":"pause_circle")+"</span><span>"+(e.pauseActive?" Resume Timer":" Pause Timer")+"</span>"),Bt){var o=e.proctorStatus==="LOCKED"||e.isLocked;Bt.disabled=!o,Bt.classList.toggle("opacity-60",!o)}}}function Zn(e){Ri&&Ri.classList.toggle("hidden",!e),[vr,br,Bn,Bt,hr].forEach(function(n){n&&(n.disabled=!!e)})}var vn=null;function ec(){var e=document.getElementById("book-view-modal"),n=document.getElementById("book-view-loading"),t=document.getElementById("book-view-content"),a=document.getElementById("book-view-error");if(!(!e||!O)){e.classList.remove("hidden"),n.classList.remove("hidden"),t.classList.add("hidden"),a.classList.add("hidden");var r=oa.httpsCallable("getAnalytics");r({pollId:O}).then(function(i){var s=i.data||i,d={success:!0,summary:{className:s.className||"Unknown Class",pollName:s.pollName||"Unknown Poll",date:new Date().toLocaleDateString(),averageScore:0},students:[],questions:[]};s.itemAnalysis&&Object.keys(s.itemAnalysis).forEach(function(o){var l=s.itemAnalysis[o];d.questions.push({index:o,text:"Question "+(parseInt(o)+1),difficulty:l.difficultyIndex,discrimination:l.discriminationIndex,correctCount:l.correctCount,totalCount:l.totalResponseCount})}),vn=d,ac(d),n.classList.add("hidden"),t.classList.remove("hidden")}).catch(function(i){nc("Error loading analytics: "+(i.message||"Unknown error"))})}}function tc(){var e=document.getElementById("book-view-modal");e&&e.classList.add("hidden"),vn=null}window.closeBookView=tc;function nc(e){var n=document.getElementById("book-view-loading"),t=document.getElementById("book-view-content"),a=document.getElementById("book-view-error"),r=document.getElementById("book-view-error-message");n.classList.add("hidden"),t.classList.add("hidden"),a.classList.remove("hidden"),r&&(r.textContent=e)}var vn=null;function ac(e){vn=e;var n=document.getElementById("book-view-title"),t=document.getElementById("book-view-subtitle");n&&(n.textContent=e.pollName+" - Book View"),t&&(t.textContent=e.className+" â€¢ "+e.questionCount+" questions â€¢ "+e.studentDetails.length+" students");var a=document.getElementById("book-export-csv-btn");if(!a){var r=document.querySelector("#book-view-section .flex.items-center.gap-4");r&&(a=document.createElement("button"),a.id="book-export-csv-btn",a.className="flex items-center gap-2 px-4 py-2 bg-veritas-gold text-white rounded-lg hover:bg-veritas-gold/90 transition-colors font-semibold",a.innerHTML='<span class="material-symbols-outlined text-sm">download</span><span>Export CSV</span>',a.onclick=function(){Js()},r.appendChild(a))}rc(e.classOverview,e.questionCount),ic(e.studentDetails),sc(e.itemAnalysis,e.studentDetails),oc(e.studentDetails,e.questionCount)}function Js(){if(!vn){D("error","Export Error","No book view data available to export.");return}try{for(var e=vn,n=[],t=["Student Name","Email","Score","Percentage"],a=0;a<e.questionCount;a++)t.push("Q"+(a+1));n.push(t.join(",")),e.studentDetails.forEach(function(l){var c=[];function u(g){if(g==null)return"";var m=String(g);return m.includes(",")||m.includes('"')||m.includes(`
`)?'"'+m.replace(/"/g,'""')+'"':m}c.push(u(l.name)),c.push(u(l.email||"")),c.push(l.totalScore+"/"+l.maxScore),c.push(l.percentage+"%"),l.questionResponses.forEach(function(g){if(g.answered){var m=g.isCorrect?"âœ“ "+g.studentAnswer:"âœ— "+g.studentAnswer;c.push(u(m))}else c.push("â€”")}),n.push(c.join(","))});var r=n.join(`
`),i=new Blob([r],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),d=URL.createObjectURL(i),o=(e.pollName||"Poll")+"_"+(e.className||"Class")+"_Results.csv";o=o.replace(/[^a-z0-9_\-]/gi,"_"),s.setAttribute("href",d),s.setAttribute("download",o),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),D("success","Export Complete","CSV file downloaded successfully.",3e3),typeof Qd=="function"&&(""+e.pollName,void 0)}catch(l){console.error("[CSV Export] Error:",l),D("error","Export Failed","Failed to generate CSV file: "+l.message)}}window.exportBookViewToCSV=Js;function rc(e,n){var t=document.getElementById("book-class-total-students"),a=document.getElementById("book-class-average"),r=document.getElementById("book-class-median"),i=document.getElementById("book-class-stddev"),s=document.getElementById("book-class-interpretation");if(t&&(t.textContent=e.participantCount),a){var d=n>0?Math.round(e.mean/n*100):0;a.textContent=d+"%"}if(r&&(r.textContent=e.median+"/"+n),i&&(i.textContent=e.stdDev.toFixed(2)),s&&e.interpretation){var o="";e.interpretation.participation&&(o+='<div class="mb-2"><strong>Participation:</strong> '+e.interpretation.participation.message+"</div>"),e.interpretation.meanScore&&(o+='<div class="mb-2"><strong>Class Performance:</strong> '+e.interpretation.meanScore.message+"</div>"),e.interpretation.stdDev&&(o+="<div><strong>Score Distribution:</strong> "+e.interpretation.stdDev.message+"</div>"),s.innerHTML=o}}function ic(e){var n=document.getElementById("book-students-table-body");n&&(n.innerHTML="",e.forEach(function(t){var a=document.createElement("tr");a.className="hover:bg-slate-50 dark:hover:bg-brand-dark-gray/20 transition-colors cursor-pointer",a.onclick=function(){lc(t)};var r="";t.rank===1?r='<span class="ml-2 text-yellow-500">ðŸ¥‡</span>':t.rank===2?r='<span class="ml-2 text-gray-400">ðŸ¥ˆ</span>':t.rank===3&&(r='<span class="ml-2 text-orange-600">ðŸ¥‰</span>');var i="text-slate-700 dark:text-slate-300";t.percentage>=90?i="text-green-600 dark:text-green-400 font-bold":t.percentage>=80?i="text-green-600 dark:text-green-400":t.percentage>=70?i="text-blue-600 dark:text-blue-400":t.percentage>=60?i="text-yellow-600 dark:text-yellow-400":i="text-red-600 dark:text-red-400",a.innerHTML='<td class="px-4 py-3 text-sm font-semibold">'+t.rank+r+'</td><td class="px-4 py-3 text-sm font-medium text-brand-dark-gray dark:text-white">'+y(t.name)+'</td><td class="px-4 py-3 text-sm text-center">'+t.totalScore+"/"+t.maxScore+'</td><td class="px-4 py-3 text-sm text-center '+i+'">'+t.percentage+'%</td><td class="px-4 py-3 text-sm text-center">'+t.percentileRank+'th</td><td class="px-4 py-3 text-center"><button class="px-3 py-1 text-xs font-semibold rounded-lg bg-veritas-gold/10 text-veritas-gold hover:bg-veritas-gold/20 transition-colors">View Details</button></td>',n.appendChild(a)}))}function sc(e,n){var t=document.getElementById("book-questions-container");t&&(t.innerHTML="",e.forEach(function(a,r){var i=document.createElement("div");i.className="bg-white dark:bg-brand-dark-gray/30 rounded-xl border border-slate-200 dark:border-brand-dark-gray/40 p-6 shadow-sm";var s=a.interpretation.difficulty.color,d=a.interpretation.discrimination.color,o=a.interpretation.overall.color,l='<div class="flex items-start justify-between gap-4 mb-4"><div class="flex-1"><h4 class="text-lg font-bold text-brand-dark-gray dark:text-white mb-2">Question '+(r+1)+'</h4><p class="text-sm text-slate-600 dark:text-slate-400">'+y(a.questionText)+'</p></div><div class="flex gap-2">';a.flags.forEach(function(c){var u=c.replace(/-/g," ").toUpperCase();l+='<span class="px-2 py-1 text-xs font-semibold rounded bg-red-100 text-red-800">âš  '+u+"</span>"}),l+="</div></div>",l+='<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"><div class="bg-slate-50 dark:bg-brand-dark-gray/40 rounded-lg p-3"><p class="text-xs text-slate-500 mb-1">Difficulty (P-Value)</p><p class="text-2xl font-bold" style="color:'+s+'">'+(a.difficultyPct||0)+'%</p><p class="text-xs text-slate-600 dark:text-slate-400">'+a.interpretation.difficulty.message+'</p></div><div class="bg-slate-50 dark:bg-brand-dark-gray/40 rounded-lg p-3"><p class="text-xs text-slate-500 mb-1">Discrimination</p><p class="text-2xl font-bold" style="color:'+d+'">'+a.discrimination.toFixed(2)+'</p><p class="text-xs text-slate-600 dark:text-slate-400">'+a.interpretation.discrimination.message+'</p></div><div class="bg-slate-50 dark:bg-brand-dark-gray/40 rounded-lg p-3"><p class="text-xs text-slate-500 mb-1">Responses</p><p class="text-2xl font-bold text-slate-700 dark:text-slate-300">'+a.responseCount+'</p><p class="text-xs text-slate-600 dark:text-slate-400">students answered</p></div><div class="bg-slate-50 dark:bg-brand-dark-gray/40 rounded-lg p-3"><p class="text-xs text-slate-500 mb-1">Overall Quality</p><p class="text-sm font-bold" style="color:'+o+'">'+a.interpretation.overall.quality.toUpperCase()+'</p><p class="text-xs text-slate-600 dark:text-slate-400">'+a.interpretation.overall.message+"</p></div></div>",a.distractorAnalysis&&a.distractorAnalysis.length>0&&(l+='<div class="border-t border-slate-200 dark:border-brand-dark-gray/40 pt-4"><h5 class="text-sm font-semibold text-brand-dark-gray dark:text-white mb-3">Answer Choice Analysis</h5><div class="space-y-2">',a.distractorAnalysis.forEach(function(c){var u=c.isCorrect,g=u?"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800":"bg-slate-50 dark:bg-brand-dark-gray/40 border-slate-200 dark:border-brand-dark-gray/60",m=u?"âœ“":"";l+='<div class="flex items-center gap-3 p-3 rounded-lg border '+g+'"><div class="flex-shrink-0 w-8 h-8 rounded-full bg-white dark:bg-brand-dark-gray flex items-center justify-center font-bold text-sm">'+c.optionLetter+'</div><div class="flex-1"><p class="text-sm font-medium text-brand-dark-gray dark:text-white">'+m+" "+y(c.option)+(u?' <span class="text-green-600 dark:text-green-400">(Correct Answer)</span>':"")+'</p></div><div class="text-right"><p class="text-sm font-bold text-brand-dark-gray dark:text-white">'+c.totalPct.toFixed(1)+'%</p><p class="text-xs text-slate-500">selected</p></div><div class="text-right"><p class="text-xs text-slate-500">High: '+c.highGroupPct.toFixed(1)+'%</p><p class="text-xs text-slate-500">Low: '+c.lowGroupPct.toFixed(1)+"%</p></div></div>"}),l+="</div></div>"),i.innerHTML=l,t.appendChild(i)}))}function oc(e,n){var t=document.getElementById("book-matrix-header-row"),a=document.getElementById("book-matrix-table-body");if(!(!t||!a)){t.innerHTML="";var r=document.createElement("th");r.className="sticky left-0 bg-slate-100 dark:bg-brand-dark-gray/50 px-3 py-2 text-left font-semibold border-r border-slate-300 dark:border-brand-dark-gray/60",r.textContent="Student",t.appendChild(r);for(var i=0;i<n;i++){var s=document.createElement("th");s.className="bg-slate-100 dark:bg-brand-dark-gray/50 px-3 py-2 text-center font-semibold border-l border-slate-300 dark:border-brand-dark-gray/60",s.textContent="Q"+(i+1),t.appendChild(s)}var d=document.createElement("th");d.className="bg-slate-100 dark:bg-brand-dark-gray/50 px-3 py-2 text-center font-semibold",d.textContent="Total",t.appendChild(d),a.innerHTML="",e.forEach(function(o){var l=document.createElement("tr");l.className="hover:bg-slate-50 dark:hover:bg-brand-dark-gray/20";var c=document.createElement("td");c.className="sticky left-0 bg-white dark:bg-brand-dark-gray px-3 py-2 text-sm font-medium border-r border-slate-300 dark:border-brand-dark-gray/60",c.textContent=o.name,l.appendChild(c),o.questionResponses.forEach(function(g){var m=document.createElement("td");m.className="px-3 py-2 text-center text-xs border-l border-slate-200 dark:border-brand-dark-gray/60",g.answered?g.isCorrect?(m.className+=" bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 font-semibold",m.innerHTML='âœ“<br><span class="text-[10px]">'+y(g.studentAnswer)+"</span>"):(m.className+=" bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 font-semibold",m.innerHTML='âœ—<br><span class="text-[10px]">'+y(g.studentAnswer)+"</span>"):(m.className+=" bg-slate-100 dark:bg-brand-dark-gray/40 text-slate-400",m.textContent="â€”"),l.appendChild(m)});var u=document.createElement("td");u.className="px-3 py-2 text-center font-bold text-sm bg-slate-100 dark:bg-brand-dark-gray/50",u.textContent=o.totalScore+"/"+o.maxScore,l.appendChild(u),a.appendChild(l)})}}function lc(e){var n=document.getElementById("book-student-detail");if(n){var t=document.getElementById("student-detail-name"),a=document.getElementById("student-detail-score"),r=document.getElementById("student-detail-percentage"),i=document.getElementById("student-detail-rank"),s=document.getElementById("student-detail-percentile");t&&(t.textContent=e.name),a&&(a.textContent=e.totalScore+"/"+e.maxScore),r&&(r.textContent=e.percentage+"%"),i&&(i.textContent="#"+e.rank),s&&(s.textContent=e.percentileRank+"th percentile");var d=document.getElementById("student-detail-responses");d&&(d.innerHTML="",e.questionResponses.forEach(function(o,l){var c=document.createElement("div");c.className="bg-white dark:bg-brand-dark-gray/30 rounded-lg border border-slate-200 dark:border-brand-dark-gray/40 p-4";var u=o.isCorrect?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300":"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300",g=o.isCorrect?"âœ“":"âœ—",m=o.isCorrect?"Correct":"Incorrect";o.answered||(u="bg-slate-100 text-slate-600 dark:bg-brand-dark-gray/40 dark:text-slate-400",g="â€”",m="Not Answered");var p='<div class="flex items-start justify-between gap-4 mb-3"><h5 class="text-sm font-bold text-brand-dark-gray dark:text-white">Question '+(l+1)+'</h5><span class="px-3 py-1 text-xs font-semibold rounded-full '+u+'">'+g+" "+m+'</span></div><p class="text-sm text-slate-700 dark:text-slate-300 mb-3">'+y(o.questionText)+"</p>";o.answered&&(p+='<div class="space-y-2"><div><span class="text-xs font-semibold text-slate-500">Student Answer:</span> <span class="text-sm font-medium text-brand-dark-gray dark:text-white">'+y(o.studentAnswer)+'</span></div><div><span class="text-xs font-semibold text-slate-500">Correct Answer:</span> <span class="text-sm font-medium text-green-700 dark:text-green-400">'+y(o.correctAnswer)+"</span></div></div>"),c.innerHTML=p,d.appendChild(c)})),n.classList.remove("hidden")}}function Zs(){var e=document.getElementById("book-student-detail");e&&e.classList.add("hidden")}window.closeStudentDetail=Zs,document.addEventListener("keydown",function(e){if(e.key==="Escape"||e.keyCode===27){var n=document.getElementById("book-student-detail");n&&!n.classList.contains("hidden")&&Zs()}});function si(e){var n=["students","questions","matrix"];n.forEach(function(t){var a=document.getElementById("book-tab-"+t),r=document.getElementById("book-content-"+t);a&&(t===e?a.className="px-6 py-3 font-semibold text-sm transition-colors border-b-2 border-veritas-gold text-veritas-gold":a.className="px-6 py-3 font-semibold text-sm transition-colors border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-veritas-gold hover:border-veritas-gold/30"),r&&(t===e?r.classList.remove("hidden"):r.classList.add("hidden"))})}function y(e){if(!e)return"";var n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&amp;#039;"};return String(e).replace(/[&<>"']/g,function(t){return n[t]})}k("view-book-report-btn",ec),k("secure-view-links-btn",function(){var e=f&&f.className;if(!e){S("No class assigned to this assessment.",{title:"View Links",destructive:!0});return}$?($.dataset.className=e,Ua()):firebase.database().ref("rosters/rosters/"+e).once("value").then(function(n){var t=n.val();if(t&&t.length>0){var a=t.map(function(r){return{name:r.name,email:r.email,link:WEB_APP_URL+"?role=student&pollId="+(f?f.pollId:"")+"&email="+encodeURIComponent(r.email)}});openLinksModalWithData(e,a)}else S("No students found in this class roster.",{title:"View Links",destructive:!0})}).catch(function(n){F(n)})});var eo=document.getElementById("book-tab-students"),to=document.getElementById("book-tab-questions"),no=document.getElementById("book-tab-matrix");eo&&eo.addEventListener("click",function(){si("students")}),to&&to.addEventListener("click",function(){si("questions")}),no&&no.addEventListener("click",function(){si("matrix")});function oi(e,n){if(!(!O||!Ae||!J)){Zn(!0);var t=O,a=n[2]||J.email,r=typeof generateStudentKey=="function"?generateStudentKey(a):a.replace(/[.$#[\]]/g,"_"),i=firebase.database().ref("sessions/"+t+"/students/"+r),s=null;if(e==="adjustSecureAssessmentTime"){var d=n[3];s=i.child("timeAdjustment").transaction(function(o){return(o||0)+d})}else e==="pauseSecureAssessmentStudent"?s=i.update({status:"PAUSED",pauseActive:!0}):e==="resumeSecureAssessmentStudent"?s=i.update({status:"ACTIVE",pauseActive:!1}):e==="forceSubmitSecureAssessmentStudent"&&(s=i.update({status:"FINISHED"}));s?s.then(function(){Zn(!1),Jn()}).catch(function(o){Zn(!1),F(o)}):Zn(!1)}}function ao(e){J&&oi("adjustSecureAssessmentTime",[O,Ae,J.email,e])}function dc(){if(J){var e=J.pauseActive?"resumeSecureAssessmentStudent":"pauseSecureAssessmentStudent";oi(e,[O,Ae,J.email])}}async function cc(){if(J){var e=await Ke("Force submit and lock "+J.name+"?",{title:"Force submit",destructive:!0,confirmText:"Force Submit"});e&&oi("forceSubmitSecureAssessmentStudent",[O,Ae,J.email])}}k("end-individual-session-btn",Ml),Di&&Di.addEventListener("click",Ys),document.querySelectorAll('[data-student-manager-close="true"]').forEach(function(e){e.addEventListener("click",Ys)}),vr&&vr.addEventListener("click",function(){ao(5)}),br&&br.addEventListener("click",function(){ao(10)}),Bn&&Bn.addEventListener("click",dc),hr&&hr.addEventListener("click",function(){cc()}),Bt&&Bt.addEventListener("click",function(){!J||!O||(Vd(J.email,"ACTIVE"),ls(J.email,O,J.lockVersion||0,Bt))}),nn&&nn.addEventListener("click",function(){$s("ALL")}),gt&&gt.addEventListener("click",function(){$s("SELECTED")}),ya&&ya.addEventListener("click",function(){$d()}),Xn();var v={currentStep:1,mode:null,pollName:"",className:"",timeLimitMinutes:null,accessCode:"",availabilityStart:null,availabilityEnd:null,calculatorEnabled:!1,proctoringRules:[],questions:[],showResultsImmediately:!1,pollId:null,isEditMode:!1};function ea(){v={currentStep:1,mode:null,pollName:"",className:"",timeLimitMinutes:null,accessCode:"",availabilityStart:null,availabilityEnd:null,calculatorEnabled:!1,proctoringRules:[],questions:[],showResultsImmediately:!1,pollId:null,isEditMode:!1}}function ro(e,n){if(!firebase.auth().currentUser||!window.AUTH_READY){console.warn("[Wizard] Cannot refresh classes: Auth not ready"),e&&(firebase.auth().currentUser?(e.innerHTML='<option value="" disabled>Loading classes...</option>',setTimeout(function(){ro(e,n)},500)):e.innerHTML='<option value="" disabled>Please sign in to load classes</option>');return}tt({action:"GET_DATA"}).then(function(t){if(t.data&&t.data.success){qr(t.data,M);var a=window.ALL_CLASSES&&window.ALL_CLASSES.length>0?window.ALL_CLASSES:[];e&&(a.length>0?(e.innerHTML='<option value="">-- Select a class --</option>',a.forEach(function(r){var i=document.createElement("option");i.value=r,i.textContent=r,e.appendChild(i)}),n&&(e.value=n)):e.innerHTML='<option value="" disabled>No classes found (Create one in Dashboard)</option>')}}).catch(function(t){console.warn("[Wizard] Unable to refresh classes for wizard:",t)})}var ta=null;function na(e,n){ea();var t=!!e;if(ea(),v.pollId=t?e.pollId:null,v.isEditMode=t,v.currentStep=1,t&&e){v.pollName=e.pollName||"",v.className=e.className||"";var a=Xe(e.sessionType);v.mode=a==="SECURE_ASSESSMENT"?"secure":"live",v.mode==="secure"&&(v.timeLimitMinutes=typeof e.timeLimitMinutes=="number"?e.timeLimitMinutes:e.secureSettings&&typeof e.secureSettings.timeLimitMinutes=="number"?e.secureSettings.timeLimitMinutes:60,v.accessCode=(e.accessCode||e.secureSettings&&e.secureSettings.accessCode||"").toString().toUpperCase(),v.availabilityStart=e.availableFrom||e.secureSettings&&e.secureSettings.availableFrom||null,v.availabilityEnd=e.dueBy||e.secureSettings&&e.secureSettings.dueBy||null,v.calculatorEnabled=e.calculatorEnabled===!0||e.secureSettings&&e.secureSettings.calculatorEnabled===!0),e.questions&&e.questions.length>0&&(v.questions=e.questions.map(function(m){for(var p=(m.options||[]).map(function(h){return{text:h.text||"",imageURL:h.imageURL||"",imageFileId:h.imageFileId||null}});p.length<4;)p.push({text:"",imageURL:"",imageFileId:null});var b=0;return p.forEach(function(h,w){h.text===m.correctAnswer&&(b=w)}),{questionText:m.questionText||"",questionImageURL:m.questionImageURL||"",questionImageFileId:m.questionImageFileId||null,options:p,correctAnswerIndex:b,metacognitionEnabled:!!m.metacognitionEnabled,timerSeconds:m.timerSeconds||null}}));var r=document.getElementById("wizard-title");r&&(r.textContent="Edit Poll")}else{var r=document.getElementById("wizard-title");r&&(r.textContent="Create Poll")}v.questions.length;var i=document.getElementById("wizard-class-select");if(i){i.innerHTML='<option value="">-- Select a class --</option>';var s=window.ALL_CLASSES&&window.ALL_CLASSES.length>0?window.ALL_CLASSES:typeof jt<"u"?jt:[];if(s.length===0){var d=document.createElement("option");d.textContent="Loading classes...",d.disabled=!0,i.appendChild(d),ro(i,v.className)}else s.forEach(function(m){var p=document.createElement("option");p.value=m,p.textContent=m,i.appendChild(p)});if(t&&v.className){if(s.indexOf(v.className)===-1){var o=document.createElement("option");o.value=v.className,o.textContent=v.className,i.appendChild(o)}i.value=v.className}}Re("create-poll");var l=document.getElementById("header-session-controls");if(l&&l.classList.add("hidden"),t){typeof n=="number"&&n>=0?(Se(3),L=n,setTimeout(function(){ie()},0)):Se(2);var c=document.getElementById("live-config-section"),u=document.getElementById("secure-config-section"),g=document.getElementById("config-mode-label");v.mode==="secure"?(c&&c.classList.add("hidden"),u&&u.classList.remove("hidden"),g&&(g.textContent="Secure Assessment")):v.mode==="live"&&(c&&c.classList.remove("hidden"),u&&u.classList.add("hidden"),g&&(g.textContent="Live Poll"))}else Se(1)}function io(){if(!((v.pollName||v.questions.length>0)&&!confirm("You have unsaved changes. Are you sure you want to close?"))){var e=document.getElementById("header-session-controls");e&&e.classList.remove("hidden"),Re("dashboard")}}function so(e){Array.isArray(e)&&el(e),v={currentStep:1,mode:null,pollName:"",className:"",timeLimitMinutes:null,accessCode:"",availabilityStart:null,availabilityEnd:null,calculatorEnabled:!1,proctoringRules:[],questions:[],showResultsImmediately:!1,pollId:null,isEditMode:!1};var n=document.getElementById("header-session-controls");n&&n.classList.remove("hidden"),Re("dashboard")}function uc(e){if(e){var n=V.find(function(t){return t.pollId===e});n?na(n):S("Failed to load poll data for editing.",{title:"Error"})}}window.Wizard={init:na,close:io,loadWithData:uc};function Se(e){if(!(e<1||e>4)){var n=[".wizard-progress"];n.forEach(function(u){var g=document.querySelector(u);if(g)for(var m=1;m<=4;m++){var p=g.querySelector('.progress-step[data-step="'+m+'"]');if(p)if(p.classList.remove("active","completed"),m<e){p.classList.add("completed");var b=p.querySelector(".progress-circle");b&&(b.classList.add("bg-green-500"),b.classList.remove("bg-white/20"))}else if(m===e){p.classList.add("active");var b=p.querySelector(".progress-circle");b&&(b.classList.remove("bg-green-500","bg-white/20"),b.classList.add("bg-veritas-gold"))}else{var b=p.querySelector(".progress-circle");b&&(b.classList.remove("bg-green-500","bg-veritas-gold"),b.classList.add("bg-white/20"))}}});for(var t=1;t<=4;t++){var a=document.getElementById("wizard-step-"+t);a&&a.classList.remove("active")}var r=document.getElementById("wizard-step-"+e);if(r&&r.classList.add("active"),v.currentStep=e,gc(),e===2){var i=document.getElementById("wizard-poll-name"),s=document.getElementById("wizard-class-select"),d=document.getElementById("wizard-time-limit"),o=document.getElementById("wizard-access-code"),l=document.getElementById("wizard-calculator-toggle");if(i&&v.pollName&&(i.value=v.pollName),s&&v.className&&(s.value=v.className),d&&v.timeLimitMinutes&&(d.value=v.timeLimitMinutes),o&&v.accessCode&&(o.value=v.accessCode),l&&(l.checked=v.calculatorEnabled===!0),v.isEditMode&&v.mode){var c=document.getElementById("wizard-step-2")?.querySelector("span.mode-label");c&&(c.textContent=v.mode==="secure"?"Secure Assessment":"Live Poll")}}v.currentStep===3&&e!==3&&De(),e===3&&Pe(),e===4&&Bc()}}function fc(){bc(v.currentStep)&&(vc(v.currentStep),v.currentStep<4&&Se(v.currentStep+1))}function mc(){v.currentStep>1&&Se(v.currentStep-1)}function gc(){var e=document.getElementById("wizard-back-btn"),n=document.getElementById("wizard-next-btn"),t=document.getElementById("wizard-publish-btn");if(!(!e||!n||!t))if(v.isEditMode?e.disabled=v.currentStep<=2:e.disabled=v.currentStep===1,v.currentStep===4){n.classList.add("hidden"),t.classList.remove("hidden");var a=t.querySelector(".material-symbols-outlined"),r=t.querySelector(".publish-btn-text")||t;v.isEditMode?(a&&(a.textContent="save"),r.innerHTML='<span class="material-symbols-outlined">save</span>Update Poll'):(a&&(a.textContent="rocket_launch"),r.innerHTML='<span class="material-symbols-outlined">rocket_launch</span>Publish Poll')}else n.classList.remove("hidden"),t.classList.add("hidden")}function pc(e){v.mode=e;var n=document.querySelectorAll(".mode-card");n.forEach(function(a){a.getAttribute("data-mode")===e?a.classList.add("selected"):a.classList.remove("selected")});var t=document.getElementById("wizard-next-btn");t&&(t.disabled=!1)}function vc(e){e===2&&(v.pollName=document.getElementById("wizard-poll-name")?.value||"",v.className=document.getElementById("wizard-class-select")?.value||"",v.mode==="secure"&&(v.timeLimitMinutes=parseInt(document.getElementById("wizard-time-limit")?.value)||null,v.accessCode=document.getElementById("wizard-access-code")?.value||"",v.calculatorEnabled=document.getElementById("wizard-calculator-toggle")?.checked||!1))}function bc(e){if(e===1){if(!v.mode)return alert("Please select a poll mode."),!1;var n=document.getElementById("live-config-section"),t=document.getElementById("secure-config-section"),a=document.getElementById("config-mode-label");return v.mode==="live"?(n&&n.classList.remove("hidden"),t&&t.classList.add("hidden"),a&&(a.textContent="Live Poll")):(n&&n.classList.add("hidden"),t&&t.classList.remove("hidden"),a&&(a.textContent="Secure Assessment")),!0}if(e===2){var r=document.getElementById("wizard-poll-name")?.value.trim(),i=document.getElementById("wizard-class-select")?.value;if(!r)return alert("Please enter a poll name."),!1;if(!i)return alert("Please select a class."),!1;if(v.mode==="secure"){var s=parseInt(document.getElementById("wizard-time-limit")?.value);if(!s||s<=0)return alert("Time limit is required for Secure Assessments."),!1}return!0}return e===3&&v.questions.length===0?(alert("Please add at least one question."),!1):!0}function De(){var e={a:0,b:1,c:2,d:3,e:4,f:5};Object.keys(Oe.instances).forEach(function(n){var t=Oe.instances[n];if(t){var a=document.getElementById(n);if(a){var r=a.querySelector(".ql-editor"),i=r?r.innerHTML:t.root.innerHTML,s=t.getText(),d=t.getContents(),o=n.match(/^question-input-(\d+)$/);if(o){var l=parseInt(o[1],10)-1;v.questions[l]&&(v.questions[l].html=i,v.questions[l].delta=d,v.questions[l].questionText=s);return}var c=n.match(/^answer-input-(\d+)-([a-f])$/i);if(c){var l=parseInt(c[1],10)-1,u=c[2].toLowerCase(),g=e[u];v.questions[l]&&v.questions[l].options[g]&&(v.questions[l].options[g].html=i,v.questions[l].options[g].delta=d,v.questions[l].options[g].text=s);return}var m=n.match(/^q-meta-(\d+)$/);if(m){var l=parseInt(m[1],10);v.questions[l]&&(v.questions[l].metaPromptHtml=i,v.questions[l].metaPromptDelta=d,v.questions[l].metaPromptText=s);return}}}})}window.syncWizardQuillContent=De;function hc(){var e=document.getElementById("wizard-questions-list");e&&(v.questions.push({questionText:"",html:"",delta:null,questionImageURL:"",options:[{text:"",html:"",delta:null,imageURL:"",id:Ze()},{text:"",html:"",delta:null,imageURL:"",id:Ze()},{text:"",html:"",delta:null,imageURL:"",id:Ze()},{text:"",html:"",delta:null,imageURL:"",id:Ze()}],correctAnswerIndex:0,metacognitionEnabled:!1,timerSeconds:null}),De(),Pe(),setTimeout(function(){var n=e.lastElementChild;n&&n.scrollIntoView({behavior:"smooth",block:"center"})},100))}function yc(e){if(v.questions.length<=1){alert("You must have at least one question.");return}confirm("Are you sure you want to remove this question?")&&(De(),v.questions.splice(e,1),Pe())}function xc(e){var n=v.questions[e];if(n.options.length>=6){alert("Maximum 6 answer choices allowed.");return}De(),n.options.push({text:"",html:"",delta:null,imageURL:"",id:Ze()}),Pe()}function wc(e,n){var t=v.questions[e];if(t.options.length<=2){alert("Minimum 2 answer choices required.");return}De(),t.options.splice(n,1),t.correctAnswerIndex>=t.options.length&&(t.correctAnswerIndex=0),Pe()}function Ec(e,n){De(),v.questions[e].correctAnswerIndex=n,Pe()}function Ic(e,n){if(!(!n||!n.trim())){var t=n.split(`
`).map(o=>o.trim()).filter(o=>o);if(!(t.length<2)){var a="",r=[],i=/^([a-f]|[1-6])[\.\)]\s*(.*)/i,s=!1;t.forEach(o=>{var l=o.match(i);l?(s=!0,r.push(l[2])):s?r.length>0&&(r[r.length-1]+=" "+o):a+=(a?`
`:"")+o}),r.length===0&&(a=t[0],r=t.slice(1)),De();var d=v.questions[e];for(d.questionText=a,d.html="<p>"+a+"</p>",d.delta=null,d.options=r.slice(0,6).map(o=>({text:o,html:"<p>"+o+"</p>",delta:null,imageURL:"",id:Ze()}));d.options.length<2;)d.options.push({text:"",html:"",delta:null,imageURL:"",id:Ze()});Pe()}}}function kc(){var e=[{label:"Î±",value:"Î±"},{label:"Î²",value:"Î²"},{label:"Î³",value:"Î³"},{label:"Ï€",value:"Ï€"},{label:"Î¸",value:"Î¸"},{label:"Î£",value:"Î£"},{label:"âˆž",value:"âˆž"},{label:"âˆš",value:"âˆš"},{label:"Â²",value:"Â²"},{label:"Â³",value:"Â³"},{label:"Â±",value:"Â±"},{label:"â‰ ",value:"â‰ "},{label:"â‰ˆ",value:"â‰ˆ"},{label:"â‰¤",value:"â‰¤"},{label:"â‰¥",value:"â‰¥"},{label:"Î”",value:"Î”"}],n='<div class="math-input-panel flex flex-wrap gap-1.5 p-2 bg-slate-50 border-b border-brand-light-gray">';return e.forEach(function(t){n+=`<button type="button" class="math-symbol-btn" onclick="QuillManager.insertMathSymbol('`+t.value+`')">`+t.label+"</button>"}),n+="</div>",n}function Pe(){var e=document.getElementById("wizard-questions-list");e&&(e.innerHTML="",Oe.clearAll(),v.questions.forEach(function(n,t){var a=["A","B","C","D","E","F"],r=t+1,i="question-input-"+r,s=document.createElement("div");s.className="question-card bg-white border border-brand-light-gray rounded-xl overflow-hidden shadow-sm transition-all duration-200 ring-offset-2",s.dataset.qIndex=t;var d='<div class="question-card-header flex justify-between items-center px-4 py-2 bg-slate-50 border-b border-brand-light-gray"><div class="flex items-center gap-3"><div class="drag-handle cursor-grab active:cursor-grabbing p-1 -ml-1 text-slate-400 hover:text-slate-600 hover:bg-slate-200 rounded transition-colors" draggable="true" title="Drag to reorder"><span class="material-symbols-outlined text-lg">drag_indicator</span></div><div class="flex items-center gap-2"><div class="h-6 w-6 rounded bg-veritas-navy text-white flex items-center justify-center font-bold text-[10px]">'+r+'</div><span class="font-bold text-xs text-brand-dark-gray tracking-tight">QUESTION '+r+'</span></div></div><div class="flex items-center gap-2"><label class="flex items-center gap-1.5 px-2 py-1 rounded hover:bg-slate-200 cursor-pointer text-[11px] font-semibold text-slate-500 transition-colors" title="Enable confidence tracking"><input type="checkbox" class="wizard-meta-cb h-3.5 w-3.5 rounded border-slate-300 text-veritas-navy focus:ring-veritas-navy" data-q-index="'+t+'" '+(n.metacognitionEnabled?"checked":"")+'><span>Confidence</span></label><div class="w-px h-4 bg-slate-200 mx-1"></div><button type="button" class="p-1.5 rounded text-red-400 hover:text-red-600 hover:bg-red-50 transition-all" onclick="removeWizardQuestion('+t+')" title="Remove Question"><span class="material-symbols-outlined text-lg">delete</span></button></div></div>',o=kc(),l='<div class="px-4 py-3 bg-slate-50/50 border-b border-brand-light-gray"><div class="flex items-center gap-2 mb-2"><span class="material-symbols-outlined text-sm text-veritas-gold">tips_and_updates</span><span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Smart Paste</span></div><textarea class="smart-paste-area focus:ring-1 focus:ring-veritas-gold" placeholder="Paste full question with options here (e.g. "What is 2+2? A) 3 B) 4") to auto-populate..." data-q-index="'+t+'"></textarea></div>',c='<div class="p-4 space-y-2"><div class="flex items-center justify-between"><label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider">Question Stem</label></div><div class="border border-brand-light-gray rounded-lg overflow-hidden focus-within:border-veritas-navy transition-colors"><div id="'+i+'" class="bg-white" style="min-height: 100px; height: auto;"></div></div></div>',u='<div class="px-4 pb-4 space-y-3"><label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider block mb-1">Answer Choices</label>';n.options.forEach(function(h,w){var q=n.correctAnswerIndex===w,T="answer-input-"+r+"-"+a[w].toLowerCase(),x=q?"ring-2 ring-green-500 bg-green-50/30":"border-slate-200";u+='<div class="flex items-start gap-3 p-3 rounded-xl border '+x+' transition-all group"><div class="flex flex-col items-center gap-2 mt-1"><button type="button" class="wizard-correct-toggle w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm transition-all '+(q?"bg-green-500 text-white shadow-lg shadow-green-200":"bg-slate-100 text-slate-400 hover:bg-green-100 hover:text-green-600")+'" onclick="setCorrectAnswer('+t+", "+w+')" title="Mark as Correct Answer">'+a[w]+'</button></div><div class="flex-1"><div class="border border-brand-light-gray rounded-lg overflow-hidden bg-white focus-within:border-veritas-navy transition-colors"><div id="'+T+'" style="min-height: 60px; height: auto;"></div></div></div><button type="button" class="mt-2 p-1.5 rounded text-slate-300 hover:text-red-500 hover:bg-red-50 transition-all opacity-0 group-hover:opacity-100" onclick="removeWizardOption('+t+", "+w+')" title="Remove Choice"><span class="material-symbols-outlined text-lg">close</span></button></div>'}),n.options.length<6&&(u+='<div class="flex justify-center pt-1"><button type="button" class="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-100 hover:bg-primary/10 text-slate-600 hover:text-primary transition-all text-[11px] font-bold" onclick="addWizardOption('+t+')"><span class="material-symbols-outlined text-sm">add_circle</span>Add Choice</button></div>'),u+="</div>",s.innerHTML=d+o+l+c+u,e.appendChild(s);var g=s.querySelector(".smart-paste-area");if(g&&g.addEventListener("paste",function(h){h.preventDefault();var w=(h.clipboardData||window.clipboardData).getData("text");Ic(t,w)}),n.metacognitionEnabled){var m=document.createElement("div");m.className="px-4 pb-4",m.innerHTML='<label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Confidence Prompt</label><div id="q-meta-'+t+'" class="border border-brand-light-gray rounded-lg overflow-hidden" style="height: 80px;"></div>',s.insertBefore(m,s.querySelector(".p-4")),Oe.init("q-meta-"+t,n.metaPromptDelta||n.metaPromptHtml||"How confident are you in your answer?","Enter prompt...",function(h){v.questions[t].metaPromptHtml=h.html,v.questions[t].metaPromptDelta=h.delta,v.questions[t].metaPromptText=h.text})}var p=s.querySelector(".wizard-meta-cb");p&&p.addEventListener("change",function(){v.questions[t].metacognitionEnabled=this.checked,Pe()});var b=s.querySelector(".drag-handle");b.addEventListener("dragstart",function(h){ta=t,s.classList.add("opacity-40","scale-[0.98]"),h.dataTransfer.effectAllowed="move",h.dataTransfer.setDragImage(s,20,20)}),b.addEventListener("dragend",function(h){s.classList.remove("opacity-40","scale-[0.98]"),e.querySelectorAll(".question-card").forEach(function(w){w.classList.remove("ring-4","ring-veritas-gold/20","border-veritas-gold")})}),s.addEventListener("dragover",function(h){return h.preventDefault&&h.preventDefault(),h.dataTransfer.dropEffect="move",this.classList.add("ring-4","ring-veritas-gold/20","border-veritas-gold"),!1}),s.addEventListener("dragleave",function(h){this.classList.remove("ring-4","ring-veritas-gold/20","border-veritas-gold")}),s.addEventListener("drop",function(h){h.stopPropagation&&h.stopPropagation();var w=parseInt(this.dataset.qIndex);if(ta!==null&&ta!==w){De();var q=v.questions[ta];v.questions.splice(ta,1),v.questions.splice(w,0,q),Pe()}return!1})}),Sc(),oo())}function oo(){var e=document.getElementById("wizard-timeline-items");e&&(e.innerHTML="",v.questions.forEach(function(n,t){var a=document.createElement("button");a.type="button",a.className="wizard-timeline-btn w-full h-8 rounded-lg bg-slate-50 hover:bg-primary/10 border border-brand-light-gray/50 hover:border-primary flex items-center justify-center font-bold text-sm text-brand-dark-gray hover:text-primary transition-all",a.dataset.qIndex=t,a.title="Jump to Question "+(t+1),a.textContent=t+1,a.addEventListener("click",function(){lo(t)}),e.appendChild(a)}),Lc())}function lo(e){var n=document.getElementById("wizard-questions-list");if(n){var t=n.querySelectorAll(".question-card");t[e]&&(t[e].scrollIntoView({behavior:"smooth",block:"center"}),t[e].classList.add("ring-2","ring-primary","ring-offset-2"),setTimeout(function(){t[e].classList.remove("ring-2","ring-primary","ring-offset-2")},1500))}}var Ga=null;function Lc(){Ga&&Ga.disconnect();var e=document.getElementById("wizard-questions-list"),n=document.getElementById("wizard-timeline-items");if(!(!e||!n)){var t=e.querySelectorAll(".question-card");t.length!==0&&(Ga=new IntersectionObserver(function(a){a.forEach(function(r){if(r.isIntersecting){var i=parseInt(r.target.dataset.qIndex);Cc(i)}})},{root:null,rootMargin:"-20% 0px -60% 0px",threshold:0}),t.forEach(function(a){Ga.observe(a)}))}}function Cc(e){var n=document.getElementById("wizard-timeline-items");if(n){var t=n.querySelectorAll(".wizard-timeline-btn");t.forEach(function(a,r){r===e?(a.classList.remove("bg-slate-50","text-brand-dark-gray","border-brand-light-gray/50"),a.classList.add("bg-primary","text-white","border-primary","shadow-md")):(a.classList.remove("bg-primary","text-white","border-primary","shadow-md"),a.classList.add("bg-slate-50","text-brand-dark-gray","border-brand-light-gray/50"))})}}window.updateWizardTimeline=oo,window.jumpToWizardQuestion=lo;function co(e){if(!e)return null;if(e.tagName&&e.tagName.toLowerCase()==="div")return e.id;var n=document.createElement("div");return n.id=e.id,n.className=e.className||"",n.innerHTML=e.value||e.innerHTML||"",Array.prototype.slice.call(e.attributes||[]).forEach(function(t){t.name!=="id"&&t.name!=="class"&&n.setAttribute(t.name,t.value)}),e.parentNode&&e.parentNode.replaceChild(n,e),n.id}function Sc(){if(console.log("[Wizard] initializeQuillEditors firing"),typeof Quill>"u"){console.error("Quill is not available. Skipping wizard editor initialization.");return}var e=document.querySelector("[data-full-editor-toggle], #full-editor-toggle");e&&e.parentNode&&e.parentNode.removeChild(e);var n=document.getElementById("poll-wizard")||document,t=n.querySelectorAll('[id^="question-input-"]');t.forEach(function(i){var s=i.id.match(/^question-input-(\d+)/),d=s?parseInt(s[1],10)-1:null;if(!(d===null||!v.questions[d])){var o=v.questions[d],l=o.delta||o.html||o.questionText||"",c=co(i);Oe.init(c,l,"Enter question text...",function(u){o.html=u.html,o.delta=u.delta,o.questionText=u.text})}});var a={a:0,b:1,c:2,d:3,e:4,f:5},r=n.querySelectorAll('[id^="answer-input-"]');r.forEach(function(i){var s=i.id.match(/^answer-input-(\d+)-([a-f])/i);if(s){var d=parseInt(s[1],10)-1,o=s[2].toLowerCase(),l=a[o];if(!(d<0||l===void 0)){var c=v.questions[d];if(c){c.options[l]||(c.options[l]={text:"",html:"",delta:null,imageURL:"",imageFileId:null,id:Ze()});var u=c.options[l],g=u.delta||u.html||u.text||"",m=co(i);Oe.init(m,g,"Answer choice...",function(p){u.html=p.html,u.delta=p.delta,u.text=p.text})}}}})}function Ac(e){return new Promise(function(n,t){var a=firebase.auth().currentUser;if(!a){t("User not authenticated");return}var r=Date.now(),i="poll_images/"+a.uid+"/"+r+"_"+e.name,s=firebase.storage().ref().child(i),d=s.put(e);d.on("state_changed",function(o){},function(o){console.error("Upload failed:",o),t(o)},function(){d.snapshot.ref.getDownloadURL().then(function(o){n(o)})})})}function Tc(e,n,t){if(e){if(!e.type.startsWith("image/")){alert("Please select an image file.");return}if(e.size>5*1024*1024){alert("Image must be less than 5MB.");return}De(),t===null?v.questions[n].questionImageURL="UPLOADING":v.questions[n].options[t].imageURL="UPLOADING",Pe(),Ac(e).then(function(a){De(),t===null?v.questions[n].questionImageURL=a:v.questions[n].options[t].imageURL=a,Pe()}).catch(function(a){alert("Image upload failed. Please try again."),De(),t===null?v.questions[n].questionImageURL=null:v.questions[n].options[t].imageURL=null,Pe()})}}window.addWizardOption=xc,window.removeWizardOption=wc,window.setCorrectAnswer=Ec,window.handleWizardImageUpload=Tc;function Bc(){var e=v.mode==="live"?"Live Poll":"Secure Assessment";document.getElementById("review-mode").textContent=e,document.getElementById("review-name").textContent=v.pollName||"(Untitled)",document.getElementById("review-class").textContent=v.className||"(No class selected)";var n=document.getElementById("review-questions-summary");if(n)if(v.questions.length===0)n.innerHTML='<p class="text-red-500 font-medium">No questions added. Please go back and add at least one question.</p>';else{var t=["A","B","C","D","E","F"],a='<div class="space-y-4">';a+='<p class="text-sm text-brand-dark-gray/60 mb-3">'+v.questions.length+" question(s) ready to publish</p>",v.questions.forEach(function(r,i){var s=r.questionText||"(Empty question)";s.length>80&&(s=s.substring(0,80)+"..."),a+='<div class="bg-slate-50 rounded-lg p-3 border border-brand-light-gray hover:border-primary hover:bg-primary/5 cursor-pointer transition-all group" data-edit-question="'+i+'" title="Click to edit this question">',a+='<div class="flex items-start gap-2 mb-2">',a+='<span class="h-6 w-6 rounded bg-primary text-white text-xs font-bold flex items-center justify-center shrink-0">'+(i+1)+"</span>",a+='<span class="font-medium text-brand-dark-gray text-sm group-hover:text-primary">'+y(s)+"</span>",a+='<span class="material-symbols-outlined text-xs text-slate-400 ml-auto opacity-0 group-hover:opacity-100 transition-opacity">edit</span>',a+="</div>",r.options&&r.options.length>0&&(a+='<div class="ml-8 flex flex-wrap gap-2">',r.options.forEach(function(d,o){if(d.text&&d.text.trim()!==""){var l=r.correctAnswerIndex===o,c=l?"bg-green-100 text-green-700 border-green-300":"bg-white text-brand-dark-gray/70 border-brand-light-gray",u=d.text.length>20?d.text.substring(0,20)+"...":d.text;a+='<span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded border '+c+'">',a+="<strong>"+t[o]+"</strong> "+y(u),l&&(a+=' <span class="material-symbols-outlined text-xs">check</span>'),a+="</span>"}}),a+="</div>"),a+="</div>"}),a+="</div>",v.mode==="secure"&&(a+='<div class="mt-4 p-3 rounded-lg bg-amber-50 border border-amber-200">',a+='<h5 class="text-sm font-bold text-amber-800 mb-2 flex items-center gap-2"><span class="material-symbols-outlined text-base">lock</span>Secure Assessment Settings</h5>',a+='<div class="text-sm text-amber-700 space-y-1">',a+="<p><strong>Time Limit:</strong> "+(v.timeLimitMinutes||"Not set")+" minutes</p>",v.accessCode&&(a+="<p><strong>Access Code:</strong> "+y(v.accessCode)+"</p>"),a+="<p><strong>Calculator:</strong> "+(v.calculatorEnabled?"Enabled":"Disabled")+"</p>",a+="</div></div>"),n.innerHTML=a,n.querySelectorAll("[data-edit-question]").forEach(function(r){r.addEventListener("click",function(){var i=parseInt(this.getAttribute("data-edit-question"));Se(3),setTimeout(function(){var s=document.querySelectorAll(".question-card");s[i]&&(s[i].scrollIntoView({behavior:"smooth",block:"center"}),s[i].classList.add("ring-2","ring-primary","ring-offset-2"),setTimeout(function(){s[i].classList.remove("ring-2","ring-primary","ring-offset-2")},2e3))},100)})})}}function qc(){if(!v.pollName||v.pollName.trim()===""){alert("Please enter a poll name."),Se(2);return}if(!v.className||v.className.trim()===""){alert("Please select a class."),Se(2);return}if(v.questions.length===0){alert("Please add at least one question."),Se(3);return}for(var e=0;e<v.questions.length;e++){var n=v.questions[e];if(!n.questionText||n.questionText.trim()===""){alert("Question "+(e+1)+" is missing the question text."),Se(3);return}for(var t=!1,a=0;a<n.options.length;a++)if(n.options[a].text&&n.options[a].text.trim()!==""){t=!0;break}if(!t){alert("Question "+(e+1)+" needs at least one answer choice."),Se(3);return}}if(v.mode==="secure"&&(!v.timeLimitMinutes||v.timeLimitMinutes<=0)){alert("Please set a time limit for secure assessments."),Se(2);return}var r=v.questions.map(function(b){var h=b.options.filter(function(C){return C.text&&C.text.trim()!==""});h.length<2&&(h=[{text:"Option A",imageURL:null,imageFileId:null},{text:"Option B",imageURL:null,imageFileId:null}]);var w=null;if(b.correctAnswerIndex!==void 0&&b.correctAnswerIndex!==null){var q=b.options[b.correctAnswerIndex];q&&q.text&&q.text.trim()!==""&&(w=q.text.trim())}!w&&h.length>0&&(w=h[0].text);var T=b.correctAnswerIndex!==void 0&&b.correctAnswerIndex<h.length?b.correctAnswerIndex:0,x=h[T].id;return{questionText:b.questionText?b.questionText.trim():"",html:b.html||b.questionText||"",delta:b.delta||null,questionImageURL:b.questionImageURL&&b.questionImageURL!=="UPLOADING"?b.questionImageURL:null,questionImageFileId:b.questionImageFileId||null,options:h.map(function(C){return{id:C.id||Ze(),text:C.text?C.text.trim():"",html:C.html||C.text||"",delta:C.delta||null,imageURL:C.imageURL&&C.imageURL!=="UPLOADING"?C.imageURL:null,imageFileId:C.imageFileId||null}}),correctAnswer:w,correctAnswerId:x,timerSeconds:b.timerSeconds||null,metacognitionEnabled:!!b.metacognitionEnabled,metaPromptHtml:b.metaPromptHtml||null,metaPromptDelta:b.metaPromptDelta||null,metaPromptText:b.metaPromptText||null}}),i={sessionType:v.mode==="secure"?"SECURE_ASSESSMENT":"LIVE_POLL"};v.mode==="secure"&&(i.timeLimitMinutes=parseInt(v.timeLimitMinutes)||60,i.accessCode=v.accessCode||"",i.calculatorEnabled=v.calculatorEnabled===!0);var s=document.getElementById("wizard-publish-btn"),d=v.isEditMode?"Updating":"Publishing",o=v.isEditMode?"save":"rocket_launch";s&&(s.disabled=!0,s.innerHTML='<span class="material-symbols-outlined animate-spin">hourglass_empty</span> '+d+"..."),console.log(d+" poll:",v.pollName,v.className,r,i);var l=firebase.functions();if(v.isEditMode&&v.pollId){var c=v.pollId,u={pollId:c,pollName:v.pollName.trim(),className:v.className.trim(),questions:r,metadata:i},g=l.httpsCallable("updatePoll");g(u).then(async function(b){console.log("Poll updated via Cloud Function:",b.data),await S("Poll updated successfully!",{title:"Success"});var h={pollId:c,pollName:u.pollName,className:u.className,questions:u.questions,metadata:u.metadata,success:!0};so(h)}).catch(async function(b){console.error("Cloud Function Update Error:",b),await S("Failed to update: "+(b.message||"Unknown error"),{title:"Error",destructive:!0}),s&&(s.disabled=!1,s.innerHTML='<span class="material-symbols-outlined">'+o+"</span> Update Poll")})}else{var m={pollName:v.pollName.trim(),className:v.className.trim(),questions:r,metadata:i},p=l.httpsCallable("createPoll");p(m).then(async function(b){console.log("Poll created via Cloud Function:",b.data),await S("Poll published successfully!",{title:"Success"});var h={pollId:b.data.pollId,pollName:m.pollName,className:m.className,questions:m.questions,metadata:m.metadata,success:!0};so(h)}).catch(async function(b){console.error("Cloud Function Create Error:",b),await S("Failed to publish: "+(b.message||"Unknown error"),{title:"Error",destructive:!0}),s&&(s.disabled=!1,s.innerHTML='<span class="material-symbols-outlined">'+o+"</span> Publish Poll")})}}window.showDashboard=He,window.openPollCreator=hd,window.openPollWizard=na,window.closePollWizard=io,window.initWizardState=ea,window.selectPollMode=pc,window.wizardGoNext=fc,window.wizardGoBack=mc,window.goToWizardStep=Se,window.goToWizardStep=Se,window.addWizardQuestion=hc,window.removeWizardQuestion=yc,window.endSession=aa,window.publishWizardPoll=qc,window.filterStudentsByFlag=Il,window.clearStudentFilter=kl,window.sortStudentsBy=Ll,window.updateLiveView=vt,window.endSession=aa,k("header-stop-btn",function(){f&&f.pollId&&aa(f.pollId)}),k("fab-stop-btn",function(){f&&f.pollId&&aa(f.pollId)}),k("mobile-stop-btn",function(){f&&f.pollId&&aa(f.pollId)});async function aa(e){if(!e){console.error("endSession called without pollId");return}if(confirm("Are you sure you want to end this session? This will stop all student activity and finalize the results.")){var n=document.getElementById("header-stop-btn"),t=document.getElementById("fab-stop-btn"),a=document.getElementById("mobile-stop-btn"),r=[n,t,a].filter(Boolean);r.forEach(function(u){u.disabled=!0,u.innerHTML='<span class="material-symbols-outlined animate-spin">hourglass_empty</span> Ending...'});try{var i=firebase.functions().httpsCallable("finalizeSession"),s=await i({pollId:e});console.log("Session finalized:",s.data),await S("Session ended successfully. Results have been saved to history.",{title:"Session Ended"});var d=document.getElementById("live-view"),o=document.getElementById("header-live"),l=document.getElementById("header-default");d&&(d.style.display="none"),o&&(o.style.display="none"),l&&(l.style.display="flex");var c=document.getElementById("fab-container");c&&(c.style.display="none"),typeof He=="function"?He():window.location.reload()}catch(u){console.error("Failed to end session:",u),await S("Failed to end session: "+(u.message||"Unknown error"),{title:"Error",destructive:!0}),r.forEach(function(g){g.disabled=!1,g.id==="fab-stop-btn"?g.innerHTML='<span class="material-symbols-outlined">stop</span>':g.id==="mobile-stop-btn"?g.innerHTML='<span class="material-symbols-outlined text-base">stop_circle</span><span>End</span>':g.innerHTML='<span class="material-symbols-outlined text-base">stop_circle</span> End Session'})}}}function li(e){console.log("[Optimization] Handling lightweight update:",e);var t=e.questionIndex,a=f&&f.questions?f.questions[t]:null;if(Hd(e.pollId,{questionIndex:t,status:e.status,sessionPhase:e.metadata?e.metadata.sessionPhase:"LIVE",resultsVisibility:e.metadata?e.metadata.resultsVisibility:"HIDDEN",questionText:a?a.questionText:"",questionImageURL:a?a.questionImageURL:"",options:a?a.options:[]}),!f||!f.questions){console.warn("[Optimization] CURRENT_POLL_DATA missing, falling back to full refresh");var n=V.find(function(s){return s.pollId===e.pollId});if(n&&n.questions){f=n;var a=n.questions[e.questionIndex];if(a){li(e);return}}console.error("[Firebase] Failed to locate poll definition for sync:",e.pollId);return}var t=e.questionIndex,a=f.questions[t];if(!a){console.error("[Optimization] Question definition not found for index:",t);return}var r=P;if(!r||r.length===0){var i=f?f.className:null;if(console.log("[Optimization] No students loaded, searching for roster. className:",i),i&&Z&&Z[i]&&Z[i].length>0){console.log("[Optimization] Found roster in memory:",Z[i].length,"students"),P=Z[i].map(function(s){return{name:s.name||"",email:s.email||"",firstName:(s.name||"").split(" ")[0]||"",lastName:(s.name||"").split(" ").slice(1).join(" ")||"",status:"Waiting...",statusNote:"waiting",answer:"---",isCorrect:null,confidence:null,timestamp:9999999999999}}),bn(e,a,t,P);return}if(f&&f.roster&&f.roster.length>0){console.log("[Optimization] Found roster in poll definition:",f.roster.length,"students"),P=f.roster.map(function(s){return{name:s.name||"",email:s.email||"",firstName:(s.name||"").split(" ")[0]||"",lastName:(s.name||"").split(" ").slice(1).join(" ")||"",status:"Waiting...",statusNote:"waiting",answer:"---",isCorrect:null,confidence:null,timestamp:9999999999999}}),bn(e,a,t,P);return}if(i){console.log("[Optimization] Fetching roster from Firebase for class:",i),firebase.database().ref("rosters/rosters/"+i).once("value").then(function(s){var d=s.val();d&&Array.isArray(d)&&d.length>0?(console.log("[Optimization] Loaded",d.length,"students from Firebase"),P=d.map(function(o){return{name:o.name||"",email:o.email||"",firstName:(o.name||"").split(" ")[0]||"",lastName:(o.name||"").split(" ").slice(1).join(" ")||"",status:"Waiting...",statusNote:"waiting",answer:"---",isCorrect:null,confidence:null,timestamp:9999999999999}}),li(e)):(console.warn("[Optimization] No roster found in Firebase for class:",i),bn(e,a,t,[]))}).catch(function(s){console.error("[Optimization] Failed to fetch roster from Firebase:",s),bn(e,a,t,[])});return}console.warn("[Optimization] No roster source available"),bn(e,a,t,[]);return}bn(e,a,t,r)}function bn(e,n,t,a){var r={pollId:e.pollId,status:e.status,questionIndex:t,pollName:f.pollName,questionText:n.questionText,questionImageURL:n.questionImageURL,options:n.options||[],totalQuestions:f.questions.length,correctAnswer:n.correctAnswer,timerSeconds:n.timerSeconds,metadata:e.metadata,authoritativeStatus:"LIVE",results:{},totalResponses:0,totalStudents:a.length,studentStatusList:a.map(function(i){return Object.assign({},i,{status:"Waiting...",statusNote:"waiting",answer:"---",isCorrect:null,confidence:null,timestamp:9999999999999})})};vt(r),setTimeout(function(){console.log("[Optimization] Triggering background fetch for consistency"),Be=!1,Dt()},500)}var It=null,Ka=null,$a=null;window.openFormulaModal=function(e,n,t){It=e,Ka=n,$a=t||null;var a=document.getElementById("formula-modal"),r=document.getElementById("math-editor-field");if(a&&r){if(t){var i=t.value();r.value=typeof i=="string"?i:""}else r.value="";a.classList.remove("hidden"),a.classList.add("flex"),setTimeout(function(){r.focus()},50)}},window.closeFormulaModal=function(){var e=document.getElementById("formula-modal");e&&(e.classList.add("hidden"),e.classList.remove("flex"),It=null,Ka=null,$a=null)},window.insertFormula=function(){var e=document.getElementById("math-editor-field");if(It&&e){var n=e.value;if($a){var t=It.getIndex($a);It.deleteText(t,1),It.insertEmbed(t,"formula",n)}else{var t=Ka?Ka.index:It.getLength();It.insertEmbed(t,"formula",n)}closeFormulaModal()}},(function(){var n=document.getElementById("close-formula-modal"),t=document.getElementById("cancel-formula-btn"),a=document.getElementById("insert-formula-btn");n&&(n.onclick=window.closeFormulaModal),t&&(t.onclick=window.closeFormulaModal),a&&(a.onclick=window.insertFormula)})();function Nc(){var e=document.getElementById("calculator-draggable"),n=document.getElementById("calculator-drag-handle"),t=document.getElementById("header-calc-toggle");if(!e||!n||!t)return;t.addEventListener("click",function(){var p=e.classList.contains("hidden");p?(e.classList.remove("hidden"),t.classList.add("bg-white","text-indigo-600","shadow-inner"),t.classList.remove("text-gray-600")):(e.classList.add("hidden"),t.classList.remove("bg-white","text-indigo-600","shadow-inner"),t.classList.add("text-gray-600"))});var a=!1,r,i,s,d,o=0,l=0;n.addEventListener("mousedown",c),document.addEventListener("mouseup",u),document.addEventListener("mousemove",g);function c(p){s=p.clientX-o,d=p.clientY-l,(p.target===n||n.contains(p.target))&&(a=!0)}function u(p){s=r,d=i,a=!1}function g(p){a&&(p.preventDefault(),r=p.clientX-s,i=p.clientY-d,o=r,l=i,m(r,i,e))}function m(p,b,h){h.style.transform="translate3d("+p+"px, "+b+"px, 0)"}}setTimeout(function(){Nc(),console.log("[Info] Calculator System Initialized")},1e3),document.querySelectorAll('[data-close-inspector="true"]').forEach(function(e){e.addEventListener("click",function(){var n=document.getElementById("student-inspector-modal");n&&n.classList.add("hidden")})});function uo(e){if(!(!f.questions||!f.questions[e])){var n=f.questions[e],t=document.getElementById("live-question-text");t&&(t.textContent=n.questionText||"");var a=document.getElementById("live-question-image-container"),r=document.getElementById("live-question-image");if(a&&r){var i=Zr(n.questionImage||n.questionImageURL,n.questionImageFileId);i?(r.src=i,a.classList.remove("hidden")):a.classList.add("hidden")}var s=document.getElementById("results-bars");if(s){s.innerHTML="";var d=n.answers||n.options||[];d.length>0&&d.forEach(function(l,c){var u=document.createElement("div");u.className="mb-3";var g=String.fromCharCode(65+c);u.innerHTML=`
                        <div class="flex justify-between text-sm mb-1">
                           <span class="font-bold">${g}. ${y(l.text||"")}</span>
                           <span class="text-gray-400 text-xs">Waiting...</span>
                        </div>
                        <div class="h-8 w-full bg-gray-100 rounded-lg overflow-hidden relative">
                           <div class="h-full bg-gray-200" style="width: 0%"></div>
                        </div>
                     `,s.appendChild(u)})}var o=document.getElementById("live-question-info");o&&(o.textContent="Q"+(e+1)+" / "+f.questions.length)}}function Mc(){if(se!==null){var e=f.pollId,n=se,t=f.questions&&f.questions[n]?f.questions[n]:null,a=document.getElementById("header-present-btn");a&&Y(a,!0);var r=firebase.functions().httpsCallable("setLiveSessionState");r({pollId:e,questionIndex:n,status:"OPEN",questionText:t?t.questionText:"",options:t?t.options:[],correctAnswer:t?t.correctAnswer:null,questionImageURL:t&&(t.questionImageURL||t.imageURL||t.mediaUrl)||"",totalQuestions:f.questions&&f.questions.length?f.questions.length:0}).then(function(){a&&Y(a,!1),a&&a.classList.add("hidden")}).catch(function(i){a&&Y(a,!1),F(i)})}}})();
